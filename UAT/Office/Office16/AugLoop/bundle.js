"use strict";(()=>{var WT=Object.create;var Pu=Object.defineProperty;var OT=Object.getOwnPropertyDescriptor;var LT=Object.getOwnPropertyNames;var FT=Object.getPrototypeOf,qT=Object.prototype.hasOwnProperty;var Nu=(n,r)=>(r=Symbol[n])?r:Symbol.for("Symbol."+n),$T=n=>{throw TypeError(n)};var GT=(n,r)=>()=>(n&&(r=n(n=0)),r);var re=(n,r)=>()=>(r||n((r={exports:{}}).exports,r),r.exports),UT=(n,r)=>{for(var e in r)Pu(n,e,{get:r[e],enumerable:!0})},Du=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let o of LT(r))!qT.call(n,o)&&o!==e&&Pu(n,o,{get:()=>r[o],enumerable:!(t=OT(r,o))||t.enumerable});return n},hn=(n,r,e)=>(Du(n,r,"default"),e&&Du(e,r,"default")),w=(n,r,e)=>(e=n!=null?WT(FT(n)):{},Du(r||!n||!n.__esModule?Pu(e,"default",{value:n,enumerable:!0}):e,n));var HT=function(n,r){this[0]=n,this[1]=r};var Co=n=>{var r=n[Nu("asyncIterator")],e=!1,t,o={};return r==null?(r=n[Nu("iterator")](),t=a=>o[a]=s=>r[a](s)):(r=r.call(n),t=a=>o[a]=s=>{if(e){if(e=!1,a==="throw")throw s;return s}return e=!0,{done:!1,value:new HT(new Promise(u=>{var l=r[a](s);l instanceof Object||$T("Object expected"),u(l)}),1)}}),o[Nu("iterator")]=()=>o,t("next"),"throw"in r?t("throw"):o.throw=a=>{throw a},"return"in r&&t("return"),o};var Mp=re((exports,module)=>{h();if(exports.__platformBundles!==void 0)for(platformBundles=exports.__platformBundles.concat(),Reflect.deleteProperty(exports,"__platformBundles"),i=0;i<platformBundles.length;++i)console.log("PB start "+(i+1)+"/"+platformBundles.length),eval(platformBundles[i]),console.log("PB done  "+(i+1)+"/"+platformBundles.length);var platformBundles,i});var global,h=GT(()=>{global=new Function("return this;")();Mp()});var Np=re((KE,Ep)=>{h();Ep.exports=OfficePlatformGlobal.ReactNativeReka});var Pp=re((XE,Dp)=>{h();Dp.exports=OfficePlatformGlobal.Reka});var Ru=re((r0,li)=>{h();function QT(n){if(Array.isArray(n))return n}li.exports=QT,li.exports.__esModule=!0,li.exports.default=li.exports});var Wp=re((i0,ci)=>{h();function jT(n,r){var e=n==null?null:typeof Symbol!="undefined"&&n[Symbol.iterator]||n["@@iterator"];if(e!=null){var t,o,a,s,u=[],l=!0,c=!1;try{if(a=(e=e.call(n)).next,r===0){if(Object(e)!==e)return;l=!1}else for(;!(l=(t=a.call(e)).done)&&(u.push(t.value),u.length!==r);l=!0);}catch(f){c=!0,o=f}finally{try{if(!l&&e.return!=null&&(s=e.return(),Object(s)!==s))return}finally{if(c)throw o}}return u}}ci.exports=jT,ci.exports.__esModule=!0,ci.exports.default=ci.exports});var Bu=re((s0,fi)=>{h();function JT(n,r){(r==null||r>n.length)&&(r=n.length);for(var e=0,t=Array(r);e<r;e++)t[e]=n[e];return t}fi.exports=JT,fi.exports.__esModule=!0,fi.exports.default=fi.exports});var Ya=re((l0,di)=>{h();var Op=Bu();function KT(n,r){if(n){if(typeof n=="string")return Op(n,r);var e={}.toString.call(n).slice(8,-1);return e==="Object"&&n.constructor&&(e=n.constructor.name),e==="Map"||e==="Set"?Array.from(n):e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e)?Op(n,r):void 0}}di.exports=KT,di.exports.__esModule=!0,di.exports.default=di.exports});var Wu=re((f0,pi)=>{h();function YT(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}pi.exports=YT,pi.exports.__esModule=!0,pi.exports.default=pi.exports});var dt=re((p0,gi)=>{h();var XT=Ru(),ZT=Wp(),eI=Ya(),tI=Wu();function nI(n,r){return XT(n)||ZT(n,r)||eI(n,r)||tI()}gi.exports=nI,gi.exports.__esModule=!0,gi.exports.default=gi.exports});var P=re((k0,hi)=>{h();function rI(n,r){if(!(n instanceof r))throw new TypeError("Cannot call a class as a function")}hi.exports=rI,hi.exports.__esModule=!0,hi.exports.default=hi.exports});var Xa=re((S0,Un)=>{h();function Ou(n){"@babel/helpers - typeof";return Un.exports=Ou=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},Un.exports.__esModule=!0,Un.exports.default=Un.exports,Ou(n)}Un.exports=Ou,Un.exports.__esModule=!0,Un.exports.default=Un.exports});var Gp=re((x0,mi)=>{h();var $p=Xa().default;function oI(n,r){if($p(n)!="object"||!n)return n;var e=n[Symbol.toPrimitive];if(e!==void 0){var t=e.call(n,r||"default");if($p(t)!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(n)}mi.exports=oI,mi.exports.__esModule=!0,mi.exports.default=mi.exports});var Lu=re((I0,vi)=>{h();var iI=Xa().default,aI=Gp();function sI(n){var r=aI(n,"string");return iI(r)=="symbol"?r:r+""}vi.exports=sI,vi.exports.__esModule=!0,vi.exports.default=vi.exports});var R=re((A0,yi)=>{h();var uI=Lu();function Up(n,r){for(var e=0;e<r.length;e++){var t=r[e];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,uI(t.key),t)}}function lI(n,r,e){return r&&Up(n.prototype,r),e&&Up(n,e),Object.defineProperty(n,"prototype",{writable:!1}),n}yi.exports=lI,yi.exports.__esModule=!0,yi.exports.default=yi.exports});var Qp=re((B0,ki)=>{h();var cI=Bu();function fI(n){if(Array.isArray(n))return cI(n)}ki.exports=fI,ki.exports.__esModule=!0,ki.exports.default=ki.exports});var qu=re((O0,wi)=>{h();function dI(n){if(typeof Symbol!="undefined"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}wi.exports=dI,wi.exports.__esModule=!0,wi.exports.default=wi.exports});var jp=re((F0,Si)=>{h();function pI(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}Si.exports=pI,Si.exports.__esModule=!0,Si.exports.default=Si.exports});var Se=re(($0,Ci)=>{h();var gI=Qp(),hI=qu(),mI=Ya(),vI=jp();function yI(n){return gI(n)||hI(n)||mI(n)||vI()}Ci.exports=yI,Ci.exports.__esModule=!0,Ci.exports.default=Ci.exports});var Zp=re((FN,_i)=>{h();function kI(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}_i.exports=kI,_i.exports.__esModule=!0,_i.exports.default=_i.exports});var Qe=re(($N,Ai)=>{h();var wI=Xa().default,SI=Zp();function CI(n,r){if(r&&(wI(r)=="object"||typeof r=="function"))return r;if(r!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return SI(n)}Ai.exports=CI,Ai.exports.__esModule=!0,Ai.exports.default=Ai.exports});var $e=re((UN,Qn)=>{h();function fl(n){return Qn.exports=fl=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(r){return r.__proto__||Object.getPrototypeOf(r)},Qn.exports.__esModule=!0,Qn.exports.default=Qn.exports,fl(n)}Qn.exports=fl,Qn.exports.__esModule=!0,Qn.exports.default=Qn.exports});var is=re((zN,jn)=>{h();function dl(n,r){return jn.exports=dl=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},jn.exports.__esModule=!0,jn.exports.default=jn.exports,dl(n,r)}jn.exports=dl,jn.exports.__esModule=!0,jn.exports.default=jn.exports});var je=re((QN,bi)=>{h();var xI=is();function TI(n,r){if(typeof r!="function"&&r!==null)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(r&&r.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),r&&xI(n,r)}bi.exports=TI,bi.exports.__esModule=!0,bi.exports.default=bi.exports});var eg=re((JN,Mi)=>{h();function II(n){try{return Function.toString.call(n).indexOf("[native code]")!==-1}catch(r){return typeof n=="function"}}Mi.exports=II,Mi.exports.__esModule=!0,Mi.exports.default=Mi.exports});var ng=re((YN,Jn)=>{h();function tg(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Jn.exports=tg=function(){return!!n},Jn.exports.__esModule=!0,Jn.exports.default=Jn.exports)()}Jn.exports=tg,Jn.exports.__esModule=!0,Jn.exports.default=Jn.exports});var rg=re((ZN,Ei)=>{h();var _I=ng(),AI=is();function bI(n,r,e){if(_I())return Reflect.construct.apply(null,arguments);var t=[null];t.push.apply(t,r);var o=new(n.bind.apply(n,t));return e&&AI(o,e.prototype),o}Ei.exports=bI,Ei.exports.__esModule=!0,Ei.exports.default=Ei.exports});var as=re((tD,Kn)=>{h();var MI=$e(),EI=is(),NI=eg(),DI=rg();function pl(n){var r=typeof Map=="function"?new Map:void 0;return Kn.exports=pl=function(t){if(t===null||!NI(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(r!==void 0){if(r.has(t))return r.get(t);r.set(t,o)}function o(){return DI(t,arguments,MI(this).constructor)}return o.prototype=Object.create(t.prototype,{constructor:{value:o,enumerable:!1,writable:!0,configurable:!0}}),EI(o,t)},Kn.exports.__esModule=!0,Kn.exports.default=Kn.exports,pl(n)}Kn.exports=pl,Kn.exports.__esModule=!0,Kn.exports.default=Kn.exports});var ys=re((zP,zr)=>{h();zr.exports=global.fetch;zr.exports.default=global.fetch;zr.exports.fetch=global.fetch;zr.exports.Headers=global.Headers;zr.exports.Request=global.Request;zr.exports.Response=global.Response});var Ol=re((oR,uh)=>{h();var Wo=null;typeof WebSocket!="undefined"?Wo=WebSocket:typeof MozWebSocket!="undefined"?Wo=MozWebSocket:typeof global!="undefined"?Wo=global.WebSocket||global.MozWebSocket:typeof window!="undefined"?Wo=window.WebSocket||window.MozWebSocket:typeof self!="undefined"&&(Wo=self.WebSocket||self.MozWebSocket);uh.exports=Wo});var Ui=re((lR,Gi)=>{h();var a_=Lu();function s_(n,r,e){return(r=a_(r))in n?Object.defineProperty(n,r,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[r]=e,n}Gi.exports=s_,Gi.exports.__esModule=!0,Gi.exports.default=Gi.exports});var fh=re((fR,Hi)=>{h();var u_=$e();function l_(n,r){for(;!{}.hasOwnProperty.call(n,r)&&(n=u_(n))!==null;);return n}Hi.exports=l_,Hi.exports.__esModule=!0,Hi.exports.default=Hi.exports});var Ss=re((pR,er)=>{h();var c_=fh();function ql(){return er.exports=ql=typeof Reflect!="undefined"&&Reflect.get?Reflect.get.bind():function(n,r,e){var t=c_(n,r);if(t){var o=Object.getOwnPropertyDescriptor(t,r);return o.get?o.get.call(arguments.length<3?n:e):o.value}},er.exports.__esModule=!0,er.exports.default=er.exports,ql.apply(null,arguments)}er.exports=ql,er.exports.__esModule=!0,er.exports.default=er.exports});var zi=re((hR,dh)=>{"use strict";h();dh.exports=function n(r,e){if(r===e)return!0;if(r&&e&&typeof r=="object"&&typeof e=="object"){if(r.constructor!==e.constructor)return!1;var t,o,a;if(Array.isArray(r)){if(t=r.length,t!=e.length)return!1;for(o=t;o--!==0;)if(!n(r[o],e[o]))return!1;return!0}if(r.constructor===RegExp)return r.source===e.source&&r.flags===e.flags;if(r.valueOf!==Object.prototype.valueOf)return r.valueOf()===e.valueOf();if(r.toString!==Object.prototype.toString)return r.toString()===e.toString();if(a=Object.keys(r),t=a.length,t!==Object.keys(e).length)return!1;for(o=t;o--!==0;)if(!Object.prototype.hasOwnProperty.call(e,a[o]))return!1;for(o=t;o--!==0;){var s=a[o];if(!n(r[s],e[s]))return!1}return!0}return r!==r&&e!==e}});var Ah=re((WR,_h)=>{h();_h.exports={$schema:"http://json-schema.org/draft-07/schema#",$id:"http://augloop.office.com/settings.json",definitions:{environments:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["dev","test","int","dogfood","msit","prod","fairfax","gcchigh","dod","ag08","ag09","gallatin"]}},regions:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["australiaeast","australiasoutheast","brazilsouth","centralindia","centralus","chinaeast3","chinanorth3","eastus","eastus2","eastus2euap","francecentral","japaneast","northeurope","southcentralus","swedencentral","northcentralus","southeastasia","westcentralus","westeurope","westus","westus2","usdodcentral","usdodeast","usgovarizona","usgovtexas","usgovvirginia","usnateast","usnatwest","usseceast","ussecwest"]}},dataBoundaries:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["eudb"]}},serviceNames:{type:"array",uniqueItems:!0,minItems:1,items:{type:"string",enum:["gateway","matchmaker","httpproxy","utility","textanalysis","proofing","acronyms","classification","mastermind","excel-ecs-proxy","automatic-clp","fileio","powerpoint-getitems-proxy","tricorder","image-services","natural-language","role-detection","doc-xray","compose","voice","incubation","canvas","excel","ink","extension","observational-assistance","personalization","security","generative-text"]}},IConfigValue:{type:"object",properties:{value:{description:"An untyped setting",type:["array","boolean","integer","null","number","object","string"]},environments:{$ref:"#/definitions/environments"},regions:{$ref:"#/definitions/regions"},dataBoundaries:{$ref:"#/definitions/dataBoundaries"},serviceNames:{$ref:"#/definitions/serviceNames"},lastModifiedBy:{type:"string",format:"email"},lastModifiedTime:{type:"string",format:"date-time"}},required:["value"],additionalProperties:!1},IConfigSetting:{type:"array",minItems:1,items:{$ref:"#/definitions/IConfigValue"}},IStringConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A string setting",type:"string"}}},{$ref:"#/definitions/IConfigValue"}]}},INumericConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A number setting",type:"number"}}},{$ref:"#/definitions/IConfigValue"}]}},IBooleanConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"A boolean setting",type:"boolean"}}},{$ref:"#/definitions/IConfigValue"}]}},IObjectConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"An object setting",type:"object"}}},{$ref:"#/definitions/IConfigValue"}]}},IArrayConfigSetting:{type:"array",minItems:1,items:{allOf:[{type:"object",properties:{value:{description:"An array setting",type:"array"}}},{$ref:"#/definitions/IConfigValue"}]}}},title:"Config",properties:{$schema:!0},additionalProperties:{$ref:"#/definitions/IConfigSetting"}}});var Pn=re((hB,sc)=>{"use strict";h();var S_=Object.prototype.hasOwnProperty,Lt="~";function la(){}Object.create&&(la.prototype=Object.create(null),new la().__proto__||(Lt=!1));function C_(n,r,e){this.fn=n,this.context=r,this.once=e||!1}function Oh(n,r,e,t,o){if(typeof e!="function")throw new TypeError("The listener must be a function");var a=new C_(e,t||n,o),s=Lt?Lt+r:r;return n._events[s]?n._events[s].fn?n._events[s]=[n._events[s],a]:n._events[s].push(a):(n._events[s]=a,n._eventsCount++),n}function Ms(n,r){--n._eventsCount===0?n._events=new la:delete n._events[r]}function Nt(){this._events=new la,this._eventsCount=0}Nt.prototype.eventNames=function(){var r=[],e,t;if(this._eventsCount===0)return r;for(t in e=this._events)S_.call(e,t)&&r.push(Lt?t.slice(1):t);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r};Nt.prototype.listeners=function(r){var e=Lt?Lt+r:r,t=this._events[e];if(!t)return[];if(t.fn)return[t.fn];for(var o=0,a=t.length,s=new Array(a);o<a;o++)s[o]=t[o].fn;return s};Nt.prototype.listenerCount=function(r){var e=Lt?Lt+r:r,t=this._events[e];return t?t.fn?1:t.length:0};Nt.prototype.emit=function(r,e,t,o,a,s){var u=Lt?Lt+r:r;if(!this._events[u])return!1;var l=this._events[u],c=arguments.length,f,d;if(l.fn){switch(l.once&&this.removeListener(r,l.fn,void 0,!0),c){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,e),!0;case 3:return l.fn.call(l.context,e,t),!0;case 4:return l.fn.call(l.context,e,t,o),!0;case 5:return l.fn.call(l.context,e,t,o,a),!0;case 6:return l.fn.call(l.context,e,t,o,a,s),!0}for(d=1,f=new Array(c-1);d<c;d++)f[d-1]=arguments[d];l.fn.apply(l.context,f)}else{var p=l.length,g;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(r,l[d].fn,void 0,!0),c){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,e);break;case 3:l[d].fn.call(l[d].context,e,t);break;case 4:l[d].fn.call(l[d].context,e,t,o);break;default:if(!f)for(g=1,f=new Array(c-1);g<c;g++)f[g-1]=arguments[g];l[d].fn.apply(l[d].context,f)}}return!0};Nt.prototype.on=function(r,e,t){return Oh(this,r,e,t,!1)};Nt.prototype.once=function(r,e,t){return Oh(this,r,e,t,!0)};Nt.prototype.removeListener=function(r,e,t,o){var a=Lt?Lt+r:r;if(!this._events[a])return this;if(!e)return Ms(this,a),this;var s=this._events[a];if(s.fn)s.fn===e&&(!o||s.once)&&(!t||s.context===t)&&Ms(this,a);else{for(var u=0,l=[],c=s.length;u<c;u++)(s[u].fn!==e||o&&!s[u].once||t&&s[u].context!==t)&&l.push(s[u]);l.length?this._events[a]=l.length===1?l[0]:l:Ms(this,a)}return this};Nt.prototype.removeAllListeners=function(r){var e;return r?(e=Lt?Lt+r:r,this._events[e]&&Ms(this,e)):(this._events=new la,this._eventsCount=0),this};Nt.prototype.off=Nt.prototype.removeListener;Nt.prototype.addListener=Nt.prototype.on;Nt.prefixed=Lt;Nt.EventEmitter=Nt;typeof sc!="undefined"&&(sc.exports=Nt)});var fc=re((xB,Gh)=>{"use strict";h();function Ee(n){if(this._capacity=$h(n),this._length=0,this._front=0,qh(n)){for(var r=n.length,e=0;e<r;++e)this[e]=n[e];this._length=r}}Ee.prototype.toArray=function(){for(var r=this._length,e=new Array(r),t=this._front,o=this._capacity,a=0;a<r;++a)e[a]=this[t+a&o-1];return e};Ee.prototype.push=function(r){var e=arguments.length,t=this._length;if(e>1){var o=this._capacity;if(t+e>o){for(var s=0;s<e;++s){this._checkCapacity(t+1);var a=this._front+t&this._capacity-1;this[a]=arguments[s],t++,this._length=t}return t}else{for(var a=this._front,s=0;s<e;++s)this[a+t&o-1]=arguments[s],a++;return this._length=t+e,t+e}}if(e===0)return t;this._checkCapacity(t+1);var s=this._front+t&this._capacity-1;return this[s]=r,this._length=t+1,t+1};Ee.prototype.pop=function(){var r=this._length;if(r!==0){var e=this._front+r-1&this._capacity-1,t=this[e];return this[e]=void 0,this._length=r-1,t}};Ee.prototype.shift=function(){var r=this._length;if(r!==0){var e=this._front,t=this[e];return this[e]=void 0,this._front=e+1&this._capacity-1,this._length=r-1,t}};Ee.prototype.unshift=function(r){var e=this._length,t=arguments.length;if(t>1){var s=this._capacity;if(e+t>s){for(var u=t-1;u>=0;u--){this._checkCapacity(e+1);var s=this._capacity,o=(this._front-1&s-1^s)-s;this[o]=arguments[u],e++,this._length=e,this._front=o}return e}else{for(var a=this._front,u=t-1;u>=0;u--){var o=(a-1&s-1^s)-s;this[o]=arguments[u],a=o}return this._front=a,this._length=e+t,e+t}}if(t===0)return e;this._checkCapacity(e+1);var s=this._capacity,u=(this._front-1&s-1^s)-s;return this[u]=r,this._length=e+1,this._front=u,e+1};Ee.prototype.peekBack=function(){var r=this._length;if(r!==0){var e=this._front+r-1&this._capacity-1;return this[e]}};Ee.prototype.peekFront=function(){if(this._length!==0)return this[this._front]};Ee.prototype.get=function(r){var e=r;if(e===(e|0)){var t=this._length;if(e<0&&(e=e+t),!(e<0||e>=t))return this[this._front+e&this._capacity-1]}};Ee.prototype.isEmpty=function(){return this._length===0};Ee.prototype.clear=function(){for(var r=this._length,e=this._front,t=this._capacity,o=0;o<r;++o)this[e+o&t-1]=void 0;this._length=0,this._front=0};Ee.prototype.toString=function(){return this.toArray().toString()};Ee.prototype.valueOf=Ee.prototype.toString;Ee.prototype.removeFront=Ee.prototype.shift;Ee.prototype.removeBack=Ee.prototype.pop;Ee.prototype.insertFront=Ee.prototype.unshift;Ee.prototype.insertBack=Ee.prototype.push;Ee.prototype.enqueue=Ee.prototype.push;Ee.prototype.dequeue=Ee.prototype.shift;Ee.prototype.toJSON=Ee.prototype.toArray;Object.defineProperty(Ee.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}});Ee.prototype._checkCapacity=function(r){this._capacity<r&&this._resizeTo($h(this._capacity*1.5+16))};Ee.prototype._resizeTo=function(r){var e=this._capacity;this._capacity=r;var t=this._front,o=this._length;if(t+o>e){var a=t+o&e-1;T_(this,0,this,e,a)}};var qh=Array.isArray;function T_(n,r,e,t,o){for(var a=0;a<o;++a)e[a+t]=n[a+r],n[a+r]=void 0}function I_(n){return n=n>>>0,n=n-1,n=n|n>>1,n=n|n>>2,n=n|n>>4,n=n|n>>8,n=n|n>>16,n+1}function $h(n){if(typeof n!="number")if(qh(n))n=n.length;else return 16;return I_(Math.min(Math.max(16,n),1073741824))}Gh.exports=Ee});var rm=re(nm=>{h();(function(n){"use strict";function r(x,T){var I;return x instanceof Buffer?I=x:I=Buffer.from(x.buffer,x.byteOffset,x.byteLength),I.toString(T)}var e=function(T){return Buffer.from(T)};function t(x){for(var T=0,I=Math.min(65536,x.length+1),_=new Uint16Array(I),M=[],b=0;;){var A=T<x.length;if(!A||b>=I-1){var N=_.subarray(0,b),F=N;if(M.push(String.fromCharCode.apply(null,F)),!A)return M.join("");x=x.subarray(T),T=0,b=0}var q=x[T++];if(!(q&128))_[b++]=q;else if((q&224)===192){var J=x[T++]&63;_[b++]=(q&31)<<6|J}else if((q&240)===224){var J=x[T++]&63,Y=x[T++]&63;_[b++]=(q&31)<<12|J<<6|Y}else if((q&248)===240){var J=x[T++]&63,Y=x[T++]&63,fe=x[T++]&63,W=(q&7)<<18|J<<12|Y<<6|fe;W>65535&&(W-=65536,_[b++]=W>>>10&1023|55296,W=56320|W&1023),_[b++]=W}}}function o(x){for(var T=0,I=x.length,_=0,M=Math.max(32,I+(I>>>1)+7),b=new Uint8Array(M>>>3<<3);T<I;){var A=x.charCodeAt(T++);if(A>=55296&&A<=56319){if(T<I){var N=x.charCodeAt(T);(N&64512)===56320&&(++T,A=((A&1023)<<10)+(N&1023)+65536)}if(A>=55296&&A<=56319)continue}if(_+4>b.length){M+=8,M*=1+T/x.length*2,M=M>>>3<<3;var F=new Uint8Array(M);F.set(b),b=F}if(A&4294967168)if(!(A&4294965248))b[_++]=A>>>6&31|192;else if(!(A&4294901760))b[_++]=A>>>12&15|224,b[_++]=A>>>6&63|128;else if(!(A&4292870144))b[_++]=A>>>18&7|240,b[_++]=A>>>12&63|128,b[_++]=A>>>6&63|128;else continue;else{b[_++]=A;continue}b[_++]=A&63|128}return b.slice?b.slice(0,_):b.subarray(0,_)}var a="Failed to ",s=function(T,I,_){if(T)throw new Error("".concat(a).concat(I,": the '").concat(_,"' option is unsupported."))},u=typeof Buffer=="function"&&Buffer.from,l=u?e:o;function c(){this.encoding="utf-8"}c.prototype.encode=function(x,T){return s(T&&T.stream,"encode","stream"),l(x)};function f(x){var T;try{var I=new Blob([x],{type:"text/plain;charset=UTF-8"});T=URL.createObjectURL(I);var _=new XMLHttpRequest;return _.open("GET",T,!1),_.send(),_.responseText}finally{T&&URL.revokeObjectURL(T)}}var d=!u&&typeof Blob=="function"&&typeof URL=="function"&&typeof URL.createObjectURL=="function",p=["utf-8","utf8","unicode-1-1-utf-8"],g=t;u?g=r:d&&(g=function(T){try{return f(T)}catch(I){return t(T)}});var k="construct 'TextDecoder'",S="".concat(a," ").concat(k,": the ");function C(x,T){s(T&&T.fatal,k,"fatal"),x=x||"utf-8";var I;if(u?I=Buffer.isEncoding(x):I=p.indexOf(x.toLowerCase())!==-1,!I)throw new RangeError("".concat(S," encoding label provided ('").concat(x,"') is invalid."));this.encoding=x,this.fatal=!1,this.ignoreBOM=!1}C.prototype.decode=function(x,T){s(T&&T.stream,"decode","stream");var I;return x instanceof Uint8Array?I=x:x.buffer instanceof ArrayBuffer?I=new Uint8Array(x.buffer):I=new Uint8Array(x),g(I,this.encoding)},n.TextEncoder=n.TextEncoder||c,n.TextDecoder=n.TextDecoder||C})(typeof window!="undefined"?window:typeof global!="undefined"?global:nm)});var Xm=re((mO,va)=>{h();function G_(n){throw new TypeError('"'+n+'" is read-only')}va.exports=G_,va.exports.__esModule=!0,va.exports.default=va.exports});var Hv=re((n1,Uv)=>{h();var tA="Expected a function",$v=NaN,nA="[object Symbol]",rA=/^\s+|\s+$/g,oA=/^[-+]0x[0-9a-f]+$/i,iA=/^0b[01]+$/i,aA=/^0o[0-7]+$/i,sA=parseInt,uA=typeof global=="object"&&global&&global.Object===Object&&global,lA=typeof self=="object"&&self&&self.Object===Object&&self,cA=uA||lA||Function("return this")(),fA=Object.prototype,dA=fA.toString,pA=Math.max,gA=Math.min,Wf=function(){return cA.Date.now()};function hA(n,r,e){var t,o,a,s,u,l,c=0,f=!1,d=!1,p=!0;if(typeof n!="function")throw new TypeError(tA);r=Gv(r)||0,Of(e)&&(f=!!e.leading,d="maxWait"in e,a=d?pA(Gv(e.maxWait)||0,r):a,p="trailing"in e?!!e.trailing:p);function g(b){var A=t,N=o;return t=o=void 0,c=b,s=n.apply(N,A),s}function k(b){return c=b,u=setTimeout(x,r),f?g(b):s}function S(b){var A=b-l,N=b-c,F=r-A;return d?gA(F,a-N):F}function C(b){var A=b-l,N=b-c;return l===void 0||A>=r||A<0||d&&N>=a}function x(){var b=Wf();if(C(b))return T(b);u=setTimeout(x,S(b))}function T(b){return u=void 0,p&&t?g(b):(t=o=void 0,s)}function I(){u!==void 0&&clearTimeout(u),c=0,t=l=o=u=void 0}function _(){return u===void 0?s:T(Wf())}function M(){var b=Wf(),A=C(b);if(t=arguments,o=this,l=b,A){if(u===void 0)return k(l);if(d)return u=setTimeout(x,r),g(l)}return u===void 0&&(u=setTimeout(x,r)),s}return M.cancel=I,M.flush=_,M}function Of(n){var r=typeof n;return!!n&&(r=="object"||r=="function")}function mA(n){return!!n&&typeof n=="object"}function vA(n){return typeof n=="symbol"||mA(n)&&dA.call(n)==nA}function Gv(n){if(typeof n=="number")return n;if(vA(n))return $v;if(Of(n)){var r=typeof n.valueOf=="function"?n.valueOf():n;n=Of(r)?r+"":r}if(typeof n!="string")return n===0?n:+n;n=n.replace(rA,"");var e=iA.test(n);return e||aA.test(n)?sA(n.slice(2),e?2:8):oA.test(n)?$v:+n}Uv.exports=hA});var Tn=re((Q1,Ta)=>{h();function gy(n,r,e,t,o,a,s){try{var u=n[a](s),l=u.value}catch(c){return void e(c)}u.done?r(l):Promise.resolve(l).then(t,o)}function _A(n){return function(){var r=this,e=arguments;return new Promise(function(t,o){var a=n.apply(r,e);function s(l){gy(a,t,o,s,u,"next",l)}function u(l){gy(a,t,o,s,u,"throw",l)}s(void 0)})}}Ta.exports=_A,Ta.exports.__esModule=!0,Ta.exports.default=Ta.exports});var Hy=re((BF,Ia)=>{h();var PA=Ru(),RA=qu(),BA=Ya(),WA=Wu();function OA(n){return PA(n)||RA(n)||BA(n)||WA()}Ia.exports=OA,Ia.exports.__esModule=!0,Ia.exports.default=Ia.exports});var OC=re((k3,WC)=>{h();WC.exports={version:"2.35.1448"}});var Yx=re(Cu=>{"use strict";h();Object.defineProperty(Cu,"__esModule",{value:!0});var hE;(function(n){n.DesignerSlideSuggestion="Designer.Slides",n.TextToSmartArtSuggestion="Designer.TextToSmartArt",n.PowerPointTextTileChanged="PowerPoint.TextTileChanged",n.SlideContentChange="PowerPoint.SlideContentChange",n.IdeasExecuteAction="Ideas.ExecuteAction"})(hE=Cu.MessageType||(Cu.MessageType={}))});var Xx=re(xu=>{"use strict";h();Object.defineProperty(xu,"__esModule",{value:!0});var mE;(function(n){n[n.Error=0]="Error",n[n.Warn=1]="Warn",n[n.Info=2]="Info",n[n.Debug=3]="Debug"})(mE=xu.LoggingLevel||(xu.LoggingLevel={}))});var Zx=re(Tu=>{"use strict";h();Object.defineProperty(Tu,"__esModule",{value:!0});var vE;(function(n){n.NotSet="NotSet",n.Timeout="Timeout",n.NetworkError="NetworkError",n.ServiceError="ServiceError",n.ParsingError="ParsingError",n.AuthenticationError="AuthenticationError",n.UnhandledException="UnhandledException"})(vE=Tu.ProviderErrorType||(Tu.ProviderErrorType={}))});var eT=re(Iu=>{"use strict";h();Object.defineProperty(Iu,"__esModule",{value:!0});var yE;(function(n){n.Invalid="Invalid",n.Success="Success",n.Error="Error",n.Pending="Pending",n.NoResult="NoResult"})(yE=Iu.ProviderResultStatus||(Iu.ProviderResultStatus={}))});var tT=re(_u=>{"use strict";h();Object.defineProperty(_u,"__esModule",{value:!0});var kE;(function(n){n[n.NotSet=0]="NotSet",n[n.Measure=1]="Measure",n[n.Diagnostics=2]="Diagnostics",n[n.CriticalBusinessImpact=191]="CriticalBusinessImpact",n[n.CriticalCensus=192]="CriticalCensus",n[n.CriticalExperimentation=193]="CriticalExperimentation",n[n.CriticalUsage=194]="CriticalUsage"})(kE=_u.SamplingPolicy||(_u.SamplingPolicy={}))});var nT=re(wt=>{"use strict";h();Object.defineProperty(wt,"__esModule",{value:!0});var wE;(function(n){n.DESIGNER_SLIDE_PROVIDER_ID="Provider.Designer.Slide",n.SLIDE_SUGGESTION_ID="EntityGroup.Designer.Slide.Suggestion"})(wE=wt.DesignerSlideProviderIdentifier||(wt.DesignerSlideProviderIdentifier={}));var SE;(function(n){n.MAKE_IT_VISUAL_PROVIDER_ID="Provider.UCI.MakeItVisual",n.MAKE_IT_VISUAL_KEYWORDS_ID="EntityGroup.UCI.MakeItVisual.Keywords"})(SE=wt.MakeItVisualProviderIdentifier||(wt.MakeItVisualProviderIdentifier={}));var CE;(function(n){n.DESIGNER_TEXT_TO_SMARTART_PROVIDER_ID="Provider.Designer.TextToSmartArt",n.TEXT_TO_SMARTART_SUGGESTION_ID="EntityGroup.Designer.TextToSmartArt.Suggestion"})(CE=wt.DesignerTextToSmartArtProviderIdentifier||(wt.DesignerTextToSmartArtProviderIdentifier={}));var xE;(function(n){n.HUBBLE_PROVIDER_ID="Provider.Hubble",n.HUBBLE_IMAGES_GROUP_ID="EntityGroup.Hubble.Images"})(xE=wt.HubbleProviderIdentifier||(wt.HubbleProviderIdentifier={}));var TE;(function(n){n.TAP_SEARCH_QF_PROVIDER_ID="Provider.Tap.Search.QF",n.TAP_SEARCH_QF_AND_OLS_PROVIDER_ID="Provider.Tap.Search.QFAndOLS",n.TAP_SEARCH_OLS_PROVIDER_ID="Provider.Tap.Search.OLS",n.TAP_SEARCH_SP_PROVIDER_ID="Provider.Tap.Search.SP",n.TAP_SEARCH_ZERO_TERM_QF_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.QF",n.TAP_SEARCH_ZERO_TERM_QF_AND_OLS_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.QFAndOLS",n.TAP_SEARCH_ZERO_TERM_OLS_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.OLS",n.TAP_SEARCH_ZERO_TERM_SP_PROVIDER_ID="Provider.Tap.Search.ZeroTerm.SP",n.DOCUMENT_ID="EntityGroup.Tap.Document"})(TE=wt.TapProviderIdentifier||(wt.TapProviderIdentifier={}));var IE;(function(n){n.DICTIONARY_PROVIDER_ID="Provider.UCI.Dictionary",n.DICTIONARY_WORDS_GROUP_ID="EntityGroup.UCI.Dictionary.Words"})(IE=wt.DictionaryProviderIdentifier||(wt.DictionaryProviderIdentifier={}));var _E;(function(n){n.IMAGES_PROVIDER_ID="Provider.UCI.Images",n.IMAGES_ID="EntityGroup.UCI.Images.Images"})(_E=wt.ImagesProviderIdentifier||(wt.ImagesProviderIdentifier={}));var AE;(function(n){n.INSIGHTS_PROVIDER_ID="Provider.UCI.Insights",n.BINGANSWER_COMPUTATION_ID="EntityGroup.UCI.Insights.BingAnswer.Computation",n.BINGANSWER_CURRENCY_ID="EntityGroup.UCI.Insights.BingAnswer.Currency",n.BINGANSWER_FACTS_ID="EntityGroup.UCI.Insights.BingAnswer.Facts",n.BINGANSWER_FINANCE_ID="EntityGroup.UCI.Insights.BingAnswer.Finance",n.BINGANSWER_NEWS_ID="EntityGroup.UCI.Insights.BingAnswer.News",n.BINGANSWER_WEATHER_ID="EntityGroup.UCI.Insights.BingAnswer.Weather",n.DICTIONARY_ID="EntityGroup.UCI.Insights.Dictionary",n.ENTITIES_ID="EntityGroup.UCI.Insights.Entities",n.IMAGES_ID="EntityGroup.UCI.Insights.Images",n.WEBRESULTS_ID="EntityGroup.UCI.Insights.WebResults",n.WIKIPEDIARESULTS_ID="EntityGroup.UCI.Insights.WikipediaResults"})(AE=wt.InsightsProviderIdentifier||(wt.InsightsProviderIdentifier={}))});var wp=re($t=>{"use strict";h();Object.defineProperty($t,"__esModule",{value:!0});var bE=Yx();$t.MessageType=bE.MessageType;var ME=Xx();$t.LoggingLevel=ME.LoggingLevel;var EE=Zx();$t.ProviderErrorType=EE.ProviderErrorType;var NE=eT();$t.ProviderResultStatus=NE.ProviderResultStatus;var DE=tT();$t.SamplingPolicy=DE.SamplingPolicy;var Or=nT();$t.DesignerSlideProviderIdentifier=Or.DesignerSlideProviderIdentifier;$t.MakeItVisualProviderIdentifier=Or.MakeItVisualProviderIdentifier;$t.DesignerTextToSmartArtProviderIdentifier=Or.DesignerTextToSmartArtProviderIdentifier;$t.HubbleProviderIdentifier=Or.HubbleProviderIdentifier;$t.TapProviderIdentifier=Or.TapProviderIdentifier;$t.DictionaryProviderIdentifier=Or.DictionaryProviderIdentifier;$t.ImagesProviderIdentifier=Or.ImagesProviderIdentifier;$t.InsightsProviderIdentifier=Or.InsightsProviderIdentifier});var rT=re(Sp=>{"use strict";h();Object.defineProperty(Sp,"__esModule",{value:!0});var Va=wp(),PE=function(){function n(r,e){this.logger=r,this.configuration=e,this.shouldMatchDocumentTitle=!1,this.shouldMatchDocumentTitle=this.configuration?this.configuration.shouldQueryMatchQfDocumentTitle:n.defaultShouldQueryMatchQfDocumentTitle}return n.prototype.rank=function(r,e){var t=this,o=e.rankedEntityGroups.slice();return o.sort(function(a,s){var u=t.getProviderRank(r,a),l=t.getProviderRank(r,s);return a.providerId==s.providerId&&a.providerId==Va.InsightsProviderIdentifier.INSIGHTS_PROVIDER_ID?a.rank-s.rank:u-l}),e.rankedEntityGroups=o,this.logger.info(595994314,"[SmartLookupRanker] RankedResults",{interactionId:r.interactionId,transactionId:r.transactionId,queryMatchEnabled:this.shouldMatchDocumentTitle,ranking:e.rankedEntityGroups.map(function(a){return a.groupTypeId})}),e},n.prototype.getProviderRank=function(r,e){var t=this;if(e.providerId==Va.TapProviderIdentifier.TAP_SEARCH_QF_PROVIDER_ID&&this.shouldMatchDocumentTitle){var o=e;if(o.groupTypeId==Va.TapProviderIdentifier.DOCUMENT_ID){var a=r,s=a!=null&&a.tapContext!=null?a.tapContext.queryText.toLocaleLowerCase().split(n.separators).filter(function(u){return u}):void 0;if(o.data.find(function(u){return t.isTextContainsSearchWords(u.Title.toLocaleLowerCase(),s)}))this.logger.debug(595973527,"[SmartLookupRanker] Query match with Qf Document succeeded",{interactionId:r.interactionId,transactionId:r.transactionId});else return this.logger.debug(595973526,"[SmartLookupRanker] Query match with Qf Document failed",{interactionId:r.interactionId,transactionId:r.transactionId}),Number.MAX_VALUE}}return n.providerRank[e.providerId]?n.providerRank[e.providerId]:Number.MAX_VALUE},n.prototype.isTextContainsSearchWords=function(r,e){if(e==null||r==null)return!1;var t=r.split(n.separators);return e.every(function(o){return t.find(function(a){return a.indexOf(o)>=0})!=null})},n.providerRank=(Au={},Au[Va.TapProviderIdentifier.TAP_SEARCH_QF_PROVIDER_ID]=1,Au[Va.InsightsProviderIdentifier.INSIGHTS_PROVIDER_ID]=2,Au),n.separators=/[\s]+/,n.defaultShouldQueryMatchQfDocumentTitle=!1,n}();Sp.SmartLookupRanker=PE;var Au});var oT=re(Cp=>{"use strict";h();Object.defineProperty(Cp,"__esModule",{value:!0});var RE=rT();Cp.SmartLookupRanker=RE.SmartLookupRanker});var iT=re((JV,Qa)=>{h();function BE(n){if(n==null)throw new TypeError("Cannot destructure "+n)}Qa.exports=BE,Qa.exports.__esModule=!0,Qa.exports.default=Qa.exports});var vT=re((a8,mT)=>{h();mT.exports=OfficePlatformGlobal.Telemetry.OTel});var kT=re((u8,yT)=>{h();yT.exports=OfficePlatformGlobal.Telemetry.OTelSDX});h();var RT=w(Np());h();var Ka=w(Pp());h();var Rp=function(n){return n[n.Unknown=0]="Unknown",n[n.LiveId=1]="LiveId",n[n.OrgId=2]="OrgId",n[n.ActiveDirectory=3]="ActiveDirectory",n[n.ADAL=4]="ADAL",n[n.SSPI=5]="SSPI",n[n.OAuth2=6]="OAuth2",n}({});var Yt=function(n){return n[n.Error=0]="Error",n[n.Warning=1]="Warning",n[n.Info=3]="Info",n[n.Metric=4]="Metric",n[n.Verbose=5]="Verbose",n[n.Debug=6]="Debug",n}({});Ka.CustomTypeRegistry.registerTypeInfos({"AugLoopData::InputData":{InputSchema:"$string",InputJson:"$string",CorrelationVector:"$string"},"AugLoopData::ResultData":{InputSchema:"$string",InputJson:"$string",OutputSchema:"$string",OutputJson:"$string"},"AugLoopData::ServiceGroups":{OfficeServiceGroup:"$number",ControllerServiceGroup:"$number"},"AugLoopData::HostMetadata":{AppName:"$string",AppPlatform:"$string",AppVersion:"$string",UILanguage:"$string",ClientId:"$string",ReleaseAudienceGroup:"$string",ReleaseChannel:"$string",ReleaseFork:"$string",SessionId:"$string",Flights:"$string",PrivateMode:"$boolean",DisabledServiceGroups:["$array","AugLoopData::ServiceGroups"],SystemTimezone:["opt-field","$string"],IsClientTelemetrySampled:["opt-field","$boolean"]},"AugLoopData::ConfigTicket":{Provider:"$number",Policy:"$string",Target:"$string",ResourceId:"$string",AuthorityUrl:"$string"},"AugLoopData::ConnectParams":{isSeedingRequired:["opt-field","$boolean"],sessionUrl:["opt-field","$string"],origin:["opt-field","$string"],authToken:["opt-field","$string"]},"AugLoopData::AuthTokenRequest":{Tickets:["$array","AugLoopData::ConfigTicket"],DocId:["opt-field","$string"],DocSessionId:["opt-field","$string"],TokenType:["opt-field","$number"],ConnectParams:["opt-field","AugLoopData::ConnectParams"],Claims:["opt-field","$string"],Interactive:["opt-field","$boolean"]},"AugLoopData::AuthTokenResponse":{Token:"$string",TokenError:["opt-field","$number"]},"AugLoopData::IdentityWithToken":{IdentityId:"$string",Token:"$string"},"AugLoopData::AuthTokensResponse":{Identites:["$array","AugLoopData::IdentityWithToken"]},"AugLoopData::CreateSessionParameters":{docSessionId:["opt-field","$string"],extensionConfigs:["opt-field",["$array","$string"]],flights:["opt-field","$string"],serviceUrl:["opt-field","$string"],offlineMode:["opt-field","$boolean"]},"AugLoopData::ActivateAnnotationParameters":{annotationType:"$string",token:"$string",config:["opt-field","$string"],docSessionId:["opt-field","$string"],forceReturnCachedAnnotations:["opt-field","$boolean"]},"AugLoopData::ReleaseAnnotationParameters":{token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::SubmitOperationsParameters":{operations:["$array","$string"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitSeedOperationsParameters":{operations:["$array","$string"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitSeedGroupOperationsParameters":{operations:["$array","$string"],groupComplete:["opt-field","$boolean"],cv:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SubmitCustomMessageParameters":{message:"$string",messageId:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ForceReconnectParameters":{docSessionId:["opt-field","$string"],extensionConfigs:["opt-field",["$array","$string"]]},"AugLoopData::CloseParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::AuthenticateInteractiveParameters":{docSessionId:["opt-field","$string"],token:["opt-field","$string"]},"AugLoopData::SetSessionCloseCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetConnectCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetDisconnectCallbackParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::SetClaimsChallengeCallbackParameters":{docSessionId:["opt-field","$string"],token:["opt-field","$number"]},"AugLoopData::SetOfflineModeParameters":{docSessionId:["opt-field","$string"]},"AugLoopData::BridgeMessageParameters":{bridgeId:"$string",docSessionId:["opt-field","$string"],bridgeMessage:["opt-field","$string"],binaryMessage:["opt-field",["$array","$number"]]},"AugLoopData::SDXBridgeMessageParameters":{bridgeMessage:"$string"},"AugLoopData::InitAugLoopBridgeManagerParameters":{},"AugLoopData::CreateSessionResult":{errMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::ActivateAnnotationResult":{errMessage:["opt-field","$string"],token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::AnnotationResult":{operation:"$string",token:"$string",docSessionId:["opt-field","$string"],annotationType:"$string"},"AugLoopData::ReleaseAnnotationResult":{errMessage:["opt-field","$string"],token:"$string",result:["opt-field","$boolean"]},"AugLoopData::SubmitCustomMessageResult":{errMessage:["opt-field","$string"],response:["opt-field","$string"],messageId:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ForceReconnectResult":{errMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::SessionCloseResult":{sessionCloseMessage:["opt-field","$string"],docSessionId:["opt-field","$string"]},"AugLoopData::AuthenticateInteractiveResult":{errMessage:["opt-field","$string"],token:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ConnectResult":{isSeedingRequired:"$boolean",sessionUrl:"$string",origin:"$string",authToken:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::DisconnectResult":{error:"$string",docSessionId:["opt-field","$string"]},"AugLoopData::ClaimsChallengeResult":{claimsChallengeMessage:["opt-field","$string"],docSessionId:["opt-field","$string"],token:["opt-field","$number"]}});var zT={NativeService:["AugLoopData::NativeService",{OnResult:["FireAndForgetMethod",["AugLoopData::ResultData"]],OnCreateSessionResult:["FireAndForgetMethod",["AugLoopData::CreateSessionResult"]],OnActivateAnnotationResult:["FireAndForgetMethod",["AugLoopData::ActivateAnnotationResult"]],OnAnnotationResult:["FireAndForgetMethod",["AugLoopData::AnnotationResult"]],OnReleaseAnnotationResult:["FireAndForgetMethod",["AugLoopData::ReleaseAnnotationResult"]],OnSubmitCustomMessageResult:["FireAndForgetMethod",["AugLoopData::SubmitCustomMessageResult"]],OnForceReconnectResult:["FireAndForgetMethod",["AugLoopData::ForceReconnectResult"]],OnSessionCloseResult:["FireAndForgetMethod",["AugLoopData::SessionCloseResult"]],OnAuthenticateInteractiveResult:["FireAndForgetMethod",["AugLoopData::AuthenticateInteractiveResult"]],OnConnectResult:["FireAndForgetMethod",["AugLoopData::ConnectResult"]],OnDisconnectResult:["FireAndForgetMethod",["AugLoopData::DisconnectResult"]],OnClaimsChallengeResult:["FireAndForgetMethod",["AugLoopData::ClaimsChallengeResult"]],OnIngressAugLoopBridgeMessage:["FireAndForgetMethod",["AugLoopData::BridgeMessageParameters"]],OnSDXBridgeMessageResult:["FireAndForgetMethod",["AugLoopData::SDXBridgeMessageParameters"]],RequestAuthToken:["ReturnsPromiseMethod","AugLoopData::AuthTokenResponse",["AugLoopData::AuthTokenRequest"]],RequestAuthTokens:["ReturnsPromiseMethod","AugLoopData::AuthTokensResponse",["AugLoopData::AuthTokenRequest"]],IsFeatureEnabled:["ReturnsPromiseMethod","$boolean",["$string","$string"]],IsChangeGateEnabled:["ReturnsPromiseMethod","$boolean",["$string"]],ExecuteLocalLambda:["ReturnsPromiseMethod","$string",["AugLoopData::InputData","$string","$string"]],AreLicenseFeaturesEnabled:["ReturnsPromiseMethod","$boolean",[["$array","$number"]]],SendDiagnosticTrace:["FireAndForgetMethod",["$number","$number","$string"]],OnSetServiceUrl:["Event","$string"],OnSetHostMetadata:["Event","AugLoopData::HostMetadata"],OnSubmit:["Event","AugLoopData::InputData"],OnCreateSession:["Event","AugLoopData::CreateSessionParameters"],OnActivateAnnotation:["Event","AugLoopData::ActivateAnnotationParameters"],OnReleaseAnnotation:["Event","AugLoopData::ReleaseAnnotationParameters"],OnSubmitOperations:["Event","AugLoopData::SubmitOperationsParameters"],OnSubmitSeedOperations:["Event","AugLoopData::SubmitSeedOperationsParameters"],OnSubmitSeedGroupOperations:["Event","AugLoopData::SubmitSeedGroupOperationsParameters"],OnSubmitCustomMessage:["Event","AugLoopData::SubmitCustomMessageParameters"],OnForceReconnect:["Event","AugLoopData::ForceReconnectParameters"],OnClose:["Event","AugLoopData::CloseParameters"],OnAuthenticateInteractive:["Event","AugLoopData::AuthenticateInteractiveParameters"],OnSetSessionCloseCallback:["Event","AugLoopData::SetSessionCloseCallbackParameters"],OnSetConnectCallback:["Event","AugLoopData::SetConnectCallbackParameters"],OnSetDisconnectCallback:["Event","AugLoopData::SetDisconnectCallbackParameters"],OnSetClaimsChallengeCallback:["Event","AugLoopData::SetClaimsChallengeCallbackParameters"],OnSetOfflineMode:["Event","AugLoopData::SetOfflineModeParameters"],OnInitAugLoopBridgeManager:["Event","AugLoopData::InitAugLoopBridgeManagerParameters"],OnEgressAugLoopBridgeMessage:["Event","AugLoopData::BridgeMessageParameters"],OnSDXBridgeMessageFromNative:["Event","AugLoopData::SDXBridgeMessageParameters"]}]},Bp={NativeService:Ka.RekaServiceRegistry.getNativeService(zT.NativeService)};h();var NT=w(dt());h();var st;(function(n){n[n.EditorLowPrivilege=0]="EditorLowPrivilege",n[n.AugLoopLowPrivilege=1]="AugLoopLowPrivilege",n[n.Anonymous=2]="Anonymous",n[n.ClientAssertion=3]="ClientAssertion",n[n.ClientAssertionV2=4]="ClientAssertionV2",n[n.AutoClpLowPrivilege=5]="AutoClpLowPrivilege",n[n.AutoClpAppOnlyLowPrivilege=6]="AutoClpAppOnlyLowPrivilege",n[n.Substrate=7]="Substrate",n[n.WacUserInfo=8]="WacUserInfo",n[n.OwaExchange=9]="OwaExchange",n[n.SmartCompose=10]="SmartCompose",n[n.WritingAnalyticsLowPrivilege=11]="WritingAnalyticsLowPrivilege",n[n.DWEngineLowPrivilege=12]="DWEngineLowPrivilege",n[n.SubstrateApp=13]="SubstrateApp",n[n.CortanaAppPop=14]="CortanaAppPop",n[n.OfficeAppsAppOnly=15]="OfficeAppsAppOnly",n[n.PPTFrontdoorAppPop=16]="PPTFrontdoorAppPop",n[n.EditorAppOnlyLowPrivilege=17]="EditorAppOnlyLowPrivilege",n[n.AugLoopApp=18]="AugLoopApp",n[n.MeetingIntelligenceApp=19]="MeetingIntelligenceApp",n[n.GraphApp=20]="GraphApp",n[n.IceServicesApp=21]="IceServicesApp",n[n.AzureMapsApp=22]="AzureMapsApp",n[n.SpoApp=23]="SpoApp",n[n.OneDrive=24]="OneDrive",n[n.GoogleDrive=25]="GoogleDrive",n[n.GettyApp=26]="GettyApp",n[n.Dropbox=27]="Dropbox",n[n.GooglePhotos=28]="GooglePhotos",n[n.EditorApp=29]="EditorApp",n[n.AmazonKindle=30]="AmazonKindle",n[n.ShredderApp=31]="ShredderApp",n[n.FormsLowPrivilege=32]="FormsLowPrivilege",n[n.VivaSalesLowPrivilege=33]="VivaSalesLowPrivilege",n[n.IntentSvcApp=34]="IntentSvcApp",n[n.DcgLowPrivilege=35]="DcgLowPrivilege",n[n.CSALowPrivilege=36]="CSALowPrivilege",n[n.ConsumerSydneyLowPrivilege=37]="ConsumerSydneyLowPrivilege",n[n.CompliantSydneyApp=38]="CompliantSydneyApp",n[n.M365AdminApp=39]="M365AdminApp",n[n.MeetingArtifactsServiceLowPrivilege=40]="MeetingArtifactsServiceLowPrivilege",n[n.AlchemyApp=41]="AlchemyApp",n[n.M365Admin=42]="M365Admin",n[n.ConsumerShellApp=43]="ConsumerShellApp",n[n.PowerQueryLowPrivilege=44]="PowerQueryLowPrivilege",n[n.CIIApp=45]="CIIApp",n[n.ConsumerShell=46]="ConsumerShell",n[n.AssistCopilotLowPrivilege=47]="AssistCopilotLowPrivilege",n[n.Pva=48]="Pva",n[n.TeamsCopilotServiceLowPrivilege=49]="TeamsCopilotServiceLowPrivilege",n[n.CallAnalytics=50]="CallAnalytics",n[n.IncomingPFT=51]="IncomingPFT",n[n.GraphExchange=52]="GraphExchange",n[n.EXOAdmin=53]="EXOAdmin",n[n.InsightsServicesLowPrivilege=54]="InsightsServicesLowPrivilege",n[n.VivaServicesLowPrivilege=55]="VivaServicesLowPrivilege",n[n.EcsAppOnly=56]="EcsAppOnly",n[n.ShredderLowPrivilege=57]="ShredderLowPrivilege",n[n.SpoLowPrivilege=58]="SpoLowPrivilege",n[n.PromptValidationApp=59]="PromptValidationApp",n[n.CompliantSydneyLowPrivilege=60]="CompliantSydneyLowPrivilege",n[n.SubstrateTenantFeedbackApp=61]="SubstrateTenantFeedbackApp",n[n.MonitoringPlatform=62]="MonitoringPlatform",n[n.YammerLowPrivilege=63]="YammerLowPrivilege",n[n.VivaLearningLowPrivilege=64]="VivaLearningLowPrivilege",n[n.VivaInsightsLowPrivilege=65]="VivaInsightsLowPrivilege",n[n.ClientAugLoopApp=66]="ClientAugLoopApp",n[n.AssistAuthLowPrivilege=67]="AssistAuthLowPrivilege",n[n.VivaLearningSearchPreProdLowPrivilege=68]="VivaLearningSearchPreProdLowPrivilege",n[n.SubstrateSearchApp=69]="SubstrateSearchApp",n[n.SparkContentPlatformLowPrivilege=70]="SparkContentPlatformLowPrivilege",n[n.SparkContentPlatformPopApp=71]="SparkContentPlatformPopApp",n[n.ConsumerSydneyApp=72]="ConsumerSydneyApp",n[n.BusinessAssistAuthLowPrivilege=73]="BusinessAssistAuthLowPrivilege",n[n.AzureResourceManager=74]="AzureResourceManager",n[n.AlchemyPortal=75]="AlchemyPortal",n[n.VivaUserSkillsApp=76]="VivaUserSkillsApp",n[n.VivaEngageAppPop=77]="VivaEngageAppPop",n[n.SubstrateAppOnly=78]="SubstrateAppOnly",n[n.PowerAutomateFlowCreationLowPrivilege=79]="PowerAutomateFlowCreationLowPrivilege",n[n.PowerAutomateConnectionCreationLowPrivilege=80]="PowerAutomateConnectionCreationLowPrivilege",n[n.PowerAutomateAuthorizeConnectionLowPrivilege=81]="PowerAutomateAuthorizeConnectionLowPrivilege",n[n.TCAAppPop=82]="TCAAppPop",n[n.BusinessAssistAuthAppPop=83]="BusinessAssistAuthAppPop",n[n.HolmesApp=84]="HolmesApp",n[n.GraphAppOnly=85]="GraphAppOnly",n[n.SimsApp=86]="SimsApp",n[n.VivaOrgInsightsLowPrivilege=87]="VivaOrgInsightsLowPrivilege",n[n.VivaGoalsAppPop=88]="VivaGoalsAppPop",n[n.GCBotAppPop=89]="GCBotAppPop",n[n.ShredderV2App=90]="ShredderV2App",n[n.ShredderV2LowPrivilege=91]="ShredderV2LowPrivilege",n[n.AmplifyProfileService=92]="AmplifyProfileService",n[n.AzureDevopsLowPrivilege=93]="AzureDevopsLowPrivilege",n[n.CommuteServices=94]="CommuteServices",n[n.GCBotAppOnly=95]="GCBotAppOnly",n[n.TCAAppOnly=96]="TCAAppOnly",n[n.MavenAgentLowPrivilege=97]="MavenAgentLowPrivilege",n[n.VivaOrgInsightsAppPop=98]="VivaOrgInsightsAppPop",n[n.EduAssignmentsPftAtPop=99]="EduAssignmentsPftAtPop",n[n.AugloopAppPop=100]="AugloopAppPop",n[n.OneNoteLowPrivilege=101]="OneNoteLowPrivilege",n[n.TeamsAuthzSvcAppPop=102]="TeamsAuthzSvcAppPop",n[n.LoopAppPop=103]="LoopAppPop",n[n.LoopAppOnly=104]="LoopAppOnly"})(st||(st={}));var Lp;(function(n){n[n.Unknown=0]="Unknown",n[n.Consumer=1]="Consumer",n[n.Enterprise=2]="Enterprise"})(Lp||(Lp={}));var Fp;(function(n){n.AuthorizationCode="authorization_code",n.ClientCredentials="client_credentials",n.RefreshToken="refresh_token"})(Fp||(Fp={}));var qp;(function(n){n[n.LoggedIn=0]="LoggedIn",n[n.LoggedOut=1]="LoggedOut"})(qp||(qp={}));h();var xo;(function(n){n[n.Add=1]="Add",n[n.Update=2]="Update",n[n.Delete=3]="Delete"})(xo||(xo={}));h();h();var Bt;(function(n){n[n.Undefined=0]="Undefined",n[n.Created=10]="Created",n[n.Sent=20]="Sent",n[n.Duplicated=30]="Duplicated",n[n.Seen=40]="Seen",n[n.Tried=50]="Tried",n[n.Kept=60]="Kept",n[n.Rejected=70]="Rejected"})(Bt||(Bt={}));h();var Fu;(function(n){n.Unknown="Unknown",n.Canvas="Canvas",n.CopilotChat="CopilotChat",n.Test="Test"})(Fu||(Fu={}));var St;(function(n){n[n.None=0]="None",n[n.Added=1]="Added",n[n.Updated=2]="Updated",n[n.Deleted=3]="Deleted"})(St||(St={}));var kr;(function(n){n[n.ContentChanged=0]="ContentChanged",n[n.ContentWasEmpty=1]="ContentWasEmpty",n[n.FormattingChanged=2]="FormattingChanged",n[n.ContentWasInsideOfTheTable=3]="ContentWasInsideOfTheTable"})(kr||(kr={}));var Re;(function(n){n[n.AddOfZeroElements=0]="AddOfZeroElements",n[n.AddOfItemsWithExtraOrMissingIds=1]="AddOfItemsWithExtraOrMissingIds",n[n.AddOfItemWithUndefinedId=2]="AddOfItemWithUndefinedId",n[n.AddOfUndefinedItem=3]="AddOfUndefinedItem",n[n.AddOfItemsWithDuplicateIds=4]="AddOfItemsWithDuplicateIds",n[n.SetHeadToNonExistingItem=5]="SetHeadToNonExistingItem",n[n.DeleteOfNonExistingItem=6]="DeleteOfNonExistingItem",n[n.UpdateOfNonExistentItem=7]="UpdateOfNonExistentItem",n[n.UpdateOfStubbedItem=8]="UpdateOfStubbedItem",n[n.MoveOfNonExistentItem=9]="MoveOfNonExistentItem",n[n.UpdateMetaDataOfNonAnnotationType=10]="UpdateMetaDataOfNonAnnotationType",n[n.SequentialyInvertedUpdate=11]="SequentialyInvertedUpdate",n[n.MoveToTheSamePath=12]="MoveToTheSamePath",n[n.UnknownOperation=13]="UnknownOperation",n[n.DeltaOfNonExistingItem=100]="DeltaOfNonExistingItem"})(Re||(Re={}));h();var zp=w(R()),Vp=w(P());var To;(function(n){n[n.None=0]="None",n[n.HttpsGetDownloadUrl=1]="HttpsGetDownloadUrl",n[n.AlCodedLocation=2]="AlCodedLocation",n[n.Token=3]="Token"})(To||(To={}));var Hp;(function(n){n[n.NewDocument=0]="NewDocument",n[n.EditDocument=1]="EditDocument",n[n.ViewOnlyDocument=2]="ViewOnlyDocument"})(Hp||(Hp={}));var Lr=(0,zp.default)(function n(){(0,Vp.default)(this,n)});Lr.lowerIndexBound=1;Lr.maxNumberOfRows=1048576;Lr.maxNumberOfColumns=16384;Lr.firstColumnName="A";Lr.lastColumnName="XFD";h();var Za=w(P()),es=w(R());h();var Jp=w(Se()),Kp=w(P()),Yp=w(R()),m=function(){function n(r){(0,Kp.default)(this,n),n.assign(n,this,r)}return(0,Yp.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_SchemaObject"}},{key:"getBaseTypes",value:function(){return[]}},{key:"getTypeNameFor",value:function(e){return e&&e.H_?e.H_.T_:void 0}},{key:"getBaseTypesFor",value:function(e){return e&&e.H_&&e.H_.B_?e.H_.B_:[]}},{key:"getAllTypesFor",value:function(e){var t=n.getTypeNameFor(e);return t?[t].concat((0,Jp.default)(n.getBaseTypesFor(e))):[]}},{key:"matchesTypesFor",value:function(e,t){if(!Array.isArray(t)||t.length===0)return!0;var o=n.getTypeNameFor(e),a=n.getBaseTypesFor(e);for(var s of t)if(s===o||a.indexOf(s)>=0)return!0;return!1}},{key:"assign",value:function(e,t,o){if(o)for(var a of Object.keys(o))t[a]=o[a];return t.H_=e.H_,t}}])}();m.H_={T_:m.getTypeName(),B_:m.getBaseTypes()};var _t=function(){function n(r){(0,Za.default)(this,n),m.assign(n,this,r)}return(0,es.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_Annotation"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();_t.H_={T_:_t.getTypeName(),B_:_t.getBaseTypes()};var $u=function(){function n(r){(0,Za.default)(this,n),m.assign(n,this,r)}return(0,es.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_BinaryClassificationAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();$u.H_={T_:$u.getTypeName(),B_:$u.getBaseTypes()};var Gu=function(){function n(r){(0,Za.default)(this,n),m.assign(n,this,r)}return(0,es.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_StreamAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Gu.H_={T_:Gu.getTypeName(),B_:Gu.getBaseTypes()};h();var Hu=w(P()),zu=w(R());var Fr=function(){function n(r){(0,Hu.default)(this,n),m.assign(n,this,r)}return(0,zu.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Event"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Fr.H_={T_:Fr.getTypeName(),B_:Fr.getBaseTypes()};var Uu=function(){function n(r){(0,Hu.default)(this,n),m.assign(n,this,r)}return(0,zu.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserCommand"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Event"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Uu.H_={T_:Uu.getTypeName(),B_:Uu.getBaseTypes()};h();var vt=w(P()),yt=w(R());var Vu=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemDelta"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Vu.H_={T_:Vu.getTypeName(),B_:Vu.getBaseTypes()};var Hn=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemChangesDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Hn.H_={T_:Hn.getTypeName(),B_:Hn.getBaseTypes()};var wr=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Operation"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();wr.H_={T_:wr.getTypeName(),B_:wr.getBaseTypes()};var Qu=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_OperationWithSiblingContext"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Qu.H_={T_:Qu.getTypeName(),B_:Qu.getBaseTypes()};var we=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_AddOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();we.H_={T_:we.getTypeName(),B_:we.getBaseTypes()};var mn=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_MoveOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();mn.H_={T_:mn.getTypeName(),B_:mn.getBaseTypes()};var mt=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();mt.H_={T_:mt.getTypeName(),B_:mt.getBaseTypes()};var Oe=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UpdateOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Oe.H_={T_:Oe.getTypeName(),B_:Oe.getBaseTypes()};var He=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DeleteOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();He.H_={T_:He.getTypeName(),B_:He.getBaseTypes()};var ju=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ju.H_={T_:ju.getTypeName(),B_:ju.getBaseTypes()};var Io=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeSubtreeExceptTypesOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Io.H_={T_:Io.getTypeName(),B_:Io.getBaseTypes()};var _o=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_PurgeByTypesOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();_o.H_={T_:_o.getTypeName(),B_:_o.getBaseTypes()};var Ju=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_FocusOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ju.H_={T_:Ju.getTypeName(),B_:Ju.getBaseTypes()};var Ku=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_VisibilityOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ku.H_={T_:Ku.getTypeName(),B_:Ku.getBaseTypes()};var At=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DeltaUpdateOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();At.H_={T_:At.getTypeName(),B_:At.getBaseTypes()};var Yu=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_MicroSyncOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Yu.H_={T_:Yu.getTypeName(),B_:Yu.getBaseTypes()};var it=function(){function n(r){(0,vt.default)(this,n),m.assign(n,this,r)}return(0,yt.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_SignalOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();it.H_={T_:it.getTypeName(),B_:it.getBaseTypes()};h();var ts=w(P()),ns=w(R());var Xt=function(){function n(r){(0,ts.default)(this,n),m.assign(n,this,r)}return(0,ns.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_Signal"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Xt.H_={T_:Xt.getTypeName(),B_:Xt.getBaseTypes()};var bn=function(){function n(r){(0,ts.default)(this,n),m.assign(n,this,r)}return(0,ns.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DirtyAreaSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();bn.H_={T_:bn.getTypeName(),B_:bn.getBaseTypes()};var Xu=function(){function n(r){(0,ts.default)(this,n),m.assign(n,this,r)}return(0,ns.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DirtyDocumentSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Xu.H_={T_:Xu.getTypeName(),B_:Xu.getBaseTypes()};h();var Mt=w(P()),Et=w(R());var Zu=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Blob"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Zu.H_={T_:Zu.getTypeName(),B_:Zu.getBaseTypes()};var el=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Binary"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();el.H_={T_:el.getTypeName(),B_:el.getBaseTypes()};var tl=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_TileGroup"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();tl.H_={T_:tl.getTypeName(),B_:tl.getBaseTypes()};var nl=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Session"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();nl.H_={T_:nl.getTypeName(),B_:nl.getBaseTypes()};var bt=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_Document"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();bt.H_={T_:bt.getTypeName(),B_:bt.getBaseTypes()};var zn=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_SubDocument"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();zn.H_={T_:zn.getTypeName(),B_:zn.getBaseTypes()};var Mn=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_GridCell"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Mn.H_={T_:Mn.getTypeName(),B_:Mn.getBaseTypes()};var rl=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_GridNeighborhoodContext"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();rl.H_={T_:rl.getTypeName(),B_:rl.getBaseTypes()};var ol=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ItemFilter"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ol.H_={T_:ol.getTypeName(),B_:ol.getBaseTypes()};var il=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_DynamicContext"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();il.H_={T_:il.getTypeName(),B_:il.getBaseTypes()};var xi=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_ContextHolder"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();xi.H_={T_:xi.getTypeName(),B_:xi.getBaseTypes()};var Sr=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserContextHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ContextHolder"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Sr.H_={T_:Sr.getTypeName(),B_:Sr.getBaseTypes()};var Cr=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_TenantContextHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ContextHolder"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Cr.H_={T_:Cr.getTypeName(),B_:Cr.getBaseTypes()};var al=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_EventsHolder"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();al.H_={T_:al.getTypeName(),B_:al.getBaseTypes()};var Ti=function(){function n(r){(0,Mt.default)(this,n),m.assign(n,this,r)}return(0,Et.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_UserCommandsHolder"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_EventsHolder"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ti.H_={T_:Ti.getTypeName(),B_:Ti.getBaseTypes()};h();var Ao=w(P()),bo=w(R());var Ht=function(){function n(r){(0,Ao.default)(this,n),m.assign(n,this,r)}return(0,bo.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_Apology"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ht.H_={T_:Ht.getTypeName(),B_:Ht.getBaseTypes()};var sl=function(){function n(r){(0,Ao.default)(this,n),m.assign(n,this,r)}return(0,bo.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_SecondaryApology"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();sl.H_={T_:sl.getTypeName(),B_:sl.getBaseTypes()};var ul=function(){function n(r){(0,Ao.default)(this,n),m.assign(n,this,r)}return(0,bo.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_WorkflowActivationFailureDetails"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ul.H_={T_:ul.getTypeName(),B_:ul.getBaseTypes()};var ll=function(){function n(r){(0,Ao.default)(this,n),m.assign(n,this,r)}return(0,bo.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Core_AuthTokenIsMissingDetails"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_WorkflowActivationFailureDetails"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ll.H_={T_:ll.getTypeName(),B_:ll.getBaseTypes()};var cl=function(){function n(r){(0,Ao.default)(this,n),m.assign(n,this,r)}return(0,bo.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Core_NotActivatedWorkflowApology"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Apology","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();cl.H_={T_:cl.getTypeName(),B_:cl.getBaseTypes()};h();var Xp;(function(n){n[n.MastermindAsyncBoundaryLoader=0]="MastermindAsyncBoundaryLoader",n[n.TruncatedModelIteratingLoader=1]="TruncatedModelIteratingLoader",n[n.ExcelAsyncBoundaryLoader=2]="ExcelAsyncBoundaryLoader"})(Xp||(Xp={}));var qr;(function(n){n[n.Filtering=0]="Filtering",n[n.ModelIterating=1]="ModelIterating"})(qr||(qr={}));h();var rs;(function(n){n[n.Unknown=0]="Unknown",n[n.LiveId=1]="LiveId",n[n.OrgId=2]="OrgId",n[n.ActiveDirectory=3]="ActiveDirectory",n[n.ADAL=4]="ADAL",n[n.SSPI=5]="SSPI",n[n.OAuth2=6]="OAuth2",n[n.Badger=7]="Badger"})(rs||(rs={}));var $r;(function(n){n[n.Augloop=0]="Augloop",n[n.Substrate=1]="Substrate"})($r||($r={}));var os;(function(n){n[n.Unknown=0]="Unknown",n[n.TokenMissingInteractionRequired=1]="TokenMissingInteractionRequired"})(os||(os={}));h();var vn;(function(n){n[n.Input=0]="Input",n[n.Exception=1]="Exception",n[n.WaitOn=2]="WaitOn",n[n.StopAndFilterWorkflow=3]="StopAndFilterWorkflow"})(vn||(vn={}));var Te;(function(n){n[n.Unknown=0]="Unknown",n[n.NoOutput=1]="NoOutput",n[n.Authentication=2]="Authentication",n[n.JoinTimedOut=3]="JoinTimedOut",n[n.LambdaThrow=4]="LambdaThrow",n[n.LambdaErrorCallback=5]="LambdaErrorCallback"})(Te||(Te={}));h();var Ii;(function(n){var r;(function(e){e[e.Undefined=0]="Undefined",e[e.Delete=1]="Delete",e[e.Add=2]="Add",e[e.Change=3]="Change",e[e.Refresh=4]="Refresh"})(r=n.SlideTileEventType||(n.SlideTileEventType={}))})(Ii||(Ii={}));h();var Vn;(function(n){var r;(function(u){u[u.Unknown=0]="Unknown",u[u.Text=1]="Text",u[u.Slide=2]="Slide"})(r=n.TileType||(n.TileType={}));var e;(function(u){u[u.Generic=0]="Generic",u[u.Title=1]="Title",u[u.SmartArt=2]="SmartArt",u[u.TableCell=3]="TableCell",u[u.TextBox=4]="TextBox",u[u.Notes=5]="Notes"})(e=n.TextTileType||(n.TextTileType={}));var t;(function(u){u[u.Undefined=0]="Undefined",u[u.Word=1]="Word",u[u.Phrase=2]="Phrase",u[u.Sentence=3]="Sentence",u[u.Paragraph=4]="Paragraph"})(t=n.TextTileElementUnit||(n.TextTileElementUnit={}));var o;(function(u){u[u.Undefined=0]="Undefined",u[u.Bullet=1]="Bullet",u[u.Numbered=2]="Numbered"})(o=n.ListType||(n.ListType={}));var a;(function(u){u[u.Undefined=0]="Undefined",u[u.AlphaLcParenBoth=1]="AlphaLcParenBoth",u[u.AlphaUcParenBoth=2]="AlphaUcParenBoth",u[u.AlphaLcParenR=3]="AlphaLcParenR",u[u.AlphaUcParenR=4]="AlphaUcParenR",u[u.AlphaLcPeriod=5]="AlphaLcPeriod",u[u.AlphaUcPeriod=6]="AlphaUcPeriod",u[u.ArabicParenBoth=7]="ArabicParenBoth",u[u.ArabicParenR=8]="ArabicParenR",u[u.ArabicPeriod=9]="ArabicPeriod",u[u.ArabicPlain=10]="ArabicPlain",u[u.RomanLcParenBoth=11]="RomanLcParenBoth",u[u.RomanUcParenBoth=12]="RomanUcParenBoth",u[u.RomanLcParenR=13]="RomanLcParenR",u[u.RomanUcParenR=14]="RomanUcParenR",u[u.RomanLcPeriod=15]="RomanLcPeriod",u[u.RomanUcPeriod=16]="RomanUcPeriod",u[u.CircleNumDbPlain=17]="CircleNumDbPlain",u[u.CircleNumWdBlackPlain=18]="CircleNumWdBlackPlain",u[u.CircleNumWdWhitePlain=19]="CircleNumWdWhitePlain",u[u.ArabicDbPeriod=20]="ArabicDbPeriod",u[u.ArabicDbPlain=21]="ArabicDbPlain",u[u.Ea1ChsPeriod=22]="Ea1ChsPeriod",u[u.Ea1ChsPlain=23]="Ea1ChsPlain",u[u.Ea1ChtPeriod=24]="Ea1ChtPeriod",u[u.Ea1ChtPlain=25]="Ea1ChtPlain",u[u.Ea1JpnChsDbPeriod=26]="Ea1JpnChsDbPeriod",u[u.Ea1JpnKorPlain=27]="Ea1JpnKorPlain",u[u.Ea1JpnKorPeriod=28]="Ea1JpnKorPeriod",u[u.Arabic1Minus=29]="Arabic1Minus",u[u.Arabic2Minus=30]="Arabic2Minus",u[u.Hebrew2Minus=31]="Hebrew2Minus",u[u.ThaiAlphaPeriod=32]="ThaiAlphaPeriod",u[u.ThaiAlphaParenR=33]="ThaiAlphaParenR",u[u.ThaiAlphaParenBoth=34]="ThaiAlphaParenBoth",u[u.ThaiNumPeriod=35]="ThaiNumPeriod",u[u.ThaiNumParenR=36]="ThaiNumParenR",u[u.ThaiNumParenBoth=37]="ThaiNumParenBoth",u[u.HindiAlphaPeriod=38]="HindiAlphaPeriod",u[u.HindiNumPeriod=39]="HindiNumPeriod",u[u.HindiNumParenR=40]="HindiNumParenR",u[u.HindiAlpha1Period=41]="HindiAlpha1Period"})(a=n.ListNumeration||(n.ListNumeration={}));var s;(function(u){u[u.Undefined=0]="Undefined",u[u.Delete=1]="Delete",u[u.Add=2]="Add",u[u.Change=3]="Change",u[u.Refresh=4]="Refresh"})(s=n.TextTileEventType||(n.TextTileEventType={}))})(Vn||(Vn={}));h();var En;(function(n){n[n.Undefined=0]="Undefined",n[n.Schema=1]="Schema",n[n.Boolean=2]="Boolean",n[n.Number=3]="Number",n[n.String=4]="String",n[n.Buffer=5]="Buffer",n[n.Function=6]="Function"})(En||(En={}));h();var og=w(R()),ig=w(P()),ag=w(Qe()),gl=w($e()),sg=w(je()),ug=w(as());function PI(n,r,e){return r=(0,gl.default)(r),(0,ag.default)(n,lg()?Reflect.construct(r,e||[],(0,gl.default)(n).constructor):r.apply(n,e))}function lg(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(lg=function(){return!!n})()}var xr;(function(n){n[n.JoinContext=0]="JoinContext",n[n.Session=1]="Session"})(xr||(xr={}));var Mo=function(n){function r(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"ExpectedError";return(0,ig.default)(this,r),e=PI(this,r,[t]),e.__proto__=r.prototype,e}return(0,sg.default)(r,n),(0,og.default)(r)}((0,ug.default)(Error));h();var kt;(function(n){n[n.error=0]="error",n[n.warn=1]="warn",n[n.info=3]="info",n[n.metric=4]="metric",n[n.verbose=5]="verbose",n[n.debug=6]="debug",n[n.disabled=7]="disabled"})(kt||(kt={}));h();var Wt;(function(n){n[n.Active=0]="Active",n[n.Stopped=1]="Stopped",n[n.Paused=2]="Paused"})(Wt||(Wt={}));h();var Ni;(function(n){n[n.ProductServiceUsage=2]="ProductServiceUsage",n[n.ProductServicePerformance=4]="ProductServicePerformance"})(Ni||(Ni={}));var ss;(function(n){n[n.BasicEvent=10]="BasicEvent",n[n.FullEvent=100]="FullEvent",n[n.RequiredServiceDataEvent=110]="RequiredServiceDataEvent"})(ss||(ss={}));h();var Di;(function(n){n[n.DocumentUpdate=0]="DocumentUpdate",n[n.Timeout=1]="Timeout",n[n.CloseSession=2]="CloseSession",n[n.Other=3]="Other"})(Di||(Di={}));h();var V;(function(n){n[n.SingleItem=0]="SingleItem",n[n.Reduce=1]="Reduce",n[n.Grid=2]="Grid",n[n.DynamicText=3]="DynamicText",n[n.Join=4]="Join",n[n.Generic=5]="Generic"})(V||(V={}));var us;(function(n){n.Default="Default",n.Copilot="Copilot"})(us||(us={}));var Gr;(function(n){n[n.Default=0]="Default",n[n.LocalOnly=1]="LocalOnly",n[n.Exclusive=2]="Exclusive"})(Gr||(Gr={}));var yn;(function(n){n[n.PreActivate=0]="PreActivate",n[n.Default=1]="Default",n[n.DelayActivate=1]="DelayActivate",n[n.NeverActivate=2]="NeverActivate"})(yn||(yn={}));var Tr;(function(n){n[n.Required=-3]="Required",n[n.Optional=-1]="Optional"})(Tr||(Tr={}));var Eo;(function(n){n[n.Never=0]="Never",n[n.Always=1]="Always"})(Eo||(Eo={}));var zt;(function(n){n[n.PreSeed=1]="PreSeed",n[n.OnSeed=2]="OnSeed",n[n.PostSeed=4]="PostSeed",n[n.All=5]="All"})(zt||(zt={}));var Vt;(function(n){n[n.UpstreamWorkflowsReady=0]="UpstreamWorkflowsReady",n[n.AnnotationMetadataUpdated=1]="AnnotationMetadataUpdated",n[n.DeltaUpdate=2]="DeltaUpdate",n[n.NonExclusiveTriggerSignals=3]="NonExclusiveTriggerSignals"})(Vt||(Vt={}));var Nn;(function(n){n[n.Character=1]="Character",n[n.Paragraph=2]="Paragraph"})(Nn||(Nn={}));var Pi;(function(n){n.Input="Input",n.Delta="Delta",n.UILanguage="UILanguage",n.MaxInputCount="MaxInputCount"})(Pi||(Pi={}));var hl;(function(n){n.SetPredefinedAnnotation="SetPredefinedAnnotation",n.ClearAnnotations="ClearAnnotations"})(hl||(hl={}));h();var ls;(function(n){n[n.Input=1]="Input",n[n.Output=2]="Output"})(ls||(ls={}));var cg;(function(n){n[n.Single=1]="Single",n[n.Any=-1]="Any",n[n.Optional=-2]="Optional",n[n.Some=-3]="Some"})(cg||(cg={}));h();var Yn;(function(n){n[n.WorkflowSession=0]="WorkflowSession",n[n.User=1]="User"})(Yn||(Yn={}));h();var cs=w(P()),fs=w(R());var ml=function(){function n(r){(0,cs.default)(this,n),m.assign(n,this,r)}return(0,fs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_AsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ml.H_={T_:ml.getTypeName(),B_:ml.getBaseTypes()};var Ri=function(){function n(r){(0,cs.default)(this,n),m.assign(n,this,r)}return(0,fs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_FilteringAsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Interfaces_AsyncBoundaryRequest"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ri.H_={T_:Ri.getTypeName(),B_:Ri.getBaseTypes()};var Bi=function(){function n(r){(0,cs.default)(this,n),m.assign(n,this,r)}return(0,fs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Interfaces_ModelIteratingAsyncBoundaryRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Interfaces_AsyncBoundaryRequest"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Bi.H_={T_:Bi.getTypeName(),B_:Bi.getBaseTypes()};h();h();var pg=w(R()),gg=w(P());h();var ds;(function(n){n.Log="Log"})(ds||(ds={}));var RI=typeof process!="undefined"&&process.env?process.env.SERVICE_NAME:"client",Wi="abcdefghijklmnopqrstuvwxyz0123456789",Oi={97:0,98:1,99:2,100:3,101:4,102:5,103:6,104:7,105:8,106:9,107:10,108:11,109:12,110:13,111:14,112:15,113:16,114:17,115:18,116:19,117:20,118:21,119:22,120:23,121:24,122:25,48:26,49:27,50:28,51:29,52:30,53:31,54:32,55:33,56:34,57:35},ps=[],gs=[],Ir,hg=function(r){return null},mg=function(r){},Do=new Map,vl=new Map,yl=new Map,kl=new Map,v;(function(n){n.defineCoreLogCategory=function(r){return{root:"Core",name:r}},n.defineWorkflowLogCategory=function(r){return{root:"Workflow",name:r}},n.clearLoggers=function(){ps=[],gs=[],vl.clear(),yl.clear()},n.clearAggregators=function(){Do.clear()},n.addLogger=function(r){ps.indexOf(r)===-1&&(ps.push(r),fg(vl,r))},n.addDecidingLogger=function(r){gs.indexOf(r)===-1&&(gs.push(r),fg(yl,r))},n.setCorrelationContextCallback=function(r){Ir=r},n.setStartPerformanceEventCallback=function(r){hg=r},n.setStopPerformanceEventCallback=function(r){mg=r},n.addAggregator=function(r){r.init(function(e,t){Li(e,t)}),Do.has(r.eventName)?Do.get(r.eventName).push(r):Do.set(r.eventName,[r])},n.flushAggregators=function(r){Do.forEach(function(e){e.forEach(function(t){return t.flush(r)})})},n.setTagLevelOverride=function(r,e){var t=qI(r);kl.set(t,e)},n.resetTagLevelOverrides=function(){kl.clear()},n.error=function(r,e,t,o,a,s,u,l,c,f){No(r,e,kt.error,t,o,a,s,u,l,c,f)},n.warn=function(r,e,t,o,a,s,u,l,c,f){No(r,e,kt.warn,t,o,a,s,u,l,c,f)},n.info=function(r,e,t,o,a,s,u,l,c,f){No(r,e,kt.info,t,o,a,s,u,l,c,f)},n.verbose=function(r,e,t,o,a,s,u,l,c,f){No(r,e,kt.verbose,t,o,a,s,u,l,c,f)},n.debug=function(r,e,t,o,a,s,u,l,c,f){No(r,e,kt.debug,t,o,a,s,u,l,c,f)},n.metric=function(r,e,t,o,a,s,u,l,c,f){No(r,e,kt.metric,t,o,a,s,u,l,c,f)},n.formatMetric=function(r,e,t,o){var a={};return a[r]={dimensionNames:t,dimensionValues:o,value:e},a},n.dynamic=function(r){Li(r)}})(v||(v={}));var fg=function(r,e){var t=e.level;Object.keys(kt).map(function(o){return kt[o]}).filter(function(o){return typeof o!="string"}).filter(function(o){return o<=t}).forEach(function(o){r.has(o)?r.get(o).push(e):r.set(o,[e])})},BI=function(r,e,t,o,a,s,u,l){if(e===void 0&&(typeof r=="string"||typeof r=="object"))return r;if(e===void 0&&typeof r=="function")return r();var c=[];for(var f of[r,e,t,o,a,s,u,l])f!==void 0&&c.push(typeof f=="function"?f():f);return c},vg=function(r){if(typeof r=="string")return r;for(var e="",t=0;t<r.length;t++){t>0&&(e+=" ");var o=r[t];o instanceof Error?e+=JSON.stringify({message:o.message,name:o.name,stack:o.stack}):typeof o=="object"?e+=JSON.stringify(o):e+=o}return e},yg=[],WI=["Level","Tag"],OI=["Level","Tag","Workflow"],hs=function(r){return wl(r).length},wl=function(r){return r!==void 0?vl.get(r)||yg:ps},LI=function(r,e){var t=r!==void 0?yl.get(r)||[]:gs;return t.filter(function(o){return o.shouldLog(e)})},No=function(r,e,t,o,a,s,u,l,c,f,d){t=kl.get(r)||t;var p=wl(t),g=LI(t,o);if(!(p.length==0&&g.length==0)){var k=hg(ds.Log),S=kg(r),C=BI(o,a,s,u,l,c,f,d);if(FI(e))dg(C)&&Li({eventName:"Metrics",tagId:S,category:`${e.root}.${e.name}`,traceLevel:t,message:"",getMetrics:function(){return C}},!1,p,g);else if(dg(C)){var x=C;x.tagId=S,x.category=`${e.root}.${e.name}`,x.eventName==="Operation"&&e.root==="Workflow"&&(x.eventName="WorkflowOperation",Ir&&(x.joinContextId=Ir().joinContextId,x.workflow=Ir().workflow)),x.traceLevel=t;var T=Do.get(x.eventName);if(T)for(var I=0;I<T.length;++I){var _=T[I];if(_&&_.add(x,I===T.length-1))break}else Li(x,!1,p,g)}else{var M=function(){var A;return e.root==="Core"?{TraceEventV2:{dimensionNames:function(){return WI},dimensionValues:[String(t),S],value:1}}:{WorkflowTraceEvent:{dimensionNames:function(){return OI},dimensionValues:[String(t),S,Ir?(A=Ir())===null||A===void 0?void 0:A.workflow:""],value:1}}};Li({eventName:"Log",tagId:S,category:`${e.root}.${e.name}`,traceLevel:t,message:vg(C),getMetrics:M},!1,p,g)}mg(k)}},Li=function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,t=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,a,s,u,l,c,f,d,p,g,k,S,C;if(t==null&&(t=wl(r.traceLevel)),o=o||yg,t.length>0||o.length>0){if(r.serviceName=RI,!e&&Ir){var x=Ir();x&&(r.cv=r.cv?r.cv:x.cv.toString(),r.sessionKey=r.sessionKey?r.sessionKey:x.sessionKey,r.workflow=r.workflow?r.workflow:x.workflow,r.clientAppName=r.clientAppName?r.clientAppName:(a=x.clientMetadata)===null||a===void 0?void 0:a.appName,r.clientAppPlatform=r.clientAppPlatform?r.clientAppPlatform:(s=x.clientMetadata)===null||s===void 0?void 0:s.appPlatform,r.clientAppVersion=r.clientAppVersion?r.clientAppVersion:(u=x.clientMetadata)===null||u===void 0?void 0:u.appVersion,r.clientDeviceId=r.clientDeviceId?r.clientDeviceId:(l=x.clientMetadata)===null||l===void 0?void 0:l.deviceId,r.clientDocSessionId=r.clientDocSessionId?r.clientDocSessionId:(c=x.clientMetadata)===null||c===void 0?void 0:c.docSessionId,r.clientReleaseAudienceGroup=r.clientReleaseAudienceGroup?r.clientReleaseAudienceGroup:(f=x.clientMetadata)===null||f===void 0?void 0:f.releaseAudienceGroup,r.clientReleaseChannel=r.clientReleaseChannel?r.clientReleaseChannel:(d=x.clientMetadata)===null||d===void 0?void 0:d.releaseChannel,r.clientReleaseFork=r.clientReleaseFork?r.clientReleaseFork:(p=x.clientMetadata)===null||p===void 0?void 0:p.releaseFork,r.clientRuntimeVersion=r.clientRuntimeVersion?r.clientRuntimeVersion:(g=x.clientMetadata)===null||g===void 0?void 0:g.runtimeVersion,r.clientSessionId=r.clientSessionId?r.clientSessionId:(k=x.clientMetadata)===null||k===void 0?void 0:k.sessionId,r.clientUserAgent=r.clientUserAgent?r.clientUserAgent:(S=x.clientMetadata)===null||S===void 0?void 0:S.userAgent,r.traceId=r.traceId||x.traceId,r.isClientTelemetrySampled=r.isClientTelemetrySampled?r.isClientTelemetrySampled:(C=x.clientMetadata)===null||C===void 0?void 0:C.isClientTelemetrySampled)}for(var T of t)T.log(r);for(var I of o)I.log(r)}},FI=function(r){return r.name===y.WorkflowMetricsOnly.name&&r.root===y.WorkflowMetricsOnly.root},dg=function(r){return!Array.isArray(r)&&typeof r=="object"},kg=function(r){return Wi[r>>24&63]+Wi[r>>18&63]+Wi[r>>12&63]+Wi[r>>6&63]+Wi[r>>0&63]},qI=function(r){return r&&r.length===5?Oi[r.charCodeAt(0)]<<24|Oi[r.charCodeAt(1)]<<18|Oi[r.charCodeAt(2)]<<12|Oi[r.charCodeAt(3)]<<6|Oi[r.charCodeAt(4)]:-1},y=(0,pg.default)(function n(){(0,gg.default)(this,n)});y.CoreDefault=v.defineCoreLogCategory("Default");y.CoreSystem=v.defineCoreLogCategory("System");y.CoreUnsampled=v.defineCoreLogCategory("Unsampled");y.WorkflowDefault=v.defineWorkflowLogCategory("Default");y.WorkflowUnsampled=v.defineWorkflowLogCategory("Unsampled");y.WorkflowMetricsOnly=v.defineWorkflowLogCategory("MetricsOnly");y.PrivacyGuardEvent=v.defineCoreLogCategory("PrivacyGuardEvent");h();var Tg=w(P()),Ig=w(R()),_g=w(Qe()),Il=w($e()),Ag=w(je());h();var Sl={util:{},roots:{default:{}}},bD=Sl.util,MD=Sl.roots.default||(Sl.roots.default={}),wg=function(){function n(r){if(r)for(var e in r)r[e]!=null&&(this[e]=r[e])}return n.prototype.count=0,n.prototype.cv="",n.prototype.serviceName="",n.prototype.sessionKey="",n.prototype.traceId="",n.prototype.durationMs=0,n.prototype.success=!1,n.prototype.resultDescription="",n.prototype.resultJSON="",n.prototype.resultSignature="",n.prototype.operationName="",n.prototype.resourceId="",n.prototype.dimension0="",n.prototype.dimension1="",n.prototype.dimension2="",n.prototype.dimension3="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientRuntimeVersion="",n.prototype.clientAppVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientReleaseChannel="",n.prototype.clientReleaseFork="",n.prototype.clientSessionId="",n.prototype.clientFlights="",n.prototype.clientIPRange="",n.prototype.clientDocSessionId="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.joinContextId="",n.prototype.ariaTenant="",n.prototype.ariaNamespace="",n.prototype.dataFields="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/OperationEvent"},n}();h();var Cl={util:{},roots:{default:{}}},DD=Cl.util,PD=Cl.roots.default||(Cl.roots.default={}),Sg=function(){function n(r){if(r)for(var e in r)r[e]!=null&&(this[e]=r[e])}return n.prototype.sessionKey="",n.prototype.annotationType="",n.prototype.annotationState=0,n.prototype.workflowId="",n.prototype.traceId="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/AnnotationMetaDataChangeEvent"},n}();h();var xl={util:{},roots:{default:{}}},WD=xl.util,OD=xl.roots.default||(xl.roots.default={}),Cg=function(){function n(r){if(r)for(var e in r)r[e]!=null&&(this[e]=r[e])}return n.prototype.cv="",n.prototype.sessionKey="",n.prototype.healthy=!1,n.prototype.fullLogs=!1,n.prototype.traceId="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientAppVersion="",n.prototype.clientSessionId="",n.prototype.clientRuntimeVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.isClientTelemetrySampled=!1,n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.protocolVersion=0,n.prototype.totalDurationMs=0,n.prototype.idleDurationMs=0,n.prototype.closeReason="",n.prototype.firstClientConnectionDurationMs=0,n.prototype.seedMode="",n.prototype.seedSuccess=!1,n.prototype.seedItems=0,n.prototype.seedMessageCount=0,n.prototype.seedBatchSize=0,n.prototype.seedGroupSize=0,n.prototype.seedDurationMs=0,n.prototype.sendMessageCount=0,n.prototype.sendMessageErrors=0,n.prototype.sendMessageWarnings=0,n.prototype.sendMessageDurationMsMax=0,n.prototype.processMessageCount=0,n.prototype.processMessageErrors=0,n.prototype.processMessageWarnings=0,n.prototype.processMessageDurationMsMax=0,n.prototype.syncMessageCount=0,n.prototype.syncMessagesOutOfSequence=0,n.prototype.syncMessagesAbandoned=0,n.prototype.syncMessagesIgnored=0,n.prototype.syncMessageQueueLimitReached=!1,n.prototype.modelItemsMax=0,n.prototype.modelConsistencyErrors=0,n.prototype.estimatedSizeMax=0,n.prototype.estimatedSizeCorrect=!1,n.prototype.modelItemsCountBucket="",n.prototype.modelConsistencyErrorsAndWarnings=0,n.prototype.modelConsistencyQuietStateValid=!1,n.prototype.modelConsistencyQuietStateWarnings=0,n.prototype.modelConsistencyQuietStateErrors=0,n.prototype.documentUrlAvailable=!1,n.prototype.documentUrlWasProvided=!1,n.prototype.workflowsRegistered=0,n.prototype.workflowExecutions=0,n.prototype.workflowExecutionErrors=0,n.prototype.workflowExecutionDurationMsMax=0,n.prototype.workflowExecutionInfraErrors=0,n.prototype.annotationTypesActivated=0,n.prototype.annotationsAdded=0,n.prototype.annotationsUpdated=0,n.prototype.annotationsDeleted=0,n.prototype.augLoopLowPrivilegeTokenExistenceStatus="",n.prototype.augLoopLowPrivilegeTokenFirstArrivalDurationMs=0,n.prototype.wacTokenProvisionTokenExistenceStatus="",n.prototype.wacTokenProvisionTokenFirstArrivalDurationMs=0,n.prototype.seedingWorkflowPerformanceTimesValid=!1,n.prototype.timeFromFirstSeedMessageToFirstWorkflowFinishedMs=0,n.prototype.timeFromFirstSeedMessageToFirstAnnotationMs=0,n.prototype.timeFromFirstSeedMessageToLastAnnotationMs=0,n.prototype.timeFromFirstSeedMessageToLastWorkflowFinishedMs=0,n.prototype.timeFromLastSeedMessageToLastAnnotationMs=0,n.prototype.timeFromLastSeedMessageToLastWorkflowFinishedMs=0,n.prototype.syncMessagesWorkflowPerformanceNotMeasured=0,n.prototype.timeToAllWorkflowsFinishedMsMax=0,n.prototype.timeFromSessionStartToLastWorkflowFinishedMs=0,n.prototype.healthBucket="",n.prototype.coreHealthBucket="",n.prototype.coreHealthReason="",n.prototype.coreHealthBucketWithSuppressions="",n.prototype.coreHealthReasonWithSuppressions="",n.prototype.healthReason="",n.prototype.healthReasonCategory="",n.prototype.healthBucketWithSuppressions="",n.prototype.healthReasonWithSuppressions="",n.prototype.healthReasonCategoryWithSuppressions="",n.prototype.eventAnalysisFindings="",n.prototype.mappedHealthBucketsToReasons="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/SessionStatsEvent"},n}();h();var Tl={util:{},roots:{default:{}}},qD=Tl.util,$D=Tl.roots.default||(Tl.roots.default={}),xg=function(){function n(r){if(r)for(var e in r)r[e]!=null&&(this[e]=r[e])}return n.prototype.cv="",n.prototype.serviceName="",n.prototype.sessionKey="",n.prototype.traceId="",n.prototype.clientAppName="",n.prototype.clientAppPlatform="",n.prototype.clientRuntimeVersion="",n.prototype.clientAppVersion="",n.prototype.clientReleaseAudienceGroup="",n.prototype.clientReleaseChannel="",n.prototype.clientReleaseFork="",n.prototype.clientSessionId="",n.prototype.clientFlights="",n.prototype.clientIPRange="",n.prototype.clientDocSessionId="",n.prototype.clientDeviceId="",n.prototype.clientUserAgent="",n.prototype.userType="",n.prototype.userId="",n.prototype.userTenantId="",n.prototype.sessionHealthEventName="",n.prototype.source="",n.prototype.reason="",n.prototype.reasonDependency="",n.prototype.subReason="",n.prototype.impact="",n.prototype.success=!1,n.prototype.durationMs=0,n.prototype.count=0,n.prototype.message="",n.prototype.affectedWorkflows="",n.prototype.resourceId="",n.prototype.dimension0="",n.prototype.dimension1="",n.prototype.dimension2="",n.prototype.dimension3="",n.prototype.resultDescription="",n.prototype.resultSignature="",n.prototype.joinContextId="",n.getTypeUrl=function(e){return e===void 0&&(e="type.googleapis.com"),e+"/SessionHealthEvent"},n}();h();var $I=1e3,GI=1e6,Qt=function(){return typeof process!="undefined"&&process.hrtime?function(){var n=process.hrtime();return n[0]*$I+n[1]/GI}:typeof performance!="undefined"&&performance.now?function(){return performance.now()}:function(){return Date.now()}}();function UI(n,r,e){return r=(0,Il.default)(r),(0,_g.default)(n,bg()?Reflect.construct(r,e||[],(0,Il.default)(n).constructor):r.apply(n,e))}function bg(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(bg=function(){return!!n})()}var E=function(n){function r(e,t){var o;return(0,Tg.default)(this,r),o=UI(this,r,[e]),o.eventName="Operation",o.options=t,o.durationMs=e==null?void 0:e.durationMs,(!e||e.count==null)&&(o.count=1),o}return(0,Ag.default)(r,n),(0,Ig.default)(r,[{key:"setClientMetadata",value:function(t,o){return t&&(this.clientAppName=t.appName,this.clientAppPlatform=t.appPlatform,this.clientAppVersion=t.appVersion,(o==null||!o)&&(this.clientFlights=t.flights),this.clientReleaseAudienceGroup=t.releaseAudienceGroup,this.clientReleaseChannel=t.releaseChannel,this.clientReleaseFork=t.releaseFork,this.clientRuntimeVersion=t.runtimeVersion,this.clientSessionId=t.sessionId,this.clientDocSessionId=t.docSessionId,this.clientDeviceId=t.deviceId,this.clientUserAgent=t.userAgent),this}},{key:"setUserContext",value:function(t){return t&&(this.userId=t.puid||t.oid,this.userType=t.userType&&t.userType.toString(),this.userTenantId=t.tid),this}},{key:"setMetricCustomDimensions",value:function(t,o){if(!this.options)throw new Error(`Attempting to set custom dimensions ${t} to operation ${this.operationName} without activating MetricCount or MetricDuration`);this.options.metricCustomDimensions=this.options.metricCustomDimensions||{},this.options.metricCustomDimensions[t]=o}},{key:"setDataField",value:function(t,o){if(o!=null){var a=this.dataFields?JSON.parse(this.dataFields):{};a[t]=o,this.dataFields=JSON.stringify(a)}}},{key:"setDataFields",value:function(t){this.dataFields?this.dataFields=JSON.stringify(Object.assign(Object.assign({},JSON.parse(this.dataFields)),t)):this.dataFields=JSON.stringify(t)}},{key:"start",value:function(){return this.startTime=Qt(),this}},{key:"recordStep",value:function(t){return this.setDataField(t,Math.floor(Qt()-this.startTime)),this}},{key:"stop",value:function(){var t=Qt();return this.durationMs=Math.round(t-this.startTime),this}},{key:"getMetrics",value:function(t){var o,a,s={};if(this.operationName)switch(this.operationName){case"SessionHealthOrphanedEventsWithoutProperSessionKey":case"SessionHealthOrphanedSessions":case"WorkflowActivationState":s[this.operationName+".CountV2"]={dimensionNames:r.getOrphanedSessionHealthDimensionNames.bind(r),dimensionValues:this.getOrphanedSessionHealthDimensionValues(),value:this.count};break;case"MarkUnhealthySession":case"MarkHealthWarningSession":s[this.operationName+".Reason"]={dimensionNames:r.getSessionHealthDimensionNames.bind(r),dimensionValues:this.getSessionHealthDimensionValues(),value:1};break;default:if(this.operationName==="matchmaker_timer"&&(s["Workflow.DurationMs"]={dimensionNames:r.getWorkflowDimensionNames.bind(r),dimensionValues:this.getWorkflowDimensionValues(),value:this.durationMs||0},s["Workflow.Count"]={dimensionNames:r.getWorkflowDimensionNames.bind(r),dimensionValues:this.getWorkflowDimensionValues(),value:1}),this.durationMs!==void 0){var u=`${this.operationName}.DurationMsV2`;(!((o=this.options)===null||o===void 0)&&o.metricDuration||t.indexOf(u)>=0)&&(s[u]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.durationMs})}{var l=`${this.operationName}.CountV2`;(!((a=this.options)===null||a===void 0)&&a.metricCount||t.indexOf(l)>=0)&&(s[l]={dimensionNames:this.getDimensionNames.bind(this),dimensionValues:this.getDimensionValues(),value:this.count})}}return s}},{key:"getDimensionNames",value:function(){var t,o,a=r.dimensionNames;if(!((t=this.options)===null||t===void 0)&&t.metricCustomDimensions){a=a.slice();for(var s in(o=this.options)===null||o===void 0?void 0:o.metricCustomDimensions)a.push(s)}return a}},{key:"getDimensionValues",value:function(){var t,o,a=[this.success,this.clientAppName,this.clientAppPlatform,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3];if(!((t=this.options)===null||t===void 0)&&t.metricCustomDimensions)for(var s in(o=this.options)===null||o===void 0?void 0:o.metricCustomDimensions)a.push(this.options.metricCustomDimensions[s]);return a}},{key:"getOrphanedSessionHealthDimensionValues",value:function(){return[this.success,this.clientAppName,this.clientAppPlatform,this.clientReleaseAudienceGroup,this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}},{key:"getSessionHealthDimensionValues",value:function(){return[this.resultSignature,this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}},{key:"getWorkflowDimensionValues",value:function(){return[this.resultSignature,this.resourceId,this.resourceId,this.success]}}],[{key:"getOrphanedSessionHealthDimensionNames",value:function(){return this.orphanedSessionHealthDimensionNames}},{key:"getSessionHealthDimensionNames",value:function(){return this.sessionHealthDimensionNames}},{key:"getWorkflowDimensionNames",value:function(){return this.workflowDimensionNames}}])}(wg);E.dimensionNames=["Success","ClientAppName","ClientAppPlatform","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];E.orphanedSessionHealthDimensionNames=["Success","ClientAppName","ClientAppPlatform","ClientReleaseAudienceGroup","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];E.sessionHealthDimensionNames=["Reason","ClientAppName","ClientAppPlatform","ClientAppVersion","Dimension0","Dimension1","Dimension2","Dimension3"];E.workflowDimensionNames=["ResultSignature","WorkflowId","ResourceId","Success"];h();var Rg=w(P()),Bg=w(R());h();var Ng=w(P()),Dg=w(R()),Je=function(){function n(r){(0,Ng.default)(this,n),this.childCount=0,this.id=r||HI()}return(0,Dg.default)(n,[{key:"newChild",value:function(){return++this.childCount,new n(this.id+"."+this.childCount.toString())}},{key:"toString",value:function(){return this.id.length>127?this.id.substring(0,127)+"!":this.id}}],[{key:"fromString",value:function(e,t){if(!e)throw new Error("Received invalid correlation vector string");var o;return e.endsWith(".0")?o=new n(e.substring(0,e.length-2)):o=new n(e),t&&(o.childCount=t),o}}])}(),Mg=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],Pg=22,Eg=new Array(Pg);function HI(){for(var n=0;n<Pg;n++)Eg[n]=Mg[Math.floor(Math.random()*Mg.length)];return Eg.join("")}h();function _l(n,r){return JSON.stringify}var Ur=function(){function n(r,e,t,o){(0,Rg.default)(this,n),this.cv=r,this.sessionDescriptor=e,this.clientMetadata=t,this.workflow=o==null?void 0:o.workflow,this.joinContextId=o==null?void 0:o.joinContextId,this.performanceEvent=o==null?void 0:o.performanceEvent,this.sessionLogsSampled=void 0,this._interactionId=o==null?void 0:o.interactionId,this._interactionSessionId=o==null?void 0:o.interactionSessionId,this.traceId=o==null?void 0:o.traceId}return(0,Bg.default)(n,[{key:"sessionKey",get:function(){var e;return(e=this.sessionDescriptor)===null||e===void 0?void 0:e.sessionKey}},{key:"interactionSessionId",get:function(){return this._interactionSessionId},set:function(e){if(this._interactionSessionId&&this._interactionSessionId!==e)throw new Error("InteractionSessionId is already set");this._interactionSessionId=e}},{key:"interactionId",get:function(){return this._interactionId},set:function(e){if(this._interactionId&&this._interactionId!==e)throw new Error("InteractionId is already set");this._interactionId=e}},{key:"toString",value:function(){var e,t;return`${(e=this.clientMetadata)===null||e===void 0?void 0:e.appName};${(t=this.clientMetadata)===null||t===void 0?void 0:t.appPlatform};${this.sessionKey};${this.cv}`}},{key:"serialize",value:function(){var e,t,o,a,s,u=(e=this.clientMetadata)===null||e===void 0?void 0:e.appName,l=(t=this.clientMetadata)===null||t===void 0?void 0:t.appPlatform,c=(o=this.clientMetadata)===null||o===void 0?void 0:o.releaseAudienceGroup,f=(a=this.clientMetadata)===null||a===void 0?void 0:a.flights;return n.stringify(Object.assign(Object.assign({cv:this.cv.toString()},(s=this.sessionDescriptor)!==null&&s!==void 0?s:{}),{clientAppName:u,clientAppPlatform:l,clientReleaseAudienceGroup:c,clientFlights:f,workflow:this.workflow,joinContextId:this.joinContextId,interactionId:this.interactionId,interactionSessionId:this.interactionSessionId,traceId:this.traceId}))}},{key:"newChild",value:function(){return new n(this.cv.newChild(),this.sessionDescriptor,this.clientMetadata,{workflow:this.workflow,joinContextId:this.joinContextId,interactionId:this.interactionId,interactionSessionId:this.interactionSessionId,traceId:this.traceId})}}],[{key:"deserialize",value:function(e){if(e)try{var t=JSON.parse(e),o={appName:t.clientAppName,appPlatform:t.clientAppPlatform,releaseAudienceGroup:t.clientReleaseAudienceGroup,flights:t.clientFlights};return new n(new Je(t.cv),{sessionKey:t.sessionKey,userId:t.userId,mastermindEndpoint:t.mastermindEndpoint},o,{workflow:t.workflow,joinContextId:t.joinContextId,interactionId:t.interactionId,interactionSessionId:t.interactionSessionId,traceId:t.traceId})}catch(a){return new n(new Je(e))}}},{key:"fromExisting",value:function(e,t,o,a,s){return new n(t||e.cv,o||e.sessionDescriptor,a||e.clientMetadata,{workflow:(s==null?void 0:s.workflow)||e.workflow,joinContextId:(s==null?void 0:s.joinContextId)||e.joinContextId,performanceEvent:(s==null?void 0:s.performanceEvent)||e.performanceEvent,interactionId:(s==null?void 0:s.interactionId)||e.interactionId,interactionSessionId:(s==null?void 0:s.interactionSessionId)||e.interactionSessionId,traceId:(s==null?void 0:s.traceId)||e.traceId})}}])}();Ur.schema={type:"object",properties:{cv:{type:"string"},clientAppName:{type:"string"},clientAppPlatform:{type:"string"},clientReleaseAudienceGroup:{type:"string"},clientFlights:{type:"string"},sessionKey:{type:"string"},userId:{type:"string"},mastermindEndpoint:{type:"string"},workflow:{type:"string"},joinContextId:{type:"string"},interactionId:{type:"string"},interactionSessionId:{type:"string"},traceId:{type:"string"}}};Ur.stringify=_l(Ur.schema);h();var bl=w(R()),Ml=w(P()),Wg="|",Og="b~",zI="b~true",Al="n~",VI=/\|\~/g,QI="_",jI=(0,bl.default)(function n(){(0,Ml.default)(this,n),this.count=0,this.measureSums=new Map}),El=(0,bl.default)(function n(r,e,t,o,a){var s=this;(0,Ml.default)(this,n),this.buckets=new Map,this.init=function(u){s.log=u},this.add=function(u){var l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(!s.condition||!s.condition(u))return l===!0&&s.log(u,!1),!1;var c=[];for(var f of s.dimensions)if(u[f]===void 0||u[f]===null)c.push(null);else{var d="";typeof u[f]=="boolean"?d=Og:typeof u[f]=="number"&&(d=Al),c.push(`${d}${u[f].toString().replace(VI,QI)}`)}var p=c.join(Wg),g=s.buckets.get(p);if(!g){g=new jI,g.traceLevel=u.traceLevel;for(var k of s.avgMeasures)g.measureSums.set(k,0);s.buckets.set(p,g)}g.count++;for(var S of s.avgMeasures)u[S]&&g.measureSums.set(S,g.measureSums.get(S)+u[S]);return!0},this.flush=function(){var u=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;s.buckets.forEach(function(l,c){for(var f={traceLevel:l.traceLevel,eventName:s.eventName,count:l.count},d=c.split(Wg),p=0;p<s.dimensions.length;p++){var g=s.dimensions[p],k=d[p];k.indexOf(Og)===0?f[g]=k===zI:k.indexOf(Al)===0?f[g]=parseInt(k.slice(Al.length),10):f[g]=k}for(var S of s.avgMeasures)f[S]=Math.round(l.measureSums.get(S)/l.count);s.log(f,!0)}),s.buckets.clear(),u&&(s.condition=null,clearInterval(s.interval))},this.eventName=r,this.condition=e,this.dimensions=t,this.avgMeasures=o,a>0&&(this.interval=setInterval(this.flush,a*1e3))});h();var Lg=w(R()),Fg=w(P()),qg=w(Qe()),Nl=w($e()),$g=w(je());function JI(n,r,e){return r=(0,Nl.default)(r),(0,qg.default)(n,Gg()?Reflect.construct(r,e||[],(0,Nl.default)(n).constructor):r.apply(n,e))}function Gg(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Gg=function(){return!!n})()}var Fi=function(n){function r(e){var t;return(0,Fg.default)(this,r),t=JI(this,r,[e]),t.eventName="AnnotationMetaDataChange",t}return(0,$g.default)(r,n),(0,Lg.default)(r)}(Sg);h();var Ug=w(P()),Hg=w(R()),zg=w(Qe()),Dl=w($e()),Vg=w(je());function KI(n,r,e){return r=(0,Dl.default)(r),(0,zg.default)(n,Qg()?Reflect.construct(r,e||[],(0,Dl.default)(n).constructor):r.apply(n,e))}function Qg(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Qg=function(){return!!n})()}var Ie;(function(n){n[n.Unknown=0]="Unknown",n[n.Core=1]="Core",n[n.Workflow=2]="Workflow",n[n.SessionExtension=3]="SessionExtension",n[n.Client=4]="Client",n[n.ClientRuntime=5]="ClientRuntime"})(Ie||(Ie={}));var de;(function(n){n[n.Unknown=0]="Unknown",n[n.Core=1]="Core",n[n.Workflow=2]="Workflow",n[n.SessionExtension=3]="SessionExtension",n[n.Client=4]="Client",n[n.Network=5]="Network",n[n.AugLoopDependency=6]="AugLoopDependency",n[n.WorkflowDependency=7]="WorkflowDependency",n[n.ClientRuntime=8]="ClientRuntime"})(de||(de={}));var _e;(function(n){n[n.Unknown=0]="Unknown",n[n.None=1]="None",n[n.MissingInput=2]="MissingInput",n[n.MissingOutput=3]="MissingOutput"})(_e||(_e={}));var Le=function(n){function r(e,t){var o;(0,Ug.default)(this,r);var a,s;return o=KI(this,r,[{source:Ie[e.source],reason:de[e.reason],reasonDependency:e.reasonDependency,subReason:e.subReason,sessionHealthEventName:e.sessionHealthEventName,impact:_e[e.impact],success:e.success,durationMs:(a=e.durationMs)!==null&&a!==void 0?a:0,count:typeof e.count=="number"?e.count:1,message:e.message,affectedWorkflows:((s=e.affectedWorkflows)!==null&&s!==void 0?s:[]).join(","),resourceId:e.resourceId,dimension0:e.dimension0,dimension1:e.dimension1,dimension2:e.dimension2,dimension3:e.dimension3,cv:e.cv,resultSignature:e.resultSignature,resultDescription:e.resultDescription,joinContextId:e.joinContextId}]),o.eventName="SessionHealth",t&&o.setClientMetadata(t),o.metricCount=e.metricCount,o.metricDuration=e.metricDuration,o}return(0,Vg.default)(r,n),(0,Hg.default)(r,[{key:"getMetrics",value:function(){var t={};return(this.metricCount===void 0||this.metricCount)&&(t[`${this.sessionHealthEventName}.CountV2`]={dimensionNames:function(){return r.dimensionNames},dimensionValues:this.getDimensionValues(),value:this.count}),(this.metricDuration===void 0||this.metricDuration)&&(t[`${this.sessionHealthEventName}.DurationMsV2`]={dimensionNames:function(){return r.dimensionNames},dimensionValues:this.getDimensionValues(),value:this.durationMs}),t}},{key:"setClientMetadata",value:function(t){return t&&(this.clientAppName=t.appName,this.clientAppPlatform=t.appPlatform,this.clientAppVersion=t.appVersion,this.clientFlights=t.flights,this.clientReleaseAudienceGroup=t.releaseAudienceGroup,this.clientReleaseChannel=t.releaseChannel,this.clientReleaseFork=t.releaseFork,this.clientRuntimeVersion=t.runtimeVersion,this.clientSessionId=t.sessionId,this.clientDocSessionId=t.docSessionId,this.clientUserAgent=t.userAgent,this.clientDeviceId=t.deviceId),this}},{key:"setUserContext",value:function(t){return t&&(this.userId=t.puid||t.oid,this.userType=t.userType&&t.userType.toString(),this.userTenantId=t.tid),this}},{key:"setReason",value:function(t){return this.reason=de[t],this}},{key:"setSource",value:function(t){return this.source=Ie[t],this}},{key:"setImpact",value:function(t){return this.impact=_e[t],this}},{key:"setAffectedWorkflows",value:function(t){return this.affectedWorkflows=(t!=null?t:[]).join(","),this}},{key:"getAffectedWorkflows",value:function(){return this.affectedWorkflows.split(",")}},{key:"start",value:function(){return this.startTime=Qt(),this}},{key:"stop",value:function(){var t=Qt();return this.durationMs=Math.round(t-this.startTime),this}},{key:"getDimensionValues",value:function(){var t;return[this.clientAppName,this.clientAppPlatform,this.clientAppVersion,this.success?"1":"0",`${this.reason}_${this.reasonDependency}`,this.impact,(t=this.getAffectedWorkflows()[0])!==null&&t!==void 0?t:"",this.resourceId,this.dimension0,this.dimension1,this.dimension2,this.dimension3]}}])}(xg);Le.dimensionNames=["ClientAppName","ClientAppPlatform","ClientAppVersion","Success","Reason","Impact","FirstAffectedWorkflow","ResourceId","Dimension0","Dimension1","Dimension2","Dimension3"];h();var ne=new Ur(new Je),ms=[];var YI=function(r){ms.push(ne),ne=r},XI=function(r){if(ne===r){ne=ms.pop();return}var e=ms.lastIndexOf(r);if(e<0)throw new Error("Context not found");if(e===0)throw new Error("Cannot remove top context");ms.splice(e,1)};var ut=function(){return ne};var Pl=function(){var r;return new Ur(((r=ne==null?void 0:ne.cv)===null||r===void 0?void 0:r.newChild())||new Je,ne==null?void 0:ne.sessionDescriptor,ne==null?void 0:ne.clientMetadata,{workflow:ne==null?void 0:ne.workflow,joinContextId:ne==null?void 0:ne.joinContextId,performanceEvent:ne==null?void 0:ne.performanceEvent,interactionId:ne==null?void 0:ne.interactionId,interactionSessionId:ne.interactionSessionId,traceId:ne==null?void 0:ne.traceId})},kn=function(r){var e=Pl();return ze(function(t){return r(t&&t.cv||void 0)},e)},vs=function(r,e,t,o,a){var s=new Ur(e&&Je.fromString(e)||(ne==null?void 0:ne.cv)||new Je,t||(ne==null?void 0:ne.sessionDescriptor),o||(ne==null?void 0:ne.clientMetadata),{workflow:(a==null?void 0:a.workflow)||(ne==null?void 0:ne.workflow),joinContextId:(a==null?void 0:a.joinContextId)||(ne==null?void 0:ne.joinContextId),performanceEvent:(a==null?void 0:a.performanceEvent)||(ne==null?void 0:ne.performanceEvent),interactionId:(a==null?void 0:a.interactionId)||(ne==null?void 0:ne.interactionId),interactionSessionId:(a==null?void 0:a.interactionSessionId)||(ne==null?void 0:ne.interactionSessionId),traceId:(a==null?void 0:a.traceId)||(ne==null?void 0:ne.traceId)});return ze(r,s)},ze=function(r,e){YI(e);try{return r(e)}finally{XI(e)}};h();h();var jg=w(P()),Jg=w(R()),Xn=function(){function n(r){if((0,jg.default)(this,n),this.cache=new Map,this.options=r||{sweepInterval:100},this.options.idleDurationMs!=null&&this.options.idleDurationMs<=0)throw new Error("Idle duration must be positive");if(this.interval=this.options.sweepInterval||100,this.interval<=0)throw new Error("Sweep interval must be a positive number")}return(0,Jg.default)(n,[{key:"put",value:function(e,t,o,a,s,u,l){if(o==null||o<=0)throw new Error("Cache timeout must be a positive number");(s==null||s<=0)&&(s=this.options.idleDurationMs);var c={value:t,lastUsed:s?Date.now():void 0,expire:o+Date.now(),idleDurationMs:s,expireCallback:a,expiringTriggerTime:u+Date.now(),expiringCallback:l};return this.cache.set(e,c),this.timeout||(this.timeout=setInterval(this.onInterval.bind(this),this.interval),this.timeout.unref&&this.timeout.unref()),t}},{key:"del",value:function(e){if(this.options.delCallback){var t=this.cache.get(e);t&&this.options.delCallback(e,t.value)}var o=this.cache.delete(e);return this.size()===0&&this.clear(),o}},{key:"clear",value:function(){this.timeout&&(clearInterval(this.timeout),this.timeout=void 0),this.cache.clear()}},{key:"get",value:function(e){var t=this.cache.get(e);if(t)return this.options.idleDurationMs&&(t.lastUsed=Date.now()),t.expire<Date.now()&&(this.del(e),t.expireCallback&&t.expireCallback(e,t.value),t=this.cache.get(e),!t)?void 0:t.value}},{key:"keys",value:function(){return this.cache.keys()}},{key:"forEach",value:function(e){this.cache.forEach(function(t,o){e(t.value,o)})}},{key:"size",value:function(){return this.cache.size}},{key:"updateExpireTime",value:function(e,t){return this.cache.has(e)&&t>=0?(this.cache.get(e).expire=t+Date.now(),!0):!1}},{key:"onInterval",value:function(){var e=this,t=Date.now();this.cache.forEach(function(o,a){try{if(o.idleDurationMs&&o.lastUsed<t-o.idleDurationMs){e.del(a),e.options.idleCallback&&e.options.idleCallback(a,o.value);return}o.expire<t&&(e.del(a),o.expireCallback&&o.expireCallback(a,o.value)),o.expiringTriggerTime<t&&o.expiringCallback&&(o.expiringCallback(a,o.value),o.expiringCallback=void 0)}catch(s){n.logIntervalError&&n.logIntervalError(s)}})}}],[{key:"setLogIntervalError",value:function(e){n.logIntervalError=e}}])}();h();h();var Ga=w(Se()),rp=w(P()),op=w(R());h();var ZI={category:En.Schema,schema:{name:"Exception",path:"message-schema.proto"}},BP={category:En.Schema,schema:{name:"Filter",path:"message-schema.proto"}},Hr=function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(r==null)return"Invalid message passed";if(r.payload==null)return`${Te[Te.NoOutput]}: Payload is null`;if(r.payload.exceptionType==null)return"Payload is not an exception";var t=Te[r.payload.exceptionType];return t+=r.payload.message?`: ${r.payload.message}`:": No description",t+=e&&r.payload.data?`
${r.payload.data.toString()}`:"",t},Kg=function(r){return r==null||r.payload==null||r.payload.exceptionType==null?Te.Unknown:r.payload.exceptionType},Zn=function(r,e){if(r==null)throw new Error("Cannot set exception on null message");r.payload=e,r.payloadSchema=ZI,r.messageType=vn.Exception};h();h();var Yg=w(dt()),Rl=w(Se()),Xg=w(P()),Zg=w(R());var qi;(function(n){n[n.ExceedingMaxSize=0]="ExceedingMaxSize",n[n.GroupComplete=1]="GroupComplete",n[n.BatchIntervalElapsed=2]="BatchIntervalElapsed"})(qi||(qi={}));var Po=function(){function n(r,e,t,o,a){(0,Xg.default)(this,n),this.batchesByGroupingKey=new Map,this.getOrderOfMagnitudeDimension=function(s){return s<0?"Negative":s===0?"0":s===1?"1":`Magnitude ${s.toString().length}`},this.submit=r,this.onSummary=o,this.reduceBatchOperationsEnabled=e,this.batchMessagesEnabled=t,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=a}return(0,Zg.default)(n,[{key:"addBatchItem",value:function(e,t,o,a,s,u){var l=this,c=t.delayMs,f=t.delayMsMax,d=t.maxInputSize,p=t.estimateSize,g=t.groupingKeyExtractor,k=p(e),S=g(e);if(t.split&&k>d){var C;try{C=t.split(e)}catch(F){var x=new Error("Split error: "+F.message);u?u(x):v.error(573366352,y.CoreDefault,x);return}if(C&&Array.isArray(C.inputs)&&C.inputs.length>1){for(var T,I=[],_=u?function(F,q){if(T=T||F,I.push(q),I.length===C.inputs.length){var J;try{J=C.join(I)}catch(Y){u(new Error("Join error: "+Y.message));return}u(T,J)}}:void 0,M=0;M<C.inputs.length;M++){var b=C.inputs[M];this.addBatchItem(b,t,o,a,s&&M===C.inputs.length-1,_)}return}}var A=this.batchesByGroupingKey.get(S);if(A&&A.size+k>d&&(this.executeBatch(S,A,t,qi.ExceedingMaxSize),A=void 0),A||(A={items:[],size:0,hasItemsWithCallbacks:!1,context:o,creationTime:Date.now()},this.batchesByGroupingKey.set(S,A)),!this.batchMessagesEnabled)A.items.push({input:e,size:k,callback:u});else{var N=A.items[A.items.length-1];N&&N.cv===a&&N.callback===u?(N.input=[].concat((0,Rl.default)(N.input),(0,Rl.default)(e)),N.size+=k):A.items.push({input:e,size:k,cv:a,callback:u})}A.size+=k,A.hasItemsWithCallbacks=A.hasItemsWithCallbacks||!!u,this.batchMessagesEnabled||(A.cv=a),A.groupComplete=s,A.groupComplete?this.executeBatch(S,A,t,qi.GroupComplete):(Date.now()-A.creationTime+c<f&&(clearTimeout(A.timeout),A.timeout=void 0),A.timeout||(A.timeout=setTimeout(function(){l.executeBatch(S,A,t,qi.BatchIntervalElapsed)},c)))}},{key:"removeAllBatchedItems",value:function(){this.batchesByGroupingKey.forEach(function(e){e.timeout&&clearTimeout(e.timeout)}),this.batchesByGroupingKey.clear()}},{key:"reduceBatchOperations",value:function(e){var t=new E({operationName:"ReduceBatchOperations"}).start(),o=0,a=0,s=0,u=new Set,l=[],c=function(I,_){return I.parentPath.toString()+"/"+I.parentRevId+"/"+_.id};for(var f of e.input.reverse()){var d=[];for(var p of f.input.reverse())if(Oe.typeGuard(p)){var g=[];for(var k of p.items){s++;var S=c(p,k);u.has(S)?a++:(g.push(k),u.add(S),o++)}g.length!==0&&(p.items=g,d.push(p))}else if(we.typeGuard(p)){for(var C of p.items){var x=c(p,C);u.delete(x)}d.push(p)}else d.push(p);d.length!==0&&l.push({input:d.reverse(),size:f.size,cv:f.cv,callback:f.callback})}e.input=l.reverse(),s!=0&&(t.dimension0=`${this.getOrderOfMagnitudeDimension(a)}`,t.dimension1=`noOp: ${a===0}`),s-a==o?t.success=!0:t.success=!1,v.info(507839488,y.CoreDefault,t.stop())}},{key:"maxNumberOfDeltaUpdateOpsPerItemPerBatch",value:function(e){var t=function(f,d){return f.parentPath.toString()+"/"+d.id},o=0,a=new Map;for(var s of e.input)if(At.typeGuard(s))for(var u of s.items){var l=t(s,u);a.has(l)||a.set(l,0),a.set(l,a.get(l)+1),o=Math.max(o,a.get(l))}return o}},{key:"executeBatch",value:function(e,t,o,a){var s=this;clearTimeout(t.timeout),t.timeout=void 0,this.batchesByGroupingKey.delete(e);var u=t.items,l=new E({operationName:"ExecuteBatch",cv:this.batchMessagesEnabled?"":t.cv,resourceId:t.context.name,resultDescription:`batching duration: ${Date.now()-t.creationTime}ms`,dimension0:`${this.batchMessagesEnabled?"Batched items count":"Batched ops count:"} ${this.getOrderOfMagnitudeDimension(u.length)}`,dimension1:`Size ${this.getOrderOfMagnitudeDimension(t.size)}`,dimension2:a.toString()}).start(),c=function(p,g,k){var S;if(g&&g.exceptionType===Te.NoOutput)l.success=!0,v.info(573366353,y.CoreDefault,l.stop());else{var C=`${p} error: ${g?g.message||g:"Unknown error"}`;S=g||new Error(C),l.success=!1,l.resultDescription=`Batch of ${u.length} items of size ${t.size} with ${C}`,l.resultSignature=`${p} Error`,v.error(573366354,y.CoreDefault,l.stop())}if(t.hasItemsWithCallbacks)for(var x of u)x.callback&&x.callback(S,k)},f;try{f=o.multiplex(this.batchMessagesEnabled?u:u.map(function(d){return d.input}))}catch(d){c("Multiplex",d);return}this.reduceBatchOperationsEnabled&&this.batchMessagesEnabled&&e=="operations"&&this.reduceBatchOperations(f),!this.batchMessagesEnabled&&e=="operations"&&this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled&&(l.dimension3=this.getOrderOfMagnitudeDimension(this.maxNumberOfDeltaUpdateOpsPerItemPerBatch(f))),this.submit(f.input,t,function(d,p){if(d||p&&("exceptionType"in p||p instanceof Error))c("Submit",d||p,p);else if(t.hasItemsWithCallbacks||o.summaryExtractor){var g;if(t.hasItemsWithCallbacks)try{if(g=f.demultiplex(p),g.length!==u.length)throw new Error("Mismatched output length")}catch(I){c("Demultiplex",I);return}var k,S;if(o.summaryExtractor)try{var C=o.summaryExtractor(p),x=(0,Yg.default)(C,2);S=x[0],k=x[1]}catch(I){c("SummaryExtractor",I);return}if(l.success=!0,v.info(573366342,y.CoreDefault,l.stop()),t.hasItemsWithCallbacks)for(var T=0;T<u.length;T++)u[T].callback&&u[T].callback(void 0,g[T]);k&&s.onSummary(S,k,t.context)}else l.success=!0,v.info(573366343,y.CoreDefault,l.stop())})}}])}();h();h();var eh=w(dt()),th=w(P()),nh=w(R()),rh=function(){function n(r,e,t){if((0,th.default)(this,n),this.requestInProgress=!1,this.queuedRequests=[],r==null)throw new Error("No request.");this.fetch=r,this.fetchTimeout=e,this.queueTimeout=t}return(0,nh.default)(n,[{key:"tryProcessNextRequest",value:function(){if(this.requestInProgress=!1,this.queuedRequests.length>0){var e=this.queuedRequests.shift(),t=(0,eh.default)(e,3),o=t[0],a=t[1],s=t[2];clearTimeout(s),this.add(o,a)}}},{key:"add",value:function(e,t){var o=this;if(this.requestInProgress){var a=setTimeout(function(){t(new Error("Timed out waiting in queue"),null),o.queuedRequests.shift()},this.queueTimeout);this.queuedRequests.push([e,t,a])}else{this.requestInProgress=!0;var s=new Promise(function(u,l){var c=!1,f=setTimeout(function(){c=!0,l(new Error("Fetch timed out"))},o.fetchTimeout);o.fetch(e).then(function(d){c||(clearTimeout(f),u(d))}).catch(function(d){c||(clearTimeout(f),l(d))})});s.then(function(u){t(null,u),o.tryProcessNextRequest()}).catch(function(u){t(u,null),o.tryProcessNextRequest()})}}}])}();var $i=w(ys()),e_=2e4,t_=12e4,ks="Request timed out";function Vr(n,r,e){var t=new $i.Request(n,r);return n_.add(t,e)}var n_=new rh($i.fetch,e_,t_);function oh(n,r,e){return new Promise(function(t,o){var a=setTimeout(function(){o(new Error(ks))},r);(0,$i.fetch)(n,e||{}).then(function(s){clearTimeout(a),t(s)}).catch(function(s){clearTimeout(a),o(s)})})}h();function Zt(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){var r=Math.random()*16|0,e=n==="x"?r:r&3|8;return e.toString(16)})}h();var ws=function(r){return r_(r,Number.POSITIVE_INFINITY)};var r_=function(r,e){for(var t=0,o=[],a=[r];a.length>0;){var s=a.pop(),u=typeof s;if(u==="boolean")t+=4;else if(u==="string")t+=2*s.length;else if(u==="number")t+=8;else if(u==="object"&&s&&o.indexOf(s)===-1)if(s instanceof Uint8Array)t+=s.length;else{o.push(s);for(var l in s)a.push(s[l])}if(t>e)return t}return t};h();var LC=w(P()),FC=w(R());h();var ih=w(P()),ah=w(R()),sh=w(Se());var o_=1e3,Bl=["cloud-dev.microsoft","officeppe.com","cloud.microsoft","office.com","office365.us","ic.gov","microsoft.scloud","microsoftonline.cn"],Ro=function(r,e,t,o){return new El(r,function(a){return a.success&&t.indexOf(a[e])>=0},[e,"ariaNamespace","resourceId","success","resultSignature","clientDocSessionId","dimension0","dimension1","dimension2","dimension3"],["durationMs"],o)},Wl=function(r){Bl.push.apply(Bl,(0,sh.default)(r))},en=function(r){if(!r)return r;for(var e of Bl)if(r.indexOf(e)>=0)return r;return"**redacted**"},Bo=function(){function n(r){(0,ih.default)(this,n),this.level=kt.info,this.hostCallbacks=r}return(0,ah.default)(n,[{key:"log",value:function(e){var t=this;if(!(this.hostCallbacks==null||this.hostCallbacks.sendTelemetryEvent==null)){var o=function(f,d,p,g,k){var S=d.charAt(0).toUpperCase()+d.slice(1),C={DocSessionId:f.clientDocSessionId,ResourceId:f.resourceId,ResultDescription:f.resultDescription,ResultSignature:f.resultSignature,Dimension0:f.dimension0,Dimension1:f.dimension1,Dimension2:f.dimension2,Dimension3:f.dimension3,JoinContextId:f.joinContextId,ServerSessionKey:t.serverSessionKey};p&&(C=Object.assign(Object.assign({},C),JSON.parse(p)));var x=g||n.augLoopAriaTenantToken,T=!k&&x==n.augLoopAriaTenantToken?n.augLoopAriaNamespace:k;S=S||n.operationNamePlaceholder;var I={CV:f.cv,Duration:(f.durationMs||0)*o_,Count:f.count,AggMode:2,Success:f.success};t.hostCallbacks.sendTelemetryEvent(x,T?`${T}_${S}`:S,C,"Office.System.Activity",I,!1,Ni.ProductServiceUsage|Ni.ProductServicePerformance,ss.RequiredServiceDataEvent)},a=function(f,d,p){t.hostCallbacks.sendDiagnosticTrace&&t.hostCallbacks.sendDiagnosticTrace(f,d,p)};if(e.category!="Workflow.MetricsOnly")if(e.eventName==="Operation"){var s=e;o(s,s.operationName,s.dataFields,void 0,s.ariaNamespace)}else if(e.eventName==="SessionHealth"){var u=e;o(u,u.sessionHealthEventName)}else if(e.eventName==="WorkflowOperation"){var l=e;o(l,l.operationName,l.dataFields,l.ariaTenant,l.ariaNamespace)}else e.eventName==="Log"&&a(e.tagId,e.traceLevel,e.message)}}},{key:"setServerSessionKey",value:function(e){this.serverSessionKey=e}}])}();Bo.augLoopAriaTenantToken="3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770";Bo.augLoopAriaNamespace="Office_AugLoop_Client";Bo.operationNamePlaceholder="OperationNameNotProvided";h();var lh=w(P()),ch=w(R()),Ll=w(Ol());var i_=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node!="undefined",Fl=function(){function n(r){(0,lh.default)(this,n),this.networkOverrideOptions=r,this.hadEgressError=!1,this.isClosing=!1,this.pendingEgress=[]}return(0,ch.default)(n,[{key:"init",value:function(e,t,o,a,s){var u=this,l;if(this.clientMetadata=s,i_){var c={};!((l=this.networkOverrideOptions)===null||l===void 0)&&l.hostHeader&&(c.headers={host:this.networkOverrideOptions.hostHeader}),this.ws=new Ll.default(e,c)}else this.ws=new Ll.default(e);this.logOp=new E({operationName:n.className,success:!0}).start(),this.logOp.setClientMetadata(s,!0),this.ingressByteCountOp=new E({operationName:"WSIngressByteOrderOfMagnitude",success:!0}),this.ingressByteCountOp.setClientMetadata(s,!0),this.ws.addEventListener("open",function(f){o(),u.logOp.resourceId="OnOpen",u.logOp.resultDescription="",u.logOp.success=!0,u.logOp.dimension0=u.pendingEgress.length.toString(),v.info(508843801,y.CoreDefault,u.logOp.stop())}),this.ws.addEventListener("message",function(f){u.logIngressCount(f.data),t(f.data)}),this.ws.addEventListener("error",function(f){u.errorMessage=f.message,u.logOp.resourceId="OnError",u.logOp.resultDescription=u.errorMessage,u.logOp.success=!1,v.info(508843800,y.CoreDefault,u.logOp.stop()),u.ws?u.ws.close():u.logWsUndefinedError("error event handler")}),this.ws.addEventListener("close",function(f){u.logOp.resourceId="OnClose",u.logOp.resultDescription=f?`code: ${f.code}. reason: ${f.reason}`:"",u.logOp.success=!0,v.info(508843799,y.CoreDefault,u.logOp.stop()),a(u.errorMessage),u.isClosing=!1})}},{key:"egress",value:function(e){var t=this,o=e.obj;this.ws.send(o,function(a){a&&!t.hadEgressError&&(t.hadEgressError=!0,t.logOp.resourceId="OnEgressError",t.logOp.resultDescription=a.message,t.logOp.success=!1,v.info(508843797,y.CoreDefault,t.logOp.stop()))})}},{key:"close",value:function(){this.isClosing||(this.isClosing=!0,this.ws?this.ws.close():this.logWsUndefinedError("close"))}},{key:"logIngressCount",value:function(e){var t=e.length;t>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=t.toString().length.toString(),v.info(508843794,y.CoreDefault,this.ingressByteCountOp.stop()))}},{key:"logWsUndefinedError",value:function(e){var t=new E({operationName:n.className,success:!1}).start();t.setClientMetadata(this.clientMetadata,!0),t.resourceId="webSocketUndefined",t.resultDescription=e+": this.ws null or undefined",v.info(506566722,y.CoreDefault,t.stop())}}])}();Fl.className="WebSocketWorker";h();var ma=w(Ui()),Nm=w(P()),Dm=w(R()),Pm=w(Qe()),Cc=w($e()),Rm=w(je());h();var Bh=w(P()),Wh=w(R());var ve={};UT(ve,{ChangeGate:()=>H,DataListener:()=>Qr,ModuleSettings:()=>p_,Setting:()=>_r,SettingInstance:()=>G,SettingInstanceCollection:()=>Gl,SettingPatternInstance:()=>f_,SettingsRegistry:()=>xh,TestSettingsProvider:()=>h_});h();h();h();var hh=w(Ss()),Ts=w(P()),Is=w(R()),mh=w(Qe()),Cs=w($e()),_s=w(je()),yh=w(zi());h();var ph=w(P()),gh=w(R()),Qr=function(){function n(){(0,ph.default)(this,n),this.listeners=new Map,this.lastId=0}return(0,gh.default)(n,[{key:"addListener",value:function(e){if(!e)throw new Error("No callback provided for data listener");return this.listeners.set(this.lastId,e),this.lastId++}},{key:"removeListener",value:function(e){this.listeners.delete(e)}},{key:"notifyListeners",value:function(e){this.listeners.forEach(function(t){t(e)})}}])}();function xs(n,r,e,t){var o=(0,hh.default)((0,Cs.default)(1&t?n.prototype:n),r,e);return 2&t&&typeof o=="function"?function(a){return o.apply(e,a)}:o}function $l(n,r,e){return r=(0,Cs.default)(r),(0,mh.default)(n,vh()?Reflect.construct(r,e||[],(0,Cs.default)(n).constructor):r.apply(n,e))}function vh(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(vh=function(){return!!n})()}var _r=function(n){function r(e){var t;return(0,Ts.default)(this,r),t=$l(this,r),t.name=e,t}return(0,_s.default)(r,n),(0,Is.default)(r,[{key:"getName",value:function(){return this.name}},{key:"getValue",value:function(){var t,o;if(typeof globalThis.process!="undefined"&&((o=(t=globalThis.process)===null||t===void 0?void 0:t.env)===null||o===void 0?void 0:o.VALIDATE_CORRECT_USAGE_OF_GET_VALUE)==="true")throw new Error("getValue() has been invoked incorrectly for ModuleSettings. Make sure getValue() is called dynamically where the value of a setting is needed");return this.value}},{key:"updateValue",value:function(t){return(0,yh.default)(this.value,t)?!1:(v.info(572837968,y.CoreDefault,`Received new property value for ${this.getName()}:`,t),this.value=t,!0)}}],[{key:"getInstance",value:function(t){var o=this.allSettings.get(t);if(!o){o=new r(t);var a=r.tryGetConfigProperty(r.currentConfig,t);a.success&&o.updateValue(a.value),this.allSettings.set(t,o)}return o}},{key:"getPatternInstance",value:function(t){var o=this.allPatternSettings.get(t);if(!o){o={regex:new RegExp(t),setting:new r(t)};var a=r.tryGetConfigPropertyByPattern(r.currentConfig,o.regex);o.setting.updateValue(a),this.allPatternSettings.set(t,o)}return o.setting}},{key:"setNewConfig",value:function(t){r.currentConfig=t,v.info(572837966,y.CoreDefault,`New config: ${JSON.stringify(t)}`),r.allSettings.forEach(function(o,a){var s=r.tryGetConfigProperty(r.currentConfig,a).value;o.updateValue(s)&&(v.info(572837967,y.CoreDefault,`Setting new value for ${a}: ${s instanceof Object?JSON.stringify(s):s}`),o.notifyListeners(s))}),r.allPatternSettings.forEach(function(o,a){var s=r.tryGetConfigPropertyByPattern(t,o.regex);o.setting.updateValue(s)&&(v.info(508432774,y.CoreDefault,`Setting new value for pattern ${a}: ${JSON.stringify(s)}`),o.setting.notifyListeners(s))})}},{key:"tryGetConfigProperty",value:function(t,o){return t&&t.hasOwnProperty(o)?{success:!0,value:r.selectApplicableValue(t[o])}:{success:!1,value:void 0}}},{key:"tryGetConfigPropertyByPattern",value:function(t,o){var a=[];if(t){var s=Object.getOwnPropertyNames(t).filter(function(l){return o.test(l)});for(var u of s)a.push({name:u,value:r.selectApplicableValue(t[u])})}return a}},{key:"setGlobalFilter",value:function(t){r.globalFilter=t}},{key:"clear",value:function(){r.currentConfig=void 0,r.allSettings.clear(),r.allPatternSettings.clear()}},{key:"selectApplicableValue",value:function(t){var o;if(t){var a=t.find(function(s){return!r.globalFilter||r.globalFilter(s)});a&&(o=a.value)}return o}}])}(Qr);_r.allSettings=new Map;_r.allPatternSettings=new Map;var G=function(n){function r(e,t){var o;return(0,Ts.default)(this,r),o=$l(this,r),o.listenerId=NaN,o.defaultValue=t,o.setting=_r.getInstance(e),o}return(0,_s.default)(r,n),(0,Is.default)(r,[{key:"getDefaultValue",value:function(){return this.defaultValue}},{key:"addListener",value:function(t){var o=this;return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(function(){o.notifyListeners(o.getValue())})),xs(r,"addListener",this,3)([t])}},{key:"removeListener",value:function(t){xs(r,"removeListener",this,3)([t]),this.listeners.size==0&&!Number.isNaN(this.listenerId)&&(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}},{key:"getValue",value:function(){var t=this.setting.getValue();return t===void 0?this.defaultValue:t}}])}(Qr),f_=function(n){function r(e){var t;return(0,Ts.default)(this,r),t=$l(this,r),t.listenerId=NaN,t.setting=_r.getPatternInstance(e),t}return(0,_s.default)(r,n),(0,Is.default)(r,[{key:"addListener",value:function(t){var o=this;return Number.isNaN(this.listenerId)&&(this.listenerId=this.setting.addListener(function(){o.notifyListeners(o.getValue())})),xs(r,"addListener",this,3)([t])}},{key:"removeListener",value:function(t){xs(r,"removeListener",this,3)([t]),this.listeners.size==0&&!Number.isNaN(this.listenerId)&&(this.setting.removeListener(this.listenerId),this.listenerId=NaN)}},{key:"getValue",value:function(){var t=this.setting.getValue();return t===void 0?[]:t}}])}(Qr);var d_=new G("disabledChangeGates",[]),H=function(r,e){var t=d_.getValue().indexOf(r)===-1;if(!e)return t;if(t){for(var o=arguments.length,a=new Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];return e.apply(void 0,a)}};h();var kh=w(P()),wh=w(R());var p_=function(){function n(r,e){(0,kh.default)(this,n),this.moduleName=r!=null?r:"",this.moduleVersion=e!=null?e:""}return(0,wh.default)(n,[{key:"getInstance",value:function(e,t){return new G(`${this.moduleName}.${e}`,t)}}])}();h();var Sh=w(P()),Ch=w(R());var xh=function(){function n(){(0,Sh.default)(this,n)}return(0,Ch.default)(n,null,[{key:"addProvider",value:function(e){var t=e.addListener(function(){v.info(572837969,y.CoreDefault,`Received new settings from ${e.constructor.name}`),n.currentConfig=n.buildConfig(),_r.setNewConfig(n.currentConfig)});n.providers.push({provider:e,listenerId:t}),n.currentConfig=n.buildConfig(),_r.setNewConfig(n.currentConfig)}},{key:"getCurrentConfig",value:function(){return n.currentConfig}},{key:"clear",value:function(){n.currentConfig=void 0,n.providers.forEach(function(e){e.provider.removeListener(e.listenerId)}),n.providers=[]}},{key:"buildConfig",value:function(){var e={};for(var t of n.providers){var o=t.provider.getSettings()||{};e=Object.assign(e,o)}return e}}])}();xh.providers=[];h();var Th=w(P()),Ih=w(R());var Gl=function(){function n(r,e){(0,Th.default)(this,n),this.prefix=r,this.defaultValue=e,this.settingInstances=new Map}return(0,Ih.default)(n,[{key:"getSettingInstance",value:function(e){var t=`${this.prefix}${e}`,o=this.settingInstances.get(t);return o===void 0&&(o=new G(t,this.defaultValue),this.settingInstances.set(t,o)),o}}])}();hn(ve,w(Ah()));h();var bh=w(P()),Mh=w(R()),Eh=w(Qe()),Ul=w($e()),Nh=w(je());function g_(n,r,e){return r=(0,Ul.default)(r),(0,Eh.default)(n,Dh()?Reflect.construct(r,e||[],(0,Ul.default)(n).constructor):r.apply(n,e))}function Dh(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Dh=function(){return!!n})()}var h_=function(n){function r(e){var t;return(0,bh.default)(this,r),t=g_(this,r),t.currentSettings=e,t}return(0,Nh.default)(r,n),(0,Mh.default)(r,[{key:"setSettings",value:function(t){this.currentSettings=t,this.notifyListeners(t)}},{key:"getSettings",value:function(){return this.currentSettings}}])}(Qr);h();var Rh=2,As;(function(n){n[n.ServerError=0]="ServerError",n[n.WorkflowDisabled=100]="WorkflowDisabled",n[n.TokenNotReady=101]="TokenNotReady",n[n.FlightNotReady=102]="FlightNotReady",n[n.ContextNotReady=103]="ContextNotReady",n[n.WorkflowExcluded=104]="WorkflowExcluded",n[n.WorkflowExecutionTimeout=105]="WorkflowExecutionTimeout",n[n.LambdaExecutionError=106]="LambdaExecutionError",n[n.UnexpectedOutput=107]="UnexpectedOutput"})(As||(As={}));var Vi;(function(n){n[n.Unknown=0]="Unknown",n[n.InvalidRequest=1]="InvalidRequest",n[n.InvalidResponse=2]="InvalidResponse",n[n.RuntimeNotInitialized=3]="RuntimeNotInitialized",n[n.RequestCancelled=4]="RequestCancelled",n[n.ResponseReceivedAfterFinalResponse=5]="ResponseReceivedAfterFinalResponse"})(Vi||(Vi={}));var Me;(function(n){n[n.Unknown=0]="Unknown",n[n.Found=302]="Found",n[n.BadRequest=400]="BadRequest",n[n.Unauthorized=401]="Unauthorized",n[n.Forbidden=403]="Forbidden",n[n.NotFound=404]="NotFound",n[n.RequestTimeout=408]="RequestTimeout",n[n.Conflict=409]="Conflict",n[n.Gone=410]="Gone",n[n.RequestEntityTooLarge=413]="RequestEntityTooLarge",n[n.UnsupportedMediaType=415]="UnsupportedMediaType",n[n.UnprocessableContent=422]="UnprocessableContent",n[n.TooManyRequests=429]="TooManyRequests",n[n.SocketDisconnect=499]="SocketDisconnect",n[n.InternalServerError=500]="InternalServerError",n[n.ServiceUnavailable=503]="ServiceUnavailable",n[n.GatewayTimeout=504]="GatewayTimeout",n[n.UnsupportedMessage=1e3]="UnsupportedMessage",n[n.Cancelled=1001]="Cancelled",n[n.EgressError=1002]="EgressError",n[n.SyncMessageException=2e3]="SyncMessageException",n[n.SyncMessageUnsupported=2001]="SyncMessageUnsupported",n[n.SyncMessageUnexpectedSeed=2002]="SyncMessageUnexpectedSeed",n[n.SyncMessageUnsupportedBatch=2003]="SyncMessageUnsupportedBatch",n[n.SyncMessageQueueFull=2004]="SyncMessageQueueFull",n[n.SyncMessageTooLateOrDuplicate=2005]="SyncMessageTooLateOrDuplicate",n[n.SyncMessageGroupIdMismatch=2006]="SyncMessageGroupIdMismatch",n[n.SyncMessageGroupStop=2007]="SyncMessageGroupStop",n[n.SyncMessageLost=2008]="SyncMessageLost",n[n.SyncMessageUnprocessedDuplicate=2009]="SyncMessageUnprocessedDuplicate",n[n.SyncMessageSessionClosed=2010]="SyncMessageSessionClosed",n[n.SyncMessageAbandoned=2011]="SyncMessageAbandoned",n[n.TokenValidationError=2100]="TokenValidationError",n[n.TokenDecryptError=2101]="TokenDecryptError",n[n.TokenTypeError=2102]="TokenTypeError",n[n.TokenUserBlocked=2103]="TokenUserBlocked",n[n.AnnotationActivationInvalidType=2200]="AnnotationActivationInvalidType",n[n.AnnotationReleaseTokenNotFound=2300]="AnnotationReleaseTokenNotFound"})(Me||(Me={}));var tr;(function(n){n[n.UnKnown=0]="UnKnown",n[n.Start=1]="Start",n[n.Regular=2]="Regular",n[n.CheckConnection=3]="CheckConnection",n[n.PostEgress=4]="PostEgress",n[n.TimeoutResend=5]="TimeoutResend",n[n.FailResend=6]="FailResend"})(tr||(tr={}));var Ph;(function(n){n[n.IdentityChange=0]="IdentityChange"})(Ph||(Ph={}));var sn;(function(n){n[n.Idle=0]="Idle",n[n.Pending=1]="Pending"})(sn||(sn={}));h();var oe=w(P()),ie=w(R());var Hl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Message"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Hl.H_={T_:Hl.getTypeName(),B_:Hl.getBaseTypes()};var Ge=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Response"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ge.H_={T_:Ge.getTypeName(),B_:Ge.getBaseTypes()};var Qi=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_StreamingResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Qi.H_={T_:Qi.getTypeName(),B_:Qi.getBaseTypes()};var ji=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_StreamingRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ji.H_={T_:ji.getTypeName(),B_:ji.getBaseTypes()};var zl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ExecutionError"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();zl.H_={T_:zl.getTypeName(),B_:zl.getBaseTypes()};var Vl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_GetAnnotationsClientError"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Vl.H_={T_:Vl.getTypeName(),B_:Vl.getBaseTypes()};var Ql=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_GetAnnotationsErrorInfo"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ql.H_={T_:Ql.getTypeName(),B_:Ql.getBaseTypes()};var X=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();X.H_={T_:X.getTypeName(),B_:X.getBaseTypes()};var Ji=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TimeoutErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ji.H_={T_:Ji.getTypeName(),B_:Ji.getBaseTypes()};var Ki=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_RateLimitErrorResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_ErrorResponse","AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ki.H_={T_:Ki.getTypeName(),B_:Ki.getBaseTypes()};var pt=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();pt.H_={T_:pt.getTypeName(),B_:pt.getBaseTypes()};var un=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionInitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();un.H_={T_:un.getTypeName(),B_:un.getBaseTypes()};var jr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionLongPollMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();jr.H_={T_:jr.getTypeName(),B_:jr.getBaseTypes()};var nr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionLongPollResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();nr.H_={T_:nr.getTypeName(),B_:nr.getBaseTypes()};var Oo=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionCloseReason"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Oo.H_={T_:Oo.getTypeName(),B_:Oo.getBaseTypes()};var jl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionSwapOnClose"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SessionCloseReason"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();jl.H_={T_:jl.getTypeName(),B_:jl.getBaseTypes()};var Ve=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionCloseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ve.H_={T_:Ve.getTypeName(),B_:Ve.getBaseTypes()};var Yi=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_CacheDumpRequestMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Yi.H_={T_:Yi.getTypeName(),B_:Yi.getBaseTypes()};var Jl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_CacheDumpRequestResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Jl.H_={T_:Jl.getTypeName(),B_:Jl.getBaseTypes()};var ln=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationActivationMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ln.H_={T_:ln.getTypeName(),B_:ln.getBaseTypes()};var rr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationActivationResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();rr.H_={T_:rr.getTypeName(),B_:rr.getBaseTypes()};var Jr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationResultStateMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Jr.H_={T_:Jr.getTypeName(),B_:Jr.getBaseTypes()};var Kr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationReleaseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Kr.H_={T_:Kr.getTypeName(),B_:Kr.getBaseTypes()};var Yr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationReleaseResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Yr.H_={T_:Yr.getTypeName(),B_:Yr.getBaseTypes()};var Xr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Xr.H_={T_:Xr.getTypeName(),B_:Xr.getBaseTypes()};var Lo=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationConfigUpdateResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Lo.H_={T_:Lo.getTypeName(),B_:Lo.getBaseTypes()};var wn=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_BatchedMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();wn.H_={T_:wn.getTypeName(),B_:wn.getBaseTypes()};var Be=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SyncMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Be.H_={T_:Be.getTypeName(),B_:Be.getBaseTypes()};var or=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_MicroSyncMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();or.H_={T_:or.getTypeName(),B_:or.getBaseTypes()};var cn=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SyncResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();cn.H_={T_:cn.getTypeName(),B_:cn.getBaseTypes()};var Kl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionDeleteMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Kl.H_={T_:Kl.getTypeName(),B_:Kl.getBaseTypes()};var Ct=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_AnnotationResultsMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ct.H_={T_:Ct.getTypeName(),B_:Ct.getBaseTypes()};var Dn=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenProvisionMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Dn.H_={T_:Dn.getTypeName(),B_:Dn.getBaseTypes()};var Fo=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenFailureMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Fo.H_={T_:Fo.getTypeName(),B_:Fo.getBaseTypes()};var Yl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_TokenProvisionResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Yl.H_={T_:Yl.getTypeName(),B_:Yl.getBaseTypes()};var Xl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_KeepAlive"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Xl.H_={T_:Xl.getTypeName(),B_:Xl.getBaseTypes()};var Zr=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowGraphInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Zr.H_={T_:Zr.getTypeName(),B_:Zr.getBaseTypes()};var Xi=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowGraphInitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Xi.H_={T_:Xi.getTypeName(),B_:Xi.getBaseTypes()};var eo=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionCompleteMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_SyncMessage","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();eo.H_={T_:eo.getTypeName(),B_:eo.getBaseTypes()};var Zl=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitV2Message"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Zl.H_={T_:Zl.getTypeName(),B_:Zl.getBaseTypes()};var ec=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitV2Response"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ec.H_={T_:ec.getTypeName(),B_:ec.getBaseTypes()};var tc=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();tc.H_={T_:tc.getTypeName(),B_:tc.getBaseTypes()};var nc=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2InitResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();nc.H_={T_:nc.getTypeName(),B_:nc.getBaseTypes()};var rc=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_OAuth2CallbackMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();rc.H_={T_:rc.getTypeName(),B_:rc.getBaseTypes()};var qo=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_BridgeMessage"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();qo.H_={T_:qo.getTypeName(),B_:qo.getBaseTypes()};var Zi=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionConnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Zi.H_={T_:Zi.getTypeName(),B_:Zi.getBaseTypes()};var ea=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionDisconnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ea.H_={T_:ea.getTypeName(),B_:ea.getBaseTypes()};var ta=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SessionReconnectMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ta.H_={T_:ta.getTypeName(),B_:ta.getBaseTypes()};var na=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SubmittedCustomMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();na.H_={T_:na.getTypeName(),B_:na.getBaseTypes()};var $o=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ServerAuthenticationStateChangeMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();$o.H_={T_:$o.getTypeName(),B_:$o.getBaseTypes()};var ra=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_ClaimsChallengeMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ra.H_={T_:ra.getTypeName(),B_:ra.getBaseTypes()};var oc=function(){function n(r){(0,oe.default)(this,n),m.assign(n,this,r)}return(0,ie.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_BlobUploadResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();oc.H_={T_:oc.getTypeName(),B_:oc.getBaseTypes()};var Ot;(function(n){n.ClientDisconnected="Client disconnected.",n.UnsupportedSyncMessage="SyncMessages with seq = -1 are not supported anymore.",n.UnexpectedSeedMessage="Unexpected seed message",n.SyncMessageUnsupportedBatch="SyncMessage with unsupported batching.",n.AnnotationTokenNotFound="Token not found"})(Ot||(Ot={}));var ic;(function(n){n.ProvisionTokenValidationError="Token provision message didn't pass token validation.",n.ProvisionTokenDecryptAndTransformError="Token provision message didn't pass token decrypt and transform."})(ic||(ic={}));function bs(n){var r=["AugLoop_Excel_Session_Protocol_","AugLoop_Powerpoint_Session_Protocol_","AugLoop_Session_Protocol_"],e;for(var t of r)if(n.indexOf(t)===0){e=t;break}if(!e)return"MalformedMessageName";var o="Message",a=n.indexOf(o,n.length-o.length)===n.length-o.length;return n.slice(e.length,a?-o.length:void 0)}var m_=5e3,v_=12e4,y_=15e3,k_=3e5,w_=12e4,Go=function(){function n(r){(0,Bh.default)(this,n),this.config=r,this.nextMessageId=1,this.pendingResponseCallbacks=new Xn({sweepInterval:m_}),this.messageCallbacks=new Map,this.messageIdPrefix=r.messageIdPrefix,this.source=r.messageIdPrefix==="c"?Ie.ClientRuntime:Ie.Core,this.stats={sendMessageCount:0,sendMessageClientDisconnectedErrors:0,sendMessageErrors:0,sendMessageDurationMsMax:0,processMessageCount:0,processMessageProvisionTokenErrors:0,processMessageErrors:0,processMessageDurationMsMax:0}}return(0,Wh.default)(n,[{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"setEgress",value:function(e){var t=this;this.egress=e,this.config.resendPendingMessagesOnReconnect&&this.egress&&this.pendingResponseCallbacks.forEach(function(o,a){o.logOp.dimension1=(o.sendCount++).toString(),t.egress(o.message,function(s){return t.onEgressError(s,o)})})}},{key:"ingress",value:function(e,t){Ge.typeGuard(e)?(this.processResponse(e),t()):this.processMessage(e,t),Ve.typeGuard(e)&&!e.reconnectAllowed&&this.clearAllPendingResponses()}},{key:"sendMessage",value:function(e,t,o){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:0,u,l,c=new Le({sessionHealthEventName:"SendMessage",source:this.source,reason:de.Client,impact:this.source===Ie.ClientRuntime?_e.MissingInput:_e.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv,resourceId:bs(m.getTypeNameFor(e)),dimension0:s.toString()}).start(),f=function(){if(c.setClientMetadata(a.clientMetadata),c.success)v.info(572836e3,y.CoreDefault,c.stop());else{var T=c.resultSignature==="ErrorWithoutPendingResponse"||c.resultSignature==="ResponseCallbackException"||c.message!=="We called into done callback";c.message=JSON.stringify({errorNotPropagatedToDoneCallback:T}),v.error(572836001,y.CoreDefault,c.stop())}};H("PersistMessageId")?e.messageId=(u=e.messageId)!==null&&u!==void 0?u:`${this.messageIdPrefix}${this.nextMessageId++}`:e.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`,wn.typeGuard(e)&&e.messages.forEach(function(x,T){return x.messageId=e.messageId+"."+T});var d=m.getTypeNameFor(e)===Ve.getTypeName(),p=!o&&!d,g={message:e,logOp:c,logEvent:f,callback:void 0,sendCount:1};if(p){g.callback=function(x,T){var I;if(x?(c.success=!1,c.resultSignature=x.error,c.resultDescription=`Error for ${m.getTypeNameFor(e)} message ${e.messageId}${Be.typeGuard(e)?`, seq ${e.seq}`:""}: ${x.error}`):c.resultSignature="Success",t)try{c.message="We called into done callback",t(x,T)}catch(_){c.success=!1,c.resultSignature="ResponseCallbackException",c.resultDescription=((I=a.clientMetadata)===null||I===void 0?void 0:I.appPlatform)==="Web"?JSON.stringify({message:_.message,stack:_.stack}):JSON.stringify({message:_.message})}f(),a.updateSendMessageStats(c.success,c.durationMs,x?new Error(x.error):void 0)};var k=function(){g.callback(new Ji({code:Me.RequestTimeout,error:"Timeout waiting for response"}),void 0)},S=this.config.responseTimeoutMs;if(jr.typeGuard(e)){var C=e;C.longPollTimeoutHint>=y_&&C.longPollTimeoutHint<=k_?S=C.longPollTimeoutHint+5e3:S=v_}else ji.typeGuard(e)&&(S=(l=e.maxDelayMs)!==null&&l!==void 0?l:w_);this.pendingResponseCallbacks.put(e.messageId,g,S,k)}this.egress&&this.egress(e,function(x){return a.onEgressError(x,g)},s)}},{key:"onEgressError",value:function(e,t){var o,a;if(e){var s=t.message,u=this.pendingResponseCallbacks.get(t.message.messageId);u?(this.pendingResponseCallbacks.del(s.messageId),u.callback(new X({messageId:s.messageId,code:Me.EgressError,error:e.message}))):Ve.typeGuard(s)?(t.logOp.success=(a=(o=e.message)===null||o===void 0?void 0:o.endsWith("Client disconnected."))!==null&&a!==void 0?a:!1,t.logOp.resultSignature="ErrorSendingSessionCloseMessage",t.logOp.resultDescription=`Error for ${m.getTypeNameFor(s)} message ${s.messageId}: ${e.message}`,t.logEvent()):(t.logOp.success=!1,t.logOp.resultSignature="ErrorWithoutPendingResponse",t.logOp.resultDescription=`Error for ${m.getTypeNameFor(s)} message ${s.messageId}: ${e.message}`,t.logEvent())}}},{key:"queryEgressCacheSize",value:function(){return this.pendingResponseCallbacks.size()}},{key:"onMessage",value:function(e,t){this.messageCallbacks.set(e,t)}},{key:"getStats",value:function(){return this.stats}},{key:"hasMessageCallback",value:function(e){return this.messageCallbacks.has(e)}},{key:"cancelPendingResponseCallbacks",value:function(){var e=this;this.pendingResponseCallbacks.forEach(function(t,o){t&&(e.pendingResponseCallbacks.del(o),t.callback(new X({messageId:o,code:Me.Cancelled,error:"Cancelled"})))})}},{key:"clearAllPendingResponses",value:function(){if(this.pendingResponseCallbacks.size()!=0){var e=new E({operationName:"PurgePendingResponses",resultDescription:this.pendingResponseCallbacks.size().toString(),success:!0});v.info(572836002,y.CoreDefault,e),this.pendingResponseCallbacks.clear()}}},{key:"processMessage",value:function(e,t){var o=this,a=new Le({sessionHealthEventName:"ProcessMessage",source:this.source,reason:de.Client,impact:this.source===Ie.ClientRuntime?_e.MissingOutput:_e.MissingInput,success:!0,message:"",affectedWorkflows:["All"],cv:e.cv}).start(),s=function(){if(a.setClientMetadata(o.clientMetadata),a.success)v.info(572836003,y.CoreDefault,a.stop());else{var d=a.resourceId==="UnsupportedMessage"||a.resultSignature==="Timeout"||a.resultSignature==="OnResponseInvokedMoreThanOnce"||a.resultSignature==="MessageCallbackException"||a.message!=="We called into messageCallback";a.message=JSON.stringify({errorHappenedOutsideRegisteredMessageCallback:d}),v.error(572836032,y.CoreDefault,a.stop())}},u=this.messageCallbacks.get(m.getTypeNameFor(e));u?a.resourceId=bs(m.getTypeNameFor(e)):u=function(d,p){a.resourceId=bs(m.getTypeNameFor(d)),a.resourceId!=="MalformedMessageName"&&(a.resourceId="UnsupportedMessage"),p(new X({messageId:d.messageId,code:Me.UnsupportedMessage,error:`Message type ${m.getTypeNameFor(d)} is not supported`}))};var l=!1,c=function(d,p){l?(a.success=!1,a.resultSignature="OnResponseInvokedMoreThanOnce",a.resultDescription=`Invoked onResponse for ${m.getTypeNameFor(e)} message ${e.messageId} more than once`):d?(a.success=!1,a.resultSignature=d.error,d.code!==void 0&&(a.dimension0=Me[d.code]),a.resultDescription=`Error for ${m.getTypeNameFor(e)} message ${e.messageId}: ${d.error}`):a.resultSignature="Success",l=!0,s(),d&&!m.matchesTypesFor(d,[X.getTypeName()])&&(d=new X({error:"Internal Server Error"})),o.updateProcessMessageStats(a.success,a.durationMs,d?new Error(d.error):void 0),d?(d.messageId=e.messageId,t(d)):p?(p.messageId=e.messageId,t(void 0,p)):t()};try{a.message="We called into messageCallback",u(e,c)}catch(f){a.success=!1,a.resultSignature="MessageCallbackException",a.resultDescription=JSON.stringify({message:f.message,stack:f.stack}),s(),this.updateProcessMessageStats(!1,a.durationMs,f),t()}}},{key:"processResponse",value:function(e){var t,o=new E({operationName:"ProcessResponse"});if(o.success=!0,o.setClientMetadata(this.clientMetadata),o.start(),e.messageId){var a=this.pendingResponseCallbacks.get(e.messageId),s=a==null?void 0:a.callback;if(s){if(Qi.typeGuard(e)&&!e.finalResponse){var u=a.message.maxDelayMs;this.pendingResponseCallbacks.updateExpireTime(e.messageId,u)}else this.pendingResponseCallbacks.del(e.messageId);m.matchesTypesFor(e,[X.getTypeName()])?s(e):s(void 0,e)}else o.resultSignature="NoPendingMessage",o.resultDescription=`${e.messageId}`,o.success=!1}else o.resultSignature="NoMessageIdSetInResponse",X.typeGuard(e)?o.resultDescription=e.error:o.resultDescription="MessageId is not available",o.success=!1;((t=this.clientMetadata)===null||t===void 0?void 0:t.releaseAudienceGroup)!=="Production"&&(o.resourceId=bs(m.getTypeNameFor(e)),v.info(572836034,y.CoreDefault,o.stop()))}},{key:"updateSendMessageStats",value:function(e,t,o){this.stats.sendMessageCount++,this.stats.sendMessageDurationMsMax=Math.max(t,this.stats.sendMessageDurationMsMax),!e&&!o?v.warn(572836035,y.CoreDefault,"Failed send message did not provide error object."):e&&o&&v.warn(572836036,y.CoreDefault,"Succeeded send message provided error object."),!e&&(o&&o.message===Ot.ClientDisconnected?this.stats.sendMessageClientDisconnectedErrors++:this.stats.sendMessageErrors++)}},{key:"updateProcessMessageStats",value:function(e,t,o){this.stats.processMessageCount++,this.stats.processMessageDurationMsMax=Math.max(t,this.stats.processMessageDurationMsMax),!e&&!o?v.warn(572836037,y.CoreDefault,"Failed process message did not provide error object."):e&&o&&v.warn(572836038,y.CoreDefault,"Succeeded process message provided error object."),!e&&(o&&o.message===ic.ProvisionTokenValidationError?this.stats.processMessageProvisionTokenErrors++:this.stats.processMessageErrors++)}}])}();h();var Ze;(function(n){n[n.NotAuthenticated=0]="NotAuthenticated",n[n.Pending=1]="Pending",n[n.Authenticated=2]="Authenticated",n[n.WacUserInfoAuthenticated=3]="WacUserInfoAuthenticated",n[n.TokenMissingInteractionRequired=4]="TokenMissingInteractionRequired"})(Ze||(Ze={}));h();var sa=w(P()),ua=w(R());var oa=function(){function n(r){(0,sa.default)(this,n),m.assign(n,this,r)}return(0,ua.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_SetClaimsChallengeCallbackMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();oa.H_={T_:oa.getTypeName(),B_:oa.getBaseTypes()};var ia=function(){function n(r){(0,sa.default)(this,n),m.assign(n,this,r)}return(0,ua.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_FireClaimsChallengeCallbackResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ia.H_={T_:ia.getTypeName(),B_:ia.getBaseTypes()};var aa=function(){function n(r){(0,sa.default)(this,n),m.assign(n,this,r)}return(0,ua.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_InteractiveAuthMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();aa.H_={T_:aa.getTypeName(),B_:aa.getBaseTypes()};var ac=function(){function n(r){(0,sa.default)(this,n),m.assign(n,this,r)}return(0,ua.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_GetAnnotationsResponseBridgeMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ac.H_={T_:ac.getTypeName(),B_:ac.getBaseTypes()};var Wm=w(Pn());h();var x_=w(Se()),uc=w(P()),lc=w(R());var Lh=w(zi()),pe=function(){function n(){(0,uc.default)(this,n)}return(0,lc.default)(n,null,[{key:"createHealthCheckRequest",value:function(e){return{payload:{},payloadSchema:{category:En.Schema,schema:{name:"HealthCheckRequest"}},requestedSchema:{category:En.Schema,schema:{name:"HealthCheckResponse"}},clientMetadata:e}}},{key:"isFeatureEnabled",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"None";return e&&e.isFeatureEnabled?e.isFeatureEnabled("Microsoft.Office.AugLoop."+t,a).catch(function(){return Promise.resolve(o)}):Promise.resolve(o)}},{key:"isChangeGateEnabled",value:function(e,t){return e&&e.isChangeGateEnabled?e.isChangeGateEnabled(t):Promise.resolve(!1)}},{key:"convertWebSocketUrlToHttp",value:function(e){return this.convertUrl(e,!1)}},{key:"convertServiceUrlToWebSocket",value:function(e){return this.convertUrl(e,!0)}},{key:"convertUrl",value:function(e,t){if(!e)return e;var o=e.split(":"),a=o[0].toLowerCase();return a.indexOf(t?"http":"ws")==0?(a=t?a.replace("http","ws"):a.replace("ws","http"),o[0]=a,o.join(":")):e}},{key:"deepEquals",value:function(e,t){return(0,Lh.default)(e,t)}},{key:"collectTelemetry",value:function(e,t,o,a,s,u){var l,c,f,d;e.start(),e.resultSignature=a!=null?a:"",e.resultDescription=s!=null?s:"",e.success=o,u?(e.dimension0=(l=u[0])!==null&&l!==void 0?l:"",e.dimension1=(c=u[1])!==null&&c!==void 0?c:"",e.dimension2=(f=u[2])!==null&&f!==void 0?f:"",e.dimension3=(d=u[3])!==null&&d!==void 0?d:""):(e.dimension0="",e.dimension1="",e.dimension2="",e.dimension3=""),t.log(function(){return v.info(508367457,y.CoreDefault,e.stop())})}}])}();pe.getCurrentTimeMs=function(){return Date.now?Date.now():new Date().getTime()};var to=function(){function n(r){(0,uc.default)(this,n),this.maxNumberOfLogs=40,this.numberOfLogs=0,this.id=r}return(0,lc.default)(n,[{key:"log",value:function(e){if(this.numberOfLogs<this.maxNumberOfLogs&&(this.numberOfLogs++,e(),this.numberOfLogs===this.maxNumberOfLogs)){var t=new E({operationName:"OnLastLog",success:!0,resourceId:this.id,resultDescription:`Limit for number of logs for id: ${this.id} reached - all next logs will be dropped`});v.warn(572838107,y.CoreDefault,t)}}}])}(),wB=[m.getTypeName(),_t.getTypeName(),Xt.getTypeName()];var cc=function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return Number.isFinite(r)?r:e},Fh=function(r,e){if(!Array.isArray(e)||e.length===0||At.typeGuard(r)||mt.typeGuard(r))return!0;for(var t of r.items)if(!t.body||m.matchesTypesFor(t.body,e))return!0;return!1};h();var Hh=w(P()),zh=w(R());var Vh=w(fc());var Rn;(function(n){n.ArrivedBeforeReseeding="Message is dropped from queue since it arrived before reseeding is started",n.DroppedAsOldestInQueue="Message is dropped as oldest in full queue",n.DroppedBecauseClientDisconnected="Message is dropped because client is disconnected from server"})(Rn||(Rn={}));var Uh=1e3,Qh=function(){function n(r){(0,Hh.default)(this,n),this.logOp=new E({operationName:"MessageQueue",success:!0}),this.queue=new Vh.default(Uh),this.callbacks=r}return(0,zh.default)(n,[{key:"clear",value:function(){this.queue.clear()}},{key:"size",value:function(){return this.queue.length}},{key:"push",value:function(e,t,o){var a=this.queue;if(a.length===Uh){this.logOp.resourceId="QueueFull",this.logOp.durationMs=0,this.logOp.success=!1,v.warn(508843746,y.CoreDefault,this.logOp);var s=a.shift();s.onResponse&&s.onResponse(new X({error:Rn.DroppedAsOldestInQueue}))}a.push({message:e,onResponse:t,timeQueued:pe.getCurrentTimeMs(),attemptNumber:o})}},{key:"sendOnSessionInitialized",value:function(e){var t=this.queue.length,o=0;if(t>0){for(var a=pe.getCurrentTimeMs()-this.queue.get(0).timeQueued;this.queue.length>0&&this.callbacks.canSendMessage();){var s=this.queue.shift();e&&this.containSequencedSyncMessage(s)?(o++,s.onResponse&&s.onResponse(new X({error:Rn.ArrivedBeforeReseeding}))):s.message instanceof Uint8Array?this.callbacks.sendBytes(s.message):this.callbacks.sendMessage(s.message,s.onResponse,s.attemptNumber)}this.logOp.resourceId="SendOnSessionInitialized",this.logOp.resultDescription=`Queue size before: ${t}, after: ${this.queue.length}. droppedSyncMessages: ${o}`,this.logOp.durationMs=a,this.logOp.success=!0,v.warn(508843745,y.CoreDefault,this.logOp)}}},{key:"containSequencedSyncMessage",value:function(e){return e.message instanceof Be&&m.matchesTypesFor(e.message,[Be.getTypeName()])&&e.message.seq>=0||e.message instanceof wn&&m.matchesTypesFor(e.message,[wn.getTypeName()])}}])}();h();var jh=w(Qe()),dc=w($e()),ca=w(je()),Uo=w(P()),Ho=w(R());function Es(n,r,e){return r=(0,dc.default)(r),(0,jh.default)(n,Jh()?Reflect.construct(r,e||[],(0,dc.default)(n).constructor):r.apply(n,e))}function Jh(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Jh=function(){return!!n})()}var We;(function(n){n[n.Initing=0]="Initing",n[n.Running=1]="Running",n[n.Disconnected=2]="Disconnected",n[n.Closed=3]="Closed"})(We||(We={}));var pc=function(r,e,t,o){e&&(e.cv||(e.cv=r.cvParent.newChild().toString()),r.messageEndpoint.sendMessage(e,function(a,s){!a&&m.getTypeNameFor(s)===cn.getTypeName()&&(r.stats.lastSyncMessage=Date.now()),t&&t(a,s)},void 0,o))},Kh=function(r,e,t,o){e&&(r.messageQueue.push(e,t,o),r.networkWorkerManager.init(void 0,r.customInitPromise).catch(function(a){var s=new E({operationName:"WorkerManagerInit",success:!1,resultDescription:`${a}`});v.error(508843789,y.CoreDefault,s)}))},Yh=function(r,e){e&&(r.messageQueue.push(e),r.networkWorkerManager.init(void 0,r.customInitPromise).catch(function(t){v.error(508843788,y.CoreDefault,`Init failed: ${t}`)}))},Ns=function(){function n(r){(0,Uo.default)(this,n),this.context=r}return(0,Ho.default)(n,[{key:"onEnter",value:function(e){}},{key:"sendMessage",value:function(e,t,o,a){}},{key:"sendBytes",value:function(e){}},{key:"canSendMessage",value:function(){return!1}},{key:"onConnectionClose",value:function(){}}])}(),Xh=function(n){function r(){var e;return(0,Uo.default)(this,r),e=Es(this,r,arguments),e.stateName=We.Initing,e.possibleNextStates=[We.Running,We.Disconnected,We.Closed],e}return(0,ca.default)(r,n),(0,Ho.default)(r,[{key:"sendMessage",value:function(t,o,a){m.matchesTypesFor(t,[pt.getTypeName()])?pc(this.context,t,o,a):Kh(this.context,t,o)}},{key:"sendBytes",value:function(t){Yh(this.context,t)}},{key:"onConnectionClose",value:function(){this.context.setState(We.Disconnected)}}])}(Ns),Zh=function(n){function r(){var e;return(0,Uo.default)(this,r),e=Es(this,r,arguments),e.stateName=We.Running,e.possibleNextStates=[We.Disconnected,We.Closed],e}return(0,ca.default)(r,n),(0,Ho.default)(r,[{key:"onEnter",value:function(t){t&&t.isSessionReseedingStarted&&this.context.resetNextSyncSequenceId(),this.context.messageQueue.sendOnSessionInitialized(t&&t.isSessionReseedingStarted)}},{key:"sendMessage",value:function(t,o,a,s){pc(this.context,t,o,a)}},{key:"sendBytes",value:function(t){t&&this.context.networkWorkerManager.egressBytes(t)}},{key:"canSendMessage",value:function(){return!0}},{key:"onConnectionClose",value:function(){this.context.setState(We.Disconnected)}}])}(Ns),em=function(n){function r(){var e;return(0,Uo.default)(this,r),e=Es(this,r,arguments),e.stateName=We.Disconnected,e.possibleNextStates=[We.Initing,We.Closed],e}return(0,ca.default)(r,n),(0,Ho.default)(r,[{key:"onEnter",value:function(t){this.context.messageEndpoint.cancelPendingResponseCallbacks()}},{key:"sendMessage",value:function(t,o,a,s){if(m.matchesTypesFor(t,[pt.getTypeName()]))this.context.setState(We.Initing),pc(this.context,t,o,a);else if(m.matchesTypesFor(t,[Ve.getTypeName()]))this.context.setState(We.Closed);else{if(!s){Kh(this.context,t,o,a);return}o&&o(new X({messageId:t.messageId,error:Rn.DroppedBecauseClientDisconnected}))}}},{key:"sendBytes",value:function(t){Yh(this.context,t)}}])}(Ns),tm=function(n){function r(){var e;return(0,Uo.default)(this,r),e=Es(this,r,arguments),e.stateName=We.Closed,e.possibleNextStates=[],e}return(0,ca.default)(r,n),(0,Ho.default)(r,[{key:"onEnter",value:function(t){this.context.messageEndpoint.cancelPendingResponseCallbacks()}}])}(Ns);h();var bm=w(P()),Mm=w(R());h();h();var __=function(){if(typeof TextEncoder=="undefined"){rm();var r={AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder};return TextEncoder=void 0,TextDecoder=void 0,r}else return{AugLoopTextEncoder:TextEncoder,AugLoopTextDecoder:TextDecoder}},om=__(),gc=om.AugLoopTextEncoder,hc=om.AugLoopTextDecoder;h();var im=w(P()),am=w(R());var fn=function(){function n(){(0,im.default)(this,n)}return(0,am.default)(n,null,[{key:"deserialize",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:function(f){return f};if(e[0]!==n.IDENTIFIERBYTE)throw new Error("Invalid Binary: Incorrect Identifier");for(var o=1,a=[],s=new DataView(e.buffer,e.byteOffset,e.byteLength);o<e.byteLength;){if(o+4>e.byteLength)throw new Error("Invalid Binary: Error reading fragment length");var u=s.getUint32(o);if(o+u+4>e.byteLength)throw new Error("Invalid Binary: Fragment out of range");typeof Buffer!="undefined"&&Buffer.from?a.push(Buffer.from(e.buffer,e.byteOffset+o+4,u)):a.push(new Uint8Array(e.buffer,e.byteOffset+o+4,u)),o+=4+u}if(a.length<1)throw new Error("Invalid Binary: No fragments found");var l=n.textDecoder.decode(a[0]),c=function(d,p){if(typeof p=="string"){if(p.substring(0,n.BINARYKEYWORD.length)===n.BINARYKEYWORD){var g=parseInt(p.substring(n.BINARYKEYWORD.length),10);if(typeof g!="number"||g>=a.length-1)throw new Error("Invalid Binary: Binary index out of range");return t(a[g+1])}else if(p.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD)return p.substring(n.ESCAPEKEYWORD.length)}return p};return JSON.parse(l,c)}},{key:"serialize",value:function(e){var t=[void 0],o=function(p,g){return ArrayBuffer.isView(g)?(t.push(g),`${n.BINARYKEYWORD}${t.length-2}`):g&&g.type==="Buffer"&&Array.isArray(g.data)?(t.push(new Uint8Array(g.data)),`${n.BINARYKEYWORD}${t.length-2}`):typeof g=="string"&&g.substring(0,n.ESCAPEKEYWORD.length)===n.ESCAPEKEYWORD?n.ESCAPEKEYWORD+g:g},a=JSON.stringify(e,o);t[0]=n.textEncoder.encode(a);var s=t.reduce(function(d,p){return d+4+p.byteLength},0),u=new Uint8Array(s+1);u[0]=n.IDENTIFIERBYTE;var l=1,c=new DataView(u.buffer,u.byteOffset,u.byteLength);for(var f of t)c.setUint32(l,f.byteLength),u.set(f,l+4),l+=4+f.byteLength;return u}}])}();fn.IDENTIFIERBYTE=3;fn.BINARYKEYWORD=":b";fn.ESCAPEKEYWORD=":";fn.textDecoder=new hc;fn.textEncoder=new gc;h();var xm=w(P()),Tm=w(R());h();h();var sm=w(P()),um=w(R());var A_=3,mc=3e4,vc=function(){function n(r,e,t,o){(0,sm.default)(this,n),this.lastPingTime=0,this.lastPongTime=0,this.lastEgressTime=0,this.remainingPingFailures=3,this.isPingPongSuccessful=!1,this.reducedPingPongRetryEnabled=o,this.pingPongLogOp=new E({operationName:"WebSocketReliabilityManager",success:!0,resourceId:this.reducedPingPongRetryEnabled?"reducedPingPongRetryEnabled":""}).start(),this.pingPongLogOp.setClientMetadata(t,!0),this.worker=r,this.rateControllerClose=e}return(0,um.default)(n,[{key:"start",value:function(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.resultDescription="initial ping"):this.logOperation(!0,"ping","initial ping"),this.ping(),this.isPingPongSuccessful=!0,this.startInterval()}},{key:"onResponse",value:function(){this.lastPongTime=Date.now(),this.reducedPingPongRetryEnabled&&(this.pingPongLogOp.success=!0,v.info(506795283,y.CoreDefault,this.pingPongLogOp.stop()))}},{key:"isReliabilityResponse",value:function(e){return typeof e=="string"&&e.length===1&&e===n.pingPongMessage}},{key:"close",value:function(){this.reducedPingPongRetryEnabled?(this.pingPongLogOp.start(),this.pingPongLogOp.success=!0,this.pingPongLogOp.resultDescription="close",v.info(506795282,y.CoreDefault,this.pingPongLogOp.stop())):this.logOperation(!0,"ping","close"),this.lastPingTime=0,this.lastPongTime=0,this.isPingPongSuccessful=!1,this.clearPingInterval(),this.worker=void 0}},{key:"checkConnection",value:function(){return this.isPingPongSuccessful}},{key:"postEgress",value:function(){this.lastEgressTime=Date.now()}},{key:"needsParsedResponses",value:function(){return!1}},{key:"ping",value:function(){this.reducedPingPongRetryEnabled?this.worker||(this.pingPongLogOp.success=!1,this.pingPongLogOp.resultDescription="websocket worker undefined",this.rateControllerClose(),v.info(506795281,y.CoreDefault,this.pingPongLogOp.stop())):this.lastPingTime=Date.now(),this.worker&&(this.reducedPingPongRetryEnabled&&(this.lastPingTime=Date.now()),this.worker.egress({obj:n.pingPongMessage}))}},{key:"startInterval",value:function(){var e=this;this.pingInterval=setInterval(function(){if(e.reducedPingPongRetryEnabled){if(e.lastPongTime<e.lastPingTime&&Date.now()-e.lastPingTime<mc)return;e.isPingPongSuccessful=e.lastPongTime>=e.lastPingTime,e.pingPongLogOp.start(),e.isPingPongSuccessful?e.ping():(e.pingPongLogOp.success=!1,e.pingPongLogOp.resultDescription="Pong not received",v.info(506795280,y.CoreDefault,e.pingPongLogOp.stop()),e.worker?e.worker.close():e.rateControllerClose())}else{if(e.isPingPongSuccessful=e.lastPongTime>=e.lastPingTime&&e.lastPongTime-e.lastPingTime<=mc,e.lastPongTime>e.lastEgressTime)return;var t=e.lastPongTime-e.lastPingTime;e.isPingPongSuccessful?(e.remainingPingFailures=A_,e.ping()):e.remainingPingFailures>0?(--e.remainingPingFailures,e.ping()):(e.logOperation(!1,"ping","Pong still not received after all retry attempts",[`${t}`,`${e.remainingPingFailures}`]),e.worker?e.worker.close():e.rateControllerClose())}},mc)}},{key:"clearPingInterval",value:function(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0)}},{key:"logOperation",value:function(e,t,o,a){var s,u,l,c;this.pingPongLogOp.start(),this.pingPongLogOp.success=e,this.pingPongLogOp.resultSignature=t,this.pingPongLogOp.resultDescription=o,a&&(this.pingPongLogOp.dimension0=(s=a[0])!==null&&s!==void 0?s:"",this.pingPongLogOp.dimension1=(u=a[1])!==null&&u!==void 0?u:"",this.pingPongLogOp.dimension2=(l=a[2])!==null&&l!==void 0?l:"",this.pingPongLogOp.dimension3=(c=a[3])!==null&&c!==void 0?c:""),v.info(507320073,y.CoreDefault,this.pingPongLogOp.stop())}}])}();vc.pingPongMessage="~";h();var fm=w(P()),dm=w(R());var b_=15e3,M_=2e4,E_=6e4,lm="Request timed out",cm=4,pm=function(){function n(r,e,t){(0,fm.default)(this,n),this.remainingRetryAttempts=cm,this.isAsleep=!1,this.isLongPollSuccessful=!1,this.isActiveLongPoll=!1,this.isResponseReceived=!1,this.lastEgressTime=0,this.longPollLogOp=new E({operationName:"OnLongPollMessage",success:!0}),this.clientMetadata=e,this.sessionCorrelationVector=t,this.longPollLogOp.setClientMetadata(this.clientMetadata,!0),this.worker=r}return(0,dm.default)(n,[{key:"start",value:function(){var e=new E({operationName:"StartHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),v.info(508163399,y.CoreDefault,e.stop()),this.trySendLongPoll(tr.Start,!0),this.isLongPollSuccessful=!0}},{key:"onResponse",value:function(e){if(!e||this.isResponseReceived){var t=new E({operationName:"HttpReliabilityManagerFailure",success:!1}).start();t.setClientMetadata(this.clientMetadata,!0),v.info(508162497,y.CoreDefault,t.stop());return}this.isResponseReceived=!0,this.isActiveLongPoll=!1;var o=e;if(o.error)if(this.isLongPollSuccessful=!1,--this.remainingRetryAttempts,this.remainingRetryAttempts>0){this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription=`Retry attempts left : ${this.remainingRetryAttempts}`,this.longPollLogOp.resultSignature=o.error,v.info(508163398,y.CoreDefault,this.longPollLogOp.stop());var a=o.error===lm?tr.TimeoutResend:tr.FailResend;o.error===lm||this.remainingRetryAttempts===3?this.trySendLongPoll(a,!0):this.enqueueSendLongPoll(a)}else this.longPollLogOp.success=!1,this.longPollLogOp.resultDescription="Long poll still not received after all retry attempts",v.info(508163397,y.CoreDefault,this.longPollLogOp.stop()),this.worker&&this.worker.close();else this.longPollLogOp.success=!0,this.longPollLogOp.resultDescription="Long poll received",v.info(508163401,y.CoreDefault,this.longPollLogOp.stop()),this.remainingRetryAttempts=cm,this.isLongPollSuccessful=!0,this.trySendLongPoll(tr.Regular)}},{key:"close",value:function(){var e=new E({operationName:"CloseHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),v.info(508162467,y.CoreDefault,e.stop()),this.sendLongPollTimer&&(clearTimeout(this.sendLongPollTimer),this.sendLongPollTimer=void 0),this.isActiveLongPoll=!1,this.isLongPollSuccessful=!1,this.worker=void 0}},{key:"checkConnection",value:function(){if(this.isAsleep){this.isAsleep=!1;var e=new E({operationName:"AwakenHttpReliabilityManager",success:!0}).start();e.setClientMetadata(this.clientMetadata,!0),v.info(508162496,y.CoreDefault,e.stop()),this.trySendLongPoll(tr.CheckConnection,!0)}return this.isLongPollSuccessful}},{key:"isReliabilityResponse",value:function(e){return typeof e!="string"&&nr.typeGuard(e)}},{key:"postEgress",value:function(){this.lastEgressTime=Date.now(),this.trySendLongPoll(tr.PostEgress)}},{key:"needsParsedResponses",value:function(){return!0}},{key:"enqueueSendLongPoll",value:function(e){var t=this;this.sendLongPollTimer=setTimeout(function(){t.trySendLongPoll(e,!0)},M_)}},{key:"trySendLongPoll",value:function(e,t){if(!this.worker){var o=new E({operationName:"LongPollNoOp",success:!0}).start();o.setClientMetadata(this.clientMetadata,!0),o.resultDescription="Worker is undefined",v.info(507281438,y.CoreDefault,o.stop());return}if(this.isActiveLongPoll===!0){var a=new E({operationName:"LongPollNoOp",success:!0}).start();a.setClientMetadata(this.clientMetadata,!0),a.resultDescription="Already active long poll",v.info(508163396,y.CoreDefault,a.stop());return}if(this.isActiveLongPoll=!0,Date.now()-this.lastEgressTime>E_&&!t){this.isActiveLongPoll=!1,this.isAsleep=!0;var s=new E({operationName:"LongPollSleep",success:!0}).start();s.setClientMetadata(this.clientMetadata),s.resultDescription=`isAsleep: ${this.isAsleep}, isActiveLongPoll: ${this.isActiveLongPoll}`,v.info(507278739,y.CoreDefault,s.stop());return}this.longPollLogOp.start(),this.isResponseReceived=!1,this.worker.egress({obj:this.getLongPollMessageString(e),isHttpSessionLongPollMessage:!0,isHttpSessionInitMessage:!1})}},{key:"getLongPollMessageString",value:function(e){var t=new jr({longPollTimeoutHint:b_,type:e});return this.sessionCorrelationVector&&(t.cv=this.sessionCorrelationVector().newChild().toString()),JSON.stringify(t)}}])}();h();var gm=w(P()),hm=w(R());var mm=w(ys());var N_=2e4,D_=JSON.stringify(new nr({error:ks})),Ds=function(){function n(r){(0,gm.default)(this,n),this.networkOverrideOptions=r,this.isClosed=!1,this.pendingEgress=[]}return(0,hm.default)(n,[{key:"init",value:function(e,t,o,a){var s=new E({operationName:"HttpWorkerInit",success:!0}).start(),u=e.split("/?x-origin=");u.length===2?(this.url=pe.convertWebSocketUrlToHttp(u[0]),this.origin=u[1]):(this.url=pe.convertWebSocketUrlToHttp(e),this.origin=void 0),this.ingress=t,this.onOpen=o,this.onClose=a,v.info(507839180,y.CoreDefault,s.stop())}},{key:"egress",value:function(e){var t=this,o=new E({operationName:"HttpEgress",success:!0}).start();if(!(this.isConnectedToSession()||e.isHttpSessionInitMessage)){this.pendingEgress.push(e),o.success=!1,o.resultDescription="NotConnected, pendingQueueSize:  "+this.pendingEgress.length.toString(),v.info(508163394,y.CoreDefault,o.stop());return}var a=this.getRequestInfo(e,o);if(!a.url){o.success=!1,o.resultDescription="Could not generate HTTP request",v.error(508163393,y.CoreDefault,o.stop());return}if(e.isHttpSessionLongPollMessage){this.egressLongPoll(a,o);return}Vr(a.url,a.request,function(s,u){s?t.onEgressError(o,"OnEgressError:"+(s==null?void 0:s.message)):!u||!u.ok?t.onEgressError(o,"OnEgressResponseError: "+(s==null?void 0:s.message)+`, Status ${u==null?void 0:u.status}: ${u==null?void 0:u.statusText}`):u.text().then(function(l){o.success=!0,v.info(508163362,y.CoreDefault,o.stop()),t.ingressInternal(l)}).catch(function(l){t.onEgressError(o,"OnEgressParseError: "+(l==null?void 0:l.message))})})}},{key:"close",value:function(){var e=new E({operationName:"HttpWorkerClose",success:!0}).start();if(this.isClosed){e.resultDescription="AlreadyClosed",v.info(508163360,y.CoreDefault,e.stop());return}v.info(508163359,y.CoreDefault,e.stop()),this.isClosed=!0,this.sessionSettings=void 0,this.onClose&&(this.onClose(void 0),this.onClose=void 0)}},{key:"onEgressError",value:function(e,t){e.success=!1,e.resultDescription=t,v.error(508163358,y.CoreDefault,e.stop()),this.isClosed||this.close()}},{key:"ingressInternal",value:function(e,t){var o=this,a=e;t||(a=this.formatServerInput(e));var s=function(l){un.typeGuard(l)&&o.onSessionInitResponse(l)};a&&(this.logIngressCount(a),this.ingress(a,s))}},{key:"onSessionInitResponse",value:function(e){var t=this,o=new E({operationName:"HttpWorkerOpen",success:!0}).start();if(!e.sessionKey||!e.origin||!e.anonymousToken||!e.sessionUrlBase){o.success=!1,o.resultDescription="SessionInitResponse missing information",v.error(507809949,y.CoreDefault,o.stop());return}v.info(508163357,y.CoreDefault,o.stop()),this.setSessionSettings(e.sessionKey,e.origin,e.anonymousToken,e.sessionUrlBase),this.onOpen(),this.pendingEgress.forEach(function(a){t.egress(a)}),this.pendingEgress=[]}},{key:"egressLongPoll",value:function(e,t){var o=this;oh(e.url,N_,e.request).then(function(a){!a||!a.ok?o.onEgressError(t,"LongPollFetchStatusFailure: "+(a==null?void 0:a.statusText)):a.text().then(function(s){t.success=!0,t.resourceId="LongPoll",v.info(508163355,y.CoreDefault,t.stop()),o.ingressInternal(s)}).catch(function(s){o.onEgressError(t,"LongPollFetchParseError: "+(s==null?void 0:s.message))})}).catch(function(a){a.message===ks?(t.success=!1,t.resultDescription="LongPollFetchResponseTimeout:"+(a==null?void 0:a.message),v.error(508163353,y.CoreDefault,t.stop()),o.ingressInternal(D_,!0)):o.onEgressError(t,"LongPollFetchResponseError: "+(a==null?void 0:a.message))})}},{key:"getRequestInfo",value:function(e,t){var o=this.getUrl(e==null?void 0:e.isHttpSessionInitMessage),a=this.getHeader(e,t);return t.resultSignature=o,{url:o,request:{method:"POST",headers:a,body:e.obj}}}},{key:"getUrl",value:function(e){var t=this.sessionSettings&&this.sessionSettings.sliceUrl?this.sessionSettings.sliceUrl:this.url;return e?t+"/sessioninit":this.isConnectedToSession()?t+"/session/"+this.sessionSettings.sessionKey:""}},{key:"getHeader",value:function(e,t){var o,a,s=new mm.Headers;return e!=null&&e.isHttpSessionInitMessage?(s.set("Content-Type","application/json"),this.origin&&s.set("x-origin",this.origin)):this.isConnectedToSession()&&(e.obj instanceof Uint8Array||e.obj instanceof ArrayBuffer?(s.set("Content-Type","application/jsond2"),t.dimension0=e.obj.byteLength.toString().length.toString()):s.set("Content-Type","application/json"),s.append("Authorization",`Bearer ${this.sessionSettings.anonymousToken}`),s.set("x-origin",this.sessionSettings.origin)),!((o=this.networkOverrideOptions)===null||o===void 0)&&o.hostHeader&&s.set("host",(a=this.networkOverrideOptions)===null||a===void 0?void 0:a.hostHeader),s}},{key:"setSessionSettings",value:function(e,t,o,a){var s=a.replace("/session","");this.sessionSettings={sessionKey:e,origin:t,anonymousToken:o,sliceUrl:s}}},{key:"isConnectedToSession",value:function(){return this.sessionSettings&&this.sessionSettings.sessionKey.length>0&&this.sessionSettings.anonymousToken.length>0&&this.sessionSettings.origin.length>0&&this.sessionSettings.sliceUrl.length>0&&!this.isClosed}},{key:"formatServerInput",value:function(e){return e.length>1?e.substring(1,e.length-1):""}},{key:"logIngressCount",value:function(e){var t=e.length;if(t>1e5){var o=new E({operationName:"HttpIngressByteOrderOfMagnitude",success:!0}).start();o.dimension2=t.toString().length.toString(),v.info(508409622,y.CoreDefault,o.stop())}}}])}();var vm=function(r,e,t,o,a){return r instanceof Ds?new pm(r,t,o):new vc(r,e,t,a)};var Im=w(fc()),ym=function(n,r,e,t){function o(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(f){try{c(t.next(f))}catch(d){s(d)}}function l(f){try{c(t.throw(f))}catch(d){s(d)}}function c(f){f.done?a(f.value):o(f.value).then(u,l)}c((t=t.apply(n,r||[])).next())})},km=50,wm=1e5,P_=1e4,yc=1e4,Sm=3e6,kc=1e3,R_=1e4,Cm=.9,_m=function(){function n(r){var e=this;(0,xm.default)(this,n);var t,o,a;this.emptyMessageId=0,this.egressMessageCount=0,this.egressByteCount=0,this.prevSeq=-1,this.pendingQueue=[],this.rpsThreshold=150,this.bpsThreshold=5e8,this.isClosing=!1,this.messageQueue=void 0,this.egressRateLogOp=new E({operationName:"NetworkEgressRate",success:!0}),this.egressedCache=new Map,this.initPromise=new Promise(function(s){e.resolveInitPromise=s}),this.dynamicRateControllerEnabled=(t=r==null?void 0:r.dynamicRateControllerEnabled)!==null&&t!==void 0?t:!1,this.dynamicRateControllerEnabled&&(this.messageQueue=new Im.default),this.reducedPingPongRetryEnabled=(o=r==null?void 0:r.reducedPingPongRetryEnabled)!==null&&o!==void 0?o:!1,this.startQueueProcessingInOpen=(a=r==null?void 0:r.startQueueProcessingInOpen)!==null&&a!==void 0?a:!0}return(0,Tm.default)(n,[{key:"init",value:function(e,t,o,a,s,u){var l=this;this.worker=e,this.ingress=t,this.queryEgressCacheSize=o,this.clientMetadata=s,this.networkMode=a,this.reliabilityManager=vm(this.worker,this.close.bind(this),void 0,u,this.reducedPingPongRetryEnabled),this.egressRateLogOp.setClientMetadata(this.clientMetadata,!0),this.dynamicRateControllerEnabled&&(this.resetRateLimiter(),this.onCloseController=new Promise(function(c){l.resolveCloseControllerPromise=c}),this.queueProcessingCompletePromise=new Promise(function(c){l.resolveQueueProcessingCompletePromise=c}),this.startQueueProcessingInOpen||this.processQueue()),this.resolveInitPromise()}},{key:"open",value:function(){var e=this,t=new E({operationName:"NetworkRateControllerOpen",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();t.setClientMetadata(this.clientMetadata,!0),this.initPromise.then(function(){if(!e.reliabilityManager){t.success=!1,t.resultDescription="Reliability Manager is undefined";return}e.egressRateControlIntervalStart=Date.now(),e.reliabilityManager.start(),e.dynamicRateControllerEnabled?e.startQueueProcessingInOpen&&e.processQueue():(e.egressRateControlTimer=setInterval(function(){return e.flush()},1e3),e.flush())}).catch(function(o){var a;t.success=!1,t.resultDescription=(a="Catch: "+(o==null?void 0:o.message))!==null&&a!==void 0?a:""}).finally(function(){v.info(507834384,y.CoreDefault,t.stop())})}},{key:"ingressFromWorker",value:function(e,t){var o=this;if(!this.reliabilityManager){this.ingress(e,t);return}if(!this.reliabilityManager.needsParsedResponses()&&this.reliabilityManager.isReliabilityResponse(e)){this.reliabilityManager.onResponse();return}this.ingress(e,function(a){t==null||t(a),o.reliabilityManager.needsParsedResponses()&&o.reliabilityManager.isReliabilityResponse(a)&&o.reliabilityManager.onResponse(a)})}},{key:"onRateLimitErrorResponse",value:function(e){if(this.dynamicRateControllerEnabled){var t=new E({operationName:"NetworkRateControllerOnRateLimitResponse",success:!0}).start();t.setClientMetadata(this.clientMetadata,!0),t.resultSignature=`rateLimitAlreadyStarted: ${this.rateLimitTimeout!==void 0}`,t.setDataField("RetryAfterMs",e.retryAfterMs),t.setDataField("QueueSize",this.messageQueue.length),this.startRateLimiting(e.retryAfterMs),v.info(507388684,y.CoreDefault,t.stop())}}},{key:"setRpsBps",value:function(e,t){var o=new E({operationName:"NetworkRateControllerRateLimitsSet",success:!0}).start();o.setClientMetadata(this.clientMetadata,!0),e&&(this.rpsThreshold=Cm*e,o.resultDescription+=`maxRPS: ${e}, rpsThreshold: ${this.rpsThreshold}; `),t&&(this.bpsThreshold=Cm*t,o.resultDescription+=`maxRPS: ${t}, rpsThreshold: ${this.bpsThreshold}; `),v.info(507388683,y.CoreDefault,o.stop())}},{key:"close",value:function(){var e,t;return ym(this,void 0,void 0,function*(){var o=new E({operationName:"NetworkRateControllerClose",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();if(o.setClientMetadata(this.clientMetadata,!0),this.isClosing=!0,this.dynamicRateControllerEnabled){(e=this.resolveCloseControllerPromise)===null||e===void 0||e.call(this);var a=(t=this.reliabilityManager)===null||t===void 0?void 0:t.checkConnection();o.setDataField("QueueSizeBeforeFlush",this.messageQueue.length),this.messageQueue.length!=0&&a&&(yield this.queueProcessingCompletePromise),o.setDataField("QueueSizeAfterFlush",this.messageQueue.length),o.setDataField("IsConnected",a)}this.reliabilityManager?this.reliabilityManager.close():o.resultDescription="Reliability Manager is undefined",this.worker=void 0,this.prevSeq=-1,this.clearEgressControlTimeout(),this.reliabilityManager=void 0,v.info(507834381,y.CoreDefault,o.stop())})}},{key:"clearMessageQueues",value:function(){this.pendingQueue=[],this.egressedCache.clear(),this.messageQueue=void 0}},{key:"egress",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,o,a,s;if(!this.reliabilityManager){this.logEgressActivity(!1,"Reliability Manager is undefined","");return}var u=this.getMessageSize(e);if(u>=Sm){this.logEgressActivity(!1,`Message size exceeded ${Sm}`,`Message size: ${u}`);return}if((e.obj instanceof ArrayBuffer||e.isHttpSessionInitMessage)&&this.worker){this.logEgressActivity(!0,`isArrayBuffer: ${e.obj instanceof ArrayBuffer}, isHttpSessionInitMessage: ${e.isHttpSessionInitMessage}`,""),this.worker.egress(e);return}if(this.validateSyncMessage(e.messageId,e.seqId),this.dynamicRateControllerEnabled){var l=(o=e.messageId)!==null&&o!==void 0?o:`id${this.emptyMessageId++}`,c={obj:e.obj,seqId:e==null?void 0:e.seqId,messageId:l,isHttpSessionInitMessage:e==null?void 0:e.isHttpSessionInitMessage},f=t>0,d=new E({operationName:"NetworkRateControllerQueueItem",success:!0,dimension3:`isRetry: ${f}`}).start();d.setClientMetadata(this.clientMetadata,!0);var p={message:c,logOp:d};if(d.dimension0="Enqueue",f?this.messageQueue.unshift(p):this.messageQueue.push(p),this.messageQueue.length>R_)throw this.messageQueue.shift(),new Error("MessageQueue max size reached.");v.info(507388547,y.CoreDefault,d.stop()),(a=this.resolveQueueNotEmptyPromise)===null||a===void 0||a.call(this)}else{var g=this.queryEgressCacheSize(),k=this.egressMessageCount>=this.rpsThreshold,S=this.egressByteCount>=this.bpsThreshold,C=g>yc,x=this.reliabilityManager.checkConnection(),T=this.pendingQueue.length!==0,I=this.pendingQueue.length>=P_;if(!x||k||S||T||I||C){var _="",M=[];(T||I)&&(_+=I?"Pending queue max exceeded. ":"Pending queue not empty. ",M.push(this.pendingQueue.length.toString().length.toString())),C&&(_+=g>=yc?"Egressed cache max exceeded. ":"",M.push(g.toString().length.toString())),k&&(_+="RPS exceeded. ",M.push(this.egressMessageCount.toString().length.toString())),S&&(_+="BPS exceeded. ",M.push(this.egressByteCount.toString().length.toString())),_+=x?"":"Not connected. ",this.logEgressActivity(!0,`networkMode: ${this.networkMode}`,_,M);var b=(s=e.messageId)!==null&&s!==void 0?s:`id${this.emptyMessageId++}`;this.pendingQueue.push({obj:e.obj,seqId:e==null?void 0:e.seqId,messageId:b,isHttpSessionInitMessage:e==null?void 0:e.isHttpSessionInitMessage});return}this.sendToNetworkWorker(e)}}},{key:"getMessageSize",value:function(e){return e.obj instanceof ArrayBuffer?e.obj.byteLength:e.obj.length}},{key:"sendToNetworkWorker",value:function(e){try{if(!this.worker){this.logEgressActivity(!1,"NetworkWorker is undefined","SendToNetworkWorkerFailure");return}if(!this.reliabilityManager){this.logEgressActivity(!1,"Reliability Manager is undefined","SendToNetworkWorkerFailure");return}this.worker.egress(e),this.reliabilityManager.postEgress();var t=this.getMessageSize(e);this.logEgressCount(t)}catch(o){this.logEgressActivity(!1,"SendToNetworkWorkerFailure",o?o.message:"")}}},{key:"flush",value:function(){if(!this.reliabilityManager){var e=new E({operationName:"NetworkRateControllerFlushFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();e.setClientMetadata(this.clientMetadata,!0),e.resultDescription="Reliability Manager is undefined",v.info(507834373,y.CoreDefault,e.stop());return}for(var t=0,o=0;this.pendingQueue.length>0&&this.queryEgressCacheSize()<yc&&t<this.rpsThreshold&&o<this.bpsThreshold&&this.reliabilityManager.checkConnection();){var a=this.pendingQueue.shift();this.sendToNetworkWorker(a),t++,o+=this.getMessageSize(a)}}},{key:"processQueue",value:function(){var e,t,o;return ym(this,void 0,void 0,function*(){if(!this.reliabilityManager){var a=new E({operationName:"NetworkRateControllerProcessQueueFailure",success:!1,dimension3:`networkMode: ${this.networkMode}`}).start();a.setClientMetadata(this.clientMetadata,!0),a.resultDescription="Reliability Manager is undefined",v.info(507573643,y.CoreDefault,a.stop());return}for(var s=new E({operationName:"NetworkRateControllerProcessQueue",success:!0}).start();;){if(this.messageQueue.length===0){if(this.isClosing){s.setDataField("ExitReason","Stage#1 Closing");break}yield Promise.race([this.queueNotEmpty(),this.onCloseController])}if(this.rateLimitTimeout){var u=new E({operationName:"NetworkRateControllerRateLimitBackoff",dimension3:`networkMode: ${this.networkMode}`}).start();u.setClientMetadata(this.clientMetadata,!0),u.setDataField("QueueLengthBeforeBackoff",this.messageQueue.length),yield Promise.race([this.rateLimitTimeout,this.onCloseController]),u.setDataField("QueueLengthAfterBackoff",this.messageQueue.length),u.setDataField("IsClosing",this.isClosing),u.success=!0,this.rateLimitTimeout=void 0,this.resetRateLimiter(),v.info(507281410,y.CoreDefault,u.stop())}if(!(!((e=this.reliabilityManager)===null||e===void 0)&&e.checkConnection())){if(this.isClosing){s.setDataField("ExitReason","Stage#2 Closing");break}yield this.checkConnectionPromise(),this.connectionPromise=void 0}if(!this.reliabilityManager){s.setDataField("ExitReason","Stage#2 ReliabilityManager null");break}for(;this.messageQueue.length>0&&this.reliabilityManager.checkConnection();){var l=Date.now()-this.egressRateControlIntervalStart;if(l>=kc)this.resetRateLimiter();else if(this.egressMessageCount>=this.rpsThreshold||this.egressByteCount>=this.bpsThreshold){var c=Date.now()-this.egressRateControlIntervalStart,f=kc-c+100,d="";this.egressMessageCount>=this.rpsThreshold&&(d+="RPS exceeded."),this.egressByteCount>=this.bpsThreshold&&(d+="BPS exceeded.");var p="rateLimitHit",g=new E({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();g.setClientMetadata(this.clientMetadata,!0),g.success=!0,g.resultDescription=p,g.resultSignature=d,g.dimension0=this.messageQueue.length.toString().length.toString(),g.dimension1="rateLimitHit",g.setDataField("QueueLength",this.messageQueue.length),g.setDataField("RateLimitDelayMs",f),v.info(507281409,y.CoreDefault,g.stop()),this.startRateLimiting(f);break}var k=this.messageQueue.shift();k.logOp.dimension0="Dequeue",this.sendToNetworkWorker(k.message),v.info(507388682,y.CoreDefault,k.logOp.stop())}this.onQueueNotEmpty=void 0,this.resolveQueueNotEmptyPromise=void 0}(t=this.resolveQueueProcessingCompletePromise)===null||t===void 0||t.call(this),this.resolveQueueProcessingCompletePromise=void 0,s.setClientMetadata(this.clientMetadata,!0),s.setDataField("QueueSize",this.messageQueue.length),s.setDataField("IsConnected",(o=this.reliabilityManager)===null||o===void 0?void 0:o.checkConnection()),s.setDataField("IsClosing",this.isClosing),v.info(507368671,y.CoreDefault,s.stop())})}},{key:"queueNotEmpty",value:function(){var e=this;return this.onQueueNotEmpty||(this.onQueueNotEmpty=new Promise(function(t){e.resolveQueueNotEmptyPromise=t})),this.onQueueNotEmpty}},{key:"checkConnectionPromise",value:function(){return this.connectionPromise||(this.connectionPromise=new Promise(function(e){setTimeout(e,1e3)})),this.connectionPromise}},{key:"startRateLimiting",value:function(e){this.rateLimitTimeout||(this.rateLimitTimeout=new Promise(function(t){setTimeout(t,e)}))}},{key:"resetRateLimiter",value:function(){this.egressRateControlIntervalStart=Date.now(),this.egressMessageCount=0,this.egressByteCount=0}},{key:"clearEgressControlTimeout",value:function(){this.egressRateControlTimer&&(clearInterval(this.egressRateControlTimer),this.egressRateControlTimer=void 0)}},{key:"validateSyncMessage",value:function(e,t){if(!(t===void 0||e===void 0||t<=this.prevSeq)){if(t&&t!==this.prevSeq+1){var o=new E({operationName:"NetworkRateControllerAbandonedSyncMessage",success:!0,dimension3:`networkMode: ${this.networkMode}`}).start();o.setClientMetadata(this.clientMetadata,!0),o.resultDescription="Gap in sync message",o.dimension0=`${this.prevSeq}`,o.dimension1=`${t}`,o.dimension2=`${t-this.prevSeq}`,v.info(507834370,y.CoreDefault,o.stop())}this.prevSeq=t}}},{key:"logEgressActivity",value:function(e,t,o,a){var s,u,l,c,f=new E({operationName:"NetworkRateControllerEgress",dimension3:`networkMode: ${this.networkMode}`}).start();f.setClientMetadata(this.clientMetadata,!0),f.success=e,f.resultDescription=t,f.resultSignature=o,a&&(f.dimension0=(s=a[0])!==null&&s!==void 0?s:"",f.dimension1=(u=a[1])!==null&&u!==void 0?u:"",f.dimension2=(l=a[2])!==null&&l!==void 0?l:"",f.dimension3=(c=a[3])!==null&&c!==void 0?c:""),v.info(507626007,y.CoreDefault,f.stop())}},{key:"logEgressCount",value:function(e){var t=Date.now();t-this.egressRateControlIntervalStart>kc&&((this.egressMessageCount>km||this.egressByteCount>wm)&&(this.egressRateLogOp.start(),this.egressRateLogOp.resultDescription=this.egressMessageCount>km?"rps logging threshold exceeded":"",this.egressRateLogOp.resultDescription=this.egressByteCount>wm?"bps logging threshold exceeded":"",this.egressRateLogOp.dimension0=(t-this.egressRateControlIntervalStart).toString(),this.egressRateLogOp.dimension1=`${this.egressMessageCount}`,this.egressRateLogOp.dimension2=`${this.egressByteCount}`,this.egressRateLogOp.dimension3=`networkMode: ${this.networkMode}`,v.info(508843792,y.CoreDefault,this.egressRateLogOp.stop())),this.egressRateControlIntervalStart=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=e!=null?e:0}}])}();h();var Am="sessionWorkflowContext",Ce;(function(n){n[n.JSWebSockets=0]="JSWebSockets",n[n.LocalWorkflowsOnly=1]="LocalWorkflowsOnly",n[n.HostWebSockets=2]="HostWebSockets",n[n.HttpFallback=3]="HttpFallback"})(Ce||(Ce={}));h();var dn=w(P()),pn=w(R());var no=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_WorkflowRegistrationMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();no.H_={T_:no.getTypeName(),B_:no.getBaseTypes()};var ir=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionRequest"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ir.H_={T_:ir.getTypeName(),B_:ir.getBaseTypes()};var zo=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_WorkflowExecutionResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();zo.H_={T_:zo.getTypeName(),B_:zo.getBaseTypes()};var fa=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_RuntimeInitMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();fa.H_={T_:fa.getTypeName(),B_:fa.getBaseTypes()};var wc=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_DiagnosticTraceMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();wc.H_={T_:wc.getTypeName(),B_:wc.getBaseTypes()};var da=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_TelemetryMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();da.H_={T_:da.getTypeName(),B_:da.getBaseTypes()};var Sc=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_TelemetryFlushMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Sc.H_={T_:Sc.getTypeName(),B_:Sc.getBaseTypes()};var pa=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_SessionCloseResponse"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();pa.H_={T_:pa.getTypeName(),B_:pa.getBaseTypes()};var ar=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_WorkflowDefinitionOverrideMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ar.H_={T_:ar.getTypeName(),B_:ar.getBaseTypes()};var Sn=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsRequestMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_StreamingRequest","AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Sn.H_={T_:Sn.getTypeName(),B_:Sn.getBaseTypes()};var ga=function(){function n(r){(0,dn.default)(this,n),m.assign(n,this,r)}return(0,pn.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Session_Protocol_Internal_GetAnnotationsResponseMessage"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_StreamingResponse","AugLoop_Session_Protocol_Response"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ga.H_={T_:ga.getTypeName(),B_:ga.getBaseTypes()};var Em=1e3,B_=6e4,W_=function(r,e,t){var o=0,a=pe.getCurrentTimeMs()?pe.getCurrentTimeMs()-e:0,s=[1e3,2e3,5e3,1e4,6e4];return o=s[Math.max(0,Math.min(s.length-1,r-1))],o=Math.max(o-a,Em),o=t&&t>0?Math.min(5e3,o):o,o},ha=function(){function n(r,e,t,o,a,s,u,l,c,f,d){var p=this;(0,bm.default)(this,n),this.logCountLimiter=new to(n.className),this.isWorkerReady=!1,this.permanentlyClosed=!1,this.currentReconnectAttempt=0,this.lastInitializationAttemptTimeMs=0,this.offlineInterval=void 0,this.alreadyLoggedReconnectAttempt=!1,this.httpTestsLeft=5,this.httpTestsSuccessCount=0,this.workerOpenCount=0,this.testHttpConnection=function(g){var k=pe.convertWebSocketUrlToHttp(p.globalUrl),S=!g,C=g!=null?g:new E({operationName:"HttpsTest",resourceId:en(k),success:!1,resultDescription:"",resultSignature:"HttpResponse:"}).start(),x={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":C.cv},body:JSON.stringify(pe.createHealthCheckRequest(p.clientMetadata))};Vr(k,x,function(T,I){T?(C.dimension1="HttpErr",C.resultDescription+=`HttpErr: ${T.message}`):!I||!I.ok?(C.dimension1="HttpNoResp",C.resultDescription+=`HttpStatus: ${I==null?void 0:I.status}`):(C.dimension1="HttpOK",p.leaveOfflineMode(),p.httpTestsSuccessCount++,S&&(C.success=!0)),S&&C.stop(),p.logCountLimiter.log(function(){v.info(508843780,y.CoreDefault,C)})})},this.globalUrl=r,this.clientMetadata=e,this.workerFactory=t,this.sessionInitializer=o,this.ingress=a,this.queryEgressCacheSize=s,this.onConnectionClose=u,this.onDetectedWSBlock=l,this.sessionCorrelationVector=c,this.httpFallbackEnabled=f.httpFallbackEnabled,this.dynamicRateControllerEnabled=f.dynamicRateControllerEnabled,this.reducedPingPongRetryEnabled=f.reducedPingPongRetryEnabled,this.startQueueProcessingInOpen=f.startQueueProcessingInOpen,this.networkWorkerLogOp=new E({operationName:"CreateNetworkWorker",success:!0}),this.networkMode=d||Ce.JSWebSockets,this.initNetworkMode=this.networkMode}return(0,Mm.default)(n,[{key:"init",value:function(e,t){var o=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;if(this.permanentlyClosed)return Promise.reject(new Error("permanentlyClosed"));if(this.isWorkerReady||this.pendingInitPromise)return this.pendingInitPromise?this.pendingInitPromise:Promise.resolve();this.extensionConfigs=e||this.extensionConfigs;var s=function(){if(a||!o.alreadyLoggedReconnectAttempt){var l=a?n.initialAttemptTimeout:n.reconnectAttemptTimeout;o.connTimeout=setTimeout(function(){var c=new E({operationName:"ConnectionFailingOrSlow",dimension0:a?"Initial":"Reconnect",dimension1:l.toString(),dimension2:o.currentReconnectAttempt.toString()});v.info(508843787,y.CoreDefault,c),o.alreadyLoggedReconnectAttempt=!a,o.connTimeout=void 0},l)}};return t?this.pendingInitPromise=t().catch(function(u){var l=new E({operationName:"WorkerManagerCustomInit",success:!1,resultDescription:`${u}`});v.error(508843786,y.CoreDefault,l)}).then(function(){s(),o.initInternal()}):(this.pendingInitPromise=Promise.resolve(),s(),this.initInternal()),this.pendingInitPromise}},{key:"egress",value:function(e,t){var o=this;return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(function(){o.egressInternal(e,t)}):(this.egressInternal(e,t),Promise.resolve())}},{key:"egressBytes",value:function(e){var t=this;return!this.isWorkerReady&&this.pendingInitPromise?this.pendingInitPromise.then(function(){t.egressBytesInternal(e)}):(this.egressBytesInternal(e),Promise.resolve())}},{key:"getNetworkMode",value:function(){return this.networkMode}},{key:"getInitNetworkMode",value:function(){return this.initNetworkMode}},{key:"onRateLimitErrorResponse",value:function(e){this.dynamicRateControllerEnabled&&this.getNetworkRateController().onRateLimitErrorResponse(e)}},{key:"close",value:function(e){this.isWorkerReady=!1,this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close(),this.worker&&(this.worker.close(),this.worker=null),!this.dynamicRateControllerEnabled&&this.networkRateController&&this.getNetworkRateController().close(),this.networkRateController=null,this.permanentlyClosed=e||this.permanentlyClosed,this.permanentlyClosed&&(this.leaveOfflineMode(),clearTimeout(this.connTimeout))}},{key:"initInternal",value:function(){var e=this;if(this.isWorkerReady=!1,this.permanentlyClosed||this.isOffline()){var t=new E({operationName:"WorkerManagerInitOffline",success:!0,resultSignature:this.permanentlyClosed?"PermanentlyClosed":"Offline"});v.info(508843785,y.CoreDefault,t);return}this.currentReconnectAttempt>0?setTimeout(function(){e.tryToConnectAndInitializeSession()},W_(this.currentReconnectAttempt,this.lastInitializationAttemptTimeMs,this.httpFallbackEnabled?this.httpTestsSuccessCount:void 0)):this.getNetworkMode()===Ce.HttpFallback?setTimeout(function(){e.tryToConnectAndInitializeSession()},100):this.tryToConnectAndInitializeSession()}},{key:"egressInternal",value:function(e,t){if(!this.isWorkerReady&&!m.matchesTypesFor(e,[pt.getTypeName()])){m.matchesTypesFor(e,[Ge.getTypeName()])||v.error(508843784,y.CoreDefault,new E({operationName:"UnexpectedEgressCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}));return}var o;m.matchesTypesFor(e,[or.getTypeName()])?(this.castBinaryData(e),o=fn.serialize(e)):o=JSON.stringify(e);var a;if(Be.typeGuard(e)&&(a=e.seq),this.bypassRateController(e)){this.worker.egress({obj:o});return}var s=pt.typeGuard(e)&&this.getNetworkMode()===Ce.HttpFallback;this.getNetworkRateController().egress({obj:o,isHttpSessionInitMessage:s,messageId:e.messageId,seqId:a},t)}},{key:"bypassRateController",value:function(e){return Ve.typeGuard(e)}},{key:"egressBytesInternal",value:function(e){if(!this.isWorkerReady){v.error(508843783,y.CoreDefault,new E({operationName:"UnexpectedEgressBytesCall",resultDescription:`isWorkerReady: ${this.isWorkerReady}`}));return}this.getNetworkRateController().egress({obj:e})}},{key:"tryToConnectAndInitializeSession",value:function(){var e=this;this.currentReconnectAttempt++,this.lastInitializationAttemptTimeMs=pe.getCurrentTimeMs();var t=function(s){if(!(e.permanentlyClosed||e.isOffline())){var u=e.sliceUrl?e.sliceUrl:e.globalUrl;s.setDataField("connectionUrl",en(u)),e.connect(u),e.sessionInitializer.initSession({isTokenRefresh:!1,isReconnectOnSameSlice:!!e.sliceUrl,extensionConfigs:e.extensionConfigs,onResponse:function(c,f){if(s.success=!c,s.resourceId=f?en(f.sliceUrl):"",s.dimension2=e.getNetworkModeLogString(),e.getNetworkMode()===Ce.HttpFallback?(s.resultDescription=c?`HTTP Error: ${c.error}`:"",s.dimension0=s.success?"HTTPOK":"HTTPFail"):(s.resultDescription=c?`WS Error: ${c.error}`:"",s.dimension0=s.success?"WSOK":"WSFail"),c||!e.worker){e.sliceUrl=void 0,e.close(),e.httpTestsLeft>0?(e.httpTestsLeft--,e.testHttpConnection(s.stop())):(e.httpFallbackEnabled?e.getNetworkMode()===Ce.JSWebSockets?e.workerOpenCount===0&&e.httpTestsSuccessCount>=5?(s.dimension1="WSBlocked",s.dimension3="HTTP Fallback",e.networkMode=Ce.HttpFallback,e.currentReconnectAttempt=0,e.resetHttpTestsCounter()):e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="WSOffline"):e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="HTTPOffline"):e.workerOpenCount===0&&e.httpTestsSuccessCount>=5?(e.permanentlyClosed=!0,s.dimension1="WSBlocked",e.onDetectedWSBlock()):e.httpTestsSuccessCount===0&&(e.startOfflineMode(),s.dimension1="WSOffline"),e.logCountLimiter.log(function(){v.info(508843782,y.CoreDefault,s.stop())})),e.initInternal();return}else if(e.logCountLimiter.log(function(){v.info(508843781,y.CoreDefault,s.stop())}),f.forceReconnect){e.close();var d=new E({operationName:"ForcedReconnect"}).start();d.resultSignature=`globalUrl: ${e.globalUrl}. sliceUrl: ${e.sliceUrl}`,e.sliceUrl=void 0,setTimeout(function(){t(d)},Em)}else clearTimeout(e.connTimeout),e.sliceUrl=f.sliceUrl,e.dynamicRateControllerEnabled&&e.getNetworkRateController().setRpsBps(f.maxRPS,f.maxBPS),e.ready();e.resetHttpTestsCounter()}})}},o=new E({operationName:"TryToConnectAndInitializeSession",resultSignature:`Reconnection attempt #${this.currentReconnectAttempt}`}).start();t(o)}},{key:"getNetworkRateController",value:function(){return this.networkRateController||(this.networkRateController=new _m({dynamicRateControllerEnabled:this.dynamicRateControllerEnabled,reducedPingPongRetryEnabled:this.reducedPingPongRetryEnabled,startQueueProcessingInOpen:this.startQueueProcessingInOpen})),this.networkRateController}},{key:"connect",value:function(e){var t=this,o=this.getNetworkMode();this.networkWorkerLogOp.start(),this.networkWorkerLogOp.resultDescription=this.getNetworkModeLogString(),this.networkWorkerLogOp.dimension0=o.toString(),this.logCountLimiter.log(function(){return v.info(508372418,y.CoreDefault,t.networkWorkerLogOp.stop())}),this.worker=this.workerFactory(o),this.worker.init(e,this.getNetworkRateController().ingressFromWorker.bind(this.networkRateController),function(){t.workerOpenCount++,t.getNetworkRateController().open(),t.leaveOfflineMode()},function(a){t.close(),t.onConnectionClose(a)},this.clientMetadata),this.getNetworkRateController().init(this.worker,this.ingress,this.queryEgressCacheSize,o,this.clientMetadata,this.sessionCorrelationVector)}},{key:"ready",value:function(){this.isWorkerReady=!0,this.pendingInitPromise=void 0,this.currentReconnectAttempt=0}},{key:"castBinaryData",value:function(e){if(e){if(Array.isArray(e.__binaryMembers__))for(var t of e.__binaryMembers__)ArrayBuffer.isView(e[t])||(e[t]=new Uint8Array(e[t]));for(var o of Object.keys(e))typeof e[o]=="object"&&e[o]!==null&&this.castBinaryData(e[o])}}},{key:"isOffline",value:function(){return!!this.offlineInterval}},{key:"startOfflineMode",value:function(){var e=this;this.offlineInterval=setInterval(function(){e.testHttpConnection()},B_)}},{key:"leaveOfflineMode",value:function(){this.isOffline()&&(clearInterval(this.offlineInterval),this.offlineInterval=void 0,this.resetHttpTestsCounter(),this.tryToConnectAndInitializeSession())}},{key:"resetHttpTestsCounter",value:function(){this.httpTestsLeft=5,this.httpTestsSuccessCount=0}},{key:"getNetworkModeLogString",value:function(){return"NetworkMode: "+(this.getNetworkMode()===Ce.JSWebSockets?"WebSocket":"HTTP")}}])}();ha.initialAttemptTimeout=1e5;ha.reconnectAttemptTimeout=2e4;ha.className="NetworkWorkerManager";function O_(n,r,e){return r=(0,Cc.default)(r),(0,Pm.default)(n,Bm()?Reflect.construct(r,e||[],(0,Cc.default)(n).constructor):r.apply(n,e))}function Bm(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Bm=function(){return!!n})()}var xc=function(n){function r(e,t,o,a,s,u,l,c,f){var d;return(0,Nm.default)(this,r),d=O_(this,r),d.cvParent=new Je,d.logOp=new E({operationName:"SessionState",success:!0}).start(),d.sessionStateChangeLogCountLimiter=new to("SessionState"),d.logRetryTelemetry=!0,d.stats=t,d.allStates=(0,ma.default)((0,ma.default)((0,ma.default)((0,ma.default)({},We.Initing,new Xh(d)),We.Running,new Zh(d)),We.Disconnected,new em(d)),We.Closed,new tm(d)),d.setState(We.Initing),d.messageEndpoint=new Go({messageIdPrefix:"c",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),d.messageEndpoint.setClientMetadata(s),d.messageEndpoint.setEgress(d.egress.bind(d)),d.messageEndpoint.onMessage(Ve.getTypeName(),function(p,g){d.onSessionCloseMessage(p,g)}),d.networkWorkerManager=new ha(e,s,o,a,d.ingress.bind(d),d.messageEndpoint.queryEgressCacheSize.bind(d.messageEndpoint),d.onConnectionClose.bind(d),function(){d.onSessionClose(void 0,"WSNotSupported")},d.getCorrelationVector.bind(d),l,f),d.messageQueue=new Qh({sendMessage:function(g,k,S,C){return d.state.sendMessage(g,k,S,C)},sendBytes:d.sendBytes.bind(d),canSendMessage:function(){return d.state.canSendMessage()}}),a.on("connect",function(p,g,k,S,C,x,T){d.setState(We.Running,"",{isSessionReseedingStarted:p&&g}),d.emit("connect",p,k,S,C,x,T)}),a.on("reconnect",function(){return d.emit("reconnect")}),a.on("serverAuthenticationStateChange",function(p){return d.emit("serverAuthenticationStateChange",p)}),d.resetNextSyncSequenceId=function(){return d.emit("resetNextSyncSequenceId")},d.tokenRefreshManager=u,d.delayBeforeSocketClose=l.delayBeforeSocketClose,d.gateUtils=c,d.gateUtils&&d.gateUtils.isChangeGateEnabled("LogRetryMessageEvent").then(function(p){d.logRetryTelemetry=p}).catch(function(){}),d}return(0,Rm.default)(r,n),(0,Dm.default)(r,[{key:"setState",value:function(t,o,a){var s=this;if(!(this.state&&t===this.state.stateName)){var u=this.state?We[this.state.stateName]:"undefined",l=this.state?this.state.possibleNextStates.indexOf(t)>=0:t===We.Initing;this.sessionStateChangeLogCountLimiter.log(function(){s.logOp.stop(),s.logOp.resourceId=`New state: ${l?We[t]:u}`,s.logOp.resultDescription=`Previous state: ${u}`,s.logOp.dimension0=`Attempted state: ${We[t]||"undefined"}`,s.logOp.resultSignature=o+(s.state&&!l?"Unexpected state change":""),s.logOp.success=l,v.info(508843791,y.CoreDefault,s.logOp)}),l&&(this.state=this.allStates[t],this.logOp.start(),this.state.onEnter(a))}}},{key:"init",value:function(t,o){return this.extensionConfigs=t,this.customInitPromise=o,this.networkWorkerManager.init(this.extensionConfigs,this.customInitPromise,!0)}},{key:"sendMessage",value:function(t,o,a){this.retrySendMessage(t,o,r.maxRetries,a)}},{key:"sendBytes",value:function(t){this.state.sendBytes(t)}},{key:"onMessage",value:function(t,o){this.messageEndpoint.onMessage(t,o)}},{key:"getCorrelationVector",value:function(){return this.cvParent}},{key:"getNetworkWorkerManager",value:function(){return this.networkWorkerManager}},{key:"forceReconnect",value:function(t){var o=this;return this.extensionConfigs=t||this.extensionConfigs,this.networkWorkerManager.close(!1),new Promise(function(a){return setTimeout(function(){a(o.networkWorkerManager.init(o.extensionConfigs))},100)})}},{key:"closeSession",value:function(t){var o=this;if(this.sendMessage(new Ve),this.delayBeforeSocketClose)setTimeout(function(){o.networkWorkerManager.close(!0);var s=t||new Oo({reasonDescription:"ClientRequested"});o.onSessionClose(new Ve({reconnectAllowed:!1,reason:s}),"ClientRequested")},100);else{this.networkWorkerManager.close(!0);var a=t||new Oo({reasonDescription:"ClientRequested"});this.onSessionClose(new Ve({reconnectAllowed:!1,reason:a}),"ClientRequested")}}},{key:"ingress",value:function(t,o){var a=this,s;try{s=JSON.parse(t)}catch(c){v.error(508843790,y.CoreDefault,new E({operationName:"ProcessMessage",resourceId:"Unknown",success:!1,resultSignature:"ParseError",resultDescription:c.message,durationMs:0}))}if(s){if(o&&Ge.typeGuard(s)&&o(s),this.networkWorkerManager.getNetworkMode()===Ce.HttpFallback&&nr.typeGuard(s)){var u=s;if(u.batch)for(var l of u.batch)this.messageEndpoint.ingress(l,function(c,f){return a.egress(c||f,function(){})});return}this.messageEndpoint.ingress(s,function(c,f){return a.egress(c||f,function(){})})}}},{key:"egress",value:function(t,o,a){t&&this.networkWorkerManager.egress(t,a).then(function(){return o()}).catch(function(s){return o(s)})}},{key:"onSessionCloseMessage",value:function(t,o){t.reconnectAllowed?this.networkWorkerManager.close():this.onSessionClose(t,"CloseMessageReceived"),o()}},{key:"onSessionClose",value:function(t,o){this.setState(We.Closed,o),this.tokenRefreshManager.clearAllTimeouts(),this.onConnectionClose(void 0),t&&this.emit("sessionClose",t)}},{key:"onConnectionClose",value:function(t){this.state.onConnectionClose(),this.stats.lastConnectionClose=pe.getCurrentTimeMs(),this.emit("disconnect",t)}},{key:"retrySendMessage",value:function(t,o,a,s,u){var l=this,c=r.maxRetries-a;this.state.sendMessage(t,function(f,d){var p,g,k,S,C;u&&(f&&a==0?(u.success=!1,v.info(507025311,y.CoreDefault,u.stop())):f&&a>0?(u.dimension0=(c+1).toString(),u.dimension1=(p=f.code.toString())!==null&&p!==void 0?p:"NoErrorCode",u.resultSignature=(g=f.error)!==null&&g!==void 0?g:"NoErrorMessage"):(u.success=!0,v.info(507025310,y.CoreDefault,u.stop()))),f&&a>0&&l.canBeRetried(t)&&l.isTransientError(f)?(l.logRetryTelemetry&&!u&&(u=new E({operationName:"RetrySendMessage",success:!0,dimension0:c.toString()}).start(),u.resourceId=m.getTypeNameFor(t),u.dimension1=(S=(k=f.code)===null||k===void 0?void 0:k.toString())!==null&&S!==void 0?S:"NoErrorCode",u.resultSignature=(C=f.error)!==null&&C!==void 0?C:"NoErrorMessage",u.resultDescription=`Retrying message with messageId: ${t.messageId}${Be.typeGuard(t)?`, seq: ${t.seq}`:""}`),m.matchesTypesFor(f,[Ki.getTypeName()])&&l.networkWorkerManager.onRateLimitErrorResponse(f),l.retrySendMessage(t,o,a-1,s,u)):o&&o(f,d)},c,s)}},{key:"canBeRetried",value:function(t){return!m.matchesTypesFor(t,[pt.getTypeName(),or.getTypeName(),Sn.getTypeName()])}},{key:"isTransientError",value:function(t){var o=t.error;return o!==Ot.SyncMessageUnsupportedBatch&&o!==Ot.UnexpectedSeedMessage&&o!==Ot.UnsupportedSyncMessage&&o!==Ot.AnnotationTokenNotFound&&o!==Rn.ArrivedBeforeReseeding&&o!==Rn.DroppedAsOldestInQueue&&o!==Rn.DroppedBecauseClientDisconnected}}])}(Wm.EventEmitter);xc.maxRetries=2;h();var jS=w(Ui()),wo=w(Se()),Pr=w(dt()),JS=w(P()),KS=w(R());h();var Om=w(P()),Lm=w(R());var Tc=function(){function n(r,e,t,o){(0,Om.default)(this,n),this.sendMessage=r,this.annotationType=e,this.options=t,this.token=`${e}-${n.nextActivationResultBatchId++}`,this.annotationDoesNotExistOnServiceEnabled=o}return(0,Lm.default)(n,[{key:"activate",value:function(e,t,o){var a=this;return new Promise(function(s,u){a.sendMessage(new ln({annotationType:a.annotationType,token:a.token,config:a.options?a.options.config:void 0,ignoreExistingAnnotations:e,sendStateUpdates:a.options?!!a.options.stateUpdateCallback:void 0,forceReturnCachedAnnotations:a.options?a.options.forceReturnCachedAnnotations:void 0,returnAnnotationDoesNotExist:a.annotationDoesNotExistOnServiceEnabled||!1,sendApologies:o}),function(l,c){l?u(new Error(l.error)):(rr.typeGuard(c)&&a.annotationDoesNotExistOnServiceEnabled&&(a.annotationDoesNotExistOnService=c.annotationNotExists),s({token:a.token}))},t)})}},{key:"release",value:function(){var e=this;return new Promise(function(t,o){if(e.annotationDoesNotExistOnService&&e.annotationDoesNotExistOnServiceEnabled){t(!1);return}e.sendMessage(new Kr({token:e.token}),function(a,s){a?o(new Error(a.error)):t(s.lastRelease)})})}}])}();Tc.nextActivationResultBatchId=1;h();var sr=function(r,e){var t=[];for(var o of r!=null?r:[])if(!(e!==void 0&&e!==o.cardinality))for(var a of o.contextTypes)t.push([a,o.cardinality,o.producerWaitPolicy]);return t},Fm=function(r){var e=[];for(var t of r!=null?r:[])(t.cardinality===Tr.Required||t.producerWaitPolicy===Eo.Always)&&(e=e.concat(t.contextTypes));return e};h();h();var lt=w(Se()),Dv=w(P()),Pv=w(R()),Rv=w(Qe()),Rf=w($e()),Bv=w(je());h();h();var Ic=w(P()),_c=w(R());h();var qm=w(P()),$m=w(R());var L_=new G("performanceEventExpirationTimeMs",1e4),Gm=function(){function n(){(0,qm.default)(this,n),this.pendingEvents=[]}return(0,$m.default)(n,[{key:"add",value:function(e){this.pendingEvents.push(e),this.runTimeout()}},{key:"runTimeout",value:function(){var e=this;this.timer||this.pendingEvents.length===0||(this.timer=setTimeout(function(){e.logFinishedEvents(),e.timer=void 0,e.runTimeout()},500),this.timer.unref&&this.timer.unref())}},{key:"calculateSyncDuration",value:function(e){var t,o=0;if(e.sync)o+=(t=e.durationMs)!==null&&t!==void 0?t:0;else for(var a of e.children)o+=this.calculateSyncDuration(a);return o}},{key:"logFinishedEvents",value:function(){for(var e=this,t=Date.now(),o=0,a=[],s=function(){var l=e.pendingEvents[o];if(t-l.lastActivityTimeMs<L_.getValue())return a.push(l),1;ze(function(){var c=new E;c.operationName="PerformanceMeasurement",c.resourceId=l.rootScope.name,c.resultJSON=JSON.stringify(l.toLoggable()),c.success=!0,c.stop(),c.durationMs=Math.round(e.calculateSyncDuration(l.rootScope));var f=ut(),d=f.performanceEvent;f.performanceEvent=void 0,v.info(521417348,y.CoreDefault,c),f.performanceEvent=d},l.cc)};o<this.pendingEvents.length;o++)s();this.pendingEvents=a}}],[{key:"getInstance",value:function(){return this.instance||(this.instance=new n),this.instance}}])}();var nO=new G("loggedPerformanceEventsPercentage",0),rO=new G("lowRateThresholdMs",2e3);function Um(){v.setStartPerformanceEventCallback(function(n){var r=Q();return r.startSync(n)}),v.setStopPerformanceEventCallback(function(n){Q().stop(n)})}Um();var F_=function(){function n(){(0,Ic.default)(this,n)}return(0,_c.default)(n,[{key:"start",value:function(e,t){return ro}},{key:"startSync",value:function(e,t){return ro}},{key:"startAsync",value:function(e,t){return ro}},{key:"stop",value:function(e){}},{key:"remove",value:function(e){}},{key:"stopCurrentScope",value:function(){}},{key:"stopCurrentEvent",value:function(){}},{key:"resume",value:function(e){}},{key:"startBranch",value:function(e,t,o){return{event:ro,performanceEvent:Ps}}},{key:"switchToScope",value:function(e){}},{key:"switchToParentScope",value:function(){}},{key:"switchToRootScope",value:function(){}},{key:"markForLogging",value:function(){}},{key:"find",value:function(e){return ro}}])}(),ro={name:"Dummy",startTimeMs:0,activeEventsNumber:0,status:Wt.Active},Ps=new F_;Ps.rootScope=ro;Ps.currentScope=ro;var oo;(function(n){n[n.None=0]="None",n[n.WentDown=1]="WentDown",n[n.WentUp=2]="WentUp"})(oo||(oo={}));function Q(n){return q_.getCurrent(n)||Ps}var q_=function(){function n(){(0,Ic.default)(this,n),this.markedForLogging={value:!1},this.activeSyncEvents=new Set,this.notFoundEventNames=new Set}return(0,_c.default)(n,[{key:"resume",value:function(e){var t,o;this.lastActivityTimeMs=Date.now();var a;typeof e=="string"?a=(o=(t=this.currentScope)===null||t===void 0?void 0:t.children)===null||o===void 0?void 0:o.find(function(s){return s.name===e}):a=e,a&&this.resumeInternal(a)&&(this.currentScope=a.parent,a.sync&&this.activeSyncEvents.add(a))}},{key:"start",value:function(e,t){return this.startInternal(e,void 0,t)}},{key:"startAsync",value:function(e,t){return this.startInternal(e,!1,t)}},{key:"startSync",value:function(e,t){return this.startInternal(e,!0,t)}},{key:"stop",value:function(e){var t,o,a;this.lastActivityTimeMs=Date.now();var s=Qt(),u;if(typeof e=="string"?((t=this.currentScope)===null||t===void 0?void 0:t.name)===e?u=this.currentScope:u=(o=this.currentScope)===null||o===void 0?void 0:o.children.find(function(c){return c.name===e}):u=e,!!u){if(u.activeEventsNumber?u.stopRequested=!0:(this.pause(u,s),u.status=Wt.Stopped,u.parent&&u.parent.stopRequested&&u.parent.activeEventsNumber===0&&(this.stop(u.parent),u.parent.stopRequested=!1)),u.sync&&u.parent.neighbourScopeActiveSyncEvents)for(var l of u.parent.neighbourScopeActiveSyncEvents)l.status===Wt.Paused&&(this.resumeInternal(l),l.pausedByNeighbour=!1);this.currentScope=(a=u.initialScope)!==null&&a!==void 0?a:u.parent,u.sync&&this.activeSyncEvents.delete(u)}}},{key:"remove",value:function(e){var t;this.lastActivityTimeMs=Date.now(),(t=e==null?void 0:e.parent)===null||t===void 0||t.children.splice(e.parent.children.indexOf(e),1)}},{key:"stopCurrentScope",value:function(){this.stop(this.currentScope)}},{key:"stopCurrentEvent",value:function(){this.currentScope.children.length>0&&this.stop(this.currentScope.children[this.currentScope.children.length-1])}},{key:"startBranch",value:function(e,t,o){return this.startBranchInternal(e,t,void 0,o)}},{key:"switchToScope",value:function(e){this.currentScope=e}},{key:"switchToParentScope",value:function(){var e;this.currentScope=(e=this.currentScope)===null||e===void 0?void 0:e.parent}},{key:"switchToRootScope",value:function(){this.currentScope=this.rootScope}},{key:"markForLogging",value:function(){this.markedForLogging.value||(this.markedForLogging.value=!0,Gm.getInstance().add(this))}},{key:"toLoggable",value:function(){var e={events:{},summary:{syncDurationMs:0,asyncDurationMs:0,eventDurations:{}}};return e.events[this.rootScope.name]=this.mapEventToLoggable(this.rootScope),this.notFoundEventNames.size>0&&(e.summary.notFoundEventNames=Array.from(this.notFoundEventNames)),this.fillSummary(e.summary,this.rootScope),e}},{key:"find",value:function(e){var t=this.findInternal(e);return t||this.notFoundEventNames.add(e),t}},{key:"pauseActiveSyncEvents",value:function(){var e=Qt();for(var t of this.activeSyncEvents)this.pause(t,e)}},{key:"resumeActiveSyncEvents",value:function(){for(var e of this.activeSyncEvents)!e.pausedByNeighbour&&e.status===Wt.Paused&&e.performanceEvent===this&&this.resumeInternal(e)}},{key:"resumeInternal",value:function(e,t){if(e&&(e.status!==Wt.Active||t)){if(e.parent&&e.parent.activeEventsNumber++,e.startTimeMs=Qt(),e.status=Wt.Active,e.sync&&e.parent.neighbourScopeActiveSyncEvents){var o=Qt();for(var a of e.parent.neighbourScopeActiveSyncEvents)a.status===Wt.Active&&(this.pause(a,o),a.pausedByNeighbour=!0)}return!0}return!1}},{key:"startInternal",value:function(e,t,o){this.lastActivityTimeMs=Date.now();var a=this.currentScope,s=this.switchScope(t),u=this.findOrCreateEvent(e,t,o);return u.event.performanceEvent=this,this.onEventStarted(u.event,a,u.created,s),u.event}},{key:"startBranchInternal",value:function(e,t,o,a){var s=this.currentScope,u=this.switchScope(o),l=this.createEvent(e,o,a);this.onEventStarted(l,s,!0,u),this.currentScope=l;var c=new n;return c.rootScope=this.rootScope,c.currentScope=this.currentScope,c.cc=t,c.markedForLogging=this.markedForLogging,c.activeSyncEvents=this.activeSyncEvents,c.notFoundEventNames=this.notFoundEventNames,l.performanceEvent=c,t.performanceEvent=c,this.currentScope=s,{event:l,performanceEvent:c}}},{key:"onEventStarted",value:function(e,t,o,a){var s;this.lastActivityTimeMs=Date.now(),a.scopeChange!==oo.None&&(e.initialScope=t),e.neighbourScopeActiveSyncEvents=a.neighbourScopeActiveSyncEvents,o?(e.parent=this.currentScope,(s=this.currentScope)===null||s===void 0||s.children.push(e)):e.status!==Wt.Active&&(e.count=e.count?e.count+1:2,e.startTimeMs=Qt(),e.status=Wt.Active),this.resumeInternal(e,!0),e.sync&&this.activeSyncEvents.add(e)}},{key:"pause",value:function(e,t){var o;e.status===Wt.Active&&(e.durationMs=((o=e.durationMs)!==null&&o!==void 0?o:0)+(t-e.startTimeMs),e.startTimeMs=void 0,e.parent&&e.parent.activeEventsNumber--,e.status=Wt.Paused)}},{key:"findInternal",value:function(e){var t,o;return(o=(t=this.currentScope)===null||t===void 0?void 0:t.children)===null||o===void 0?void 0:o.find(function(a){return a.name===e})}},{key:"switchScope",value:function(e){for(var t,o={scopeChange:oo.None},a,s=this.currentScope.children.length-1;s>=0;s--){var u=this.currentScope.children[s];if(u.startTimeMs!==void 0&&u.performanceEvent===this){if(e===!0&&u.sync!==!1||e!==!0&&u.sync===void 0)return this.currentScope=u,{scopeChange:oo.WentDown};a=u}}if(e===!1)for(;!((t=this.currentScope)===null||t===void 0)&&t.sync;)this.currentScope=this.currentScope.parent,o.scopeChange=oo.WentUp;else if(e===void 0){var l=this.currentScope;for(a!=null&&a.sync&&(o.neighbourScopeActiveSyncEvents=new Set([a]));l.sync!==void 0;)l.sync===!0&&l.startTimeMs!==void 0&&(o.neighbourScopeActiveSyncEvents||(o.neighbourScopeActiveSyncEvents=new Set),o.neighbourScopeActiveSyncEvents.add(l)),l=l.parent,o.scopeChange=oo.WentUp;this.currentScope=l}return o}},{key:"mergeEvents",value:function(e,t){var o,a,s,u;e.count=((o=e.count)!==null&&o!==void 0?o:1)+((a=t.count)!==null&&a!==void 0?a:1),e.durationMs=((s=e.durationMs)!==null&&s!==void 0?s:0)+((u=t.durationMs)!==null&&u!==void 0?u:0),t.children.length>0&&e.children===void 0&&(e.children={});for(var l of t.children)e.children[l.name]?this.mergeEvents(e.children[l.name],l):e.children[l.name]=this.mapEventToLoggable(l)}},{key:"fillSummary",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},a,s,u,l,c;t.sync&&((a=t.parent)===null||a===void 0?void 0:a.sync)!==!0?e.syncDurationMs+=(s=t.durationMs)!==null&&s!==void 0?s:0:t.sync===!1&&(e.asyncDurationMs+=(u=t.durationMs)!==null&&u!==void 0?u:0),e.eventDurations[t.name]===void 0&&(e.eventDurations[t.name]={sync:t.sync,durationMs:0,count:0}),o[t.name]===1&&(e.eventDurations[t.name].durationMs+=(l=t.durationMs)!==null&&l!==void 0?l:0),e.eventDurations[t.name].count+=(c=t.count)!==null&&c!==void 0?c:1;for(var f of t.children)o[f.name]=o[f.name]?o[f.name]+1:1,this.fillSummary(e,f,o),o[f.name]--}},{key:"mapEventToLoggable",value:function(e){var t=Object.assign({},e);if(t.parent=void 0,t.startTimeMs=void 0,t.initialScope=void 0,t.name=void 0,t.neighbourScopeActiveSyncEvents=void 0,t.perfEvent=void 0,t.pausedByNeighbour=void 0,t.performanceEvent=void 0,t.activeEventsNumber=void 0,t.stopRequested=void 0,t.status=void 0,t.children.length>0){t.children={};var o=0;for(var a of e.children)if(t.children[a.name])this.mergeEvents(t.children[a.name],a);else{var s=this.mapEventToLoggable(a);e.children.length>1&&(s.order=o++),t.children[a.name]=s}}else t.children=void 0;return t}},{key:"createEvent",value:function(e,t,o){var a={name:e,sync:t,startTimeMs:Qt(),children:[],activeEventsNumber:0,status:Wt.Active};return o&&(a=Object.assign(a,o)),a}},{key:"findOrCreateEvent",value:function(e,t,o){var a=this.findInternal(e),s=a===void 0||a.startTimeMs!==void 0;return s?a=this.createEvent(e,t,o):o&&Object.assign(a,o),{event:a,created:s}}}],[{key:"getCurrent",value:function(e){var t;return(t=e!=null?e:ut())===null||t===void 0?void 0:t.performanceEvent}},{key:"create",value:function(e,t){var o=ut(),a=new n;return a.rootScope=a.findOrCreateEvent(e,void 0,t).event,a.currentScope=a.rootScope,a.cc=o,a.lastActivityTimeMs=Date.now(),o.performanceEvent=a,o.performanceEvent}}])}();h();var Hm=w(P()),zm=w(R());var Cn=function(){function n(r){(0,Hm.default)(this,n),m.assign(n,this,r)}return(0,zm.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Voice_VoiceOperation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Operation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Cn.H_={T_:Cn.getTypeName(),B_:Cn.getBaseTypes()};var Ov=w(Pn());h();var Vm=w(R()),Qm=w(P()),jm=w(Qe()),Ac=w($e()),Jm=w(je()),Km=w(as());function $_(n,r,e){return r=(0,Ac.default)(r),(0,jm.default)(n,Ym()?Reflect.construct(r,e||[],(0,Ac.default)(n).constructor):r.apply(n,e))}function Ym(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Ym=function(){return!!n})()}var io=function(n){function r(e){var t;return(0,Qm.default)(this,r),t=$_(this,r,[e]),t.__proto__=r.prototype,t}return(0,Jm.default)(r,n),(0,Vm.default)(r)}((0,Km.default)(Error));h();var bc=w(Se()),tv=w(dt()),CO=w(Xm()),nv=w(P()),rv=w(R());h();var xn;(function(n){n.ApplyOperations="ApplyOperations",n.GetModelSubTreeItems="Model.GetSubTreeItems",n.EmitEvents="EmitEvents",n.InvokeSynchronousEvents="InvokeSynchronousEvents",n.UpdateModelItems="Model.UpdateItems",n.GetModelItemChildren="Model.GetItemChildren"})(xn||(xn={}));h();var tn="\\",U_=100,at=function(r,e){return Object.assign(Object.assign({},e),{parentPath:r})},z=function(r){return Array.isArray(r)?r.length===5?`${r[0]}${tn}${r[1]}${tn}${r[2]}${tn}${r[3]}${tn}${r[4]}`:r.length===4?`${r[0]}${tn}${r[1]}${tn}${r[2]}${tn}${r[3]}`:r.length===3?`${r[0]}${tn}${r[1]}${tn}${r[2]}`:r.length===2?`${r[0]}${tn}${r[1]}`:r.length===1?r[0]:r.join(tn):"(malformed path)"},Zm=function(r,e){if(r.length!==e.length)return!1;for(var t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0},Bn=function(r){return r.split(tn)},ev=function(r){return r&&r.length>0&&r.length<U_&&r.indexOf(tn)<0},ya=function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return Number.isFinite(r)?r:e},Wn=function(r,e){if(r.length>e.length)return!1;for(var t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0};var Rs=function(){function n(){(0,nv.default)(this,n),this.singleItemListeners=new Map}return(0,rv.default)(n,[{key:"onItemChange",value:function(e,t,o,a){var s=this.singleItemListeners.get(e);s||(s=[],this.singleItemListeners.set(e,s)),s.push({itemType:e,inputStage:t,callback:o,synchronousCallbackRequired:a})}},{key:"emitEvents",value:function(e,t){var o=this,a=Q(),s=a.startSync(xn.EmitEvents),u=[],l=[],c=new Map,f=function(_){v.debug(572837896,y.CoreDefault,function(){return`Triggering notifications for ${m.getTypeNameFor(_)}`});var M=function(N){if(!N.body)return 1;var F=function(Y){var fe=o.singleItemListeners.get(Y);for(var W of fe||[]){if(t!==void 0&&t<1&&!(W.inputStage&zt.PreSeed)){v.debug(572837897,y.CoreDefault,function(){return`Suppressing item listener callback for item type ${Y} on ${z([].concat((0,bc.default)(_.parentPath),[N.id]))} on a seeded item.`});continue}v.debug(572837898,y.CoreDefault,function(){return`Invoking item listener callback for item type ${Y} on ${z([].concat((0,bc.default)(_.parentPath),[N.id]))}`});var B=Object.assign(Object.assign({},_),{items:[N]}),L=c.get(W);L||(L=[],c.set(W,L)),L.push(B)}};for(var q of m.getAllTypesFor(N.body))F(q)};for(var b of _.items)M(b)};for(var d of e)f(d);var p=function(_,M){_.synchronousCallbackRequired?l.push(function(){return _.callback(M)}):u.push(function(){return _.callback(M)})};for(var g of c.entries()){var k=(0,tv.default)(g,2),S=k[0],C=k[1];p(S,C)}var x=function(_){var M=function(N){try{kn(function(){N()})}catch(F){v.error(572837899,y.CoreDefault,`Item listener callback failed: ${F.message}`)}};for(var b of _)M(b)};if(l.length>0){a.stop(s);var T=a.start(xn.InvokeSynchronousEvents);x(l),a.stop(T),a.resume(s)}u.length>0&&setTimeout(function(){return x(u)},0),a.stop(s)}}])}();h();var me;(function(n){n[n.Add=0]="Add",n[n.Delete=1]="Delete",n[n.Update=2]="Update",n[n.CursorUpdate=3]="CursorUpdate",n[n.FormattingUpdate=4]="FormattingUpdate",n[n.OtherNonContentUpdate=5]="OtherNonContentUpdate"})(me||(me={}));var Ke;(function(n){n[n.Chars=0]="Chars",n[n.Word=1]="Word",n[n.PartialSentence=2]="PartialSentence",n[n.Sentence=3]="Sentence",n[n.Paragraph=4]="Paragraph"})(Ke||(Ke={}));var ov;(function(n){n[n.SessionUser=0]="SessionUser",n[n.Programmatic=1]="Programmatic",n[n.Collaborator=2]="Collaborator"})(ov||(ov={}));h();var iv;(function(n){n[n.Unspecified=0]="Unspecified",n[n.Inline=1]="Inline",n[n.Floating=2]="Floating"})(iv||(iv={}));var Bs;(function(n){n[n.Undefined=0]="Undefined",n[n.Bullet=1]="Bullet",n[n.Numbered=2]="Numbered",n[n.Lim=3]="Lim",n[n.Nil=4]="Nil",n[n.Any=5]="Any",n[n.NoList=6]="NoList",n[n.Invalid=7]="Invalid"})(Bs||(Bs={}));var av;(function(n){n[n.DontCare=1]="DontCare",n[n.Thin=2]="Thin",n[n.ExtraLight=3]="ExtraLight",n[n.Light=4]="Light",n[n.Normal=5]="Normal",n[n.Medium=6]="Medium",n[n.SemiBold=7]="SemiBold",n[n.Bold=8]="Bold",n[n.ExtraBold=9]="ExtraBold",n[n.Heavy=10]="Heavy"})(av||(av={}));var sv;(function(n){n[n.NoCaps=0]="NoCaps",n[n.SmallCaps=1]="SmallCaps",n[n.AllCaps=2]="AllCaps",n[n.AllPetiteCaps=3]="AllPetiteCaps",n[n.PetiteCaps=4]="PetiteCaps",n[n.Unicase=5]="Unicase",n[n.Titling=6]="Titling",n[n.Other=7]="Other"})(sv||(sv={}));var uv;(function(n){n[n.None=0]="None",n[n.Words=1]="Words",n[n.SingleLine=2]="SingleLine",n[n.DoubleLine=3]="DoubleLine",n[n.HeavyLine=4]="HeavyLine",n[n.DottedLine=5]="DottedLine",n[n.DottedHeavyLine=6]="DottedHeavyLine",n[n.DashLine=7]="DashLine",n[n.DashHeavyLine=8]="DashHeavyLine",n[n.DashLongLine=9]="DashLongLine",n[n.DashLongHeavyLine=10]="DashLongHeavyLine",n[n.DotDashLine=11]="DotDashLine",n[n.DotDashHeavyLine=12]="DotDashHeavyLine",n[n.DotDotDashLine=13]="DotDotDashLine",n[n.DotDotDashHeavyLine=14]="DotDotDashHeavyLine",n[n.WavyLine=15]="WavyLine",n[n.WavyHeavyLine=16]="WavyHeavyLine",n[n.WavyDoubleLine=17]="WavyDoubleLine"})(uv||(uv={}));var lv;(function(n){n[n.Left=0]="Left",n[n.Right=1]="Right",n[n.Center=2]="Center",n[n.Justified=3]="Justified",n[n.Other=4]="Other",n[n.None=5]="None",n[n.JustifyLow=6]="JustifyLow",n[n.Distributed=7]="Distributed",n[n.ThaiDistributed=8]="ThaiDistributed"})(lv||(lv={}));var cv;(function(n){n[n.Image=0]="Image",n[n.TextBox=1]="TextBox",n[n.Chart=2]="Chart",n[n.SmartArt=3]="SmartArt",n[n.Drawing=4]="Drawing",n[n.EquationObject=5]="EquationObject",n[n.Ink=6]="Ink",n[n.InkSpace=7]="InkSpace",n[n.InkEndOfLine=8]="InkEndOfLine",n[n.LineBreak=9]="LineBreak",n[n.PageBreak=10]="PageBreak",n[n.PageNumbers=11]="PageNumbers",n[n.FootnoteEndnote=12]="FootnoteEndnote",n[n.FootnoteEndnoteReferenceMark=13]="FootnoteEndnoteReferenceMark",n[n.Tab=14]="Tab",n[n.UnsupportedObject=15]="UnsupportedObject",n[n.Other=16]="Other",n[n.Person=17]="Person",n[n.Date=18]="Date"})(cv||(cv={}));var fv;(function(n){n[n.Initial=0]="Initial",n[n.FirstLine=1]="FirstLine",n[n.Hanging=2]="Hanging"})(fv||(fv={}));h();var xt=w(P()),Tt=w(R());var Mc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_RangeAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Mc.H_={T_:Mc.getTypeName(),B_:Mc.getBaseTypes()};var Ec=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_MultiTileRangeAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ec.H_={T_:Ec.getTypeName(),B_:Ec.getBaseTypes()};var Nc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageDetectionSummaryAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Nc.H_={T_:Nc.getTypeName(),B_:Nc.getBaseTypes()};var Dc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Dc.H_={T_:Dc.getTypeName(),B_:Dc.getBaseTypes()};var Pc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_LanguageCountAnnotationLocalized"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_LanguageCountAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Pc.H_={T_:Pc.getTypeName(),B_:Pc.getBaseTypes()};var Rc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_Definition"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Rc.H_={T_:Rc.getTypeName(),B_:Rc.getBaseTypes()};var Bc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_SuggestionsAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Bc.H_={T_:Bc.getTypeName(),B_:Bc.getBaseTypes()};var Wc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_Critique"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Wc.H_={T_:Wc.getTypeName(),B_:Wc.getBaseTypes()};var Oc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_NeuralRewriteCritique"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_Critique","AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Oc.H_={T_:Oc.getTypeName(),B_:Oc.getBaseTypes()};var Lc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_CritiqueCategoryCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Lc.H_={T_:Lc.getTypeName(),B_:Lc.getBaseTypes()};var ao=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_UniqueWordsCountAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ao.H_={T_:ao.getTypeName(),B_:ao.getBaseTypes()};var Fc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_EmptyDocumentAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Fc.H_={T_:Fc.getTypeName(),B_:Fc.getBaseTypes()};var qc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_IdeasPersonalizationSettingsAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();qc.H_={T_:qc.getTypeName(),B_:qc.getBaseTypes()};var $c=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_TextToSpeechAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();$c.H_={T_:$c.getTypeName(),B_:$c.getBaseTypes()};var Gc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_AutoreplaceAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_Critique","AugLoop_Text_SuggestionsAnnotation","AugLoop_Text_RangeAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Gc.H_={T_:Gc.getTypeName(),B_:Gc.getBaseTypes()};var Uc=function(){function n(r){(0,xt.default)(this,n),m.assign(n,this,r)}return(0,Tt.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Text_TextStreamAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_StreamAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Uc.H_={T_:Uc.getTypeName(),B_:Uc.getBaseTypes()};h();var Hc=w(P()),zc=w(R());var ur=function(){function n(r){(0,Hc.default)(this,n),m.assign(n,this,r)}return(0,zc.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TextTileDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ur.H_={T_:ur.getTypeName(),B_:ur.getBaseTypes()};var gn=function(){function n(r){(0,Hc.default)(this,n),m.assign(n,this,r)}return(0,zc.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_FormattedTextTileDelta"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTileDelta","AugLoop_Core_ItemDelta"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();gn.H_={T_:gn.getTypeName(),B_:gn.getBaseTypes()};h();var lr=w(P()),cr=w(R());var nt=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TextTile"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();nt.H_={T_:nt.getTypeName(),B_:nt.getBaseTypes()};var gt=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_FormattedTextTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();gt.H_={T_:gt.getTypeName(),B_:gt.getBaseTypes()};var Vc=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_InlineTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Vc.H_={T_:Vc.getTypeName(),B_:Vc.getBaseTypes()};var Qc=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_DynamicTextContext"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DynamicContext"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Qc.H_={T_:Qc.getTypeName(),B_:Qc.getBaseTypes()};var jc=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_TaskTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_FormattedTextTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();jc.H_={T_:jc.getTypeName(),B_:jc.getBaseTypes()};var Jc=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_PersonTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Jc.H_={T_:Jc.getTypeName(),B_:Jc.getBaseTypes()};var Kc=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_DateTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Kc.H_={T_:Kc.getTypeName(),B_:Kc.getBaseTypes()};var Yc=function(){function n(r){(0,lr.default)(this,n),m.assign(n,this,r)}return(0,cr.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Text_LinkTile"}},{key:"getBaseTypes",value:function(){return["AugLoop_Text_InlineTile","AugLoop_Text_TextTile"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Yc.H_={T_:Yc.getTypeName(),B_:Yc.getBaseTypes()};h();var dv=w(Se()),pv=w(P()),gv=w(R());var hv=function(){function n(){(0,pv.default)(this,n)}return(0,gv.default)(n,[{key:"accumulate",value:function(e,t,o,a){var s=this;if(o===0){a(t,o);return}var u=0,l=0,c=Oe.getTypeName(),f=we.getTypeName(),d=function(_){var M=m.getTypeNameFor(_);return M===c||M==f},p=Math.round(performance.now());p-=p%e.messageRateIntervalMs;var g=[];for(var k of t){var S=k.items.length===1&&d(k)&&!k.items[0].deltas,C=S?z([].concat((0,dv.default)(k.parentPath),[k.items[0].id])):void 0,x=!this.lastUpdatedItem||this.lastUpdatedItem.itemPathKey!==C;if(l+=k.items.length,S){var T=x||this.lastUpdatedItem.intervalStartTime!==p?1:this.lastUpdatedItem.currentRate+1;this.lastUpdatedItem={itemPathKey:C,intervalStartTime:p,currentRate:T},u++}if(!S||x){this.accumulatedUpdate&&(v.info(508368717,y.CoreDefault,`Pushing accumulated item before the timeout due the pattern change. Seq = ${this.accumulatedUpdate.seq}`),this.accumulatedUpdate.seq===o?g.push(this.accumulatedUpdate.operation):this.accumulatedUpdate.callback([this.accumulatedUpdate.operation],this.accumulatedUpdate.seq),clearTimeout(this.accumulatedUpdate.timeout),this.accumulatedUpdate=void 0),g.push(k);continue}this.accumulatedUpdate===void 0?this.lastUpdatedItem.currentRate>e.maxRate?(v.info(508368716,y.CoreDefault,`Message rate of ${e.maxRate} messages per ${e.messageRateIntervalMs}ms is exceeded - starting to accumulate the changes for single-tile update with seq = ${o}.`),this.accumulatedUpdate={callback:a,operation:k,seq:o,timeout:setTimeout(function(){s.accumulatedUpdate.callback([s.accumulatedUpdate.operation],s.accumulatedUpdate.seq),s.accumulatedUpdate=void 0},e.accumulationTimeoutMs)}):g.push(k):(v.info(508368715,y.CoreDefault,`An item from the message with seq = ${o} will be sent to item listeners with delay as it's currently being accumulated due to exceeded single-tile update max rate`),this.accumulatedUpdate.operation.items=k.items,this.accumulatedUpdate.seq=o,this.accumulatedUpdate.callback=a)}H("SingleItemUpdatesAccumulatorExtraLogging")&&v.info(508347408,y.CoreDefault,`operations.length: ${t.length}, singleTileOperations: ${u}, totalItemsCount: ${l}`),g.length&&a(g,o)}}])}();h();var Ef=w(dt()),Nf=w(P()),Df=w(R());h();var wa=w(Se()),Xc=w(P()),Zc=w(R());h();var yv=w(Ui()),kv=w(P()),wv=w(R());h();var mv=w(P()),vv=w(R()),ka=function(){function n(r,e){if((0,mv.default)(this,n),this.next=void 0,this.previous=void 0,e==null)throw Error("Argument id cannot be undefined or null.");this.item=r,this._id=e}return(0,vv.default)(n,[{key:"id",get:function(){return this._id}}])}();var Ws=function(){function n(r,e){if((0,kv.default)(this,n),this.fragmentsById=new Map,this.arrayOfFragmentHeads=[],this.checksEnabled=r||function(){return!0},Array.isArray(e))for(var t of e){var o=void 0;for(var a of t){var s=new ka(a.item,a.id);this.fragmentsById.set(s.id,s),o?(o.next=s,s.previous=o):this.arrayOfFragmentHeads.push(s),o=s}}}return(0,wv.default)(n,[{key:Symbol.iterator,value:function(){return this.makeIterator(!1)}},{key:"iterator",value:function(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return(0,yv.default)({},Symbol.iterator,function(){return e.makeIterator(t)})}},{key:"hasItems",value:function(){if(this.arrayOfFragmentHeads.length===0)return!1;for(var e of this.fragmentsById.values())if(e.item)return!0;return!1}},{key:"getItemsWithIds",value:function(){var e,t=new Array(this.arrayOfFragmentHeads.length),o=0;for(var a of this.arrayOfFragmentHeads){for(var s=[],u=a,l=a==null?void 0:a.next;u;)s.push({item:u.item,id:u.id}),u=u.next,l=(e=l==null?void 0:l.next)===null||e===void 0?void 0:e.next,u&&u===l&&(v.error(512231009,y.CoreDefault,"FragList getItemsWithIds Cycle Detected"),u=void 0);t[o++]=s}return t}},{key:"getFragmentHeadIds",value:function(e){var t=[];for(var o of this.arrayOfFragmentHeads)e(o.id,o.item)&&t.push(o.id);return t}},{key:"isFragmented",value:function(){return this.arrayOfFragmentHeads.length>1}},{key:"addItem",value:function(e,t,o,a,s){this.addItems([e],[t],o,a,s)}},{key:"addItems",value:function(e,t,o,a,s){if(v.verbose(573871326,y.CoreDefault,function(){return`FragList: Adding ${t.toString()}`}),e.length===0){o(Re.AddOfZeroElements,"");return}if(e.length!==t.length)throw Error("Length of object array doesn't match length of id array.");this.checksEnabled()&&this.checkForSequentialInversion(t,o);var u=this.createFragmentList(e,t);this.removeAlreadyExistingStubFragments(u),this.addFragmentsToMap(u),this.innerAddItems(u,a,s),this.checkState()}},{key:"deleteItem",value:function(e,t){v.verbose(573871327,y.CoreDefault,`FragList: Deleting ${e}`);var o=this.fragmentsById.get(e);return o===void 0?!1:(this.innerDeleteFragment(o),this.checkState(),!0)}},{key:"updateItem",value:function(e,t,o){v.verbose(573871328,y.CoreDefault,`FragList: Updating ${e}`);var a=this.fragmentsById.get(e);if(a===void 0)throw Error(`Item with id '${e!=null?e:"undefined"}' doesn't exist.`);a.item===void 0&&o(Re.UpdateOfStubbedItem,e),a.item=t,this.checkState()}},{key:"moveItem",value:function(e,t,o,a){v.verbose(573871329,y.CoreDefault,`FragList: Moving ${e}`);var s=this.fragmentsById.get(e);if(s===void 0){a(Re.MoveOfNonExistentItem,e);return}this.connectFragments(s.previous,s.next),this.innerAddItems([s],t,o),this.checkState()}},{key:"getItem",value:function(e){var t=this.fragmentsById.get(e);if(t)return t.item}},{key:"checkForSequentialInversion",value:function(e,t){var o=new Set(e);for(var a of e){o.delete(a);var s=this.fragmentsById.get(a);if(s){for(var u=s.previous;u;u=u.previous)if(o.has(u.id)){t(Re.SequentialyInvertedUpdate,u.id);return}}}}},{key:"checkState",value:function(){if(this.checksEnabled()){var e=[];for(var t of this.iterator(!1))t!=null&&e.push(t);var o=[];for(var a of this.fragmentsById.values())a.item!=null&&o.push(a.item);this.checkSizeOfArrayAndMapAreSame(e,o),this.checkArrayAndMapAreIdentical(e,o)}}},{key:"checkSizeOfArrayAndMapAreSame",value:function(e,t){return e.length!=t.length?(v.error(573871330,y.CoreDefault,`${e.length} items available, but ${t.length} items in the map`),!1):!0}},{key:"checkArrayAndMapAreIdentical",value:function(e,t){var o=!0;for(var a of t){var s=e.indexOf(a);s==-1?(v.error(573871331,y.CoreDefault,`Can't reach element ${a}`),o=!1):e.splice(s,1)}for(var u of e)v.error(573871360,y.CoreDefault,`Element: ${u} in the sorted array that isn't in the map.`),o=!1;return o}},{key:"innerAddItems",value:function(e,t,o){var a=this.getOrCreateFragment(t),s=this.getOrCreateFragment(o);a&&a.next&&this.disconnectFragments(a,a.next),s&&s.previous&&this.disconnectFragments(s.previous,s),this.connectFragments(a,e[0]),this.connectFragments(e[e.length-1],s)}},{key:"makeIterator",value:function(e){var t=this,o=-1,a=void 0,s=void 0;return{next:function(){for(var l;o<t.arrayOfFragmentHeads.length;){for(;a;){var c=a;if(a=a.next,s=(l=s==null?void 0:s.next)===null||l===void 0?void 0:l.next,c&&c===s&&(v.error(512231008,y.CoreDefault,"FragList Iterator Cycle Detected."),a=void 0),c.item||e)return{value:c.item,done:!1}}o++,a=o<t.arrayOfFragmentHeads.length?t.arrayOfFragmentHeads[o]:void 0,s=a}return{value:void 0,done:!0}}}}},{key:"innerDeleteFragment",value:function(e){this.fragmentsById.delete(e.id),this.removeFragmentFromHeadList(e),this.connectFragments(e.previous,e.next)}},{key:"removeFragmentFromHeadList",value:function(e){var t=this.arrayOfFragmentHeads.indexOf(e);t!=-1&&this.arrayOfFragmentHeads.splice(t,1)}},{key:"addFragmentsToMap",value:function(e){for(var t of e)this.fragmentsById.set(t.id,t)}},{key:"createFragmentList",value:function(e,t){var o=new Array(e.length);o[0]=new ka(e[0],t[0]);for(var a=1;a<e.length;a++)o[a]=new ka(e[a],t[a]),o[a-1].next=o[a],o[a].previous=o[a-1];return o}},{key:"removeAlreadyExistingStubFragments",value:function(e){for(var t of e){var o=this.fragmentsById.get(t.id);o&&(o.item!=null&&v.info(573871361,y.CoreDefault,`Already Existing Item: ${o.id}`),this.innerDeleteFragment(o))}}},{key:"getOrCreateFragment",value:function(e){if(e!=null){var t=this.fragmentsById.get(e);return t===void 0&&(t=new ka(void 0,e),this.fragmentsById.set(e,t)),t}}},{key:"connectFragments",value:function(e,t){if(e&&(e.next=t,e.previous==null)){var o=this.arrayOfFragmentHeads.indexOf(e);o===-1&&this.arrayOfFragmentHeads.push(e)}if(t)if(t.previous=e,e){var a=this.arrayOfFragmentHeads.indexOf(t);a!==-1&&this.arrayOfFragmentHeads.splice(a,1)}else this.arrayOfFragmentHeads.push(t)}},{key:"disconnectFragments",value:function(e,t){!e||!t||(e.next=void 0,t.previous=void 0,this.arrayOfFragmentHeads.push(t))}}])}();function H_(){return!1}var z_=function(){function n(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;(0,Xc.default)(this,n),this.id=r,this.parent=e}return(0,Zc.default)(n,[{key:"getPath",value:function(){for(var e=this,t=0;e!==null;)t+=1,e=e.parent;var o=new Array(t);for(e=this;t>0;)t-=1,o[t]=e.id,e=e.parent;return o}},{key:"getParentPath",value:function(){var e,t;return(t=(e=this.parent)===null||e===void 0?void 0:e.getPath())!==null&&t!==void 0?t:[]}}])}(),Sa=Symbol("path");function V_(){return this[Sa].getParentPath()}function Q_(n){Object.defineProperty(this,"parentPath",{value:n,writable:!0,configurable:!0,enumerable:!0})}function Sv(){var n={id:"#root#",parentPath:[]};return H("CompressItemPathsEnabled")&&(n[Sa]=null),n}function j_(n,r){var e=r.parentPath.length===0&&r.id==="#root#"?[]:[].concat((0,wa.default)(r.parentPath),[r.id]),t=n;return t.parentPath=e,t}function Vo(n,r){var e=r[Sa];return e!==void 0?(n[Sa]=new z_(n.id,e),Object.defineProperty(n,"parentPath",{get:V_,set:Q_,configurable:!0,enumerable:!0}),n):j_(n,r)}var Cv=function(){function n(r,e){(0,Xc.default)(this,n),this.itemWithPath=r.item,r.childNodes&&r.childNodes.length>0?this.childNodes=new Ws(e,r.childNodes.map(function(t){return t.map(function(o){return{id:o.id,item:o.item?new n(o.item,e):void 0}})})):H("LeavesHaveNoChildrenOptimizationEnabled")?this.checksEnabled=e:this.childNodes=new Ws(e)}return(0,Zc.default)(n,[{key:"itemWithPath",get:function(){return this.item},set:function(e){this.item=e}},{key:"serializableForm",value:function(){var e,t,o=(t=(e=this.childNodes)===null||e===void 0?void 0:e.getItemsWithIds())!==null&&t!==void 0?t:[];return{item:this.itemWithPath,childNodes:o.map(function(a){return a.map(function(s){return{id:s.id,item:s.item?s.item.serializableForm():void 0}})})}}},{key:"loggableForm",value:function(){var e,t,o=(t=(e=this.childNodes)===null||e===void 0?void 0:e.getItemsWithIds())!==null&&t!==void 0?t:[];return{id:this.item.id,type:m.getTypeNameFor(this.itemWithPath.body),childNodeIds:o.map(function(a){return a.map(function(s){return s.id})})}}},{key:"normalizeEmptyChildren",value:function(){this.ensureChildNodeList(),this.checksEnabled=void 0}},{key:"visitChildNodesSync",value:function(e){var t;for(var o of(t=this.childNodes)!==null&&t!==void 0?t:[])e(o)}},{key:"visitChildNodesWithFragListStubsSync",value:function(e){var t,o;for(var a of(o=(t=this.childNodes)===null||t===void 0?void 0:t.iterator(!0))!==null&&o!==void 0?o:[])e(a)}},{key:"visitAllLeafDescendantNodesSync",value:function(e){var t;for(var o of(t=this.childNodes)!==null&&t!==void 0?t:[])o.hasChildren()?o.visitAllLeafDescendantNodesSync(e):e(o)}},{key:"visitSubtree",value:function(e){var t;e(this);for(var o of(t=this.childNodes)!==null&&t!==void 0?t:[])o.visitSubtree(e)}},{key:"getNodeInSubtree",value:function(e,t,o){if(e.length===0)return this;o=o||{createInferredNodes:!1};for(var a=this,s=void 0,u=0;u<e.length;u++){var l=e[u];if(s=a.getChildNodeById(l),!s&&o.createInferredNodes&&(this.item[Sa]===void 0?s=t({id:l,parentPath:[].concat((0,wa.default)(this.getPath()),(0,wa.default)(e.slice(0,u)))}):s=t(Vo({id:l},a.item)),a.ensureChildNodeList(),a.childNodes.addItem(s,l,null)),!s)return;a=s}return s}},{key:"addChildItems",value:function(e,t,o,a,s){this.ensureChildNodeList(),this.childNodes.addItems(t,o,e,a,s)}},{key:"updateChildItem",value:function(e,t,o){this.ensureChildNodeList(),this.childNodes.updateItem(e,t,o)}},{key:"deleteChildItem",value:function(e,t){var o;(o=this.childNodes)===null||o===void 0||o.deleteItem(e,t)}},{key:"hasChildren",value:function(){var e,t;return(t=(e=this.childNodes)===null||e===void 0?void 0:e.hasItems())!==null&&t!==void 0?t:!1}},{key:"getChildNodeById",value:function(e){var t;return(t=this.childNodes)===null||t===void 0?void 0:t.getItem(e)}},{key:"getFragmentHeadIds",value:function(e){var t,o;return(o=(t=this.childNodes)===null||t===void 0?void 0:t.getFragmentHeadIds(e))!==null&&o!==void 0?o:[]}},{key:"ensureChildNodeList",value:function(){var e;this.childNodes===void 0&&(this.childNodes=new Ws((e=this.checksEnabled)!==null&&e!==void 0?e:H_))}},{key:"getPath",value:function(){return this.item.parentPath.length===0&&this.item.id==="#root#"?[]:[].concat((0,wa.default)(this.item.parentPath),[this.item.id])}}])}();h();var Ne=w(P()),De=w(R());var ef=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMetadata"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ef.H_={T_:ef.getTypeName(),B_:ef.getBaseTypes()};var so=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_Worksheet"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_TileGroup"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();so.H_={T_:so.getTypeName(),B_:so.getBaseTypes()};var tf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_WorksheetMetadata"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();tf.H_={T_:tf.getTypeName(),B_:tf.getBaseTypes()};var nf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRange"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();nf.H_={T_:nf.getTypeName(),B_:nf.getBaseTypes()};var rf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeWrapper"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();rf.H_={T_:rf.getTypeName(),B_:rf.getBaseTypes()};var of=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeWrapperAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();of.H_={T_:of.getTypeName(),B_:of.getBaseTypes()};var af=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_BaseExcelBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();af.H_={T_:af.getTypeName(),B_:af.getBaseTypes()};var sf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelBlock","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();sf.H_={T_:sf.getTypeName(),B_:sf.getBaseTypes()};var uf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelExtendedBlock"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelBlock","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();uf.H_={T_:uf.getTypeName(),B_:uf.getBaseTypes()};var lf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMergedCellInfo"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRange"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();lf.H_={T_:lf.getTypeName(),B_:lf.getBaseTypes()};var cf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();cf.H_={T_:cf.getTypeName(),B_:cf.getBaseTypes()};var ff=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_PathFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ff.H_={T_:ff.getTypeName(),B_:ff.getBaseTypes()};var df=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelGridSubtreeFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();df.H_={T_:df.getTypeName(),B_:df.getBaseTypes()};var pf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelRangeSampleFilter"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeFilter","AugLoop_Core_ItemFilter"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();pf.H_={T_:pf.getTypeName(),B_:pf.getBaseTypes()};var gf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelTableColumn"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();gf.H_={T_:gf.getTypeName(),B_:gf.getBaseTypes()};var hf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_BaseExcelTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();hf.H_={T_:hf.getTypeName(),B_:hf.getBaseTypes()};var mf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelTable","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();mf.H_={T_:mf.getTypeName(),B_:mf.getBaseTypes()};var vf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelPivotTable"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_BaseExcelTable","AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();vf.H_={T_:vf.getTypeName(),B_:vf.getBaseTypes()};var Ca=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelCell"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_GridCell"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ca.H_={T_:Ca.getTypeName(),B_:Ca.getBaseTypes()};var yf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelMergedCell"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapper"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();yf.H_={T_:yf.getTypeName(),B_:yf.getBaseTypes()};var kf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelRangeAddressNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRange"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();kf.H_={T_:kf.getTypeName(),B_:kf.getBaseTypes()};var wf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelRecognizedTableNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();wf.H_={T_:wf.getTypeName(),B_:wf.getBaseTypes()};var Sf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelDetectedTableBoundaryPartNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Sf.H_={T_:Sf.getTypeName(),B_:Sf.getBaseTypes()};var Cf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelDetectedTableBoundaryNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Excel_ExcelRangeWrapperAnnotation","AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Cf.H_={T_:Cf.getTypeName(),B_:Cf.getBaseTypes()};var xf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_ExcelTableAi_ExcelTableDataGridPartNew"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();xf.H_={T_:xf.getTypeName(),B_:xf.getBaseTypes()};var Tf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelComparisonAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Tf.H_={T_:Tf.getTypeName(),B_:Tf.getBaseTypes()};var If=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_ExcelComparisonItem"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();If.H_={T_:If.getTypeName(),B_:If.getBaseTypes()};var _f=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_EcsAccessInfo"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();_f.H_={T_:_f.getTypeName(),B_:_f.getBaseTypes()};var Af=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_DirtyRangeSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Af.H_={T_:Af.getTypeName(),B_:Af.getBaseTypes()};var bf=function(){function n(r){(0,Ne.default)(this,n),m.assign(n,this,r)}return(0,De.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Excel_DirtyDocumentSignalForClp"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_DirtyDocumentSignal","AugLoop_Core_DirtyAreaSignal","AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();bf.H_={T_:bf.getTypeName(),B_:bf.getBaseTypes()};h();var xv=w(P()),Tv=w(R()),Iv=function(){function n(){(0,xv.default)(this,n),this.string2internedString=new Map,this.hitCount=0}return(0,Tv.default)(n,[{key:"intern",value:function(e){var t=this.string2internedString.get(e);return t!==void 0?(this.hitCount+=1,t):(this.string2internedString.set(e,e),e)}},{key:"clear",value:function(){this.string2internedString.clear(),this.hitCount=0}},{key:"hits",get:function(){return this.hitCount}},{key:"size",get:function(){return this.string2internedString.size}},{key:"hitRate",value:function(){return this.hits/(this.hits+this.size)}}])}();h();var _v=w(Se());function Av(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:void 0,r=new Map,e=function(o){if(o==null){v.error(572837961,y.CoreDefault,"Attempt to call a generic function on undefined or null");return}var a=void 0;for(var s of[m.getTypeNameFor(o)].concat((0,_v.default)(m.getBaseTypesFor(o)),[void 0])){var u=r.get(s);if(u!==void 0){a=u;break}}if(a===void 0){v.error(572837962,y.CoreDefault,`Cannot find generic implementation for type ${m.getTypeNameFor(o)}`);return}for(var l=arguments.length,c=new Array(l>1?l-1:0),f=1;f<l;f++)c[f-1]=arguments[f];return a.apply(void 0,[o].concat(c))};return e.set=function(t,o){r.set(t,o)},e}h();var Os=w(dt()),bv=w(P()),Mv=w(R());var J_=new G("enableTreeLevelsByItemTypeCaching",!0),Mf=function(){function n(r,e){(0,bv.default)(this,n),this.levelsByTypeMap=e!=null?e:new Map,this._isEnabled=r!=null?r:J_.getValue()}return(0,Mv.default)(n,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"size",get:function(){return this.levelsByTypeMap.size}},{key:"add",value:function(e){this._isEnabled&&n.add(this.levelsByTypeMap,e)}},{key:"addNodes",value:function(e){if(this._isEnabled)for(var t of e)n.add(this.levelsByTypeMap,t.itemWithPath)}},{key:"addSubtree",value:function(e){var t=this;this._isEnabled&&e.visitSubtree(function(o){t.add(o.itemWithPath)})}},{key:"remove",value:function(e){var t,o;if(!(!this._isEnabled||!(!((t=e==null?void 0:e.body)===null||t===void 0)&&t.H_))){var a=e.parentPath.length;e.body.H_.T_&&this.removeType(e.body.H_.T_,a);for(var s of(o=e.body.H_.B_)!==null&&o!==void 0?o:[])this.removeType(s,a)}}},{key:"removeSubtree",value:function(e){var t=this;this._isEnabled&&e.visitSubtree(function(o){t.remove(o.itemWithPath)})}},{key:"update",value:function(e,t){if(this._isEnabled){var o=this.getAllTypesSet(e);if(!o){this.add(t);return}var a=this.getAllTypesSet(t);if(!a){this.remove(e);return}var s=t.parentPath.length;for(var u of o)a.has(u)||this.removeType(u,s);for(var l of a)o.has(l)||n.addType(this.levelsByTypeMap,l,s)}}},{key:"getLevels",value:function(e){return this.levelsByTypeMap.get(e)}},{key:"compare",value:function(e){var t,o=void 0;for(var a of e){var s=(0,Os.default)(a,2),u=s[0],l=s[1];if(!this.levelsByTypeMap.has(u)){o={itemType:u,expected:Array.from(l.entries()),actual:null};break}var c=this.levelsByTypeMap.get(u);for(var f of l){var d=(0,Os.default)(f,2),p=d[0],g=d[1],k=(t=c.get(p))!==null&&t!==void 0?t:0;if(k!=g){o={itemType:u,expected:Array.from(l.entries()),actual:Array.from(c.entries())};break}}}for(var S of this.levelsByTypeMap){var C=(0,Os.default)(S,2),x=C[0],T=C[1];if(o)break;if(!e.has(x)){for(var I of T.values())if(I>0){o={itemType:x,expected:null,actual:Array.from(T.entries())};break}}}return o}},{key:"removeType",value:function(e,t){var o=this.levelsByTypeMap.get(e);if(o){var a=o.get(t);o.set(t,a-1)}}},{key:"getAllTypesSet",value:function(e){var t,o,a;if(!((o=(t=e==null?void 0:e.body)===null||t===void 0?void 0:t.H_)===null||o===void 0)&&o.T_){var s=new Set;s.add(e.body.H_.T_);for(var u of(a=e.body.H_.B_)!==null&&a!==void 0?a:[])s.add(u);return s}}}],[{key:"add",value:function(e,t){var o,a;if(!((o=t==null?void 0:t.body)===null||o===void 0)&&o.H_){var s=t.parentPath.length;t.body.H_.T_&&n.addType(e,t.body.H_.T_,s);for(var u of(a=t.body.H_.B_)!==null&&a!==void 0?a:[])n.addType(e,u,s)}}},{key:"addType",value:function(e,t,o){var a,s=e.get(t);if(!s)s=new Map,s.set(o,1),e.set(t,s);else{var u=(a=s.get(o))!==null&&a!==void 0?a:0;s.set(o,u+1)}}}])}();var Ev=new G("modelLogMinDurationInMs",30),K_=new G("percentageOfGetSubtreeItemsLogs",5),Y_=["formulaR1C1Json","numberFormat","numberFormatCategory","fillColor","fontColor"],Pf=Av(function(n,r){});Pf.set(void 0,function(){});Pf.set(Ca.getTypeName(),function(n,r){if(r!==void 0)for(var e of Y_)n[e]!==void 0&&(n[e]=r.intern(n[e]))});var X_=function(){function n(r,e,t){(0,Nf.default)(this,n),this._itemIds=[],this._newNodes=[],this._lastPrevId=e,this._createNode=t,r?(this._addItem=this.addItemIfNotDuplicate,this._uniqueIds=new Set):this._addItem=this.addItem}return(0,Df.default)(n,[{key:"lastPrevId",get:function(){return this._lastPrevId}},{key:"itemIds",get:function(){return this._itemIds}},{key:"newNodes",get:function(){return this._newNodes}},{key:"addItemIfNeeded",value:function(e,t){this._addItem(e,t)}},{key:"reset",value:function(e){this._itemIds=[],this._newNodes=[],this._lastPrevId=e,this._uniqueIds&&(this._uniqueIds=new Set)}},{key:"addItem",value:function(e){this._itemIds.push(e.id);var t=this._createNode(e);this._newNodes.push(t)}},{key:"addItemIfNotDuplicate",value:function(e,t){if(this._uniqueIds.has(e.id))t(Re.AddOfItemsWithDuplicateIds,e.id);else{this._uniqueIds.add(e.id),this._itemIds.push(e.id);var o=this._createNode(e);this._newNodes.push(o)}}}])}(),uo=function(){function n(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1,e=arguments.length>1?arguments[1]:void 0,t=arguments.length>2?arguments[2]:void 0;(0,Nf.default)(this,n),this._firstSeenSchemaObjectTypes=new Map,this.cellLookup=new Map,this.shouldErrorCheck=function(){return!1},this.root=this.createNode(Sv()),this.root.itemWithPath.parentPath=[],this.nextAnnotationId=r,this.maxNodeCount=1,this.nodeCount=1,H("InternExcelCellProperties")&&(this.interner=new Iv),this.levelsByTypeCache=new Mf(e,t)}return(0,Df.default)(n,[{key:"firstSeenSchemaObjectTypes",get:function(){return this._firstSeenSchemaObjectTypes}},{key:"getNextAnnotationId",value:function(){return"#A"+this.nextAnnotationId++}},{key:"serializableForm",value:function(){return{nextAnnotationId:this.nextAnnotationId}}},{key:"serializeAllNodes",value:function(){var e=new Array(this.nodeCount),t=0;return this.root.visitSubtree(function(o){e[t++]=o.serializableForm()}),e}},{key:"addItems",value:function(e,t,o,a,s){var u=this,l,c;if(o.length!==0){if(H("PreventFragCyclesWithPrevAndNextIds")){var f=this.updatePrevAndNextIdsIfCycles(o,a,s);a=f.prevId,s=f.nextId}var d=this.shouldErrorCheck(),p=new X_(d,a,this.createNode.bind(this)),g=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!0}),k=g.itemWithPath;if(d){var S=o.map(function(_){return u.ensureItemId(_),_.id.toString()}).join(", ");v.info(527745699,y.CoreDefault,`Add items with ids: ${S}, parentItemId: ${k.id}, previousItemId: ${a}, nextItemId: ${s}.`)}for(var C of o){this.ensureItemId(C),C.body!=null&&(this.addCell(t,C),Pf(C.body,this.interner),this.reportSeenType(C.body));var x=Vo(C,k),T=g.getChildNodeById(x.id);if(T){!((l=T.itemWithPath)===null||l===void 0)&&l.body&&(!((c=x==null?void 0:x.id)===null||c===void 0)&&c.match(/R(\d+)C(\d+)/)||v.info(527745728,y.CoreDefault,`Already Existing Item: ${x.id}`));var I=T.itemWithPath;T.itemWithPath=x,this.levelsByTypeCache.update(I,x),p.newNodes.length>0&&(g.addChildItems(e,p.newNodes,p.itemIds,p.lastPrevId,C.id),this.levelsByTypeCache.addNodes(p.newNodes),p.reset(x.id))}else p.addItemIfNeeded(x,e)}p.newNodes.length>0&&(g.addChildItems(e,p.newNodes,p.itemIds,p.lastPrevId,s),this.levelsByTypeCache.addNodes(p.newNodes))}}},{key:"updateItems",value:function(e,t,o){if(o.length!==0){var a=Q().startSync(xn.UpdateModelItems),s=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!1});s||(e(Re.UpdateOfNonExistentItem,t[t.length-1]),s=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!0}));var u=s.itemWithPath;for(var l of o){if(!l.id){e(Re.UpdateOfNonExistentItem,void 0);continue}var c=Vo(l,u),f=s.getChildNodeById(c.id);if(!f){e(Re.UpdateOfNonExistentItem,c.id),f=this.createNode(c),s.addChildItems(e,[f],[c.id]),this.levelsByTypeCache.add(c);continue}var d=f.itemWithPath;f.itemWithPath=c,s.updateChildItem(l.id,f,e),this.levelsByTypeCache.update(d,c)}Q().stop(a)}}},{key:"deleteItems",value:function(e,t,o){if(o.length!==0){var a=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!1});if(!a){e(Re.DeleteOfNonExistingItem,t[t.length-1]);return}var s=a.itemWithPath;this.shouldErrorCheck()&&v.info(527745729,y.CoreDefault,`Delete items with ids: ${o.map(function(c){return c.id.toString()}).join(", ")}, parentItemId: ${s.id}`);for(var u of o){var l=a.getChildNodeById(u.id);if(!l){e(Re.DeleteOfNonExistingItem,u.id);continue}this.levelsByTypeCache.removeSubtree(l),a.deleteChildItem(u.id,e),this.deleteNode(l)}}}},{key:"moveItems",value:function(e,t,o,a,s,u){var l=this;if(a.length!==0){var c=this.root.getNodeInSubtree(t,this.createNode.bind(this),{createInferredNodes:!1});if(!c){e(Re.MoveOfNonExistentItem,t[t.length-1]);return}if(H("PreventFragCyclesWithPrevAndNextIds")){var f=this.updatePrevAndNextIdsIfCycles(a,s,u);s=f.prevId,u=f.nextId}var d=this.root.getNodeInSubtree(o,this.createNode.bind(this),{createInferredNodes:!0}),p=d.itemWithPath,g=[],k=[],S=function(){var T=c.getChildNodeById(C.id);if(!T)return e(Re.DeleteOfNonExistingItem,C.id),1;g.push(T),k.push(C.id),l.levelsByTypeCache.removeSubtree(T),T.itemWithPath=Vo(Object.assign({},T.itemWithPath),p);var I=function(M){M.visitChildNodesSync(function(b){b.itemWithPath=Vo(Object.assign({},b.itemWithPath),M.itemWithPath),I(b)})};I(T),l.levelsByTypeCache.addSubtree(T),c.deleteChildItem(C.id,e)};for(var C of a)S();d.addChildItems(e,g,k,s,u)}}},{key:"getItem",value:function(e){if(e.length===0)throw new Error("Invalid item path");var t=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(t)return t.itemWithPath}},{key:"hasItem",value:function(e){if(e.length===0)return!1;var t=this.root.getNodeInSubtree(e,this.createNode.bind(this));return!!t}},{key:"getCells1D",value:function(e,t,o,a,s){var u=[],l=this.cellLookup.get(e);if(!l)throw new Error(`Invalid worksheet ID ${e}`);var c=Lr.lowerIndexBound,f=l.length-1;t=Math.max(t,c),o=Math.min(o,f),a=Math.max(a,c);for(var d=t;d<=o;d++)if(Array.isArray(l[d]))for(var p=l[d].length-1,g=Math.min(s,p),k=a;k<=g;k++)l[d][k]&&u.push(l[d][k]);return u}},{key:"getSubtreeItems",value:function(e,t,o){var a=Q().startSync(xn.GetModelSubTreeItems);try{return!this.levelsByTypeCache.isEnabled||!Array.isArray(t)||t.length===0||t.some(function(s){return!s})?this.getSubtreeItemsFullSearch(e,t,o):this.getSubtreeItemsIndexed(e,t,o)}finally{Q().stop(a)}}},{key:"getItemChildren",value:function(e,t){var o=Q().startSync(xn.GetModelItemChildren);try{var a=[],s=this.root.getNodeInSubtree(e,this.createNode.bind(this));return s?(s.visitChildNodesSync(function(u){(!t||m.matchesTypesFor(u.itemWithPath.body,t))&&a.push(u.itemWithPath)}),a):void 0}finally{Q().stop(o)}}},{key:"visitItemPathSync",value:function(e,t){var o=this.root;for(var a of e){if(o=o.getNodeInSubtree([a],this.createNode.bind(this)),!o)throw new Error("Ancestor item not found");if(t(o.itemWithPath))return}}},{key:"getMaxItemCount",value:function(){return this.maxNodeCount}},{key:"analyzeTreeLevelsByItemTypeCacheErrors",value:function(){var e=this,t=new Map,o=new E({operationName:"AnalyzeTreeLevelsByItemTypeCacheConsistency",success:!0}).start(),a=function(c){Mf.add(t,c.itemWithPath),c.visitChildNodesSync(function(f){return a(f)})};this.root.visitChildNodesSync(function(l){return a(l)});var s=this.levelsByTypeCache.compare(t);o.success=!s,o.stop();var u=function(){return o.resultDescription=`maxItemCount: ${e.maxNodeCount.toString()}. diff: ${JSON.stringify(s)}`,o};return o.success===!1||o.durationMs>Ev.getValue()?v.info(528589721,y.CoreDefault,u):v.debug(528589722,y.CoreDefault,u),o.success}},{key:"setShouldErrorCheck",value:function(e){this.shouldErrorCheck=e}},{key:"getSubtreeItemsFullSearch",value:function(e,t,o){var a=this,s;Array.isArray(t)&&o?s=function(k){return o(k)&&m.matchesTypesFor(k.body,t)}:Array.isArray(t)&&!o?s=function(k){return m.matchesTypesFor(k.body,t)}:s=t||function(){return!0};var u=new E({operationName:"getSubtreeItemsFullSearch",success:!0}).start(),l=[],c=0,f=function(k){c++,s(k.itemWithPath)&&l.push(k.itemWithPath),k.visitChildNodesSync(function(S){return f(S)})};if(e.length===0)this.root.visitChildNodesSync(function(g){return f(g)});else{var d=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(!d)throw new Error(`Failed to get item for path ${z(e)} in model`);f(d)}u.stop();var p=function(){return u.resultDescription=`maxItemCount= ${a.maxNodeCount.toString()}. subtreeSize=${c}. results=${l.length}.`,u};return n.shouldLogGetSubtreeItemsMetric(u)?v.info(529056927,y.CoreDefault,p):v.debug(529056928,y.CoreDefault,p),l}},{key:"getSubtreeItemsIndexed",value:function(e,t,o){var a=this,s=new E({operationName:"getSubtreeItemsIndexed",success:!0}).start(),u=this.calculateItemTypesByLevelAndMaxLevel(t),l=(0,Ef.default)(u,2),c=l[0],f=l[1];if(c.size===0)return[];var d;o?d=function(T,I){return o(T)&&m.matchesTypesFor(T.body,I)}:d=function(T,I){return m.matchesTypesFor(T.body,I)};var p=[],g=0,k=function(T,I,_){g++,_&&d(T.itemWithPath,_)&&p.push(T.itemWithPath),I<f&&T.visitChildNodesSync(function(M){return k(M,I+1,c.get(I+1))})};if(e.length===0)this.root.visitChildNodesSync(function(x){return k(x,0,c.get(0))});else{var S=this.root.getNodeInSubtree(e,this.createNode.bind(this));if(!S)throw new Error(`Failed to get item for path ${z(e)} in model`);k(S,e.length-1,c.get(e.length-1))}s.stop();var C=function(){var T={maxInputCount:a.maxNodeCount,visitedNodesCount:g,resultsCount:p.length,cacheSize:a.levelsByTypeCache.size,itemTypes:t.join(", ")};return s.resultDescription=JSON.stringify(T),s};return n.shouldLogGetSubtreeItemsMetric(s)?v.info(572837889,y.CoreDefault,C):v.debug(572837890,y.CoreDefault,C),p}},{key:"calculateItemTypesByLevelAndMaxLevel",value:function(e){var t=this,o=new Map,a=-1,s=function(c){var f=t.levelsByTypeCache.getLevels(c);if(f)for(var d of f){var p=(0,Ef.default)(d,2),g=p[0],k=p[1];if(!(k<=0)){var S=o.get(g);S||(S=[],o.set(g,S),a<g&&(a=g)),S.push(c)}}};for(var u of e)s(u);return[o,a]}},{key:"createNode",value:function(e){ev(e.id)||v.warn(572837893,y.CoreDefault,`ItemId ${e.id} does not meet length/charset requirements`);var t=new Cv({item:e,childNodes:[]},this.shouldErrorCheck);return this.nodeCount++,this.nodeCount>this.maxNodeCount&&(this.maxNodeCount=this.nodeCount),t}},{key:"deleteNode",value:function(e){e&&e.hasChildren()&&v.error(572837894,y.CoreDefault,"Destroying node which has children. This can result in orphaned children in our map of all nodes."),this.nodeCount--,this.nodeCount<0&&v.error(572837895,y.CoreDefault,"Model is in inconsistent state, total nodes count is less than zero.")}},{key:"addCell",value:function(e,t){if(m.matchesTypesFor(t.body,[Mn.getTypeName()])){var o=t.body,a=this.cellLookup.get(e[e.length-1]);a||(a=[]),Array.isArray(a[o.row])||(a[o.row]=[]),a[o.row][o.column]=t,this.cellLookup.set(e[e.length-1],a)}}},{key:"reportSeenType",value:function(e){var t;for(var o of m.getAllTypesFor(e)){var a=this._firstSeenSchemaObjectTypes.get(o);a||(t||(t=Date.now()),this._firstSeenSchemaObjectTypes.set(o,t))}}},{key:"ensureItemId",value:function(e){e.id||(e.id=Zt(),v.info(527745730,y.CoreDefault,`Assigning ${e.id} to child item provided without an id`))}},{key:"updatePrevAndNextIdsIfCycles",value:function(e,t,o){for(var a of e)if(a.id===t||a.id===o)return v.info(512233806,y.CoreDefault,`Incoming operation with prevId or nextId the same as the item.id: ${a.id}`),{prevId:void 0,nextId:void 0};return{prevId:t,nextId:o}}}],[{key:"fromSerializableForm",value:function(e){return new n(e.nextAnnotationId)}},{key:"shouldLogGetSubtreeItemsMetric",value:function(e){return H("LogPercOfGetSubtreeItems")?100*Math.random()<=K_.getValue():e.durationMs>Ev.getValue()}}])}();h();var xa=new G("moveOperationEnabled",!1);function Z_(n,r,e){return r=(0,Rf.default)(r),(0,Rv.default)(n,Wv()?Reflect.construct(r,e||[],(0,Rf.default)(n).constructor):r.apply(n,e))}function Wv(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Wv=function(){return!!n})()}var Nv=new G("hotCacheLogMinDurationInMs",30),eA=new G("singleItemUpdatesAccumulatorSettings",{"Outlook-Win32":{enabled:!0,accumulationTimeoutMs:2e3,messageRateIntervalMs:1e3,maxRate:4}}),Lv=function(n){function r(e,t,o){var a;return(0,Dv.default)(this,r),a=Z_(this,r),a.itemListeners=new Rs,a.stats={maxItemCount:0,firstSeenSchemaObjectTypes:new Map,documentUrlAvailable:!1,documentUrlWasProvided:!1},a.deltaHandlers=new Map,a.consistencyErrorLogger=e,a.model=t||new uo,a.model.setShouldErrorCheck(function(){return!1}),a.itemUpdatesAccumulator=o!=null?o:new hv,H("checkIfDocumentUrlWasProvided")&&a.setupDocumentUrlChecker(),a}return(0,Bv.default)(r,n),(0,Pv.default)(r,[{key:"getSerializedCache",value:function(){return{allNodes:this.model.serializeAllNodes()}}},{key:"applyOperations",value:function(t,o){var a=this,s=Q(),u=s.startSync(xn.ApplyOperations),l=0,c=0,f=!1,d=t.length,p=new E({operationName:"HotCacheApplyOperations",success:!0},{metricDuration:!0}).start(),g=[],k=[],S=function(_){var M=m.getTypeNameFor(_),b=function(U,K){if(a.consistencyErrorLogger.logModelOperationError(M,_,U,K),H("mastermindSendOpErrors")){var Z=(0,lt.default)(_.parentPath);K&&Z.push(K),k.push({path:Z,errorCode:U})}};if(a.model.shouldErrorCheck()){var A=function(){var U=4e3,K=100,Z=_.items.length>K,ye=Z?_.items.slice(0,K):_.items,he=ye.map(function(on){return on.id}).join(", "),ke=he.length>U,Ae=ke?he.substring(0,U):he;return`Applying ${M} to hot cache haveWeOmittedSomeIds=${Z}; haveWeShortenedLogString=${ke}; ids: ${Ae}`};v.info(572837901,y.CoreDefault,A)}var N=M===He.getTypeName();if(N){f=!0;var F=a.generateDeepDeleteOperations(_,b);s.stop(u);for(var q of F)a.triggerNotifications([q],o),l++;s.resume(u);for(var J of F)a.updateModel(J,o,b),c++}else if(M===At.getTypeName()){var Y=a.handleDeltaUpdate(b,_);Y&&(a.updateModel(Y,o,b),c++,g.push(Y))}else{if(M===mn.getTypeName()){var fe=_;if(Zm(fe.parentPath,fe.prevParentPath)&&!fe.nextId&&!fe.prevId)return fe.items.forEach(function($){return b(Re.MoveToTheSamePath,$.id)}),0;if(xa.getValue())return g.push(_),a.generateSubtreeMoveOperations(fe).forEach(function($){a.emit("beforeItemChange",$),g.push($)}),a.updateModel(_,o,b),c++,0;var W=a.generateAddOperationsForNewPath(fe),B=a.generateDeepDeleteOperations(new He({items:_.items,parentPath:fe.prevParentPath}),b);s.stop(u);for(var L of B)a.triggerNotifications([L],o),l++;s.resume(u);for(var O of B)a.updateModel(O,o,b);for(var D of W)a.updateModel(D,o,b),g.push(D);return 0}a.updateModel(_,o,b),c++,M!==Io.getTypeName()&&M!==_o.getTypeName()&&g.push(_)}},C;for(var x of t)C=S(x);s.stop(u),g.length>0&&(this.triggerNotifications(g,o),l++),p.stop();var T=function(){return p.resultDescription=`{"triggerNotificationsCallCount":${l},"updateModelCallCount":${c},"hadDeleteOps":${f},"numberOfOps":${d}}`,p};return p.durationMs>Nv.getValue()?v.info(572837902,y.CoreDefault,T):v.debug(572837903,y.CoreDefault,T),k}},{key:"getItem",value:function(t){var o=this.model.getItem(t);if(!o)throw new io(`Failed to get item for path ${z(t)} in hot cache`);return o}},{key:"hasItem",value:function(t){return this.model.hasItem(t)}},{key:"tryGetItem",value:function(t){return this.model.getItem(t)}},{key:"getItemChildren",value:function(t,o){var a=this.model.getItemChildren(t,o);if(!Array.isArray(a))throw new io(`Path not found ${z(t)}`);return a}},{key:"getSubtreeItems",value:function(t,o,a){return this.model.getSubtreeItems(t,o,a)}},{key:"getFirstAncestorOfType",value:function(t,o){for(var a=t.slice(0),s=!0;a.length>0;){var u=this.model.getItem(a);if(u){if(m.matchesTypesFor(u.body,o))return at(a.slice(0,-1),u)}else if(!s)throw new Error(`Failed to get ancestor of type(s) [${o.join(",")}] on path ${z(a)} (bad path)`);s=!1,a.pop()}}},{key:"tryGetFirstAncestorOfType",value:function(t,o){try{return this.getFirstAncestorOfType(t,o)}catch(a){}}},{key:"onItemChange",value:function(t,o,a,s){this.itemListeners.onItemChange(t,o,a,s)}},{key:"getCells1D",value:function(t,o,a,s,u){return this.model.getCells1D(t,o,a,s,u)}},{key:"getAnnotation",value:function(t){try{return this.model.getItem(t).body}catch(o){v.error(572837904,y.CoreDefault,`Could not find annotation given path: ${t}`);return}}},{key:"getStats",value:function(){return this.stats.firstSeenSchemaObjectTypes=this.model.firstSeenSchemaObjectTypes,this.stats.documentUrlAvailable=H("CheckIfDocumentUrlIsAvailable")?this.isDocumentUrlAvailable():!1,this.stats}},{key:"registerItemDeltaHandler",value:function(t,o){this.deltaHandlers.set(t,o)}},{key:"getNextAnnotationId",value:function(){return this.model.getNextAnnotationId()}},{key:"dispose",value:function(){}},{key:"updateAnnotationMetadata",value:function(t,o){var a=[];for(var s of o.items){var u=this.model.getItem(o.parentPath.concat([s.id]));if(!u||!u.body)t(Re.UpdateOfStubbedItem,s.id);else if(!m.matchesTypesFor(u.body,[_t.getTypeName()]))t(Re.UpdateMetaDataOfNonAnnotationType,s.id);else{var l=u.body;l.M_=Object.assign(Object.assign({},l.M_),o.M_),a.push(u)}}o.items=a,this.model.updateItems(t,o.parentPath,a)}},{key:"handleDeltaUpdate",value:function(t,o){var a=this.model.getItem(o.parentPath);if(!a){H("deltaConsistencyErrors")&&o.items&&o.items.length>0?t(Re.DeltaOfNonExistingItem,o.items[0].id):v.error(572837908,y.CoreDefault,`Failed to find parent item for delta op, ID: ${o.parentPath}`);return}var s=o.parentPath.slice(0,-1),u=o.items&&o.items.length>1?o.items.sort(function(k,S){return[me.Add,me.Update,me.Delete].includes(k.body.deltaType)?-1:1}):o.items,l=[],c=ut(),f=c.clientMetadata;for(var d of u)try{var p=this.deltaHandlers.get(m.getTypeNameFor(d.body));if(p){v.info(572837909,y.CoreDefault,`Executing delta handler for item type ${m.getTypeNameFor(a.body)}, and ID: ${a.id}`);var g=p(d.body,a.body,f==null?void 0:f.flights);l.push(d.body),g?a={id:a.id,revId:d.revId,body:g,parentPath:s,delta:l[0],deltas:l,contextId:d.contextId,sourceTimestamp:d.sourceTimestamp}:v.info(572837910,y.CoreDefault,`Failed to apply delta of type: ${m.getTypeNameFor(d.body)} on item ${a.id}`)}else v.warn(572837911,y.CoreDefault,`Received a delta operation with no registered handler, delta type: ${m.getTypeNameFor(d.body)}`)}catch(k){v.error(572837912,y.CoreDefault,`Failed to apply delta, error: ${k}`)}if(u.length>0)return new Oe({parentPath:s,items:[a]})}},{key:"updateModel",value:function(t,o,a){var s;this.emit("beforeItemChange",t);var u=m.getTypeNameFor(t);if(v.debug(572837905,y.CoreDefault,function(){var g,k;return`Updating model for ${u} under parent path [${t.parentPath}] (${(g=t.items)===null||g===void 0?void 0:g.length} item(s), first item id: ${((k=t.items)===null||k===void 0?void 0:k.length)>0?t.items[0].id:"(no items)"})`}),u===we.getTypeName()){var l=t;this.model.addItems(a,l.parentPath,l.items,l.prevId,l.nextId)}else if(u===Oe.getTypeName())this.model.updateItems(a,t.parentPath,t.items);else if(u===He.getTypeName())this.model.deleteItems(a,t.parentPath,t.items);else if(u===mt.getTypeName())this.updateAnnotationMetadata(a,t);else if(!(u===Cn.getTypeName()||u===it.getTypeName()))if(u===_o.getTypeName()){var c=t;c.parentPath&&((s=c.types)===null||s===void 0?void 0:s.length)>0?this.purgeModelByTypes(c.parentPath,c.types):v.error(507253403,y.CoreDefault,"invalid arguments for purge by types operation")}else if(u==Io.getTypeName()){var f=t;if(f.parentPath&&t.items&&f.typesToKeep){var d=t;this.purgeModelExceptTypes(d.parentPath,d.items,d.typesToKeep)}else v.error(506853457,y.CoreDefault,"invalid arguments for purge subtree except types operation")}else if(xa.getValue()&&u==mn.getTypeName()){var p=t;this.model.moveItems(a,p.prevParentPath,p.parentPath,p.items,p.prevId,p.nextId)}else H("errorUnknownOperation")&&a(Re.UnknownOperation,void 0),v.warn(572837914,y.CoreDefault,`Unsupported operation type ${u}`);this.stats.maxItemCount=this.model.getMaxItemCount()}},{key:"purgeModelExceptTypes",value:function(t,o,a){var s=this;v.info(506853340,y.CoreDefault,`purging the model subtree keeping types ${JSON.stringify(a)}`);var u=function(){var f=[].concat((0,lt.default)(t),[l.id]),d=s.model.getItemChildren(f);if((d==null?void 0:d.length)>0){var p=d.map(function(k){return s.model.getItem([].concat((0,lt.default)(f),[k.id]))}),g=(a==null?void 0:a.length)>0?p.filter(function(k){return!m.matchesTypesFor(k.body,a)}):p;s.purgeModel(f,g)}};for(var l of o)u()}},{key:"purgeModel",value:function(t,o){var a=this;v.info(526403014,y.CoreDefault,"purging the model"),this.emit("purgeModel",o.map(function(c){return[].concat((0,lt.default)(t),[c.id])}));var s=this.model;this.model=new uo;var u=new Set(o.map(function(c){return c.id})),l=function(f){var d=s.getItemChildren(f),p=new Set(d);if(d&&d.length>0){if(f.length===t.length&&f.every(function(S,C){return t[C]===S}))for(var g=0;g<d.length;g++)u.has(d[g].id)&&(v.info(526403015,y.CoreDefault,"PurgeModel: reached the purgable node. Will not unpurge."),p.delete(d[g]));a.updateModel(new we({parentPath:f,items:(0,lt.default)(p)}),0,function(){});for(var k of p)l([].concat((0,lt.default)(f),[k.id]))}};l([])}},{key:"purgeModelByTypes",value:function(t,o){var a=this;v.info(507253402,y.CoreDefault,"purgeModelByTypes: purging the model by types: ",o.join(", "));var s=this.model;this.model=new uo;var u=[],l=function(f){var d=s.getItemChildren(f),p=new Set(d);if(d&&d.length>0){if(f.length>=t.length&&t.every(function(S,C){return f[C]===S}))for(var g=0;g<d.length;g++)m.matchesTypesFor(d[g].body,o)&&(u.push([].concat((0,lt.default)(f),[d[g].id])),p.delete(d[g]));a.updateModel(new we({parentPath:f,items:(0,lt.default)(p)}),0,function(){});for(var k of p)l([].concat((0,lt.default)(f),[k.id]))}};l([]),this.emit("purgeModel",u,o,t),v.info(507253401,y.CoreDefault,`purgeModelByTypes: purged ${u.length}. items`)}},{key:"triggerNotifications",value:function(t,o){var a=this,s,u,l,c,f=new E({operationName:"HotCacheTriggerNotifications",success:!0}).start(),d=ut(),p=`${(u=(s=d.clientMetadata)===null||s===void 0?void 0:s.appName)!==null&&u!==void 0?u:""}-${(c=(l=d.clientMetadata)===null||l===void 0?void 0:l.appPlatform)!==null&&c!==void 0?c:""}`,g=eA.getValue()[p];g&&g.enabled?this.itemUpdatesAccumulator.accumulate(g,t,o,function(S,C){a.itemListeners.emitEvents(S,C)}):this.itemListeners.emitEvents(t,o),f.stop();var k=function(){return f.resultDescription=`maxItemCount= ${a.stats.maxItemCount.toString()}. ops.length=${t.length}.`,f};f.durationMs>Nv.getValue()?v.info(572837958,y.CoreDefault,k):v.debug(572837959,y.CoreDefault,k)}},{key:"generateDeepDeleteOperations",value:function(t,o){var a=this,s=[],u=function(f){var d=a.model.getItemChildren(f);d&&d.length>0&&(s.push(new He({parentPath:f,items:d})),d.forEach(function(p){u([].concat((0,lt.default)(f),[p.id]))}))},l=function(f){var d=a.model.getItem(f);d?(s.push(new He({parentPath:f.slice(0,-1),items:[d]})),u(f)):o(Re.DeleteOfNonExistingItem,f[f.length-1])};return t.items.forEach(function(c){l([].concat((0,lt.default)(t.parentPath),[c.id]))}),s.reverse(),s}},{key:"isDocumentUrlAvailable",value:function(){var t=this.model.getSubtreeItems([],[bt.getTypeName()]);if(!t||t.length===0)return!1;var o=t[0].body;return!!o.url}},{key:"generateSubtreeMoveOperations",value:function(t){for(var o=this,a=[],s=function(g,k){var S=o.model.getItemChildren(k);if(S!=null&&S.length){a.push(new mn({parentPath:g,prevParentPath:k,items:S}));for(var C of S)s([].concat((0,lt.default)(g),[C.id]),[].concat((0,lt.default)(k),[C.id]))}},u=0;u<t.items.length;u++){var l=t.items[u],c=[].concat((0,lt.default)(t.parentPath),[l.id]),f=[].concat((0,lt.default)(t.prevParentPath),[l.id]),d=this.model.getItem(f);t.items[u]=Object.assign({},d),s(c,f)}return a}},{key:"generateAddOperationsForNewPath",value:function(t){var o=this,a=[],s=function(g,k){var S=o.model.getItemChildren(k);if(S!=null&&S.length){a.push(new we({parentPath:g,items:S}));for(var C of S)s([].concat((0,lt.default)(g),[C.id]),[].concat((0,lt.default)(k),[C.id]))}},u=new we({parentPath:t.parentPath,items:[]});a.push(u);for(var l=0;l<t.items.length;l++){var c=[].concat((0,lt.default)(t.parentPath),[t.items[l].id]),f=[].concat((0,lt.default)(t.prevParentPath),[t.items[l].id]),d=this.model.getItem(f);d&&(u.items.push(Object.assign({},d)),s(c,f))}return a}},{key:"setupDocumentUrlChecker",value:function(){var t=this;this.onItemChange(bt.getTypeName(),zt.All,function(o){if(!t.stats.documentUrlWasProvided)for(var a of o)for(var s of a.items){var u=s.body;if(u!=null&&u.url){t.stats.documentUrlWasProvided=!0;return}}})}}])}(Ov.EventEmitter);h();var ny=w(P()),ry=w(R());h();h();var Fv=w(P()),qv=w(R()),Bf=function(){function n(r){(0,Fv.default)(this,n),this.containedAnalyzers=r}return(0,qv.default)(n,[{key:"appliedOperationNotification",value:function(){for(var e of this.containedAnalyzers)e.appliedOperationNotification()}},{key:"scheduleAnalysis",value:function(){for(var e of this.containedAnalyzers)e.scheduleAnalysis()}},{key:"stop",value:function(){for(var e of this.containedAnalyzers)e.stop()}}])}();h();var Jv=w(P()),Kv=w(R()),Yv=w(Qe()),Ff=w($e()),Xv=w(je());h();var zv=w(P()),Vv=w(R()),Lf=w(Hv()),nn;(function(n){n[n.Idle=0]="Idle",n[n.Pending=1]="Pending",n[n.Running=2]="Running",n[n.Stopped=3]="Stopped"})(nn||(nn={}));var Qv=function(){function n(r){(0,zv.default)(this,n),this.state=nn.Idle,this.hadNewAppliedOperations=!1,this.analysisTimeoutRelaxed=!1,this.args=r,this.debouncedAnalysis=(0,Lf.default)(this.analysisToDebounce.bind(this),this.args.normalSessionsDebounceTimeInMs)}return(0,Vv.default)(n,[{key:"finishedAnalysisAndInQuietState",get:function(){return this.state===nn.Idle}},{key:"appliedOperationNotification",value:function(){this.hadNewAppliedOperations=!0}},{key:"stop",value:function(){this.state=nn.Stopped,this.debouncedAnalysis.cancel();var e=function(){};e.cancel=function(){},this.debouncedAnalysis=e}},{key:"scheduleAnalysis",value:function(){this.state===nn.Idle&&(this.state=nn.Pending),this.debouncedAnalysis()}},{key:"analysisToDebounce",value:function(){var e=this;if(!(this.state!==nn.Pending||!this.canPerformAnalysis())){if(!this.hadNewAppliedOperations){this.state=nn.Idle;return}this.state=nn.Running,this.hadNewAppliedOperations=!1,this.performAnalysis(function(){return e.hadNewAppliedOperations},function(t){e.hadNewAppliedOperations&&setTimeout(function(){return e.scheduleAnalysis()},0),t&&(e.args.allowAnalysisOfLargeSessions()?e.analysisTimeoutRelaxed||(e.analysisTimeoutRelaxed=!0,e.debouncedAnalysis.cancel(),e.debouncedAnalysis=(0,Lf.default)(e.analysisToDebounce.bind(e),e.args.tooLargeSessionsDebounceTimeInMs),setTimeout(function(){return e.scheduleAnalysis()},0)):e.state=nn.Stopped),e.state===nn.Running&&(e.state=nn.Idle)})}}}])}();function yA(n,r,e){return r=(0,Ff.default)(r),(0,Yv.default)(n,Zv()?Reflect.construct(r,e||[],(0,Ff.default)(n).constructor):r.apply(n,e))}function Zv(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Zv=function(){return!!n})()}var kA=5e4,wA=3e5,SA=new G("treeLevelsByItemTypeCacheAnalysisEnabled",!1),jv=new G("treeLevelsByItemTypeCacheAnalysisOfLargeSessions",!1),CA=new G("treeLevelsByItemTypeCacheLargeSessionThreshold",1e3),ey=function(n){function r(e){var t;return(0,Jv.default)(this,r),t=yA(this,r,[{allowAnalysisOfLargeSessions:function(){return jv.getValue()},normalSessionsDebounceTimeInMs:kA,tooLargeSessionsDebounceTimeInMs:wA}]),t.stopAnlysis=!1,t.fetchInMemoryModel=e,t}return(0,Xv.default)(r,n),(0,Kv.default)(r,[{key:"canPerformAnalysis",value:function(){return SA.getValue()&&!this.stopAnlysis}},{key:"performAnalysis",value:function(t,o){var a=this.fetchInMemoryModel();if(a){if(a.getMaxItemCount()>CA.getValue()&&!jv.getValue()){this.stopAnlysis=!0,o(!0);return}var s=a.analyzeTreeLevelsByItemTypeCacheErrors();this.stopAnlysis=!s,o(!1)}}}])}(Qv);var xA=new G("percentageOfSessionsForTreeLevelsCacheAnalysis",10),TA=new G("enableTreeLevelsByItemTypeCaching",!0),IA=new G("treeLevelsByItemTypeCacheAnalysisEnabled",!1),ty=function(r){if(IA.getValue()&&TA.getValue()&&100*Math.random()<=xA.getValue()){var e=new ey(r);return new Bf([e])}return new Bf([])};var oy=function(){function n(r){var e=this;(0,ny.default)(this,n),this.isShuttingDown=!1,this.quietStateAnalyzer=ty(function(){return e.hotCache.model}),this.hotCache=r()}return(0,ry.default)(n,[{key:"on",value:function(e,t){this.hotCache.on(e,t)}},{key:"applyOperations",value:function(e,t){if(this.isShuttingDown)throw new Error("Shutdown is in process, no further messages will be applied.");this.quietStateAnalyzer.appliedOperationNotification();var o=this.hotCache.applyOperations(e,t);return this.quietStateAnalyzer.scheduleAnalysis(),o}},{key:"getItem",value:function(e){return this.hotCache.getItem(e)}},{key:"hasItem",value:function(e){return this.hotCache.hasItem(e)}},{key:"tryGetItem",value:function(e){return this.hotCache.tryGetItem(e)}},{key:"getItemChildren",value:function(e,t){return this.hotCache.getItemChildren(e,t)}},{key:"onItemChange",value:function(e,t,o,a){this.hotCache.onItemChange(e,t,o,a)}},{key:"getSubtreeItems",value:function(e,t,o){return this.hotCache.getSubtreeItems(e,t,o)}},{key:"getFirstAncestorOfType",value:function(e,t){return this.hotCache.getFirstAncestorOfType(e,t)}},{key:"tryGetFirstAncestorOfType",value:function(e,t){return this.hotCache.tryGetFirstAncestorOfType(e,t)}},{key:"getAnnotation",value:function(e){return this.hotCache.getAnnotation(e)}},{key:"getCells1D",value:function(e,t,o,a,s){return this.hotCache.getCells1D(e,t,o,a,s)}},{key:"getStats",value:function(){return this.hotCache.getStats()}},{key:"getSerializedCache",value:function(){return this.hotCache.getSerializedCache()}},{key:"getNextAnnotationId",value:function(){return this.hotCache.getNextAnnotationId()}},{key:"registerItemDeltaHandler",value:function(e,t){this.hotCache.registerItemDeltaHandler(e,t)}},{key:"dispose",value:function(){this.hotCache.dispose(),this.isShuttingDown=!0,this.quietStateAnalyzer.stop()}}])}();h();var iy=w(Se()),ay=w(P()),sy=w(R());var qf=function(){function n(){(0,ay.default)(this,n),this.stats={warnings:0,errors:0,quietStateAnalysisDataCorrect:!1,lastRunWarnings:void 0,lastRunErrors:void 0}}return(0,sy.default)(n,[{key:"getStats",value:function(){return this.stats}},{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"logModelOperationError",value:function(e,t,o,a){var s=n.shouldLogConsistencyErrorAsInfoTemporarily(o),u;s?(this.stats.warnings++,u="SyncOperationWarning"):(this.stats.errors++,u="SyncOperationError"),v.info(508650700,y.CoreDefault,new Le({sessionHealthEventName:u,source:Ie.Core,reason:de.Client,impact:_e.MissingInput,success:!1,message:`${e} for item ${z([].concat((0,iy.default)(t.parentPath),[a]))} has operation error ${Re[o]}`,dimension0:Re[o],subReason:Re[o]},this.clientMetadata))}}],[{key:"shouldLogConsistencyErrorAsInfoTemporarily",value:function(e){return e===Re.UpdateOfNonExistentItem||e===Re.DeleteOfNonExistingItem}}])}();h();var Pk=w(Se()),Rk=w(P()),Bk=w(R()),Wk=w(Qe()),dd=w($e()),Ok=w(je());h();var uy=w(P()),ly=w(R()),cy=function(){function n(){(0,uy.default)(this,n),this.prevSequence=-1}return(0,ly.default)(n,[{key:"generate",value:function(e){if(e)for(var t of e){var o=++this.prevSequence;t.metadata?t.metadata.seq=o:t.metadata={seq:o}}}}])}();h();var fy=w(P()),dy=w(R()),Ls=function(){function n(r){(0,fy.default)(this,n),this.elements=r}return(0,dy.default)(n,[{key:"getAll",value:function(e){return Promise.resolve(this.elements)}},{key:"map",value:function(e){throw new Error("Not Yet Implemented")}},{key:"filter",value:function(e){throw new Error("Not Yet Implemented")}},{key:"forEach",value:function(e){throw new Error("Not Yet Implemented")}},{key:"reduce",value:function(e,t){throw new Error("Not Yet Implemented")}}])}();h();var Fs=w(P()),qs=w(R());var lo=function(){function n(r){(0,Fs.default)(this,n),m.assign(n,this,r)}return(0,qs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_AsyncAnnotationResult"}},{key:"getBaseTypes",value:function(){return[]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();lo.H_={T_:lo.getTypeName(),B_:lo.getBaseTypes()};var $f=function(){function n(r){(0,Fs.default)(this,n),m.assign(n,this,r)}return(0,qs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_ChatStoreSetMessages"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();$f.H_={T_:$f.getTypeName(),B_:$f.getBaseTypes()};var Gf=function(){function n(r){(0,Fs.default)(this,n),m.assign(n,this,r)}return(0,qs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Runtime_Workflow_Shared_ChatStoreGetMessages"}},{key:"getBaseTypes",value:function(){return["AugLoop_Session_Protocol_Message"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Gf.H_={T_:Gf.getTypeName(),B_:Gf.getBaseTypes()};h();var ee;(function(n){n[n.WorkflowExecutionFailed=0]="WorkflowExecutionFailed",n[n.WorkflowDisabled=1]="WorkflowDisabled",n[n.WorkflowWrongAnnotationType=2]="WorkflowWrongAnnotationType",n[n.FailedAnnotationApply=3]="FailedAnnotationApply",n[n.ApplyAnnotationsException=4]="ApplyAnnotationsException",n[n.AnnotationsNotArray=5]="AnnotationsNotArray",n[n.UnexpectedOutput=6]="UnexpectedOutput",n[n.OutputIsNotAnnotation=7]="OutputIsNotAnnotation",n[n.MixedOutput=8]="MixedOutput",n[n.UnknownAnnotationParent=9]="UnknownAnnotationParent",n[n.SnapshotStorageNotInitialized=10]="SnapshotStorageNotInitialized",n[n.FailedToRetrieveDataFromSnapshot=11]="FailedToRetrieveDataFromSnapshot",n[n.TooManyItemsToExecuteReduceWorkflow=12]="TooManyItemsToExecuteReduceWorkflow",n[n.NoAcceptableTransportAvailable=13]="NoAcceptableTransportAvailable",n[n.FailedToZipInput=14]="FailedToZipInput",n[n.RequiredTokenNotAvailable=15]="RequiredTokenNotAvailable",n[n.TimedOutSendingRequestToWorkflowProcess=16]="TimedOutSendingRequestToWorkflowProcess",n[n.PubSubProduceError=17]="PubSubProduceError",n[n.WorkflowExecutionCancelled=18]="WorkflowExecutionCancelled",n[n.WorkflowTimeout=19]="WorkflowTimeout",n[n.SequenceOutOfOrder=20]="SequenceOutOfOrder",n[n.WorkflowResultsCancelled=21]="WorkflowResultsCancelled",n[n.WorkflowExecutionThrottled=22]="WorkflowExecutionThrottled",n[n.InvalidInputQuantityForSingleItemWorkflow=23]="InvalidInputQuantityForSingleItemWorkflow"})(ee||(ee={}));var $s=new Set(Object.keys(ee).filter(function(n){return typeof ee[n]=="number"})),Uf=function(r){return $s.has(r)?ee[r]:r.indexOf("Timeout sending request")!==-1?ee.TimedOutSendingRequestToWorkflowProcess:r.indexOf("PubSub.produce Error")!==-1?ee.PubSubProduceError:ee.WorkflowExecutionFailed},py=function(r){switch(r){case ee.SnapshotStorageNotInitialized:case ee.FailedToRetrieveDataFromSnapshot:case ee.TooManyItemsToExecuteReduceWorkflow:case ee.NoAcceptableTransportAvailable:case ee.FailedToZipInput:case ee.TimedOutSendingRequestToWorkflowProcess:case ee.PubSubProduceError:case ee.WorkflowExecutionCancelled:return!0;case ee.WorkflowExecutionFailed:case ee.WorkflowDisabled:case ee.WorkflowWrongAnnotationType:case ee.FailedAnnotationApply:case ee.ApplyAnnotationsException:case ee.AnnotationsNotArray:case ee.UnexpectedOutput:case ee.OutputIsNotAnnotation:case ee.MixedOutput:case ee.UnknownAnnotationParent:case ee.WorkflowTimeout:case ee.SequenceOutOfOrder:default:return!1}};h();var Qo;(function(n){n.JsClient="C",n.Server="S"})(Qo||(Qo={}));h();var vy=w(dt()),co=w(Se()),Qf=w(P()),jf=w(R());h();var Hf=w(Tn()),zf=w(P()),Vf=w(R());var AA=function(){function n(r,e,t,o){(0,zf.default)(this,n),this.item=r,this.subtreeRootItem=t,this.subtreeRootModelIteratorItem=o,this.createIteratorCallback=e}return(0,Vf.default)(n,[{key:"schema",get:function(){return this.item.schema}},{key:"id",get:function(){return this.item.id}},{key:"operation",get:function(){return this.item.operation}},{key:"delta",get:function(){return this.item.delta}},{key:"deltas",get:function(){return this.item.deltas}},{key:"isContext",get:function(){return this.item.isContext}},{key:"asyncBoundary",get:function(){return this.item.asyncBoundary}},{key:"revId",get:function(){return this.item.revId}},{key:"getModelIterator",value:function(){if(this.asyncBoundary)return this.createIteratorCallback(this);throw new Error("An iterator can be created only for async boundary items")}},{key:"getSourceTimestamp",value:function(){return this.item.getSourceTimestamp()}},{key:"getContextId",value:function(){return this.item.getContextId()}},{key:"getBody",value:function(){return this.item.getBody()}},{key:"getItemReference",value:function(){return this.item.getItemReference()}},{key:"getParentItem",value:function(e){var t=this.item.getParentItem(e);if(t===void 0){if(this.subtreeRootModelIteratorItem!==void 0)return this.subtreeRootModelIteratorItem.getParentItem(e);t=this.subtreeRootItem.getParentItem(e)}return this.createIteratorItem(t)}},{key:"getParentItemBody",value:function(e){var t;return(t=this.getParentItem(e))===null||t===void 0?void 0:t.getBody()}},{key:"getChildItem",value:function(e){var t=this.item.getChildItem(e);return this.createIteratorItem(t)}},{key:"getChildItemBody",value:function(e){return this.item.getChildItemBody(e)}},{key:"getChildItems",value:function(e){var t=this;return this.item.getChildItems(e).map(function(o){return t.createIteratorItem(o)})}},{key:"getChildItemBodies",value:function(e){return this.item.getChildItemBodies(e)}},{key:"getSubtreeItem",value:function(e){var t=this.item.getSubtreeItem(e);return this.createIteratorItem(t)}},{key:"getSubtreeItemBody",value:function(e){return this.item.getSubtreeItemBody(e)}},{key:"getSubtreeItems",value:function(e){var t=this;return this.item.getSubtreeItems(e).map(function(o){return t.createIteratorItem(o)})}},{key:"getSubtreeItemBodies",value:function(e){return this.item.getSubtreeItemBodies(e)}},{key:"getContextItem",value:function(e){var t=this.item.getContextItem(e);return this.createIteratorItem(t)}},{key:"getContextItemBody",value:function(e){return this.item.getContextItemBody(e)}},{key:"getContextItems",value:function(e){var t=this;return this.item.getContextItems(e).map(function(o){return t.createIteratorItem(o)})}},{key:"getContextItemBodies",value:function(e){return this.item.getContextItemBodies(e)}},{key:"addAnnotation",value:function(e,t){var o=this.item.addAnnotation(e,t);return this.createIteratorItem(o)}},{key:"updateAnnotation",value:function(e,t){this.item.updateAnnotation(e,t)}},{key:"deleteAnnotation",value:function(e){return this.item.deleteAnnotation(e)}},{key:"createIteratorItem",value:function(e){return e===void 0?void 0:new n(e,this.createIteratorCallback,this.subtreeRootItem,this.subtreeRootModelIteratorItem)}}])}(),hy=function(){function n(r,e,t,o,a,s,u){(0,zf.default)(this,n);var l;this.subtreeRootItem=r,this.parentModel=e,this.asyncBoundaryLoader=t,this.hasUnreadItems=this.subtreeRootItem.getChildItem()!==void 0,this.subtreeRootModelIteratorItem=s,this.endReached=!1,this.truncationContext=o,this.truncated=((l=o==null?void 0:o.truncatedItemPathKeys)===null||l===void 0?void 0:l.indexOf(this.subtreeRootItem.id))>=0,this.pageSize=a,this.modelUnloadedCallback=u}return(0,Vf.default)(n,[{key:"getNextPage",value:function(){var r=(0,Hf.default)(function*(){if(this.endReached)return Promise.resolve([]);if(!this.hasUnreadItems&&this.truncated){var t=yield this.asyncBoundaryLoader.loadSubtree(new Bi({pageSize:this.pageSize,rootItemPath:this.subtreeRootItem.getItemReference().referencedPath,lastItemPathKey:this.lastItemPathKey})),o=this.parentModel.createSubModel(this.subtreeRootItem);o.addItems(t.items);for(var a of t.existingAnnotations)o.getItemByReference({referencedPath:a.parentPath}).addAnnotation(a.body);this.lastItemPathKey=t.lastItemPathKey,this.subtreeRootItem=o.scopeItem,this.currentSubModel&&(this.currentSubModel.commitPendingAnnotations(),this.modelUnloadedCallback(this.currentSubModel)),this.currentSubModel=o,this.endReached=t.endReached}for(var s=this.subtreeRootItem.getChildItems(),u=new Array(s.length),l=this.createIterator.bind(this),c=0;c<u.length;c++)u[c]=new AA(s[c],l,this.subtreeRootItem,this.subtreeRootModelIteratorItem);return this.hasUnreadItems=!1,this.truncated||(this.endReached=!0),Promise.resolve(u)});function e(){return r.apply(this,arguments)}return e}()},{key:"forEach",value:function(){var r=(0,Hf.default)(function*(t){for(var o=yield this.getNextPage(),a=!1,s=function(){a=!0};o.length>0;){for(var u=0;!a&&u<o.length;u++){var l=t(o[u],s);l instanceof Promise&&(yield l)}if(a)break;o=yield this.getNextPage()}});function e(t){return r.apply(this,arguments)}return e}()},{key:"createIterator",value:function(e){var t;return new n(e.item,(t=this.currentSubModel)!==null&&t!==void 0?t:this.parentModel,this.asyncBoundaryLoader,this.truncationContext,this.pageSize,e,this.modelUnloadedCallback)}}])}();var my=new G("pullWorkflowModelPageSize",11e3),yy=Symbol("workflowModel"),rt=Symbol("workflowModelItem"),Ar=function(r){if(!r)return function(e){return e[rt]!==void 0};if(typeof r=="function")return function(e){return e[rt]&&r(e[rt])};if((r.id?1:0)+(r.ids?1:0)+(r.itemType?1:0)+(r.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");return r.id?function(e){return e[rt]&&r.id===e[rt].internalId}:r.ids?function(e){return e[rt]&&r.ids.indexOf(e[rt].internalId)>=0}:r.itemType?function(e){return e[rt]&&m.matchesTypesFor(e.body,[r.itemType])}:function(e){return e[rt]&&m.matchesTypesFor(e.body,r.itemTypes)}},bA=function(){function n(r,e,t,o,a,s,u,l){(0,Qf.default)(this,n),this.model=r,this.item=e,this.isNew=a,this.isContext=s,this.operation=e.op,this.delta=e.delta,this.deltas=e.deltas,this.loadSubtreeCallback=t,this.createIteratorCallback=o,this.resolveSchemaItemCallback=u,this.getNextAnnotationId=l}return(0,jf.default)(n,[{key:"id",get:function(){if(this.isNew)throw new Error("Cannot provide id for newly added annotation");return this.internalId}},{key:"internalId",get:function(){return this._id||(this._id=z(this.itemPath)),this._id}},{key:"revId",get:function(){return this.item.revId}},{key:"asyncBoundary",get:function(){var e;return(e=this.schema)===null||e===void 0?void 0:e.asyncBoundary}},{key:"schema",get:function(){var e;return(e=this._schema)!==null&&e!==void 0?e:this._schema=this.resolveSchemaItemCallback?this.resolveSchemaItemCallback(this):void 0}},{key:"workflowModel",get:function(){return this.model[yy]}},{key:"itemPath",get:function(){return this._itemPath||(this._itemPath=[].concat((0,co.default)(this.item.parentPath),[this.item.id])),this._itemPath}},{key:"getModelIterator",value:function(){if(this.asyncBoundary)return this.createIteratorCallback(this);throw new Error("An iterator can be created only for async boundary items")}},{key:"getBody",value:function(){return this.item.body}},{key:"getItemReference",value:function(){if(this.isNew)throw new Error("Cannot provide IItemReference for newly added annotation");return{referencedPath:(0,co.default)(this.itemPath)}}},{key:"getParentItem",value:function(e){var t=Ar(e),o=void 0;return this.model.visitItemPathSync(this.item.parentPath,function(a){t(a)&&(o=a[rt])}),o}},{key:"getParentItemBody",value:function(e){var t;return(t=this.getParentItem(e))===null||t===void 0?void 0:t.getBody()}},{key:"getPrevItem",value:function(e,t){var o=this.getSubtreeItemsForSiblingIteration(e,t),a=o.indexOf(this.item)-1;if(a>=0)return o[a][rt]}},{key:"getPrevItemBody",value:function(e,t){var o;return(o=this.getPrevItem(e,t))===null||o===void 0?void 0:o.getBody()}},{key:"getNextItem",value:function(e,t){var o=this.getSubtreeItemsForSiblingIteration(e,t),a=o.indexOf(this.item)+1;if(a>0&&a<o.length)return o[a][rt]}},{key:"getNextItemBody",value:function(e,t){var o;return(o=this.getNextItem(e,t))===null||o===void 0?void 0:o.getBody()}},{key:"getChildItem",value:function(e){var t=Ar(e),o=[];return this.accumulateChildWorkflowModelItems(t,this.itemPath,o,!0),o[0]}},{key:"getChildItemBody",value:function(e){var t;return(t=this.getChildItem(e))===null||t===void 0?void 0:t.getBody()}},{key:"getChildItems",value:function(e){var t=Ar(e),o=[];return this.accumulateChildWorkflowModelItems(t,this.itemPath,o),o}},{key:"getChildItemBodies",value:function(e){return this.getChildItems(e).map(function(t){return t.getBody()})}},{key:"getSubtreeItem",value:function(e){return this.getSubtreeWorkflowModelItems(Ar(e),this.itemPath,!0)[0]}},{key:"getSubtreeItemBody",value:function(e){var t;return(t=this.getSubtreeItem(e))===null||t===void 0?void 0:t.getBody()}},{key:"getSubtreeItems",value:function(e){return this.getSubtreeWorkflowModelItems(Ar(e),this.itemPath)}},{key:"getSubtreeItemBodies",value:function(e){return this.getSubtreeItems(e).map(function(t){return t.getBody()})}},{key:"getContextItem",value:function(e){var t;return(t=this.getContextItems(e))===null||t===void 0?void 0:t[0]}},{key:"getContextItemBody",value:function(e){var t;return(t=this.getContextItem(e))===null||t===void 0?void 0:t.getBody()}},{key:"getContextItems",value:function(e){var t=this,o=Ar(e),a=function(l){var c=(0,co.default)(l.getItemReference().referencedPath);return c.splice(-1),Wn(c,t.itemPath)},s=function(l){return o(l.item)&&a(l)};return this.workflowModel.getItems(s)}},{key:"getContextItemBodies",value:function(e){return this.getContextItems(e).map(function(t){return t.getBody()})}},{key:"addAnnotation",value:function(e,t){if(t!=null&&t.immediate){this.workflowModel.commitImmediateAnnotation(this.item,e);return}if(this.isNew){var o=`WorkflowModelItem.add: Cannot add an annotation to an item without stable id. Item: ${this.internalId}`;if(this.allowStableAnnotationIds())throw new Error(o);v.warn(507011726,y.CoreDefault,o)}var a=this.allowStableAnnotationIds()&&e.id,s={id:a?e.id:this.getNextAnnotationId(),body:e,parentPath:this.itemPath};return this.model.addItems(function(){},this.itemPath,[s]),s[rt]=new n(this.model,s,this.loadSubtreeCallback,void 0,!a,void 0,this.resolveSchemaItemCallback,this.getNextAnnotationId),this.workflowModel.setPendingAnnotationType(this.item,m.getTypeNameFor(e)),s[rt]}},{key:"updateAnnotation",value:function(e,t){var o;if(m.getTypeNameFor(e)!==m.getTypeNameFor(this.item.body))throw new Error("WorkflowModelItem.update: Must update annotation with another body of the same type");if(this.allowStableAnnotationIds()&&!this.isNew&&(e==null?void 0:e.id)!==((o=this.item.body)===null||o===void 0?void 0:o.id))throw new Error("WorkflowModelItem.update: It is not allowed to modify stable item id");var a=this.getParentItemForAnnotationOperations("update",t);this.item.body=e,this.model.updateItems(function(){},this.item.parentPath,[this.item]),this.workflowModel.setPendingAnnotationType(a,m.getTypeNameFor(this.item.body))}},{key:"deleteAnnotation",value:function(e){var t=this.getParentItemForAnnotationOperations("delete",e);this.model.deleteItems(function(){},this.item.parentPath,[this.item]),this.workflowModel.setPendingAnnotationType(t,m.getTypeNameFor(this.item.body)),this.item.body=void 0}},{key:"loadSubtree",value:function(e){return this.loadSubtreeCallback(this.itemPath,e)}},{key:"getSourceTimestamp",value:function(){return this.item.sourceTimestamp}},{key:"getContextId",value:function(){return this.item.contextId}},{key:"accumulateChildWorkflowModelItems",value:function(e,t,o,a){var s=this.model.getItemChildren(t);for(var u of s)if(u[rt]){if(e(u)&&(o.push(u[rt]),a))return!1}else if(H("FixStubsFromStoppingIteratingTheChildren")){if(!this.accumulateChildWorkflowModelItems(e,[].concat((0,co.default)(u.parentPath),[u.id]),o,a))return!1}else if(this.accumulateChildWorkflowModelItems(e,[].concat((0,co.default)(u.parentPath),[u.id]),o,a))return!1;return!0}},{key:"getParentItemForAnnotationOperations",value:function(e,t){if(t!=null&&t.immediate)throw new Error(`WorkflowModelItem.${e}Annotation: Unsupported option`);var o=this.item.parentPath.length>0?this.model.getItem(this.item.parentPath):void 0;if(!o||o[rt]===void 0)throw new Error(`WorkflowModelItem.${e}Annotation: Parent must exist in workflow model`);return o}},{key:"getSubtreeItemsForSiblingIteration",value:function(e,t){var o=Ar(e);if(!o(this.item))throw new Error("Sibling filter must match current item");var a=this.getParentItem(t).itemPath;return this.model.getSubtreeItems(a,o).slice(1)}},{key:"getSubtreeWorkflowModelItems",value:function(e,t,o){var a=this.model.getSubtreeItems(t,e);if(a.length>0&&a[0]===this.item&&(a=a.slice(1)),a.length===0)return[];for(var s=new Array(o?1:a.length),u=0;u<s.length;u++)s[u]=a[u][rt];return s}},{key:"allowStableAnnotationIds",value:function(){var e;return H("AllowStableAnnotationIds")&&((e=this.workflowModel.modelOptions)===null||e===void 0?void 0:e.allowStableAnnotationIds)}}])}(),ky=function(){function n(r,e,t,o,a,s,u,l,c){(0,Qf.default)(this,n),this.pendingAnnotationTypesByParentItem=new Map,this.childModels=new Set,this.asyncBoundaryLoader=o,a&&(this.workflowModelItemSchemaResolver=s==null?void 0:s.create(a)),this.workflowModelItemSchemaResolverFactory=s,this.truncationContext=u,this.model=new uo,this.model[yy]=this,this._scopeItem=r,this._modelOptions=c,this.addItemCallback=t,this.getNextAnnotationId=l!=null?l:this.model.getNextAnnotationId.bind(this.model),this.addItems([r]),this.setAnnotations=e}return(0,jf.default)(n,[{key:"scopeItem",get:function(){return this._scopeItem[rt]}},{key:"rootItem",get:function(){return this.scopeItem}},{key:"modelOptions",get:function(){return this._modelOptions}},{key:"addItems",value:function(e,t){var o,a;if((e==null?void 0:e.length)>0){var s=this.loadSubtree.bind(this),u=this.createWorkflowModelIterator.bind(this),l=(a=(o=this.workflowModelItemSchemaResolver)===null||o===void 0?void 0:o.resolve)===null||a===void 0?void 0:a.bind(this.workflowModelItemSchemaResolver);for(var c of e)this.addItemCallback&&this.addItemCallback(c),this.model.addItems(function(){},c.parentPath,[c]),c[rt]=new bA(this.model,c,s,u,void 0,t,l,this.getNextAnnotationId)}}},{key:"setPendingAnnotationType",value:function(e,t){if(this.immediateAnnotationParentItem)throw new Error("Mixing immediate and non-immediate annotations is not supported");var o=this.pendingAnnotationTypesByParentItem.get(e)||[];o.indexOf(t)<0&&o.push(t),this.pendingAnnotationTypesByParentItem.set(e,o)}},{key:"commitImmediateAnnotation",value:function(e,t){if(this.pendingAnnotationTypesByParentItem.size>0)throw new Error("Mixing immediate and non-immediate annotations is not supported");if(this.immediateAnnotationParentItem&&this.immediateAnnotationParentItem!==e)throw new Error("Adding immediate annotations under different parents is not supported");this.setAnnotations(e,m.getTypeNameFor(t),[t],{immediate:!0}),this.immediateAnnotationParentItem=e}},{key:"commitPendingAnnotations",value:function(){for(var e of this.pendingAnnotationTypesByParentItem){var t=(0,vy.default)(e,2),o=t[0],a=t[1];for(var s of a){var u=this.model.getItemChildren([].concat((0,co.default)(o.parentPath),[o.id]),[s]);u&&u.length>0&&this.setAnnotations(o,s,u.map(function(c){return c.body}))}}for(var l of this.childModels)l.commitPendingAnnotations()}},{key:"getItem",value:function(e){return this.getItems(e)[0]}},{key:"getItems",value:function(e){return this.model.getSubtreeItems([],Ar(e)).map(function(t){return t[rt]})}},{key:"getItemBody",value:function(e){var t;return(t=this.getItem(e))===null||t===void 0?void 0:t.getBody()}},{key:"getItemBodies",value:function(e){return this.getItems(e).map(function(t){return t.getBody()})}},{key:"getItemByReference",value:function(e){var t;if(((t=e==null?void 0:e.referencedPath)===null||t===void 0?void 0:t.length)>0){var o=this.model.getItem(e.referencedPath);if(o)return o[rt]}}},{key:"getItemBodyByReference",value:function(e){var t;return(t=this.getItemByReference(e))===null||t===void 0?void 0:t.getBody()}},{key:"createWorkflowModelIterator",value:function(e){var t,o=void 0;if(this.asyncBoundaryLoader?this.asyncBoundaryLoader.kind!==qr.ModelIterating?o=`loadSubtree must be called for the asyncBoundaryLoader of kind 'ModelIterating'. Actual kind is ${this.asyncBoundaryLoader.kind}`:e.asyncBoundary||(o="An iterator can be created only for the items with asyncBoundary === true"):o="asyncBoundaryLoader is not defined",o)throw v.error(509092948,y.CoreDefault,o),new Error(o);var a;return!((t=this.modelOptions)===null||t===void 0)&&t.maxModelItems?a=Math.min(this.modelOptions.maxModelItems,my.getValue()):a=my.getValue(),new hy(e,this,this.asyncBoundaryLoader,this.truncationContext,a,void 0,this.onChildModelUnloaded.bind(this))}},{key:"createSubModel",value:function(e){var t=this.model.getItem(Bn(e.id)),o=new n(t,this.setAnnotations,this.addItemCallback,this.asyncBoundaryLoader,[e.schema],this.workflowModelItemSchemaResolverFactory,this.truncationContext,this.getNextAnnotationId,this.modelOptions);return this.childModels.add(o),o}},{key:"onChildModelUnloaded",value:function(e){this.childModels.delete(e)}},{key:"loadSubtree",value:function(e,t){var o=this,a=new E({operationName:"WorkflowModelLoadSubtree",success:!0,resultDescription:e.join("/")},{metricDuration:!0,metricCount:!0}).start(),s=void 0;if(this.asyncBoundaryLoader?this.asyncBoundaryLoader.kind!==qr.Filtering&&(s=`loadSubtree must be called for the asyncBoundaryLoader of kind 'Filtering'. Actual kind is ${this.asyncBoundaryLoader.kind}`):s="asyncBoundaryLoader is not defined",s)throw a.success=!1,a.resultSignature=`${s}`,v.error(526952588,y.CoreDefault,a.stop()),new Error(s);var u=this.asyncBoundaryLoader;return u.loadSubtree(new Ri({rootItemPath:e,filter:t})).then(function(l){l.forEach(function(c){c.parentPath=e}),o.addItems(l),a.success=!0,a.count=l.length,a.resultSignature="items loaded successfully",v.metric(526952589,y.CoreDefault,a.stop())}).catch(function(l){return a.success=!1,a.resultSignature="items loaded failed",a.resultDescription+=`
${l}`,v.error(526952590,y.CoreDefault,a.stop()),Promise.reject(l)})}}])}();h();var po=w(Tn()),Mk=w(P()),Ek=w(R());h();var Dy=w(P()),Py=w(R()),Ry=w(Qe()),Vs=w($e()),By=w(Ss()),Wy=w(je());h();var Iy=w(P()),_y=w(R());h();var Kf=w(Se());var Jf=new Map,uF=new G("workflowSynchronizationInterval",10),Gs=function(r){if(!r||!r.startsWith)return r;if(!Jf.has(r)){var e="Workflows/",t=r.startsWith(e)?r.substring(e.length):r;return Jf.set(r,t),t}return Jf.get(r)};var Sy=function(r,e,t){var o;return!(e&&e.includeExistingAnnotations&&r&&((o=t==null?void 0:t.length)!==null&&o!==void 0?o:0)===0)},Cy=function(r,e,t){if(!r||e===void 0)return!0;t!=null||(t=[]);for(var o of e)if(!t.includes(o))return!1;return!0},xy=function(r,e){r=r!=null?r:[],e=e!=null?e:[];var t=Array.from(new Set(r)).sort(),o=Array.from(new Set(e)).sort();if(t.length!==o.length)return!1;for(var a=0;a<t.length;a++)if(t[a]!==o[a])return!1;return!0},wy=[m.getTypeName(),_t.getTypeName(),Xt.getTypeName()],Us=function(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,t=new Set;for(var o of r)if(typeof o=="string")wy.includes(o)||t.add(o);else{var a=e?[o.getTypeName()].concat((0,Kf.default)(o.getBaseTypes())):[o.getTypeName()];for(var s of a)wy.includes(s)||t.add(s)}return(0,Kf.default)(t)};var Yf=function(r,e,t){if(e!==t){if(e===void 0){r.push(t);return}if(t===void 0){r.splice(r.indexOf(e),1);return}var o=r.indexOf(e);r[o]=t}};function Ty(n,r){var e=function(o){return typeof o=="number"};if(r.some(e)){if(!r.every(e))throw new Error(`Expected AuthTokenType[] or AuthTokenOptions[] but found a mix in workflow ${n}`);return!0}return!1}var Ay=function(){function n(r,e){(0,Iy.default)(this,n);var t,o,a,s;this.visibility=Gr.Default,this.id=r,this.resourceId=Gs(r),e&&(this.requestedContextTypesRules=(t=e.requestedContextTypesRules)!==null&&t!==void 0?t:this.requestedContextTypesRules,this.eventSequenceOptions=(o=e.eventSequenceOptions)!==null&&o!==void 0?o:this.eventSequenceOptions,this.activationUserConfigs=(a=e.activationUserConfigs)!==null&&a!==void 0?a:this.activationUserConfigs,this.requiredTokenOptions=(s=e.requiredTokenOptions)!==null&&s!==void 0?s:this.requiredTokenOptions)}return(0,_y.default)(n,[{key:"validateOptions",value:function(){return{isValid:!0}}},{key:"setRequestedContexts",value:function(e){var t;return this.requestedContextTypesRules=((t=this.requestedContextTypesRules)!==null&&t!==void 0?t:this.requestedContextTypesRules=[]).concat(e),this}},{key:"setEventSequenceOptions",value:function(e){return this.eventSequenceOptions=e,this}},{key:"setActivationUserConfigs",value:function(e){return this.activationUserConfigs=e,this}}])}();h();var Hs=w(R()),zs=w(P());var MA=(0,Hs.default)(function n(r,e){(0,zs.default)(this,n),this.name=r,this.defaultValue=e}),by=(0,Hs.default)(function n(r,e){(0,zs.default)(this,n),this.type=Pi.MaxInputCount,typeof r=="number"?this.maxCount=r:r instanceof MA&&(this.setting=r),this.action=e}),My=(0,Hs.default)(function n(r,e){(0,zs.default)(this,n),this.type=Pi.UILanguage,r instanceof Array?this.languages=r:this.setting=r,this.action=e});function EA(n,r,e){return r=(0,Vs.default)(r),(0,Ry.default)(n,Oy()?Reflect.construct(r,e||[],(0,Vs.default)(n).constructor):r.apply(n,e))}function Oy(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Oy=function(){return!!n})()}function NA(n,r,e,t){var o=(0,By.default)((0,Vs.default)(1&t?n.prototype:n),r,e);return 2&t&&typeof o=="function"?function(a){return o.apply(e,a)}:o}var Ey=Symbol("maxInputCountPrefilter"),Ny=Symbol("languagesPrefilter"),Qs=function(n){function r(e,t){var o;(0,Dy.default)(this,r);var a,s,u,l,c,f,d,p,g,k,S,C,x,T,I,_,M,b,A,N,F;return o=EA(this,r,[e,t]),o.kind=V.Reduce,o.priority=0,o.activationConfigs=[{clientAppName:"All",clientAppPlatform:"All",activationTier:yn.Default}],o.inputStage=zt.All,o.minDelayMs=1e3,o.maxDelayMs=5e3,o.isStateful=!1,o.bypassModel=!1,o.bypassTypes=void 0,o.fetchExistingAnnotations=!1,o.billingDomain=us.Default,t&&(o.priority=(a=t.priority)!==null&&a!==void 0?a:o.priority,o.inputTypes=(s=t.inputTypes)!==null&&s!==void 0?s:o.inputTypes,o.outputTypes=(u=t.outputTypes)!==null&&u!==void 0?u:o.outputTypes,o.inputStage=(l=t.inputStage)!==null&&l!==void 0?l:o.inputStage,o.isStateful=(c=t.isStateful)!==null&&c!==void 0?c:o.isStateful,o.activationConfigs=(f=t.activationConfigs)!==null&&f!==void 0?f:o.activationConfigs,o.triggerSignals=(d=t.triggerSignals)!==null&&d!==void 0?d:o.triggerSignals,o.requiredTokenTypes=(p=t.requiredTokenTypes)!==null&&p!==void 0?p:o.requiredTokenTypes,o.activationFlightsConfigs=(g=t.activationFlightsConfigs)!==null&&g!==void 0?g:o.activationFlightsConfigs,o.isAppOnlyTokenAllowed=(k=t.isAppOnlyTokenAllowed)!==null&&k!==void 0?k:o.isAppOnlyTokenAllowed,o.triggerConditions=(S=t.triggerConditions)!==null&&S!==void 0?S:o.triggerConditions,o.minDelayMs=(C=t.minDelayMs)!==null&&C!==void 0?C:o.minDelayMs,o.maxDelayMs=(x=t.maxDelayMs)!==null&&x!==void 0?x:o.maxDelayMs,o.maxExecutionTimeInS=(T=t.maxExecutionTimeInS)!==null&&T!==void 0?T:o.maxExecutionTimeInS,o.collectionScopeType=(I=t.collectionScopeType)!==null&&I!==void 0?I:o.collectionScopeType,o.bypassModel=(_=t.bypassModel)!==null&&_!==void 0?_:o.bypassModel,o.bypassTypes=(M=t.bypassTypes)!==null&&M!==void 0?M:o.bypassTypes,o.fetchExistingAnnotations=(b=t.fetchExistingAnnotations)!==null&&b!==void 0?b:o.fetchExistingAnnotations,o.modelOptions=(A=t.modelOptions)!==null&&A!==void 0?A:o.modelOptions,o.definitionOverrideTargetWorkflows=(N=t.definitionOverrideTargetWorkflows)!==null&&N!==void 0?N:o.definitionOverrideTargetWorkflows,o.billingDomain=(F=t.billingDomain)!==null&&F!==void 0?F:o.billingDomain),o}return(0,Wy.default)(r,n),(0,Py.default)(r,[{key:"setPriority",value:function(t){return this.priority=t,this}},{key:"setActivationConfigs",value:function(t){return this.activationConfigs=t,this}},{key:"setCollectionScopeType",value:function(t){return this.collectionScopeType=t,this}},{key:"setInputTypes",value:function(t){return this.inputTypes=Us(t,!1),this}},{key:"setInputStage",value:function(t){return this.inputStage=t,this}},{key:"setTriggerSignals",value:function(t){return this.triggerSignals=t,this}},{key:"setOutputTypes",value:function(t){return this.outputTypes=Us(t),this}},{key:"setTriggerConditions",value:function(t){return this.triggerConditions=t,this}},{key:"setMinDelayTime",value:function(t){return this.minDelayMs=t?Math.max(0,t):void 0,this}},{key:"setMaxDelayTime",value:function(t){return this.maxDelayMs=t?Math.max(0,t):void 0,this}},{key:"setMaxExecutionTime",value:function(t){return this.maxExecutionTimeInS=t,this}},{key:"setStateful",value:function(){return this.isStateful=!0,this}},{key:"setStateExpiryMs",value:function(t){return this.stateExpiryMs=t,this}},{key:"setLambdaType",value:function(t){return this.factory=function(){return new t},this}},{key:"setLambda",value:function(t){return this.factory=function(){return{execute:t,dispose:function(){}}},this}},{key:"setRequiredTokenTypes",value:function(t){return Ty(this.id,t)?this.requiredTokenTypes=t:this.requiredTokenOptions=t,this}},{key:"setOptionalTokenTypes",value:function(t){return this.optionalTokenTypes=t,this}},{key:"setActivationFlightsConfigs",value:function(t){return this.activationFlightsConfigs=t,this}},{key:"setIsAppOnlyTokenAllowed",value:function(t){return this.isAppOnlyTokenAllowed=t,this}},{key:"setBypassModel",value:function(t){return this.bypassModel=!0,t&&(this.bypassTypes=Us(t)),this}},{key:"setFetchExistingAnnotations",value:function(){return this.fetchExistingAnnotations=!0,this}},{key:"setModelOptions",value:function(t){return this.modelOptions=t,this}},{key:"validateOptions",value:function(){var t=NA(r,"validateOptions",this,3)([]);return t.isValid?Sy(this.bypassModel,this.modelOptions,this.bypassTypes)?Cy(this.bypassModel,this.bypassTypes,this.outputTypes)?{isValid:!0}:{isValid:!1,errorMessage:"Types provided to 'setBypassModel' must be set in 'setOutputTypes'."}:{isValid:!1,errorMessage:"Option 'includeExistingAnnotations' can't be enabled if 'bypassModel' is enabled for all output types."}:t}},{key:"setDefinitionOverrideTargetWorkflows",value:function(t){return this.definitionOverrideTargetWorkflows=t,this}},{key:"setMaxInputCountPrefilter",value:function(t,o){var a,s=new by(t,o);return Yf((a=this.prefilters)!==null&&a!==void 0?a:this.prefilters=[],this[Ey],s),this[Ey]=s,this}},{key:"setSupportedLanguagesPrefilter",value:function(t,o){var a,s=new My(t,o);return Yf((a=this.prefilters)!==null&&a!==void 0?a:this.prefilters=[],this[Ny],s),this[Ny]=s,this}},{key:"setBillingDomain",value:function(t){return this.billingDomain=t,this}}],[{key:"create",value:function(t){return new r(t)}}])}(Ay);h();h();var sk=w(P()),uk=w(R()),sd=w(Se()),lk=w(Tn());h();h();var Zf=w(R()),ed=w(P()),Ly=w(Qe()),Xf=w($e()),td=w(je()),Fy=w(as());function qy(n,r,e){return r=(0,Xf.default)(r),(0,Ly.default)(n,$y()?Reflect.construct(r,e||[],(0,Xf.default)(n).constructor):r.apply(n,e))}function $y(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return($y=function(){return!!n})()}var DA="AuthError",Gy=function(n){function r(e,t,o,a){var s;return(0,ed.default)(this,r),s=qy(this,r,[t?`${e}: ${t}`:e]),Object.setPrototypeOf(s,r.prototype),s.errorCode=e||"",s.errorMessage=t||"",s.subError=o||"",s.correlationId=a||"",s.name=DA,s}return(0,td.default)(r,n),(0,Zf.default)(r)}((0,Fy.default)(Error));var nd="InteractionRequiredAuthError",Uy=function(n){function r(e,t,o,a,s,u,l){var c;return(0,ed.default)(this,r),c=qy(this,r,[e,t,o,a]),Object.setPrototypeOf(c,r.prototype),c.timestamp=s||"",c.traceId=u||"",c.claims=l||"",c.name=nd,c}return(0,td.default)(r,n),(0,Zf.default)(r)}(Gy);function rd(n){try{if(n!=null&&n.includes(nd)){var r=JSON.parse(n);return new Uy(r.errorCode,r.errorMessage,r.subError,r.correlationId,r.timestamp,r.traceId,r.claims)}}catch(e){v.error(507062222,y.CoreDefault,"InteractionRequiredAuthError detected but unable to build from token.");return}}h();h();var zy=w(P()),Vy=w(R()),Qy=w(Hy()),od=";",id=":",LA=".";function fr(n){if(!n)return new jo([],new Set,new Map,new Map);var r=n.split(od),e=new Set,t=new Map,o=new Map;for(var a of r){var s=a.trim();if(s!==""){e.add(jo.normalizeName(s));var u=s.split(id),l=(0,Qy.default)(u),c=l[0],f=l.slice(1),d=f.join(id),p=jo.normalizeName(c);if(p){t.set(p,d);var g=jo.parseName(p);g&&g!==p&&o.set(g,p)}}}return new jo(r,e,t,o)}function ad(n){if(!n)return"";var r=new Set,e=[];for(var t of n.split(od).reverse()){var o=t.split(id)[0],a=jo.normalizeName(o);r.has(a)||(r.add(a),e.push(t))}return e.reverse().join(od)}var jo=function(){function n(r,e,t,o){(0,zy.default)(this,n),this.originalFlights=r,this.normalizedFlights=e,this.keyValueFlightsMap=t,this.parsedFlightsMap=o}return(0,Vy.default)(n,[{key:"hasFlight",value:function(e){var t=n.normalizeName(e),o=this.normalizedFlights.has(t),a=this.keyValueFlightsMap.has(t),s=this.parsedFlightsMap.has(t);return o||a||s}},{key:"getBooleanValue",value:function(e,t){var o,a,s=(o=this.getStringValue(e))===null||o===void 0?void 0:o.toLowerCase(),u=(a=this.getStringValue(this.parsedFlightsMap.get(n.normalizeName(e))))===null||a===void 0?void 0:a.toLowerCase();return s==="true"||u==="true"?!0:s==="false"||u==="false"?!1:t}},{key:"getIntValue",value:function(e,t){var o=this.getStringValue(e),a=Number.parseInt(o,10);return Number.isNaN(a)?t:a}},{key:"getStringValue",value:function(e,t){var o;return(o=this.keyValueFlightsMap.get(n.normalizeName(e)))!==null&&o!==void 0?o:t}},{key:"getAll",value:function(){return this.originalFlights}},{key:"getAllParsed",value:function(){var e=[];return this.keyValueFlightsMap.forEach(function(t,o){var a=t==null?void 0:t.toLowerCase();switch(a){case"true":e.push({name:o,value:!0});break;case"false":e.push({name:o,value:!1});break;default:{var s=Number.parseInt(a,10);Number.isNaN(s)?e.push({name:o,value:t}):e.push({name:o,value:s})}break}}),e}}],[{key:"normalizeName",value:function(e){return e==null?void 0:e.toLowerCase()}},{key:"parseName",value:function(e){var t=e==null?void 0:e.split(LA);return t?t[t.length-1]:void 0}}])}();h();var _a=w(Tn()),jy=w(P()),Jy=w(R());var Ky=function(){function n(r,e,t){if((0,jy.default)(this,n),this.correlationValidator=t,!r)throw new Error("workflowMessageHandler is required");if(this.workflowMessageHandler=r,!e)throw new Error("executionContext is required");this.executionContext=e}return(0,Jy.default)(n,[{key:"addMessages",value:function(){var r=(0,_a.default)(function*(t){return this.correlationValidator.validate("ChatStore.addMessages"),this.workflowMessageHandler.onChatStoreMessagesSet({messages:t,options:{operationType:xo.Add}},this.executionContext)});function e(t){return r.apply(this,arguments)}return e}()},{key:"updateMessages",value:function(){var r=(0,_a.default)(function*(t){return this.correlationValidator.validate("ChatStore.updateMessages"),this.workflowMessageHandler.onChatStoreMessagesSet({messages:t,options:{operationType:xo.Update}},this.executionContext)});function e(t){return r.apply(this,arguments)}return e}()},{key:"deleteMessages",value:function(){var r=(0,_a.default)(function*(t){this.correlationValidator.validate("ChatStore.deleteMessages");var o=t.map(function(a){return{id:a,content:""}});return this.workflowMessageHandler.onChatStoreMessagesSet({messages:o,options:{operationType:xo.Delete}},this.executionContext)});function e(t){return r.apply(this,arguments)}return e}()},{key:"getMessages",value:function(){var r=(0,_a.default)(function*(t){return this.correlationValidator.validate("ChatStore.getMessages"),this.workflowMessageHandler.onChatStoreMessagesGet({options:t},this.executionContext)});function e(t){return r.apply(this,arguments)}return e}()}])}();h();var ek=w(P()),tk=w(R());h();var Yy=w(P()),Xy=w(R());var Zy=function(){function n(r,e){(0,Yy.default)(this,n),this.schema=r,this.typeToSchemaItemsMap=e}return(0,Xy.default)(n,[{key:"resolve",value:function(e){var t=this,o=m.getAllTypesFor(e.getBody()),a=o.map(function(f){return t.typeToSchemaItemsMap.get(f)}).filter(function(f){return f!==void 0});if(!a)throw v.error(509092953,y.CoreDefault,`Couldn't find a matching schema item. Item types: ${JSON.stringify(o)}, schema: ${JSON.stringify(this.schema)}`),new Error("Cannot find matching schema item");if(a.length===1&&a[0].length===1)return a[0][0];for(var s={child:void 0,schemaItem:void 0,itemTypes:o},u=void 0,l=e.getParentItem();l;){u=l;var c=s;s={child:c,schemaItem:void 0,itemTypes:m.getAllTypesFor(u.getBody())},l=u.getParentItem()}return this.resolveSchemaItem(s,this.schema)}},{key:"resolveSchemaItem",value:function(e,t){var o=t.find(function(a){return e.itemTypes.indexOf(a.type)!==-1});if(!e.child&&o)return o;if(!o||!o.children)throw v.error(509092952,y.CoreDefault,`Couldn't find a matching schema item. Item types: ${JSON.stringify(e.itemTypes)}, schema: ${JSON.stringify(this.schema)}`),new Error("Cannot find matching schema item");return this.resolveSchemaItem(e.child,o.children)}}])}();var nk=function(){function n(){(0,ek.default)(this,n)}return(0,tk.default)(n,[{key:"create",value:function(e){var t=new Map;return this.buildTypeToSchemaItemsMap(e,t),new Zy(e,t)}},{key:"buildTypeToSchemaItemsMap",value:function(e,t){for(var o of e.filter(function(s){return s.role===ls.Input})){var a=t.get(o.type);a||(a=[],t.set(o.type,a)),a.push(o),o.children&&this.buildTypeToSchemaItemsMap(o.children,t)}}}])}();h();var rk=w(P()),ok=w(R()),ik=function(){function n(){var r=this;(0,rk.default)(this,n),this.abortController=new AbortController,this.cancellationDetails=void 0,this.cancellationPromise=new Promise(function(e){r.resolveCancellationPromise=e})}return(0,ok.default)(n,[{key:"abortSignal",get:function(){return this.abortController.signal}},{key:"isCancelled",get:function(){return this.abortSignal.aborted}},{key:"markAsCancelled",value:function(e,t){this.cancellationDetails={reason:e,reasonDetails:t},this.abortController.abort(this.cancellationDetails),this.resolveCancellationPromise()}}])}();var FA=new G("workflowSequencerEnabled",!0),qA=new G("workflowSequencerDisabledWorkflows",[]),$A=new G("workflowDeactivateTokensDisabledWorkflows",["ChangeSummaries","Copywriter","Voice","WritersUnblock"]),GA=new G("workflowDefaultTimeout",8e3),ak=new Set,UA=new G("getAnnotationsTimeoutMs",8e3),ck=function(r,e){var t,o,a,s,u=r.workflow,l=r.workflowMessageHandler,c=r.executionContext,f=r.input,d=r.clientMetadata,p=r.getTokenCallback,g=r.stateCache,k=r.asyncBoundaryLoader,S=r.getSessionInfo,C=r.getWorkflowStoreManager,x=r.correlationValidator,T=!1,I=(o=(t=f.scopeItem)===null||t===void 0?void 0:t.contextId)!==null&&o!==void 0?o:(s=(a=f.inputItems)===null||a===void 0?void 0:a[0])===null||s===void 0?void 0:s.contextId;vs(function(){var _=(0,lk.default)(function*(M){var b;v.debug(512336708,y.CoreDefault,function(){return`executeWorkflow id: ${u.id}, inputs count: ${f.inputItems?f.inputItems.length:-1}`});var A=new E({operationName:"ExecuteWorkflowOnService",resourceId:u.resourceId,joinContextId:I!=null?I:""}).start(),N=f.scopeItem||(f.inputItems&&f.inputItems.length>=1?f.inputItems[0]:void 0),F=(k==null?void 0:k.kind)!==qr.ModelIterating,q=F?new Map:void 0,J=Zt();if(N&&F&&(N.parentPath||v.error(512336707,y.CoreDefault,`Missing scope item parent. Workflow: ${u.id}. Type: ${m.getTypeNameFor(N.body)}`),q.set(N.body,N)),Array.isArray(f.inputItems)&&F)for(var Y of f.inputItems)Y&&Y.body&&(Y.parentPath||v.error(512336706,y.CoreDefault,`Missing parent. Workflow: ${u.id}. Type: ${m.getTypeNameFor(Y.body)}`),q.set(Y.body,Y));if(H("ImplementSignalWithPath")&&f.triggerSignals&&F)for(var fe of f.triggerSignals){var W=fe;if(W.signalPath){var B={id:W.signalPath.at(-1),parentPath:W.signalPath.slice(0,-1),body:fe,sourceInfo:W.sourceInfo};q.set(W,B)}}var L=[],O=N?[].concat((0,sd.default)(N.parentPath),[N.id]):void 0,D=void 0,$=function(ae){x.validate("executeWorkflowWithCallback.submitSignals"),ze(function(){var j=new E({operationName:"submitSignalsAction",resourceId:u.id,success:!0});for(var ge of ae){var ue=m.getTypeNameFor(ge);m.matchesTypesFor(ge,[Xt.getTypeName()])||(j.resultDescription=`Workflow produced an output that is not an signal (${m.getTypeNameFor(ge)})`,v.info(512336705,y.CoreDefault,j)),(!u.outputTypes||u.outputTypes.indexOf(ue)===-1)&&(j.resultDescription=`Workflow said it would output one of [${u.outputTypes}] but instead output ${ue}`,v.info(512336704,y.CoreDefault,j)),ge.timestamp&&(ak.has(u.id)||(ak.add(u.id),j.resultDescription=`Workflow "${u.id}" sets signal.timeStamp`,v.info(509212802,y.CoreDefault,j)))}var le=ae.map(function(Ue){return{id:Zt(),source:u.id,body:Ue,contextId:I}}),Pe=new it({parentPath:["session"],items:le}),ot=new Be({cv:M.cv.toString(),ops:[Pe]}),qe=JSON.stringify(le.map(function(Ue){var Ut,An;return{id:Ue.id,type:(An=(Ut=Ue.body)===null||Ut===void 0?void 0:Ut.H_)===null||An===void 0?void 0:An.T_}}));v.debug(512336675,y.CoreDefault,`Publishing message for triggering signals ${qe}.`),l.onMessage(ot,c).then(function(){v.debug(512336674,y.CoreDefault,`Signals ${qe} successfully triggered.`)}).catch(function(Ue){v.error(512336673,y.CoreDefault,`Error sending signals ${qe}: ${Ue}.`)})},M)},U=function(ae,j,ge){x.validate("executeWorkflowWithCallback.overrideWorkflowDefinition"),ze(function(){var ue;switch(ge){case xr.JoinContext:{if(!N.contextId){var le="ContextId is not defined for this scope item.";throw v.error(512336672,y.CoreDefault,le),new Error(le)}ue=N.contextId;break}case xr.Session:{ue=void 0;break}default:{var Pe="Defined scope is not supported. "+ge;throw v.error(512336671,y.CoreDefault,Pe),new Error(Pe)}}var ot=new ar({definition:j,contextId:ue,sourceWorkflowId:u.id,targetWorkflowId:ae});l.onMessage(ot,c).catch(function(qe){v.error(512336670,y.CoreDefault,`Error overriding config for workflow: ${ae}, contextId: ${N.contextId}: ${qe}.`)})},M)},K=function(ae){D=ae},Z=function(ae,j,ge,ue){x.validate("executeWorkflowWithCallback.setItemAnnotations"),ze(function(){var le;if(u.isStateful){var Pe=g.getAnnotationSequenceGenerator(u,c.sessionKey,c.userId);Pe==null||Pe.generate(ge)}var ot=on(ae,j,ge,ue);if(ue&&ue.immediate){var qe=new E({operationName:"SetImmediateAnnotations",resourceId:u.id,success:!0}).start();H("AddTelemetryForOutOfOrderAnnotationsOnMastermind")&&v.verbose(506573338,y.CoreDefault,`Setting annotations for workflow: ${u.id} and annotationType: ${j} under workflowExecutionGuid: ${J}`);var Ue=new lo({workflow:u,scopeItemPath:O,scopeItemRevId:N==null?void 0:N.revId,annotationQueue:[ot],callerRequestId:(le=c.callerRequestId)!==null&&le!==void 0?le:void 0,workflowExecutionGuid:J});if(l.onAnnotationResult(Ue,c).catch(function(Ut){var An=`Error posting annotations: ${Ut}`;v.error(512336669,y.CoreDefault,An),qe.success=!1,qe.resultDescription=An}).finally(function(){v.info(507339521,y.CoreDefault,qe.stop())}),H("includeImmediateBypassModelAnnotations")){if(!c.callerRequestId&&Aa(u,j))return}else if(Aa(u,j))return}L.push(ot)},M)},ye=function(ae,j,ge,ue){x.validate("executeWorkflowWithCallback.setAnnotations");var le=ut();ze(function(){if(!le||(le==null?void 0:le.sessionKey)!==(M==null?void 0:M.sessionKey))throw new Error("actions.setAnnotations must be called with a CV matching the session");if(!F)throw new Error("actions.setAnnotations should not be used for the WFs that use model iterating async boundary loader. Use IWorkflowModelItem.addAnnotation instead");var Pe=void 0;if(!(ue!=null&&ue.isSessionAnnotation)&&(Pe=q.get(ae),!Pe))throw v.error(512336664,y.CoreDefault,"Workflow is trying to annotate an unknown object"),new Error(ee[ee.UnknownAnnotationParent]);Z(Pe,j,ge,ue)},M)},he=Zt(),ke=function(ae,j){return new Promise(function(ge,ue){x.validate("executeWorkflowWithCallback.getDynamicAnnotations"),ze(function(){kn(function(){var le=ae.maxDelayMs?ae.maxDelayMs:UA.getValue(),Pe=setTimeout(function(){var ot=`Timeout: No response received within ${le} ms`;ue(new Error(ot)),H("UseWorkflowCancellation")&&Fe.cancellation.markAsCancelled(Di.Timeout,ot)},le);Ae(ae,le,function(ot,qe){clearTimeout(Pe),l.onGetDynamicAnnotationsDoneCalled(he),ot?ue(ot):ge(qe)},j)})},M)})},Ae=function(ae,j,ge,ue){var le=ut(),Pe={cvString:le==null?void 0:le.cv.toString(),interactionId:le==null?void 0:le.interactionId,interactionSessionId:le==null?void 0:le.interactionSessionId},ot=new Sn({annotationTypes:ae.annotationTypes,transientItems:ae.transientItems,callerWorkflowId:u.id,callerRequestId:he,correlationInfo:Pe,activationWorkflowId:ae.activationWorkflowId});l.onMessage(ot,c,j,ue).then(function(qe){var Ue=qe==null?void 0:qe.payload;if(!Ue)ge(new Error("GetAnnotations call didn't return anything"),void 0);else if(m.matchesTypesFor(Ue,[X.getTypeName()]))ge(new Error(Ue.error),void 0);else if(m.matchesTypesFor(Ue,[ga.getTypeName()]))ge(void 0,{content:Ue.content});else{var Ut=`Unexpected response with types: ${m.getBaseTypesFor(Ue)}`;v.error(508680269,y.CoreDefault,Ut),ge(new Error(Ut),void 0)}}).catch(function(qe){v.error(508680268,y.CoreDefault,`Error with getDynamicAnnotations call: ${qe.message}`),ge(qe,void 0)})},on=function(ae,j,ge,ue){if(!Array.isArray(ge))throw v.error(512336668,y.CoreDefault,"Workflow produced an invalid annotation array"),new Error(ee[ee.AnnotationsNotArray]);if(!u.outputTypes||u.outputTypes.indexOf(j)===-1)throw v.error(512336667,y.CoreDefault,`Workflow said it would output one of [${u.outputTypes}] but instead output ${j}`),new Error(ee[ee.UnexpectedOutput]);for(var le of ge){if(!m.matchesTypesFor(le,[_t.getTypeName()]))throw v.error(512336666,y.CoreDefault,`Workflow produced an output that is not an annotation (${m.getTypeNameFor(le)})`),new Error(ee[ee.OutputIsNotAnnotation]);if(m.getTypeNameFor(le)!==j)throw v.error(512336665,y.CoreDefault,`Workflow produced inconsistent annotation types in setAnnotations call (${m.getTypeNameFor(le)} did not match expected ${j})`),new Error(ee[ee.MixedOutput])}return ue&&ue.isSessionAnnotation?{path:["session"],contextId:I,ancestorType:ue.ancestorType,annotationType:j,annotations:ge,isImmediateAnnotation:ue.immediate,sourceInfo:Fe.sourceInfo}:ue&&ue.ancestorType?{path:ae.parentPath,contextId:I,ancestorType:ue.ancestorType,annotationType:j,annotations:ge,isImmediateAnnotation:ue.immediate,sourceInfo:Fe.sourceInfo}:{path:[].concat((0,sd.default)(ae.parentPath),[ae.id]),revId:ae.revId,contextId:I,annotationType:j,annotations:ge,isImmediateAnnotation:ue==null?void 0:ue.immediate,sourceInfo:Fe.sourceInfo}},ht,an=u.maxExecutionTimeInS*1e3||GA.getValue();ht=setTimeout(function(){ht=void 0,e(new Error(ee[ee.WorkflowTimeout]),void 0),H("UseWorkflowCancellation")&&Fe.cancellation.markAsCancelled(Di.Timeout,`Timeout: No response received within ${an} ms`)},an);var Gt=function(ae,j){x.validate("executeWorkflowWithCallback.workflowExecutionDone"),T=!0,ht&&(clearTimeout(ht),ze(function(){var ge,ue,le,Pe;(!ae||j!=null&&j.preserveQueuedOnError||!((ge=j==null?void 0:j.strategy)===null||ge===void 0)&&ge.preserveQueued)&&((ue=Fe.getModel())===null||ue===void 0||ue.commitPendingAnnotations()),A&&(A.success=!ae,ae&&ae instanceof Mo&&(A.success=!0,A.dimension2="ExpectedFailure"),v.info(512336663,y.CoreDefault,A.stop())),ae&&(j!=null&&j.preserveQueuedOnError||!((le=j==null?void 0:j.strategy)===null||le===void 0)&&le.preserveQueued)?(v.info(512336662,y.CoreDefault,`Workflow execution failed and preserving queue, with error: ${ae.message} at ${ae.stack}`),e(void 0,{error:ae.message,isExpectedError:ae instanceof Mo,annotations:L,billingDomainPerExecution:D})):e(ae,{annotations:j!=null&&j.ignoreExecution?void 0:L,ignoreExecution:(Pe=j==null?void 0:j.ignoreExecution)!==null&&Pe!==void 0?Pe:!1,billingDomainPerExecution:D,workflowExecutionGuid:J})},M))},Xe=S(c.sessionKey),Ye=function(){function be(){(0,sk.default)(this,be);var ae,j,ge,ue,le;this.clientMetadata=d,this.userContext=c.userContext,this.blobContext={sessionKey:c.sessionKey,userId:c.userId},this.triggerSignals=f.triggerSignals,this.existingAnnotations=(ae=f.existingAnnotations)===null||ae===void 0?void 0:ae.map(function(Pe){return Pe.body}),this.annotationActivationConfigs=f.annotationActivationConfigs,this.workflowId=u.id,this.sourceInfo=!((ge=q==null?void 0:q.get((j=f.triggerSignals)===null||j===void 0?void 0:j[0]))===null||ge===void 0)&&ge.sourceInfo?q.get(f.triggerSignals[0]).sourceInfo:(le=(ue=f.inputItems)===null||ue===void 0?void 0:ue[0])===null||le===void 0?void 0:le.sourceInfo,this.asyncBoundaryLoader=k,this.callerWorkflowId=f.callerWorkflowId,this.sessionEndpoint={url:Xe.sessionUrl,origin:c.origin},this._model=u.modelOptions?this.createModel():void 0}return(0,uk.default)(be,[{key:"cancellation",get:function(){var j;return(j=this._cancellation)!==null&&j!==void 0||(this._cancellation=new ik),this._cancellation}},{key:"model",get:function(){var j;return(j=this._model)!==null&&j!==void 0||(this._model=this.createModel()),this._model}},{key:"flights",get:function(){var j;return(j=this._flights)!==null&&j!==void 0||(this._flights=fr(this.clientMetadata.flights)),this._flights}},{key:"workflowStore",get:function(){return!this._workflowStoreManager&&C&&(this._workflowStoreManager=C(c.userId,c.sessionKey,this.workflowId)),this._workflowStoreManager}},{key:"chatStore",get:function(){if(!H("EnableChatStore")){v.warn(508851673,y.CoreDefault,"Calling chat store from context while chat store is turned off");return}return this._chatStore||(this._chatStore=new Ky(l,c,x)),this._chatStore}},{key:"getToken",value:function(j,ge){if(T){var ue=`Workflow ${u.id} asking for token ${j} after workflow is complete. Stack ${Error().stack}`;if($A.getValue().indexOf(u.id)===-1){v.error(509141987,y.CoreDefault,ue),ge(new Error(`Cannot provide token ${j} after workflow is complete`),void 0);return}else v.info(507319566,y.CoreDefault,ue)}if(p){var le=function(ot,qe,Ue){var Ut=rd(qe);Ut&&(ot=Ut,qe=void 0),ge(ot,qe,{returnedTokenType:Ue})};return p(u,j,le)}else throw v.error(512336661,y.CoreDefault,`NYI: Workflow service getTokenCallback for workflow ${u.id} is not available.`),new Error("Token callback not available")}},{key:"getTokenAsync",value:function(j){var ge=this;return new Promise(function(ue,le){ge.getToken(j,function(Pe,ot,qe){Pe?le(Pe):ue(Object.assign({},qe,{token:ot}))})})}},{key:"getModel",value:function(){return this._model}},{key:"createModel",value:function(){var j,ge,ue,le,Pe,ot=new nk,qe;F&&(qe=function(bp){q.set(bp.body,bp)});var Ue=new ky(N,Z,qe,k,u.modelSchema,ot,f.truncationContext,void 0,u.modelOptions);if(u.kind!==V.SingleItem)if(f.dynamicContext)if(u.kind===V.DynamicText||u.kind===V.Generic){var Ut=f.dynamicContext;Ue.addItems(Ut.contextAbove,!0),Ue.addItems(f.inputItems),Ue.addItems(Ut.contextBelow,!0)}else throw new Error(`${u.kind} workflow does not support dynamic context`);else Ue.addItems(f.inputItems);else(!((j=u.modelOptions)===null||j===void 0)&&j.includeScopeItemParent||!((ge=u.modelOptions)===null||ge===void 0)&&ge.includeRootItemParent)&&((ue=f.inputItems)===null||ue===void 0?void 0:ue.length)===2&&Ue.addItems([f.inputItems[1]]);return!((le=u.modelOptions)===null||le===void 0)&&le.includeExistingAnnotations&&((Pe=f.existingAnnotations)===null||Pe===void 0||Pe.forEach(function(An){Ue.getItemByReference({referencedPath:An.parentPath}).addAnnotation(An.body)})),Ue.addItems(f.requestedContexts),Ue}}])}(),Fe=new Ye,Pt={setAnnotations:ye,submitSignals:$,overrideWorkflowDefinition:U,getDynamicAnnotations:ke,done:Gt,setBillingDomain:K},Rt;if(u.isStateful&&(Rt=g.getState(u,c.sessionKey,c.userId)),!Rt)try{Rt=u.factory(),u.isStateful&&g.setState(u,c.sessionKey,c.userId,Rt)}catch(be){e(new Error(`workflow ${u.id} instance creation process got error: ${be.message}`),void 0);return}try{if(u.kind===V.SingleItem){if(f.inputItems.length!==1&&f.inputItems.length!==2){v.error(508621079,y.CoreDefault,"Single item workflows expect one or two inputs (second item is the parent item if requested)"),Gt(new Error(ee[ee.InvalidInputQuantityForSingleItemWorkflow]));return}Fe.delta=f.inputItems[0].delta,Fe.deltas=f.inputItems[0].deltas;var mr=f.inputItems[0],vr=mr.body;if(vr&&u.id==="VoiceUxo"&&(vr.seq=(b=vr.seq)!==null&&b!==void 0?b:parseInt(mr==null?void 0:mr.id,10)),FA.getValue()&&!qA.getValue().includes(u.id)&&!u.skipWorkflowItemSequencing&&vr.seq!==void 0){u.id!=="Workflows/Voice"&&v.info(512336659,y.CoreDefault,"WorkflowSequencerEnabled workflow has sequencing with id: "+u.id);try{var yr=g.getBufferingSequencer(u,c.sessionKey,c.userId);yr!==void 0?yield yr.sequence(vr.seq):v.error(512336658,y.CoreDefault,"BufferingSequencer does not exist in cache and was not instantiated")}catch(be){if(v.error(512336657,y.CoreDefault,"Error processing workflow sequence: "+be),H("SkipWorkflowExecutionOnInvalidSeq")){Gt(new Error(ee[ee.SequenceOutOfOrder]));return}}}yield Rt.execute(vr,Fe,Pt)}else if(u.kind===V.DynamicText){if(!Array.isArray(f.inputItems))throw new Error("Dynamic text workflows expect an array of input items");var si=new Ls(f.inputItems.map(function(be){return be.body}));Fe.dynamicTextContext=f.dynamicContext,yield Rt.execute(si,Fe,Pt)}else if(u.kind===V.Reduce){if(!Array.isArray(f.inputItems))throw new Error("Reduce workflows expect an array of input items");var Ap=new Ls(f.inputItems.map(function(be){return be.body}));yield Rt.execute(N.body,Ap,Fe,Pt)}else if(u.kind===V.Grid){var Kt=f.inputContext,_n=[];f.inputItems.slice(0,Kt.numberOfNonEmptyCells).forEach(function(be){if(be&&be.body){var ae=be.body,j=ae.row-Kt.neighborhoodTopRow,ge=ae.column-Kt.neighborhoodLeftColumn;_n[j]||(_n[j]=[]),_n[j][ge]=ae}});var Eu=f.inputItems.slice(Kt.numberOfNonEmptyCells),ui=new Ls(Eu.map(function(be){return be.body}));v.info(512336656,y.CoreDefault,`sending grid to workflow. inputItems length: ${Kt.numberOfNonEmptyCells}; grid context ${JSON.stringify(Kt)}`),yield Rt.execute(N.body,{targetGridRelativeTopRow:Kt.targetGridRelativeTopRow,targetGridRelativeLeftColumn:Kt.targetGridRelativeLeftColumn,cells:_n},ui,Kt,Fe,Pt)}else if(u.kind===V.Join){if(!Array.isArray(f.inputItems))throw new Error("Join workflows expect an array of input items");Fe.delta=N.delta,Fe.deltas=N.deltas;var BT=f.inputItems.map(function(be){return be.body});yield Rt.execute(N.body,BT,Fe,Pt)}else u.kind===V.Generic&&(yield Rt.execute(Fe.model,Fe,Pt))}catch(be){v.error(507589979,y.CoreDefault,`workflow ${u.id} execution error: ${be.message} at ${be.stack}`),Gt(be)}finally{u.isStateful||Rt.dispose()}});return function(M){return _.apply(this,arguments)}}(),void 0,void 0,H("UseWorkflowClientMetadataForCC")?d:void 0,{workflow:u.resourceId,joinContextId:I})};var ud=function(r,e,t,o,a,s,u,l,c,f){return new Promise(function(d,p){ck({workflow:r,workflowMessageHandler:e,executionContext:t,input:o,clientMetadata:a,getTokenCallback:s,stateCache:u,asyncBoundaryLoader:l,getSessionInfo:c,getWorkflowStoreManager:void 0,correlationValidator:f},function(g,k){if(g){p(g);return}d(k)})})};h();var gk=w(P()),hk=w(R());h();h();var fk=w(P()),dk=w(R());var Jo=function(){function n(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;(0,fk.default)(this,n),this.prevSeq=-1,this.bufferingTimeMs=r,this.rejectOutdatedSequenceNumbers=e}return(0,dk.default)(n,[{key:"sequence",value:function(e){var t=this;return new Promise(function(o,a){if(e<t.prevSeq)if(t.rejectOutdatedSequenceNumbers){var s=new Error(`BufferingSequencer: Item out of order. Expecting seqId > ${t.prevSeq}. Actual seqId ${e}`);s.name=n.Rejected,a(s);return}else t.prevSeq=-1;e!=t.prevSeq+1&&v.warn(542712385,y.CoreDefault,`BufferingSequencer: got out of order sequence number. Got ${e}, expected ${t.prevSeq+1}`);var u={seq:e,resolve:o};t.insertItem(u),t.runInOrder(u,!0,!1)})}},{key:"insertItem",value:function(e){if(!this.firstQueueItem){this.firstQueueItem=e,this.lastQueueItem=e;return}var t=this.lastQueueItem,o=null;do{if(e.seq>t.seq){e.prev=t,t.next=e,o?(o.prev=e,e.next=o):this.lastQueueItem=e;return}o=t,t=t.prev}while(t);o&&(o.prev=e),e.next=o,this.firstQueueItem=e}},{key:"runInOrder",value:function(e,t,o){for(var a=this,s=this.prevSeq,u=!1,l=[];this.firstQueueItem;){var c=this.firstQueueItem;if(s+1!=c.seq&&(!o||c.seq>e.seq))break;s=c.seq,c.timeout&&clearTimeout(c.timeout),l.push(c),e==c&&(u=!0),this.firstQueueItem=this.firstQueueItem.next,this.firstQueueItem&&(this.firstQueueItem.prev=null)}l.length>0&&setTimeout(function(){for(var f of l)f.resolve(f.seq)},0),this.prevSeq=s,!u&&t&&(e.timeout=setTimeout(function(){a.runInOrder(e,!1,!0)},this.bufferingTimeMs))}}])}();Jo.Rejected="SequenceItemRejected";var HA=new G("workflowStateCacheSweepInterval",1e3),mk=new G("workflowStateCacheIdleTimeoutMs",3e4),zA=new G("workflowStateCacheIdleTimeoutPerWorkflowMs",{}),VA=new G("sequencerTimeoutInMs",500),QA=function(r){return r.stateExpiryMs||mk.getValue()},pk=function(r,e,t){if(!r)throw new Error("workflowId is undefined");if(!e)throw new Error("sessionKey is undefined");if(!t)throw new Error("userId is undefined");return`${r}-${e}-${t}`},vk=function(){function n(){(0,gk.default)(this,n),this.cache=new Xn({sweepInterval:HA.getValue(),idleDurationMs:mk.getValue(),idleCallback:this.onStateIdle.bind(this)})}return(0,hk.default)(n,[{key:"setState",value:function(e,t,o,a){if(!e){v.error(526952585,y.CoreDefault,"cannot set state for undefined workflow");return}if(!e.isStateful){v.error(526952586,y.CoreDefault,`WorkflowStateCache: Attempting to set state for the stateless workflow ${e.id}`);return}var s=pk(e.id,t,o),u=this.cache.get(s);if(u&&u.state.dispose(),a){var l={cc:ut(),state:a,annotationSequenceGenerator:new cy,bufferingSequencer:new Jo(VA.getValue(),!0)};this.cache.put(s,l,QA(e),this.onStateIdle.bind(this),zA.getValue()[e.id])}else this.cache.del(s)}},{key:"getState",value:function(e,t,o){var a=this.getStateCacheItem(e,t,o);return a==null?void 0:a.state}},{key:"getAnnotationSequenceGenerator",value:function(e,t,o){var a=this.getStateCacheItem(e,t,o);return a==null?void 0:a.annotationSequenceGenerator}},{key:"getBufferingSequencer",value:function(e,t,o){var a=this.getStateCacheItem(e,t,o);return a==null?void 0:a.bufferingSequencer}},{key:"clear",value:function(){this.cache.clear()}},{key:"getStateCacheItem",value:function(e,t,o){if(!e){v.error(526952587,y.CoreDefault,"cannot get state for undefined workflow");return}if(e.isStateful){var a=this.cache.get(pk(e.id,t,o));return a}}},{key:"onStateIdle",value:function(e,t){ze(function(){return t.state.dispose()},t.cc)}}])}();h();var _k=w(P()),Ak=w(R());h();var ba=w(Tn()),Tk=w(P()),Ik=w(R());h();var kk=w(Qe()),js=w($e()),wk=w(Ss()),Sk=w(je()),fo=w(Tn()),ld=w(P()),cd=w(R());function jA(n,r,e){return r=(0,js.default)(r),(0,kk.default)(n,Ck()?Reflect.construct(r,e||[],(0,js.default)(n).constructor):r.apply(n,e))}function Ck(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Ck=function(){return!!n})()}function yk(n,r,e,t){var o=(0,wk.default)((0,js.default)(1&t?n.prototype:n),r,e);return 2&t&&typeof o=="function"?function(a){return o.apply(e,a)}:o}var JA=new G("workflowStoreSweepIntervalMs",1e4),KA=new G("workflowStoreItemExpiryMs",6e5),YA=function(){function n(r,e,t,o,a){if((0,ld.default)(this,n),this.storeType=Yn.WorkflowSession,!e)throw new Error("workflowId is required");if(this.workflowId=e,!t)throw new Error("sessionKey is required");if(this.sessionKey=t,!o)throw new Error("userId is required");if(this.userId=o,!r)throw new Error("instanceId is required");this.instanceId=r,this.cache=new Xn({sweepInterval:JA.getValue()}),this.onWorkflowStoreCleared=a}return(0,cd.default)(n,[{key:"setItem",value:function(){var r=(0,fo.default)(function*(t,o,a,s){var u=this;return new Promise(function(l,c){try{var f=u.getStoreKey(u.workflowId,u.sessionKey,u.userId,t);o?u.cache.put(f,o,s!=null?s:KA.getValue(),u.onItemExpired.bind(u)):u.cache.del(f),l(!0)}catch(d){c(d)}})});function e(t,o,a,s){return r.apply(this,arguments)}return e}()},{key:"getItem",value:function(){var r=(0,fo.default)(function*(t,o){var a=this;return new Promise(function(s,u){var l=a.getStoreKey(a.workflowId,a.sessionKey,a.userId,t),c=a.cache.get(l);s(c)})});function e(t,o){return r.apply(this,arguments)}return e}()},{key:"getStoreKey",value:function(e,t,o,a){return`${e}-${t}-${o}-${a}`}},{key:"clear",value:function(){this.cache.clear(),this.onWorkflowStoreCleared&&this.onWorkflowStoreCleared(this.instanceId,this)}},{key:"onItemExpired",value:function(e,t){this.cache.size()===0&&this.clear()}}])}(),xk=function(n){function r(e,t,o,a,s){return(0,ld.default)(this,r),jA(this,r,[e,t,o,a,s])}return(0,Sk.default)(r,n),(0,cd.default)(r,[{key:"setItem",value:function(){var e=(0,fo.default)(function*(o,a,s,u){var l=this,c=function(){var f=(0,fo.default)(function*(d,p){try{var g=yield yk(r,"setItem",l,3)([o,a,s,u]);if(!g)return p(new Error("Item not set in local cache"));d(g)}catch(k){p(k)}});return function(p,g){return f.apply(this,arguments)}}();return new Promise(c)});function t(o,a,s,u){return e.apply(this,arguments)}return t}()},{key:"getItem",value:function(){var e=(0,fo.default)(function*(o,a){var s=this,u=function(){var l=(0,fo.default)(function*(c,f){try{var d=yield yk(r,"getItem",s,3)([o,a]);if(d)return c(d);c(void 0)}catch(p){f(p)}});return function(f,d){return l.apply(this,arguments)}}();return new Promise(u)});function t(o,a){return e.apply(this,arguments)}return t}()}])}(YA);var fd=function(){function n(r){(0,Tk.default)(this,n);var e;if(!r.userId)throw new Error("userId is required");this.userId=r.userId,this.workflowId=r.workflowId,this.sessionKey=r.sessionKey,this.workflowStores=(e=r.workflowStores)!==null&&e!==void 0?e:new Map,this.onWorkflowStoreCleared=r.workflowStoreClearedCallback}return(0,Ik.default)(n,[{key:"setItem",value:function(){var r=(0,ba.default)(function*(t,o){var a=this,s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Yn.WorkflowSession,u=arguments.length>3?arguments[3]:void 0,l=function(){var c=(0,ba.default)(function*(f,d){try{var p=a.getStoreInstance(s),g=yield p.setItem(t,o,s,u);f(g)}catch(k){d(k)}});return function(d,p){return c.apply(this,arguments)}}();return new Promise(l)});function e(t,o){return r.apply(this,arguments)}return e}()},{key:"getItem",value:function(){var r=(0,ba.default)(function*(t,o){var a=this,s=function(){var u=(0,ba.default)(function*(l,c){try{var f=a.getStoreInstance(o),d=yield f.getItem(t,o);l(d)}catch(p){c(p)}});return function(c,f){return u.apply(this,arguments)}}();return new Promise(s)});function e(t,o){return r.apply(this,arguments)}return e}()},{key:"getStoreInstance",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Yn.WorkflowSession,t,o=`${this.userId}-${this.sessionKey}-${this.workflowId}`;switch(e){case Yn.WorkflowSession:if(!this.sessionKey||!this.workflowId)throw new Error("sessionKey and workflow not set for this instance");t=this.workflowStores.get(o),t||(t=new xk(o,this.workflowId,this.sessionKey,this.userId,this.workflowStoreClearedCallback.bind(this)),this.workflowStores.set(o,t));break;case Yn.User:throw new Error("Workflow Store for user type is not yet implemented");default:throw new Error("Invalid store type")}return t}},{key:"workflowStoreClearedCallback",value:function(e,t){this.workflowStores.delete(e),this.workflowStores.size===0&&this.onWorkflowStoreCleared&&this.onWorkflowStoreCleared(this.userId,this)}}])}();var bk=function(){function n(){(0,_k.default)(this,n),this.workflowStoreRegistry=new Map}return(0,Ak.default)(n,[{key:"getWorkflowStoreManager",value:function(e,t,o){var a=this.workflowStoreRegistry.get(e);return a||(a=new fd({userId:e}),this.workflowStoreRegistry.set(e,a)),new fd({sessionKey:t,workflowId:o,userId:a.userId,workflowStoreClearedCallback:this.workflowStoreClearedCallback.bind(this),workflowStores:a.workflowStores})}},{key:"workflowStoreClearedCallback",value:function(e,t){this.workflowStoreRegistry.delete(e)}}])}();var XA=new G("supportStreamCallback",!1),ZA=new G("workflowsEnabledForFallbackToAugloopToken",[]),eb=new G("workflowDeactivateTokensDisabledWorkflows",["ChangeSummaries","Copywriter","Voice","WritersUnblock"]),tb=function(r,e){switch(r){case st.AutoClpLowPrivilege:return st.AutoClpAppOnlyLowPrivilege;case st.EditorLowPrivilege:return st.EditorAppOnlyLowPrivilege;case st.AugLoopLowPrivilege:return ZA.getValue().includes(e)?st.WacUserInfo:void 0}},nb=function(r){switch(r){case st.IncomingPFT:return st.AugLoopLowPrivilege}},rb=function(r,e,t){var o=nb(r);return t&&!o&&(o=tb(r,e)),o},dr=function(r){return H("BypassModelPerAnnotationType")?r.bypassModel?r.bypassTypes===void 0?!0:xy(r.bypassTypes,r.outputTypes):!1:r.bypassModel},Aa=function(r,e){return H("BypassModelPerAnnotationType")?r.bypassModel&&(r.bypassTypes===void 0||r.bypassTypes.includes(e)):r.bypassModel},Nk=function(){function n(r,e,t,o,a){(0,Mk.default)(this,n),this.correlationValidatorFactory=a,this.workflowRegistry=new Map,this.workflowMessageHandler=r,this.workflowStateCache=new vk,this.workflowStoreRegistry=new bk,this.registerWorkflows(e),this.asyncBoundaryLoaderRegistry=t,this.getSessionInfo=o}return(0,Ek.default)(n,[{key:"onWorkflowLambdaMessage",value:function(){var r=(0,po.default)(function*(t){var o=this.getMessageType(t);if(o==ir.getTypeName()){var a=t.payload?t.payload:t;return this.onWorkflowRequest(a)}if(o==lo.getTypeName()){var s=t.payload?t.payload:t;this.onWorkflowStreamingResults(s)}});function e(t){return r.apply(this,arguments)}return e}()},{key:"onWorkflowRequest",value:function(){var r=(0,po.default)(function*(t){var o=t.payload?t.payload:t,a=o.workflowId;if(!this.workflowRegistry.has(a))throw v.error(526718720,y.CoreDefault,`executeWorkflow workflow id '${a}' not available`),new Error(`executeWorkflow workflow id '${a}' not available`);var s=this.getWorkflowDefinition(t),u=this.createTokensMap(o.tokens),l=this.correlationValidatorFactory.create(t.executionContext.sessionKey),c=function(k,S,C){var x;if(l.validate("WorkflowRuntime.getToken"),u){k.id!=a&&v.warn(526718721,y.CoreDefault,`Workflow ${k.id} is requesting token and we are executing workflow ${a}`);var T=u.get(S);if(T)C(void 0,T,S);else{var I=`Workflow ${k.id} is requesting token ${st[S]} but it is not available`,_=rb(S,a,k.isAppOnlyTokenAllowed),M=u.get(_);M?C(void 0,M,_):_?(I=I+`, try alternate token ${st[_]} but it is not available either`,v.warn(526718722,y.CoreDefault,I),C(new Error(I),void 0)):(v.warn(526718723,y.CoreDefault,I),C(new Error(I),void 0))}}else{var b=`Workflow ${k.id} is requesting token ${st[S]} but tokensMap is undefined, from ${(x=o==null?void 0:o.tokens)===null||x===void 0?void 0:x.length} tokens. `;k.optionalTokenTypes?v.info(526718724,y.CoreDefault,b):v.error(526718725,y.CoreDefault,b),C(new Error(b),void 0)}};try{if(H("executeOneWorkflow")){var f=[];for(var d of o.batchExecutionInputs)f.push(this.executeOneWorkflow(d,o,s,c,l));var p=yield Promise.all(f);return new zo({batchExecutionResults:p})}else return yield this.onWorkflowRequestInternal(o,s,c,l)}finally{H("DataProvenanceClearTokensOnWorkflowCompletion")&&u&&eb.getValue().indexOf(s.id)===-1&&u.clear()}});function e(t){return r.apply(this,arguments)}return e}()},{key:"getWorkflowDefinition",value:function(e){var t=this.workflowRegistry.get(e.workflowId);return e.executionContext.appliedWorkflowOverrides&&v.info(507543837,y.CoreDefault,`Overriding workflow definition for workflow ${e.workflowId} with ${JSON.stringify(e.executionContext.appliedWorkflowOverrides)}`),Object.assign({},t,e.executionContext.appliedWorkflowOverrides)}},{key:"getMessageType",value:function(e){return e.payload?m.getTypeNameFor(e.payload):m.getTypeNameFor(e)}},{key:"onWorkflowStreamingResults",value:function(e){this.workflowMessageHandler.onWorkflowStreamingResults(e)}},{key:"executeOneWorkflow",value:function(){var r=(0,po.default)(function*(t,o,a,s,u){var l=this;return yield kn((0,po.default)(function*(){var c;try{return yield ud({workflow:a,workflowMessageHandler:l.workflowMessageHandler,executionContext:o.executionContext,input:t,clientMetadata:o.clientMetadata,getTokenCallback:s,stateCache:l.workflowStateCache,asyncBoundaryLoader:l.createAsyncBoundaryLoader(o,(c=a==null?void 0:a.modelOptions)===null||c===void 0?void 0:c.asyncBoundaryLoaderType,t),getSessionInfo:l.getSessionInfo,getWorkflowStoreManager:l.workflowStoreRegistry.getWorkflowStoreManager.bind(l.workflowStoreRegistry),correlationValidator:u})}catch(f){return{error:f.message,isExpectedError:f instanceof Mo}}}))});function e(t,o,a,s,u){return r.apply(this,arguments)}return e}()},{key:"onWorkflowRequestInternal",value:function(){var r=(0,po.default)(function*(t,o,a,s){var u=this,l=[],c=function*(g){kn(function(){var k=function(){var S=(0,po.default)(function*(){var C;try{var x=yield ud({workflow:o,workflowMessageHandler:u.workflowMessageHandler,executionContext:t.executionContext,input:g,clientMetadata:t.clientMetadata,getTokenCallback:a,stateCache:u.workflowStateCache,asyncBoundaryLoader:u.createAsyncBoundaryLoader(t,(C=o==null?void 0:o.modelOptions)===null||C===void 0?void 0:C.asyncBoundaryLoaderType,g),getSessionInfo:u.getSessionInfo,getWorkflowStoreManager:u.workflowStoreRegistry.getWorkflowStoreManager.bind(u.workflowStoreRegistry),correlationValidator:s});return x}catch(T){return{error:T.message,isExpectedError:T instanceof Mo}}});return function(){return S.apply(this,arguments)}}();l.push(k())})};for(var f of t.batchExecutionInputs)yield*Co(c(f));var d=yield Promise.all(l);return new zo({batchExecutionResults:d})});function e(t,o,a,s){return r.apply(this,arguments)}return e}()},{key:"registerWorkflow",value:function(e){this.workflowRegistry.set(e.id,e),XA.getValue()?this.workflowMessageHandler.setWorkflowRequestCallback(e,this.onWorkflowLambdaMessage.bind(this)):this.workflowMessageHandler.setWorkflowRequestCallback(e,this.onWorkflowRequest.bind(this))}},{key:"close",value:function(){this.workflowStateCache.clear()}},{key:"getRegisteredWorkflows",value:function(){return Array.from(this.workflowRegistry.values())}},{key:"registerWorkflows",value:function(e){var t=this;e.forEach(function(o){t.registerWorkflow(o)})}},{key:"createTokensMap",value:function(e){if(!(!Array.isArray(e)||e.length===0)){if(e.length%2!==0){v.error(526718728,y.CoreDefault,"token information array contains odd number of items, it should be even for token id/value pairs");return}for(var t=new Map,o=0;o<e.length;o+=2){var a=st[e[o]];t.set(a,e[o+1])}return t}}},{key:"createAsyncBoundaryLoader",value:function(e,t,o){var a;if(!((a=this.asyncBoundaryLoaderRegistry)===null||a===void 0)&&a.has(t))return this.asyncBoundaryLoaderRegistry.get(t)(e,this.workflowMessageHandler.onWorkflowModelRequest.bind(this.workflowMessageHandler),o,this.workflowMessageHandler.onFetchRangeFromCacheRequest.bind(this.workflowMessageHandler))}}])}();h();var Dk;(function(n){n.SyncMessageProcessing="SyncMessageProcessing",n.ItemChangesTriggeredWorkflow="ItemChangesTriggeredWorkflow",n.ContextChangesTriggeredWorkflow="ContextChangesTriggeredWorkflow",n.ScheduleWorkflowExecution="ScheduleWorkflowExecution"})(Dk||(Dk={}));var te;(function(n){n.SynchronizeMessage="SynchronizeMessage",n.ApplyNextSequence="ApplyNextSequence",n.InvalidateWorkflow="InvalidateWorkflow",n.EvaulatePrefilters="EvaulatePrefilters",n.AddScopeGroupedParameters="AddScopeGroupedParameters",n.WorkflowExecution="WorkflowExecution",n.SendWorkflowRequest="SendWorkflowRequest",n.SendWorkflowRequestSync="SendWorkflowRequestSync",n.QueueWorkflow="QueueWorkflow",n.WaitingInWorkflowQueue="WaitingInWorkflowQueue",n.ExecutionTrackerInvalidate="ExecutionTracker.Invalidate",n.SetScopeExecutionNotification="SetScopeExecutionNotification",n.WorkflowRegistrationQueueTask="WorkflowRegistration.QueueTask",n.ResolveAndValidateAllRequestedContexts="ResolveAndValidateAllRequestedContexts",n.QueueOrSetScopeExecutionNotification="QueueOrSetScopeExecutionNotification",n.ValidateWorkflowExecution="ValidateWorkflowExecution",n.QueueExecutionNotification="QueueExecutionNotification",n.QueueGridNeighborhoodWorkflow="QueueGridNeighborhoodWorkflow",n.SyncMessageSequencerSendResponse="SyncMessageSequencerSendResponse",n.WaitingInDebounceQueue="WaitingInDebounceQueue",n.WaitingForPendingScopeExecution="WaitingForPendingScopeExecution",n.InvalidateHybridSingleItemWorkflow="InvalidateHybridSingleItemWorkflow",n.ProcessWorkflowResponse="ProcessWorkflowResponse",n.ProcessAnnotationQueue="ProcessAnnotationQueue",n.ProcessAnnotationQueueSync="ProcessAnnotationQueueSync",n.ConsolidateAnnotationQueue="ConsolidateAnnotationQueue",n.PersistAnnotationQueueStateless="PersistAnnotationQueue.Stateless",n.PersistAnnotationQueueStateful="PersistAnnotationQueue.Stateful",n.CommitAnnotations="CommitAnnotations",n.SendAnnotations="SendAnnotations",n.SendAnnotationsSync="SendAnnotationsSync",n.WaitingForInOrderMessage="WaitingForInOrderMessage",n.PrepareSequencedOperations="PrepareSequencedOperations",n.GridSplitterSplit="GridSplitter.Split",n.TableBoundaryGridSplitterSplit="TableBoundaryGridSplitter.Split",n.WaitingInSynchronizationQueue="WaitingInSynchronizationQueue",n.SynchronizeWorkflowTask="SynchronizeWorkflowTask",n.SynchronizeWorkflowTasks="SynchronizeWorkflowTasks",n.PostponeWorkflowTask="PostponeWorkflowTask"})(te||(te={}));var Fk=w(Pn());function ob(n,r,e){return r=(0,dd.default)(r),(0,Wk.default)(n,Lk()?Reflect.construct(r,e||[],(0,dd.default)(n).constructor):r.apply(n,e))}function Lk(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Lk=function(){return!!n})()}var ib=function(r,e){var t=r.map(e);return r.filter(function(o,a){return t.indexOf(t[a])===a})},ab=function(r,e){var t=r.map(e);return r.filter(function(o,a){return t.lastIndexOf(t[a])===a})},Js=function(n){function r(e){var t;return(0,Rk.default)(this,r),t=ob(this,r),t.session=e,t}return(0,Ok.default)(r,n),(0,Bk.default)(r,[{key:"processAnnotationQueue",value:function(t,o){if(Array.isArray(o)){var a=Q(),s=a.start(te.ProcessAnnotationQueue),u=a.startSync(te.ProcessAnnotationQueueSync),l=new Le({sessionHealthEventName:"ProcessAnnotationQueue",success:!0,source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,resourceId:t.resourceId,count:0,message:"",affectedWorkflows:[t.resourceId]}).start();try{for(var c of o)if(Array.isArray(c.annotationQueue)){H("fasterConsolidateAnnotationQueue")?c.annotationQueue=this.consolidateAnnotationQueue(c.annotationQueue):this.consolidateAnnotationQueue(c.annotationQueue);for(var f of c.annotationQueue)if(Array.isArray(f.annotations))for(var d of f.annotations)l.count++,d.ownerId=t.id}a.stop(u),this.emit("onBeforeAnnotationsPersisted",t,o),this.persistAnnotationQueue(t,o,l),v.info(529093132,y.CoreDefault,l.stop())}catch(p){a.stop(u),l.success=!1,l.dimension0=ee[ee.ApplyAnnotationsException],l.resultDescription=p.message,v.error(529093133,y.CoreDefault,l.stop()),v.error(529093134,y.CoreDefault,`${l.sessionHealthEventName} ${p.stack}`)}Q().stop(s)}}},{key:"consolidateAnnotationQueue",value:function(t){if(t.length<2)return t;var o=Q().startSync(te.ConsolidateAnnotationQueue);if(H("fasterConsolidateAnnotationQueue")){for(var a=!1,s=0;s<t.length;s++)if(t[s].ancestorType){a=!0;break}if(!a){var u;return H("reverseUniqby")?u=ab(t,function(k){return`${z(k.path)}-${k.annotationType}`}):(t.reverse(),u=ib(t,function(k){return`${z(k.path)}-${k.annotationType}`}),u.reverse()),Q().stop(o),u}}for(var l=new Map,c=0;c<t.length;){var f=t[c],d=`${z(f.path)}-${f.annotationType}`,p=l.get(d);if(p!==void 0){if(f.ancestorType){var g;(g=t[p].annotations).push.apply(g,(0,Pk.default)(f.annotations))}else t[p]=f;t.splice(c,1)}else l.set(d,c),c++}return Q().stop(o),t}},{key:"generateAnnotationAddOps",value:function(t,o,a,s,u){if(s.length>0){var l=new we({parentPath:t,items:s});o&&(l.parentRevId=o),a&&(l.isTriggeredBySyncDelta=a),u.push(l),this.session.stats.annotationsAdded+=s.length}}},{key:"generateAnnotationUpdateOps",value:function(t,o,a,s,u){if(s.length>0){var l=new Oe({parentPath:t,items:s});o&&(l.parentRevId=o),a&&(l.isTriggeredBySyncDelta=a),u.push(l),this.session.stats.annotationsUpdated+=s.length}}},{key:"generateAnnotationDeleteOps",value:function(t,o,a,s,u,l){if(u.length>0){var c=new Array(u.length),f=0,d=function(S){c[f++]={id:S.id,parentPath:o,contextId:S.contextId},v.debug(529093135,y.CoreDefault,function(){return`Deleting annotation ${S.id} (type: ${m.getTypeNameFor(S.body)}, workflow: ${t.id})`})};for(var p of u)d(p);var g=new He({parentPath:o,items:c});a&&(g.parentRevId=a),s&&(g.isTriggeredBySyncDelta=s),l.push(g),this.session.stats.annotationsDeleted+=c.length}}}])}(Fk.EventEmitter);h();var qk=w(Se());var sb=[me.CursorUpdate,me.FormattingUpdate,me.OtherNonContentUpdate];function $k(n,r,e){var t=new E({operationName:"ApplyTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();try{if(!r){t.success=!1,t.resultDescription="Unable to apply text tile delta, parent tile is undefined",v.info(538798173,y.CoreDefault,t.stop());return}if(m.getTypeNameFor(r)!==nt.getTypeName()){t.success=!1,t.resultDescription=`Unable to apply text tile delta, parent tile is not proper type: expected ${ur.getTypeName()}, received ${m.getTypeNameFor(r)}`,v.info(538798174,y.CoreDefault,t.stop());return}var o=r,a=n,s=o.content,u="";if(a.position===void 0||a.position<0){t.success=!1,t.resultDescription="Unable to apply text tile delta, invalid text tile position",v.info(538798175,y.CoreDefault,t.stop());return}switch(a.deltaType){case me.Add:a.position<s.length?u=`${s.slice(0,a.position)}${a.content}${s.slice(a.position,s.length)}`:u=s+a.content;break;case me.Update:!a.content&&a.unit===Ke.Sentence&&(t.dimension0="1"),u=`${s.slice(0,a.position)}${a.content}${s.slice(a.position+(a.length||0),s.length)}`;break;case me.Delete:u=`${s.slice(0,a.position)}${s.slice(a.position+(a.length||0),s.length)}`}return v.info(538837071,y.CoreDefault,t.stop()),new nt({content:u})}catch(l){t.success=!1,t.resultDescription=`Error applying text tile delta: ${l}`,v.info(538798176,y.CoreDefault,t.stop());return}}function Gk(n,r,e){var t,o,a,s,u,l,c,f,d=new E({operationName:"ApplyFormattedTextTileDeltaForLocalWorkflows",dimension0:"0",success:!0}).start();d.clientFlights=e;try{if(!r){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, parent tile is undefined",v.info(538798177,y.CoreDefault,d.stop());return}if(m.getTypeNameFor(r)!==gt.getTypeName()){d.success=!1,d.resultDescription=`Unable to apply formatted text tile delta, parent tile is not proper type: expected ${gt.getTypeName()}, received ${m.getTypeNameFor(r)}`,v.info(538798178,y.CoreDefault,d.stop());return}var p=r,g=n,k=p.content,S="";if((g.position===void 0||g.position<0)&&!pd(g.deltaType)){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, invalid text tile position",v.info(538798179,y.CoreDefault,d.stop());return}else if(g.content===void 0&&!pd(g.deltaType)){d.success=!1,d.resultDescription="Unable to apply formatted text tile delta, non-delete, non-formatting, non-other-non-content-update and non-cursor-update operation without content defined",v.info(538798208,y.CoreDefault,d.stop());return}if(g.deltaType===me.Add&&g.length!==0?v.info(538798209,y.CoreDefault,new E({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta add operation with delta length, expected length 0",success:!0})):pd(g.deltaType)&&g.content!==void 0&&v.info(538798210,y.CoreDefault,new E({operationName:"ApplyDeltaChecks",resultDescription:"Received formatted text tile delta delete or non-content related operation with content defined, expected undefined",success:!0})),Uk(g.deltaType)){if(g.deltaType===me.CursorUpdate)return new gt(Object.assign(Object.assign({},p),{ipPosition:(c=g.cursorData)===null||c===void 0?void 0:c.ipPosition,isColdIp:(f=g.cursorData)===null||f===void 0?void 0:f.isColdIp}));if(g.deltaType===me.FormattingUpdate)return new gt(Object.assign(Object.assign({},p),{formattedRanges:g.formattedRanges}));if(g.deltaType===me.OtherNonContentUpdate){var b,A={};for(b in g.otherNonContentData)A[b]=g.otherNonContentData[b];return new gt(Object.assign(Object.assign({},p),A))}}else{var C=ub(p.formattedRanges,g.deltaType,g.position),x=p.formattedRanges?(0,qk.default)(p.formattedRanges):[],T=C?x.indexOf(C):-1;T!==-1&&(g.position+(g.length||0)>C.start+C.length?C.length=g.position+((t=g.content)!==null&&t!==void 0?t:"").length-C.start:C.length+=((o=g.content)!==null&&o!==void 0?o:"").length-(g.length||0),x[T]=C);var I=p.ipPosition;switch(g.deltaType){case me.Add:g.position<k.length?S=`${k.slice(0,g.position)}${g.content}${k.slice(g.position,k.length)}`:S=k+g.content,I=g.position+g.length;break;case me.Update:!g.content&&g.unit===Ke.Sentence&&(d.dimension0="1"),S=`${k.slice(0,g.position)}${g.content}${k.slice(g.position+((a=g.length)!==null&&a!==void 0?a:0),k.length)}`,I=g.position+g.content.length;break;case me.Delete:S=`${k.slice(0,g.position)}${k.slice(g.position+((s=g.length)!==null&&s!==void 0?s:0),k.length)}`,I=g.position;break}for(var _ of x.slice(T+1))_.start<g.position||(g.position+(g.length||0)>_.start?(_.length=_.start+_.length-(g.position+(g.length||0)),_.start=g.position+((u=g.content)!==null&&u!==void 0?u:"").length):_.start+=((l=g.content)!==null&&l!==void 0?l:"").length-(g.length||0));x=x.filter(function(N){return N.length>0});var M=new gt(Object.assign(Object.assign({},p),{ipPosition:I,content:S,formattedRanges:x,queryRange:g.queryRange}));return v.info(538837073,y.CoreDefault,d.stop()),M}return}catch(N){d.success=!1,d.resultDescription=`Error applying formatted text tile delta: ${N}`,v.info(538798211,y.CoreDefault,d.stop());return}}function ub(n,r,e){var t=new E({operationName:"FindRangeForDelta",success:!0});if(t.start(),!n){t.resultDescription="No formatted ranges found within the tile, skipping.",v.info(538798212,y.CoreDefault,t.stop());return}if(r===me.Add){var o=n.find(function(s){return s.start===e&&s.length===0});if(o)return t.resultDescription=`Found a zero-length formatted range for add operation with start ${o.start}.`,v.info(538798213,y.CoreDefault,t.stop()),o;e=Math.max(e-1,0)}var a=n.find(function(s){return s.length===0?s.start===e:s.start<=e&&e<s.start+s.length});return a?(t.resultDescription=`Updating formatted range for operation with start: ${a.start} and length: ${a.length}`,v.info(538798214,y.CoreDefault,t.stop())):(t.resultDescription=`Unable to find formatted range for operation at position ${e}, skipping.`,v.info(538798215,y.CoreDefault,t.stop())),a}function Uk(n){return sb.indexOf(n)!==-1}function pd(n){return Uk(n)||me.Delete===n}h();var Hk=w(P()),zk=w(R());h();var On=function(r,e,t){var o=r.get(e);return o||(o=t(),r.set(e,o)),o},Ma=function(r){return{id:r.id,kind:r.kind,visibility:r.visibility,collectionScopeType:r.collectionScopeType,inputTypes:r.inputTypes,outputTypes:r.outputTypes,correlatedSignals:r.correlatedSignals}},br=function(r){return Array.isArray(r.correlatedSignals)&&r.correlatedSignals.length>0};var Ea=function(r,e){return r==null||e==null?!1:r.length>0&&(r===e||e.indexOf(r)===0&&e.charAt(r.length)===".")},rn=function(r){return Array.isArray(r.triggerSignals)&&r.triggerSignals.length>0},Na=function(r){var e,t;return(t=(e=r.triggerConditions)===null||e===void 0?void 0:e.includes(Vt.NonExclusiveTriggerSignals))!==null&&t!==void 0?t:!1},Da=function(r){return!(r.minDelayMs===void 0&&r.maxDelayMs===void 0)},gd=function(r){var e;return(e=r.triggerConditions)===null||e===void 0?void 0:e.includes(Vt.UpstreamWorkflowsReady)};var Ks=function(){function n(){(0,Hk.default)(this,n),this.workflowDefByWorkflowAndContextId=new Map,this.workflowDefByWorkflow=new Map}return(0,zk.default)(n,[{key:"mergeWorkflowDefinition",value:function(e,t,o){if(o){var a=On(this.workflowDefByWorkflowAndContextId,e.id,function(){return new Map});a.set(o,n.mergeDefinitions(e,a.get(o),t))}else this.workflowDefByWorkflow.set(e.id,n.mergeDefinitions(e,this.workflowDefByWorkflow.get(e.id),t))}},{key:"getWorkflowDefinition",value:function(e,t){var o,a;return t&&(a=(o=this.workflowDefByWorkflowAndContextId.get(e.id))===null||o===void 0?void 0:o.get(t)),a||(a=this.workflowDefByWorkflow.get(e.id)),a||(a=e),a}},{key:"deleteWorkflowDefinition",value:function(e,t){var o=this.workflowDefByWorkflowAndContextId.get(e.id);o&&(o.delete(t),o.size===0&&this.workflowDefByWorkflowAndContextId.delete(e.id))}}],[{key:"mergeDefinitions",value:function(e,t,o){return Object.assign(Object.assign(Object.assign({},e),t),o)}}])}();h();var Ys=function(r,e){var t;return!(e.maxEventAge&&Date.now()-r.timestamp>e.maxEventAge||e.includedTypes&&!e.includedTypes.includes(r.type)||!((t=e.excludedTypes)===null||t===void 0)&&t.includes(r.type))};h();var go=w(dt()),ho=w(Se()),Zk=w(P()),ew=w(R());h();h();var Vk=w(P()),Qk=w(R());var jk=function(){function n(){(0,Vk.default)(this,n)}return(0,Qk.default)(n,[{key:"generateDelta",value:function(e,t,o){var a=m.getTypeNameFor(e),s=m.getTypeNameFor(t);if(a!==s)throw new Error(`Tile types must be same. NewTile type: '${m.getTypeNameFor(e)}', OldTile type '${m.getTypeNameFor(t)}'.`);var u=new Set(o==null?void 0:o.changes);return(a===nt.getTypeName()||m.getBaseTypesFor(e).includes(nt.getTypeName()))&&this.setChangesForTextTile(e,t,u),(a===gt.getTypeName()||m.getBaseTypesFor(e).includes(gt.getTypeName()))&&this.setChangesForFormattedTextTile(e,t,u),new Hn({changes:Array.from(u)})}},{key:"setChangesForTextTile",value:function(e,t,o){e.content!==t.content&&o.add(kr.ContentChanged),t.content||o.add(kr.ContentWasEmpty)}},{key:"setChangesForFormattedTextTile",value:function(e,t,o){var a=this.areFormattedTextTilesDifferent(e,t);a&&o.add(kr.FormattingChanged),(t.isInsideTable||t.isInsideTOC)&&o.add(kr.ContentWasInsideOfTheTable)}},{key:"areFormattedTextTilesDifferent",value:function(e,t){return e.indentation!==t.indentation||e.rightIndentation!==t.rightIndentation||e.outlineLevel!==t.outlineLevel||e.listType!==t.listType||e.alignment!==t.alignment||e.isInsideTable!==t.isInsideTable||e.isInsideTOC!==t.isInsideTOC||e.spacingBeforeParagraph!==t.spacingBeforeParagraph||e.spacingAfterParagraph!==t.spacingAfterParagraph||e.lineSpacing!==t.lineSpacing||e.listId!==t.listId||e.bulletAndNumberFontSize!==t.bulletAndNumberFontSize||e.bulletAndNumberFontFamily!==t.bulletAndNumberFontFamily||e.specialIndentType!==t.specialIndentType||e.specialIndentBy!==t.specialIndentBy||e.fontKerning!==t.fontKerning||this.areFormattedRangesChanged(e.formattedRanges,t.formattedRanges)}},{key:"areFormattedRangesChanged",value:function(e,t){var o,a,s=(o=e==null?void 0:e.length)!==null&&o!==void 0?o:0,u=(a=t==null?void 0:t.length)!==null&&a!==void 0?a:0;if(s!==u)return!0;for(var l=0;l<s;l++)if(this.areFormattedRangesDifferent(e[l],t[l]))return!0;return!1}},{key:"areFormattedRangesDifferent",value:function(e,t){return!e||!t?!t!=!e:e.isDeleted!==t.isDeleted||e.fontFamily!==t.fontFamily||e.fontWeight!==t.fontWeight||e.fontSize!==t.fontSize||e.italic!==t.italic||e.underline!==t.underline||e.capitalization!==t.capitalization||e.color!==t.color||e.highlightColor!==t.highlightColor||e.styleName!==t.styleName||e.isFollowUp!==t.isFollowUp||e.link!==t.link||e.isReference!==t.isReference||e.languageId!==t.languageId||e.objectType!==t.objectType}}])}();var Jk=function(){return new Map([[Hn.getTypeName(),new jk]])};h();var Kk=w(P()),Yk=w(R());var Xk=function(){function n(){(0,Kk.default)(this,n),this.changesByInputKey=new Map,this.changesByWorkflowExecutionKey=new Map}return(0,Yk.default)(n,[{key:"removeInputChanges",value:function(e,t){var o=this.changesByInputKey.get(e);if(o===void 0)throw new Error(`InputKey '${e}' not found.`);o.delete(t),o.size===0&&this.changesByInputKey.delete(e);var a=this.changesByWorkflowExecutionKey.get(t);if(a===void 0)throw new Error(`WorkflowExecutionKey '${t}' not found.`);a.delete(e),a.size===0&&this.changesByWorkflowExecutionKey.delete(t)}},{key:"getInputChanges",value:function(e,t){var o=this.changesByInputKey.get(e),a=o==null?void 0:o.get(t);return a}},{key:"getInputChangesByWorkflowExecutionKey",value:function(e){var t=this.changesByWorkflowExecutionKey.get(e);return t?Array.from(t):void 0}},{key:"getInputChangesByInputKey",value:function(e){var t=this.changesByInputKey.get(e);return t?Array.from(t):void 0}},{key:"setInputChangesByInputKey",value:function(e,t){var o=On(this.changesByInputKey,e,function(){return new Map});for(var a of o.keys())o.set(a,t),On(this.changesByWorkflowExecutionKey,a,function(){return new Map}).set(e,t);return Array.from(o.keys())}},{key:"setInputChanges",value:function(e,t,o){On(this.changesByInputKey,e,function(){return new Map}).set(t,o),On(this.changesByWorkflowExecutionKey,t,function(){return new Map}).set(e,o)}}])}();var tw=function(){function n(r,e){(0,Zk.default)(this,n),this.sessionCache=r,this.inputChangesTracker=e!=null?e:new Xk,this.itemDeltaGenerators=Jk()}return(0,ew.default)(n,[{key:"getChanges",value:function(e,t){var o=this,a=z([e].concat((0,ho.default)(t))),s=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(a);if(s){var u=s.map(function(l){var c=(0,go.default)(l,2),f=c[0],d=c[1],p=Bn(f),g=p.pop();return o.inputChangesTracker.setInputChanges(f,a,Object.assign(Object.assign({},d),{canReset:!0})),{id:g,parentPath:p,delta:d.delta,op:d.op}});return u}}},{key:"applyChanges",value:function(e){var t=this,o=new E({operationName:"InputChangesManagerApplyChanges",success:!0}).start();e.forEach(function(a){var s=m.getTypeNameFor(a);switch(s){case Oe.getTypeName():t.markItemsAsModified(a.items,a.parentPath);break;case He.getTypeName():t.markItemsAsDeleted(a.items,a.parentPath);break;case mn.getTypeName():t.markItemsAsDeleted(a.items,a.prevParentPath);break;default:break}}),o.stop().durationMs>10&&v.info(527523975,y.CoreDefault,o)}},{key:"setWorkflowInputs",value:function(e,t,o){var a=this,s,u=z([t].concat((0,ho.default)(o))),l=(s=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(u))!==null&&s!==void 0?s:[];l.forEach(function(T){var I=(0,go.default)(T,2),_=I[0],M=I[1];return a.inputChangesTracker.removeInputChanges(_,u)});for(var c=0,f=0;c<e.length||f<l.length;)if(l[f]!==void 0&&e[c]!==void 0){var d=(0,go.default)(l[f],2),p=d[0],g=d[1],k=z(e[c].path);(g==null?void 0:g.op)===St.Deleted?(this.inputChangesTracker.setInputChanges(p,u,g),f++):p===k?(this.inputChangesTracker.setInputChanges(p,u,g),f++,c++):(this.inputChangesTracker.setInputChanges(k,u,{op:St.Added,deltaType:e[c].deltaType,canReset:!0}),c++)}else if(l[f]!==void 0){var S=(0,go.default)(l[f],2),C=S[0],x=S[1];this.inputChangesTracker.setInputChanges(C,u,x),f++}else this.inputChangesTracker.setInputChanges(z(e[c].path),u,{op:St.Added,deltaType:e[c].deltaType,canReset:!0}),c++}},{key:"resetChanges",value:function(e,t){var o=this,a,s=z([e].concat((0,ho.default)(t)));(a=this.inputChangesTracker.getInputChangesByWorkflowExecutionKey(s))===null||a===void 0||a.forEach(function(u){var l=(0,go.default)(u,2),c=l[0],f=l[1];if(f.canReset)switch(f.op){case St.Deleted:o.inputChangesTracker.removeInputChanges(c,s);break;case St.Added:case St.Updated:o.inputChangesTracker.setInputChanges(c,s,{op:St.None,deltaType:f.deltaType,canReset:!0});break;default:break}})}},{key:"markItemsAsModified",value:function(e,t){var o=this;e.forEach(function(a){var s=z([].concat((0,ho.default)(t),[a.id])),u=o.inputChangesTracker.getInputChangesByInputKey(s),l=o.memoizeGetItem([].concat((0,ho.default)(t),[a.id]));u==null||u.forEach(function(c){var f=(0,go.default)(c,2),d=f[0],p=f[1];if(p.op===St.None||p.op===St.Updated){var g=o.itemDeltaGenerators.get(p.deltaType);if(g){var k=l();p.delta=g.generateDelta(a.body,k.body,p.delta)}p.op=St.Updated}o.inputChangesTracker.setInputChanges(s,d,{op:p.op,deltaType:p.deltaType,delta:p.delta,canReset:!1})})})}},{key:"memoizeGetItem",value:function(e){var t=this,o=void 0,a=!1;return function(){return a||(o=t.sessionCache.getItem(e),a=!0),o}}},{key:"markItemsAsDeleted",value:function(e,t){var o=this;e.forEach(function(a){o.inputChangesTracker.setInputChangesByInputKey(z([].concat((0,ho.default)(t),[a.id])),{op:St.Deleted,canReset:!1})})}}])}();h();var nw=w(P()),rw=w(R());var Pa=new Set([we.getTypeName(),Oe.getTypeName(),it.getTypeName(),At.getTypeName()]),Ft=function(){function n(r,e){(0,nw.default)(this,n),this.nextId=1,this.runtimeKind=r,this.workflowGraph=e}return(0,rw.default)(n,[{key:"applyContextIdOnOperations",value:function(e){for(var t of e){var o=m.getTypeNameFor(t);if(this.isSupportedOperation(o))for(var a of t.items){if(!a.contextId){a.contextId=this.addNewContextId();continue}if(a.source&&this.workflowGraph.getWorkflow(a.source,!1)){a.contextId=this.addNewContextId(a.contextId);continue}this.tryLogMessage(new E({operationName:"ApplyContextIdOnOperations",success:!0}).start(),"Item with a contextId but without a workflow source atribute")}}}},{key:"addNewContextId",value:function(e){var t=`${this.runtimeKind}${this.nextId++}`;return e?`${e}.${t}`:t}},{key:"isSupportedOperation",value:function(e){return Pa.has(e)}},{key:"tryLogMessage",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;e&&(e.success=o,e.resultDescription=t,v.verbose(527308633,y.CoreDefault,e.stop()))}}],[{key:"isParentContextId",value:function(e,t){return Ea(e,t)}}])}(),xe;(function(n){n[n.Idle=1]="Idle",n[n.Pending=2]="Pending",n[n.Running=3]="Running",n[n.Executed=4]="Executed"})(xe||(xe={}));h();var oM=w(Se()),IS=w(P()),_S=w(R());h();var ei=w(dt()),It=w(Se()),yS=w(P()),kS=w(R()),wS=w(Qe()),Bd=w($e()),SS=w(je());var xS=w(Pn());h();var lw=w(dt()),Ko=w(Se()),cw=w(P()),fw=w(R()),dw=w(Qe()),yd=w($e()),pw=w(je());var kd=w(zi());h();var ow=w(Qe()),hd=w($e()),iw=w(je()),md=w(P()),vd=w(R());var sw=w(Pn());function lb(n,r,e){return r=(0,hd.default)(r),(0,ow.default)(n,aw()?Reflect.construct(r,e||[],(0,hd.default)(n).constructor):r.apply(n,e))}function aw(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(aw=function(){return!!n})()}var cb=new G("sequencerTimeoutWhenNotWaitingSeedCompleteInMs",5e3),fb=new G("sequencerTimeoutWhenWaitingOnSeedCompleteInMs",3e4),db=new G("sequencerTimeoutWhenWaitingOnGroupCompleteInMs",3e4),pb=new G("sequencerMaxQueueLength",1e3),gb=new G("sequencerAcceptedTimeout",100),hb=new G("sequencerLostMessageTimeout",305e3),mb=new G("seedMessageErrors1",!0),vb=new G("seedMessageErrors2",!1),yb=new G("syncErrorOnSessionClose",!0),Ra=new G("allowDelayedSeedMessage",!1),Mr;(function(n){n[n.Syncronous=0]="Syncronous",n[n.Asyncronous=1]="Asyncronous",n[n.Abandoned=2]="Abandoned"})(Mr||(Mr={}));var mo;(function(n){n[n.NotStarted=0]="NotStarted",n[n.Incomplete=1]="Incomplete",n[n.Finished=2]="Finished"})(mo||(mo={}));var vo;(function(n){n[n.Complete=0]="Complete",n[n.FailedTimeout=1]="FailedTimeout",n[n.FailedSessionClose=2]="FailedSessionClose"})(vo||(vo={}));var kb=function(){function n(r,e,t){(0,md.default)(this,n),this.sequencer=r,this.healthEvent=new Le({sessionHealthEventName:"QueueAndApplySyncMessage",source:Ie.Core,reason:de.Unknown,impact:_e.MissingInput,success:!0,message:`seq=${e.seq}`,resourceId:e.seq<=0?"Seeding":"NonSeeding",dimension0:Mr[Mr.Syncronous]}).start(),this.cc=ut(),this.done=t,this.syncMessage=e,this.acceptanceTimeout=setTimeout(this.onAcceptanceTimeout.bind(this),gb.getValue()),this.lostMessageTimeout=setTimeout(this.onLostMessageTimeout.bind(this),hb.getValue())}return(0,vd.default)(n,[{key:"onAcceptanceTimeout",value:function(){this.done(void 0,new cn),this.acceptanceTimeout=void 0}},{key:"onLostMessageTimeout",value:function(){this.lostMessageTimeout=void 0,this.healthEvent.success=!1,this.healthEvent.message+=" Message Lost",this.healthEvent.dimension1=Me[Me.SyncMessageLost],v.info(537002506,y.CoreDefault,this.healthEvent.stop())}},{key:"apply",value:function(){var e=this,t;try{v.verbose(537002519,y.CoreDefault,function(){return`SyncMessageSequencer.applySyncMessage: Applying SyncMessage. seq ${e.syncMessage.seq}, operations count = ${e.syncMessage.ops.length}`}),this.sequencer.emit("applyingSeq",this.syncMessage.seq);var o=Q();o.markForLogging(),this.sequencer.applyMessageCallback(this.syncMessage,this.onCompleted.bind(this))}catch(s){var a=(t=s==null?void 0:s.stack)!==null&&t!==void 0?t:"";v.info(507069856,y.CoreDefault,a),this.healthEvent.message+=` ${a}`,this.onCompleted(new X({error:"Failed to commit",code:Me.SyncMessageException}))}}},{key:"onCompleted",value:function(e,t){var o=this;ze(function(){o.lostMessageTimeout&&(clearTimeout(o.lostMessageTimeout),o.lostMessageTimeout=void 0),o.acceptanceTimeout?(clearTimeout(o.acceptanceTimeout),o.acceptanceTimeout=void 0,o.done(e,t)):o.healthEvent.dimension0=Mr[Mr.Asyncronous],e&&(o.sequencer.stats.syncMessagesIgnored++,o.syncMessage.seq===0&&o.sequencer.seedErrors++,o.healthEvent.reason===de[de.Unknown]&&o.healthEvent.setReason(de.Core),o.healthEvent.success=!1,X.typeGuard(e)&&(o.healthEvent.message+=` ${e.error}`,o.healthEvent.dimension1=e.code?Me[e.code]:Me[Me.Unknown])),v.info(507265567,y.CoreDefault,o.healthEvent.stop())},this.cc)}}])}(),In;(function(n){n[n.None=0]="None",n[n.Sequenced=1]="Sequenced",n[n.Reconnect=2]="Reconnect",n[n.Reseeding=3]="Reseeding"})(In||(In={}));var uw=function(n){function r(e,t){var o;return(0,md.default)(this,r),o=lb(this,r),o.seedErrors=0,o.prevSeq=-1,o.groupCount=0,o.groupSize=0,o.groupId=void 0,o.fullFileSeedingComplete=!1,o.cache=new Xn,o.seedCompleteSingleton=!1,o.applyMessageCallback=e,o.seedSessionHealthEvent=new Le({sessionHealthEventName:"SessionFullFileSeeding",source:Ie.Core,reason:de.Unknown,impact:_e.MissingInput,success:!1,message:"",metricCount:!1}).start(),o.stats={seedMode:t?In.Reconnect:In.None,seedSuccess:!1,seedItems:0,seedMessageCount:0,seedGroupSize:0,seedDurationMs:0,syncMessageCount:0,syncMessagesOutOfSequence:0,syncMessagesAbandoned:0,syncMessagesIgnored:0,syncMessageQueueLimitReached:!1},o}return(0,iw.default)(r,n),(0,vd.default)(r,[{key:"onSyncMessage",value:function(t,o){var a=this,s,u=new kb(this,t,function(c,f){var d=Q(),p=d.startSync(te.SyncMessageSequencerSendResponse);o(c,f),d.stop(p)});try{if(this.updateGroupParameters(t),v.debug(537002498,y.CoreDefault,function(){return`SyncMessageSequencer.onSyncMessage: SyncMessage received. seq ${t.seq}, ${a.groupParametersToString(t)}, operations count = ${t.ops.length}`}),this.stats.syncMessageCount++,!this.validateSyncMessageAndHandleErrors(u))return;t.seq===0&&(this.prevSeq===-1||Ra.getValue())?this.handleSeedMessage(u):this.handleNonSeedMessage(u)}catch(c){var l=(s=c==null?void 0:c.stack)!==null&&s!==void 0?s:"";throw v.info(507069855,y.CoreDefault,l),u.healthEvent.message+=` ${l}`,u.onCompleted(new X({error:"Failed to Commit",code:Me.SyncMessageException})),c}}},{key:"getStats",value:function(){return this.stats}},{key:"onClose",value:function(){this.logForFullFileSeeding(vo.FailedSessionClose);for(var t of this.cache.keys()){var o=this.cache.get(t);o&&(yb.getValue()?o.onCompleted(new X({code:Me.SyncMessageSessionClosed,error:"Sync message ignored since session is closing."})):o.onCompleted(void 0,new cn))}this.cache.clear()}},{key:"getNextSeq",value:function(){return this.prevSeq+1}},{key:"validateSyncMessageAndHandleErrors",value:function(t){if(t.syncMessage.seq<=-1)return t.onCompleted(new X({code:Me.SyncMessageUnsupported,error:Ot.UnsupportedSyncMessage})),!1;if(t.syncMessage.seq===0){if(this.fullFileSeedingComplete){if(v.info(507388064,y.CoreDefault,"SyncMessageSequencer.validateSyncMessageAndHandleErrors: SyncMessage with seq0 came in after fullFileSeedingComplete "),mb.getValue())return t.onCompleted(new X({code:Me.SyncMessageUnexpectedSeed,error:Ot.UnexpectedSeedMessage})),!1;if(this.prevSeq===-1)return t.onCompleted(new X({code:Me.SyncMessageUnexpectedSeed,error:Ot.UnexpectedSeedMessage})),!1}else if(this.prevSeq!==-1){if(Ra.getValue())return v.info(506336670,y.CoreDefault,"SyncMessageSequencer.validateSyncMessageAndHandleErrors: Delayed SyncMessage with seq0 came in after prevSeq is !== -1 and fullFileSeedingComplete is false"),!0;if(v.info(507277377,y.CoreDefault,"SyncMessageSequencer.validateSyncMessageAndHandleErrors: SyncMessage with seq0 came in after prevSeq is !== -1 and fullFileSeedingComplete is false"),vb.getValue())return t.onCompleted(new X({code:Me.SyncMessageUnexpectedSeed,error:Ot.UnexpectedSeedMessage})),!1}return!0}if(this.cache.size()>=pb.getValue())return this.stats.syncMessageQueueLimitReached=!0,t.onCompleted(new X({code:Me.SyncMessageQueueFull,error:"Sync messages were ignored since queue was full"})),!1;if(t.syncMessage.seq!==0&&t.syncMessage.seq<=this.prevSeq)return t.onCompleted(new X({code:Me.SyncMessageTooLateOrDuplicate,error:"Sync messages were ignored since they were either late or duplicate"})),!1;if(this.groupId&&t.syncMessage.groupId){var o=Number.parseInt(this.groupId,10),a=Number.parseInt(t.syncMessage.groupId,10);if(a>0&&a>o)return!0;if(this.groupId!==t.syncMessage.groupId)return t.onCompleted(new X({code:Me.SyncMessageGroupIdMismatch,error:"Sequencer group Id does not match syncMessage group Id"})),!1}return!0}},{key:"handleSeedMessage",value:function(t){t.healthEvent.resourceId="Seeding",this.stats.seedMode===In.Reconnect?this.stats.seedMode=In.Reseeding:this.stats.seedMode===In.None&&(this.stats.seedMode=In.Sequenced),this.emit("seedMessageReceived"),(!t.syncMessage.groupId||this.groupCount===this.groupSize)&&this.emit("lastSeedMessageReceived"),t.apply(),this.stats.seedMessageCount++,t.syncMessage.groupId?this.updateSeedGroup(t.syncMessage):this.completeSeeding()}},{key:"checkSyncMessageToStopPreviousGroup",value:function(t){if(this.groupId&&t.groupId){var o=Number.parseInt(this.groupId,10),a=Number.parseInt(t.groupId,10);a>0&&a>o&&this.stopPreviousGroup(t)}}},{key:"getTimeoutInMs",value:function(){return this.groupId?db.getValue():this.prevSeq===-1?fb.getValue():cb.getValue()}},{key:"handleNonSeedMessage",value:function(t){t.healthEvent.resourceId="NonSeeding",this.checkSyncMessageToStopPreviousGroup(t.syncMessage);var o=this.cache.get(t.syncMessage.seq);if(o){t.onCompleted(new X({code:Me.SyncMessageUnprocessedDuplicate,error:`SyncMessage with seq=${t.syncMessage.seq} is already queued for processing`}));return}this.cache.put(t.syncMessage.seq,t,this.getTimeoutInMs(),this.onTimeout.bind(this));var a=t.syncMessage.seq===this.prevSeq+1,s=this.groupId&&this.groupSize===this.groupCount,u=s||this.groupId===void 0&&a;a||this.stats.syncMessagesOutOfSequence++,u?this.applyNextSequence(t):Q().startAsync(te.WaitingForInOrderMessage)}},{key:"tryToApplyNextMessage",value:function(){var t=this.cache.get(this.prevSeq+1);t&&this.applyNextSequence(t)}},{key:"onTimeout",value:function(t,o){v.info(537002514,y.CoreDefault,`SyncMessageSequencer.onTimeout: Performing best-effort sync of next sequence after ${this.prevSeq}, ${this.groupParametersToString(o.syncMessage)}`),!this.fullFileSeedingComplete&&!Ra.getValue()&&this.logForFullFileSeeding(vo.FailedTimeout),this.applyNextSequence(o),this.resetGroupParameters()}},{key:"stopPreviousGroup",value:function(t){if(v.info(508839882,y.CoreDefault,`SyncMessageSequencer.stopPreviousGroup: Pervious group ID: ${this.groupId} new group ID: ${t.groupId}`),H("groupStopErrorResponse"))for(var o of this.cache.keys()){var a=this.cache.get(o);a&&a.onCompleted(new X({code:Me.SyncMessageGroupStop,error:`Sequencer group changed to ${t.groupId}. Dropping queued messages`}))}this.cache.clear();var s=Number.parseInt(this.groupId,10);s<=0&&(this.completeSeeding(),this.emit("lastSeedMessageReceived")),this.resetGroupParameters(),this.updateGroupParameters(t)}},{key:"applyNextSequence",value:function(t){var o=this,a,s;ze(function(){a=Q(),s=Q().startSync(te.ApplyNextSequence)},t.cc);var u=[t];this.cache.forEach(function(S,C){C!==t.syncMessage.seq&&u.push(S)}),u.sort(function(S,C){return C.syncMessage.seq-S.syncMessage.seq});for(var l=function(C){ze(function(){Q().stop(te.WaitingForInOrderMessage),a.stop(s),C.apply(),a.resume(s),H("FixPrevSeqResetForSeq0")?o.prevSeq<C.syncMessage.seq?o.prevSeq=C.syncMessage.seq:v.info(507072897,y.CoreDefault,`PrevSeq resetting would have happened from ${o.prevSeq} to ${C.syncMessage.seq}`):o.prevSeq=C.syncMessage.seq,o.cache.del(C.syncMessage.seq)},C.cc)},c=0,f=void 0,d=u.pop();d&&d.syncMessage.seq<=t.syncMessage.seq;){var p=d.syncMessage.seq-(this.prevSeq+1);p<0&&v.info(507388099,y.CoreDefault,`abandonedMessages count: ${p} is negative`),p>0&&f===void 0&&(f=this.prevSeq+1),c+=p,l(d),d=u.pop()}if(c>0){this.stats.syncMessagesAbandoned+=c;var g=`seq=${f}`;c>1&&(g+=`-${f+c-1}`);var k=new Le({sessionHealthEventName:"QueueAndApplySyncMessage",source:Ie.Core,reason:f===0?de.Client:de.ClientRuntime,impact:_e.MissingInput,success:!1,count:c,message:g,resourceId:f===0?"Seeding":"NonSeeding",dimension0:Mr[Mr.Abandoned],dimension1:Me[Me.SyncMessageAbandoned]});v.info(537002516,y.CoreDefault,k)}for(;d&&d.syncMessage.seq===this.prevSeq+1;)l(d),d=u.pop();this.groupId&&this.resetGroupParameters(),a.stop(s)}},{key:"updateSeedGroup",value:function(t){this.stats.seedItems+=t.ops.reduce(function(o,a){return o+a.items.length},0),this.groupCount===this.groupSize&&this.completeSeeding()}},{key:"completeSeeding",value:function(){this.fullFileSeedingComplete=!0,this.stats.seedSuccess=this.seedErrors===0,this.stats.seedGroupSize=this.groupSize,this.stats.seedDurationMs=this.seedSessionHealthEvent.durationMs,(!Ra.getValue()||this.prevSeq===-1)&&(this.prevSeq=0),this.logForFullFileSeeding(vo.Complete),this.tryToApplyNextMessage(),this.emit("seedCompleted"),this.resetGroupParameters()}},{key:"logForFullFileSeeding",value:function(t){if(!this.seedCompleteSingleton){if(this.seedCompleteSingleton=!0,this.seedSessionHealthEvent.success=this.fullFileSeedingComplete&&this.stats.seedSuccess,this.seedSessionHealthEvent.resourceId=In[this.stats.seedMode],this.seedSessionHealthEvent.dimension0=vo[t],Ra.getValue()){var o="DelaySeedMessageMode";this.prevSeq!==0&&(o+="_CompletedAfterNonSeedMessagesWereAccepted"),this.seedSessionHealthEvent.dimension2=o}t===vo.Complete&&this.seedSessionHealthEvent.stop(),this.fullFileSeedingComplete?this.seedSessionHealthEvent.dimension1=mo[mo.Finished]:this.seedSessionHealthEvent.dimension1=mo[this.stats.seedMessageCount<=0?mo.NotStarted:mo.Incomplete],this.seedSessionHealthEvent.message=`Number of received messages: ${this.groupCount}. Number of expected messages: ${this.groupSize>0?this.groupSize:"unknown"}.`,v.info(537002524,y.CoreDefault,this.seedSessionHealthEvent)}}},{key:"groupParametersToString",value:function(t){if(this.groupId){var o=t?`, groupId ${t.groupId}, syncMessage.groupComplete ${t.groupComplete}`:`groupId ${this.groupId}`;return`inGroup true, groupCount ${this.groupCount}, groupSize ${this.groupSize} ${o}`}else return"inGroup false"}},{key:"resetGroupParameters",value:function(){this.groupCount=0,this.groupSize=0,this.groupId=void 0}},{key:"updateGroupParameters",value:function(t){var o,a,s;t.groupId=(o=t.groupId)!==null&&o!==void 0?o:t.batchId,t.groupSize=(a=t.groupSize)!==null&&a!==void 0?a:t.batchSize,t.groupComplete=(s=t.groupComplete)!==null&&s!==void 0?s:t.batchComplete,t.groupId!==void 0&&(this.groupId===void 0&&(this.groupId=t.groupId),this.groupId===t.groupId&&(this.groupCount++,t.groupComplete&&(this.groupSize=t.groupSize,this.groupCount!==this.groupSize&&v.info(537002525,y.CoreDefault,`SyncMessageSequencer.updateGroupParameters: GroupComplete message is not last message in group ${t.groupId}. groupCount=${this.groupCount}, groupSize=${this.groupSize}.`))))}}])}(sw.EventEmitter);h();var yo=function(r){var e;return H("AllowStableAnnotationIds")&&((e=r.modelOptions)===null||e===void 0?void 0:e.allowStableAnnotationIds)};function wb(n,r,e){return r=(0,yd.default)(r),(0,dw.default)(n,gw()?Reflect.construct(r,e||[],(0,yd.default)(n).constructor):r.apply(n,e))}function gw(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(gw=function(){return!!n})()}var hw=function(n){function r(e){var t;return(0,cw.default)(this,r),t=wb(this,r,[e]),t.annotationTypeFirstInstanceLogged=new Set,t}return(0,pw.default)(r,n),(0,fw.default)(r,[{key:"persistAnnotationQueue",value:function(t,o,a){var s=this,u,l,c,f,d=Q().startSync(te.PersistAnnotationQueueStateful),p=new Map,g=new Map;for(var k of o){this.synthesizeEmptyAnnotationQueueEntriesIfNecessary(t,k.scopeItemPath,k.scopeItemRevId,k.annotationQueue);var S=function(K,Z,ye){var he=ye?g:p;if(Z&&Z.length>0){var ke,Ae=he.get(K);Ae||(Ae=[],he.set(K,Ae)),(ke=Ae).push.apply(ke,(0,Ko.default)(Z))}};if(this.isWorkflowInReduceStyle(t)&&t.outputTypes){var C=[].concat((0,Ko.default)(t.outputTypes),[Ht.getTypeName()]),x=this.session.cache.getSubtreeItems(k.scopeItemPath,C,function(U){return U.source===t.id}),T=new Map;for(var I of x){var _=void 0;Ht.typeGuard(I.body)?_=I.body.annotationTypeName:_=m.getTypeNameFor(I.body);var M=T.get(_);M?M.push(I):(M=[I],T.set(_,M))}var b=function(K){var Z=k.annotationQueue.filter(function(ye){return ye.annotationType===K});s.processSubtreeAnnotationQueue(t,K,Z,(u=T.get(K))!==null&&u!==void 0?u:[],S,k.source)};for(var A of t.outputTypes)b(A)}else this.processAnnotationQueueInternal(t,k.annotationQueue,S)}if(p.size>0||g.size>0){var N=new Array(p.size),F=0;for(var q of[{opsByType:p,areApologies:!1},{opsByType:g,areApologies:!0}]){var J=q.opsByType,Y=q.areApologies;for(var fe of J.keys()){var W=J.get(fe),B=0,L=0,O=0;for(var D of W){var $=m.getTypeNameFor(D);$===we.getTypeName()?B+=((l=D.items)===null||l===void 0?void 0:l.length)||0:$===Oe.getTypeName()?L+=((c=D.items)===null||c===void 0?void 0:c.length)||0:$===He.getTypeName()&&(O+=((f=D.items)===null||f===void 0?void 0:f.length)||0)}N[F++]={type:Y?`Apology<${fe}>`:fe,added:B,updated:L,deleted:O}}}a.message=`Committing annotation changes: ${JSON.stringify(N)}`,Q().stop(d),this.commitAnnotations(t,p,g)}else Q().stop(d),a.message="No annotation changes to commit";a.dimension1="Stateful"}},{key:"synthesizeEmptyAnnotationQueueEntriesIfNecessary",value:function(t,o,a,s){if(t.kind===V.SingleItem){var u=function(f){s.some(function(d){return d.annotationType===f})||s.push({path:o,revId:a,annotationType:f,annotations:[],areApologies:!1})};for(var l of t.outputTypes||[])u(l)}}},{key:"processSubtreeAnnotationQueue",value:function(t,o,a,s,u,l){var c=this;if(l===ko.ApologiesGenerator){this.processAnnotationQueueInternal(t,a,u);return}var f=new Map,d=new Map;for(var p of s){var g=Ht.typeGuard(p.body)?d:f,k=z(p.parentPath),S=g.get(k);S||(S=[],g.set(k,S)),S.push(p)}for(var C of a){var x=z(C.path);f.delete(x),d.delete(x)}var T=function(_,M){var b=[];for(var A of _){var N=(0,lw.default)(A,2),F=N[0],q=N[1];c.generateAnnotationDeleteOps(t,Bn(F),void 0,!1,q,b)}u(o,b,M)};T(f,!1),T(d,!0),this.processAnnotationQueueInternal(t,a,u)}},{key:"processAnnotationQueueInternal",value:function(t,o,a){for(var s of o)if(s.ancestorType){var u=this.session.cache.getFirstAncestorOfType(s.path,[s.ancestorType]);if(!u)throw new Error(`Failed to get ancestor of type ${s.ancestorType} on path ${z(s.path)} (no match)`);this.applyAnnotations(t,[].concat((0,Ko.default)(u.parentPath),[u.id]),void 0,!1,s,a)}else this.applyAnnotations(t,s.path,s.revId,s.isTriggeredBySyncDelta,s,a)}},{key:"applyAnnotations",value:function(t,o,a,s,u,l){var c=u.annotationType,f=u.annotations,d=u.sourceInfo,p=u.areApologies,g;try{var k=[].concat((0,Ko.default)(t.outputTypes),[Ht.getTypeName()]);g=this.session.cache.getItemChildren(o,k)}catch(F){if(F instanceof io)if(yo(t))g=[];else{v.info(529093124,y.CoreDefault,`Annotations ignored because parent ${z(o)} no longer exists`);return}else throw F}var S=[];for(var C of g)C.source===t.id&&(Ht.typeGuard(C.body)&&C.body.annotationTypeName===c||!p&&m.getTypeNameFor(C.body)===c)&&S.push(C);var x=[],T=[];this.compareAnnotationsToExistingChildren(o,t,f,c,u.isImmediateAnnotation,S,x,T,d);var I=[],_=[];for(var M of S)Ht.typeGuard(M.body)?I.push(M):_.push(M);var b=[],A=[];H("DeleteOpsBeforeAdds")?(p||this.generateAnnotationDeleteOps(t,o,a,s,_,b),this.generateAnnotationDeleteOps(t,o,a,s,I,A),this.generateAnnotationAddOps(o,a,s,x,p?A:b),this.generateAnnotationUpdateOps(o,a,s,T,p?A:b)):(this.generateAnnotationAddOps(o,a,s,x,p?A:b),this.generateAnnotationUpdateOps(o,a,s,T,p?A:b),p||this.generateAnnotationDeleteOps(t,o,a,s,_,b),this.generateAnnotationDeleteOps(t,o,a,s,I,A));var N=function(q){for(var J of q)for(var Y of J.items)Y.contextId=u.contextId};N(b),N(A),l(c,b,!1),l(c,A,!0)}},{key:"isWorkflowInReduceStyle",value:function(t){return t.kind===V.Reduce||t.kind===V.Generic&&t.dynamicExecutionPreferences===void 0}},{key:"compareAnnotationsToExistingChildren",value:function(t,o,a,s,u,l,c,f,d){var p=this,g=function(C){var x=!0;if(C.id||(C.id=Zt(),x=!1),yo(o)&&x){var T=p.session.cache.tryGetItem([].concat((0,Ko.default)(t),[C.id]));if(T&&T.source!==o.id)return v.warn(507011727,y.CoreDefault,`Attempting to create annotation with stable ID ${C.id} (parent path ${z(t)}), but the item with that ID already exists.`),1}var I=C.id;C.id=void 0;var _=C.M_;C.M_=void 0;var M=p.compareAnnotationToExistingChildren(o,C,I,s,l,u,x),b=M.shouldAddAnnotation,A=M.shouldUpdateAnnotation,N=M.itemId;C.id=I,C.M_=_,b&&(C.M_=Object.assign(Object.assign({},C.M_),{state:Bt.Created}),p.logMetaData(Bt.Created,s,C.ownerId));var F=d?{id:N,parentPath:t,source:o.id,body:C,sourceInfo:d}:{id:N,parentPath:t,source:o.id,body:C},q="Not changing";b?(c.push(F),q="Adding"):A&&(f.push(F),q="Updating"),v.debug(529093125,y.CoreDefault,function(){return`${q} annotation ${C.id} (type: ${m.getTypeNameFor(C)}, workflow: ${o.id})`})};for(var k of a)g(k)}},{key:"compareAnnotationToExistingChildren",value:function(t,o,a,s,u,l,c){for(var f={shouldAddAnnotation:!0,shouldUpdateAnnotation:!1,itemId:""},d=Ht.typeGuard(o),p=0;p<u.length;p++){var g=u[p].body;if(d&&!Ht.typeGuard(g)){u.splice(p--,1);continue}var k=g.id;g.id=void 0;var S=g.M_;g.M_=void 0;var C=!1;if(H("ApplyAnnotationOptimization")?(!rn(t)||Na(t)||l||yo(t)&&c)&&(0,kd.default)(g,o)?(C=!0,f.shouldAddAnnotation=!1):a===k&&(C=!0,f.shouldUpdateAnnotation=!0,f.shouldAddAnnotation=!1,f.itemId=u[p].id):(!rn(t)||Na(t))&&(0,kd.default)(g,o)?(C=!0,f.shouldAddAnnotation=!1):a===k&&(C=!0,f.shouldUpdateAnnotation=!0,f.shouldAddAnnotation=!1,f.itemId=u[p].id),g.id=k,g.M_=S,C){this.logMetaData(Bt.Duplicated,s,g.ownerId),u.splice(p,1);break}}return f.shouldAddAnnotation&&(f.itemId=yo(t)&&c?a:this.session.cache.getNextAnnotationId()),f}},{key:"commitAnnotations",value:function(t,o,a){var s=this,u=Q(),l=u.startSync(te.CommitAnnotations),c=function(d,p,g){if(d.length){s.session.contextIdManager.applyContextIdOnOperations(d),s.session.updateWorkflowExecutionStates(d);try{s.session.cache.applyOperations(d,void 0)}catch(I){v.info(529093126,y.CoreDefault,new Le({sessionHealthEventName:"FailedApplyingAnnotationsToCache",source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!1,message:"",affectedWorkflows:[t.resourceId]})),v.error(529093127,y.CoreDefault,`Error applying annotation results to cache: ${I.message}`)}var k=p;if(g){var S=d.find(function(I){return!He.typeGuard(I)});if(S){var C=S.items[0].body.annotationTypeName;k=`Apology<${C}>`}}var x=s.session.annotationActivationInfosByType.get(p);if(mw.getValue()&&x&&(!g||x.some(function(I){return I.sendApologies}))){var T=d.map(function(I){var _=new Array(I.items.length),M=0;for(var b of I.items)if(b.body){var A=b.body;s.logMetaData(Bt.Sent,k,A.ownerId),_[M++]={id:b.id,body:A,contextId:b.contextId}}return _.length=M,new mt({parentPath:I.parentPath,items:_,M_:{state:Bt.Sent}})});try{s.session.cache.applyOperations(T,void 0)}catch(I){v.info(529093128,y.CoreDefault,new Le({sessionHealthEventName:"FailedSettingAnnotationStateToSent",source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!1,message:"",affectedWorkflows:[t.resourceId]})),v.error(529093129,y.CoreDefault,"Error setting annotation state to sent")}}u.stop(l),s.session.sendAnnotations(p,d,g,t),u.resume(l),s.logAnnotationTypeFirstInstance(k)}};o.forEach(function(f,d){c(f,d,!1)}),a.forEach(function(f,d){c(f,d,!0)}),u.stop(l)}},{key:"logMetaData",value:function(t,o,a){a||(a=""),v.info(529093130,y.CoreDefault,new Fi({sessionKey:this.session.sessionKey,annotationType:o,annotationState:t,workflowId:Gs(a)}))}},{key:"logAnnotationTypeFirstInstance",value:function(t){this.session.syncMessageSequencer.getStats().seedMode===In.Sequenced&&!this.annotationTypeFirstInstanceLogged.has(t)&&(v.info(529093131,y.CoreDefault,new E({operationName:"FirstAnnotation",resourceId:t,durationMs:Date.now()-this.session.startTime,resultSignature:"SinceSessionStart",success:!0},{metricDuration:!0})),this.annotationTypeFirstInstanceLogged.add(t))}}])}(Js);h();var vw=w(P()),yw=w(R()),kw=w(Qe()),wd=w($e()),ww=w(je());function Sb(n,r,e){return r=(0,wd.default)(r),(0,kw.default)(n,Sw()?Reflect.construct(r,e||[],(0,wd.default)(n).constructor):r.apply(n,e))}function Sw(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Sw=function(){return!!n})()}var Cw=function(n){function r(e,t){var o;return(0,vw.default)(this,r),o=Sb(this,r,[e]),o.itemListeners=t,o}return(0,ww.default)(r,n),(0,yw.default)(r,[{key:"persistAnnotationQueue",value:function(t,o,a){var s=this,u=Q(),l=u.startSync(te.PersistAnnotationQueueStateless),c=new Array(o.length),f=0;for(var d of o){var p=function(S){var C=[],x=S.annotations.map(function(T){return S.sourceInfo?{id:s.session.cache.getNextAnnotationId(),parentPath:S.path,source:t.id,contextId:S.contextId,body:T,sourceInfo:S.sourceInfo}:{id:s.session.cache.getNextAnnotationId(),parentPath:S.path,source:t.id,contextId:S.contextId,body:T}});s.generateAnnotationAddOps(S.path,S.revId,S.isTriggeredBySyncDelta,x,C),s.session.contextIdManager.applyContextIdOnOperations(C),s.session.updateWorkflowExecutionStates(C),s.itemListeners.emitEvents(C),u.stop(l),s.session.sendAnnotations(S.annotationType,C,S.areApologies,t),u.resume(l),c[f++]={type:S.annotationType,added:C.reduce(function(T,I){var _;return T+(((_=I.items)===null||_===void 0?void 0:_.length)||0)},0),updated:0,deleted:0}};for(var g of d.annotationQueue)p(g)}a.message=c.length>0?`Committing annotation changes: ${JSON.stringify(c)}`:"No annotation changes to commit",a.dimension1="Stateless",u.stop(l)}}])}(Js);h();var se=w(Se()),jt=w(dt()),Mw=w(Qe()),Td=w($e()),Ew=w(je()),eu=w(P()),tu=w(R());h();var Xs=w(P()),Zs=w(R());var Sd=function(){function n(r){(0,Xs.default)(this,n),m.assign(n,this,r)}return(0,Zs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_ContentSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Sd.H_={T_:Sd.getTypeName(),B_:Sd.getBaseTypes()};var Cd=function(){function n(r){(0,Xs.default)(this,n),m.assign(n,this,r)}return(0,Zs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_BaseSubstrateSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Cd.H_={T_:Cd.getTypeName(),B_:Cd.getBaseTypes()};var Ba=function(){function n(r){(0,Xs.default)(this,n),m.assign(n,this,r)}return(0,Zs.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_Signals_CorrelatedSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();Ba.H_={T_:Ba.getTypeName(),B_:Ba.getBaseTypes()};var Dw=w(Pn());h();var Cb=new G("fullInvalidationThreshold",.85),xd=new G("enableLoggingUnexpectedItems",!1),xw=function(r,e,t,o){var a=[];if(o=o!=null?o:Cb.getValue(),e.size===0||e.size/t.length>=o){var s=[];for(var u of t)u?s.push(u):xd.getValue()&&v.info(537678304,y.CoreDefault,"Undefined sibling item is detected.");a.push(s)}else{for(var l=new Map,c=0;c<t.length;c++)t[c]?l.set(t[c].id,c):xd.getValue()&&v.info(537678305,y.CoreDefault,"Undefined sibling item is detected.");for(;e.size>0;){var f=[],d=e.keys().next().value,p=d,g=l.get(p);if(g===void 0){v.info(537678306,y.CoreDefault,`SiblingItems doesn't contain invalidated item with id ${p}`),e.delete(p);continue}f.push(t[g]);for(var k=g+1<t.length?t[g+1].id:void 0;e.has(k);)p=k,g+=1,f.push(t[g]),e.delete(p),k=g+1<t.length?t[g+1].id:void 0;p=d,g=l.get(p);for(var S=g-1>=0?t[g-1].id:void 0;e.has(S);)p=S,g-=1,f.unshift(t[g]),e.delete(p),S=g-1>=0?t[g-1].id:void 0;e.delete(d),a.push(f)}}if(r.workflow.dynamicExecutionPreferences.inputSize===-1)return a;var C=[];for(var x of a)for(var T=0,I=r.workflow.dynamicExecutionPreferences.inputSize;T<x.length;){for(var _=0,M=[];_<I&&T<x.length;){if(x[T]&&x[T].body){var b=x[T].body;if(M.push(x[T]),r.workflow.dynamicExecutionPreferences.inputSizeUnit===Nn.Character)_+=b?b.content.length:0;else if(r.workflow.dynamicExecutionPreferences.inputSizeUnit===Nn.Paragraph)_++;else{v.error(537678307,y.CoreDefault,`Unsupported UnitType: ${r.workflow.dynamicExecutionPreferences.inputSizeUnit}`);return}}else xd.getValue()&&v.info(537678336,y.CoreDefault,"Undefined sibling item is detected.");T+=1}C.push(M)}return C};h();var Tw=w(Se()),Iw=w(P()),_w=w(R());var Aw=function(){function n(){(0,Iw.default)(this,n)}return(0,_w.default)(n,[{key:"getBatchesByItemPath",value:function*(e,t,o){if(e.length===0)return[];if(e.length<=t()){yield e;return}var a=e.reduce(function(d,p){var g=o(p),k=z([].concat((0,Tw.default)(g.parentPath),[g.id]));return d.has(k)||d.set(k,[]),d.get(k).push(p),d},new Map),s=[],u=t();for(var l of a.values()){s.length>0&&l.length<=u&&s.length+l.length>u&&(yield s,u=t(),s=[]);for(var c=0;c<l.length;){var f=Math.min(u-s.length,l.length-c);s=s.concat(l.slice(c,c+f)),c+=f,s.length===u&&(yield s,u=t(),s=[])}}s.length>0&&(yield s)}},{key:"getBatches",value:function*(e,t){var o=[],a=t();for(var s of e)o.push(s),o.length===a&&(yield o,a=t(),o=[]);o.length>0&&(yield o)}}])}();function xb(n,r,e){return r=(0,Td.default)(r),(0,Mw.default)(n,Nw()?Reflect.construct(r,e||[],(0,Td.default)(n).constructor):r.apply(n,e))}function Nw(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(Nw=function(){return!!n})()}var Er=new G("workflowExecutionManagerExtraLogging",!1),Fn;(function(n){n[n.Input=1]="Input",n[n.Context=2]="Context"})(Fn||(Fn={}));var Tb=new G("deltaUpdateMinDelayMs",250),Ib=new G("deltaUpdateMaxDelayMs",250),_b=function(){return{minDelayMs:Tb.getValue(),maxDelayMs:Ib.getValue()}},Pw=function(r){return new Rb(r)},Ab=new G("skipDebounceDeltasEnabled",!0),bb=new G("enableExecutionCountCheck",!1),Mb=new G("sweepScopeExecutionNotificationsInterval",200),Eb=new G("disableLoggingAncestorNotFoundForWorkflows",["HoneybeeRankingDelta"]),Nb=new G("enableDeltaUpdateDelayPerClient",{default:!1}),bw=new G("enableEarlyJoinCompletion",!1),Db=new Map([[gt.getTypeName(),Hn.getTypeName()]]),Pb=function(){function n(){(0,eu.default)(this,n)}return(0,tu.default)(n,[{key:"setClientMetadata",value:function(e){this.clientSettingsKey=e!=null&&e.appName&&(e!=null&&e.appPlatform)?`${e.appName.toLowerCase()}-${e.appPlatform.toLowerCase()}`:void 0}},{key:"getValue",value:function(){var e=Nb.getValue();return this.clientSettingsKey&&e.hasOwnProperty(this.clientSettingsKey)?e[this.clientSettingsKey]:e.hasOwnProperty("default")?e.default:!1}}])}(),Rb=function(n){function r(e){var t;return(0,eu.default)(this,r),t=xb(this,r),t.sweepIntervalMs=Mb.getValue(),t.sessionCache=e.cache,t.queueWorkflow=e.queueWorkflow,t.queueGridNeighborhoodWorkflow=e.queueGridNeighborhoodWorkflow,t.sessionCache.on("purgeModel",t.onPurgeModel.bind(t)),t.inputChangesManager=e.inputChangesManager,t.getUserNodePath=e.getUserNodePath,t.workflowDefinitionManager=e.workflowDefinitionManager,t.workflowItemStorage=e.workflowItemStorage,t.getTenantNodePath=e.getTenantNodePath,t.getUserCommandsNodePath=e.getUserCommandsNodePath,t.sessionCreationTime=e.sessionCreationTime,t.usesRefactoredDebouncing=e.usesRefactoredDebouncing,t.workflowSynchronizationManager=e.workflowSynchronizationManager,t.workflowPrefilterManager=e.workflowPrefilterManager,t.workflowQueue=e.workflowQueue,t.enableDeltaUpdateDelay=new Pb,t.batchSplitter=new Aw,t.executionCompleteCallback=e.executionCompleteCallback,t.notificationManager=e.notificationManager,t.workflowExecutionTrackersByName=e.workflowExecutionTrackersByName,t.attachExecutionTrackerToEachWorkflow(e.workflowRegistrationsByName,e.workflowsByInputAnnotation,e.workflowsByOutputAnnotation,e.workflowsByRequestedContextType),t.workflowBatchSizeMax=e.workflowBatchSizeMax,t.itemScopeMovedTracker=e.itemScopeMovedTracker,t.workflowExecutionScopesResolver=e.workflowExecutionScopesResolver,t.areaIntersectionChecker=e.areaIntersectionChecker,t.workflowContextsManager=e.workflowContextsManager,t.areasIntersect=e.areasIntersect,t.supportsAreaIntersection=e.supportsAreaIntersection,t}return(0,Ew.default)(r,n),(0,tu.default)(r,[{key:"pendingNotifications",get:function(){return this.notificationManager.pendingNotifications}},{key:"getAllDownstreamWorkflowIds",value:function(t){var o=new Set;H("WaitContextProducerToComplete")?this.workflowExecutionTrackersByName.get(t).allDownstreamWorkflowExecutionTrackers.forEach(function(l){l.workflowResultType===Fn.Input&&o.add(l)}):o=this.workflowExecutionTrackersByName.get(t).allDownstreamWorkflowExecutionTrackers;var a=new Array(o?o.size:0),s=0;for(var u of o?o.values():[])a[s++]=u.workflowExecutionTracker.workflow.id;return a}},{key:"getAllUpstreamWorkflowIds",value:function(t){var o=new Set;H("WaitContextProducerToComplete")?this.workflowExecutionTrackersByName.get(t).allUpstreamWorkflowExecutionTrackers.forEach(function(l){l.workflowResultType===Fn.Input&&o.add(l)}):o=this.workflowExecutionTrackersByName.get(t).allUpstreamWorkflowExecutionTrackers;var a=new Array(o?o.size:0),s=0;for(var u of o?o.values():[])a[s++]=u.workflowExecutionTracker.workflow.id;return a}},{key:"invalidateWorkflow",value:function(t,o){var a=this.workflowExecutionTrackersByName.get(t.workflow.id);try{if(t.workflow.kind===V.SingleItem)this.invalidateSingleItemWorkflow(a,t,o);else if(t.workflow.kind===V.DynamicText)this.invalidateDynamicWorkflow(a,t,o);else if(t.workflow.kind===V.Reduce||t.workflow.kind===V.Grid)for(var s of o)this.invalidateReduceWorkflow(a,t,s);else if(t.workflow.kind===V.Join)for(var u of o)this.invalidateJoinWorkflow(a,t,u);else if(t.workflow.kind===V.Generic)for(var l of o)this.invalidateGenericWorkflow(a,t,l);else v.error(537678240,y.CoreDefault,`Failed to invalidate workflow ${t.workflow.id}: workflow in type ${t.workflow.kind} is not supported.`)}catch(g){v.error(537678241,y.CoreDefault,`Failed to invalidate workflow ${t.workflow.id}: ${g.message}`)}finally{var c=a.getExecutionState();for(var f of o){var d=f.item;if(d!=null&&d.contextId){var p=c.get(d.contextId);p===xe.Idle&&a.afterWorkflowExecution(d.contextId)}}}}},{key:"getWorkflowsByExecutionState",value:function(){for(var t=new Set,o=arguments.length,a=new Array(o),s=0;s<o;s++)a[s]=arguments[s];for(var u of this.workflowExecutionTrackersByName.values())a.includes(u.getWorkflowExecutionState())&&t.add(u.workflow);return t}},{key:"requestSweep",value:function(){this.ensureSweepTimer()}},{key:"onSessionClose",value:function(){this.cancelSweepTimer(),this.usesRefactoredDebouncing&&this.workflowSynchronizationManager.onSessionClose()}},{key:"evaluatePrefilters",value:function(t,o){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Ln.All,s={scopeItem:o.scopeItem,inputItems:o.inputItems,clientMetadata:this.clientMetadata};return this.workflowPrefilterManager.evaluateWorkflowPrefilters(t,s,a)}},{key:"setClientMetadata",value:function(t){this.clientMetadata=t,this.enableDeltaUpdateDelay.setClientMetadata(t)}},{key:"attachExecutionTrackerToWorkflow",value:function(t,o,a,s){if(this.workflowExecutionTrackersByName.has(t.workflow.id))throw new Error(`Duplicate workflow ${t.workflow.id}`);for(var u of this.workflowExecutionTrackersByName.values())u.allDownstreamWorkflowExecutionTrackers=void 0,u.allUpstreamWorkflowExecutionTrackers=void 0;this.attachExecutionTrackerToEachWorkflow(new Map([[t.workflow.id,t]]),o,a,s)}},{key:"increasePendingUpstreamWorkflowsCount",value:function(t,o,a){this.workflowExecutionTrackersByName.get(t).increasePendingUpstreamWorkflowsCount(o,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache),a)}},{key:"preProcessItemToWorkflow",value:function(t,o){var a=this.workflowExecutionTrackersByName.get(t.id);t.kind===V.Join&&m.matchesTypesFor(o.body,t.inputTypes)&&a.addInputItemToProcess(o.contextId),(t.kind===V.SingleItem&&m.matchesTypesFor(o.body,t.inputTypes)||t.kind===V.Join&&m.matchesTypesFor(o.body,[t.collectionScopeType]))&&a.beforeWorkflowExecution(o.contextId)}},{key:"getScopeExecutionTracker",value:function(t){return this.workflowExecutionTrackersByName.get(t)}},{key:"evaluateSingleItemPrefiltersWithoutAction",value:function(t,o){var a={scopeItem:o,inputItems:[o],clientMetadata:this.clientMetadata},s=this.workflowPrefilterManager.evaluateWorkflowPrefilters(t,a,Ln.WithoutActionDefinition);return s.shouldExecuteWorkflow}},{key:"prefilterAndSplitTasksBeforeQueing",value:function(t,o){var a=[],s=[];for(var u of o){var l=this.evaluatePrefilters(t.workflow,u,Ln.WithActionDefinition);l.shouldExecuteWorkflow?a.push(u):(u.prefilterActionResults=l.prefilterActionResults,s.push(u))}return{workflowTasks:a,prefilteredTasks:s}}},{key:"attachExecutionTrackerToEachWorkflow",value:function(t,o,a,s){for(var u of t){var l=(0,jt.default)(u,2),c=l[0],f=l[1],d=new Bb(f,this.onExecutionStateChange.bind(this),this.onContextIdWorkflowExecutionComplete.bind(this));this.workflowExecutionTrackersByName.set(c,d)}for(var p of this.workflowExecutionTrackersByName.values())this.setDownstreamWorkflowExecutionTrackers(p,o,s),this.setUpstreamWorkflowExecutionTrackers(p,a)}},{key:"setDownstreamWorkflowExecutionTrackers",value:function(t,o,a){var s,u,l;if(t.allDownstreamWorkflowExecutionTrackers===void 0){t.allDownstreamWorkflowExecutionTrackers=new Set;for(var c of(s=t.workflow.outputTypes)!==null&&s!==void 0?s:[]){var f=(u=o.get(c))!==null&&u!==void 0?u:new Set;if(this.setDownstreamWorkflowExecutionTrackersForDependentWorkflows(f,o,a,t,Fn.Input),H("WaitContextProducerToComplete")){var d=(l=a.get(c))!==null&&l!==void 0?l:new Set;this.setDownstreamWorkflowExecutionTrackersForDependentWorkflows(d,o,a,t,Fn.Context)}}}}},{key:"setDownstreamWorkflowExecutionTrackersForDependentWorkflows",value:function(t,o,a,s,u){var l;for(var c of t){this.setDownstreamWorkflowExecutionTrackers(this.workflowExecutionTrackersByName.get(c.id),o,a),s.allDownstreamWorkflowExecutionTrackers.add({workflowExecutionTracker:this.workflowExecutionTrackersByName.get(c.id),workflowResultType:u});var f=function(g){s.allDownstreamWorkflowExecutionTrackers.forEach(function(k){k.workflowExecutionTracker===g.workflowExecutionTracker&&k.workflowResultType===g.workflowResultType&&s.allDownstreamWorkflowExecutionTrackers.delete(k)}),s.allDownstreamWorkflowExecutionTrackers.add(g)};for(var d of(l=this.workflowExecutionTrackersByName.get(c.id).allDownstreamWorkflowExecutionTrackers)!==null&&l!==void 0?l:[])f(d)}}},{key:"setUpstreamWorkflowExecutionTrackers",value:function(t,o){var a;if(t.allUpstreamWorkflowExecutionTrackers===void 0){t.allUpstreamWorkflowExecutionTrackers=new Set;var s=(a=t.workflow.inputTypes)!==null&&a!==void 0?a:[];this.setUpstreamWorkflowExecutionTrackersForTypes(s,t,o,Fn.Input),H("WaitContextProducerToComplete")&&(s=Fm(this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).requestedContextTypesRules),this.setUpstreamWorkflowExecutionTrackersForTypes(s,t,o,Fn.Context))}}},{key:"setUpstreamWorkflowExecutionTrackersForTypes",value:function(t,o,a,s){var u,l;for(var c of t)for(var f of(u=a.get(c))!==null&&u!==void 0?u:[]){this.setUpstreamWorkflowExecutionTrackers(this.workflowExecutionTrackersByName.get(f.id),a),o.allUpstreamWorkflowExecutionTrackers.add({workflowExecutionTracker:this.workflowExecutionTrackersByName.get(f.id),workflowResultType:s});var d=function(k){o.allUpstreamWorkflowExecutionTrackers.forEach(function(S){S.workflowExecutionTracker===k.workflowExecutionTracker&&S.workflowResultType===k.workflowResultType&&o.allUpstreamWorkflowExecutionTrackers.delete(S)}),o.allUpstreamWorkflowExecutionTrackers.add(k)};for(var p of(l=this.workflowExecutionTrackersByName.get(f.id).allUpstreamWorkflowExecutionTrackers)!==null&&l!==void 0?l:[])d(p)}}},{key:"invalidateSingleItemWorkflow",value:function(t,o,a){var s=this,u,l,c,f,d,p,g,k,S=new Map,C=!1;if(H("RefactoredScopeResolving")){var x=this.workflowExecutionScopesResolver.resolve(o,a);for(var T of x)S.set(z(T.scopePath),T.params);C=(l=(u=x[0])===null||u===void 0?void 0:u.ignoreMinDelay)!==null&&l!==void 0?l:!1}else{var I=Q(),_=this.isWorkflowRequestingContexts(o.workflow),M=void 0,b=function(U){var K,Z,ye,he=I.startSync(te.AddScopeGroupedParameters),ke="";if(_){M||(M=s.getAllDocumentContextHolderPaths((ye=(Z=(K=a==null?void 0:a[0])===null||K===void 0?void 0:K.updatedContextScope)===null||Z===void 0?void 0:Z[0])!==null&&ye!==void 0?ye:"session"));var Ae=s.getDeepestDocumentContextHolderPath(M,U.item);Ae&&(ke=z(Ae))}S.has(ke)||S.set(ke,[]),S.get(ke).push(U),I.stop(he)},A=function(U){return(!o.invalidationFilter||o.invalidationFilter(U)!==!1)&&s.evaluateSingleItemPrefiltersWithoutAction(o.workflow,U)},N=function(U){A(U.item)?b(U):v.verbose(508411922,y.CoreDefault,function(){return`Filtered out single-item invalidation for item with path [${[].concat((0,se.default)(U.item.parentPath),[U.item.id])}]`})};if(!a||a.length==1&&(!a[0].item||a[0].updatedContextScope)){C=!(!((c=a==null?void 0:a[0])===null||c===void 0)&&c.updatedContextScope);for(var F of this.sessionCache.getSubtreeItems((d=(f=a==null?void 0:a[0])===null||f===void 0?void 0:f.updatedContextScope)!==null&&d!==void 0?d:[],o.workflow.inputTypes))N({item:F,opType:(p=a==null?void 0:a[0])===null||p===void 0?void 0:p.opType})}else for(var q of a)if(q.item)if(m.matchesTypesFor(q.item.body,[bn.getTypeName()])){var J=H("UserAreaIntersectionChecker")?this.areaIntersectionChecker.getAreaIntersectionFilter(q.item.body):this.getAreaIntersectionFilter(q.item.body),Y=this.sessionCache.getSubtreeItems([],o.workflow.inputTypes,J);v.info(508411921,y.CoreDefault,`invalidateSingleItemWorkflow: Using intersection for workflow '${o.workflow.id}' , found '${Y==null?void 0:Y.length}' items.`);for(var fe of Y)m.matchesTypesFor(fe.body,[bn.getTypeName()])?v.warn(508411920,y.CoreDefault,function(){return`Skipping a DirtyAreaSignal received from the model for ${o.workflow.id}`}):N({item:fe,opType:q.opType})}else N(q)}if(Q().stop(te.InvalidateWorkflow),S.size>0){var W=(k=(g=a==null?void 0:a[0])===null||g===void 0?void 0:g.reInvalidateAfterDebounce)!==null&&k!==void 0?k:!1;for(var B of S.entries()){var L=(0,jt.default)(B,2),O=L[0],D=L[1];if(br(o.workflow)){this.invalidateHybridSingleItemWorkflow(t,o,D);continue}this.queueOrSetScopeExecutionNotification(!Da(o.workflow),Bn(O),o,t,C,W,D)}}}},{key:"invalidateHybridSingleItemWorkflow",value:function(t,o,a){var s,u=Q(),l=u.startSync(te.InvalidateHybridSingleItemWorkflow),c=o.workflow;for(var f of a)if(f!=null&&f.item){var d=f.item.contextId;if(m.matchesTypesFor(f.item.body,(0,se.default)(c.inputTypes))){var p=f.item;this.workflowItemStorage.setScopeItem(p,c),u.stop(l),this.queueOrSetScopeExecutionNotification(!1,[].concat((0,se.default)(p.parentPath),[p.id]),o,t,!0,(s=f.reInvalidateAfterDebounce)!==null&&s!==void 0?s:!1,[{item:p}],f==null?void 0:f.triggerSignals);return}if(!Ba.typeGuard(f.item.body))continue;var g=f.item.body;if(!c.correlatedSignals.includes(g.id))continue;var k=this.workflowItemStorage.getScopeItem(d,c);if(!k)continue;var S=this.notificationManager.get(c.id,k.contextId);if(!S){v.info(525218563,y.CoreDefault,`Workflow ${c.id}, contextId ${k.contextId}, already executed, skipping new scope execution`);continue}this.workflowItemStorage.addItemToWorkflowList(f.item,c),u.stop(l),this.tryToQueueExecutionNotification(S,function(){},H("EnableRequestedContextForJoinWorkflows")?this.resolveAndValidateContextsAndEvents.bind(this):function(C,x){return[!0,!0,[]]},!0)&&this.notificationManager.delete(c.id,k.contextId),u.resume(l)}u.stop(l)}},{key:"invalidateDynamicWorkflow",value:function(t,o,a){var s,u,l,c,f,d=new Map,p=!1;if(H("RefactoredScopeResolving")){var g=this.workflowExecutionScopesResolver.resolve(o,a);for(var k of g)d.set(z(k.scopePath),k.itemIds)}else{var S=function(F,q){var J;if(!d.has(F))d.set(F,[]);else if(((J=d.get(F))===null||J===void 0?void 0:J.length)===0)return;q!==void 0&&d.get(F).push(q.id)};for(var C of a)if(C.item)S(z(C.item.parentPath),C.item);else if(p=!(!((s=a==null?void 0:a[0])===null||s===void 0)&&s.updatedContextScope),o.workflow.inputTypes){var x=this.sessionCache.getSubtreeItems((l=(u=a==null?void 0:a[0])===null||u===void 0?void 0:u.updatedContextScope)!==null&&l!==void 0?l:[],o.workflow.inputTypes);for(var T of x)S(z(T.parentPath))}}Q().stop(te.InvalidateWorkflow);var I=(f=(c=a==null?void 0:a[0])===null||c===void 0?void 0:c.reInvalidateAfterDebounce)!==null&&f!==void 0?f:!1;for(var _ of d.entries()){var M=(0,jt.default)(_,2),b=M[0],A=M[1];this.queueOrSetScopeExecutionNotification(!1,Bn(b),o,t,p,I,void 0,void 0,A)}}},{key:"invalidateReduceWorkflow",value:function(t,o,a){var s,u,l,c=Da(o.workflow);if(!this.tryInvalidateReduceWorkflowUsingIntersection(t,o,c,a))if(H("RefactoredScopeResolving")){var f=this.workflowExecutionScopesResolver.resolve(o,[a]);for(var d of f)Q().stop(te.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(d.tryToQueue,d.scopePath,o,t,d.ignoreMinDelay,(s=a.reInvalidateAfterDebounce)!==null&&s!==void 0?s:!1,void 0,a.triggerSignals)}else if(a!=null&&a.item){if(o.invalidationFilter&&o.invalidationFilter(a.item)===!1){v.verbose(537678272,y.CoreDefault,function(){return`Filtered out reduce invalidation for item with parent path [${[].concat((0,se.default)(a.item.parentPath),[a.item.id])}]`});return}var p=this.sessionCache.getFirstAncestorOfType([].concat((0,se.default)(a.item.parentPath),[a.item.id]),[o.workflow.collectionScopeType]);if(p){a.item=p;var g=[].concat((0,se.default)(p.parentPath),[p.id]);Q().stop(te.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(!1,g,o,t,!1,(u=a.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,void 0,a.triggerSignals)}else return}else{var k=void 0;H("AllowUndefinedCollectionScopeTypeV2")&&!o.workflow.collectionScopeType?k=this.sessionCache.getItemChildren([],[]):k=this.sessionCache.getSubtreeItems((l=a==null?void 0:a.updatedContextScope)!==null&&l!==void 0?l:[],[o.workflow.collectionScopeType]),H("ExtraLoggingInSeedingAndWorkflowInvalidation")&&(k==null?void 0:k.length)===0&&v.info(506479707,y.CoreDefault,`Workflow: '${o.workflow.id}' item with type: '${o.workflow.collectionScopeType}' does not exists in the model`),this.invalidateReduceWorkflowForMultipleRootItems(k,t,o,c,a)}}},{key:"getAreaIntersectionFilter",value:function(t){var o=this;return function(a){return o.supportsAreaIntersection(a.body)&&o.areasIntersect(a.body,t)}}},{key:"tryInvalidateReduceWorkflowUsingIntersection",value:function(t,o,a,s){var u,l,c,f=void 0,d=!1;if(!s||m.getTypeNameFor((u=s.item)===null||u===void 0?void 0:u.body)==o.workflow.collectionScopeType)return!1;var p;if(H("UserAreaIntersectionChecker")?p=this.areaIntersectionChecker.supportsAreaIntersection((l=s.item)===null||l===void 0?void 0:l.body):p=this.supportsAreaIntersection((c=s.item)===null||c===void 0?void 0:c.body),p?f=s.item.body:(f=r.getDirtyAreaSingleSignalTrigger(s.triggerSignals),d=!!f),!f)return!1;var g;H("UserAreaIntersectionChecker")?g=this.areaIntersectionChecker.getAreaIntersectionFilter(f):g=this.getAreaIntersectionFilter(f);var k=this.sessionCache.getSubtreeItems([],[o.workflow.collectionScopeType],g);return v.info(508560338,y.CoreDefault,`tryInvalidateReduceWorkflowUsingIntersection: Using intersection for workflow '${o.workflow.id}' , dirty area type: '${m.getTypeNameFor(f)}', found '${k==null?void 0:k.length}' items.`),(k==null?void 0:k.length)>0?(this.invalidateReduceWorkflowForMultipleRootItems(k,t,o,a,s),!0):d}},{key:"invalidateReduceWorkflowForMultipleRootItems",value:function(t,o,a,s,u){var l=this,c,f=!(!((c=u==null?void 0:u[0])===null||c===void 0)&&c.updatedContextScope),d=function(S){if(a.invalidationFilter&&a.invalidationFilter(S)===!1)return v.info(508560337,y.CoreDefault,function(){return`Filtered out reduce invalidation for item with parent path [${[].concat((0,se.default)(S.parentPath),[S.id])}]`}),{v:void 0};Q().stop(te.InvalidateWorkflow),l.queueOrSetScopeExecutionNotification(!s&&!gd(a.workflow),[].concat((0,se.default)(S.parentPath),[S.id]),a,o,f,!1,void 0,u==null?void 0:u.triggerSignals)},p;for(var g of t)if(p=d(g),p)return p.v}},{key:"isReadyToEarlyJoin",value:function(t,o){var a=bw.getValue(),s=function(p){var g,k=Array.from((g=p.states)!==null&&g!==void 0?g:[]).map(function(C){return`${C[0]}: ${C[1].map(function(x){return x.join()})}`}).join(";"),S=new E({operationName:"EarlyJoinCompletion",resourceId:t.workflow.id,joinContextId:o,success:!0}).start();S.resultDescription=`isReadyToEarlyJoin (${a}) -> hasProcessedAllInputItems: ${p.hasProcessedAllInputItems}, allUpstreamComplete: ${p.allUpstreamComplete}, states: ${k}`,v.info(512550801,y.CoreDefault,S.stop())},u=t.countItemsToProcess(o)===0;if(!u)return s({hasProcessedAllInputItems:u}),!1;var l=this.areAllUpstreamWorkflowComplete(t,o),c=l.allUpstreamComplete,f=l.states;return s({hasProcessedAllInputItems:u,allUpstreamComplete:c,states:f}),a?c:!1}},{key:"areAllUpstreamWorkflowComplete",value:function(t,o){var a=new Map;for(var s of t.allUpstreamWorkflowExecutionTrackers){var u=s.workflowExecutionTracker,l=[];for(var c of u.getExecutionState()){var f=(0,jt.default)(c,2),d=f[0],p=f[1];if(l.push([d,p]),Ft.isParentContextId(o,d))return a.set(u.workflow.id,l),{allUpstreamComplete:!1,states:a}}l.length>0&&a.set(u.workflow.id,l)}return{allUpstreamComplete:!0,states:a}}},{key:"isAnyContextProducerRunning",value:function(t,o){for(var a of o)if(t.contextProducerPendingExecCountByScope.get(z(a))>0)return!0;return!1}},{key:"invalidateJoinWorkflow",value:function(t,o,a){var s=this,u=function(f){var d,p=[].concat((0,se.default)(f.parentPath),[f.id]),g=o.workflow;if(o.invalidationFilter&&o.invalidationFilter(f)===!1){v.info(537678274,y.CoreDefault,function(){return`Filtered out join invalidation for item with parent path [${p}]`});return}var k=f.contextId;if(m.matchesTypesFor(f.body,[g.collectionScopeType])){var S=f;s.workflowItemStorage.setScopeItem(S,g),v.info(537678275,y.CoreDefault,function(){return`WEM.invalidateJoinWorkflow :: Scope item: ${f.id} (${m.getTypeNameFor(f.body)}), workflow: ${g.id}, contextId: ${k}`}),Q().stop(te.InvalidateWorkflow),s.queueOrSetScopeExecutionNotification(!1,[].concat((0,se.default)(S.parentPath),[S.id]),o,t,!0,(d=a.reInvalidateAfterDebounce)!==null&&d!==void 0?d:!1,[{item:S,isDeltaUpdate:a.isDeltaUpdate,opType:a.opType}],a==null?void 0:a.triggerSignals)}else{t.removeProcessedInputItem(k);var C=s.workflowItemStorage.getScopeItem(k,g);if(!C){v.info(537678276,y.CoreDefault,function(){return`There is no scope item stored for workflow: ${g.id}, contextId: ${k}`});return}v.info(537678277,y.CoreDefault,function(){return`WEM.invalidateJoinWorkflow :: Input item: ${f.id} (${m.getTypeNameFor(f.body)}), workflow: ${g.id}, contextId: ${k}`}),s.workflowItemStorage.addItemToWorkflowList(f,g);var x=s.isReadyToEarlyJoin(t,C.contextId);if(s.workflowItemStorage.isWorkflowReady(C.contextId,g)||x){var T=s.notificationManager.get(g.id,C.contextId);if(!T){v.info(537678278,y.CoreDefault,`Workflow ${g.id}, contextId ${C.contextId}, already queued, skipping new scope execution`);return}Q().stop(te.InvalidateWorkflow),s.tryToQueueExecutionNotification(T,function(){},H("EnableRequestedContextForJoinWorkflows")?s.resolveAndValidateContextsAndEvents.bind(s):function(I,_){return[!0,!0,[]]},!1)&&s.notificationManager.delete(g.id,C.contextId)}}};if(a!=null&&a.item)u(a.item);else if(o.workflow.inputStage===zt.OnSeed&&a.triggerSignals===void 0)for(var l of this.sessionCache.getSubtreeItems([],[o.workflow.collectionScopeType]))u(l)}},{key:"invalidateGenericWorkflow",value:function(t,o,a){var s,u,l,c;if(H("RefactoredScopeResolving")){var f=this.workflowExecutionScopesResolver.resolve(o,[a]);Q().stop(te.InvalidateWorkflow);for(var d of f)this.queueOrSetScopeExecutionNotification(d.tryToQueue,d.scopePath,o,t,d.ignoreMinDelay,(s=a.reInvalidateAfterDebounce)!==null&&s!==void 0?s:!1,void 0,a==null?void 0:a.triggerSignals,d.itemIds)}else{var p=void 0;if(a!=null&&a.item){var g=void 0;if(o.workflow.dynamicExecutionPreferences)g=a.item.parentPath,p=[a.item.id];else{var k=this.sessionCache.getFirstAncestorOfType([].concat((0,se.default)(a.item.parentPath),[a.item.id]),[o.workflow.collectionScopeType]);if(k)g=[].concat((0,se.default)(k.parentPath),[k.id]);else return}Q().stop(te.InvalidateWorkflow),this.queueOrSetScopeExecutionNotification(!1,g,o,t,!1,(u=a.reInvalidateAfterDebounce)!==null&&u!==void 0?u:!1,void 0,a==null?void 0:a.triggerSignals,p)}else{var S=!(!((l=a==null?void 0:a[0])===null||l===void 0)&&l.updatedContextScope),C=new Set;if(o.workflow.dynamicExecutionPreferences){var x=this.sessionCache.getSubtreeItems([],o.workflow.inputTypes);for(var T of x)C.add(T.parentPath)}else{var I=this.sessionCache.getSubtreeItems((c=a==null?void 0:a.updatedContextScope)!==null&&c!==void 0?c:[],[o.workflow.collectionScopeType]);for(var _ of I||[])C.add([].concat((0,se.default)(_.parentPath),[_.id]))}Q().stop(te.InvalidateWorkflow);for(var M of C||[])this.queueOrSetScopeExecutionNotification(!Da(o.workflow)&&!gd(o.workflow),M,o,t,S,!1,void 0,a==null?void 0:a.triggerSignals,p)}}}},{key:"validateExecution",value:function(t,o){var a,s=Q().startSync(te.ValidateWorkflowExecution);try{var u=t.registration.workflow.triggerConditions;if(((a=t.triggerSignals)===null||a===void 0?void 0:a.length)>0&&!(u!=null&&u.includes(Vt.UpstreamWorkflowsReady)))return!0;if(H("EnableTriggerConditionDeltaUpdate")&&t.minTime&&!t.reInvalidateAfterDebounce&&!this.meetsDelayCondition(t)||!H("EnableTriggerConditionDeltaUpdate")&&t.registration.workflow.minDelayMs!==void 0&&t.registration.workflow.maxDelayMs!==void 0&&!t.reInvalidateAfterDebounce&&!this.meetsDelayCondition(t)||u!=null&&u.includes(Vt.UpstreamWorkflowsReady)&&t.registration.workflow.kind!=V.SingleItem&&!this.meetsUpstreamWorkflowsReadyCondition(t.registration.workflow.id,t.scopePath))return!1;if(t.registration.workflow.kind===V.Join||br(t.registration.workflow)){var l=Date.now(),c=t.registration.workflow,f=t.params[0].item.contextId,d=this.workflowDefinitionManager.getWorkflowDefinition(c,f).maxDelayMs;return this.workflowItemStorage.isWorkflowReady(f,c)?(v.info(537678279,y.CoreDefault,`Workflow: ${c.id} queuing by maxAnnotation, contextId: ${f}`),!0):t.startTime+d<l?(v.info(537678280,y.CoreDefault,`Workflow: ${c.id} queuing by maxTimeout, contextId: ${f}, timeout: ${d}`),!0):this.isReadyToEarlyJoin(this.workflowExecutionTrackersByName.get(c.id),f)?(v.info(512557890,y.CoreDefault,`Workflow: ${c.id} queuing by early completion, contextId: ${f}, timeout: ${d}`),!0):!1}return!(!o&&this.notificationManager.get(t.registration.workflow.id,z(t.scopePath)))}finally{Q().stop(s)}}},{key:"meetsDelayCondition",value:function(t){var o=Date.now();return t.minTime===void 0||o>t.minTime}},{key:"meetsUpstreamWorkflowsReadyCondition",value:function(t,o){return this.workflowExecutionTrackersByName.get(t).areUpstreamWorkflowsReadyByScope(o)}},{key:"onExecutionStateChange",value:function(t,o,a){o!==a&&this.emit("executionStateChange",t,o)}},{key:"ensureSweepTimer",value:function(t){this.sweepTimer||(this.sweepTimer=setInterval(this.onSweep.bind(this),this.sweepIntervalMs),this.sweepTimer.unref&&this.sweepTimer.unref(),t&&this.emit("pendingNotificationsChange",!1))}},{key:"onSweep",value:function(){this.emit("sweep"),this.sweepScopeExecutionNotifications()}},{key:"cancelSweepTimer",value:function(){this.sweepTimer?(clearInterval(this.sweepTimer),this.sweepTimer=void 0,Er.getValue()&&v.info(507896610,y.CoreDefault,"WorkflowExecutionManager.cancelSweepTimer: Cancelling sweep timer")):Er.getValue()&&v.info(507856777,y.CoreDefault,"WorkflowExecutionManager.cancelSweepTimer: sweep timer is not set - nothing to cancel")}},{key:"shouldSkipExecutionOnDeletedItem",value:function(t){return t.opType!==Cn.getTypeName()&&t.opType!==it.getTypeName()&&!this.sessionCache.hasItem([].concat((0,se.default)(t.item.parentPath),[t.item.id]))}},{key:"removeParamsForExecutionOnDeletedItem",value:function(t,o){var a;if(H("EnableSkippingWorkflowExecutionForMissingItem")&&(t.registration.workflow.kind===V.SingleItem||t.registration.workflow.kind===V.Join)&&!dr(t.registration.workflow)){var s=(a=t.params)!==null&&a!==void 0?a:[],u=[];for(var l of s)this.shouldSkipExecutionOnDeletedItem(l)?(v.info(512296736,y.CoreDefault,`Invalidate Workflow Param for workflow ${t.registration.workflow.id} scopeItem is missing or deleted - skipping adding workflow param to execution.`),o&&this.workflowExecutionTrackersByName.get(t.registration.workflow.id).onExecutionTaskCompleted([].concat((0,se.default)(l.item.parentPath),[l.item.id]),this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache))):u.push(l);return t.params=u,u.length===0}return!1}},{key:"sweepScopeExecutionNotifications",value:function(){var t=this,o=!0,a=void 0,s=function(g,k){return t.resolveAndValidateContextsAndEvents(g,k,a)},u=function(g){var k=function(_,M){var b=function(){var N=Q(),F=N.find(te.WaitingForPendingScopeExecution);N.stop(F),!a&&t.isWorkflowRequestingContexts(M.registration.workflow)&&(a=t.getAllDocumentContextHolderPaths());var q=t.removeParamsForExecutionOnDeletedItem(M,!0);q||t.tryToQueueExecutionNotification(M,function(){},s,!0)?t.notificationManager.delete(g,_):(N.resume(F),o=!1)};H("ResumeCorrelationForSweepScopeExecutionNotifications")?ze(function(){b()},M.cc):b()};for(var S of d.entries()){var C=(0,jt.default)(S,2),x=C[0],T=C[1];k(x,T)}};for(var l of this.notificationManager.entries()){var c=(0,jt.default)(l,2),f=c[0],d=c[1];u(f)}o&&(v.debug(537678281,y.CoreDefault,"WorkflowExecutionManager.sweepScopeExecutionNotifications: No pending scope notifications left, cancelling sweep timer"),this.emit("pendingNotificationsChange",!0),this.cancelSweepTimer())}},{key:"tryToQueueExecutionNotification",value:function(t,o,a,s){var u=this,l,c,f,d=Q(),p=d.startSync(te.QueueExecutionNotification);try{if(!this.validateExecution(t,s))return!1;var g=function(fe){u.workflowExecutionTrackersByName.get(t.registration.workflow.id).onExecutionTaskCompleted(fe,u.sessionCache.getFirstAncestorOfType.bind(u.sessionCache))},k=a(t.registration,t.scopePath),S=(0,jt.default)(k,3),C=S[0],x=S[1],T=S[2];if(!x){if(Er.getValue()&&v.info(507896609,y.CoreDefault,"WorkflowExecutionManager.tryToQueueExecutionNotification: Required events are not ready"),s)if(t.registration.workflow.kind===V.SingleItem){var I=(l=t.params)!==null&&l!==void 0?l:[];for(var _ of I)g([].concat((0,se.default)(_.item.parentPath),[_.item.id]))}else g(t.scopePath);return!0}if(!C)return Er.getValue()&&v.info(507896608,y.CoreDefault,"WorkflowExecutionManager.tryToQueueExecutionNotification: Required contexts are not ready"),!1;try{if(t.registration.workflow.kind===V.SingleItem){var M=(c=t.params)!==null&&c!==void 0?c:[];for(var b of M)o([].concat((0,se.default)(b.item.parentPath),[b.item.id]));this.queueSingleItemWorkflow(t.registration,M,T)}else if(t.registration.workflow.kind===V.Reduce||t.registration.workflow.kind===V.Grid)try{var A=this.sessionCache.getItem(t.scopePath);o(t.scopePath),this.queueReduceWorkflow(t.registration,at(t.scopePath.slice(0,-1),A),t.triggerSignals,T,t.isTriggeredByEvents,g,z(t.scopePath))}catch(Y){v.debug(537678282,y.CoreDefault,"Subtree no longer exists, skipping queue workflow execution")}else if(t.registration.workflow.kind===V.DynamicText)o(t.scopePath),this.queueDynamicWorkflow(t.registration,t.scopePath,t.dynamicItemIds,T,t.isTriggeredByEvents,g);else if(t.registration.workflow.kind===V.Join){var N=t.params[0].item.contextId,F=this.workflowItemStorage.getScopeItem(N,t.registration.workflow);F?(o([].concat((0,se.default)(F.parentPath),[F.id])),this.queueJoinWorkflow(t.registration,F,T,g,N)):v.debug(537678283,y.CoreDefault,"ContextId no longer exists, skipping queue workflow execution")}else t.registration.workflow.kind===V.Generic?this.queueGenericWorkflow(t,o,T,g):v.error(537678284,y.CoreDefault,`Workflow in type ${t.registration.workflow.kind} is not supported`)}catch(Y){if(s)if(t.registration.workflow.kind===V.SingleItem){var q=(f=t.params)!==null&&f!==void 0?f:[];for(var J of q)g([].concat((0,se.default)(J.item.parentPath),[J.item.id]))}else g(t.scopePath);v.warn(537678285,y.CoreDefault,`WorkflowExecutionManager.tryToQueueExecutionNotification: Trying to queue ${t.registration.workflow.id} caused an exception: ${Y}`)}return Er.getValue()&&v.info(507896607,y.CoreDefault,`WorkflowExecutionManager.tryToQueueExecutionNotification: Queued workflow ${t.registration.workflow.id} due to ${t.triggerSignals.length} signals`),!0}finally{d.stop(p)}}},{key:"isDeltaTriggeredWorkflow",value:function(t){var o;return(o=this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).triggerConditions)===null||o===void 0?void 0:o.includes(Vt.DeltaUpdate)}},{key:"calculateWorkflowMinAndMaxStartTime",value:function(t,o){var a=void 0;Da(t.workflow)?a={minDelayMs:t.workflow.minDelayMs,maxDelayMs:t.workflow.maxDelayMs}:this.enableDeltaUpdateDelay.getValue()&&!this.isDeltaTriggeredWorkflow(t)&&(o!=null&&o.every(function(c){return c.isDeltaUpdate}))&&(a=_b());var s=Date.now(),u=a!=null&&a.minDelayMs?s+a.minDelayMs:void 0,l=s+ya(a==null?void 0:a.maxDelayMs,5e3);return{notificationStartTime:s,minTime:u,maxTime:l}}},{key:"queueOrSetScopeExecutionNotification",value:function(t,o,a,s,u,l,c,f,d){var p=this,g,k=Q().startSync(te.QueueOrSetScopeExecutionNotification),S,C,x;if(H("EnableTriggerConditionDeltaUpdate")){var T=this.calculateWorkflowMinAndMaxStartTime(a,c);x=T.notificationStartTime,S=T.minTime,C=T.maxTime}else x=Date.now(),S=x+ya(a.workflow.minDelayMs,1e3),C=x+ya(a.workflow.maxDelayMs,5e3);var I={registration:a,scopePath:o,params:c,triggerSignals:f!=null?f:[],startTime:x,minTime:H("IgnoreMinTimeWorkflowExecution")&&u?void 0:S,maxTime:C,dynamicItemIds:d?new Set(d):void 0,reInvalidateAfterDebounce:l,isTriggeredByEvents:(g=c==null?void 0:c[0])===null||g===void 0?void 0:g.isInvalidatedByEvents,cc:ut()},_=function(A){s.invalidateWorkflow(A,p.sessionCache.getFirstAncestorOfType.bind(p.sessionCache))};Q().stop(k);var M=!1;(t||l)&&(M=this.tryToQueueExecutionNotification(I,_,this.resolveAndValidateContextsAndEvents.bind(this),!1)),M||this.setScopeExecutionNotification(o,a,_,I)}},{key:"setScopeExecutionNotification",value:function(t,o,a,s){var u=Q().startSync(te.SetScopeExecutionNotification),l=void 0;s.params&&s.params[0].item.contextId&&(l=s.params[0].item.contextId);var c=z(t);l&&(o.workflow.kind===V.Join||br(o.workflow))&&(c=l);var f=this.notificationManager.get(o.workflow.id,c);if(f)(!H("IgnoreMinTimeWorkflowExecution")||f.minTime)&&(f.minTime=s.minTime?Math.min(s.minTime,ya(f.maxTime,s.maxTime)):void 0),s.reInvalidateAfterDebounce?(f.triggerSignals=s.triggerSignals.concat(f.triggerSignals),f.reInvalidateAfterDebounce=s.reInvalidateAfterDebounce):f.triggerSignals=f.triggerSignals.concat(s.triggerSignals),f.registration.workflow.dynamicExecutionPreferences&&s.dynamicItemIds!==void 0&&s.dynamicItemIds.forEach(function(p){return f.dynamicItemIds.add(p)}),H("ScopeExecutionNotificationUpdateParams")&&f.registration.workflow.kind===V.SingleItem&&this.updateScopeNotificationParams(f,s),o.workflow.kind===V.Join&&v.info(537678288,y.CoreDefault,`Dropping new scope notification for ${o.workflow.id}: ${c}, contextId: ${l}`);else if(v.info(537678286,y.CoreDefault,function(){return`New pending scope execution for ${o.workflow.id} at ${c} ${o.workflow.kind===V.Join||br(o.workflow)?", ("+l+")":""}`}),this.notificationManager.set(o.workflow.id,c,s),o.workflow.kind==V.SingleItem)for(var d of s.params)a([].concat((0,se.default)(d.item.parentPath),[d.item.id]));else a(t);Q().stop(u),f||Q().startAsync(te.WaitingForPendingScopeExecution),this.ensureSweepTimer(!0)}},{key:"updateScopeNotificationParams",value:function(t,o){var a,s,u=new E({operationName:"setScopeExecutionNotification_updateParams",resourceId:t.registration.workflow.resourceId,success:!0}).start();try{if(H("DoNotOrderParamsByRevId")){if(o.params)if(o.reInvalidateAfterDebounce)t.params=o.params.concat(t.params);else{var l;(l=t.params).push.apply(l,(0,se.default)(o.params))}return}if(o.params)for(var c of o.params){var f=!1;if(!((a=c.item)===null||a===void 0)&&a.revId){for(var d of t.params)if(!((s=d.item)===null||s===void 0)&&s.revId&&c.item.id===d.item.id){f=!0,parseInt(c.item.revId,10)>parseInt(d.item.revId,10)&&(d.item=c.item);break}}f||t.params.push(c)}}finally{v.info(537678287,y.CoreDefault,u.stop())}}},{key:"fetchInputChanges",value:function(t,o,a){var s=this,u;if(!((u=t.modelOptions)===null||u===void 0)&&u.includeItemOperations){var l=new E({operationName:"FetchInputChanges",success:!0,resourceId:t.id}).start(),c=[].concat((0,se.default)(a.parentPath),[a.id]);this.inputChangesManager.setWorkflowInputs(o.map(function(S){var C=m.getTypeNameFor(S.body);return{path:[].concat((0,se.default)(S.parentPath),[S.id]),deltaType:s.getDeltaType(C,t)}}),t.id,c);for(var f=this.inputChangesManager.getChanges(t.id,c),d=0,p=0;d<o.length&&p<f.length;){var g=Object.assign({},o[d]),k=f[p];if(k.op!==St.Deleted){if(z([].concat((0,se.default)(g.parentPath),[g.id]))!==z([].concat((0,se.default)(k.parentPath),[k.id])))throw new Error("Input changes are not in order with input items.");g.op=k.op,g.delta=k.delta,f[p]=g,d++}p++}return l.stop().durationMs>10&&v.info(537678289,y.CoreDefault,l),f}}},{key:"getDeltaType",value:function(t,o){var a,s,u=(a=o.deltaTypesByInputType)===null||a===void 0?void 0:a[t];return!u&&(!((s=o.modelOptions)===null||s===void 0)&&s.includeDefaultItemDeltas)&&(u=Db.get(t)),u}},{key:"fetchParentItem",value:function(t,o){var a,s;if(!(!(!((a=t.modelOptions)===null||a===void 0)&&a.includeScopeItemParent)&&!(!((s=t.modelOptions)===null||s===void 0)&&s.includeRootItemParent)))try{var u=this.sessionCache.getItem(o.parentPath);return at(o.parentPath.slice(0,-1),u)}catch(c){var l=`Fetching parent item with path: ${z(o.parentPath)}. Error: ${c}`;throw v.error(537678290,y.CoreDefault,l),new Error(l)}}},{key:"queueSingleItemWorkflowTask",value:function(t,o){var a=Q(),s=a.find(te.QueueExecutionNotification),u=this.workflowSynchronizationManager.notifyBeforeQueueing(o,t);if(u){this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(o.scopeItem.contextId,xe.Running);var l=this.evaluatePrefilters(t.workflow,o,Ln.WithActionDefinition);o.prefilterActionResults=l.prefilterActionResults;var c=!l.shouldExecuteWorkflow;a.stop(s),this.queueWorkflow(t,[o],c),a.resume(s)}}},{key:"queueSingleItemWorkflowTasksWithBatching",value:function(t,o){var a=this,s=Q(),u=s.find(te.QueueExecutionNotification),l=this.workflowSynchronizationManager.notifyBeforeBatchedQueuing(o,t);if(l.length>0){l.forEach(function(k){return a.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(k.scopeItem.contextId,xe.Running)});var c=this.prefilterAndSplitTasksBeforeQueing(t,l),f=c.workflowTasks,d=c.prefilteredTasks;for(var p of this.batchSplitter.getBatchesByItemPath(f,function(){return a.getWorkflowBatchSizeMax(t)},function(k){return k.scopeItem}))s.stop(u),this.queueWorkflow(t,p),s.resume(u);for(var g of this.batchSplitter.getBatches(d,function(){return a.getWorkflowBatchSizeMax(t)}))s.stop(u),this.queueWorkflow(t,g,!0),s.resume(u)}}},{key:"queueSingleItemWorkflow",value:function(t,o,a){var s=this;if(br(t.workflow)){this.queueHybridSingleItemWorkflow(t,o,a);return}if(this.usesRefactoredDebouncing){var u=o.map(function(k){return s.createSingleItemWorkflowTask(k,t,a)});u.length===1?this.queueSingleItemWorkflowTask(t,u[0]):this.queueSingleItemWorkflowTasksWithBatching(t,u)}else{var l=Q(),c=l.find(te.QueueExecutionNotification),f=[];for(var d of this.batchSplitter.getBatchesByItemPath(o,function(){return s.getWorkflowBatchSizeMax(t)},function(k){return k.item})){var p=function(S){var C=[].concat((0,se.default)(S.item.parentPath),[S.item.id]),x=s.fetchParentItem(t.workflow,S.item);s.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(S.item.contextId,xe.Running);var T={scopeItem:S.item,inputItems:x?[S.item,x]:[S.item],requestedContextsAndEvents:a,executionScopeId:s.shouldSkipSynchronization(S)?void 0:z(C),previousAnnotations:r.fetchExistingAnnotations(t.workflow,C,s.sessionCache),onComplete:function(){return s.onExecutionTaskCompleted(t.workflow.id,S.item)},extensibleWorkflowContext:s.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:et.Pending,opType:S.opType};f.push(T)};for(var g of d)p(g);l.stop(c),this.queueWorkflow(t,f),l.resume(c),f=[]}}}},{key:"createSingleItemWorkflowTask",value:function(t,o,a){var s=this,u=[].concat((0,se.default)(t.item.parentPath),[t.item.id]),l=this.fetchParentItem(o.workflow,t.item),c={scopeItem:t.item,inputItems:l?[t.item,l]:[t.item],requestedContextsAndEvents:a,executionScopeId:this.shouldSkipSynchronization(t)?void 0:z(u),previousAnnotations:r.fetchExistingAnnotations(o.workflow,u,this.sessionCache),onComplete:function(){return s.onExecutionTaskCompleted(o.workflow.id,t.item)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:et.Pending,opType:t.opType,maxSynchronizationEndTimeMs:t.maxSynchronizationEndTimeMs};return c}},{key:"getExtensibleWorkflowContext",value:function(){var t=["session",`ext-${Am}`];return this.sessionCache.hasItem(t)?this.sessionCache.getItem(t).body:void 0}},{key:"queueHybridSingleItemWorkflow",value:function(t,o,a){var s=this,u=function(){var d=c.item,p=s.workflowItemStorage.getItemsToExecute(d.contextId,t.workflow);if(p.length===0)return s.workflowItemStorage.onWorkflowExecuted(d,t.workflow),v.info(525218564,y.CoreDefault,`Failed to retrieve items for workflow: ${t.workflow.id}, contextId: ${d.contextId}`),{v:void 0};if(s.usesRefactoredDebouncing){var g=[].concat((0,se.default)(d.parentPath),[d.id]),k={scopeItem:d,inputItems:[d],requestedContextsAndEvents:a,executionScopeId:s.shouldSkipSynchronization(c)?void 0:z(g),previousAnnotations:r.fetchExistingAnnotations(t.workflow,g,s.sessionCache),onComplete:function(){return s.onExecutionHybridSingleItemTaskCompleted(t.workflow,d)},extensibleWorkflowContext:s.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:et.Pending},S=s.workflowSynchronizationManager.notifyBeforeQueueing(k,t);if(S){v.info(525218565,y.CoreDefault,`WEM.queueHybridSingleItemWorkflow :: ${t.workflow.id} queued input: ${d.id}, contextId: ${d.contextId}, correlatedSignal: ${p[0].id}`),s.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(d.contextId,xe.Running);var C=s.evaluatePrefilters(t.workflow,k,Ln.WithActionDefinition);k.prefilterActionResults=C.prefilterActionResults;var x=!C.shouldExecuteWorkflow;s.queueWorkflow(t,[k],x)}}else v.info(509747276,y.CoreDefault,`WEM.queueHybridSingleItemWorkflow :: ${t.workflow.id} queued input: ${d.id}, contextId: ${d.contextId}, correlatedSignal: ${p[0].id}`),s.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(d.contextId,xe.Running),s.queueWorkflow(t,[{scopeItem:d,inputItems:[d],requestedContextsAndEvents:a,executionScopeId:s.shouldSkipSynchronization(c)?void 0:z([].concat((0,se.default)(c.item.parentPath),[c.item.id])),previousAnnotations:r.fetchExistingAnnotations(t.workflow,[].concat((0,se.default)(c.item.parentPath),[c.item.id]),s.sessionCache),onComplete:function(){return s.onExecutionHybridSingleItemTaskCompleted(t.workflow,d)},extensibleWorkflowContext:s.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:et.Pending}])},l;for(var c of o)if(l=u(),l)return l.v}},{key:"getContextHolderPaths",value:function(t){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:void 0;if(H("UseWorkflowContextManager"))return this.workflowContextsManager.getContextHolderPaths(t,o);var a=H("AddSessionAsContextHolder")?[this.getUserNodePath(),this.getTenantNodePath(),["session"]]:[this.getUserNodePath(),this.getTenantNodePath()],s=[].concat(a),u=[],l=o!=null?o:this.getAllDocumentContextHolderPaths();if(t)for(var c of l)Wn(c,t)?s.push(c):Wn(t,c)&&u.push(c);else s=s.concat(l);return[s,u]}},{key:"getAllDocumentContextHolderPaths",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"session",o;return H("UseWorkflowContextManager")?this.workflowContextsManager.getAllDocumentContextHolderPaths(t):((o=this.sessionCache.getSubtreeItems([t],[bt.getTypeName(),zn.getTypeName(),so.getTypeName()]))!==null&&o!==void 0?o:[]).map(function(a){return[].concat((0,se.default)(a.parentPath),[a.id])})}},{key:"getAllContexts",value:function(t){var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],a;if(H("UseWorkflowContextManager"))return this.workflowContextsManager.getAllContexts(t,o);var s=[];for(var u of t){var l=(a=this.sessionCache.getItemChildren(u,o))!==null&&a!==void 0?a:[];if(s.push.apply(s,l),H("ContextHolderAsSelfContext")){var c=this.sessionCache.getItem(u);c!=null&&c.body&&m.matchesTypesFor(c.body,o)&&s.push(at(u.slice(0,-1),c))}}return s}},{key:"resolveAndValidateAllRequestedContexts",value:function(t,o){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,s=Q().startSync(te.ResolveAndValidateAllRequestedContexts);try{var u=[];if(this.isWorkflowRequestingContexts(t.workflow)){var l=this.getContextHolderPaths(o,a),c=(0,jt.default)(l,2),f=c[0],d=c[1],p=sr(this.workflowDefinitionManager.getWorkflowDefinition(t.workflow).requestedContextTypesRules),g=p.map(function(_){var M=(0,jt.default)(_,2),b=M[0],A=M[1];return b});u=this.getAllContexts(f,g);var k=H("FixRequiredContextBaseTypes")?new Set(u.flatMap(function(_){return m.getAllTypesFor(_.body)})):new Set(u.map(function(_){return m.getTypeNameFor(_.body)}));for(var S of p){var C=(0,jt.default)(S,3),x=C[0],T=C[1],I=C[2];if(T==Tr.Required&&!k.has(x))return Er.getValue()&&v.info(507896606,y.CoreDefault,`WorkflowExecutionManager.resolveAndValidateAllRequestedContexts: Required context type ${x} not available for workflow ${t.workflow.id}`),[!1,[]];if(I===Eo.Always&&this.isAnyContextProducerRunning(this.workflowExecutionTrackersByName.get(t.workflow.id),f))return Er.getValue()&&v.info(507896605,y.CoreDefault,`WorkflowExecutionManager.resolveAndValidateAllRequestedContexts: Required context type ${x} not available for workflow ${t.workflow.id} - producer is running`),[!1,[]]}u=u.concat(this.getAllContexts(d,g))}return[!0,u]}finally{Q().stop(s)}}},{key:"getRequestedEvents",value:function(t){var o=this.sessionCache.getItemChildren(this.getUserCommandsNodePath(),[Fr.getTypeName()]);return o=o.filter(function(a){return Ys(a.body,t)}),o.sort(function(a,s){return a.body.timestamp-s.body.timestamp}),t.maxWindowSize&&(o=o.slice(-t.maxWindowSize)),o}},{key:"resolveAndValidateEvents",value:function(t){var o,a;if(!H("EnableUserCommands"))return[!0,[]];var s=[];if(t.workflow.eventSequenceOptions){var u=t.workflow.eventSequenceOptions;if(Date.now()-this.sessionCreationTime<((o=u.minTimeFrame)!==null&&o!==void 0?o:0))return[!u.required,[]];if(s=this.getRequestedEvents(u),s.length<((a=u.minWindowSize)!==null&&a!==void 0?a:1))return[!u.required,[]]}return[!0,s]}},{key:"resolveAndValidateContextsAndEvents",value:function(t,o){var a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:void 0,s=this.resolveAndValidateAllRequestedContexts(t,o,a),u=(0,jt.default)(s,2),l=u[0],c=u[1],f=this.resolveAndValidateEvents(t),d=(0,jt.default)(f,2),p=d[0],g=d[1],k=p&&l;return[l,p,k?c.concat(g):[]]}},{key:"isWorkflowRequestingContexts",value:function(t){var o;return((o=this.workflowDefinitionManager.getWorkflowDefinition(t).requestedContextTypesRules)!==null&&o!==void 0?o:[]).some(function(a){return a.contextTypes.length>0})}},{key:"getDeepestDocumentContextHolderPath",value:function(t,o){var a;if(H("UseWorkflowContextManager"))return this.workflowContextsManager.getDeepestDocumentContextHolderPath(t,o);var s=void 0,u=[].concat((0,se.default)(o.parentPath),[o.id]);for(var l of t)Wn(l,u)&&l.length>((a=s==null?void 0:s.length)!==null&&a!==void 0?a:0)&&(s=l);return s}},{key:"shouldSkipSynchronization",value:function(t){var o;return t.opType===Cn.getTypeName()||Ab.getValue()&&((o=t.item)===null||o===void 0?void 0:o.delta)!==void 0}},{key:"fetchExistingAnnotationsForItems",value:function(t,o){var a=this,s;if(!(!t.fetchExistingAnnotations&&!(!((s=t.modelOptions)===null||s===void 0)&&s.includeExistingAnnotations))){var u=new E({operationName:"FetchExistingAnnotationsForItems",success:!0,resourceId:t.id}).start(),l=o;if(H("FilterOutDuplicateItemsBeforeFetchExistingAnnotationsForItems")){var c=new Map(l.map(function(d){return[z([].concat((0,se.default)(d.parentPath),[d.id])),d]}));l=Array.from(c.values())}var f=[];return l.forEach(function(d){var p=r.fetchExistingAnnotations(t,[].concat((0,se.default)(d.parentPath),[d.id]),a.sessionCache);p==null||p.forEach(function(g){f.push(g)})}),u.stop().durationMs>10&&v.info(527524321,y.CoreDefault,u),f.length>0?f:void 0}}},{key:"queueReduceWorkflow",value:function(t,o,a,s,u,l,c){var f=this,d,p,g=[].concat((0,se.default)(o.parentPath),[o.id]),k=[];if(!H("FixReduceWorkflowWithoutInputs")||((d=t.workflow.inputTypes)===null||d===void 0?void 0:d.length)>0)try{var S;if(H("UserAreaIntersectionChecker")?S=this.areaIntersectionChecker.supportsAreaIntersection(o.body):S=this.supportsAreaIntersection(o.body),S){var C;H("UserAreaIntersectionChecker")?C=this.areaIntersectionChecker.getAreaIntersectionFilter(o.body):C=this.getAreaIntersectionFilter(o.body);var x=this.sessionCache.getSubtreeItems([],t.workflow.inputTypes,C),T=this.sessionCache.getSubtreeItems(g,t.workflow.inputTypes);k=(0,se.default)(new Set(x.concat(T)));var I=k.length-x.length;v.info(508597976,y.CoreDefault,`queueReduceWorkflow: Using intersection for workflow '${t.workflow.id}' , #itemsByRootPath: '${x.length}', #itemsByRootPath: '${I}'`)}else k=this.sessionCache.getSubtreeItems(g,t.workflow.inputTypes)}catch(q){v.error(537678291,y.CoreDefault,`Failed to retrieve subtree items for executing workflow ${t.workflow.id}: ${q.message}`),l(g);return}if(t.workflow.kind===V.Reduce||t.workflow.kind===V.Generic){var _={scopeItem:o,inputItems:(p=this.fetchInputChanges(t.workflow,k,o))!==null&&p!==void 0?p:k,requestedContextsAndEvents:s,executionScopeId:c,triggerSignals:a,previousAnnotations:this.fetchExistingAnnotationsForItems(t.workflow,[o].concat((0,se.default)(k))),onComplete:function(){return f.onExecutionTaskCompleted(t.workflow.id,o)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:u,status:et.Pending};if(!this.evaluatePrefilters(t.workflow,_,Ln.WithoutActionDefinition).shouldExecuteWorkflow){v.verbose(523351809,y.CoreDefault,function(){return`Filtered out workflow ${t.workflow.id} invalidation based on prefilter.`}),l(g);return}if((!_.inputItems||_.inputItems.length===0)&&v.info(527237130,y.CoreDefault,`Workflow: '${t.workflow.id}' queued with no inputs.`),this.usesRefactoredDebouncing){var M=this.workflowSynchronizationManager.notifyBeforeQueueing(_,t);if(!M){Q().stop(te.QueueExecutionNotification);return}var b=this.evaluatePrefilters(t.workflow,_,Ln.WithActionDefinition);_.prefilterActionResults=b.prefilterActionResults;var A=!b.shouldExecuteWorkflow;this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(o.contextId,xe.Running),Q().stop(te.QueueExecutionNotification),this.queueWorkflow(t,[_],A)}else this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(o.contextId,xe.Running),Q().stop(te.QueueExecutionNotification),this.queueWorkflow(t,[_])}else{var N=k.filter(function(q){return m.matchesTypesFor(q.body,[Mn.getTypeName()])}),F=k.filter(function(q){return!m.matchesTypesFor(q.body,[Mn.getTypeName()])});Q().stop(te.QueueExecutionNotification),this.queueGridNeighborhoodWorkflow(t,g,o,N,F,s,u,function(){f.onExecutionTaskCompleted(t.workflow.id,o)})}}},{key:"queueDynamicWorkflow",value:function(t,o,a,s,u,l){var c=this,f,d;if(t.workflow.dynamicExecutionPreferences.inputSize<-1||t.workflow.dynamicExecutionPreferences.inputSize===0){v.error(537678292,y.CoreDefault,"Workflow inputSize must be positive integers or -1."),l(o);return}var p=void 0;try{p=this.sessionCache.getItemChildren(o,[nt.getTypeName()])}catch(N){v.info(537678293,y.CoreDefault,`Failed to fetch children on parent item: ${z(o)}: ${N.message}`),l(o);return}if(!p||p.length===0){v.error(537678294,y.CoreDefault,`There are no children on parent item: ${z(o)}`),l(o);return}var g=xw(t,a,p);if(!g){l(o);return}if((t.workflow.dynamicExecutionPreferences.contextAbove!==void 0||t.workflow.dynamicExecutionPreferences.contextBelow!==void 0)&&((f=t.workflow.dynamicExecutionPreferences)===null||f===void 0?void 0:f.contextUnit)===void 0||t.workflow.dynamicExecutionPreferences.contextAbove===void 0&&t.workflow.dynamicExecutionPreferences.contextBelow===void 0&&((d=t.workflow.dynamicExecutionPreferences)===null||d===void 0?void 0:d.contextUnit)!==void 0){v.error(537678295,y.CoreDefault,"Workflow contextUnit and at least one of workflow [contextAbove, contextBelow] must also be specified."),l(o);return}if(t.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&t.workflow.dynamicExecutionPreferences.contextAbove<-1||t.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&t.workflow.dynamicExecutionPreferences.contextBelow<-1){v.error(537678296,y.CoreDefault,"Workflow contextAbove/contextBelow must be integers greater than or equal to -1."),l(o);return}var k=Q(),S=k.find(te.QueueExecutionNotification);if(this.usesRefactoredDebouncing){var C=[];for(var x of g){var T=this.createDynamicTextWorkflowTask(o,x,p,t,s,u);T&&C.push(T)}var I=this.workflowSynchronizationManager.notifyBeforeBatchedQueuing(C,t);for(var _ of this.batchSplitter.getBatches(I,function(){return c.getWorkflowBatchSizeMax(t)}))k.stop(S),this.queueWorkflow(t,_),k.resume(S);k.stop(S)}else{var M=[],b=function(){var F=(0,se.default)(o);A.forEach(function(Y){return F.push(Y.id)});var q=void 0;if(t.workflow.dynamicExecutionPreferences.contextUnit!==void 0&&(q=c.calculateDynamicTextContent(A,p,t),!q))return 1;var J=at(o.slice(0,-1),c.sessionCache.getItem(o));c.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(J.contextId,xe.Running),M.push({scopeItem:J,inputItems:A,executionScopeId:z(F),dynamicContextItems:q,requestedContextsAndEvents:s,onComplete:function(){return c.onExecutionTaskCompleted(t.workflow.id,J)},extensibleWorkflowContext:c.getExtensibleWorkflowContext(),isTriggeredByEvents:u,status:et.Pending}),k.stop(S),M.length>=c.getWorkflowBatchSizeMax(t)&&(c.queueWorkflow(t,M),M=[]),k.resume(S)};for(var A of g)b();M.length>0&&this.queueWorkflow(t,M)}}},{key:"createDynamicTextWorkflowTask",value:function(t,o,a,s,u,l){var c=this,f=(0,se.default)(t);o.forEach(function(g){return f.push(g.id)});var d=void 0;if(!(s.workflow.dynamicExecutionPreferences.contextUnit!==void 0&&(d=this.calculateDynamicTextContent(o,a,s),!d))){var p=at(t.slice(0,-1),this.sessionCache.getItem(t));return{scopeItem:p,inputItems:o,executionScopeId:z(f),dynamicContextItems:d,requestedContextsAndEvents:u,onComplete:function(){return c.onExecutionTaskCompleted(s.workflow.id,p)},isTriggeredByEvents:l,status:et.Pending}}}},{key:"calculateDynamicTextContent",value:function(t,o,a){var s;try{s=o.indexOf(t[0])}catch(x){v.error(537678297,y.CoreDefault,`Item ${t[0].id} not present within parent item's children.`);return}var u=a.workflow.dynamicExecutionPreferences.contextUnit,l=[],c=s-1;if(a.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&a.workflow.dynamicExecutionPreferences.contextAbove>0)for(var f=a.workflow.dynamicExecutionPreferences.contextAbove,d=0;c>=0&&d<f;){var p=o[c--];u===Nn.Character?(l.unshift(p),d+=p.body?p.body.content.length:0):u===Nn.Paragraph&&(l.unshift(p),d++)}else a.workflow.dynamicExecutionPreferences.contextAbove!==void 0&&a.workflow.dynamicExecutionPreferences.contextAbove===-1&&(l=o.slice(0,s));try{s=o.indexOf(t[t.length-1])}catch(x){v.error(537678298,y.CoreDefault,`Item ${t[t.length-1].id} not present within parent item's children.`);return}c=s+1;var g=[];if(a.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&a.workflow.dynamicExecutionPreferences.contextBelow>0)for(var k=a.workflow.dynamicExecutionPreferences.contextBelow,S=0;c<o.length&&S<k;){var C=o[c++];u===Nn.Character?(g.push(C),S+=C.body?C.body.content.length:0):u===Nn.Paragraph&&(g.push(C),S++)}else a.workflow.dynamicExecutionPreferences.contextBelow!==void 0&&a.workflow.dynamicExecutionPreferences.contextBelow===-1&&(g=o.slice(s+1));return{contextAbove:l,contextBelow:g}}},{key:"queueJoinWorkflow",value:function(t,o,a,s,u){var l=this,c=this.workflowItemStorage.getItemsToExecute(o.contextId,t.workflow);if(c.length===0){this.workflowItemStorage.onWorkflowExecuted(o,t.workflow),v.info(537678299,y.CoreDefault,`Failed to retrieve items for workflow: ${t.workflow.id}, contextId: ${o.contextId}`),s([].concat((0,se.default)(o.parentPath),[o.id]));return}if(H("EnableSkippingWorkflowExecutionForMissingItem")&&!dr(t.workflow)&&!Xt.typeGuard(o.body)&&!this.sessionCache.hasItem([].concat((0,se.default)(o.parentPath),[o.id]))){this.workflowItemStorage.onWorkflowExecuted(o,t.workflow),v.info(509748545,y.CoreDefault,`Invalidate Workflow Param for workflow ${t.workflow.id} scopeItem is missing or deleted from model cache - skipping adding workflow param to execution.`),s([].concat((0,se.default)(o.parentPath),[o.id]));return}v.info(537678300,y.CoreDefault,`WEM.queueJoinWorkflow :: ${t.workflow.id} queued inputs [${c.map(function(d){return d.id}).join(",")}], contextId: ${o.contextId}`),this.workflowExecutionTrackersByName.get(t.workflow.id).setExecutionState(o.contextId,xe.Running),Q().stop(te.QueueExecutionNotification);var f=this.usesRefactoredDebouncing?void 0:u;this.queueWorkflow(t,[{scopeItem:o,inputItems:c,requestedContextsAndEvents:a,executionScopeId:f,onComplete:function(){return l.onExecutionJoinTaskCompleted(t.workflow,o)},extensibleWorkflowContext:this.getExtensibleWorkflowContext(),isTriggeredByEvents:!1,status:et.Pending}])}},{key:"queueGenericWorkflow",value:function(t,o,a,s){if(t.registration.workflow.dynamicExecutionPreferences)o(t.scopePath),this.queueDynamicWorkflow(t.registration,t.scopePath,t.dynamicItemIds,void 0,t.isTriggeredByEvents,s);else try{var u=this.sessionCache.getItem(t.scopePath);o(t.scopePath),this.queueReduceWorkflow(t.registration,at(t.scopePath.slice(0,-1),u),t.triggerSignals,a,t.isTriggeredByEvents,s,z(t.scopePath))}catch(l){s(t.scopePath),v.debug(537678301,y.CoreDefault,"Subtree no longer exists, skipping queue workflow execution")}}},{key:"onExecutionJoinTaskCompleted",value:function(t,o){this.workflowItemStorage.onWorkflowExecuted(o,t),this.workflowDefinitionManager.deleteWorkflowDefinition(t,o.contextId),this.onExecutionTaskCompleted(t.id,o)}},{key:"onExecutionHybridSingleItemTaskCompleted",value:function(t,o){this.workflowItemStorage.onWorkflowExecuted(o,t),this.onExecutionTaskCompleted(t.id,o)}},{key:"onExecutionTaskCompleted",value:function(t,o){var a=this.workflowExecutionTrackersByName.get(t);o.contextId&&a.afterWorkflowExecution(o.contextId);var s=[].concat((0,se.default)(o.parentPath),[o.id]),u=s;try{var l=this.itemScopeMovedTracker.getUpdatedScopePathIfExists(s,t);s=l!=null?l:s,a.onExecutionTaskCompleted(s,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache))}catch(c){v.error(537678302,y.CoreDefault,`Failed to process workflow task completion ${t}: ${c.message}`)}finally{this.itemScopeMovedTracker.afterWorkflowExecution(u,t)}}},{key:"onContextIdWorkflowExecutionComplete",value:function(t,o){var a=this;if(this.executionCompleteCallback&&this.executionCompleteCallback(t,o),bw.getValue()){var s=function(){for(var l of a.workflowExecutionTrackersByName.values())if(l.workflow.kind===V.Join){for(var c of l.getExecutionState().keys())if(Ft.isParentContextId(c,o))return!0}return!1};s()&&(this.cancelSweepTimer(),this.requestSweep(),this.sweepScopeExecutionNotifications())}}},{key:"updateExecutionTrackersOnPurge",value:function(t){for(var o of t){var a=this.workflowExecutionTrackersByName.get(o.workflowId);a?(a.onExecutionTaskCompleted(o.itemPath,this.sessionCache.getFirstAncestorOfType.bind(this.sessionCache)),v.info(507856773,y.CoreDefault,`WorkflowExecutionManager.updateExecutionTrackersOnPurge: completed execution for workflow ${o.workflowId}, selfPendingExecCount: ${a.selfPendingExecCount}`)):v.info(507847636,y.CoreDefault,`WorkflowExecutionManager.updateExecutionTrackersOnPurge: skip for workflow ${o.workflowId}: no executionTracker found`)}}},{key:"onPurgeModel",value:function(t,o,a){Er.getValue()&&v.info(507856770,y.CoreDefault,`WorkflowExecutionManager.onPurgeModel ${t.length} item paths to purge`);var s=function(c,f){var d;if(!o||!a)return!1;var p=f.length!=a.length&&Wn(a,f);return p?(d=c.outputTypes)===null||d===void 0?void 0:d.some(function(g){return o.includes(g)}):!1};if(this.cancelQueuedWorkflows(t,s),this.pendingNotifications){var u=this.notificationManager.cancelPendingNotifications(t,s,this.sessionCache,this);u.length>0&&(this.emit("pendingNotificationsChange",!0),this.updateExecutionTrackersOnPurge(u))}}},{key:"cancelQueuedWorkflows",value:function(t,o){var a=this,s=new E({operationName:"CancelQueuedWorkflowsOnPurge",success:!0}).start(),u=H("NotifySynchronizationManagerOnPurge"),l=[],c=function(S){return(t==null?void 0:t.find(function(C){return Wn(C,S)}))!==void 0},f=function(S){return(S==null?void 0:S.filter(function(C){return!m.matchesTypesFor(C,[bn.getTypeName()])}).length)||0},d=function(S,C,x){var T,I=[].concat((0,se.default)(S.scopeItem.parentPath),[S.scopeItem.id]),_=c(I),M=o(C,I),b=((T=S.inputItems)===null||T===void 0?void 0:T.find(function(q){return c([].concat((0,se.default)(q==null?void 0:q.parentPath),[q==null?void 0:q.id]))}))!==void 0;if(!_&&!b&&!M)return v.info(507834947,y.CoreDefault,`WorkflowExecutionManager.cancelQueuedWorkflows: not cancelling ${x} workflow ${C.id}: not affected by purge`),!0;var A=S.opType===it.getTypeName(),N=f(S.triggerSignals),F=H("PreventCancellationBasedOnSignals")?N>0:A||N>0;return F?(v.info(507856768,y.CoreDefault,`WorkflowExecutionManager.cancelQueuedWorkflows: not cancelling ${x} workflow ${C.id} triggered by ${S.opType} with ${N} signals`),!0):(v.info(507856739,y.CoreDefault,`WorkflowExecutionManager.cancelQueuedWorkflows: cancelling ${x} workflow ${C.id}: scopeIsPurged=${_}, hasPurgedInput=${b}, opTypeIsSignal=${A}, signalCount=${N}, hasPurgedOutputType=${M}`),!1)};for(var p of this.workflowQueue.workersList())if(!dr(p.data.registration.workflow))for(var g of p.data.tasks)d(g,p.data.registration.workflow,"running")||(g.status=et.ResultsCancelled,u&&this.workflowSynchronizationManager.notifyOnCancelled(g,p.data.registration.workflow.id),l.push({resourceId:p.data.registration.workflow.resourceId,contextId:g.scopeItem.contextId}));this.workflowQueue.remove(function(k){if(dr(k.data.registration.workflow))return!1;var S=!0;for(var C of k.data.tasks){if(d(C,k.data.registration.workflow,"queued")){S=!1;continue}C.status=et.ResultsCancelled,u&&a.workflowSynchronizationManager.notifyOnCancelled(C,k.data.registration.workflow.id),l.push({resourceId:k.data.registration.workflow.resourceId,contextId:C.scopeItem.contextId})}return S}),s.count=l.length,s.resultJSON=JSON.stringify(l),v.info(512338136,y.CoreDefault,s.stop())}},{key:"getWorkflowBatchSizeMax",value:function(t){var o,a=this.workflowBatchSizeMax(),s=(o=t.workflow.maxBatchSize)!==null&&o!==void 0?o:0;return s>0?Math.min(a,s):a}}],[{key:"fetchExistingAnnotations",value:function(t,o,a){var s;if(!(!t.fetchExistingAnnotations&&!(!((s=t.modelOptions)===null||s===void 0)&&s.includeExistingAnnotations))){var u;try{u=a.getItemChildren(o,t.outputTypes)}catch(g){v.info(537678239,y.CoreDefault,function(){return`Fetching existing annotations failed on parent item: ${z(o)}. Error: ${g}`});return}var l=new Array(u.length),c=0;for(var f of u)f.body&&f.source===t.id&&(l[c++]=Object.assign(Object.assign({},f),{parentPath:o}));if(l.length=c,yo(t)&&l.length>0)for(var d of[].concat(l)){var p=r.fetchExistingAnnotations(t,[].concat((0,se.default)(d.parentPath),[d.id]),a);p&&l.push.apply(l,(0,se.default)(p))}return l}}},{key:"getDirtyAreaSingleSignalTrigger",value:function(t){return t&&t.length==1&&m.matchesTypesFor(t[0],[bn.getTypeName()])?t[0]:void 0}}])}(Dw.EventEmitter),Bb=function(){function n(r,e,t){(0,eu.default)(this,n),this.selfPendingExecCount=0,this.upstreamPendingExecCountByScope=new Map,this.upstreamToDownstreamExecCountByScope=new Map,this.contextProducerPendingExecCountByScope=new Map,this.selfPendingExecCountByScope=new Map,this.itemsContextId=new Set,this.executionState=new Map,this.workflow=r.workflow,this.registration=r,this.executionStateChangedCallback=e,this.onContextIdWorkflowExecutionComplete=t}return(0,tu.default)(n,[{key:"invalidateWorkflow",value:function(e,t){var o=Q().startSync(te.ExecutionTrackerInvalidate),a=this.getWorkflowExecutionState();this.incrementSelfPendingExecutions(e,1),this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),a),this.updateAllDownstreamWorkflowExecutionTrackers(e,t,!1),Q().stop(o)}},{key:"increasePendingUpstreamWorkflowsCount",value:function(e,t,o){var a=this.getWorkflowExecutionState();this.incrementSelfPendingExecutions(e,o),this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),a),this.updateAllDownstreamWorkflowExecutionTrackers(e,t,!1,o)}},{key:"onExecutionTaskCompleted",value:function(e,t){var o=this.getWorkflowExecutionState();this.decrementSelfPendingExecutions(e,1),this.executionStateChangedCallback(this.workflow.id,this.getWorkflowExecutionState(),o),this.updateAllDownstreamWorkflowExecutionTrackers(e,t,!0,1)}},{key:"getWorkflowExecutionState",value:function(){return this.selfPendingExecCount>0?xe.Running:this.upstreamPendingExecCountByScope.size>0?xe.Pending:xe.Idle}},{key:"areUpstreamWorkflowsReadyByScope",value:function(e){return this.upstreamPendingExecCountByScope.get(z(e))===void 0}},{key:"getPendingExecutionsCount",value:function(e){var t;return e?(t=this.selfPendingExecCountByScope.get(e))!==null&&t!==void 0?t:0:this.selfPendingExecCount}},{key:"moveScope",value:function(e,t,o){this.updatePendingExecutionsScopePaths(e,t),this.updateDownstreamWorkflowExecutionsScopePaths(e,t,o)}},{key:"updatePendingExecutionsScopePaths",value:function(e,t){var o,a=(o=this.selfPendingExecCountByScope.get(e))!==null&&o!==void 0?o:0;a&&(this.selfPendingExecCountByScope.delete(e),this.selfPendingExecCountByScope.set(t,a));var s=this.contextProducerPendingExecCountByScope.get(e);s&&(this.contextProducerPendingExecCountByScope.delete(e),this.contextProducerPendingExecCountByScope.set(t,s))}},{key:"updateDownstreamWorkflowExecutionsScopePaths",value:function(e,t,o){var a,s,u,l=(a=this.selfPendingExecCountByScope.get(e))!==null&&a!==void 0?a:0;for(var c of this.allDownstreamWorkflowExecutionTrackers){var f=c.workflowExecutionTracker.upstreamToDownstreamExecCountByScope,d=f.get(e);if(d){d.pendingCount-l<=0?f.delete(e):d.pendingCount-=l;var p=Bn(t),g=z(d.downstreamScopePath),k=(s=c.workflowExecutionTracker.upstreamPendingExecCountByScope.get(g))!==null&&s!==void 0?s:0;k-l<=0?c.workflowExecutionTracker.upstreamPendingExecCountByScope.delete(g):c.workflowExecutionTracker.upstreamPendingExecCountByScope.set(g,k-l);var S=o(p,[c.workflowExecutionTracker.workflow.collectionScopeType]);if(S){f.set(t,{pendingCount:d.pendingCount,downstreamScopePath:p});var C=z(p),x=((u=c.workflowExecutionTracker.upstreamPendingExecCountByScope.get(C))!==null&&u!==void 0?u:0)+k;c.workflowExecutionTracker.upstreamPendingExecCountByScope.set(C,x)}}}}},{key:"moveAwareGetScopeItem",value:function(e,t,o,a,s,u){if(!xa.getValue())return o(e,t);var l=z(e),c=a.upstreamToDownstreamExecCountByScope,f=c.get(l),d=s?-u:u;if(!f){var p=o(e,t);return d>0?p&&c.set(l,{pendingCount:d,downstreamScopePath:[].concat((0,se.default)(p.parentPath),[p.id])}):p&&v.info(507605015,y.CoreDefault,`upstreamToDownstreamExecCountByScope an attempt to decrement non-existent upstream to downstream counter. Upstream: ${this.workflow.id}, downstream: ${a.workflow.id}`),p}var g=f.downstreamScopePath;return f.pendingCount+=d,f.pendingCount<=0&&(c.delete(l),f.pendingCount<0&&v.warn(507605014,y.CoreDefault,`downstreamExecCount.pendingCount went below zero. Upstream: ${this.workflow.id}, downstream: ${a.workflow.id}`)),o(g,t)}},{key:"incrementSelfPendingExecutions",value:function(e,t){var o;this.selfPendingExecCount+=t;var a=z(e);this.selfPendingExecCountByScope.set(a,((o=this.selfPendingExecCountByScope.get(a))!==null&&o!==void 0?o:0)+t)}},{key:"decrementSelfPendingExecutions",value:function(e,t){this.selfPendingExecCount-=t;var o=z(e),a=this.selfPendingExecCountByScope.get(o);if(a===void 0){v.error(507605013,y.CoreDefault,`No element in selfPendingExecCountByScope for the scope on attempt to decrement. WorkflowId: ${this.workflow.id}`);return}var s=a-t;s>0?this.selfPendingExecCountByScope.set(o,s):(this.selfPendingExecCountByScope.delete(o),s<0&&v.error(507605012,y.CoreDefault,`Decremented executions count in selfPendingExecCountByScope went below zero. WorkflowId: ${this.workflow.id}`))}},{key:"updateAllDownstreamWorkflowExecutionTrackers",value:function(e,t,o){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1,u=t,l=function(p){if(p.workflowResultType===Fn.Input&&p.workflowExecutionTracker.workflow.kind!==V.SingleItem){t=function(C,x){return a.moveAwareGetScopeItem(C,x,u,p.workflowExecutionTracker,o,s)};var g=void 0;try{g=t(e,[p.workflowExecutionTracker.workflow.collectionScopeType])}catch(S){return n.shouldLogAncestorNotFoundError(p.workflowExecutionTracker.workflow.id)&&v.info(537678303,y.CoreDefault,`Failed to retrieve root item for updating workflow ${p.workflowExecutionTracker.workflow.id} execution tracker: ${S.message}`),{v:void 0}}if(g!==void 0){var k=z([].concat((0,se.default)(g.parentPath),[g.id]));o?p.workflowExecutionTracker.decreasePendingExecutionCount(k,!1,s):p.workflowExecutionTracker.increasePendingExecutionCount(k,!1,s)}}else p.workflowResultType===Fn.Context&&H("WaitContextProducerToComplete")&&(o?p.workflowExecutionTracker.decreasePendingExecutionCount(z(e),!0,s):p.workflowExecutionTracker.increasePendingExecutionCount(z(e),!0,s))},c;for(var f of this.allDownstreamWorkflowExecutionTrackers)if(c=l(f),c)return c.v}},{key:"increasePendingExecutionCount",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=t?this.contextProducerPendingExecCountByScope:this.upstreamPendingExecCountByScope,s=a.get(e);a.set(e,(s!=null?s:0)+o)}},{key:"decreasePendingExecutionCount",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,a=t?this.contextProducerPendingExecCountByScope:this.upstreamPendingExecCountByScope,s=a.get(e);bb.getValue()&&(!s||s<o)&&v.info(524153237,y.CoreDefault,`Irregular number of upstream pending executions: current ${s}, decrease value: ${o}`),a.set(e,(s!=null?s:0)-o),a.get(e)<=0&&a.delete(e)}},{key:"addInputItemToProcess",value:function(e){this.registration.suspendExecution||this.itemsContextId.add(e)}},{key:"removeProcessedInputItem",value:function(e){this.itemsContextId.delete(e)}},{key:"countItemsToProcess",value:function(e){var t=0;for(var o of this.itemsContextId)o.indexOf(e)===0&&(t+=1);return t}},{key:"getExecutionState",value:function(){return this.executionState}},{key:"setExecutionState",value:function(e,t){return e?n.isWorkflowReadyToExecute(this.registration)?(this.executionState.set(e,t),!0):(v.info(508883414,y.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.registration.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for not active workflow`})),!1):(v.info(520217549,y.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.registration.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a undefined contextId (setExecutionState)`})),!1)}},{key:"beforeWorkflowExecution",value:function(e){this.setExecutionState(e,xe.Idle)}},{key:"afterWorkflowExecution",value:function(e){this.setExecutionState(e,xe.Executed)&&this.tryToCompleteWorkflowExecution(e)}},{key:"tryToCompleteWorkflowExecution",value:function(e){var t=this.executionState.get(e);if(t===xe.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.workflow.id,e);for(var o of this.allDownstreamWorkflowExecutionTrackers)for(var a of o.workflowExecutionTracker.getExecutionState()){var s=(0,jt.default)(a,2),u=s[0],l=s[1];l===xe.Executed&&Ft.isParentContextId(e,u)&&o.workflowExecutionTracker.tryToCompleteWorkflowExecution(u)}}}},{key:"canCompleteExecution",value:function(e){for(var t of this.allUpstreamWorkflowExecutionTrackers)for(var o of t.workflowExecutionTracker.getExecutionState().keys())if(Ft.isParentContextId(o,e))return!1;return!0}}],[{key:"isWorkflowReadyToExecute",value:function(e){return e.isActivated&&!e.suspendExecution}},{key:"shouldLogAncestorNotFoundError",value:function(e){return!Eb.getValue().includes(e)}}])}();h();var Wb=new G("wordFilteredOutSubDocs",["comments","endnotes","footnotes","headerfooters","shapes","textboxes"]),Ob=new G("wordAllSubDocWorkflows",["AutoSecurityClassificationTextTileV2"]),Rw=function(r,e){if((r==null?void 0:r.appName)==="Word"){var t=Wb.getValue(),o=Ob.getValue();return function(a){if(a.parentPath.length>=2&&a.parentPath[1]==="doc"){if(a.parentPath.length>=3&&a.parentPath[2]==="main")return!0;var s=a.parentPath.length===2&&t.includes(a.id)||a.parentPath.length>=3&&t.includes(a.parentPath[2]);if(s)return o.includes(e)}return!0}}};h();var Bw=w(P()),Ww=w(R());var Lb=new G("queueSaturationHandlingStrategyEnabled",!1),Fb=new Gl("overrideWorkflowDefinition_"),qb=new G("overridableWorkflowDefinitionProperties",["activationConfigs","isStateful","stateExpiryMs","bypassModel","requiredTokenTypes","optionalTokenTypes","requestedContextTypesRules","activationFlightsConfigs","maxExecutionTimeInS","billingDomain","minDelayMs","maxDelayMs","isAppOnlyTokenAllowed","triggerConditions","triggerSignals","maxBatchSize","inputStage"]),Ow=function(){function n(r,e){(0,Bw.default)(this,n),this.totalExecutionCount=0,this.suspendExecution=!1,this.isActivated=!1,this.pendingTokenExchangesCount=0,this.eventCountSinceLastTrigger=0,this.tasksInProgress=new Set,this.debounceQueue=new Map,this.appliedWorkflowOverrides=this.overrideWorkflowDefinition(r),this.workflow=r,this.workflowQueue=e,this.lastTriggerByEventsTime=Date.now()}return(0,Ww.default)(n,[{key:"queueTask",value:function(e){var t=this,o=Q(),a=o.currentScope;o.startBranch(te.WorkflowExecution,e.cc),dr(this.workflow)||Lb.getValue()?this.queueWorkflow(e):setTimeout(function(){return t.queueWorkflow(e)},0),o.switchToScope(a)}},{key:"onTaskCompleted",value:function(e){var t=this,o,a;if((o=e.onComplete)===null||o===void 0||o.call(e,!1),e.executionScopeId){var s=this.debounceQueue.get(e.executionScopeId);s?ze(function(){var u,l=Q();l.stop(s.childPerformanceEvent),t.debounceQueue.delete(e.executionScopeId),v.info(537781724,y.CoreDefault,s.debounceOp.stop()),t.tasksInProgress.delete(e.executionScopeId);for(var c of s.taskCollection.tasks)(u=c.onComplete)===null||u===void 0||u.call(c,!0);l.startSync(te.InvalidateWorkflow),t.invalidate(s.taskCollection.tasks.map(function(f){return{item:f.scopeItem,triggerSignals:f.triggerSignals,reInvalidateAfterDebounce:!0}}))},(a=s.taskCollection)===null||a===void 0?void 0:a.cc):this.tasksInProgress.delete(e.executionScopeId)}}},{key:"setExecutionManager",value:function(e){this.executionManager=e}},{key:"invalidate",value:function(e){this.executionManager.invalidateWorkflow(this,e)}},{key:"queueWorkflow",value:function(e){var t=Q(e.cc),o=t.startSync(te.QueueWorkflow);this.workflowQueue.push(e,this.workflow.priority),t.stop(o),t.startAsync(te.WaitingInWorkflowQueue)}},{key:"overrideWorkflowDefinition",value:function(e){var t=new E({operationName:"OverrideWorkflowDefinition",resourceId:e.id,success:!0}).start(),o=this.applyWorkflowDefinitionOverrides(e);if(o)return t.resultJSON=JSON.stringify(o),v.info(507544067,y.CoreDefault,t.stop()),o}},{key:"applyWorkflowDefinitionOverrides",value:function(e){var t,o;for(var a of(t=qb.getValue())!==null&&t!==void 0?t:[]){var s=Fb.getSettingInstance(`${e.id}_${a}`).getValue();s!==void 0&&(s=s!=null?s:void 0,e[a]=s,o=o!=null?o:{},o[a]=s)}return o}}])}();h();var Lw=w(P()),Fw=w(R());var qw=function(){function n(r,e,t){(0,Lw.default)(this,n),this.upstreamMessageEndpoint=r,this.sessionKey=e,this.userId=t}return(0,Fw.default)(n,[{key:"setClientMetadata",value:function(e){this.clientMetadata=e}},{key:"executeWorkflow",value:function(e,t,o){var a=new ir({workflowId:e.id,batchExecutionInputs:t,clientMetadata:this.clientMetadata,executionContext:{sessionEndpoint:"",origin:"",sessionKey:this.sessionKey,userId:this.userId}});this.upstreamMessageEndpoint.sendMessage(a,function(s,u){if(s){o(new Error(s.error));return}var l=u;o(void 0,l.batchExecutionResults)})}}])}();h();var $w=w(dt()),Id=w(Se()),Gw=w(P()),Uw=w(R());var nu=function(){function n(r){(0,Gw.default)(this,n),this.scopeItemsByContextId=new Map,this.itemsByWorkflowAndContextId=new Map,this.workflowDefinitionManager=r}return(0,Uw.default)(n,[{key:"setScopeItem",value:function(e,t){var o,a=e.contextId;if(a){if(this.itemsByWorkflowAndContextId.has(t.id)||this.itemsByWorkflowAndContextId.set(t.id,new Map),this.itemsByWorkflowAndContextId.get(t.id).set(a,[]),!this.scopeItemsByContextId.has(a))this.scopeItemsByContextId.set(a,e);else if(!((o=this.itemsByWorkflowAndContextId.get(t.id))===null||o===void 0)&&o.has(a)){var s=new E({resultDescription:`Trying to set new scope item: ${e.id} with already existing contextId ${a} for workflow ${t.id}`,operationName:"WIS.setScopeItem",resourceId:t.id,success:!0}).start();v.verbose(527291288,y.CoreDefault,s.stop())}}}},{key:"updateScopeItemPath",value:function(e,t,o){var a,s;if(e){var u=this.scopeItemsByContextId.get(e);if(u){var l=u.parentPath;this.scopeItemsByContextId.set(e,at(t,u));for(var c=(s=(a=this.itemsByWorkflowAndContextId.get(o.id))===null||a===void 0?void 0:a.get(e))!==null&&s!==void 0?s:[],f=0;f<c.length;f++)c[f]=at([].concat((0,Id.default)(t),(0,Id.default)(c[f].parentPath.slice(0,l.length))),c[f])}}}},{key:"getScopeItem",value:function(e,t){var o;for(var a of((o=this.itemsByWorkflowAndContextId.get(t.id))===null||o===void 0?void 0:o.keys())||[])if(Ea(a,e))return this.scopeItemsByContextId.get(a)}},{key:"addItemToWorkflowList",value:function(e,t){var o=e.contextId;if(o){var a=this.itemsByWorkflowAndContextId.get(t.id);if(a)for(var s of a){var u=(0,$w.default)(s,2),l=u[0],c=u[1];if(Ea(l,o)){c.push(e);var f=new E({resultDescription:`Items for contextId ${l}: [${c.map(function(d){return d.id}).join(",")}]`,operationName:"WIS.addItemOnContextIdList",resourceId:t.id,success:!0}).start();v.info(526403808,y.CoreDefault,f.stop())}}}}},{key:"isWorkflowReady",value:function(e,t){var o=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.getGeneratedItems(e,t).length>=o}},{key:"getItemsToExecute",value:function(e,t){var o=this.getGeneratedItems(e,t);return this.itemsByWorkflowAndContextId.get(t.id).delete(e),o}},{key:"onWorkflowExecuted",value:function(e,t){var o=e.contextId,a=this.itemsByWorkflowAndContextId.get(t.id);a&&(a.delete(o),a.size===0&&this.itemsByWorkflowAndContextId.delete(t.id)),this.hasWorkflowsAwaitingExecution(o)||this.scopeItemsByContextId.delete(o)}},{key:"getGeneratedItems",value:function(e,t){var o;if(!(!((o=this.itemsByWorkflowAndContextId.get(t.id))===null||o===void 0)&&o.get(e)))return[];var a=this.workflowDefinitionManager.getWorkflowDefinition(t,e).maxAnnotations;return this.itemsByWorkflowAndContextId.get(t.id).get(e).slice(0,a)}},{key:"hasWorkflowsAwaitingExecution",value:function(e){for(var t of this.itemsByWorkflowAndContextId.values())for(var o of t.keys())if(o===e)return!0;return!1}}])}();h();var Hw=w(Se()),_d=w(P()),Ad=w(R());var pr;(function(n){n[n.Local=0]="Local",n[n.External=1]="External"})(pr||(pr={}));var ru=function(){function n(){(0,_d.default)(this,n),this.graphNodeByLocationAndWorkflowId=new Map}return(0,Ad.default)(n,[{key:"getWorkflow",value:function(e,t){var o,a=this.getLocation(t);return(o=this.graphNodeByLocationAndWorkflowId.get(a))===null||o===void 0?void 0:o.get(e)}},{key:"addWorkflow",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.getWorkflow(e.id,t)){var o=new E({operationName:"AddWorkflowToGraphFailure",success:!1,resourceId:e.id,resultDescription:`Adding a new with workflow with a duplicated workflowId: ${t}`}).start();v.error(524300630,y.CoreDefault,o.stop());return}var a=this.getLocation(t),s=new $b(e,a);this.addWorkflowAsDependency(s);var u=this.graphNodeByLocationAndWorkflowId.get(a);u||(u=new Map,this.graphNodeByLocationAndWorkflowId.set(a,u)),u.set(e.id,s)}},{key:"getUpstreamRuntimeVisibleWorkflows",value:function(){var e=[];for(var t of this.graphNodeByLocationAndWorkflowId.values()||[])for(var o of t.values()||[]){var a=this.createWorkflowDefinition(o.workflow);if(o.workflow.visibility===Gr.LocalOnly)this.compressDownstreamWorkflows(a,o);else{var s;(s=a.outputTypes).push.apply(s,(0,Hw.default)(o.workflow.outputTypes))}a.inputTypes.length!==0&&e.push(a)}return e}},{key:"removeWorkflows",value:function(e){var t=this.getLocation(e),o=this.graphNodeByLocationAndWorkflowId.get(t),a=Array.from((o==null?void 0:o.values())||[]);for(var s of a){for(var u of s.upstreamWorkflows.values())u.downstreamWorkflows.delete(s);for(var l of s.downstreamWorkflows.values())l.upstreamWorkflows.delete(s);o.delete(s.workflow.id)}}},{key:"getWorkflowsDefinitions",value:function(){var e=[];for(var t of this.graphNodeByLocationAndWorkflowId.values()||[])for(var o of t.values()||[])e.push(o.workflow);return e}},{key:"getWorkflowNodes",value:function(e){var t=[];for(var o of this.graphNodeByLocationAndWorkflowId.values())for(var a of o.values())t.push(a);return t}},{key:"getLocation",value:function(e){return e?pr.External:pr.Local}},{key:"createWorkflowDefinition",value:function(e){return Object.assign(Object.assign({},e),{outputTypes:[]})}},{key:"compressDownstreamWorkflows",value:function(e,t){for(var o of t.downstreamWorkflows){if(o.workflow.visibility===Gr.LocalOnly){this.compressDownstreamWorkflows(e,o);continue}if(!(o.workflow.kind===V.Join&&e.inputTypes.indexOf(o.workflow.collectionScopeType)===-1))for(var a of o.workflow.outputTypes)e.outputTypes.indexOf(a)===-1&&e.outputTypes.push(a)}}},{key:"addWorkflowAsDependency",value:function(e){for(var t of this.graphNodeByLocationAndWorkflowId.values())for(var o of t.values()){for(var a of o.workflow.inputTypes)e.workflow.outputTypes.indexOf(a)!==-1&&this.addWorkflowChain(e,o);for(var s of o.workflow.outputTypes)e.workflow.inputTypes.indexOf(s)!==-1&&this.addWorkflowChain(o,e)}}},{key:"addWorkflowChain",value:function(e,t){e.downstreamWorkflows.add(t),t.upstreamWorkflows.add(e)}}])}(),$b=(0,Ad.default)(function n(r,e){(0,_d.default)(this,n),this.isActivated=!0,this.upstreamWorkflows=new Set,this.downstreamWorkflows=new Set,this.location=e,this.workflow=Object.assign(Object.assign({},r),{inputTypes:Array.isArray(r.inputTypes)?r.inputTypes:[],outputTypes:Array.isArray(r.outputTypes)?r.outputTypes:[]})});h();var aS=w(P()),sS=w(R());h();h();h();h();function zw(n){return function(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];var o=e.pop();return n.call(this,e,o)}}h();var Gb=typeof queueMicrotask=="function"&&queueMicrotask,Ub=typeof setImmediate=="function"&&setImmediate,Hb=typeof process=="object"&&typeof process.nextTick=="function";function zb(n){setTimeout(n,0)}function Vb(n){return function(r){for(var e=arguments.length,t=new Array(e>1?e-1:0),o=1;o<e;o++)t[o-1]=arguments[o];return n(function(){return r.apply(void 0,t)})}}var Wa;Gb?Wa=queueMicrotask:Ub?Wa=setImmediate:Hb?Wa=process.nextTick:Wa=zb;var Yo=Vb(Wa);function bd(n){return Md(n)?function(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];var o=e.pop(),a=n.apply(this,e);return Vw(a,o)}:zw(function(r,e){var t;try{t=n.apply(this,r)}catch(o){return e(o)}if(t&&typeof t.then=="function")return Vw(t,e);e(null,t)})}function Vw(n,r){return n.then(function(e){Qw(r,null,e)},function(e){Qw(r,e&&(e instanceof Error||e.message)?e:new Error(e))})}function Qw(n,r,e){try{n(r,e)}catch(t){Yo(function(o){throw o},t)}}function Md(n){return n[Symbol.toStringTag]==="AsyncFunction"}function Qb(n){if(typeof n!="function")throw new Error("expected a function");return Md(n)?bd(n):n}var ou=Qb;h();function Ed(n){return function(){if(n===null)throw new Error("Callback was already called.");var r=n;n=null;for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];r.apply(this,t)}}h();var ct=w(Ui());h();var Jw=w(Se()),Kw=w(P()),Yw=w(R()),Xw=function(){function n(){(0,Kw.default)(this,n),this.head=this.tail=null,this.length=0}return(0,Yw.default)(n,[{key:"removeLink",value:function(e){return e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,e.prev=e.next=null,this.length-=1,e}},{key:"empty",value:function(){for(;this.head;)this.shift();return this}},{key:"insertAfter",value:function(e,t){t.prev=e,t.next=e.next,e.next?e.next.prev=t:this.tail=t,e.next=t,this.length+=1}},{key:"insertBefore",value:function(e,t){t.prev=e.prev,t.next=e,e.prev?e.prev.next=t:this.head=t,e.prev=t,this.length+=1}},{key:"unshift",value:function(e){this.head?this.insertBefore(this.head,e):jw(this,e)}},{key:"push",value:function(e){this.tail?this.insertAfter(this.tail,e):jw(this,e)}},{key:"shift",value:function(){return this.head&&this.removeLink(this.head)}},{key:"pop",value:function(){return this.tail&&this.removeLink(this.tail)}},{key:"toArray",value:function(){return(0,Jw.default)(this)}},{key:Symbol.iterator,value:function*(){for(var e=this.head;e;)yield e.data,e=e.next}},{key:"remove",value:function(e){for(var t=this.head;t;){var o=t,a=o.next;e(t)&&this.removeLink(t),t=a}return this}}])}();function jw(n,r){n.length=1,n.head=n.tail=r}function Nd(n,r,e){var t;if(r==null)r=1;else if(r===0)throw new RangeError("Concurrency must not be zero");var o=ou(n),a=0,s=[],u={error:[],drain:[],saturated:[],unsaturated:[],empty:[]};function l(I,_){u[I].push(_)}function c(I,_){var M=function(){f(I,M),_.apply(void 0,arguments)};u[I].push(M)}function f(I,_){if(!I)return Object.keys(u).forEach(function(M){return u[M]=[]});if(!_)return u[I]=[];u[I]=u[I].filter(function(M){return M!==_})}function d(I){for(var _=arguments.length,M=new Array(_>1?_-1:0),b=1;b<_;b++)M[b-1]=arguments[b];u[I].forEach(function(A){return A.apply(void 0,M)})}var p=!1;function g(I,_,M,b){if(b!=null&&typeof b!="function")throw new Error("task callback must be a function");T.started=!0;var A,N;function F(J){if(J)return M?N(J):A();for(var Y=arguments.length,fe=new Array(Y>1?Y-1:0),W=1;W<Y;W++)fe[W-1]=arguments[W];if(fe.length<=1)return A(fe[0]);A(fe)}var q=T._createTaskItem(I,M?F:b||F);if(_?T._tasks.unshift(q):T._tasks.push(q),p||(p=!0,Yo(function(){p=!1,T.process()})),M||!b)return new Promise(function(J,Y){A=J,N=Y})}function k(I){return function(_){a-=1;for(var M=arguments.length,b=new Array(M>1?M-1:0),A=1;A<M;A++)b[A-1]=arguments[A];for(var N=0,F=I.length;N<F;N++){var q,J=I[N],Y=s.indexOf(J);Y===0?s.shift():Y>0&&s.splice(Y,1),(q=J).callback.apply(q,[_].concat(b)),_!=null&&d("error",_,J.data)}a<=T.concurrency-T.buffer&&d("unsaturated"),T.idle()&&d("drain"),T.process()}}function S(I){return I.length===0&&T.idle()?(Yo(function(){return d("drain")}),!0):!1}var C=function(_){return function(M){if(!M)return new Promise(function(b,A){c(_,function(N,F){if(N)return A(N);b(F)})});f(_),l(_,M)}},x=!1,T=(t={_tasks:new Xw,_createTaskItem:function(_,M){return{data:_,callback:M}}},(0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)(t,Symbol.iterator,function*(){yield*Co(T._tasks[Symbol.iterator]())}),"concurrency",r),"payload",e),"buffer",r/4),"started",!1),"paused",!1),"push",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(b){return g(b,!1,!1,M)}):g(_,!1,!1,M)}),"pushAsync",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(b){return g(b,!1,!0,M)}):g(_,!1,!0,M)}),"kill",function(){f(),T._tasks.empty()}),"unshift",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(b){return g(b,!0,!1,M)}):g(_,!0,!1,M)}),(0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)((0,ct.default)(t,"unshiftAsync",function(_,M){return Array.isArray(_)?S(_)?void 0:_.map(function(b){return g(b,!0,!0,M)}):g(_,!0,!0,M)}),"remove",function(_){T._tasks.remove(_)}),"process",function(){if(!x){for(x=!0;!T.paused&&a<T.concurrency&&T._tasks.length;){var _=[],M=[],b=T._tasks.length;T.payload&&(b=Math.min(b,T.payload));for(var A=0;A<b;A++){var N=T._tasks.shift();_.push(N),s.push(N),M.push(N.data)}a+=1,T._tasks.length===0&&d("empty"),a===T.concurrency&&d("saturated");var F=Ed(k(_));o(M,F)}x=!1}}),"length",function(){return T._tasks.length}),"running",function(){return a}),"workersList",function(){return s}),"idle",function(){return T._tasks.length+a===0}),"pause",function(){T.paused=!0}),"resume",function(){T.paused!==!1&&(T.paused=!1,Yo(T.process))}));return Object.defineProperties(T,{saturated:{writable:!1,value:C("saturated")},unsaturated:{writable:!1,value:C("unsaturated")},empty:{writable:!1,value:C("empty")},drain:{writable:!1,value:C("drain")},error:{writable:!1,value:C("error")}}),T}h();h();function Zw(n,r){var e=ou(n);return Nd(function(t,o){e(t[0],o)},r,1)}h();var tS=w(Se()),nS=w(dt()),rS=w(P()),oS=w(R()),iS=function(){function n(){(0,rS.default)(this,n),this.heap=[],this.pushCount=Number.MIN_SAFE_INTEGER}return(0,oS.default)(n,[{key:"length",get:function(){return this.heap.length}},{key:"empty",value:function(){return this.heap=[],this}},{key:"percUp",value:function(e){for(var t;e>0&&Dd(this.heap[e],this.heap[t=eS(e)]);){var o=this.heap[e];this.heap[e]=this.heap[t],this.heap[t]=o,e=t}}},{key:"percDown",value:function(e){for(var t;(t=jb(e))<this.heap.length&&(t+1<this.heap.length&&Dd(this.heap[t+1],this.heap[t])&&(t=t+1),!Dd(this.heap[e],this.heap[t]));){var o=this.heap[e];this.heap[e]=this.heap[t],this.heap[t]=o,e=t}}},{key:"push",value:function(e){e.pushCount=++this.pushCount,this.heap.push(e),this.percUp(this.heap.length-1)}},{key:"unshift",value:function(e){return this.heap.push(e)}},{key:"shift",value:function(){var e=(0,nS.default)(this.heap,1),t=e[0];return this.heap[0]=this.heap[this.heap.length-1],this.heap.pop(),this.percDown(0),t}},{key:"toArray",value:function(){return(0,tS.default)(this)}},{key:Symbol.iterator,value:function*(){for(var e=0;e<this.heap.length;e++)yield this.heap[e].data}},{key:"remove",value:function(e){for(var t=0,o=0;o<this.heap.length;o++)e(this.heap[o])||(this.heap[t]=this.heap[o],t++);this.heap.splice(t);for(var a=eS(this.heap.length-1);a>=0;a--)this.percDown(a);return this}}])}();function jb(n){return(n<<1)+1}function eS(n){return(n+1>>1)-1}function Dd(n,r){return n.priority!==r.priority?n.priority<r.priority:n.pushCount<r.pushCount}function iu(n,r){var e=Zw(n,r),t=e.push,o=e.pushAsync;e._tasks=new iS,e._createTaskItem=function(s,u){var l=s.data,c=s.priority;return{data:l,priority:c,callback:u}};function a(s,u){return Array.isArray(s)?s.map(function(l){return{data:l,priority:u}}):{data:s,priority:u}}return e.push=function(s){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2?arguments[2]:void 0;return t(a(s,u),l)},e.pushAsync=function(s){var u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=arguments.length>2?arguments[2]:void 0;return o(a(s,u),l)},delete e.unshift,delete e.unshiftAsync,e}var uS=function(){function n(r,e,t){(0,aS.default)(this,n),this.executeTask=r,this.concurrencyLimit=e,this.queue=iu(this.executeTask,this.concurrencyLimit),this.saturationHandlingStrategy=t,this.onItemAddedCallbacks=[],this.saturationHandlingStrategy&&(this.saturated(this.saturationHandlingStrategy.onSaturated.bind(this.saturationHandlingStrategy,this)),this.unsaturated(this.saturationHandlingStrategy.onUnsaturated.bind(this.saturationHandlingStrategy,this)),this.drained(this.saturationHandlingStrategy.onDrained.bind(this.saturationHandlingStrategy,this)),this.onItemAdded(this.saturationHandlingStrategy.onItemAdded.bind(this.saturationHandlingStrategy,this)))}return(0,sS.default)(n,[{key:"buffer",get:function(){return this.queue.buffer},set:function(e){this.queue.buffer=e}},{key:"concurrency",get:function(){return this.queue.concurrency},set:function(e){this.queue.concurrency=e}},{key:"onItemAdded",value:function(e){this.onItemAddedCallbacks.push(e)}},{key:"drained",value:function(e){this.queue.drain(e)}},{key:"unsaturated",value:function(e){this.queue.unsaturated(e)}},{key:"saturated",value:function(e){this.queue.saturated(e)}},{key:"idle",value:function(){return this.queue.idle()}},{key:"running",value:function(){return this.queue.running()}},{key:"length",value:function(){return this.queue.length()}},{key:"workersList",value:function(){return this.queue.workersList()}},{key:"push",value:function(e,t){this.queue.push(e,t);for(var o of this.onItemAddedCallbacks)o()}},{key:"kill",value:function(){this.queue.kill()}},{key:"clear",value:function(){this.queue.kill(),this.queue=iu(this.executeTask,this.concurrencyLimit)}},{key:Symbol.iterator,value:function*(){yield*Co(this.queue[Symbol.iterator]())}},{key:"remove",value:function(e){this.queue.remove(e)}}])}();h();var Xo=w(Se()),cS=w(P()),fS=w(R());var Jb=new G("workflowSynchronizationInterval",10),au=new G("skipDebounceDeltasEnabled",!0),Kb=new G("defaultMaxSynchronizationWaitTimeMsForNonDeltaTriggerdWorkflows",-1),Yb=new G("defaultMaxSynchronizationWaitTimeMsForDeltaTriggerdWorkflows",0),lS=Symbol("isDuplicate"),dS=function(){function n(){(0,cS.default)(this,n),this.tasksInProgress=new Map,this.synchronizationQueue=new Map,this.synchronizationIntervalMs=Jb.getValue()}return(0,fS.default)(n,[{key:"notifyBeforeBatchedQueuing",value:function(e,t){var o,a=e.some(function(f){return f.executionScopeId});if(!a)return e;var s=Q().startSync(te.SynchronizeWorkflowTasks);this.markDuplicateTasks(e);var u=[],l=0;for(var c of e){if(!c.executionScopeId){u.push(c);continue}if(c[lS]===!0){(o=c.onComplete)===null||o===void 0||o.call(c,!0),l++;continue}this.postponeTaskIfPreviousInProgress(c,t)||(this.getTasksInProgress(t.workflow.id).set(c.executionScopeId,c),u.push(c))}return l>0&&this.logDuplicateTasksRemoval(t,l),Q().stop(s),u}},{key:"notifyBeforeQueueing",value:function(e,t){if(!e.executionScopeId)return!0;Q().startSync(te.SynchronizeWorkflowTask);var o=this.postponeTaskIfPreviousInProgress(e,t);return o||this.getTasksInProgress(t.workflow.id).set(e.executionScopeId,e),Q().stop(te.SynchronizeWorkflowTask),!o}},{key:"notifyOnCancelled",value:function(e,t){this.removeTaskInProgress(e,t,!0)}},{key:"notifyOnCompleted",value:function(e,t){this.removeTaskInProgress(e,t,!1)}},{key:"onSessionClose",value:function(){this.cancelSynchronizationTimer()}},{key:"removeTaskInProgress",value:function(e,t,o){var a;if((a=e.onComplete)===null||a===void 0||a.call(e,!1),!!e.executionScopeId){var s=this.getTasksInProgress(t),u=s.get(e.executionScopeId);if(u===e){s.delete(e.executionScopeId);var l=this.getSynchronizationQueue(t),c=l.get(e.executionScopeId);s.size===0&&this.tasksInProgress.delete(t),c&&this.reInvalidatePostponedWorkflowTask(c,l,o)}else v.info(509137730,y.CoreDefault,"Task in progress do not match the task that completed execution.")}}},{key:"markDuplicateTasks",value:function(e){var t=this;e.reduce(function(o,a){if(a.executionScopeId){var s=o.get(a.executionScopeId);s&&(s[lS]=!0,t.accumulateDataFromPreviousTask(s,a)),o.set(a.executionScopeId,a)}return o},new Map)}},{key:"getTasksInProgress",value:function(e){return On(this.tasksInProgress,e,function(){return new Map})}},{key:"getSynchronizationQueue",value:function(e){return On(this.synchronizationQueue,e,function(){return new Map})}},{key:"getMaxSynchronizationWaitTimeMs",value:function(e){var t;return e.workflow.maxSynchronizationWaitTimeMs===void 0?!((t=e.workflow.triggerConditions)===null||t===void 0)&&t.includes(Vt.DeltaUpdate)?Yb.getValue():Kb.getValue():e.workflow.maxSynchronizationWaitTimeMs}},{key:"postponeTaskIfPreviousInProgress",value:function(e,t){var o;if(!au.getValue()){var a=this.getMaxSynchronizationWaitTimeMs(t);if(e.maxSynchronizationEndTimeMs!==void 0&&e.maxSynchronizationEndTimeMs<=Date.now()||a===0)return!1;e.maxSynchronizationEndTimeMs===void 0&&(e.maxSynchronizationEndTimeMs=a>0?Date.now()+a:void 0)}var s=this.getTasksInProgress(t.workflow.id).get(e.executionScopeId);if((s==null?void 0:s.status)===et.Pending)return s.status=et.ExecutionCancelled,this.accumulateDataFromPreviousTask(s,e),(o=s.onComplete)===null||o===void 0||o.call(s,!0),this.logTaskCancellation(t),!1;if(s){var u=this.getSynchronizationQueue(t.workflow.id).get(e.executionScopeId);return u&&(this.cancelPreviousPostponedTask(u),this.accumulateDataFromPreviousTask(u.task,e)),this.postponeTask(e,t),!0}return!1}},{key:"postponeTask",value:function(e,t){var o=this,a=Q();kn(function(s){var u=a.startBranch(te.PostponeWorkflowTask,ut()),l=u.performanceEvent.startAsync(te.WaitingInSynchronizationQueue);o.getSynchronizationQueue(t.workflow.id).set(e.executionScopeId,{waitingInSyncQueueOp:new E({operationName:"WaitingInSynchronizationQueue",resourceId:t.workflow.resourceId,success:!0,resultSignature:e.executionScopeId}).start(),waitingInSyncQueuePerfEvent:l,task:e,correlationContext:ut(),workflowRegistration:t}),!au.getValue()&&e.maxSynchronizationEndTimeMs!==void 0&&o.ensureSynchronizationTimer()})}},{key:"cancelPreviousPostponedTask",value:function(e){ze(function(){var t,o;e.waitingInSyncQueueOp.success=!1,v.info(509747279,y.CoreDefault,e.waitingInSyncQueueOp.stop()),(o=(t=e.task).onComplete)===null||o===void 0||o.call(t,!0)},e.correlationContext)}},{key:"accumulateTriggerSignals",value:function(e,t){e.triggerSignals&&(t.triggerSignals?t.triggerSignals=e.triggerSignals.concat(t.triggerSignals):t.triggerSignals=(0,Xo.default)(e.triggerSignals))}},{key:"accumulateDeltas",value:function(e,t){var o,a,s,u,l,c;au.getValue()||(!((a=(o=e.scopeItem)===null||o===void 0?void 0:o.deltas)===null||a===void 0)&&a.length&&(!((u=(s=t.scopeItem)===null||s===void 0?void 0:s.deltas)===null||u===void 0)&&u.length?t.scopeItem.deltas=e.scopeItem.deltas.concat(t.scopeItem.deltas):t.scopeItem&&(t.scopeItem.deltas=(0,Xo.default)((l=e.scopeItem)===null||l===void 0?void 0:l.deltas))),!((c=e.inputItems)===null||c===void 0)&&c.length&&e.inputItems.forEach(function(f){var d,p,g,k=z([].concat((0,Xo.default)(f.parentPath),[f.id])),S=(d=t.inputItems)===null||d===void 0?void 0:d.find(function(C){return z([].concat((0,Xo.default)(C.parentPath),[C.id]))===k});S!=t.scopeItem&&(!((p=f.deltas)===null||p===void 0)&&p.length)&&S&&(!((g=S==null?void 0:S.deltas)===null||g===void 0)&&g.length?S.deltas=f.deltas.concat(S.deltas):S.deltas=(0,Xo.default)(f.deltas))}))}},{key:"accumulateDataFromPreviousTask",value:function(e,t){this.accumulateTriggerSignals(e,t),this.accumulateDeltas(e,t)}},{key:"reInvalidateWorkflowTask",value:function(e,t){var o=Q();o.startSync(te.InvalidateWorkflow),t.invalidate([{item:e.scopeItem,triggerSignals:e.triggerSignals,reInvalidateAfterDebounce:!0,maxSynchronizationEndTimeMs:e.maxSynchronizationEndTimeMs}])}},{key:"logTaskCancellation",value:function(e){var t=new E({operationName:"CancelPendingWorkflowExecution",resourceId:e.workflow.resourceId,success:!0,resultDescription:"New execution for the same scope item arrived."}).start();v.info(509747278,y.CoreDefault,t.stop())}},{key:"logDuplicateTasksRemoval",value:function(e,t){var o=new E({operationName:"RemoveDuplicateTasksFromBatch",count:t,resourceId:e.workflow.resourceId,success:!0}).start();v.info(509747277,y.CoreDefault,o.stop())}},{key:"ensureSynchronizationTimer",value:function(){!au.getValue()&&!this.synchronizationTimer&&(this.synchronizationTimer=setInterval(this.onSynchronization.bind(this),this.synchronizationIntervalMs),this.synchronizationTimer.unref&&this.synchronizationTimer.unref())}},{key:"onSynchronization",value:function(){var e=0;if(!this.synchronizationQueue||this.synchronizationQueue.size===0){this.cancelSynchronizationTimer();return}var t=this.synchronizationQueue.keys();for(var o of t){var a=this.getSynchronizationQueue(o);if(!(!a||a.size===0)){var s=a.keys();for(var u of s){var l=a.get(u);!l||l.task.maxSynchronizationEndTimeMs===void 0||(e++,l.task.maxSynchronizationEndTimeMs<=Date.now()&&(this.reInvalidatePostponedWorkflowTask(l,a,!1),e--))}}}e<=0&&this.cancelSynchronizationTimer()}},{key:"cancelSynchronizationTimer",value:function(){this.synchronizationTimer&&(clearInterval(this.synchronizationTimer),this.synchronizationTimer=void 0)}},{key:"reInvalidatePostponedWorkflowTask",value:function(e,t,o){var a=this;ze(function(){var s,u,l=Q();l.stop(e.waitingInSyncQueuePerfEvent),t.delete(e.task.executionScopeId),e.waitingInSyncQueueOp.success=!o,v.info(509747283,y.CoreDefault,e.waitingInSyncQueueOp.stop()),(u=(s=e.task).onComplete)===null||u===void 0||u.call(s,!0),o||a.reInvalidateWorkflowTask(e.task,e.workflowRegistration)},e.correlationContext)}}])}();h();var Pd=w(dt()),Zo=w(Se()),pS=w(P()),gS=w(R());var su=new G("workflowExecutionManagerExtraLogging",!1),hS=function(){function n(r,e){(0,pS.default)(this,n),this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.workflowExecutionTrackersByName=r,this.areaIntersectionChecker=e}return(0,gS.default)(n,[{key:"pendingNotifications",get:function(){return this.pendingScopeExecutionNotificationsByWorkflow.size>0}},{key:"get",value:function(e,t){var o;return(o=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||o===void 0?void 0:o.get(t)}},{key:"set",value:function(e,t,o){var a=this.pendingScopeExecutionNotificationsByWorkflow.get(e);a||(a=new Map,this.pendingScopeExecutionNotificationsByWorkflow.set(e,a)),a.set(t,o);var s=this.workflowExecutionTrackersByName.get(e);for(var u of o.params||[]){var l=u.item;l.contextId&&s.setExecutionState(l.contextId,xe.Pending)}}},{key:"delete",value:function(e,t){var o,a,s=(o=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||o===void 0?void 0:o.get(t),u=this.workflowExecutionTrackersByName.get(e);if(s)for(var l of s.params||[]){var c=l.item;if(c.contextId){var f=u.getExecutionState().get(c.contextId);f===xe.Pending&&u.getExecutionState().delete(c.contextId)}}(a=this.pendingScopeExecutionNotificationsByWorkflow.get(e))===null||a===void 0||a.delete(t),this.pendingScopeExecutionNotificationsByWorkflow.get(e).size===0&&this.pendingScopeExecutionNotificationsByWorkflow.delete(e)}},{key:"entries",value:function(){return this.pendingScopeExecutionNotificationsByWorkflow.entries()}},{key:"pathIsPurged",value:function(e,t){return(t==null?void 0:t.find(function(o){return Wn(o,e)}))!==void 0}},{key:"hasPurgedParam",value:function(e,t){var o=this,a;return((a=e.params)===null||a===void 0?void 0:a.find(function(s){var u,l;return o.pathIsPurged([].concat((0,Zo.default)((u=s==null?void 0:s.item)===null||u===void 0?void 0:u.parentPath),[(l=s==null?void 0:s.item)===null||l===void 0?void 0:l.id]),t)}))!==void 0}},{key:"hasPurgedItem",value:function(e,t,o,a){var s=this,u,l,c=o.getItem(e.scopePath),f=at(e.scopePath.slice(0,-1),c),d=[].concat((0,Zo.default)(f.parentPath),[c.id]),p=e.registration.workflow;if(((u=p.inputTypes)===null||u===void 0?void 0:u.length)>0){var g=[];try{if(this.areaIntersectionChecker.supportsAreaIntersection(c.body)){var k=this.areaIntersectionChecker.getAreaIntersectionFilter(c.body),S=o.getSubtreeItems([],p.inputTypes,k),C=o.getSubtreeItems(d,p.inputTypes);g=(0,Zo.default)(new Set(S.concat(C)))}else g=o.getSubtreeItems(d,p.inputTypes)}catch(x){return v.info(507774938,y.CoreDefault,`NotificationManager.hasPurgedItem: failed to retrieve subtree items for workflow ${p.id}: ${x.message}`),this.hasPurgedParam(e,t)}return p.kind===V.Reduce||p.kind===V.Generic?g=(l=a.fetchInputChanges(p,g,f))!==null&&l!==void 0?l:g:g=g.filter(function(x){return m.matchesTypesFor(x.body,[Mn.getTypeName()])}),g.find(function(x){return s.pathIsPurged([].concat((0,Zo.default)(x.parentPath),[x.id]),t)})!==void 0}return this.hasPurgedParam(e,t)}},{key:"cancelPendingNotifications",value:function(e,t,o,a){var s,u,l,c=[],f=new E({operationName:"NotificationManager.cancelPendingNotifications",success:!0}).start(),d=function(D){return(D==null?void 0:D.filter(function($){return!m.matchesTypesFor($,[bn.getTypeName()])}).length)||0},p=[];for(var g of this.pendingScopeExecutionNotificationsByWorkflow.entries()){var k=(0,Pd.default)(g,2),S=k[0],C=k[1],x=[];for(var T of C.entries()){var I=(0,Pd.default)(T,2),_=I[0],M=I[1],b=M.registration.workflow,A=b.kind===V.Reduce||b.kind===V.Grid||b.kind===V.Generic,N=M.scopePath,F=this.pathIsPurged(N,e),q=!1;if(A&&!F){if(H("skipCancellationIfScopeWasDeleted")&&!o.hasItem(N)){su.getValue()&&v.info(506558597,y.CoreDefault,`NotificationManager.cancelPendingNotifications: not cancelling pending workflow=${b.id}, notificationKey=${_}: scope was not purged but is not in model`);continue}q=this.hasPurgedItem(M,e,o,a)}else(!A||!F)&&(q=this.hasPurgedParam(M,e));if(!F&&!q&&!t(b,N)){su.getValue()&&v.info(507856781,y.CoreDefault,`NotificationManager.cancelPendingNotifications: not cancelling pending workflow=${b.id}, notificationKey=${_}: not affected by purge`);continue}var J=d(M.triggerSignals),Y=(u=((s=M.params)===null||s===void 0?void 0:s.find(function(O){return d(O==null?void 0:O.triggerSignals)>0}))!==void 0)!==null&&u!==void 0?u:!1;if(J>0||Y){su.getValue()&&v.info(507856780,y.CoreDefault,`NotificationManager.cancelPendingNotifications: not cancelling pending workflow=${b.id}, notificationKey=${_}, signalCount=${J}, invalidated by signal=${Y}: triggered by signal`);continue}if(su.getValue()&&v.info(507856779,y.CoreDefault,`NotificationManager.cancelPendingNotifications: cancelling pending workflow=${b.id}, notificationKey=${_}`),x.push(_),b.kind===V.SingleItem){var fe=(l=M.params)!==null&&l!==void 0?l:[];for(var W of fe)c.push({workflowId:b.id,itemPath:[].concat((0,Zo.default)(W.item.parentPath),[W.item.id])})}else A?c.push({workflowId:b.id,itemPath:N}):v.error(507811590,y.CoreDefault,`NotificationManager.cancelPendingNotifications: Workflow of type ${b.kind} is not supported`)}for(var B of x)C.delete(B);C.size===0&&p.push(S)}for(var L of p)this.pendingScopeExecutionNotificationsByWorkflow.delete(L);return f.count=c.length,f.resultJSON=JSON.stringify(c),v.info(507856778,y.CoreDefault,f.stop()),c}}])}();function Xb(n,r,e){return r=(0,Bd.default)(r),(0,wS.default)(n,CS()?Reflect.construct(r,e||[],(0,Bd.default)(n).constructor):r.apply(n,e))}function CS(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(CS=function(){return!!n})()}var Oa;(function(n){n.SessionInitMessage="SessionInitMessage",n.AnnotationActivatedMessage="AnnotationActivatedMessage",n.SeedCompleted="SeedCompleted",n.TokenProvisionMessage="TokenProvisionMessage"})(Oa||(Oa={}));var ti;(function(n){n.AnnotationActivation="annotation activation",n.Auth="auth",n.Flight="flight",n.Seeding="seeding",n.WorkflowDisabled="disabled",n.UserType="user type",n.UserContext="user context"})(ti||(ti={}));var ko;(function(n){n[n.Workflow=0]="Workflow",n[n.ApologiesGenerator=1]="ApologiesGenerator",n[n.PrefilterManager=2]="PrefilterManager",n[n.WorkflowAsync=3]="WorkflowAsync"})(ko||(ko={}));var et;(function(n){n[n.Pending=0]="Pending",n[n.Running=1]="Running",n[n.ExecutionCancelled=2]="ExecutionCancelled",n[n.ResultsCancelled=3]="ResultsCancelled"})(et||(et={}));var Nr;(function(n){n[n.Unknown=0]="Unknown",n[n.ClientClose=1]="ClientClose",n[n.IdleTimeout=2]="IdleTimeout",n[n.ExpireTimeout=3]="ExpireTimeout",n[n.MastermindShutdown=4]="MastermindShutdown",n[n.SessionExtensionClose=5]="SessionExtensionClose",n[n.UserBlocked=6]="UserBlocked"})(Nr||(Nr={}));var mS;(function(n){n.Failure="Failure",n.Success="Success",n.Partial="Partial"})(mS||(mS={}));var Zb=new G("workflowConcurrencyLimit",100),hH=new G("workflowConcurrencyMin",5),mw=new G("setAnnotationStateToSent",!0),vS=new G("delayedWorkflowActivationTierThreshold",yn.DelayActivate),eM=new G("workflowMaxTriggerSignalOpsQueueLength",100),tM=new G("sessionLogMinDurationInMs",30),nM=new G("workflowsAllowedToPreactivate",[]),rM=new G("workflowBatchSizeMax",10),Rd="session-init-message",TS=function(n){function r(e,t,o){var a;(0,yS.default)(this,r),a=Xb(this,r),a.annotationActivationInfosByType=new Map,a.workflowRegistrationsByName=new Map,a.workflowsWaitingForActivation=new Set,a.workflowsByOutputAnnotation=new Map,a.workflowsByInputAnnotation=new Map,a.workflowsByRequestedContextType=new Map,a.workflowGraph=new ru,a.outputAnnotationsRequiredByDownstreamWorkflows=new Set,a.statelessItemListeners=new Rs,a.pendingExecutionStateUpdates=new Map,a.lastSeenAnnotationStateByAnnotation=new Map,a.workflowDefinitionManager=new Ks,a.nextAnnotationResultsSequenceId=1,a.nextWorkflowExecutionCompleteSequenceId=1,a.cvParent=new Je,a.isSeedingCompleted=!1,a.workflowInputTypes=new Set,a.clientMetadataFlightsSet=new Set,a.enableRemoteExecutionNotification=!1,a.isClosed=!1,a.sessionKey=e,a.stats=o,a.sessionObjectCreationTime=Date.now(),a.startTime=t.initialStartTime?t.initialStartTime:a.sessionObjectCreationTime,a.upstreamMessageEndpoint=t.upstreamMessageEndpoint,a.downstreamMessageEndpoint=t.downstreamMessageEndpoint,a.cache=t.cache,a.workflowClientCoordinator=new qw(a.upstreamMessageEndpoint,a.sessionKey,void 0),a.inputChangesManager=new tw(a.cache),a.annotationProcessor=new hw(a),a.statelessAnnotationProcessor=new Cw(a,a.statelessItemListeners),a.contextIdManager=new Ft(Qo.JsClient,a.workflowGraph),a.workflowItemStorage=new nu(a.workflowDefinitionManager),a.workflowQueue=new uS(a.executeWorkflow.bind(a),Zb.getValue()),a.upstreamMessageEndpoint.onMessage(pt.getTypeName(),a.onSessionInitMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(Ve.getTypeName(),a.onSessionCloseMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(Dn.getTypeName(),a.onTokenProvisionMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(Zr.getTypeName(),a.onWorkflowGraphInitMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(ln.getTypeName(),a.onAnnotationActivationMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(Xr.getTypeName(),a.onAnnotationConfigUpdateMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(Be.getTypeName(),a.onSyncMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(or.getTypeName(),a.onMicroSyncMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(no.getTypeName(),a.onWorkflowRegistrationMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(ar.getTypeName(),a.onWorkflowDefinitionOverrideMessage.bind(a)),a.upstreamMessageEndpoint.onMessage(Sn.getTypeName(),a.onGetAnnotationsRequestMessage.bind(a)),a.downstreamMessageEndpoint&&a.downstreamMessageEndpoint.onMessage(Ct.getTypeName(),a.onAnnotationResultsMessage.bind(a)),a.syncMessageSequencer=new uw(a.applySyncMessage.bind(a),t.isReconnect),a.syncMessageSequencer.on("seedCompleted",a.onSeedCompleted.bind(a));var s=new Map,u=new hS(s,void 0);return a.workflowSynchronizationManager=new dS,a.workflowExecutionManager=Pw({cache:a.cache,workflowRegistrationsByName:a.workflowRegistrationsByName,workflowsByInputAnnotation:a.workflowsByInputAnnotation,workflowsByOutputAnnotation:a.workflowsByOutputAnnotation,workflowsByRequestedContextType:a.workflowsByRequestedContextType,queueWorkflow:a.queueWorkflow.bind(a),queueGridNeighborhoodWorkflow:a.queueGridNeighborhoodWorkflow.bind(a),inputChangesManager:a.inputChangesManager,getUserNodePath:function(){return a.userNodePath},getTenantNodePath:function(){return a.tenantNodePath},getUserCommandsNodePath:function(){return a.userCommandsNodePath},workflowDefinitionManager:a.workflowDefinitionManager,workflowItemStorage:a.workflowItemStorage,sessionCreationTime:a.startTime,workflowQueue:a.workflowQueue,executionCompleteCallback:a.onWorkflowExecutionComplete.bind(a),usesRefactoredDebouncing:!0,workflowSynchronizationManager:a.workflowSynchronizationManager,workflowBatchSizeMax:function(){return rM.getValue()},areasIntersect:function(c){return!1},supportsAreaIntersection:function(c){return!1},itemScopeMovedTracker:void 0,notificationManager:u,workflowExecutionTrackersByName:s,areaIntersectionChecker:void 0,workflowExecutionScopesResolver:void 0,workflowPrefilterManager:void 0,workflowContextsManager:void 0}),a.workflowExecutionManager.on("executionStateChange",a.onWorkflowExecutionStateChanged.bind(a)),a.workflowExecutionManager.on("sweep",a.onWorkflowExecutionManagerSweep.bind(a)),a.workflowRegistrationsByName.forEach(function(l){return l.setExecutionManager(a.workflowExecutionManager)}),a.cache.on("beforeItemChange",function(l){a.inputChangesManager.applyChanges([l])}),v.info(595720205,y.CoreDefault,`Starting session ${a.sessionKey}. Is reconnect: ${t.isReconnect}.`),a}return(0,SS.default)(r,n),(0,kS.default)(r,[{key:"onClose",value:function(t,o,a){var s=this;vs(function(){var u;v.info(536959044,y.CoreDefault,`Session closing: ${Nr[t]} ${(u=o==null?void 0:o.reason)!==null&&u!==void 0?u:""}`),s.workflowQueue.kill(),s.isClosed=!0,s.downstreamMessageEndpoint&&s.downstreamMessageEndpoint.sendMessage(new Ve(o)),t!==Nr.ClientClose&&s.upstreamMessageEndpoint.sendMessage(new Ve(o)),s.syncMessageSequencer.onClose(),s.workflowExecutionManager.onSessionClose(),t===Nr.MastermindShutdown&&s.cache.dispose(),a()},this.cvParent.toString(),{sessionKey:this.sessionKey},this.clientMetadata)}},{key:"registerWorkflow",value:function(t){if(v.info(537781729,y.CoreDefault,`Session registering ${V[t.kind]} workflow ${t.id} at priority ${t.priority}`),this.workflowRegistrationsByName.has(t.id))throw new Error(`A workflow with name ${t.id} already exists`);var o=new Ow(t,this.workflowQueue);this.workflowRegistrationsByName.set(o.workflow.id,o),this.addWorkflowToDependencyMaps(t),this.workflowsWaitingForActivation.add(o),this.workflowGraph.addWorkflow(Ma(t)),this.workflowExecutionManager.attachExecutionTrackerToWorkflow(o,this.workflowsByInputAnnotation,this.workflowsByOutputAnnotation,this.workflowsByRequestedContextType),o.setExecutionManager(this.workflowExecutionManager)}},{key:"onWorkflowGraphInitMessage",value:function(t,o){var a=new E({operationName:"WorkflowGraphInit"}).start(),s=new Xi({downstreamRuntimeWorkflows:this.workflowGraph.getUpstreamRuntimeVisibleWorkflows()});a.success=!0,v.info(524850697,y.CoreDefault,a.stop()),o(void 0,s)}},{key:"sendAnnotations",value:function(t,o,a,s,u){var l=this,c=this.annotationActivationInfosByType.get(t);!this.isClosed&&c&&(!a||c.some(function(f){return f.sendApologies}))&&kn(function(f){var d,p=new Le({sessionHealthEventName:"SendAnnotations",resourceId:s==null?void 0:s.resourceId,source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!0,message:"",affectedWorkflows:[(d=s==null?void 0:s.resourceId)!==null&&d!==void 0?d:"All"]}).start(),g=function(S){var C=0;for(var x of o)m.getTypeNameFor(x)===S.getTypeName()&&(C+=x.items.length);return C};v.info(573870239,y.CoreDefault,`Sending annotations to client (type: ${t}, workflow: ${s?s.id:void 0}, added: ${g(we)}, updated: ${g(Oe)}, deleted: ${g(He)})`),l.upstreamMessageEndpoint.sendMessage(new Ct({cv:f.toString(),seq:l.nextAnnotationResultsSequenceId++,annotationType:t,batchSize:1,batchId:u,batchComplete:!0,ops:o}),function(k){p.success=!k||l.isClosed,p.message=k==null?void 0:k.error,p.success?v.verbose(536959046,y.CoreDefault,p.stop()):v.info(536959045,y.CoreDefault,p.stop())})})}},{key:"processAnnotationQueue",value:function(t,o){if(dr(t)){this.statelessAnnotationProcessor.processAnnotationQueue(t,o);return}if(!t.bypassModel){this.annotationProcessor.processAnnotationQueue(t,o);return}var a=[],s=[],u=H("FixDeletionOnImmediateAnnotation");for(var l of o){if(l.annotationQueue.length===0){s.push(l);continue}var c=[],f=[];for(var d of l.annotationQueue)Aa(t,d.annotationType)?c.push(d):f.push(d);if(c.length===0){s.push(l);continue}(!u||l.source!==ko.WorkflowAsync||c.length>0)&&a.push(Object.assign(Object.assign({},l),{annotationQueue:c})),(!u||l.source!==ko.WorkflowAsync||f.length>0)&&s.push(Object.assign(Object.assign({},l),{annotationQueue:f}))}(!u||a.length>0)&&this.statelessAnnotationProcessor.processAnnotationQueue(t,a),(!u||s.length>0)&&this.annotationProcessor.processAnnotationQueue(t,s)}},{key:"updateWorkflowExecutionStates",value:function(t){var o=this.workflowRegistrationsByName.values();for(var a of t)if(Pa.has(m.getTypeNameFor(a)))for(var s of a.items)for(var u of o||[]){var l=u.workflow;this.workflowExecutionManager.preProcessItemToWorkflow(l,s)}}},{key:"onWorkflowRegistrationMessage",value:function(t,o){var a=t.workflowDefinition,s,u;try{this.registerWorkflow(a),u=new Ge}catch(l){s=new X({error:l.message})}finally{o(s,u)}}},{key:"onSessionInitMessage",value:function(t,o){if(v.info(537781730,y.CoreDefault,`SessionInit for ${this.sessionKey}`),!t.clientMetadata)v.error(537781731,y.CoreDefault,"Client metadata NOT received");else{if(this.clientMetadata=t.clientMetadata,this.clientMetadata.flights){var a=this.clientMetadata.flights.toLowerCase().split(";");this.clientMetadataFlightsSet=new Set;for(var s of a){var u=s.charCodeAt(0),l=s.charCodeAt(s.length-1);u<33||u>126||l<33||l>126?this.clientMetadataFlightsSet.add(s.trim()):this.clientMetadataFlightsSet.add(s)}}this.upstreamMessageEndpoint.setClientMetadata(this.clientMetadata),this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.setClientMetadata(this.clientMetadata),this.workflowClientCoordinator.setClientMetadata(this.clientMetadata),this.workflowExecutionManager.setClientMetadata(this.clientMetadata)}this.enableRemoteExecutionNotification=t.enableRemoteExecutionNotification||!1,this.createUserNodeIfNotExists(),this.createTenantNodeIfNotExists(),this.createUserCommandsNodeIfNotExists(),this.activateWaitingWorkflows(Oa.SessionInitMessage);var c=new un({sessionUrlBase:"",sessionKey:this.sessionKey,origin:"",messageId:t.messageId,workflowInputTypes:t.returnWorkflowInputTypes?Array.from(this.workflowInputTypes):[],anonymousToken:"FakeToken",tokenExpirationSeconds:999999,downstreamRuntimeWorkflows:this.enableRemoteExecutionNotification?this.workflowGraph.getUpstreamRuntimeVisibleWorkflows():[]});o(void 0,c)}},{key:"onSessionCloseMessage",value:function(t,o){v.info(509728132,y.CoreDefault,`SessionClose for ${this.sessionKey}`),this.onClose(Nr.ClientClose,t,function(a){a?o(void 0,new X({messageId:t.messageId,error:a.message})):o(void 0,new pa({messageId:t.messageId}))})}},{key:"onAnnotationActivationMessage",value:function(t,o){var a=this;this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.sendMessage(new ln(t));var s=new Le({sessionHealthEventName:"AnnotationActivation",source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!0,message:"",affectedWorkflows:["All"],resultDescription:`Activating: ${t.annotationType} with token ${t.token}`},this.clientMetadata).start();{var u=o;o=function(M,b){M&&(s.success=!1),v.info(536959047,y.CoreDefault,s.stop()),u(M,b)}}var l=t.annotationType;if(!l){s.setReason(de.Client),o(new X({error:"No annotation type provided"}));return}var c=t.sendStateUpdates,f=t.config,d=t.token,p=t.sendApologies,g=this.annotationActivationInfosByType.get(l),k=!g;k&&(g=[],this.annotationActivationInfosByType.set(l,g)),g.forEach(function(_,M){_.token===t.token&&g.splice(M,1)}),g.push({token:d,sendStateUpdates:c,sendApologies:p,config:f}),v.verbose(536959048,y.CoreDefault,function(){return`Session.onAnnotationActivationMessage: '${l}' annotation was activated`});var S=function(M){t.batchId?(v.info(536959049,y.CoreDefault,"Client supplied batchId param (or ChangeGate was disabled), using legacy behavior"),o(void 0,new rr({token:d,annotationNotExists:!1})),Array.isArray(M)&&a.sendAnnotations(l,M,!1,void 0,t.batchId||t.token||"Unknown")):(o(void 0,new Ge),Array.isArray(M)&&M.length>0&&a.sendAnnotations(l,M,!1))};if(t.ignoreExistingAnnotations)S();else if(k){var C;try{C=this.cache.getSubtreeItems([],[l])}catch(_){o(new X({error:`Failed to retrieve existing annotations: ${_.message}`}));return}v.info(536959050,y.CoreDefault,`Sending existing annotations to client (type: ${l}, count: ${C.length})`);var x=C.map(function(_){return new we({parentPath:_.parentPath,items:[_]})});S(x)}if(c){var T=this.workflowExecutionManager.getWorkflowsByExecutionState(xe.Pending,xe.Running);for(var I of this.workflowsByOutputAnnotation.get(t.annotationType)||[])!T.has(I)||this.pendingExecutionStateUpdates.has(I)||this.pendingExecutionStateUpdates.set(I,xe.Pending);this.workflowExecutionManager.requestSweep()}this.unsuspendWorkflows(l),this.emit("annotationActivationMessageReceived"),this.activateWaitingWorkflows(Oa.AnnotationActivatedMessage)}},{key:"unsuspendWorkflows",value:function(t){for(var o of(0,It.default)(this.workflowsByOutputAnnotation.get(t)||[]))if(this.workflowRegistrationsByName.get(o.id).suspendExecution){for(var a of this.workflowExecutionManager.getAllUpstreamWorkflowIds(o.id).reverse())this.workflowRegistrationsByName.get(a).suspendExecution&&(this.workflowRegistrationsByName.get(a).suspendExecution=!1,v.info(509155540,y.CoreDefault,`Execution of ${a} is unsuspended by downstream workflow request.`),this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(a)));this.workflowRegistrationsByName.get(o.id).suspendExecution=!1,v.info(509155539,y.CoreDefault,`Execution of ${o.id} is unsuspended by annotation activation request.`),this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(o.id))}}},{key:"onAnnotationReleaseMessage",value:function(t,o){var a=!1,s=!1,u=new Le({sessionHealthEventName:"AnnotationRelease",source:Ie.Core,reason:de.Core,impact:_e.None,success:!1,message:"",affectedWorkflows:["All"],resultDescription:`Releasing token: ${t.token}`},this.clientMetadata).start();for(var l of this.annotationActivationInfosByType){var c=(0,ei.default)(l,2),f=c[0],d=c[1],p=d.findIndex(function(g){return g.token==t.token});if(p>=0){d.length===1?(this.annotationActivationInfosByType.delete(f),s=!0,this.trySuspendWorkflowByAnnotationRelease(f)):d.splice(p,1),a=!0,u.success=!0,u.resultDescription=`Releasing: ${f} and token ${t.token}, lastRelease: ${s}`;break}}v.info(536959051,y.CoreDefault,u.stop()),a?o(void 0,new Yr({lastRelease:s})):o(new X({error:Ot.AnnotationTokenNotFound}))}},{key:"trySuspendWorkflowByAnnotationRelease",value:function(t){for(var o of(0,It.default)(this.workflowsByOutputAnnotation.get(t)||[]))if(this.workflowMeetsSuspendConditions(o)){this.workflowRegistrationsByName.get(o.id).suspendExecution=!0,v.info(509155538,y.CoreDefault,`Output annotations fully released, suspending ${o.id} execution.`);for(var a of this.workflowExecutionManager.getAllUpstreamWorkflowIds(o.id))this.trySuspendWorkflowByDownstreamRelease(this.workflowRegistrationsByName.get(a))}}},{key:"workflowMeetsSuspendConditions",value:function(t){var o=this;if(this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(t.id))||(t.outputTypes||[]).some(function(u){return o.annotationActivationInfosByType.has(u)}))return!1;var a=!0;for(var s of this.workflowExecutionManager.getAllDownstreamWorkflowIds(t.id))if(!this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(s))&&!this.workflowRegistrationsByName.get(s).suspendExecution){a=!1;break}return a}},{key:"trySuspendWorkflowByDownstreamRelease",value:function(t){this.workflowMeetsSuspendConditions(t.workflow)&&(t.suspendExecution=!0,v.info(509155537,y.CoreDefault,`Downstream workflows fully released, suspending ${t.workflow.id} execution.`))}},{key:"onWorkflowDefinitionOverrideMessage",value:function(t,o){var a,s,u,l,c=new Le({sessionHealthEventName:"WorkflowDefinitionOverride",source:Ie.Core,reason:de.Core,impact:_e.None,success:!1,message:"",affectedWorkflows:["All"],joinContextId:(a=t.contextId)!==null&&a!==void 0?a:""},this.clientMetadata).start(),f=function(k,S){c.setReason(k),c.resultDescription=S,v.error(529093136,y.CoreDefault,c.stop()),o(new X({error:S}))},d=(s=this.workflowRegistrationsByName.get(t.sourceWorkflowId))===null||s===void 0?void 0:s.workflow;if(!d){f(de.Workflow,`Workflow registration for source workflow '${t.targetWorkflowId} was not found.`);return}var p=(u=this.workflowRegistrationsByName.get(t.targetWorkflowId))===null||u===void 0?void 0:u.workflow;if(!p){f(de.Workflow,`Workflow registration for target workflow '${t.targetWorkflowId} was not found.`);return}if(!p.allowDefinitionOverride){f(de.Workflow,`Workflow '${p.id} does not allow workflow definition override.`);return}if(!(!((l=d.definitionOverrideTargetWorkflows)===null||l===void 0)&&l.includes(p.id))){f(de.Workflow,`Workflow '${d.id} does not allow workflow definition for workflow '${p.id}'.`);return}this.workflowDefinitionManager.mergeWorkflowDefinition(p,t.definition,t.contextId),c.success=!0,c.resourceId=d.id,c.resultDescription=`Updated config for workflow: ${t.targetWorkflowId}, context id: ${t.contextId}`,v.info(529093137,y.CoreDefault,c.stop()),o(void 0,new Ge)}},{key:"onGetAnnotationsRequestMessage",value:function(t,o){throw new Error("Not implemented yet")}},{key:"onAnnotationConfigUpdateMessage",value:function(t,o){for(var a of this.annotationActivationInfosByType){var s=(0,ei.default)(a,2),u=s[0],l=s[1],c=l.findIndex(function(p){return p.token===t.token});if(c>=0){var f=l[c];f.config=t.config,l.splice(c,1),l.push(f);for(var d of(0,It.default)(this.workflowsByOutputAnnotation.get(u)||[]))(!rn(d)||this.isWorkflowTriggeredByNonExclusiveSignals(d))&&!this.workflowsWaitingForActivation.has(this.workflowRegistrationsByName.get(d.id))&&this.tryScheduleWorkflowExecution(this.workflowRegistrationsByName.get(d.id));v.info(529093138,y.CoreDefault,`Updated: ${u} config by token ${t.token}`),o(void 0,new Lo({token:t.token,success:!0}));return}}v.error(529093139,y.CoreDefault,`Annotation token: ${t.token} was not found`),o(void 0,new Lo({token:t.token,success:!1}))}},{key:"onMicroSyncMessage",value:function(t,o){var a=new we({items:[t.item],parentPath:t.parentPath||["session"]});this.statelessItemListeners.emitEvents([a]),o(void 0,new Ge)}},{key:"onSyncMessage",value:function(t,o){var a=this;if(this.downstreamMessageEndpoint&&this.downstreamMessageEndpoint.sendMessage(new Be(t)),this.contextIdManager.applyContextIdOnOperations(t.ops),this.updateWorkflowExecutionStates(t.ops),t.ops&&t.ops.length>0&&Cn.typeGuard(t.ops[0])){this.applySyncMessage(t,o);return}var s=[];if(t.ops&&t.ops.length>0)for(var u of t.ops)if(m.getTypeNameFor(u)===it.getTypeName()){var l=function(d){if(!d.body)return 1;var p=function(S){var C=S.workflow.kind===V.SingleItem&&m.matchesTypesFor(d.body,S.workflow.inputTypes),x=rn(S.workflow)&&m.matchesTypesFor(d.body,S.workflow.triggerSignals);(C||x)&&(v.verbose(536959052,y.CoreDefault,function(){return`Received trigger signal ${m.getTypeNameFor(d.body)}, adding it to cache for waiting workflow ${S.workflow.resourceId}`}),Array.isArray(S.triggerSignalOpsQueue)||(S.triggerSignalOpsQueue=[]),S.triggerSignalOpsQueue.push(new it({parentPath:u.parentPath,items:[d]})),S.triggerSignalOpsQueue.length>eM.getValue()&&(v.verbose(536959053,y.CoreDefault,function(){return`Exceeded max trigger signal cache size for ${S.workflow.resourceId}, discarding oldest`}),S.triggerSignalOpsQueue.shift()))};for(var g of a.workflowsWaitingForActivation)p(g)};for(var c of u.items)l(c);v.info(529093140,y.CoreDefault,"Dispensing signal operation to listeners"),this.statelessItemListeners.emitEvents([u])}else z(u.parentPath)==z(["session","#userContext#"])&&this.userNodePath&&(u.parentPath=(0,It.default)(this.userNodePath)),z(u.parentPath)==z(["session","#tenantContext#"])&&this.tenantNodePath&&(u.parentPath=(0,It.default)(this.tenantNodePath)),z(u.parentPath)==z(["session","#userCommands#"])&&this.userCommandsNodePath&&(u.parentPath=(0,It.default)(this.userCommandsNodePath)),s.push(u);t.ops=s,t.seq!==void 0?this.syncMessageSequencer.onSyncMessage(t,o):(s.length>0&&v.warn(536959054,y.CoreDefault,"SyncMessage with non signal operations and undefined sequence bypassed"),o(void 0,new cn))}},{key:"onWorkflowExecutionManagerSweep",value:function(){var t=this;if(!(this.pendingExecutionStateUpdates.size===0||this.isClosed)){var o=new Map;for(var a of this.annotationActivationInfosByType){var s=(0,ei.default)(a,2),u=s[0],l=s[1];if(l.some(function(I){return I.sendStateUpdates})){var c=(0,It.default)(this.workflowsByOutputAnnotation.get(u)||[]).filter(function(I){return t.pendingExecutionStateUpdates.has(I)});if(c.length!==0){var f=!0;for(var d of c)if(this.pendingExecutionStateUpdates.get(d)!==xe.Idle){f=!1;break}f?this.lastSeenAnnotationStateByAnnotation.get(u)===sn.Pending&&o.set(u,sn.Idle):(this.lastSeenAnnotationStateByAnnotation.get(u)||sn.Idle)===sn.Idle&&o.set(u,sn.Pending)}}}var p=new Array(o.size),g=0;for(var k of o){var S=(0,ei.default)(k,2),C=S[0],x=S[1];this.lastSeenAnnotationStateByAnnotation.set(C,x),p[g++]={annotationType:C,state:x}}if(this.pendingExecutionStateUpdates.clear(),p.length>0&&!this.isClosed){var T=new Le({sessionHealthEventName:"SendAnnotationResultStates",source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!0,message:"",affectedWorkflows:["All"]}).start();this.upstreamMessageEndpoint.sendMessage(new Jr({updates:p}),function(I){T.success=!I||t.isClosed,T.message=I==null?void 0:I.error,T.success?v.verbose(536959056,y.CoreDefault,T.stop()):v.info(536959055,y.CoreDefault,T.stop())})}}}},{key:"onWorkflowExecutionComplete",value:function(t,o){this.enableRemoteExecutionNotification&&this.upstreamMessageEndpoint.sendMessage(new eo({seq:this.nextWorkflowExecutionCompleteSequenceId++,workflowId:t,contextId:o,ops:[]}),function(a){if(a){var s=new E({operationName:"WorkflowExecutionCompleteMessageError",resourceId:t,joinContextId:o});s.resultDescription=a==null?void 0:a.error,v.error(512354250,y.CoreDefault,s)}})}},{key:"onWorkflowExecutionStateChanged",value:function(t,o){var a=this,s=this.workflowRegistrationsByName.get(t).workflow,u=(0,It.default)(s.outputTypes||[]).some(function(l){return(0,It.default)(a.annotationActivationInfosByType.get(l)||[]).some(function(c){return c.sendStateUpdates})});u&&(this.pendingExecutionStateUpdates.set(s,o),this.workflowExecutionManager.requestSweep())}},{key:"onSeedCompleted",value:function(){this.isSeedingCompleted=!0,this.activateWaitingWorkflows(Oa.SeedCompleted)}},{key:"applySyncMessage",value:function(t,o){var a=new Le({sessionHealthEventName:"ApplySyncMessage",source:Ie.Core,reason:de.Core,impact:_e.MissingInput,success:!0,message:`seq=${t==null?void 0:t.seq}`,resourceId:(t==null?void 0:t.seq)<=0?"Seeding":"NonSeeding"}).start();if(!t||!Array.isArray(t.ops)||!t.ops.length){o(void 0,new cn);return}try{this.cache.applyOperations(t.ops,t.seq),v.info(536959059,y.CoreDefault,a.stop()),o(void 0,new cn)}catch(s){a.success=!1,v.error(536959057,y.CoreDefault,a.stop()),v.error(536959058,y.CoreDefault,`Cache apply failed: ${s.stack}`),o(new X({error:"Failed to commit"}));return}}},{key:"activateWorkflowByType",value:function(t){if(t.isActivated=!0,t.workflow.kind===V.SingleItem)this.activateSingleItemWorkflow(t);else if(t.workflow.kind===V.DynamicText)this.activateDynamicTextWorkflow(t);else if(t.workflow.kind===V.Reduce)this.activateReduceWorkflow(t);else if(t.workflow.kind===V.Grid)this.activateGridNeighborhoodWorkflow(t);else if(t.workflow.kind===V.Join)this.activateJoinWorkflow(t);else if(t.workflow.kind===V.Generic)this.activateGenericWorkflow(t);else throw new Error("Unknown workflow type");var o=t.workflow.kind;(o===V.Reduce||o===V.DynamicText||o===V.Generic)&&this.setupEventListener(t),this.setupContextListener(t),this.emit("workflowActivated",t)}},{key:"onAnnotationResultsMessage",value:function(t,o){this.upstreamMessageEndpoint.sendMessage(new Ct(t),o);try{this.cache.applyOperations(t.ops,void 0)}catch(a){}}},{key:"shouldTriggerOnAnnotationMetadataUpdated",value:function(t,o){var a;return!!(t!=null&&t.M_&&(!((a=o.triggerConditions)===null||a===void 0)&&a.includes(Vt.AnnotationMetadataUpdated)))}},{key:"shouldInvalidateOnEvent",value:function(t){var o,a,s,u=t.workflow.eventSequenceOptions,l=(a=(o=u.windowIncrement)!==null&&o!==void 0?o:u.minWindowSize)!==null&&a!==void 0?a:1;if(t.eventCountSinceLastTrigger<l)return!1;var c=Date.now()-t.lastTriggerByEventsTime;return!((s=c<u.minTimeIncrement)!==null&&s!==void 0&&s)}},{key:"setupEventListener",value:function(t){var o=this;!t.workflow.eventSequenceOptions||t.workflow.eventSequenceOptions.shouldTriggerWorkflow===!1||this.cache.onItemChange(Fr.getTypeName(),t.workflow.inputStage,function(a){if(!t.suspendExecution){for(var s of a){var u=m.getTypeNameFor(s);for(var l of s.items)u===we.getTypeName()&&Ys(l.body,t.workflow.eventSequenceOptions)&&t.eventCountSinceLastTrigger++}o.shouldInvalidateOnEvent(t)&&t.invalidate([{isInvalidatedByEvents:!0}])}})}},{key:"setupContextListener",value:function(t){if(!(!t.workflow.requestedContextTypesRules||rn(t.workflow)&&!this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow)||t.workflow.kind==V.Join||br(t.workflow))){for(var o of t.workflow.requestedContextTypesRules)if(o.shouldTriggerOnContextChange)for(var a of o.contextTypes)this.onContextChange(a,t)}}},{key:"onContextChange",value:function(t,o){var a=this,s=function(l,c,f){if(!f)return!1;var d=a.cache.getItem(f);if(!d)return!1;var p=z(f),g=d.body&&m.matchesTypesFor(d.body,[bt.getTypeName(),zn.getTypeName(),so.getTypeName()]),k;return H("AddSessionAsContextHolder")?k=z(a.userNodePath)===p||z(a.tenantNodePath)===p||p==="session":k=z(a.userNodePath)===p||z(a.tenantNodePath)===p,g||k?(l.push({opType:c,updatedContextScope:g?f:[]}),!0):!1};this.cache.onItemChange(t,o.workflow.inputStage,function(u){var l;if(!o.suspendExecution){var c=[];for(var f of u){var d=m.getTypeNameFor(f);if(!(d===mt.getTypeName()&&!a.shouldTriggerOnAnnotationMetadataUpdated(f,o.workflow)&&!a.isAnnotationMetadataRejection(f))){var p=s(c,d,f.parentPath);if(!p&&H("ContextHolderAsSelfContext"))for(var g of(l=f.items)!==null&&l!==void 0?l:[])g!=null&&g.id&&s(c,d,[].concat((0,It.default)(f.parentPath),[g.id]))}}c.length>0&&o.invalidate(c)}})}},{key:"activateSingleItemWorkflow",value:function(t){var o=this;if(t.workflow.inputTypes)for(var a of t.workflow.inputTypes)this.cache.onItemChange(a,t.workflow.inputStage,function(s){if(!t.suspendExecution){var u=[];for(var l of s){var c=m.getTypeNameFor(l);for(var f of l.items)if(c===we.getTypeName()||c===Oe.getTypeName()||c===Cn.getTypeName()||c===mt.getTypeName()&&o.shouldTriggerOnAnnotationMetadataUpdated(l,t.workflow)){var d=o.createInvalidationParam(t,c,l.parentPath,f);u.push(d)}}u.length>0&&t.invalidate(u)}}),this.statelessItemListeners.onItemChange(a,t.workflow.inputStage,function(s){if(!t.suspendExecution){var u=[];for(var l of s)for(var c of l.items){var f=o.createInvalidationParam(t,m.getTypeNameFor(l),l.parentPath,c);u.push(f)}u.length>0&&t.invalidate(u)}})}},{key:"activateDynamicTextWorkflow",value:function(t){var o=this;if(t.workflow.inputTypes)for(var a of t.workflow.inputTypes)this.cache.onItemChange(a,t.workflow.inputStage,function(s){if(!t.suspendExecution){var u=[];for(var l of s){var c=m.getTypeNameFor(l);for(var f of l.items)if(c===we.getTypeName()||c===Oe.getTypeName()){var d=o.createInvalidationParam(t,c,l.parentPath,f);u.push(d)}}u.length>0&&t.invalidate(u)}})}},{key:"onTriggerSignalReceived",value:function(t,o,a){var s,u=m.getTypeNameFor(t);if(u===we.getTypeName()||u===it.getTypeName()){var l=o.body;if(!l)v.error(508044379,y.CoreDefault,`Attempted triggering of workflow ${a.workflow.id} by an object which is not a signal`);else if(H("ImplementSignalWithPath")){var c=o.body;c.signalPath=(s=c.signalPath)!==null&&s!==void 0?s:[].concat((0,It.default)(t.parentPath),[o.id]),o.sourceInfo&&(c.sourceInfo=o.sourceInfo),this.scheduleWorkflowExecution(a,[c])}else this.scheduleWorkflowExecution(a,[l])}}},{key:"isAnnotationMetadataRejection",value:function(t){var o;return((o=t==null?void 0:t.M_)===null||o===void 0?void 0:o.state)===Bt.Rejected}},{key:"activateReduceWorkflow",value:function(t){var o=this;if(rn(t.workflow))for(var a of t.workflow.triggerSignals)this.cache.onItemChange(a,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var c of l)for(var f of c.items)o.onTriggerSignalReceived(c,f,t)}),this.statelessItemListeners.onItemChange(a,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var c of l)for(var f of c.items)o.onTriggerSignalReceived(c,f,t)});if(!rn(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow)){var s=new Set(t.workflow.inputTypes);s.add(t.workflow.collectionScopeType);for(var u of s)this.cache.onItemChange(u,t.workflow.inputStage,function(l){if(!t.suspendExecution)for(var c of l){var f=m.getTypeNameFor(c);if(!(f===mt.getTypeName()&&!o.shouldTriggerOnAnnotationMetadataUpdated(c,t.workflow)&&!o.isAnnotationMetadataRejection(c)))for(var d of c.items){var p=o.createInvalidationParam(t,f,c.parentPath,d);t.invalidate([p])}}},!0)}}},{key:"activateJoinWorkflow",value:function(t){var o=this,a=new Set(t.workflow.inputTypes);a.add(t.workflow.collectionScopeType);for(var s of a)this.cache.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution)for(var l of u){var c=m.getTypeNameFor(l);if(!(c===mt.getTypeName()&&!o.shouldTriggerOnAnnotationMetadataUpdated(l,t.workflow)&&!o.isAnnotationMetadataRejection(l))&&c!==He.getTypeName())for(var f of l.items){var d=o.createInvalidationParam(t,c,l.parentPath,f);t.invalidate([d])}}},!0),this.statelessItemListeners.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution){var l=[];for(var c of u){var f=m.getTypeNameFor(c);if(f!==He.getTypeName())for(var d of c.items){var p=o.createInvalidationParam(t,f,c.parentPath,d);l.push(p)}}l.length>0&&t.invalidate(l)}})}},{key:"activateGenericWorkflow",value:function(t){var o=this;if(rn(t.workflow))for(var a of t.workflow.triggerSignals)this.cache.onItemChange(a,t.workflow.inputStage,function(u){if(!t.suspendExecution)for(var l of u)for(var c of l.items)o.onTriggerSignalReceived(l,c,t)}),this.statelessItemListeners.onItemChange(a,t.workflow.inputStage,function(u){if(!t.suspendExecution)for(var l of u)for(var c of l.items)o.onTriggerSignalReceived(l,c,t)});if(!rn(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow))for(var s of t.workflow.invalidationTypes||[])this.cache.onItemChange(s,t.workflow.inputStage,function(u){if(!t.suspendExecution)for(var l of u){var c=m.getTypeNameFor(l);if(!(c===mt.getTypeName()&&!o.shouldTriggerOnAnnotationMetadataUpdated(l,t.workflow)&&!o.isAnnotationMetadataRejection(l)))for(var f of l.items){var d=o.createInvalidationParam(t,c,l.parentPath,f);t.invalidate([d])}}})}},{key:"activateGridNeighborhoodWorkflow",value:function(t){this.activateReduceWorkflow(t)}},{key:"createInvalidationParam",value:function(t,o,a,s){var u=at(a,s);return{opType:o,item:u,isDeltaUpdate:!1}}},{key:"queueGridNeighborhoodWorkflow",value:function(t,o,a,s,u,l,c,f){throw new Error("NYI")}},{key:"queueWorkflow",value:function(t,o,a){var s=this;v.debug(537781760,y.CoreDefault,function(){return`Queuing Workflow. Queue Length: ${s.workflowQueue.length()} Running: ${s.workflowQueue.running()}`});var u=Pl(),l=new Le({sessionHealthEventName:"QueueSessionWorkflow",resourceId:t.workflow.resourceId,success:!0,source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,message:"",affectedWorkflows:[t.workflow.resourceId]},this.clientMetadata).start(),c={cc:u,queueOp:l,registration:t,executionId:t.totalExecutionCount++,tasks:o};c.containsPrefilteredTasks=a,t.queueTask(c)}},{key:"processPrefilterActionResults",value:function(t,o){var a,s=!1;for(var u of o.tasks)!u.prefilterActionResults||u.status===et.ExecutionCancelled||u.status===et.ResultsCancelled||(!((a=t.modelOptions)===null||a===void 0)&&a.includeItemOperations&&this.inputChangesManager.resetChanges(t.id,[].concat((0,It.default)(u.scopeItem.parentPath),[u.scopeItem.id])),this.processAnnotationQueue(t,u.prefilterActionResults),s=!0);return s}},{key:"convertTaskToWorkflowInput",value:function(t,o){return{scopeItem:t.scopeItem,inputItems:t.inputItems,inputContext:t.inputContext,triggerSignals:t.triggerSignals,existingAnnotations:t.previousAnnotations,dynamicContext:t.dynamicContextItems,annotationActivationConfigs:this.getAnnotationActivationConfigs(o.outputTypes),requestedContexts:t.requestedContextsAndEvents}}},{key:"filterCancelledWorkflowTasks",value:function(t){var o=[];for(var a of t.tasks)a.status!==et.ExecutionCancelled&&a.status!==et.ResultsCancelled&&(a.status=et.Running,o.push(a));return o}},{key:"executeWorkflow",value:function(t,o){var a=this;ze(function(){var s=t.registration.workflow;if(a.isClosed){v.info(537781761,y.CoreDefault,`Session is closed - skipping execution of workflow ${s.id}`),o();return}var u=function(){o();for(var x of t.tasks)x.status!==et.ResultsCancelled&&x.status!==et.ExecutionCancelled&&a.workflowSynchronizationManager.notifyOnCompleted(x,t.registration.workflow.id)};if(t.tasks=a.filterCancelledWorkflowTasks(t),t.tasks.length===0){o();return}var l=t.queueOp.stop(),c=function(){v.info(536959061,y.CoreDefault,l)},f=l.durationMs;if(s.maxQueueWaitTimeMs&&f>s.maxQueueWaitTimeMs){v.info(536959062,y.CoreDefault,`Workflow ${s.id} queue wait time (${f}) exceeded specified maximum queue wait time (${s.maxQueueWaitTimeMs}) - skipping workflow execution`),u(),l.success=!1,l.dimension0="WorkflowExecutionCancelled",c();return}if(t.containsPrefilteredTasks){var d=a.processPrefilterActionResults(s,t);u(),l.dimension0=d?"Prefiltered:WithActionResults":"Prefiltered:NoActionResults",c();return}a.stats.workflowExecutions++,c(),t.tasks.some(function(C){return C.isTriggeredByEvents})&&(t.registration.lastTriggerByEventsTime=Date.now(),t.registration.eventCountSinceLastTrigger=0);var p=new Le({sessionHealthEventName:"ExecuteSessionWorkflow",resourceId:s.resourceId,source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!0,message:"",affectedWorkflows:[s.resourceId]},a.clientMetadata).start(),g=function(x){p.stop(),x!==void 0&&x>0&&(p.durationMs-=x),p.success||a.stats.workflowExecutionErrors++,a.stats.workflowExecutionDurationMsMax=Math.max(p.durationMs,a.stats.workflowExecutionDurationMsMax),v.info(524339278,y.CoreDefault,p)},k=t.tasks.map(function(C){return a.convertTaskToWorkflowInput(C,s)}),S=function(x,T,I){var _;if(H("AllowResultOperationToPassIsTriggeredBySyncDeltaProp")&&(!((_=x.triggerConditions)===null||_===void 0)&&_.some(function(b){return b===Vt.DeltaUpdate}))&&(T!=null&&T.length)){var M=I==null?void 0:I.some(function(b){var A;return(A=b.deltas)===null||A===void 0?void 0:A.some(function(N){var F=N;return!(F!=null&&F.content)&&(F==null?void 0:F.unit)===Ke.Sentence&&(F==null?void 0:F.deltaType)===me.Update})});M&&T.forEach(function(b){return b.isTriggeredBySyncDelta=!0})}};a.workflowClientCoordinator.executeWorkflow(s,k,function(C,x){var T,I;if(H("StopWorkflowsOnClose")&&a.isClosed){u(),v.info(524339279,y.CoreDefault,`Session is closed - skipping processing results of workflow ${s.id}`);return}for(var _=[],M=0;M<k.length;M++){var b=t.tasks[M],A=(x==null?void 0:x.length)>M?x[M]:void 0;if(S(s,A==null?void 0:A.annotations,k[M].inputItems),p.success=!0,p.dimension0="",p.dimension1=String(A==null?void 0:A.ignoreExecution),p.dimension2="",p.joinContextId=(T=b.scopeItem.contextId)!==null&&T!==void 0?T:"",p.message="",p.resultDescription="",p.setReason(de.Core),p.setSource(Ie.Core),p.setImpact(_e.MissingOutput),C)v.info(524339280,y.CoreDefault,`Failure during workflow ${s.id} execution ${C}`),p.success=!1,p.dimension0=ee[Uf(C.message)],p.resultDescription=C.stack,$s.has(C.message)&&py(ee[C.message])?a.stats.workflowExecutionInfraErrors++:p.setReason($s.has(C.message)&&ee[C.message]===ee.RequiredTokenNotAvailable?de.Client:de.Workflow);else if((x==null?void 0:x.length)!==k.length)p.success=!1,v.error(524339281,y.CoreDefault,`Workflow Inputs/Outputs length mismatch. Expected ${k.length}, Actual: ${x==null?void 0:x.length}`);else if(A.error)v.info(524339282,y.CoreDefault,`Failure during workflow ${s.id} execution ${A.error}`),p.success=!1,p.dimension0=ee[Uf(A.error)],p.resultDescription=A.error,p.setReason(de.Workflow),A.isExpectedError&&(p.success=!0,p.dimension2="ExpectedFailure");else if(!A.ignoreExecution&&!A.annotations)v.info(524339283,y.CoreDefault,`Workflow ${s.id} is disabled - no error, no annotations`),p.dimension0=ee[ee.WorkflowDisabled];else if(!A.ignoreExecution&&!Array.isArray(A.annotations)){v.error(524339284,y.CoreDefault,"annotationQueue is not an array"),p.success=!1;var N=ee.WorkflowWrongAnnotationType;p.dimension0=ee[N],p.setReason(de.Workflow)}if(Array.isArray(A==null?void 0:A.annotations)){var F=b.scopeItem||(b.inputItems&&b.inputItems.length===1?b.inputItems[0]:void 0),q=F?[].concat((0,It.default)(F.parentPath),[F.id]):void 0;_.push({scopeItemPath:q,scopeItemRevId:F==null?void 0:F.revId,annotationQueue:A.annotations,source:ko.Workflow})}g(),a.emit("workflowFinished",{success:p.success,hadAnnotations:Array.isArray(A==null?void 0:A.annotations)&&(A==null?void 0:A.annotations.length)>0,queueIdle:a.workflowQueue.idle(),workflowId:t.registration.workflow.id,parentPath:b.scopeItem.parentPath,itemId:b.scopeItem.id}),!((I=s.modelOptions)===null||I===void 0)&&I.includeItemOperations&&!C&&!(A!=null&&A.error)&&!A.ignoreExecution&&a.inputChangesManager.resetChanges(s.id,[].concat((0,It.default)(b.scopeItem.parentPath),[b.scopeItem.id]))}_.length>0&&a.processAnnotationQueue(s,_),u()})},t.cc)}},{key:"getAnnotationActivationConfigs",value:function(t){var o=[];for(var a of t||[]){var s=this.annotationActivationInfosByType.get(a),u=[];for(var l of s||[])l.config&&u.push(l.config);u.length>0&&o.push({annotationType:a,configs:u})}return o.length>0?o:void 0}},{key:"onTokenProvisionMessage",value:function(t,o){var a=new Le({sessionHealthEventName:"TokenProvision",success:!1,source:Ie.Core,reason:de.Client,impact:_e.MissingInput,message:"",resourceId:"undefined",affectedWorkflows:["All"]},this.clientMetadata).start();{var s=o;o=function(l,c){a.success=!l&&!!c,(l==null?void 0:l.error)==="Unexpected server error."&&a.setReason(de.Core),v.info(524027904,y.CoreDefault,a.stop()),s(l,c)}}this.downstreamMessageEndpoint?this.downstreamMessageEndpoint.sendMessage(t,o):o(void 0,new Ge)}},{key:"createSessionModelNodeIfNotExists",value:function(t,o,a){try{var s=this.cache.getItem([].concat((0,It.default)(t),[o]));if(s){v.debug(536959063,y.CoreDefault,`Node ${o} already added in the cache`);return}}catch(l){if(l instanceof io)v.debug(536959064,y.CoreDefault,`Node ${o} not found in the cache`);else throw l}var u=[new we({parentPath:t,items:[a]})];try{this.cache.applyOperations(u,void 0),v.debug(536959066,y.CoreDefault,`Successfully added node ${o} in the cache`)}catch(l){throw v.error(536959065,y.CoreDefault,`Failed to add node ${o} to the cache.`),l}}},{key:"createUserNodeIfNotExists",value:function(){var t="user_userId",o=["session","user"];this.createSessionModelNodeIfNotExists(o,t,{id:t,body:new Sr,source:Rd}),this.userNodePath=[].concat(o,[t])}},{key:"createTenantNodeIfNotExists",value:function(){var t="tenant_userId",o=["session","user"];this.createSessionModelNodeIfNotExists(o,t,{id:t,body:new Cr,source:Rd}),this.tenantNodePath=[].concat(o,[t])}},{key:"createUserCommandsNodeIfNotExists",value:function(){var t="commands_userId",o=["session","user"];this.createSessionModelNodeIfNotExists(o,t,{id:t,body:new Ti,source:Rd}),this.userCommandsNodePath=[].concat(o,[t])}},{key:"workflowMeetsActivationConditions",value:function(t){var o=this,a="",s=!0,u=this.getActivationTierForCurrentSession(t);if(u===yn.NeverActivate)return v.verbose(536959067,y.CoreDefault,function(){return`Workflow ${t.id} is disabled in ${o.clientMetadata.appName}/${o.clientMetadata.appPlatform}/${o.clientMetadata.releaseAudienceGroup}/${o.clientMetadata.tenantGroup} session`}),{meetsConditions:!1,waitingReasons:`["${ti.WorkflowDisabled}"]`,isEnabledAndActivatedByClient:!1};this.isWorkflowWaitingForAnnotationActivation(t,u)&&(a+=`"${ti.AnnotationActivation}"`,s=!1),this.isWaitingForFlight(t.activationFlightsConfigs)&&(a+=`${a.length===0?"":", "}"${ti.Flight}"`),this.isWorkflowWaitingForSeedCompleted(t)&&(a+=`${a.length===0?"":", "}"${ti.Seeding}"`);var l=a.length===0;return a="["+a+"]",{meetsConditions:l,waitingReasons:a,isEnabledAndActivatedByClient:s}}},{key:"isWorkflowWaitingForSeedCompleted",value:function(t){return t.inputStage&zt.OnSeed&&this.isSeedingCompleted===!1}},{key:"isWorkflowWaitingForAnnotationActivation",value:function(t,o){if(o>=vS.getValue()&&(!t.outputTypes||t.outputTypes.length===0))return t.activationConfigs.some(function(l){return l.activationTier===yn.PreActivate})||v.warn(536959068,y.CoreDefault,`${t.id} with no outputs should be pre-activated.`),!0;if(o<vS.getValue())return!1;var a=!1,s=!1;for(var u of t.outputTypes||[])if(a=this.annotationActivationInfosByType.has(u),a||(s=this.outputAnnotationsRequiredByDownstreamWorkflows.has(u),s))break;return!a&&!s}},{key:"matchesClientAppName",value:function(t){var o,a;if(t.clientAppName==="All")return!0;var s=(a=(o=this.clientMetadata)===null||o===void 0?void 0:o.appName)===null||a===void 0?void 0:a.toLowerCase();return s===void 0?!1:!!(t.clientAppName.toLowerCase()===s||t.clientAppName==="Fluid_*"&&s.startsWith("fluid_"))}},{key:"matchesClientTenantGroup",value:function(t){var o,a;return t==="All"||t===void 0||t.toLowerCase()===((a=(o=this.clientMetadata)===null||o===void 0?void 0:o.tenantGroup)===null||a===void 0?void 0:a.toLowerCase())}},{key:"getActivationTierForCurrentSession",value:function(t){var o,a,s,u,l=yn.Default;for(var c of t.activationConfigs)this.matchesClientAppName(c)&&(c.clientAppPlatform==="All"||c.clientAppPlatform.toLowerCase()===((a=(o=this.clientMetadata)===null||o===void 0?void 0:o.appPlatform)===null||a===void 0?void 0:a.toLowerCase()))&&(c.clientReleaseAudienceGroup==="All"||c.clientReleaseAudienceGroup===void 0||c.clientReleaseAudienceGroup.toLowerCase()===((u=(s=this.clientMetadata)===null||s===void 0?void 0:s.releaseAudienceGroup)===null||u===void 0?void 0:u.toLowerCase()))&&this.matchesClientTenantGroup(c.clientTenantGroup)&&(l=c.activationTier);return l===yn.PreActivate&&!nM.getValue().includes(t.id)&&(v.warn(536959069,y.CoreDefault,`Workflow ${t.id} is not allowed to preactivate`),l=yn.Default),l}},{key:"isWaitingForFlight",value:function(t){var o=this;if(!t||t.length<=0)return!1;var a=this.clientMetadata.appName.toLowerCase().trim(),s=!1;for(var u of t){var l=u.clientAppName.toLowerCase().trim();if(l==="all"||l===a){if((!Array.isArray(u.requiredFlights)||u.requiredFlights.every(function(c){return o.isClientOnFlight(c)}))&&(!Array.isArray(u.restrictedFlights)||!u.restrictedFlights.some(function(c){return o.isClientOnFlight(c)})))return!1;s=!0}}return s}},{key:"isClientOnFlight",value:function(t){return this.clientMetadataFlightsSet.has(t.toLowerCase().trim())}},{key:"addWorkflowToDependencyMaps",value:function(t){var o,a,s,u,l,c,f;for(var d of(o=t.outputTypes)!==null&&o!==void 0?o:[]){var p=(a=this.workflowsByOutputAnnotation.get(d))!==null&&a!==void 0?a:new Set;p.add(t),this.workflowsByOutputAnnotation.set(d,p)}for(var g of(s=t.inputTypes)!==null&&s!==void 0?s:[]){var k=(u=this.workflowsByInputAnnotation.get(g))!==null&&u!==void 0?u:new Set;k.add(t),this.workflowsByInputAnnotation.set(g,k),this.workflowInputTypes.add(g)}for(var S of(l=t.triggerSignals)!==null&&l!==void 0?l:[])this.workflowInputTypes.add(S);t.collectionScopeType&&this.workflowInputTypes.add(t.collectionScopeType);for(var C of(c=t.requestedContextTypesRules)!==null&&c!==void 0?c:[])for(var x of C.contextTypes){var T=(f=this.workflowsByRequestedContextType.get(x))!==null&&f!==void 0?f:new Set;T.add(t),this.workflowsByRequestedContextType.set(x,T),this.workflowInputTypes.add(x)}}},{key:"getAllUpstreamInputTypesByAnnotationType",value:function(t){var o=this,a,s=new Set([t]);return(a=this.workflowsByOutputAnnotation.get(t))===null||a===void 0||a.forEach(function(u){var l,c,f,d=[].concat((0,It.default)(o.workflowExecutionManager.getAllUpstreamWorkflowIds(u.id)),[u.id]);for(var p of d)(f=(c=(l=o.workflowRegistrationsByName.get(p))===null||l===void 0?void 0:l.workflow)===null||c===void 0?void 0:c.inputTypes)===null||f===void 0||f.forEach(function(g){return s.add(g)})}),s}},{key:"activateWaitingWorkflows",value:function(t){var o=new Le({sessionHealthEventName:"ActivateWaitingWorkflows",resourceId:t,success:!1,source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,message:"",affectedWorkflows:["All"]}).start();try{if(this.workflowsWaitingForActivation.size>0){v.info(536959070,y.CoreDefault,`Checking activation conditions for ${this.workflowsWaitingForActivation.size} waiting workflows`);for(var a of this.workflowsWaitingForActivation)this.tryActivateWorkflow(a)}o.success=!0}finally{o.stop();var s=function(){return o};o.durationMs>tM.getValue()||!o.success?v.info(536959071,y.CoreDefault,s):v.debug(536959072,y.CoreDefault,s)}}},{key:"tryActivateWorkflow",value:function(t){var o,a=new Le({sessionHealthEventName:"TryActivateWorkflow",source:Ie.Core,reason:de.Core,impact:_e.MissingOutput,success:!0,message:'{"activated":true}',resourceId:t.workflow.resourceId,affectedWorkflows:[t.workflow.resourceId]},this.clientMetadata).start();try{var s=this.workflowMeetsActivationConditions(t.workflow),u=s.meetsConditions,l=s.waitingReasons,c=s.isEnabledAndActivatedByClient;if(!u){c?a.message=JSON.stringify({activated:!1,waitingReasons:l,requiredTokens:t.workflow.requiredTokenTypes}):a=void 0;return}v.info(536959073,y.CoreDefault,`Activating workflow ${t.workflow.id}`),t.invalidationFilter=Rw(this.clientMetadata,t.workflow.id);var f=[];for(var d of(o=t.workflow.requestedContextTypesRules)!==null&&o!==void 0?o:[])!d.activationConditions||!this.isWaitingForFlight(d.activationConditions)?f.push(d):v.info(536959074,y.CoreDefault,`Condition for contexts '${JSON.stringify(d.contextTypes)}' is not fulfilled.`);this.workflowDefinitionManager.mergeWorkflowDefinition(t.workflow,{requestedContextTypesRules:f}),this.tryActivateUpstreamWorkflows(t.workflow),t.workflow.inputStage&~zt.OnSeed&&this.activateWorkflowByType(t),this.tryScheduleWorkflowExecution(t),this.workflowsWaitingForActivation.delete(t)}catch(p){throw a&&(a.success=!1),p}finally{a&&v.info(536959075,y.CoreDefault,a.stop())}}},{key:"tryActivateUpstreamWorkflows",value:function(t){var o,a,s=this.workflowDefinitionManager.getWorkflowDefinition(t),u=s.requestedContextTypesRules,l=sr(u).map(function(g){var k=(0,ei.default)(g,2),S=k[0],C=k[1];return S}),c=((o=t.inputTypes)!==null&&o!==void 0?o:[]).concat(l);for(var f of c){this.outputAnnotationsRequiredByDownstreamWorkflows.add(f);for(var d of(a=this.workflowsByOutputAnnotation.get(f))!==null&&a!==void 0?a:[]){var p=this.workflowRegistrationsByName.get(d.id);this.workflowsWaitingForActivation.has(p)&&this.tryActivateWorkflow(p)}}}},{key:"tryScheduleWorkflowExecution",value:function(t){var o,a,s=!1;if(((o=t.triggerSignalOpsQueue)===null||o===void 0?void 0:o.length)>0||rn(t.workflow)){var u=t.workflow.kind!==V.SingleItem?this.cache.getSubtreeItems([],t.workflow.triggerSignals):void 0,l,c;if((u==null?void 0:u.length)>0?(v.info(536959104,y.CoreDefault,`Found trigger signal(s) in model for workflow: ${t.workflow.id}`),c=u.map(function(g){return g.body})):(c=[],((a=t.triggerSignalOpsQueue)===null||a===void 0?void 0:a.length)>0&&(v.info(536959105,y.CoreDefault,`Found ${t.triggerSignalOpsQueue.length} trigger signal(s) (first type: ${m.getTypeNameFor(t.triggerSignalOpsQueue[0].items[0].body)}) in cache for workflow: ${t.workflow.id}`),l=t.triggerSignalOpsQueue,c=l.map(function(g){return g.items[0].body}),t.triggerSignalOpsQueue=void 0)),t.workflow.kind===V.SingleItem){if((l==null?void 0:l.length)>0){var f=[];for(var d of l){var p=at(d.parentPath,d.items[0]);f.push({opType:m.getTypeNameFor(d),item:p})}f.length>0&&(t.invalidate(f),s=!0)}}else(c==null?void 0:c.length)>0&&(this.scheduleWorkflowExecution(t,c),s=!0)}!s&&t.workflow.inputStage&~zt.PostSeed&&(!rn(t.workflow)||this.isWorkflowTriggeredByNonExclusiveSignals(t.workflow))&&this.scheduleWorkflowExecution(t)}},{key:"scheduleWorkflowExecution",value:function(t,o){t.invalidate([{triggerSignals:o}])}},{key:"isWorkflowTriggeredByNonExclusiveSignals",value:function(t){return H("EnableNonExclusiveTriggerSignals")&&Na(t)}}])}(xS.EventEmitter);var kH=new G("prefiltersEvaluationMinDurationInMs",1),wH=new G("disabledPrefiltersForWorkflows",[]);var SH=Symbol("lambdaEvaluator"),CH=Symbol("isDisabled"),iM=function(){function n(r){(0,IS.default)(this,n),this.overwrittenSettingsMap=r}return(0,_S.default)(n,[{key:"getValue",value:function(e,t){var o;return this.settings.has(e)?o=this.settings.get(e):(o=new G(e,t),this.settings.set(e,o)),o.getValue()}},{key:"settings",get:function(){var e;return(e=this.overwrittenSettingsMap)!==null&&e!==void 0?e:n.settingsMap}}])}();iM.settingsMap=new Map;var Ln;(function(n){n[n.All=0]="All",n[n.WithActionDefinition=1]="WithActionDefinition",n[n.WithoutActionDefinition=2]="WithoutActionDefinition"})(Ln||(Ln={}));h();var BS=w(dt()),WS=w(P()),OS=w(R()),LS=w(Se());h();var DS=w(P()),PS=w(R());h();var bS=w(Se());h();function AS(n,r){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,t={firstDiffLeft:0,firstDiffRight:r.length},o,a;return n.length<r.length?(o=n,a=r):(o=r,a=n),a.indexOf(o)===0?(t.firstDiffLeft=o.length,t.firstDiffRight=0):a.endsWith(o)?(t.firstDiffLeft=0,t.firstDiffRight=o.length):(t=sM(n,r,e),t.firstDiffLeft+t.firstDiffRight>o.length&&(t.firstDiffRight=o.length-t.firstDiffLeft)),aM(t,n,r),t}function aM(n,r,e){if(n.firstDiffLeft>0){var t=n.firstDiffLeft<r.length&&lu(r,n.firstDiffLeft),o=n.firstDiffLeft<e.length&&lu(e,n.firstDiffLeft);(t||o)&&(n.firstDiffLeft-=1)}if(n.firstDiffRight>1){var a=n.firstDiffRight<r.length&&lu(r,r.length-n.firstDiffRight),s=n.firstDiffRight<e.length&&lu(e,e.length-n.firstDiffRight);(a||s)&&(n.firstDiffRight-=1)}}function sM(n,r){var e=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,t={firstDiffLeft:0,firstDiffRight:r.length},o;for(o=0;o<n.length&&o<r.length;o+=1){var a=n.charCodeAt(o),s=r.charCodeAt(o);if(a!==s&&!(uu(a,e)&&uu(s,e)))break}for(t.firstDiffLeft=o,o=0;o<n.length&&o<r.length;o+=1){var u=n.charCodeAt(n.length-o-1),l=r.charCodeAt(r.length-o-1);if(u!==l&&!(uu(u,e)&&uu(l,e)))break}return t.firstDiffRight=o,t}function uu(n){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;switch(n){case 12288:case 8197:case 32:case 11:case 9:case 160:return!0;case 13:case 10:case 65532:return!r}return!1}function lu(n,r){return n.charCodeAt(r)>=56320&&n.charCodeAt(r)<=57343}var cu=w(zi()),ni=/[ \u00a0\u2000-\u200a\u202f\u205f\u3000\t]/g,La=/[.!?]/g;function MS(n,r){var e=[],t=NS(n,r);return t&&e.push(t),e}function ES(n,r){var e=[],t=NS(n,r);t&&e.push(t);var o=uM(n,r,t);o&&e.push(o);var a=lM(n,r,t);a&&e.push(a);var s=cM(n,r);return s&&e.push(s),e}function NS(n,r){var e=n.content,t=r.content,o=AS(e,t),a=o.firstDiffLeft,s=e.length-o.firstDiffRight,u=t.length-o.firstDiffRight,l=me.Update,c=void 0;if(e.length!==t.length)s===a?(l=me.Add,c=e[e.length-1]):u===a&&(l=me.Delete,c=t[t.length-1]);else if(e===t)return;var f=0,d;switch(l){case me.Update:f=s-a,d=t.substring(a,u);break;case me.Add:d=t.substring(a,u);break;case me.Delete:f=s-a,d=e.substring(a,s);break}var p=dM(d,c);if(p!==void 0)return new gn({content:l!==me.Delete?d:void 0,deltaType:l,unit:p,position:a,length:l!==me.Add?f:0})}function uM(n,r,e){var t,o,a,s,u,l,c=n,f=r;if(!((c==null?void 0:c.ipPosition)===(f==null?void 0:f.ipPosition)&&(c==null?void 0:c.isColdIp)===(f==null?void 0:f.isColdIp))){if((c==null?void 0:c.isColdIp)===(f==null?void 0:f.isColdIp)&&e){if(e.deltaType===me.Add){if((f==null?void 0:f.ipPosition)===((t=e.position)!==null&&t!==void 0?t:0)+((o=e.length)!==null&&o!==void 0?o:0))return}else if(e.deltaType===me.Update){if((f==null?void 0:f.ipPosition)===((a=e.position)!==null&&a!==void 0?a:0)+((u=(s=e.content)===null||s===void 0?void 0:s.length)!==null&&u!==void 0?u:0))return}else if(e.deltaType===me.Delete&&(f==null?void 0:f.ipPosition)===((l=e.position)!==null&&l!==void 0?l:0))return}return new gn({deltaType:me.CursorUpdate,cursorData:{ipPosition:f==null?void 0:f.ipPosition,isColdIp:f==null?void 0:f.isColdIp}})}}function lM(n,r,e){var t,o,a,s,u,l,c,f=n,d=r;if(((t=d.formattedRanges)===null||t===void 0?void 0:t.length)<=((o=f.formattedRanges)===null||o===void 0?void 0:o.length)){if(e){var p=f.formattedRanges?(0,bS.default)(f.formattedRanges):[],g=fM(f.formattedRanges,e,e.position),k=g?p.indexOf(g):-1;if(k!==-1&&(e.position+(e.length||0)>g.start+g.length?g.length=e.position+((a=e.content)!==null&&a!==void 0?a:"").length-g.start:g.length+=((s=e.content)!==null&&s!==void 0?s:"").length-(e.length||0),p[k]=g),p.length>0){for(var S of p.slice(k+1))S.start<e.position||(e.position+(e.length||0)>S.start?(S.length=S.start+S.length-(e.position+(e.length||0)),S.start=e.position+((u=e.content)!==null&&u!==void 0?u:"").length):S.start+=((l=e.content)!==null&&l!==void 0?l:"").length-(e.length||0));p=p.filter(function(x){return x.length>0})}var C=(c=d==null?void 0:d.formattedRanges)!==null&&c!==void 0?c:[];if((0,cu.default)(p,C)||p.length===0&&C.length===0)return}else if((0,cu.default)(f==null?void 0:f.formattedRanges,d==null?void 0:d.formattedRanges))return}return new gn({deltaType:me.FormattingUpdate,formattedRanges:d==null?void 0:d.formattedRanges})}function cM(n,r){var e=n,t=r,o,a={},s=!1;for(o in t)["ipPosition","isColdIp","content","formattedRanges"].indexOf(o)===-1&&((0,cu.default)(t[o],e[o])||(s=!0,a[o]=t[o]));if(s)return new gn({deltaType:me.OtherNonContentUpdate,otherNonContentData:a})}function fM(n,r,e){if(n){if(r.deltaType===me.Add){var t=n.find(function(a){return a.start===e&&a.length===0});if(t)return t;e=Math.max(e-1,0)}var o=n.find(function(a){return a.length===0?a.start===e:a.start<=e&&e<a.start+a.length});return o}}function dM(n,r){var e=Array.from(n.matchAll(ni));if(ni.lastIndex=0,e.length===0)return Ke.Chars;if(e.length===1){if(e[0].index===0)return r&&La.test(r)?Ke.Sentence:r&&!ni.test(r)?Ke.Word:Ke.Chars;if(e[0].index+1===n.length)return La.test(n[e[0].index-1])?Ke.Sentence:ni.test(n[e[0].index-1])?Ke.Chars:Ke.Word;if(n[e[0].index-1]){var t=n[e[0].index-1];if(La.test(t))return Ke.Sentence;if(ni.test(t))return Ke.Chars}return Ke.Word}var o=Array.from(n.matchAll(La));if(La.lastIndex=0,o.length===0)return Ke.PartialSentence;if(o.length>1)return Ke.Paragraph;if(o[0].index+1<=n.length)return ni.test(n[o[0].index+1])?Ke.Sentence:Ke.Paragraph}var RS=function(){function n(){(0,DS.default)(this,n),this.deltaBuilderHandlers=new Map,this.registerDeltaBuilderHandler(nt.getTypeName(),MS),this.registerDeltaBuilderHandler(gt.getTypeName(),ES)}return(0,PS.default)(n,[{key:"registerDeltaBuilderHandler",value:function(e,t){this.deltaBuilderHandlers.set(e,t)}},{key:"executeDeltaBuilderHandler",value:function(e,t,o){var a=this.deltaBuilderHandlers.get(e);return a?a(t,o):[]}}])}();var Od="\\",Wd=function(r,e){return e?Ld([].concat((0,LS.default)(e),[r])):r},Ld=function(r){return r.join(Od)},FS=function(){function n(r){var e=this;(0,WS.default)(this,n),this.createTextTileDeltasFromItem=function(t,o){var a,s=new E({operationName:"CreateTextTileDeltaFromItem",success:!0}).start();try{if(!t){s.success=!1,s.resultDescription="Unable to create text tile delta, parent item is undefined",v.info(524883085,y.CoreDefault,s.stop());return}if(!t.body){s.success=!1,s.resultDescription="Unable to create text tile delta, parent item has undefined body",v.info(524883086,y.CoreDefault,s.stop());return}var u=t.body;if(!nt.typeGuard(u)){s.success=!1,s.resultDescription=`Unable to create text tile delta, parent item body is not proper type: expected ${nt.getTypeName()}, received ${m.getTypeNameFor(u)}`;return}var l=Wd(t.id,o),c=(a=e.lastSeenTileByTileId.get(l))!==null&&a!==void 0?a:new nt({content:""}),f=e.createDeltas(c,u);return!f||f.length===0?(s.dimension0="0",s.resultDescription="No delta differences found"):(s.dimension0=f.length.toString(),e.lastSeenTileByTileId.set(l,u)),v.info(524883087,y.CoreDefault,s.stop()),f}catch(d){s.success=!1,s.resultDescription=`Error creating text tile delta: ${d}`,v.info(524883088,y.CoreDefault,s.stop());return}},this.lastSeenTileByTileId=r!=null?r:new Map,this.deltaBuilder=new RS}return(0,OS.default)(n,[{key:"addItemToLocalMap",value:function(e,t){var o=Wd(e.id,t),a=e.body;nt.typeGuard(a)&&!this.lastSeenTileByTileId.has(o)&&this.lastSeenTileByTileId.set(o,a)}},{key:"deleteItemFromLocalMap",value:function(e,t){var o=Wd(e.id,t);this.lastSeenTileByTileId.has(o)&&this.lastSeenTileByTileId.delete(o)}},{key:"moveItemsInLocalMap",value:function(e,t,o){var a=new Set(o),s=Ld(t),u=Ld(e),l=[],c=function(T,I){return T.length>I.length?T.substring(I.length+Od.length).split(Od)[0]:void 0};for(var f of this.lastSeenTileByTileId){var d=(0,BS.default)(f,2),p=d[0],g=d[1];if(p.startsWith(s)){var k=c(p,s);if(k===void 0||a.has(k)){var S=p.replace(s,u);l.push({item:g,newPathKey:S,prevPathKey:p})}}}for(var C of l)this.lastSeenTileByTileId.delete(C.prevPathKey),this.lastSeenTileByTileId.set(C.newPathKey,C.item)}},{key:"createDeltas",value:function(e,t){return this.deltaBuilder.executeDeltaBuilderHandler(m.getTypeNameFor(t),e,t)}}])}();h();var qS=w(ys());var pM=function(n,r,e,t){function o(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(f){try{c(t.next(f))}catch(d){s(d)}}function l(f){try{c(t.throw(f))}catch(d){s(d)}}function c(f){f.done?a(f.value):o(f.value).then(u,l)}c((t=t.apply(n,r||[])).next())})};function Fd(n,r){return pM(this,void 0,void 0,function*(){var e=n.authToken,t=n.origin,o=n.sessionUrl,a=r.body,s=r.cv,u=r.method,l=r.requestUrl,c=yield(0,qS.fetch)(l||o,{method:u,headers:Object.assign({Authorization:`Bearer ${e}`,"x-origin":t,"x-correlationid":s},r.headers),body:a});if(c.status!==200)throw new Error(`Unexpected status code: ${c.status}`);return c})}var qd=function(r,e){e?(r.resultDescription=e,r.success=!1,v.error(507646878,y.CoreDefault,r.stop())):v.info(507646877,y.CoreDefault,r.stop())};function $d(n,r,e,t){var o;Fd(n,{headers:{"Content-Type":"application/jsond"},body:fn.serialize(r),cv:e.cv,method:"POST"}).then(function(a){return a.json()}).catch(function(a){o=new X({messageId:r.messageId,error:a.message})}).then(function(a){qd(e,o?o.error:void 0),t(o,a)})}function Gd(n,r,e,t){var o;Fd(n,{headers:{"Content-Type":"application/octet-stream"},body:r,cv:e.cv,method:"POST",requestUrl:`${n.sessionUrl}/blob`}).then(function(a){return a.json()}).catch(function(a){o=new X({error:a.message})}).then(function(a){qd(e,o?o.error:void 0),t(o,a)})}function Ud(n,r,e,t){var o=n.sessionUrl,a;Fd(n,{cv:t.cv,method:"GET",requestUrl:r.refType===To.AlCodedLocation?`${o}/blob/${r.value}`:r.value}).then(function(s){return s.arrayBuffer()}).then(function(s){return new Uint8Array(s)}).catch(function(s){a=s}).then(function(s){qd(t,a?a.message:void 0),e(a,s)})}h();var $S=w(P()),GS=w(R()),US=w(Qe()),Hd=w($e()),HS=w(je());var VS=w(Pn());function gM(n,r,e){return r=(0,Hd.default)(r),(0,US.default)(n,zS()?Reflect.construct(r,e||[],(0,Hd.default)(n).constructor):r.apply(n,e))}function zS(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(zS=function(){return!!n})()}var Dr=function(n){function r(){return(0,$S.default)(this,r),gM(this,r,arguments)}return(0,HS.default)(r,n),(0,GS.default)(r,[{key:"init",value:function(){return Promise.resolve()}},{key:"sendMessage",value:function(t,o,a){}},{key:"onMessage",value:function(t,o){}},{key:"forceReconnect",value:function(){return Promise.resolve()}},{key:"closeSession",value:function(){}},{key:"sendBytes",value:function(t){}},{key:"getCorrelationVector",value:function(){return new Je}},{key:"getNetworkWorkerManager",value:function(){}},{key:"setState",value:function(t){}}])}(VS.EventEmitter);var hM=function(n,r,e,t){function o(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(f){try{c(t.next(f))}catch(d){s(d)}}function l(f){try{c(t.throw(f))}catch(d){s(d)}}function c(f){f.done?a(f.value):o(f.value).then(u,l)}c((t=t.apply(n,r||[])).next())})},ri=function(n){return this instanceof ri?(this.v=n,this):new ri(n)},mM=function(n,r,e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e.apply(n,r||[]),o,a=[];return o={},s("next"),s("throw"),s("return"),o[Symbol.asyncIterator]=function(){return this},o;function s(p){t[p]&&(o[p]=function(g){return new Promise(function(k,S){a.push([p,g,k,S])>1||u(p,g)})})}function u(p,g){try{l(t[p](g))}catch(k){d(a[0][3],k)}}function l(p){p.value instanceof ri?Promise.resolve(p.value.v).then(c,f):d(a[0][2],p)}function c(p){u("next",p)}function f(p){u("throw",p)}function d(p,g){p(g),a.shift(),a.length&&u(a[0][0],a[0][1])}},vM=10,yM=function(r){if(r===st.Substrate)return $r.Substrate},Jt;(function(n){n[n.LocalWorkflow=0]="LocalWorkflow",n[n.ServerWorkflow=1]="ServerWorkflow",n[n.Submitted=2]="Submitted"})(Jt||(Jt={}));var Rr;(function(n){n[n.Internal=0]="Internal",n[n.External=1]="External"})(Rr||(Rr={}));var qt=function(r,e){e?(r.resultDescription=e,r.success=!1,v.error(509203144,y.CoreDefault,r.stop())):v.info(509203143,y.CoreDefault,r.stop())},QS=function(r){return!r.items.some(function(e){return e.source&&e.source.indexOf("ThirdParty")===0})};var oi=function(){function n(r){(0,JS.default)(this,n);var e;this.annotationActivationTrackers=new Map,this.annotationCallbacks=new Map,this.apologyCallbacks=new Map,this.annotationResultStates=new Map,this.tokensByAnnotationType=new Map,this.registeredContextTypes=new Set,this.availableContexts=new Map,this.nextSyncSequenceId=1,this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.hasSessionConnected=!1,this.isSessionClosed=!1,this.serverAuthenticationState=Ze.NotAuthenticated,this.sessionCloseCallbacks=new Map,this.connectCallbacks=new Map,this.reconnectCallbacks=new Map,this.disconnectCallbacks=new Map,this.sessionStateCallbackToken=0,this.workflowGraph=new ru,this.workflowDefinitionManager=new Ks,this.contextIdManager=new Ft(Qo.JsClient,this.workflowGraph),this.workflowItemStorage=new nu(this.workflowDefinitionManager),this.pendingConnectCallbacks=[],this.onAnnotationsSubmittedEnabled=!1,this.reduceBatchOperationsEnabled=!1,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=!1,this.batchMessagesEnabled=!1,this.cachedClaimsChallenge={claimsVersion:0,actionRequired:!1},this.tokenMessageVersion=1,this.hostCallbacks=r.hostCallbacks,this.sessionManager=r.sessionManager,this.batchMessagesEnabled=r.batchMessagesEnabled||!1,this.reduceBatchOperationsEnabled=r.reduceBatchOperationsEnabled||!1,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=r.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||!1,this.operationBatchConfig=r.batchOptions?this.getOperationBatchConfig(r.batchOptions):void 0,this.extensionConfigs=r.extensionConfigs,this.clientMetadata=r.clientMetadata,this.userContext=r.userContext,this.localWorkflowManager=r.localWorkflowManager,this.annotationResultsProcessor=r.annotationResultsProcessor,r.workflowRuntimeFactory&&(this.workflowRuntime=r.workflowRuntimeFactory(this.sessionManager)),this.localRegisteredWorkflows=r.localRegisteredWorkflows||[],this.enableRemoteExecutionNotification=r.enableRemoteExecutionNotification||!1,this.networkMode=r.networkMode,this.egress=r.egress,this.serverAuthenticationStateChangeCallback=[],this.claimsChallengeCallback=[],this.onAnnotationsSubmittedEnabled=r.onAnnotationsSubmittedEnabled||!1,this.annotationDoesNotExistOnServiceEnabled=r.annotationDoesNotExistOnServiceEnabled||!1,this.sessionManager.on("sessionClose",this.onSessionClose.bind(this)),this.sessionManager.on("reconnect",this.onReconnect.bind(this)),this.sessionManager.on("connect",this.onConnect.bind(this)),this.sessionManager.on("disconnect",this.onDisconnect.bind(this)),this.sessionManager.on("resetNextSyncSequenceId",this.resetNextSyncSequenceId.bind(this)),this.sessionManager.on("serverAuthenticationStateChange",this.onServerAuthenticationStateChange.bind(this)),this.sessionManager.onMessage(Ct.getTypeName(),this.workflowRuntime?this.onAnnotationResultsFromLocal.bind(this):this.onAnnotationResultsFromServer.bind(this)),this.sessionManager.onMessage(Jr.getTypeName(),this.onAnnotationResultStateMessage.bind(this)),this.sessionManager.onMessage(eo.getTypeName(),this.onWorkflowExecutionCompleteMessage.bind(this)),this.sessionManager.onMessage(ra.getTypeName(),this.onClaimsChallengeMessage.bind(this)),r.isDeltaGeneratorEnabled&&(this.enableSyncDeltaSending=!r.disableSyncDeltaSending,this.syncDeltaTimeout=(e=r.syncDeltaTimeout)!==null&&e!==void 0?e:700,this.enableDeltaGenerator()),this.setServerAuthenticationStateChangeCallback(this.updateGraphOnAuthStateChange.bind(this)),this.setClaimsChallengeCallback(this.requestAuthTokenWithClaims.bind(this))}return(0,KS.default)(n,[{key:"getSessionReconnectParams",value:function(){if(!this.connectParams)throw new Error("Session has not been established yet.");return{sessionUrl:this.connectParams.sessionUrl,origin:this.connectParams.origin,authToken:this.connectParams.authToken,nextSyncSequenceId:this.nextSyncSequenceId}}},{key:"setNextSequenceId",value:function(e){this.nextSyncSequenceId=e}},{key:"tryGetDocSessionId",value:function(){if(!(!this.clientMetadata||!this.clientMetadata.docSessionId))return this.clientMetadata.docSessionId}},{key:"getSessionStateCallbackToken",value:function(e){var t;return e+"-callback-"+((t=this.tryGetDocSessionId())!==null&&t!==void 0?t:"unknown")+"-"+this.sessionStateCallbackToken++}},{key:"updateGraphOnAuthStateChange",value:function(e){this.tryActivateWorkflows()}},{key:"tryActivateWorkflows",value:function(){var e=this;if(this.enableRemoteExecutionNotification){var t=new E({operationName:"GraphServerWorkflowActivation",success:!0}).setClientMetadata(this.clientMetadata).start(),o=[];this.workflowGraph.getWorkflowNodes().filter(function(a){return a.location===pr.External}).forEach(function(a){e.localWorkflowManager.canActivateWorkflow(a,e)?a.isActivated=!0:(e.localWorkflowManager.deactivateServerWorkflow(a,e),o.push(a.workflow.id))}),t.resultDescription=`deactivated workflows: [${o.join()}]`,v.info(508879493,y.CoreDefault,t.stop())}}},{key:"initialize",value:function(){var e=this;return this.localWorkflowManager&&this.localWorkflowManager.addSession(this),this.registerLocalWorkflowsWithoutGraphInit(this.localRegisteredWorkflows),this.sessionManager.init(this.extensionConfigs,this.hostCallbacks.onInitSession?this.hostCallbacks.onInitSession:void 0,this.egress).then(function(){return e.localWorkflowManager&&e.localWorkflowManager.setTokenCallback(e.getAuthToken.bind(e)),e})}},{key:"isLocalWorkflowRegistered",value:function(e){var t=this.getLocalRegisteredWorkflows();return t.some(function(o){return e===o.id})}},{key:"isConnected",get:function(){return!!this.connectParams}},{key:"hasConnected",get:function(){return this.hasSessionConnected}},{key:"isClosed",get:function(){return this.isSessionClosed}},{key:"getServerAuthenticationState",value:function(){return this.serverAuthenticationState}},{key:"getContextIdManager",value:function(){return this.contextIdManager}},{key:"getWorkflowItemStorage",value:function(){return this.workflowItemStorage}},{key:"getWorkflowDefinition",value:function(e,t){return this.workflowDefinitionManager.getWorkflowDefinition(e,t)}},{key:"registerLocalWorkflows",value:function(e){this.registerLocalWorkflowsWithoutGraphInit(e),this.trySendWorkflowGraphInitMessage()}},{key:"registerLocalWorkflowsWithoutGraphInit",value:function(e){if(e.length){if(this.workflowRuntime)for(var t of e)this.workflowRuntime.registerWorkflow(t),this.sendMessageToSession(new no({workflowDefinition:t}));if(this.localWorkflowManager)for(var o of e)this.localWorkflowManager.registerLocalWorkflow(o,this)}}},{key:"registerLocalWorkflow",value:function(e){this.registerLocalWorkflows([e]);var t=new E({operationName:"SessionRegisterLocalWorkflow",resourceId:e.id,success:!0}).setClientMetadata(this.clientMetadata).start();qt(t)}},{key:"activateAnnotation",value:function(e,t,o){var a,s=new Tc(this.sendMessageToSession.bind(this),e,t,this.annotationDoesNotExistOnServiceEnabled),u=function(f,d){var p=f.get(e);p||(p=new Map,f.set(e,p)),p.set(s.token,d)};t!=null&&t.callback&&u(this.annotationCallbacks,t==null?void 0:t.callback),t!=null&&t.apologyCallback&&u(this.apologyCallbacks,t==null?void 0:t.apologyCallback);var l=(a=this.tokensByAnnotationType.get(e))!==null&&a!==void 0?a:[];return l.indexOf(s.token)===-1&&l.push(s.token),this.tokensByAnnotationType.set(e,l),this.annotationActivationTrackers.set(s.token,s),this.activateAnnotationForTracker(s,{ignoreExistingAnnotations:!1,sendOnlyIfConnected:!1,sendApologies:(t==null?void 0:t.apologyCallback)!==void 0})}},{key:"activateAnnotationForTracker",value:function(e,t){var o=new E({operationName:"ActivateAnnotation",resourceId:e.annotationType,success:!0}).setClientMetadata(this.clientMetadata).start();return e.activate(t.ignoreExistingAnnotations,t.sendOnlyIfConnected,t.sendApologies).then(function(a){return o.resultSignature="Ok",o.resultDescription=`Activated annotation ${e.annotationType} with token ${e.token}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`,qt(o),a}).catch(function(a){throw qt(o,`error on activate annotation type ${e.annotationType}: ${a}; sendOnlyIfConnected: ${t.sendOnlyIfConnected}`),a})}},{key:"updateAnnotationConfig",value:function(e,t){var o=new Xr({token:e,config:t});this.sendMessageToSession(o);var a=this.annotationActivationTrackers.get(e);a&&a.options&&(a.options.config=t)}},{key:"releaseAnnotation",value:function(e){var t=this.annotationActivationTrackers.get(e);if(t){this.annotationActivationTrackers.delete(e);var o=function(s){var u=s.get(t.annotationType);u&&(u.delete(e),u.size==0&&s.delete(t.annotationType))};return o(this.annotationCallbacks),o(this.apologyCallbacks),t.release()}return Promise.resolve(!1)}},{key:"setAnnotationState",value:function(e,t,o){var a={state:o};this.submitOperation(new mt({parentPath:e,items:[{id:t}],M_:a}))}},{key:"setAnnotationMetadata",value:function(e,t,o){this.submitOperation(new mt({parentPath:e,items:[{id:t}],M_:o}))}},{key:"submitOperation",value:function(e,t){this.submitOperations([e],t)}},{key:"submitOperations",value:function(e,t){var o,a;if(t||(t=this.generateCorrelationId()),this.contextIdManager.applyContextIdOnOperations(e),this.updateWorkflowExecutionStates(e),!this.onAnnotationsSubmittedEnabled){var s=this.partitionAnnotationOperations(e),u=(0,Pr.default)(s,2),l=u[0],c=u[1];this.executeCallbacksOnAnnotationSubmitted(l,t)}var f=e.filter(this.filterOperationsForSession.bind(this)).filter(QS);if(this.workflowRuntime){if(this.onAnnotationsSubmittedEnabled){var d=this.partitionAnnotationOperations(f),p=(0,Pr.default)(d,2),g=p[0],k=p[1];this.onAnnotationsSubmitted(g,t),this.submitOperationsToSession(k,t)}else this.submitOperationsToSession(f,t);return}var S=[];if(this.deltaGenerator){var C=new E({operationName:"ExecuteDeltaGenerator",success:!0}).setClientMetadata(this.clientMetadata).start();for(var x of f)if(Oe.typeGuard(x))S.push.apply(S,(0,wo.default)(this.createDeltasFromUpdateOperation(x)));else{var T=x;for(var I of T.items)we.typeGuard(x)?this.deltaGenerator.addItemToLocalMap(I,T.parentPath):He.typeGuard(x)?this.deltaGenerator.deleteItemFromLocalMap(I,T.parentPath):mn.typeGuard(x)&&this.deltaGenerator.moveItemsInLocalMap(x.parentPath,x.prevParentPath,(a=(o=x.items)===null||o===void 0?void 0:o.map(function(N){return N.id}))!==null&&a!==void 0?a:[]);S.push(x)}qt(C)}if(this.onAnnotationsSubmittedEnabled){var _=this.partitionAnnotationOperations(S.length?S:f),M=(0,Pr.default)(_,2),b=M[0],A=M[1];this.onAnnotationsSubmitted(b,t),this.submitOperationsToSession(A,t)}else this.submitOperationsToSession(S.length?S:f,t);this.localWorkflowManager&&this.localWorkflowManager.runLocalWorkflows(e,this,!0)}},{key:"submitSeedOperations",value:function(e,t){if(!this.allowSeed)throw new Error("Cannot submit seed operations more than once per session");if(this.networkMode===Ce.LocalWorkflowsOnly&&this.localWorkflowManager){this.localWorkflowManager.runLocalWorkflows(e,this);return}t||(t=this.generateCorrelationId()),this.allowSeed=!1,this.allowGroupSeed=!1;var o=this.partitionAnnotationOperations(e),a=(0,Pr.default)(o,2),s=a[0],u=a[1];this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(s,t):this.executeCallbacksOnAnnotationSubmitted(s,t),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?u:e,!0,t):this.sendMessageToSession(new Be({cv:t,seq:0,ops:this.onAnnotationsSubmittedEnabled?u:e}))}},{key:"submitSeedGroupOperations",value:function(e,t,o){if(!this.allowGroupSeed)throw new Error("Seed operations are not allowed for this session");if(this.networkMode===Ce.LocalWorkflowsOnly&&this.localWorkflowManager){this.localWorkflowManager.runLocalWorkflows(e,this);return}o||(o=this.generateCorrelationId()),t&&(this.allowGroupSeed=!1),this.allowSeed=!1;var a=this.partitionAnnotationOperations(e),s=(0,Pr.default)(a,2),u=s[0],l=s[1];this.executeCallbacksOnAnnotationSubmitted(u,o),this.onAnnotationsSubmittedEnabled?this.onAnnotationsSubmitted(u,o):this.executeCallbacksOnAnnotationSubmitted(u,o),this.operationBatchConfig?this.sendSeedMessagesViaBatchManager(this.onAnnotationsSubmittedEnabled?l:e,!!t,o):(this.seedGroupSize++,this.sendMessageToSession(new Be({cv:o,seq:0,ops:this.onAnnotationsSubmittedEnabled?l:e,groupId:"Seed",groupSize:t?this.seedGroupSize:void 0,groupComplete:t||void 0})))}},{key:"submitCustomMessage",value:function(e){var t=this;return new Promise(function(o,a){t.sendMessageToSession(e,function(s,u){s?a(new Error(`${s.error}; for message type: ${m.getTypeNameFor(e)}`)):o(u)})})}},{key:"submitLargeBinaryDataMessage",value:function(e){var t=this;return new Promise(function(o,a){t.sendMessageToSessionPostEndpoint(e,function(s,u){s?a(new Error(s.error)):o(u)})})}},{key:"submitBinaryStreamUploadMessage",value:function(e){var t=this;return new Promise(function(o,a){var s=new E({operationName:"sendBinaryStreamUploadMessage",success:!0}).setClientMetadata(t.clientMetadata).start();if(t.connectParams)Gd(t.connectParams,e,s,function(l,c){l?a(new Error(l.error)):o(c)});else{var u=function(l){return Gd(l,e,s,function(c,f){c?a(new Error(c.error)):o(f)})}.bind(t);t.pendingConnectCallbacks.push(u)}})}},{key:"requestBinaryDataForBlob",value:function(e){var t=this;return e.data?Promise.resolve(e.data):!e.dataPointer||e.dataPointer.refType===To.None?Promise.reject(new Error("Blob does not have a data pointer")):new Promise(function(o,a){t.requestBinaryDataFromSessionBlobEndpoint(e.dataPointer,function(s,u){s?a(s):o(u)})})}},{key:"requestCacheDump",value:function(e){if(e)throw new Error("NYI");return this.submitCustomMessage(new Yi)}},{key:"forceReconnect",value:function(e){return this.extensionConfigs=e,this.sessionManager.forceReconnect(e)}},{key:"close",value:function(e){this.isSessionClosed=!0,this.sessionManager.closeSession(e),this.workflowRuntime&&this.workflowRuntime.close(),this.localWorkflowManager&&this.localWorkflowManager.closeSession(this),this.graphInitMessageTimer&&(clearTimeout(this.graphInitMessageTimer),this.graphInitMessageTimer=void 0)}},{key:"authenticateInteractive",value:function(){return hM(this,void 0,void 0,function*(){if(!(this.cachedClaimsChallenge.claimsVersion>0&&!this.cachedClaimsChallenge.actionRequired)){var e=yield this.requestAuthTokenInteractive(this.cachedClaimsChallenge,{interactive:!0});if(Fo.typeGuard(e))throw new Error(e.reason)}})}},{key:"getClientMetadata",value:function(){return this.clientMetadata}},{key:"getUserContext",value:function(){return this.userContext}},{key:"setSessionCloseCallback",value:function(e){var t=this.getSessionStateCallbackToken("close");return e&&this.sessionCloseCallbacks.set(t,e),t}},{key:"setConnectCallback",value:function(e){var t=this.getSessionStateCallbackToken("connect");return e&&this.connectCallbacks.set(t,e),t}},{key:"setDisconnectCallback",value:function(e){var t=this.getSessionStateCallbackToken("disconnect");return e&&this.disconnectCallbacks.set(t,e),t}},{key:"setReconnectCallback",value:function(e){var t=this.getSessionStateCallbackToken("reconnect");return e&&this.reconnectCallbacks.set(t,e),t}},{key:"removeSessionStateCallback",value:function(e){function t(o){return o.has(e)?(o.delete(e),!0):!1}return t(this.sessionCloseCallbacks)||t(this.reconnectCallbacks)||t(this.disconnectCallbacks)||t(this.connectCallbacks)}},{key:"setServerAuthenticationStateChangeCallback",value:function(e){this.serverAuthenticationStateChangeCallback.push(e),e(this.serverAuthenticationState)}},{key:"setClaimsChallengeCallback",value:function(e){this.cachedClaimsChallenge.actionRequired&&e(this.cachedClaimsChallenge),this.claimsChallengeCallback.push(e)}},{key:"getConnectParams",value:function(){return this.connectParams}},{key:"setOfflineMode",value:function(){this.sessionManager=new Dr}},{key:"onAnnotationResults",value:function(e,t,o){var a=this;v.info(508916486,y.CoreDefault,new E({operationName:"OnAnnotationResultsEgress",dimension0:e==null?void 0:e.annotationType,success:!0,cv:e.cv})),o(void 0,new Ge),t===Jt.LocalWorkflow&&this.contextIdManager.applyContextIdOnOperations(e.ops),this.updateWorkflowExecutionStates(e.ops),this.egress&&this.egress(e,function(){}),this.annotationResultsProcessor.process(e,function(s,u){a.applyOperationForContext(s,u,t)},function(s,u){a.triggerRegisteredAnnotationCallbacks(s,e.annotationType,u,e.areApologies)},function(s){if(t!==Jt.ServerWorkflow){var u=s.ops.filter(a.filterOperationsForSession.bind(a)).filter(QS);a.submitOperationsToSession(u,s.cv)}a.localWorkflowManager&&a.localWorkflowManager.runLocalWorkflows(s.ops,a)})}},{key:"onAnnotationResultStateMessage",value:function(e,t){var o;t(void 0,new Ge);for(var a of e.updates){var s=a.annotationType,u=a.state;if(this.tokensByAnnotationType.has(s)){var l=void 0;this.annotationResultStates.has(s)?l=this.annotationResultStates.get(s):u===sn.Idle?l=sn.Pending:l=sn.Idle;for(var c of this.tokensByAnnotationType.get(s)){var f=this.annotationActivationTrackers.get(c);!((o=f.options)===null||o===void 0)&&o.stateUpdateCallback&&f.options.stateUpdateCallback(l,u)}}}}},{key:"submitOperationsToSession",value:function(e,t){var o=this;t||(t=this.generateCorrelationId());var a=e.filter(function(l){return it.typeGuard(l)}),s=e.filter(function(l){return!it.typeGuard(l)});if(a.length>0&&this.sendMessageToSession(new Be({cv:t,ops:a})),s.length>0)if(this.operationBatchConfig){if(!this.batchedOperationsManager){var u=void 0;this.batchMessagesEnabled?u=function(c,f,d){if(c.length){var p=new wn;p.messages=[],c.forEach(function(g){p.messages.push(new Be({cv:g.cv,seq:o.nextSyncSequenceId++,ops:g.input}))}),o.sendMessageToSession(p,function(g){d(g?new Error(g.error):void 0)})}}:u=function(c,f,d){o.sendMessageToSession(new Be({cv:f.cv,seq:o.nextSyncSequenceId++,ops:c}),function(p){d(p?new Error(p.error):void 0)})},this.batchedOperationsManager=new Po(u,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.batchedOperationsManager.addBatchItem(s,this.operationBatchConfig,{name:"SubmitOperations"},t)}else this.sendMessageToSession(new Be({cv:t,seq:this.nextSyncSequenceId++,ops:s}))}},{key:"sendMessageToSession",value:function(e,t){this.sessionManager.sendMessage(e,t),Ve.typeGuard(e)&&this.close()}},{key:"sendMessageToSessionPostEndpoint",value:function(e,t){var o=new E({operationName:"SendLargeBinaryDataMessage",success:!0,cv:e.cv}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)$d(this.connectParams,e,o,t);else{var a=function(s){return $d(s,e,o,t)}.bind(this);this.pendingConnectCallbacks.push(a)}}},{key:"requestBinaryDataFromSessionBlobEndpoint",value:function(e,t){var o=new E({operationName:"RequestBinaryData",success:!0,cv:new Je().toString()}).setClientMetadata(this.clientMetadata).start();if(this.connectParams)Ud(this.connectParams,e,t,o);else{var a=function(s){return Ud(s,e,t,o)}.bind(this);this.pendingConnectCallbacks.push(a)}}},{key:"registerContextTypes",value:function(e){for(var t of e)this.activateAnnotation(t),this.registeredContextTypes.add(t)}},{key:"applyOperationForContext",value:function(e,t,o){var a=this,s=m.getTypeNameFor(e);if(!(s!=we.getTypeName()&&s!=wr.getTypeName()&&s!=Oe.getTypeName()&&s!=He.getTypeName())){s==wr.getTypeName()&&(s=we.getTypeName());var u=at(this.resolvePlaceholdersInOperationParentPath(e.parentPath),t),l=z(u.parentPath);if(s==we.getTypeName()||s==Oe.getTypeName()){if(!u.body)return;var c=m.getTypeNameFor(u.body);if(!this.registeredContextTypes.has(c))return;var f=this.availableContexts.get(c);f||(f=new Map,this.availableContexts.set(c,f));var d=f.get(o);if(d||(d=[],f.set(o,d)),!u.id){if(this.workflowRuntime)throw new Error("Expected item to have id already");this.localWorkflowManager&&(u.id=this.localWorkflowManager.getNextClientAnnotationId())}if(s==we.getTypeName())d.filter(function(g){return z(g.parentPath)==l&&g.id==u.id}).length==0?d.push(u):v.info(540848911,y.CoreDefault,`AddOperation for (${o}, ${u.id}, ${u.source}) can't be applied as the context item with matching path and ID already exists. Use UpdateOperation instead.`);else for(var p=0;p<d.length;p++)if(d[p].id==u.id&&z(d[p].parentPath)==l)if(d[p].source==u.source){d[p]=u;break}else v.warn(540848912,y.CoreDefault,`UpdateOperation for (${o}, ${u.id}, ${u.source}) can't be applied as the context item with provided path and ID has different source: ${d[p].source}`);else v.warn(540848913,y.CoreDefault,`UpdateOperation for (${o}, ${u.id}, ${u.source}) can't be applied as the context item with matching path and ID was not found. AddOperation should be used instead`)}else if(s==He.getTypeName()){if(!u.id)return;this.availableContexts.forEach(function(g,k){var S=g.get(o);S&&(S=S.filter(function(C){return!(z(C.parentPath)==l&&C.id==u.id)}),S.length==0?g.delete(o):g.set(o,S),g.size==0?a.availableContexts.delete(k):a.availableContexts.set(k,g))})}}}},{key:"updateWorkflowExecutionStates",value:function(e){if(this.localWorkflowManager){var t=this.enableRemoteExecutionNotification?this.workflowGraph.getWorkflowNodes().map(function(u){return u.workflow}):this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this);for(var o of e)if(Pa.has(m.getTypeNameFor(o)))for(var a of o.items)for(var s of t||[])this.localWorkflowManager.preProcessItemToWorkflow(s,a,this)}}},{key:"resolveRequestedContexts",value:function(e){var t=[];for(var o of sr(e.requestedContextTypesRules)){var a=(0,Pr.default)(o,3),s=a[0],u=a[1],l=a[2];if(!this.availableContexts.has(s)){if(u==Tr.Required)return[!1,[]];continue}var c=Array.from(this.availableContexts.get(s).values()).reduce(function(f,d){return f.concat(d)},[]);if(c.length==0)throw new Error(`Assert: availableContexts have the entry for ${s} which does not contain any context annotation.`);t.push.apply(t,(0,wo.default)(c))}return[!0,this.removeDuplicatedContextItems(t)]}},{key:"removeDuplicatedContextItems",value:function(e){return e.filter(function(t,o,a){return a.findIndex(function(s){return pe.deepEquals(s,t)})===o})}},{key:"getContextAnnotations",value:function(e,t,o,a){var s,u,l=o?z(o):void 0;return(u=(s=this.availableContexts.get(e))===null||s===void 0?void 0:s.get(t))===null||u===void 0?void 0:u.filter(function(c){return(!l||z(c.parentPath)==l)&&(!a||c.source==a)})}},{key:"onWorkflowDefinitionOverrideMessage",value:function(e){var t=new E({operationName:"WorkflowDefinitionOverride",success:!0}).setClientMetadata(this.clientMetadata).start(),o=function(c){throw qt(t,c),Error(`WorkflowDefinitionOverride: ${c}`)};if(!this.localWorkflowManager){o("Not supported by this local SessionProxy instance.");return}var a=this.localWorkflowManager.getWorkflowDefinitionsByName(this),s=a.get(e.sourceWorkflowId);if(!s){o(`Workflow registration for source workflow '${e.targetWorkflowId}' was not found.`);return}t.resourceId=s.id;var u=a.get(e.targetWorkflowId);if(u){if(!u.allowDefinitionOverride){o(`Workflow '${u.id}' does not allow workflow definition override.`);return}if(!s.definitionOverrideTargetWorkflows||s.definitionOverrideTargetWorkflows.indexOf(u.id)===-1){o(`Workflow '${s.id}' does not allow workflow definition for workflow '${u.id}'.`);return}this.workflowDefinitionManager.mergeWorkflowDefinition(u,e.definition,e.contextId),t.resultDescription=`Updated config for workflow: ${e.targetWorkflowId}, context id: ${e.contextId}`,qt(t)}}},{key:"applyContextIdOnOperations",value:function(e){this.contextIdManager.applyContextIdOnOperations(e)}},{key:"attachToWorkflowGraph",value:function(e){this.addToWorkflowGraph(e),this.attachExecutionTrackerToEachWorkflow()}},{key:"triggerRegisteredAnnotationCallbacks",value:function(e,t,o,a){if(this.callAnnotationCallbacks(e,t,o,a),this.hostCallbacks.onAnnotationResult)try{a?this.hostCallbacks.onApologyResult&&this.hostCallbacks.onApologyResult(e,o):this.hostCallbacks.onAnnotationResult(e,o)}catch(s){v.error(540301151,y.CoreDefault,new E({operationName:"HostCallbackOnAnnotationResultError",dimension0:t,resultDescription:`onAnnotationResult error: ${s}`}))}}},{key:"attachExecutionTrackerToEachWorkflow",value:function(){this.localWorkflowManager&&this.localWorkflowManager.attachExecutionTrackerToEachWorkflow(this.workflowGraph,this,this.onWorkflowExecutionComplete.bind(this))}},{key:"onWorkflowExecutionCompleteMessage",value:function(e,t){t(void 0,new Ge),this.localWorkflowManager&&this.localWorkflowManager.onExternalWorkflowExecuted(e.contextId,e.workflowId,this)}},{key:"onWorkflowExecutionComplete",value:function(e,t){}},{key:"enableDeltaGenerator",value:function(){var e,t;this.deltaGenerator=(e=this.deltaGenerator)!==null&&e!==void 0?e:new FS,this.syncDeltaTimers=(t=this.syncDeltaTimers)!==null&&t!==void 0?t:new Map}},{key:"createDeltasFromUpdateOperation",value:function(e){var t,o,a=[];v.info(523776396,y.CoreDefault,`Calling delta create for UpdateOperation under parent path [${e.parentPath}] (${(t=e.items)===null||t===void 0?void 0:t.length} item(s), first item id: ${((o=e.items)===null||o===void 0?void 0:o.length)>0?e.items[0].id:"(no items)"})`);var s=(0,wo.default)(e.parentPath);for(var u of e.items){var l=[],c=this.deltaGenerator.createTextTileDeltasFromItem(u,e.parentPath);if(!(c!=null&&c.length)){v.info(523329632,y.CoreDefault,`Failed to create delta on item ${u.id}`);continue}for(var f of c){var d=Zt();s=[].concat((0,wo.default)(e.parentPath),[u.id]);var p={id:d,revId:u.revId,body:f,contextId:u.contextId,source:u.source};l.push(p)}l.length>0&&(a.push(new At({parentPath:s,items:l})),this.enableSyncDeltaSending&&this.setupSyncDeltaAfterDelay(u,s,l))}return a}},{key:"setupSyncDeltaAfterDelay",value:function(e,t,o){var a=this,s,u,l,c=this.syncDeltaTimers.get(e.id);c&&(clearTimeout(c),this.syncDeltaTimers.delete(e.id));var f=o.find(function(x){var T;return((T=x.body)===null||T===void 0?void 0:T.unit)===Ke.Chars});if(f){var d=f.body,p={content:"",deltaType:me.Update,length:0,position:((s=d==null?void 0:d.position)!==null&&s!==void 0?s:0)+((l=(u=d==null?void 0:d.content)===null||u===void 0?void 0:u.length)!==null&&l!==void 0?l:0),unit:Ke.Sentence},g=gt.typeGuard(e.body)?new gn(p):new ur(p),k={id:Zt(),revId:e.revId,body:g,contextId:e.contextId,source:e.source},S=new At({parentPath:t,items:[k]}),C=setTimeout(function(x,T){a.submitOperation(x),a.syncDeltaTimers.delete(T)},this.syncDeltaTimeout,S,e.id);this.syncDeltaTimers.set(e.id,C)}}},{key:"addToWorkflowGraph",value:function(e){this.workflowGraph.addWorkflow(Ma(e))}},{key:"getAnnotations",value:function(e,t){var o,a,s,u=new E({operationName:"GetAnnotations",success:!0,dimension1:(o=e.annotationType)===null||o===void 0?void 0:o.toString(),dimension2:(a=e.maxDelayMs)===null||a===void 0?void 0:a.toString(),cv:e.cv}).setClientMetadata(this.clientMetadata).start(),l=this.sessionManager.getCorrelationVector(),c=new Sn({annotationTypes:e.annotationType,transientItems:e.transientItems,configs:e.configs,maxDelayMs:e.maxDelayMs,correlationInfo:{cvString:(s=e.cv)!==null&&s!==void 0?s:l.newChild().toString()}}),f=[],d;this.sendMessageToSession(c,function(S,C){t!=null&&t.IsCancellationRequested||(f.push({error:S,response:C}),d==null||d(!0))});var p=this,g=!1,k=new Promise(function(S,C){if(t){var x=t.cancel.bind(t);t.cancel=function(){g?S():(x(),C(new Error(n.requestCancelledError)))}}});return(0,jS.default)({},Symbol.asyncIterator,function(){var S,C,x,T,I;return mM(this,arguments,function*(){for(;!g;)try{f.length===0&&(yield ri(Promise.race([new Promise(function(N){return d=N}),k])));var M=f.shift();if(t!=null&&t.IsCancellationRequested)throw new Error(n.requestCancelledError);g=((S=M.response)===null||S===void 0?void 0:S.finalResponse)||M.error!==void 0,u.dimension3=`final response: ${g}`;var b=void 0;M.error?(u.dimension0=`Error code: ${M.error.code}`,qt(u,M.error.error),b={serviceError:[{code:As.ServerError,error:M.error.error,retryable:p==null?void 0:p.canBeRetried(M.error)}]}):((x=(C=M.response)===null||C===void 0?void 0:C.errorInfo)===null||x===void 0?void 0:x.length)>0?(u.dimension0=`Error code: ${M.response.errorInfo}`,qt(u,"Workflow execution error"),b={serviceError:M.response.errorInfo}):(u.resultDescription="OK",qt(u)),yield yield ri({content:(T=M.response)===null||T===void 0?void 0:T.content,error:b!=null?b:void 0,finalResponse:(I=M.response)===null||I===void 0?void 0:I.finalResponse})}catch(N){var A=N.message===n.requestCancelledError?Vi.RequestCancelled:Vi.Unknown;u.dimension0=`Error code: ${A}`,qt(u,N==null?void 0:N.message),yield yield ri({content:void 0,error:{clientError:{code:A,error:N==null?void 0:N.message}}}),g=!0;break}})})}},{key:"isHttpFallback",value:function(){var e=this.sessionManager.getNetworkWorkerManager();return!!(e&&e.getInitNetworkMode()===Ce.JSWebSockets&&e.getNetworkMode()===Ce.HttpFallback)}},{key:"canBeRetried",value:function(e){return(e==null?void 0:e.code)===Me.TooManyRequests||(e==null?void 0:e.code)===Me.RequestTimeout}},{key:"getAuthToken",value:function(e,t){var o={Tickets:[]};this.clientMetadata.docSessionId&&(o.DocSessionId=this.clientMetadata.docSessionId);var a=yM(e);a&&(o.TokenType=a),this.hostCallbacks.requestAuthToken(o).then(function(s){var u;if(!s)throw new Error("Missing AuthTokenResponse from requestAuthToken");if(!s.Token)throw new Error("Missing Token from requestAuthToken");t(void 0,s.Token,{returnedTokenType:e,timeToLiveSec:(u=s.TokenProperties)===null||u===void 0?void 0:u.timeToLiveSec})}).catch(function(s){t(s)})}},{key:"resetNextSyncSequenceId",value:function(){this.nextSyncSequenceId=1}},{key:"onReconnect",value:function(){var e=this;if(this.annotationActivationTrackers.forEach(function(t){var o;e.activateAnnotationForTracker(t,{ignoreExistingAnnotations:!0,sendOnlyIfConnected:!0,sendApologies:((o=t.options)===null||o===void 0?void 0:o.apologyCallback)!==void 0}).catch(function(){})}),this.reconnectCallbacks.forEach(function(t,o){t()}),!this.connectParams)throw new Error("Expected onConnect before onReconnect")}},{key:"onSessionClose",value:function(e){this.isSessionClosed=!0,this.connectParams=void 0,this.sessionCloseCallbacks.forEach(function(t,o){t(e)})}},{key:"onConnect",value:function(e,t,o,a,s,u){this.hasSessionConnected?e&&(this.allowSeed=!0,this.allowGroupSeed=!0,this.seedGroupSize=0,this.batchedSeedMessageGroupSize=0,this.seedBatchedOperationsManager&&(this.seedBatchedOperationsManager.removeAllBatchedItems(),this.seedBatchedOperationsManager=void 0),this.batchedOperationsManager&&(this.batchedOperationsManager.removeAllBatchedItems(),this.batchedOperationsManager=void 0),this.cachedClaimsChallenge=Object.assign(Object.assign({},this.cachedClaimsChallenge),{claimsVersion:0})):this.enableRemoteExecutionNotification&&this.addDownstreamWorkflowsIntoClientGraph(u),this.connectParams={isSeedingRequired:e,sessionUrl:t,origin:o,authToken:a},this.hasSessionConnected=!0,this.tryActivateWorkflows();for(var l of this.pendingConnectCallbacks)l(this.connectParams);this.connectCallbacks.forEach(function(c,f){c(e,t,o,a)}),this.serverInputTypes=s}},{key:"onDisconnect",value:function(e){this.connectParams=void 0,this.disconnectCallbacks.forEach(function(t,o){t(e)})}},{key:"onServerAuthenticationStateChange",value:function(e){if(e!=this.serverAuthenticationState){if(this.serverAuthenticationState==Ze.Authenticated&&e==Ze.Pending)return;var t=new E({operationName:"ServerAuthStateChange",dimension0:e.toString(),dimension1:this.serverAuthenticationState.toString(),success:!0}).setClientMetadata(this.clientMetadata).start();t.resultDescription=`Changing Server Authentication State newState: ${e}`,qt(t),this.serverAuthenticationState=e;for(var o of this.serverAuthenticationStateChangeCallback)o(this.serverAuthenticationState)}}},{key:"callAnnotationCallbacks",value:function(e,t,o,a){if(!(this.annotationCallbacks.size===0&&this.apologyCallbacks.size===0)){var s=a?this.apologyCallbacks.get(t):this.annotationCallbacks.get(t);s&&s.forEach(function(u){u(e,o)})}}},{key:"getOperationBatchConfig",value:function(e){var t=function(){return"operations"},o=void 0;this.batchMessagesEnabled?o=function(u){return{input:u,demultiplex:function(){return[[]]}}}:o=function(u){return{input:u.filter(function(l){return l.length}).reduce(function(l,c){return l.concat(c)},[]),demultiplex:function(){return[[]]}}};var a=function(u){if(!(u.length<=1))return{inputs:u.reduce(function(l,c){return l.push([c]),l},[]),join:function(){return[]}}};return{delayMs:e.delayMs,delayMsMax:e.delayMsMax,maxInputSize:e.maxInputSize,estimateSize:ws,groupingKeyExtractor:t,multiplex:o,split:a}}},{key:"sendSeedMessagesViaBatchManager",value:function(e,t,o){var a=this;if(!this.seedBatchedOperationsManager){var s=void 0;this.batchMessagesEnabled?s=function(l,c,f){if(a.batchedSeedMessageGroupSize+=l.length,l.length){var d=new wn;d.messages=[],l.forEach(function(p){d.messages.push(new Be({cv:p.cv,seq:0,ops:p.input,groupId:"Seed",groupSize:c.groupComplete?a.batchedSeedMessageGroupSize:void 0,groupComplete:c.groupComplete?c.groupComplete:void 0}))}),a.sendMessageToSession(d,function(p){f(p?new Error(p.error):void 0)})}}:s=function(l,c,f){a.seedGroupSize++,a.sendMessageToSession(new Be({cv:c.cv,seq:0,ops:l,groupId:"Seed",groupSize:c.groupComplete?a.seedGroupSize:void 0,groupComplete:c.groupComplete?c.groupComplete:void 0}),function(d){f(d?new Error(d.error):void 0)})},this.seedBatchedOperationsManager=new Po(s,this.reduceBatchOperationsEnabled,this.batchMessagesEnabled,void 0,this.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled)}this.seedBatchedOperationsManager.addBatchItem(e,this.operationBatchConfig,{name:"SubmitSeedOperations"},o,t)}},{key:"onAnnotationResultsFromServer",value:function(e,t){this.onAnnotationResults(e,Jt.ServerWorkflow,t)}},{key:"onAnnotationResultsFromLocal",value:function(e,t){this.onAnnotationResults(e,Jt.LocalWorkflow,t)}},{key:"getLocalRegisteredWorkflows",value:function(){return this.workflowRuntime?this.workflowRuntime.getRegisteredWorkflows():this.localWorkflowManager?this.localWorkflowManager.getAllRegisteredWorkflowsFromSession(this).map(function(e){return Ma(e)}):[]}},{key:"sendWorkflowGraphInitMessage",value:function(){var e=this,t=this.getLocalRegisteredWorkflows(),o=new E({operationName:"WorkflowGraphInit",success:!0}).setClientMetadata(this.clientMetadata).start(),a=new Zr({upstreamRuntimeWorkflows:t});this.sendMessageToSession(a,function(s,u){if(s){qt(o,s.error);return}o.resultDescription=`local workflows: ${t.map(function(l){return l.id})}, remote workflows: ${u.downstreamRuntimeWorkflows.map(function(l){return l.id})}`,qt(o),e.onWorkflowGraphInitResponse(u)})}},{key:"trySendWorkflowGraphInitMessage",value:function(){var e=this;!this.graphInitMessageTimer&&this.enableRemoteExecutionNotification&&(this.graphInitMessageTimer=setTimeout(function(){e.graphInitMessageTimer=void 0,e.sendWorkflowGraphInitMessage()},vM))}},{key:"onWorkflowGraphInitResponse",value:function(e){this.addDownstreamWorkflowsIntoClientGraph(e.downstreamRuntimeWorkflows),this.tryActivateWorkflows()}},{key:"addDownstreamWorkflowsIntoClientGraph",value:function(e){this.workflowGraph.removeWorkflows(!0);for(var t of e||[])this.workflowGraph.addWorkflow(t,!0);this.workflowRuntime||this.attachExecutionTrackerToEachWorkflow()}},{key:"resolvePlaceholdersInOperationParentPath",value:function(e){var t=e;return t.length==3&&t[0]=="session"&&t[1]=="user"&&t[2].startsWith("user_")&&(v.info(540848914,y.CoreDefault,`Replacing user context placeholder for: ${z(e)}.`),t=["session","#userContext#"]),t.length==3&&t[0]=="session"&&t[1]=="user"&&t[2].startsWith("tenant_")&&(v.info(540848915,y.CoreDefault,`Replacing tenant context placeholder for: ${z(e)}.`),t=["session","#tenantContext#"]),t}},{key:"filterOperationsForSession",value:function(e){return this.workflowRuntime?!0:Fh(e,this.serverInputTypes)}},{key:"executeCallbacksOnAnnotationSubmitted",value:function(e,t){var o=this,a=this.getAnnotationOperationsByType(e),s=a.annotationOpsMap,u=a.apologyOpsMap;s.forEach(function(l,c){Array.from(l).forEach(function(f){return o.triggerRegisteredAnnotationCallbacks(f,c,t,!1)})}),u.forEach(function(l,c){Array.from(l).forEach(function(f){return o.triggerRegisteredAnnotationCallbacks(f,c,t,!0)})})}},{key:"partitionAnnotationOperations",value:function(e){return e.reduce(function(t,o){var a=(0,Pr.default)(t,2),s=a[0],u=a[1];return o.items.some(function(l){return l.body&&_t.typeGuard(l.body)})?[[].concat((0,wo.default)(s),[o]),u]:[s,[].concat((0,wo.default)(u),[o])]},[[],[]])}},{key:"onAnnotationsSubmitted",value:function(e,t){var o=this,a=this.getAnnotationOperationsByType(e),s=a.annotationOpsMap,u=a.apologyOpsMap;s.forEach(function(l,c){var f=Array.from(l);o.onAnnotationResults(new Ct({annotationType:c,ops:f,cv:t,areApologies:!1}),Jt.Submitted,function(){})}),u.forEach(function(l,c){var f=Array.from(l);o.onAnnotationResults(new Ct({annotationType:c,ops:f,cv:t,areApologies:!0}),Jt.Submitted,function(){})})}},{key:"getAnnotationOperationsByType",value:function(e){var t=new Map,o=new Map,a=function(l){for(var c of l.items)if(c.body&&_t.typeGuard(c.body)){var f=function(p,g){var k=p.get(g)||new Set;k.add(l),p.set(g,k)};Ht.typeGuard(c.body)?f(o,c.body.annotationTypeName):f(t,m.getTypeNameFor(c.body))}};for(var s of e)a(s);return{annotationOpsMap:t,apologyOpsMap:o}}},{key:"onClaimsChallengeMessage",value:function(e,t){var o=new E({operationName:"OnClaimsChallengeMessage",dimension0:e.claimsVersion.toString(),dimension1:e.error,success:!0}).setClientMetadata(this.clientMetadata).start();o.resultSignature=`HasClaims: ${e.claims?e.claims.length>0:!1}`,o.resultDescription="Received Claims Challenge Message from Server",qt(o),e.claimsVersion>this.cachedClaimsChallenge.claimsVersion&&(this.cachedClaimsChallenge=Object.assign(Object.assign({},e),{actionRequired:!0}));for(var a of this.claimsChallengeCallback)a(this.cachedClaimsChallenge);t(void 0,new Ge)}},{key:"generateCorrelationId",value:function(){return this.sessionManager.getCorrelationVector().newChild().toString()}},{key:"onTokenProvisionResponse",value:function(e,t){if(!(e||!t)){var o=t.tokenType&&t.tokenType==st.WacUserInfo?Ze.WacUserInfoAuthenticated:Ze.Authenticated;this.onServerAuthenticationStateChange(o)}}},{key:"requestAuthTokenWithClaims",value:function(e){this.requestAuthTokenInteractive(e).catch(function(){})}},{key:"requestAuthTokenInteractive",value:function(e,t){var o=this,a,s=new E({operationName:"RequestAuthTokenInteractive",success:!0,dimension0:`isInteractive: ${(a=t==null?void 0:t.interactive)!==null&&a!==void 0?a:!1}`}).start();s.dimension1=`HasClaims: ${e.claims?e.claims.length>0:!1}`;var u={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:$r.Augloop,ConnectParams:this.connectParams,Claims:e.claims,Interactive:t==null?void 0:t.interactive};return this.hostCallbacks.requestAuthToken(u).then(function(l){if(!l)throw new Error("Missing AuthTokenResponse from requestAuthToken claims");if(!l.Token)throw new Error("Missing Token from requestAuthToken claims");return s.resultSignature="Token",new Dn({authToken:l.Token,version:++o.tokenMessageVersion,claimsVersion:e.claimsVersion})}).catch(function(l){return s.resultSignature="NoToken",s.dimension2=l.message,new Fo({reason:l.message,version:++o.tokenMessageVersion,claimsVersion:e.claimsVersion,clientHandlesResponse:!0})}).then(function(l){return new Promise(function(c,f){o.sendMessageToSession(l,function(d,p){qt(s,d==null?void 0:d.error),o.onTokenProvisionResponse(d,p),d?f(new Error(d.error)):(Dn.typeGuard(l)&&(o.cachedClaimsChallenge.actionRequired=!1),c(l))})})})}}])}();oi.requestCancelledError="Request cancelled";h();var YS=w(R()),XS=w(P()),Fa=(0,YS.default)(function n(){(0,XS.default)(this,n)});h();var tC=w(P()),nC=w(R()),rC=w(Qe()),zd=w($e()),oC=w(je());h();var ZS=w(P()),eC=w(R()),qa;(function(n){n[n.Anonymous=0]="Anonymous",n[n.Host=1]="Host"})(qa||(qa={}));var gr=function(){function n(){(0,ZS.default)(this,n),this.timers=new Map}return(0,eC.default)(n,[{key:"scheduleRefresh",value:function(e,t,o,a){var s=this.timers.get(e);s||(s={numberOfAttempts:0},this.timers.set(e,s)),s.refreshTimeoutId&&(clearTimeout(s.refreshTimeoutId),s.refreshTimeoutId=void 0),s.expiredTimeoutId&&(clearTimeout(s.expiredTimeoutId),s.expiredTimeoutId=void 0);var u=t*1e3-n.tokenRefreshBufferMs,l=t*1e3-n.tokenExpirationBufferMs;u>0?s.numberOfAttempts=0:(++s.numberOfAttempts,u=n.tokenRefreshBackoffIntervalMs,l=n.tokenExpirationBufferMs),s.numberOfAttempts<=n.tokenRefreshMaximumAttempts&&(s.refreshTimeoutId=setTimeout(function(){o()},u)),a&&(s.expiredTimeoutId=setTimeout(function(){a()},l))}},{key:"clearRefreshTimeouts",value:function(){this.clearTimeouts(!1)}},{key:"clearAllTimeouts",value:function(){this.clearTimeouts(!0)}},{key:"clearTimeouts",value:function(e){var t=this;this.timers.forEach(function(o,a){o.refreshTimeoutId&&(clearTimeout(o.refreshTimeoutId),o.refreshTimeoutId=void 0),e&&o.expiredTimeoutId&&(clearTimeout(o.expiredTimeoutId),o.expiredTimeoutId=void 0),o.expiredTimeoutId||t.timers.delete(a)})}}])}();gr.tokenRefreshBufferMs=24e4;gr.tokenExpirationBufferMs=12e4;gr.tokenRefreshBackoffIntervalMs=3e4;gr.tokenRefreshMaximumAttempts=3;var aC=w(Pn());function kM(n,r,e){return r=(0,zd.default)(r),(0,rC.default)(n,iC()?Reflect.construct(r,e||[],(0,zd.default)(n).constructor):r.apply(n,e))}function iC(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(iC=function(){return!!n})()}var $a=function(n){function r(e,t,o,a,s){var u;if((0,tC.default)(this,r),u=kM(this,r),u.getSessionStats=e,u.clientMetadata=t,u.tokenRefreshManager=o,u.sendMessage=a,u.options=s||{},u.options.overrideSessionInitMessage=u.options.overrideSessionInitMessage||function(l){return l},u.clientMetadata&&!u.clientMetadata.userSystemTimezone)try{u.clientMetadata.userSystemTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(l){}return u}return(0,oC.default)(r,n),(0,nC.default)(r,[{key:"initSession",value:function(t){var o=this;t.onResponse=t.onResponse||function(){};var a=pe.getCurrentTimeMs(),s=this.getSessionStats().lastConnectionClose&&a-this.getSessionStats().lastConnectionClose,u=this.getSessionStats().lastSyncMessage&&a-this.getSessionStats().lastSyncMessage,l=new E({operationName:"SessionInit"}).start(),c={sessionKey:this.sessionKey,sessionId:this.clientMetadata.sessionId,timeSinceLastConnectionClose:s,timeSinceLastSyncMessage:u,isTokenRefresh:t.isTokenRefresh,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification,error:void 0},f=this.options.overrideSessionInitMessage(new pt({protocolVersion:Rh,clientMetadata:this.clientMetadata,sessionKey:this.sessionKey,origin:this.origin,authToken:this.anonymousToken,extensionConfigs:t.extensionConfigs,returnWorkflowInputTypes:!0,enableRemoteExecutionNotification:this.options.enableRemoteExecutionNotification}));this.sendMessage(f,function(d,p){if(l.success=!d,l.resultSignature=o.getSessionStats().lastConnectionClose?"Reconnect":"FirstConnect",l.resourceId=en(p==null?void 0:p.sliceUrl),l.setClientMetadata(o.clientMetadata),p!=null&&p.sessionKey&&c.sessionKey!==p.sessionKey&&(c.sessionKey=p.sessionKey),d&&(c.error=d.error),l.resultDescription=JSON.stringify(c),v.info(508843779,y.CoreDefault,l.stop()),t.onResponse(d,p),d){o.emit("serverAuthenticationStateChange",Ze.NotAuthenticated);return}if(t.isReconnectOnSameSlice&&p.forceReconnect){o.emit("serverAuthenticationStateChange",Ze.NotAuthenticated);return}if(!p.anonymousToken||!p.tokenExpirationSeconds){o.emit("serverAuthenticationStateChange",Ze.NotAuthenticated),v.error(508843778,y.CoreDefault,"AL Anonymous token was not generated for the session");return}o.anonymousToken=p.anonymousToken,o.onSuccessfulSessionInitOnServerSide(p)})}},{key:"onSuccessfulSessionInitOnServerSide",value:function(t){var o=this;this.tokenRefreshManager.scheduleRefresh(qa.Anonymous,t.tokenExpirationSeconds,this.initSession.bind(this,{isTokenRefresh:!0}),function(){o.anonymousToken=void 0}),this.connectParams={isSeedingRequired:this.sessionKey!==t.sessionKey,sessionUrl:`${t.sessionUrlBase}/${t.sessionKey}`,origin:t.origin,authToken:this.anonymousToken},this.initHostAuthToken();var a=!!this.sessionKey;this.sessionKey=t.sessionKey,this.origin=t.origin,this.emit("connect",this.connectParams.isSeedingRequired,a,this.connectParams.sessionUrl,this.connectParams.origin,this.connectParams.authToken,t.workflowInputTypes,t.downstreamRuntimeWorkflows),a&&this.emit("reconnect")}},{key:"getAuthToken",value:function(){var t={Tickets:[],DocSessionId:this.clientMetadata.docSessionId,TokenType:$r.Augloop,ConnectParams:this.connectParams};return this.options.requestAuthToken(t).then(function(o){return o}).catch(function(){})}},{key:"initHostAuthToken",value:function(){var t=this,o=this.getAuthToken.bind(this);if(this.options.requestAuthToken&&o){var a=new E({operationName:"RefreshAuthToken",success:!0}).setClientMetadata(this.clientMetadata).start();o().then(function(s){if(!s){a.resultDescription="TokenResponse is not set";return}if(!s.Token){s.TokenError==os.TokenMissingInteractionRequired?(t.emit("serverAuthenticationStateChange",Ze.TokenMissingInteractionRequired),a.resultDescription="Host auth token provision failed interaction required"):(t.emit("serverAuthenticationStateChange",Ze.NotAuthenticated),a.resultDescription="Host auth token provision failed"),a.success=!1,v.info(508843777,y.CoreDefault,a.stop());return}v.info(508843776,y.CoreDefault,a.stop()),t.sendTokenProvisionMessage(s.Token)}).catch(function(s){t.emit("serverAuthenticationStateChange",Ze.NotAuthenticated),a.success=!1,a.resultDescription=`Error happened while attempting to fetch host token: ${s}`,v.error(508843747,y.CoreDefault,a.stop())})}}},{key:"sendTokenProvisionMessage",value:function(t){var o=new Dn({authToken:t,version:1});this.emit("serverAuthenticationStateChange",Ze.Pending),this.sendMessage(o,this.onTokenProvisionResponse.bind(this),!0)}},{key:"onTokenProvisionResponse",value:function(t,o){if(t||!o||!o.tokenExpirationSeconds){this.emit("serverAuthenticationStateChange",Ze.NotAuthenticated);return}var a=o.tokenType&&o.tokenType==st.WacUserInfo?Ze.WacUserInfoAuthenticated:Ze.Authenticated;this.emit("serverAuthenticationStateChange",a),this.tokenRefreshManager.scheduleRefresh(qa.Host,o.tokenExpirationSeconds,this.initHostAuthToken.bind(this))}}])}(aC.EventEmitter);h();var fu=w(Se()),Br=w(dt()),hC=w(P()),mC=w(R());h();var Vd=w(Se()),Qd=w(P()),jd=w(R());var wM=function(){function n(r){(0,Qd.default)(this,n),this.item=r,this.operation=r.op,this.delta=r.delta,this.deltas=r.deltas,this.id=z(this.itemPath),this.revId=r.revId}return(0,jd.default)(n,[{key:"itemPath",get:function(){return[].concat((0,Vd.default)(this.item.parentPath),[this.item.id])}},{key:"getModelIterator",value:function(){throw new Error("Method not implemented.")}},{key:"getBody",value:function(){return this.item.body}},{key:"getItemReference",value:function(){throw new Error("Method not implemented.")}},{key:"getParentItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getParentItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getPrevItem",value:function(e,t){throw new Error("Method not implemented.")}},{key:"getPrevItemBody",value:function(e,t){throw new Error("Method not implemented.")}},{key:"getNextItem",value:function(e,t){throw new Error("Method not implemented.")}},{key:"getNextItemBody",value:function(e,t){throw new Error("Method not implemented.")}},{key:"getChildItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getChildItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getSubtreeItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItemBody",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getContextItemBodies",value:function(e){throw new Error("Method not implemented.")}},{key:"addAnnotation",value:function(e,t){throw new Error("Method not implemented.")}},{key:"updateAnnotation",value:function(e,t){throw new Error("Method not implemented.")}},{key:"deleteAnnotation",value:function(e){throw new Error("Method not implemented.")}},{key:"loadSubtree",value:function(e){throw new Error("Method not implemented.")}},{key:"getSourceTimestamp",value:function(){return this.item.sourceTimestamp}},{key:"getContextId",value:function(){return this.item.contextId}}])}(),sC=function(){function n(r){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];(0,Qd.default)(this,n),this.scopeItem=void 0,this.rootItem=void 0,this.normalizeFilter=function(t){if(!t)return function(o){return o!==void 0};if(typeof t=="function")throw new Error("Not implemented yet");if((t.id?1:0)+(t.ids?1:0)+(t.itemType?1:0)+(t.itemTypes?1:0)!=1)throw new Error("Exactly one condition expected on IItemFilter");if(t.itemType)return function(o){return o&&m.matchesTypesFor(o.body,[t.itemType])};if(t.itemTypes)return function(o){return o&&m.matchesTypesFor(o.body,t.itemTypes)};throw new Error("Not implemented yet")},this.items=[].concat((0,Vd.default)(e),[r]),this.scopeItem=new wM(r)}return(0,jd.default)(n,[{key:"getItem",value:function(e){throw new Error("Method not implemented.")}},{key:"getItems",value:function(e){throw new Error("Method not implemented.")}},{key:"getItemBody",value:function(e){var t=this.getItemBodies(e);return t[0]}},{key:"getItemBodies",value:function(e){var t=this.normalizeFilter(e);return this.items.filter(t).map(function(o){return o.body})}},{key:"getItemByReference",value:function(e){throw new Error("Method not implemented.")}},{key:"getItemBodyByReference",value:function(e){throw new Error("Method not implemented.")}}])}();h();var uC=w(P()),lC=w(R());var Jd=function(){function n(r){(0,uC.default)(this,n),this.model=r.model,this.clientMetadata=r.clientMetadata,this.userContext=r.userContext,this.site=r.site,this.getTokenCallback=r.getTokenCallback}return(0,lC.default)(n,[{key:"flights",get:function(){var e;return(e=this._flights)!==null&&e!==void 0||(this._flights=fr(this.clientMetadata.flights)),this._flights}},{key:"getToken",value:function(e,t){return this.getTokenCallback(e,t)}},{key:"getTokenAsync",value:function(e){var t=this;return new Promise(function(o,a){t.getToken(e,function(s,u,l){s?a(s):o(Object.assign(Object.assign({},l),{token:u}))})})}}])}();h();var cC=w(dt()),fC=w(P()),dC=w(R());var pC=function(){function n(r,e,t){(0,fC.default)(this,n),this.itemsContextId=new Set,this.executionState=new Map,this.graphNode=r,this.onContextIdWorkflowExecutionComplete=e,t&&(this.itemsContextId=t.itemsContextId,this.executionState=t.executionState)}return(0,dC.default)(n,[{key:"addInputItemToProcess",value:function(e){this.itemsContextId.add(e)}},{key:"removeProcessedInputItem",value:function(e){this.itemsContextId.delete(e)}},{key:"countItemsToProcess",value:function(e){var t=0;for(var o of this.itemsContextId)o.indexOf(e)===0&&(t+=1);return t}},{key:"getExecutionState",value:function(){return this.executionState}},{key:"setExecutionState",value:function(e,t){return this.graphNode.isActivated?e?(this.executionState.set(e,t),!0):(v.info(520217546,y.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a undefined contextId (setExecutionState)`})),!1):(v.info(508883415,y.CoreDefault,new E({operationName:"WorkflowExecutionTracker",resourceId:this.graphNode.workflow.id,joinContextId:e,resultDescription:`Trying to set state ${t} for a not activated workflow`})),!1)}},{key:"beforeWorkflowExecution",value:function(e){this.setExecutionState(e,xe.Pending)}},{key:"afterWorkflowExecution",value:function(e){this.setExecutionState(e,xe.Executed)&&this.tryToCompleteWorkflowExecution(e)}},{key:"clearWorkflowExecutions",value:function(){var e=this;this.executionState.forEach(function(t,o){return e.afterWorkflowExecution(o)})}},{key:"tryToCompleteWorkflowExecution",value:function(e){var t=this.executionState.get(e);if(t===xe.Executed&&this.canCompleteExecution(e)){this.executionState.delete(e),this.onContextIdWorkflowExecutionComplete&&this.onContextIdWorkflowExecutionComplete(this.graphNode.workflow.id,e);for(var o of this.downstreamWorkflowExecutionTrackers)for(var a of o.getExecutionState()){var s=(0,cC.default)(a,2),u=s[0],l=s[1];l===xe.Executed&&Ft.isParentContextId(e,u)&&o.tryToCompleteWorkflowExecution(u)}}}},{key:"canCompleteExecution",value:function(e){for(var t of this.upstreamWorkflowExecutionTrackers)for(var o of t.getExecutionState().keys())if(Ft.isParentContextId(o,e))return!1;return!0}}])}();var gC=500,qn;(function(n){n.Unknown="",n.InputReceived="input",n.JoinMaxAnnnotation="maxAnnotation",n.JoinMaxTimeout="maxTimeout",n.JoinEarlyCompletion="earlyCompletion"})(qn||(qn={}));var vC=function(){function n(r,e,t){var o=this;(0,hC.default)(this,n),this.executionTrackersByWorkflowNameBySession=new Map,this.workflowsWithSessionAffinity=new Map,this.workflowDefinitionsWithSessionAffinity=[],this.workflowsWithoutSessionAffinity=[],this.pendingScopeExecutionNotificationsByWorkflow=new Map,this.sweepIntervalMs=200,this.sweepTimers=new Map,this.getResourceAsArrayBuffer=function(a,s,u){return o.modelDownloader?o.modelDownloader.getResourceAsArrayBuffer(a,s,u):Promise.reject(new Error("Resource Downloader never created"))},this.getResourceAsURL=function(a,s,u){return o.modelDownloader?o.modelDownloader.getResourceAsURL(a,s,u):Promise.reject(new Error("Resource Downloader never created"))},this.createModel=function(a){return!o.inferenceService&&o.inferenceServiceFactory&&(o.inferenceService=o.inferenceServiceFactory()),o.inferenceService?o.inferenceService.then(function(s){return s.createModel(a)}):Promise.reject(new Error("Inference Service never created"))},this.createModelInputs=function(){if(!o.inferenceService&&o.inferenceServiceFactory&&(o.inferenceService=o.inferenceServiceFactory()),o.inferenceService)return o.inferenceService.then(function(a){return a.createInputs()});throw new Error("Inference Service never created")},this.nextAnnotationId=1,this.nextSignalId=1,this.modelDownloader=r,this.inferenceServiceFactory=e,t.enableDeltas&&(this.deltaHandlers=new Map().set(m.getTypeNameFor(ur),$k).set(m.getTypeNameFor(gn),Gk),this.itemsForDelta=new Map),this.enableEarlyJoin=t.enableEarlyJoin||!1,this.site={getResourceAsArrayBuffer:this.getResourceAsArrayBuffer,getResourceAsURL:this.getResourceAsURL,createModel:this.createModel,createModelInputs:this.createModelInputs}}return(0,mC.default)(n,[{key:"getNextClientAnnotationId",value:function(){return"#AC"+this.nextAnnotationId++}},{key:"getNextClientSignalId",value:function(){return"#SC"+this.nextSignalId++}},{key:"registerLocalWorkflow",value:function(e,t){var o=this,a=new E({operationName:"WorkflowRegistration",resourceId:e.id}).start();if(e.inputTypes.length===0)throw new Error("Invalid workflow params");t?(this.workflowsWithSessionAffinity.get(t).push(this.createWorkflowImplementation(e,t)),t.registerContextTypes(sr(e.requestedContextTypesRules).map(function(s){var u=(0,Br.default)(s,2),l=u[0],c=u[1];return l})),t.attachToWorkflowGraph(e),a.setClientMetadata(t.getClientMetadata())):(e.isStateful?(this.workflowDefinitionsWithSessionAffinity.push(e),this.workflowsWithSessionAffinity.forEach(function(s,u){s.push(o.createWorkflowImplementation(e,u))})):this.workflowsWithoutSessionAffinity.push(this.createWorkflowImplementation(e)),this.workflowsWithSessionAffinity.forEach(function(s,u){u.registerContextTypes(sr(e.requestedContextTypesRules).map(function(l){var c=(0,Br.default)(l,2),f=c[0],d=c[1];return f})),u.attachToWorkflowGraph(e)})),a.success=!0,v.info(572838110,y.CoreDefault,a.stop())}},{key:"getAllRegisteredWorkflowsFromSession",value:function(e){var t=[];return t.push.apply(t,(0,fu.default)(this.workflowsWithoutSessionAffinity||[])),t.push.apply(t,(0,fu.default)(this.workflowsWithSessionAffinity.get(e)||[])),t.map(function(o){return o.workflow})}},{key:"getWorkflowDefinitionsByName",value:function(e){var t,o=new Map;return(t=this.workflowsWithSessionAffinity.get(e))===null||t===void 0||t.forEach(function(a){return o.set(a.workflow.id,a.workflow)}),o}},{key:"getWorkflowDefinitionsWithSessionAffinity",value:function(){return this.workflowDefinitionsWithSessionAffinity}},{key:"attachExecutionTrackerToEachWorkflow",value:function(e,t,o){var a=this,s=e.getWorkflowNodes(),u=this.executionTrackersByWorkflowNameBySession.get(t),l=function(k,S){if(o&&o(k,S),a.enableEarlyJoin){var C=function(){for(var T of a.executionTrackersByWorkflowNameBySession.get(t).values())if(T.graphNode.workflow.kind===V.Join){for(var I of T.getExecutionState().keys())if(Ft.isParentContextId(I,S))return!0}return!1};C()&&(a.cancelSweepTimer(t),a.ensureSweepTimer(t),a.sweepScopeExecutionNotifications())}};for(var c of s){var f=u.get(c.workflow.id),d=new pC(c,l.bind(this),f);u.set(c.workflow.id,d)}for(var p of u.values())this.setDownstreamWorkflowExecutionTrackers(p,u),this.setUpstreamWorkflowExecutionTrackers(p,u)}},{key:"canActivateWorkflow",value:function(e,t){var o;return e.location===pr.Local?!0:!(!t.hasConnected||((o=e.workflow.requiredTokenTypes)===null||o===void 0?void 0:o.length)>0&&t.getServerAuthenticationState()===Ze.NotAuthenticated)}},{key:"setDownstreamWorkflowExecutionTrackers",value:function(e,t){if(e.downstreamWorkflowExecutionTrackers===void 0){e.downstreamWorkflowExecutionTrackers=new Set;var o=e.graphNode;for(var a of o.downstreamWorkflows||[]){var s=t.get(a.workflow.id);this.setDownstreamWorkflowExecutionTrackers(s,t),e.downstreamWorkflowExecutionTrackers.add(s)}}}},{key:"setUpstreamWorkflowExecutionTrackers",value:function(e,t){if(e.upstreamWorkflowExecutionTrackers===void 0){e.upstreamWorkflowExecutionTrackers=new Set;var o=e.graphNode;for(var a of o.upstreamWorkflows||[]){var s=t.get(a.workflow.id);this.setUpstreamWorkflowExecutionTrackers(s,t),e.upstreamWorkflowExecutionTrackers.add(s)}}}},{key:"deactivateServerWorkflow",value:function(e,t){var o;e.location!==pr.Local&&((o=this.executionTrackersByWorkflowNameBySession.get(t))===null||o===void 0||o.get(e.workflow.id).clearWorkflowExecutions(),e.isActivated=!1)}},{key:"addSession",value:function(e){this.executionTrackersByWorkflowNameBySession.set(e,new Map);var t=[];for(var o of this.workflowDefinitionsWithSessionAffinity)t.push(this.createWorkflowImplementation(o)),e.attachToWorkflowGraph(o);this.workflowsWithSessionAffinity.set(e,t);for(var a of this.workflowsWithoutSessionAffinity)e.attachToWorkflowGraph(a.workflow)}},{key:"closeSession",value:function(e){this.cancelSweepTimer(e);for(var t of this.workflowsWithSessionAffinity.get(e)||[])t.workflowLambda.dispose();this.workflowsWithSessionAffinity.delete(e)}},{key:"setTokenCallback",value:function(e){this.getAuthTokenCallback=e}},{key:"preProcessItemToWorkflow",value:function(e,t,o){var a=this.executionTrackersByWorkflowNameBySession.get(o).get(e.id);e.kind===V.Join&&m.matchesTypesFor(t.body,e.inputTypes)&&a.addInputItemToProcess(t.contextId),(e.kind===V.SingleItem&&m.matchesTypesFor(t.body,e.inputTypes)||e.kind===V.Join&&m.matchesTypesFor(t.body,[e.collectionScopeType]))&&a.beforeWorkflowExecution(t.contextId)}},{key:"isReadyToEarlyJoin",value:function(e,t,o){var a=this,s=function(p){var g,k=Array.from((g=p.states)!==null&&g!==void 0?g:[]).map(function(C){return`${C[0]}: ${C[1].map(function(x){return x.join()})}`}).join(),S=new E({operationName:"EarlyJoinCompletion",resourceId:e.graphNode.workflow.id,joinContextId:t,success:!0}).start();S.setClientMetadata(o),S.resultDescription=`isReadyToEarlyJoin (${a.enableEarlyJoin}) -> hasProcessedAllInputItems: ${p.hasProcessedAllInputItems}, allUpstreamComplete: ${p.allUpstreamComplete}, states: ${k}`,v.info(512550800,y.CoreDefault,S.stop())},u=e.countItemsToProcess(t)===0;if(!u)return this.enableEarlyJoin||s({hasProcessedAllInputItems:u}),!1;var l=this.areAllUpstreamWorkflowComplete(e,t),c=l.allUpstreamComplete,f=l.states;return this.enableEarlyJoin?c:(s({hasProcessedAllInputItems:u,allUpstreamComplete:c,states:f}),!1)}},{key:"areAllUpstreamWorkflowComplete",value:function(e,t){var o=new Map;for(var a of e.upstreamWorkflowExecutionTrackers){var s=[];for(var u of a.getExecutionState()){var l=(0,Br.default)(u,2),c=l[0],f=l[1];if(s.push([c,f]),Ft.isParentContextId(t,c))return o.set(a.graphNode.workflow.id,s),{allUpstreamComplete:!1,states:o}}s.length>0&&o.set(a.graphNode.workflow.id,s)}return{allUpstreamComplete:!0,states:o}}},{key:"runLocalWorkflows",value:function(e,t){var o=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s,u,l,c=function(x,T,I){var _,M,b=t.getWorkflowItemStorage(),A=x.workflow,N=(_=o.executionTrackersByWorkflowNameBySession.get(t))===null||_===void 0?void 0:_.get(A.id),F=A.inputTypes.concat(A.kind===V.Join?A.collectionScopeType:[]),q=new E({operationName:"RunLocalWorkflows",success:!0,resourceId:A.id,joinContextId:T.contextId}).start();if(q.setClientMetadata(t.getClientMetadata()),m.matchesTypesFor(T.body,F)){var J=at(I.parentPath,T);if(A.kind===V.Join)if(m.matchesTypesFor(J.body,[A.collectionScopeType])){b.setScopeItem(J,A),q.resultDescription=`Scope item: ${T.id} (${m.getTypeNameFor(T.body)})`,v.info(524126153,y.CoreDefault,q.stop()),o.setScopeExecutionNotification(t,x,J,Rr.Internal);return}else{N.removeProcessedInputItem(J.contextId);var Y=b.getScopeItem(J.contextId,A);if(!Y){q.resultDescription=`Filtered out join invalidation: out of scope type (${A.collectionScopeType}), item id: ${J.id}`,v.info(541173894,y.CoreDefault,q.stop());return}b.addItemToWorkflowList(J,A),q.joinContextId=Y.contextId,q.resultDescription=`Input item: ${T.id} (${m.getTypeNameFor(T.body)})`}if(m.getBaseTypesFor(J.body).indexOf(xi.getTypeName())>=0){var fe=[].concat((0,fu.default)(J.parentPath),[J.id]),W=!0;for(var B of(M=A.outputTypes)!==null&&M!==void 0?M:[])if(!t.getContextAnnotations(B,Jt.LocalWorkflow,fe,A.id)){W=!1;break}if(W)return}var L=function(){var D,$=t.resolveRequestedContexts(A),U=(0,Br.default)($,2),K=U[0],Z=U[1];if(!K){q.resultDescription=`Required contexts are not ready for ${A.id}. Retrying execution in ${gC} milliseconds...`,v.info(545837259,y.CoreDefault,q.stop()),setTimeout(L,gC);return}if(A.kind===V.SingleItem)o.queueWorkflow({workflowInfo:x,scopeItem:J,inputItems:[J],requestedContexts:Z,session:t,orchestrationMode:Rr.Internal,triggerReason:qn.InputReceived,onCompleteCallback:o.onWorkflowExecuted.bind(o,J,A,t)}).then(function(){v.info(509154263,y.WorkflowDefault,q.stop())}).catch(function(an){q.resultDescription=an,v.error(572838111,y.CoreDefault,q.stop())});else if(A.kind===V.Join){var ye=T.contextId,he=b.getScopeItem(ye,x.workflow);if(!he){q.resultDescription=`No scope item for ${A.id} workflow from contextId ${ye}`,v.info(526758475,y.CoreDefault,q.stop());return}var ke=o.isReadyToEarlyJoin(N,he.contextId,t.getClientMetadata()),Ae=ke?qn.JoinEarlyCompletion:qn.JoinMaxAnnnotation;if(b.isWorkflowReady(he.contextId,A)||ke){var on=(D=o.pendingScopeExecutionNotificationsByWorkflow.get(A.id))===null||D===void 0?void 0:D.get(he.contextId);if(!on){q.resultDescription=`Workflow ${A.id}, contextId ${he.contextId}, already queued, skipping new scope execution`,v.info(528048977,y.CoreDefault,q.stop());return}var ht=b.getItemsToExecute(he.contextId,A);o.queueWorkflow({workflowInfo:x,scopeItem:he,inputItems:ht,requestedContexts:Z,session:t,orchestrationMode:Rr.Internal,triggerReason:Ae,onCompleteCallback:o.onWorkflowExecuted.bind(o,he,A,t)}).then(function(){v.info(509154262,y.WorkflowDefault,q.stop())}).catch(function(an){q.resultDescription=an,v.error(541173895,y.CoreDefault,q.stop())}),o.pendingScopeExecutionNotificationsByWorkflow.get(A.id).delete(he.contextId),o.pendingScopeExecutionNotificationsByWorkflow.get(A.id).size===0&&o.pendingScopeExecutionNotificationsByWorkflow.delete(A.id)}}};L()}},f=e;a&&(f=[new we({parentPath:["session"],items:[{id:"#userContext#",body:new Sr}]}),new we({parentPath:["session"],items:[{id:"#tenantContext#",body:new Cr}]})],t.getContextIdManager().applyContextIdOnOperations(f),f=f.concat(e));for(var d of f){var p=m.getTypeNameFor(d);for(var g of d.items){if(t.applyOperationForContext(d,g,Jt.Submitted),p===He.getTypeName()){(s=this.itemsForDelta)===null||s===void 0||s.delete(d.parentPath.concat(g.id).toString());continue}else if(g.body)if(p===At.getTypeName()&&this.deltaHandlers&&this.itemsForDelta){this.handleLocalDeltaUpdate(g,d,t);continue}else(u=this.itemsForDelta)===null||u===void 0||u.set(d.parentPath.concat(g.id).toString(),g);else continue;for(var k of this.workflowsWithoutSessionAffinity)c(k,g,d);for(var S of(l=this.workflowsWithSessionAffinity.get(t))!==null&&l!==void 0?l:[])c(S,g,d)}}}},{key:"handleLocalDeltaUpdate",value:function(e,t,o){var a=new E({operationName:"LocalDeltaUpdate",dimension0:m.getTypeNameFor(e.body),success:!0});a.start();try{var s=this.deltaHandlers.get(m.getTypeNameFor(e.body)),u=this.itemsForDelta.get(t.parentPath.toString());if(s&&u){var l=t.parentPath.length>0?t.parentPath.slice(0,t.parentPath.length-1):t.parentPath,c=s(e.body,u.body);if(c){var f={id:u.id,revId:e.revId,body:c,parentPath:l,delta:e.body,contextId:e.contextId},d=new wr({parentPath:f.parentPath,items:[f]});v.info(539637591,y.CoreDefault,a.stop()),this.runLocalWorkflows([d],o)}else a.success=!1,a.resultDescription="Failed because the handler did not produce valid updated item",v.info(539637592,y.CoreDefault,a.stop())}else a.success=!1,a.resultDescription="Failed due to lack of handler or parent item",v.info(539637593,y.CoreDefault,a.stop())}catch(p){a.success=!1,a.resultDescription=`Failed to apply delta, error: ${p}`,v.info(539637594,y.CoreDefault,a.stop())}}},{key:"createWorkflowImplementation",value:function(e,t){var o=e.factory(),a={workflow:e,workflowLambda:o,initPromise:this.initWorkflow(e.kind,o,t)};return a}},{key:"initWorkflow",value:function(e,t,o){var a=new Jd({model:void 0,clientMetadata:o?o.getClientMetadata():void 0,userContext:o?o.getUserContext():void 0,site:this.site,getTokenCallback:this.getAuthTokenCallback});return e===V.SingleItem?t.init(this.site,a):e===V.Join?t.init(this.site,a):Promise.resolve()}},{key:"queueWorkflow",value:function(e){var t=this;return this.executionTrackersByWorkflowNameBySession.get(e.session).get(e.workflowInfo.workflow.id).setExecutionState(e.scopeItem.contextId,xe.Running),this.executeLocalWorkflow(e.workflowInfo,e.scopeItem,e.inputItems,e.session,e.requestedContexts,e.orchestrationMode,e.triggerReason).then(function(o){t.processAnnotationResults(o,e.session),e.onCompleteCallback()}).catch(function(o){throw e.onCompleteCallback(),o})}},{key:"processAnnotationResults",value:function(e,t){for(var o of e)t.onAnnotationResults(o,Jt.LocalWorkflow,function(){})}},{key:"executeLocalWorkflow",value:function(e,t,o,a,s,u,l){var c=this;return new Promise(function(f,d){var p,g,k,S=[],C=e.workflow,x=new E({operationName:"ExecuteWorkflow",resourceId:C.id,joinContextId:(p=t==null?void 0:t.contextId)!==null&&p!==void 0?p:"",resultDescription:l!=null?l:"",success:!0}).setClientMetadata(a.getClientMetadata());x.start();var T=(g=t==null?void 0:t.contextId)!==null&&g!==void 0?g:o[0].contextId,I=(k=t==null?void 0:t.revId)!==null&&k!==void 0?k:o[0].revId,_=function(){var O=new Map;if(t&&(t.parentPath||v.error(525382231,y.CoreDefault,`Missing scope item parent. Workflow: ${C.id}. Type: ${m.getTypeNameFor(t.body)}`),O.set(t.body,t)),Array.isArray(o))for(var D of o)D&&D.body&&(D.parentPath||v.error(525382232,y.CoreDefault,`Missing parent. Workflow: ${C.id}. Type: ${m.getTypeNameFor(D.body)}`),O.set(D.body,D));return O},M=_(),b=function(O){var D=arguments.length>1&&arguments[1]!==void 0?arguments[1]:x;if(O)return D.success=!1,D.resultDescription+=typeof O=="string"?O:O.message,D.resultSignature="Exception",v.error(572838112,y.CoreDefault,D.stop()),typeof O=="string"?new Error(O):O;v.info(572838113,y.CoreDefault,D.stop())},A=function(O,D,$,U){var K,Z=new E({operationName:"SetAnnotations",resourceId:D,joinContextId:(K=t==null?void 0:t.contextId)!==null&&K!==void 0?K:"",success:!0}).setClientMetadata(a.getClientMetadata());Z.start();var ye=function(Gt){v.info(555866112,y.CoreDefault,new Fi({annotationType:D,annotationState:Gt,workflowId:e.workflow.id}))};for(var he of $)he.metadata=Object.assign(Object.assign({},he.metadata),{state:Bt.Created}),ye(Bt.Created);var ke=M.get(O),Ae=m.getTypeNameFor(ke.body),on=function(){var Gt;if(C.kind===V.SingleItem&&o[0].body!==O){var Xe=`Expected obj to be ${o[0].body} but instead it was ${O}`;b(Xe,Z),d(b(Xe));return}var Ye;if(!Array.isArray($))Ye="Workflow produced an invalid annotation array";else if(!C.outputTypes||C.outputTypes.indexOf(D)<0)Ye=`Workflow said it would output one of [${C.outputTypes}] but instead output ${D}`;else if(!ke)Ye="No item provided";else for(var Fe of $)m.matchesTypesFor(Fe,[_t.getTypeName()])?m.getTypeNameFor(Fe)!==D&&(Ye=`Workflow produced inconsistent annotation types in setAnnotations call (${m.getTypeNameFor(Fe)} did not match expected ${D})`):Ye=`Workflow produced an output that is not an annotation ${m.getTypeNameFor(Fe)}`;if(Ye){b(Ye,Z),d(b(Ye));return}var Pt;if(U&&U.isSessionAnnotation?Pt=["session"]:U&&U.ancestorType?Pt=ke.parentPath:Pt=ke.parentPath.concat(ke.id),u!==Rr.External){var Rt=[],mr=[],vr=function(){yr.metadata=Object.assign(Object.assign({},yr.metadata),{state:Bt.Sent}),ye(Bt.Sent);var Kt=yr.id,_n=Kt?(Gt=a.getContextAnnotations(D,Jt.LocalWorkflow,Pt,C.id))===null||Gt===void 0?void 0:Gt.filter(function(Eu){var ui;return((ui=Eu.body)===null||ui===void 0?void 0:ui.id)==Kt}):void 0;(_n==null?void 0:_n.length)==1?_n.length==1?mr.push({id:_n[0].id,source:C.id,revId:I,body:yr,contextId:T}):v.error(545837260,y.CoreDefault,`Assert: Multiple existing context annotations with body id ${Kt} found for ${D} and local workflow ${C.id}).`):Rt.push({id:c.getNextClientAnnotationId(),source:C.id,revId:I,body:yr,contextId:T})};for(var yr of $)vr();var si=[];return Rt.length>0&&si.push(new we({parentPath:Pt,items:Rt,parentRevId:I})),mr.length>0&&si.push(new Oe({parentPath:Pt,items:mr,parentRevId:I})),new Ct({annotationType:D,ops:si})}},ht=on();if(!ht){v.info(509644823,y.CoreDefault,Z.stop());return}U&&U.immediate?a.onAnnotationResults(ht,Jt.LocalWorkflow,function(){}):S.push(ht),(Ae==Sr.getTypeName()||Ae==Cr.getTypeName()||m.matchesTypesFor(ke.body,[bt.getTypeName(),zn.getTypeName()]))&&a.submitOperationsToSession(ht.ops),v.info(509644822,y.CoreDefault,Z.stop())},N=function(O){if(u===Rr.External){d(b("NYI"));return}var D=new E({operationName:"submitSignalsAction",resourceId:C.id,success:!0}).setClientMetadata(a.getClientMetadata());for(var $ of O){var U=m.getTypeNameFor($);m.matchesTypesFor($,[Xt.getTypeName()])||(D.resultDescription=`Workflow produced an output that is not an signal (${m.getTypeNameFor($)})`,v.info(521413954,y.CoreDefault,D)),(!C.outputTypes||C.outputTypes.indexOf(U)===-1)&&(D.resultDescription=`Workflow said it would output one of [${C.outputTypes}] but instead output ${U}`,v.info(521413953,y.CoreDefault,D)),$.timestamp&&(n.logTimestampUsageByWorkflowId.has(C.id)||(n.logTimestampUsageByWorkflowId.add(C.id),D.resultDescription=`Workflow "${C.id}" sets signal.timeStamp`,v.info(509212803,y.CoreDefault,D)))}var K=O.map(function(ye){return{id:c.getNextClientSignalId(),source:C.id,revId:I,body:ye,contextId:T}}),Z=new it({parentPath:["session"],parentRevId:I,items:K});a.submitOperations([Z])},F=function(O,D,$){var U;switch($){case xr.JoinContext:{if(!t.contextId){var K="ContextId is not defined for this scope item.";throw v.error(527472289,y.CoreDefault,K),new Error(K)}U=t.contextId;break}case xr.Session:{U=void 0;break}default:{var Z="Defined scope is not supported. "+$;throw v.error(527472290,y.CoreDefault,Z),new Error(Z)}}var ye=new ar({definition:D,contextId:U,sourceWorkflowId:C.id,targetWorkflowId:O});a.onWorkflowDefinitionOverrideMessage(ye)},q=new Jd({model:new sC(o[0],s),clientMetadata:a.getClientMetadata(),userContext:a.getUserContext(),site:c.site,getTokenCallback:c.getAuthTokenCallback}),J=function(O){b(O?O.message:void 0),O?d(O):f(S)},Y={setAnnotations:A,submitSignals:N,done:J,overrideWorkflowDefinition:F,getDynamicAnnotations:void 0,setBillingDomain:void 0},fe=e.workflowLambda;if(C.kind===V.SingleItem){o.length!==1&&J(new Error("Single item workflows expect a single input")),q.delta=o[0].delta,q.deltas=o[0].deltas;try{var W=fe;e.initPromise||(e.initPromise=W.init(c.site,q)),e.initPromise.then(function(){W.execute(o[0].body,q,Y)}).catch(function(L){b(L)})}catch(L){b(L)}}else if(C.kind===V.Join){o.length===0&&J(new Error("Join workflows expect an inputs array")),q.delta=t.delta,q.deltas=t.deltas;try{var B=fe;e.initPromise||(e.initPromise=B.init(c.site,q)),e.initPromise.then(function(){B.execute(t.body,o.map(function(L){return L.body}),q,Y)}).catch(function(L){b(L)})}catch(L){b(L)}}else b(`Workflow kind ${C.kind} not supported`)})}},{key:"ensureSweepTimer",value:function(e){if(!this.sweepTimers.get(e)){var t=setInterval(this.onSweep.bind(this),this.sweepIntervalMs);this.sweepTimers.set(e,t)}}},{key:"cancelSweepTimer",value:function(e){var t=this.sweepTimers.get(e);this.sweepTimers.get(e)&&(clearInterval(t),this.sweepTimers.delete(e))}},{key:"onSweep",value:function(){this.sweepScopeExecutionNotifications()}},{key:"setScopeExecutionNotification",value:function(e,t,o,a){var s,u,l=Date.now(),c=l+cc(t.workflow.minDelayMs,1e3),f=l+cc(t.workflow.maxDelayMs,5e3),d={session:e,workflowImplementation:t,scopeItem:o,startTime:l,minTime:c,maxTime:f,orchestrationMode:a},p=t.workflow.kind===V.Join?o.contextId:d.scopeItem.parentPath.concat(o.id).join("\\");this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id)||this.pendingScopeExecutionNotificationsByWorkflow.set(t.workflow.id,new Map);var g=this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).get(p);if(g){var S=new E({resultDescription:`Duplicated pending scope execution for ${t.workflow.id} at ${p}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:(u=o==null?void 0:o.contextId)!==null&&u!==void 0?u:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();v.info(509727899,y.CoreDefault,S.stop())}else{var k=new E({resultDescription:`New pending scope execution for ${t.workflow.id} at ${p}`,operationName:"LocalScopeExecutionNotification",resourceId:t.workflow.id,joinContextId:(s=o==null?void 0:o.contextId)!==null&&s!==void 0?s:"",success:!0}).setClientMetadata(e.getClientMetadata()).start();v.info(539883075,y.CoreDefault,k.stop()),this.pendingScopeExecutionNotificationsByWorkflow.get(t.workflow.id).set(p,d)}this.ensureSweepTimer(e)}},{key:"sweepScopeExecutionNotifications",value:function(){var e=this,t,o,a=new Set(Array.from(this.sweepTimers.keys()));for(var s of Array.from(this.pendingScopeExecutionNotificationsByWorkflow.entries())){var u=(0,Br.default)(s,2),l=u[0],c=u[1],f=function(T){var I=T.session,_=T.workflowImplementation.workflow,M=T.orchestrationMode,b=I.getWorkflowItemStorage(),A=new E({operationName:"LocalScopeExecutionNotification",resourceId:_.id,joinContextId:(o=(t=T.scopeItem)===null||t===void 0?void 0:t.contextId)!==null&&o!==void 0?o:"",success:!0}).setClientMetadata(I.getClientMetadata()).start(),N=function(){if(_.kind===V.Join){var J=Date.now(),Y=T.workflowImplementation.workflow,fe=T.scopeItem.contextId,W=I.getWorkflowDefinition(Y,fe).maxDelayMs;return b.isWorkflowReady(fe,Y)?(A.resultDescription=`Join Workflow: ${Y.id} queuing by maxAnnotation, contextId: ${fe}`,v.info(528048978,y.CoreDefault,A.stop()),{isValid:!0,triggerReason:qn.JoinMaxAnnnotation}):T.startTime+W<J?(A.resultDescription=`Join Workflow: ${Y.id} queuing by maxTimeout, contextId: ${fe}`,v.info(528048979,y.CoreDefault,A.stop()),{isValid:!0,triggerReason:qn.JoinMaxTimeout}):e.isReadyToEarlyJoin(e.executionTrackersByWorkflowNameBySession.get(I).get(Y.id),fe,I.getClientMetadata())?(v.info(512550856,y.CoreDefault,`Workflow: ${Y.id} queuing by early completion, contextId: ${fe}, timeout: ${W}`),{isValid:!0,triggerReason:qn.JoinEarlyCompletion}):{isValid:!1,triggerReason:qn.Unknown}}return{isValid:!0,triggerReason:qn.Unknown}},F=function(){var J=N(),Y=J.isValid,fe=J.triggerReason;if(!Y)return!1;var W=I.resolveRequestedContexts(_),B=(0,Br.default)(W,2),L=B[0],O=B[1];if(!L)return!1;try{if(_.kind===V.Join){var D=T.scopeItem.contextId,$=b.getScopeItem(D,_);if($){var U=b.getItemsToExecute($.contextId,_);if(U.length===0)return A.resultDescription=`Failed to retrieve items for workflow: ${_.id}, contextId: ${D}, skipping execution`,v.info(527472291,y.CoreDefault,A.stop()),e.onWorkflowExecuted($,_,I),!0;e.queueWorkflow({workflowInfo:T.workflowImplementation,scopeItem:$,inputItems:U,requestedContexts:O,session:I,orchestrationMode:M,triggerReason:fe,onCompleteCallback:e.onWorkflowExecuted.bind(e,$,_,I)}).catch(function(K){A.success=!1,A.resultDescription=K.message,v.error(509092189,y.CoreDefault,A.stop())})}else A.resultDescription="ContextId no longer exists, skipping workflow execution",v.info(539883076,y.CoreDefault,A.stop())}else A.resultDescription=`Workflow in type ${_.kind} is not supported`,v.error(539883077,y.CoreDefault,A.stop())}catch(K){A.resultDescription=`Trying to execute ${_.id} caused an exception: ${K}`,v.warn(539883078,y.CoreDefault,A.stop())}return!0};F()?(e.pendingScopeExecutionNotificationsByWorkflow.get(l).delete(g),e.pendingScopeExecutionNotificationsByWorkflow.get(l).size===0&&e.pendingScopeExecutionNotificationsByWorkflow.delete(l)):a.delete(I)};for(var d of Array.from(c.entries())){var p=(0,Br.default)(d,2),g=p[0],k=p[1];f(k)}}if(a.size!==0)for(var S of Array.from(a)){var C=new E({resultDescription:"No pending scope notifications left, cancelling sweep timer",operationName:"LocalScopeExecutionNotification",success:!0}).start();v.debug(539883079,y.CoreDefault,C.stop()),this.cancelSweepTimer(S)}}},{key:"onExternalWorkflowExecuted",value:function(e,t,o){var a={id:"",parentPath:[],contextId:e},s={id:t};this.onWorkflowExecuted(a,s,o,!1)}},{key:"onWorkflowExecuted",value:function(e,t,o){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,s;(s=this.executionTrackersByWorkflowNameBySession.get(o).get(t.id))===null||s===void 0||s.afterWorkflowExecution(e.contextId),a&&t.kind===V.Join&&o.getWorkflowItemStorage().onWorkflowExecuted(e,t)}}])}();h();var EC=w(P()),NC=w(R());h();var TC=w(P()),IC=w(R());h();var SC=w(P()),CC=w(R());h();var yC=w(P()),kC=w(R());var wC=function(){function n(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500;(0,yC.default)(this,n),this.bufferingTimeMs=500,this.workflowIdToSequencersMap=new Map,this.bufferingTimeMs=r}return(0,kC.default)(n,[{key:"create",value:function(e){if(!e.ownerId)return null;var t=this.workflowIdToSequencersMap.get(e.ownerId);return t||(t=new Jo(this.bufferingTimeMs),this.workflowIdToSequencersMap.set(e.ownerId,t)),t}}])}();var SM=function(n,r,e,t){function o(a){return a instanceof e?a:new e(function(s){s(a)})}return new(e||(e=Promise))(function(a,s){function u(f){try{c(t.next(f))}catch(d){s(d)}}function l(f){try{c(t.throw(f))}catch(d){s(d)}}function c(f){f.done?a(f.value):o(f.value).then(u,l)}c((t=t.apply(n,r||[])).next())})},xC=function(){function n(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:500,e=arguments.length>1?arguments[1]:void 0;(0,SC.default)(this,n),this.sequencerFactory=e!=null?e:new wC(r)}return(0,CC.default)(n,[{key:"sequence",value:function(e){var t;return SM(this,void 0,void 0,function*(){var o=(t=e==null?void 0:e.M_)===null||t===void 0?void 0:t.seq;if(o!=null){var a=this.sequencerFactory.create(e);a&&(yield a.sequence(e.M_.seq))}})}}])}();var _C=function(){function n(r){(0,TC.default)(this,n),this.annotationSequencer=r!=null?r:new xC}return(0,IC.default)(n,[{key:"process",value:function(e,t,o,a){var s=this,u=[],l=function(d){var p=[];if(d!=null&&d.items){var g=function(C){var x=s.annotationSequencer.sequence(C.body).then(function(){t(d,C)});p.push(x)};for(var k of d.items)g(k)}u.push(Promise.all(p).then(function(){o(d,e.cv)}))};for(var c of e.ops)l(c);Promise.all(u).then(function(){return a(e)})}}])}();h();var AC=w(P()),bC=w(R()),MC=function(){function n(){(0,AC.default)(this,n)}return(0,bC.default)(n,[{key:"process",value:function(e,t,o,a){for(var s of e.ops){if(s!=null&&s.items)for(var u of s.items)t(s,u);o(s,e.cv)}a(e)}}])}();var DC=function(){function n(r,e,t){(0,EC.default)(this,n),this.isOrderingEnabled=r,this.orderedAnnotationResultsProcessor=e!=null?e:new _C,this.unorderedAnnotationResultsProcessor=t!=null?t:new MC}return(0,NC.default)(n,[{key:"process",value:function(e,t,o,a){this.isOrderingEnabled()?this.orderedAnnotationResultsProcessor.process(e,t,o,a):this.unorderedAnnotationResultsProcessor.process(e,t,o,a)}}])}();h();var PC=w(P()),RC=w(R()),BC=function(){function n(r){(0,PC.default)(this,n),this.hostCallbacks=r}return(0,RC.default)(n,[{key:"isFeatureEnabled",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled(e,o).catch(function(){return Promise.resolve(t)}):Promise.resolve(t)}},{key:"isChangeGateEnabled",value:function(e){return this.hostCallbacks&&this.hostCallbacks.isChangeGateEnabled?this.hostCallbacks.isChangeGateEnabled(e):Promise.resolve(!1)}}])}();var CM=30,du=function(){return OC().version},pu=function(){function n(r,e,t){var o=this;(0,LC.default)(this,n),this.sessionsByDocSessionId=new Map,this.isDeltaGeneratorEnabled=!1,this.disableSyncDeltaSending=!1,this.hasBeenInitialized=!1,this.telemetryLogger=null,this.settings={annotationsOrderingEnabled:!0,deltaOperationsEnabled:!1,checkIdbByFeatures:!0,defaultBatchingEnabled:!0,batchingWith20msIntervalEnabled:!0,onAnnotationsSubmittedEnabled:!1,httpFallbackEnabled:!0,reduceBatchOperationsEnabled:!1,batchMessagesEnabled:!1,dynamicRateControllerEnabled:!1,removeDuplicateFlights:!0,delayBeforeSocketClose:!0,annotationDoesNotExistOnService:!0,reducedPingPongRetryEnabled:!1,startQueueProcessingInOpen:!0,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:!1},this.isDownloaderCompatible=function(){if(o.settings.checkIdbByFeatures)return typeof Array!="undefined"&&typeof Array.from!="undefined"&&typeof URL!="undefined"&&typeof URL.createObjectURL!="undefined";if(typeof navigator!="undefined"&&navigator.userAgent){var s=navigator.userAgent;return!(!s.indexOf||s.indexOf("MSIE ")>0||s.indexOf("Trident/")>0)}else return!1},this.workerFactory=r||function(s){return s&&s===Ce.HttpFallback?new Ds:new Fl};var a=this.createDefaultSessionManagerFactory();this.sessionManagerFactory=function(){return(e==null?void 0:e.apply(void 0,arguments))||a.apply(void 0,arguments)},this.sessionFactory=t||function(s){return new oi(s)}}return(0,FC.default)(n,[{key:"init",value:function(e,t,o,a){var s=this,u,l,c,f,d,p,g,k,S,C,x,T=new E({operationName:"InitRuntime",resourceId:en(e),dimension1:this.hasBeenInitialized.toString()});T.start(),this.hasBeenInitialized=!0,this.hostCallbacks=o,this.gateUtils=new BC(this.hostCallbacks),this.clientMetadata=t,this.clientMetadata&&(this.clientMetadata.runtimeVersion=du()),this.telemetryLogger=new Bo(this.hostCallbacks),this.shouldAddLogger(T)?(v.addLogger(this.telemetryLogger),this.addLoggingAggregator(a)):(v.clearLoggers(),v.addLogger(this.telemetryLogger)),n.haveCalledInit=!0,this.annotationResultsProcessor=new DC(function(){return s.settings.annotationsOrderingEnabled}),this.inferenceServiceFactory=a.inferenceServiceFactory,T.dimension2=hs(kt.info).toString();var I=[];e&&(this.defaultServiceUrl=pe.convertServiceUrlToWebSocket(e),this.serviceProtocol=this.defaultServiceUrl.split(":")[0].toLowerCase()),I.push(pe.isChangeGateEnabled(this.hostCallbacks,"CheckIdbByFeatures").then(function(b){s.settings.checkIdbByFeatures=b})),I.push(this.isFeatureEnabled("AnnotationsOrderingEnabled",!0).then(function(b){s.settings.annotationsOrderingEnabled=b})),I.push(this.isFeatureEnabled("DefaultBatchingDisabled").then(function(b){var A;(A=s.settings).defaultBatchingEnabled&&(A.defaultBatchingEnabled=!b)})),I.push(this.isFeatureEnabled("HttpFallbackDisabled").then(function(b){var A;(A=s.settings).httpFallbackEnabled&&(A.httpFallbackEnabled=!b)})),I.push(this.isFeatureEnabled("BatchingWith20msIntervalDisabled").then(function(b){var A;(A=s.settings).batchingWith20msIntervalEnabled&&(A.batchingWith20msIntervalEnabled=!b)})),I.push(this.isFeatureEnabled("OnAnnotationsSubmittedDisabled").then(function(b){var A;(A=s.settings).onAnnotationsSubmittedEnabled&&(A.onAnnotationsSubmittedEnabled=!b)})),I.push(this.isFeatureEnabled("ReduceBatchOperationsEnabled").then(function(b){var A;(A=s.settings).reduceBatchOperationsEnabled||(A.reduceBatchOperationsEnabled=b)})),I.push(this.isFeatureEnabled("BatchMessagesEnabled").then(function(b){var A;(A=s.settings).batchMessagesEnabled||(A.batchMessagesEnabled=b)})),I.push(this.isFeatureEnabled("DynamicRateControllerEnabled").then(function(b){s.settings.dynamicRateControllerEnabled=b})),I.push(pe.isChangeGateEnabled(this.hostCallbacks,"DelayBeforeSocketClose").then(function(b){s.settings.delayBeforeSocketClose=b})),I.push(pe.isChangeGateEnabled(this.hostCallbacks,"AnnotationDoesNotExistOnService").then(function(b){s.settings.annotationDoesNotExistOnService=b})),I.push(pe.isFeatureEnabled(this.hostCallbacks,"ReducedPingPongRetryEnabled").then(function(b){var A;(A=s.settings).reducedPingPongRetryEnabled||(A.reducedPingPongRetryEnabled=b)})),I.push(pe.isChangeGateEnabled(this.hostCallbacks,"StartQueueProcessingInOpen").then(function(b){var A;(A=s.settings).startQueueProcessingInOpen||(A.startQueueProcessingInOpen=b)})),I.push(this.isFeatureEnabled("MaxNumberOfDeltaUpdateOpsPerItemPerBatch").then(function(b){var A;(A=s.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(A.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=b)}));var _={enableDeltas:!1,enableEarlyJoin:!1};I.push(Promise.all([this.isFeatureEnabled("DeltaOperationsEnabled").then(function(b){return _.enableDeltas=b}).catch(function(){return _.enableDeltas=!1}),this.isFeatureEnabled("EarlyJoinCompletionEnabled").then(function(b){return _.enableEarlyJoin=b}).catch(function(){return _.enableEarlyJoin=!1})]).then(function(){s.localWorkflowManager=new vC(a.modelDownloader&&s.isDownloaderCompatible()?a.modelDownloader:void 0,s.inferenceServiceFactory,_)}));var M=fr((u=t.flights)!==null&&u!==void 0?u:"");return this.isDeltaGeneratorEnabled=M.getBooleanValue("Microsoft.Office.WordOnline.AugloopDeltas",(l=a.isDeltaGeneratorEnabled)!==null&&l!==void 0?l:!1),this.disableSyncDeltaSending=M.getBooleanValue("Microsoft.Office.WordOnline.DisableSyncDeltaSending",(c=a.disableSyncDeltaSending)!==null&&c!==void 0?c:!1),this.syncDeltaTimeout=M.getIntValue("Microsoft.Office.WordOnline.SyncDeltaTimeout",a.syncDeltaTimeout),(f=this.settings).httpFallbackEnabled&&(f.httpFallbackEnabled=!M.getBooleanValue("HttpFallbackDisabled",!1)),(d=this.settings).defaultBatchingEnabled&&(d.defaultBatchingEnabled=!M.getBooleanValue("DefaultBatchingDisabled",!1)),(p=this.settings).batchingWith20msIntervalEnabled&&(p.batchingWith20msIntervalEnabled=!M.getBooleanValue("BatchingWith20msIntervalDisabled",!1)),(g=this.settings).reduceBatchOperationsEnabled||(g.reduceBatchOperationsEnabled=M.getBooleanValue("ReduceBatchOperationsEnabled",!1)),(k=this.settings).batchMessagesEnabled||(k.batchMessagesEnabled=M.getBooleanValue("BatchMessagesEnabled",!1)),(S=this.settings).removeDuplicateFlights&&(S.removeDuplicateFlights=M.getBooleanValue("RemoveDuplicateFlights",!0)),(C=this.settings).reducedPingPongRetryEnabled||(C.reducedPingPongRetryEnabled=M.getBooleanValue("ReducedPingPongRetryEnabled",!1)),(x=this.settings).maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled||(x.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled=M.getBooleanValue("maxNumberOfDeltaUpdateOpsPerItemPerBatch",!1)),T.setDataField("Flights",JSON.stringify(this.settings)),a&&a.loggableUrls&&Wl(a.loggableUrls),Promise.all(I).then(function(){s.batchOptions=a.batchOptions,!s.batchOptions&&s.settings.defaultBatchingEnabled&&(s.batchOptions={delayMs:1,maxInputSize:1e6,delayMsMax:50},s.settings.batchingWith20msIntervalEnabled&&(s.batchOptions.delayMs=20)),s.batchOptions&&!s.batchOptions.delayMsMax&&(s.batchOptions.delayMsMax=50),a&&a.networkMode&&(a.networkMode===Ce.HttpFallback&&(a.networkMode=s.settings.httpFallbackEnabled?Ce.HttpFallback:Ce.JSWebSockets),s.networkMode=a.networkMode,a.networkMode===Ce.LocalWorkflowsOnly&&(s.sessionManagerFactory=function(){return new Dr})),T.dimension0=JSON.stringify(s.batchOptions),s.logOperation(T,!0)}).catch(function(b){s.logOperation(T,!1,"Error",b?b.message:"(no error)")})}},{key:"getServiceProtocol",value:function(){return this.serviceProtocol}},{key:"registerLocalWorkflow",value:function(e){this.localWorkflowManager.registerLocalWorkflow(e)}},{key:"flushTelemetry",value:function(e){v.flushAggregators(e)}},{key:"createSession",value:function(e){var t,o=e&&e.docSessionId?e.docSessionId:Zt(),a=e&&e.documentId?e.documentId:void 0,s=this.sessionsByDocSessionId.get(o),u=new E({operationName:"CreateSession",resourceId:o,dimension1:this.hasBeenInitialized.toString()});if(u.start(),s&&s.isClosed===!1)throw this.logOperation(u,!1,"Error","docSessionId already exists"),new Error("docSessionId already exists");var l=e?(t=e.serviceUrl)!==null&&t!==void 0?t:this.defaultServiceUrl:this.defaultServiceUrl;l=pe.convertServiceUrlToWebSocket(l),l||(e=e||{},e.networkMode=Ce.LocalWorkflowsOnly),this.networkMode&&((e==null?void 0:e.networkMode)===void 0||(e==null?void 0:e.networkMode)===null)&&(e=e||{},e.networkMode=this.networkMode),((e==null?void 0:e.networkMode)===void 0||(e==null?void 0:e.networkMode)===null||(e==null?void 0:e.networkMode)===Ce.JSWebSockets)&&this.hasHttpFallbackSession()&&(e=e||{},e.networkMode=Ce.HttpFallback),e&&e.networkMode===Ce.HttpFallback&&(e.networkMode=this.settings.httpFallbackEnabled?Ce.HttpFallback:Ce.JSWebSockets);var c=Object.assign({},this.clientMetadata);c.docSessionId=o,a&&(c.documentId=a),e&&e.flights&&(c.flights=c.flights?c.flights+";"+e.flights:e.flights),this.settings.removeDuplicateFlights&&c.flights&&(c.flights=ad(c.flights)),u.setDataField("Flights",c.flights||"");var f=this.sessionFactory({hostCallbacks:this.hostCallbacks,sessionManager:this.sessionManagerFactory(c,l,e),batchOptions:this.batchOptions,extensionConfigs:(e==null?void 0:e.extensionConfigs)||[],clientMetadata:c,userContext:e?e.userContext:void 0,localWorkflowManager:e&&e.enableComplexLocalWorkflows?void 0:this.localWorkflowManager,annotationResultsProcessor:this.annotationResultsProcessor,localRegisteredWorkflows:(e==null?void 0:e.localRegisteredWorkflows)||[],enableRemoteExecutionNotification:(e==null?void 0:e.enableRemoteExecutionNotification)||!1,networkMode:e==null?void 0:e.networkMode,egress:e?e.egress:void 0,isDeltaGeneratorEnabled:this.isDeltaGeneratorEnabled,onAnnotationsSubmittedEnabled:this.settings.onAnnotationsSubmittedEnabled,disableSyncDeltaSending:this.disableSyncDeltaSending,syncDeltaTimeout:this.syncDeltaTimeout,reduceBatchOperationsEnabled:this.settings.reduceBatchOperationsEnabled,batchMessagesEnabled:this.settings.batchMessagesEnabled,annotationDoesNotExistOnServiceEnabled:this.settings.annotationDoesNotExistOnService,maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled:this.settings.maxNumberOfDeltaUpdateOpsPerItemPerBatchEnabled});return this.sessionsByDocSessionId.set(o,f),e&&e.onSessionConnect&&f.setConnectCallback(e.onSessionConnect),e&&e.onSessionDisconnect&&f.setDisconnectCallback(e.onSessionDisconnect),e&&e.onSessionReconnect&&f.setReconnectCallback(e.onSessionReconnect),e&&e.onSessionClose&&f.setSessionCloseCallback(e.onSessionClose),e&&e.onServerAuthenticationStateChangeCallback&&f.setServerAuthenticationStateChangeCallback(e.onServerAuthenticationStateChangeCallback),e&&e.onClaimsChallengeCallback&&f.setClaimsChallengeCallback(e.onClaimsChallengeCallback),this.logOperation(u,!0),f.initialize?f.initialize():Promise.resolve(f)}},{key:"getSessionManagerFactory",value:function(){return this.sessionManagerFactory}},{key:"shouldAddLogger",value:function(e){if(n.haveCalledInit){var t=new Error("Runtime already initialized");return e.dimension3=t.stack,e.dimension2=hs(kt.info).toString(),this.logOperation(e,!1,"Error",t.message),!1}else return!0}},{key:"createDefaultSessionManagerFactory",value:function(){var e=this;return function(t,o,a){if(a&&a.enableComplexLocalWorkflows)throw new Error("NYI");if(a&&a.networkMode==Ce.LocalWorkflowsOnly)return new Dr;var s=new gr,u=new Fa,l=function(){v.error(573321615,y.CoreDefault,"Unexpectedly not set sendMessage")},c=new $a(function(){return u},t,s,function(d,p,g){l(d,p,g)},{requestAuthToken:e.hostCallbacks.requestAuthToken,overrideSessionInitMessage:e.hostCallbacks.overrideSessionInitMessage,enableRemoteExecutionNotification:(a==null?void 0:a.enableRemoteExecutionNotification)||!1}),f=new xc(pe.convertServiceUrlToWebSocket(o),u,e.workerFactory,c,t,s,e.settings,e.gateUtils,a==null?void 0:a.networkMode);return l=f.sendMessage.bind(f),f.on("disconnect",function(){return s.clearRefreshTimeouts()}),f.on("connect",function(d,p,g,k){d&&e.hostCallbacks.setSessionData&&e.hostCallbacks.setSessionData(p,g,k);var S=p.substring(p.lastIndexOf("/")+1);e.telemetryLogger.setServerSessionKey(S)}),f}}},{key:"isFeatureEnabled",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return pe.isFeatureEnabled(this.hostCallbacks,e,t,o)}},{key:"hasHttpFallbackSession",value:function(){var e=!1;return this.sessionsByDocSessionId.forEach(function(t){t.isHttpFallback()&&(e=!0)}),e}},{key:"logOperation",value:function(e,t,o,a){e.stop(),e.success=t,e.resultSignature=o,e.resultDescription=a,v.info(573321622,y.CoreDefault,e)}},{key:"addLoggingAggregator",value:function(e){var t,o,a,s;pe.isChangeGateEnabled(this.hostCallbacks,"AggregateInProductionOnly")&&this.clientMetadata.releaseAudienceGroup==="Dogfood"||(v.addAggregator(Ro("Operation","operationName",["ExecuteBatch","ReduceBatchOperations","ProcessResponse","LocalDeltaUpdate","ApplyFormattedTextTileDeltaForLocalWorkflows","ApplyTextTileDeltaForLocalWorkflows","FindRangeForDelta","RunModelForInferencing","GetResource","CreateTextTileDeltaFromItem","NetworkEgressControl","HttpEgress","LongPollNoOp","NetworkRateControllerAbandonedSyncMessage","NetworkRateControllerEgress","NetworkRateControllerQueueItem","NetworkRateControllerOnRateLimitResponse","NetworkRateControllerOnRateLimitError","NetworkRateControllerRateLimitsSet","NetworkRateControllerQueueItem"],(t=e.telemetryAggregationIntervalSec)!==null&&t!==void 0?t:CM)),v.addAggregator(Ro("Operation","operationName",["ExecuteWorkflow","ExecuteLambda","EarlyJoinCompletion","OnLongPollMessage","OnAnnotationResultsEgress"],(o=e.telemetryAggregationIntervalSec)!==null&&o!==void 0?o:60)),v.addAggregator(Ro("Operation","operationName",["LocalScopeExecutionNotification","RunLocalWorkflows","EarlyJoinCompletion","SetAnnotations","WIS.addItemOnContextIdList","WIS.setScopeItem"],(a=e.telemetryAggregationIntervalSec)!==null&&a!==void 0?a:120)),v.addAggregator(Ro("SessionHealth","sessionHealthEventName",["SendMessage","ProcessMessage"],(s=e.telemetryAggregationIntervalSec)!==null&&s!==void 0?s:60)))}},{key:"uninitialize",value:function(){this.flushTelemetry(!0),this.hostCallbacks=null,this.hasBeenInitialized=!1,this.telemetryLogger=null,n.haveCalledInit=!1,v.clearAggregators(),v.clearLoggers()}}])}(),gu=new pu;h();var qC=w(P()),$C=w(R()),GC=function(){function n(){(0,qC.default)(this,n),this.cache=new Map}return(0,$C.default)(n,[{key:"setReduceTimer",value:function(e,t,o){var a=this,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,u=arguments.length>4&&arguments[4]!==void 0?arguments[4]:function(){return!1},l=arguments.length>5&&arguments[5]!==void 0?arguments[5]:5e3;this.cache.has(e)||this.cache.set(e,new Map);var c=this.cache.get(e);c.has(t)&&clearTimeout(c.get(t).timer);var f=function(){var p=c.get(t),g=Date.now()-p.start;u()&&g<l?p.timer=setTimeout(p.timerCallback,Math.min(s,l-g)):(c.size>1?c.delete(t):a.cache.delete(e),o())};c.set(t,{start:Date.now(),timerCallback:f,timer:setTimeout(f,s)})}},{key:"clear",value:function(e,t){this.cache.forEach(function(o,a){(!e||e===a)&&o.forEach(function(s,u){(!t||t===u)&&clearTimeout(s.timer)})}),this.cache.clear()}}])}();h();h();var UC=w(R()),HC=w(P());var hu=function(){function n(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:33e5;(0,HC.default)(this,n),this.tokenCache=new Map,this.requestMap=new Map,this.requestRecordMap=new Map,this.tokenExpirationMs=r}return(0,UC.default)(n,[{key:"updateAuthToken",value:function(e,t){var o=this,a=JSON.stringify(t),s=this.requestRecordMap.get(a);return(s===void 0||this.isTokenExpired(s))&&(s={requestPromise:e.requestAuthToken(t).then(function(u){if(!u||!u.Token)throw new Error(`No token available for request ${a}`);o.tokenCache.set(a,u.Token)}),requestTime:pe.getCurrentTimeMs()},this.requestRecordMap.set(a,s)),s.requestPromise}},{key:"getAuthTokenEntries",value:function(e,t){var o=this;return Array.from(this.tokenCache.keys()).map(function(a){var s=o.requestMap.get(a);return s===void 0&&(s=JSON.parse(a),o.requestMap.set(a,s)),{requestKey:a,request:s}}).filter(function(a){var s=a.request;return t?s.DocId===t:!0}).map(function(a){var s=a.requestKey,u=a.request;return o.isTokenExpired(o.requestRecordMap.get(s))&&o.updateAuthToken(e,u),{ticket:u.Tickets[0],token:o.tokenCache.get(s)}})}},{key:"isTokenExpired",value:function(e){return pe.getCurrentTimeMs()>e.requestTime+this.tokenExpirationMs}}])}();var mu,Yd=function(){mu=new hu};Yd();var Kd=function(r,e,t,o,a,s,u,l,c,f){var d={method:"POST",headers:{"content-type":"application/json","X-CorrelationId":a},body:JSON.stringify({payload:e.payload,payloadSchema:t,requestedSchema:o,clientMetadata:s,tokens:mu.getAuthTokenEntries(u,c.docId)})};Vr(r,d,function(p,g){p?f(new Error(`Fetch error in remote lambda request to ${r}: ${p}`)):g.status===401?l>0?(v.info(572838109,y.CoreDefault,"Auth token required for remote lambda request"),g.json().then(function(k){return mu.updateAuthToken(u,{Tickets:[k],DocId:c.docId})}).then(function(){Kd(r,e,t,o,a,s,u,l-1,c,f)}).catch(function(k){f({exceptionType:Te.Authentication,message:k.message})})):f({exceptionType:Te.Authentication,message:"Remote lambda request retry with authentication token failed"}):g.ok?g.json().then(function(k){if(!Array.isArray(k))f(new Error("Did not receive a valid response for remote lambda request"));else if(k.length>0){var S=0;for(var C of k)e.moreResults=++S<k.length,f(null,C)}else f(new Error("No output"))}).catch(function(k){f({exceptionType:Te.LambdaThrow,message:k.message})}):f(new Error(`Remote lambda request failed with status ${g.status}`))})},zC=function(r,e,t,o,a,s,u,l,c){Array.isArray(l.authTickets)?mu.updateAuthToken(u,{Tickets:l.authTickets,DocId:l.docId}).then(function(){Kd(r,e,t,o,a.id,s,u,1,l,c)}).catch(function(f){c({exceptionType:Te.Authentication,message:f.message})}):Kd(r,e,t,o,a.id,s,u,1,l,c)};h();h();var VC=w(P()),QC=w(R()),jC=w(Ol());var ii=function(){function n(){(0,VC.default)(this,n),this.hasBeenOpened=!1,this.hadEgressError=!1,this.lastEgressTime=0,this.lastPongTime=0,this.remainingPingFailures=3,this.egressMessageCount=0,this.egressByteCount=0,this.isClosing=!1,this.pendingEgress=[]}return(0,QC.default)(n,[{key:"init",value:function(e,t,o,a){var s=this;this.ws=new jC.default(e),this.logOp=new E({operationName:n.className,success:!0,dimension1:"V1"}).start(),this.egressTimer=Date.now(),this.egressMessageCountOp=new E({operationName:"WSEgressMessageCount",success:!0,dimension1:"V1"}),this.egressByteCountOp=new E({operationName:"WSEgressByteOrderOfMagnitude",success:!0,dimension1:"V1"}),this.ingressByteCountOp=new E({operationName:"WSIngressByteOrderOfMagnitude",success:!0,dimension1:"V1"});var u=function(c){s.logPingLatencyOp&&(s.logPingLatencyOp.success=c,v.info(507789790,y.CoreDefault,s.logPingLatencyOp.stop()),s.logPingLatencyOp=void 0)};this.ws.addEventListener("open",function(l){o(),n.logCountLimiter.log(function(){s.logOp.resourceId="OnOpen",s.logOp.resultDescription="",s.logOp.success=!0,s.logOp.dimension0=s.pendingEgress.length.toString(),v.info(507789789,y.CoreDefault,s.logOp.stop())}),s.hasBeenOpened=!0,s.pendingEgress.forEach(function(c){s.egress({obj:c})}),s.pendingEgress=[],s.pingInterval=setInterval(function(){s.logPingLatencyOp&&(--s.remainingPingFailures,u(!1)),s.remainingPingFailures>0&&s.hasBeenOpened&&s.lastPongTime<s.lastEgressTime&&(s.logPingLatencyOp=new E({operationName:"Ping",success:!0,dimension0:s.ws.bufferedAmount>=0?s.ws.bufferedAmount.toString().length.toString():void 0,dimension1:"V1"}).start(),s.ws.send(n.pingPongMessage,function(c){c&&(--s.remainingPingFailures,u(!1))}))},3e4)}),this.ws.addEventListener("message",function(l){s.logPingLatencyOp&&typeof l.data=="string"&&l.data.length===1&&l.data[0]===n.pingPongMessage?(u(!0),s.lastPongTime=Date.now()):(s.logIngressCount(l.data),t(l.data))}),this.ws.addEventListener("error",function(l){s.errorMessage=l.message,n.logCountLimiter.log(function(){s.logOp.resourceId="OnError",s.logOp.resultDescription=s.errorMessage,s.logOp.success=!1,v.info(507789788,y.CoreDefault,s.logOp.stop())}),s.ws.close()}),this.ws.addEventListener("close",function(l){n.logCountLimiter.log(function(){s.logOp.resourceId="OnClose",s.logOp.resultDescription=l?`code: ${l.code}. reason: ${l.reason}`:"",s.logOp.success=!0,v.info(507789787,y.CoreDefault,s.logOp.stop())}),s.pingInterval&&(clearInterval(s.pingInterval),s.pingInterval=void 0),a(s.errorMessage),s.isClosing=!1})}},{key:"egress",value:function(e){var t=this,o=e.obj;this.logEgressCount(o instanceof ArrayBuffer||o instanceof Uint8Array?o.byteLength:o.length),this.lastEgressTime=Date.now(),this.hasBeenOpened?this.ws.send(o,function(a){a&&!t.hadEgressError&&(t.hadEgressError=!0,n.logCountLimiter.log(function(){t.logOp.resourceId="OnFirstEgressError",t.logOp.resultDescription=a.message,t.logOp.success=!1,v.info(507789786,y.CoreDefault,t.logOp.stop())}))}):this.pendingEgress.push(o)}},{key:"close",value:function(){this.isClosing||(this.isClosing=!0,this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=void 0),this.ws.close())}},{key:"logEgressCount",value:function(e){var t=Date.now(),o=t-this.egressTimer;o>1e3&&(this.egressMessageCount>50&&(this.egressMessageCountOp.start(),this.egressMessageCountOp.resultDescription="Egress message count: "+this.egressMessageCount.toString()+", Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+o.toString(),v.info(507789785,y.CoreDefault,this.egressMessageCountOp.stop())),this.egressByteCount>1e5&&(this.egressByteCountOp.start(),this.egressByteCountOp.dimension2=this.egressByteCount.toString().length.toString(),this.egressMessageCountOp.resultDescription="Buffered amount: "+(this.ws.bufferedAmount>=0?this.ws.bufferedAmount.toString():"-")+", Time elapsed: "+o.toString(),v.info(507789784,y.CoreDefault,this.egressByteCountOp.stop())),this.egressTimer=t,this.egressMessageCount=0,this.egressByteCount=0),this.egressMessageCount++,this.egressByteCount+=e!=null?e:0}},{key:"logIngressCount",value:function(e){var t=e.length;t>1e5&&(this.ingressByteCountOp.start(),this.ingressByteCountOp.dimension2=t.toString().length.toString(),v.info(507789783,y.CoreDefault,this.ingressByteCountOp.stop()))}}])}();ii.className="WebSocketWorker";ii.logCountLimiter=new to(ii.className);ii.pingPongMessage="~";h();var Xd=w(P()),Zd=w(R());var TM=function(){function n(r,e,t,o,a,s){(0,Xd.default)(this,n),this.requestId=r,this.correlationId=e,this.schemaName=t,this.data=o,this.callback=a,this.requestTimeoutInMs=s,this.ended=!1,this.startTime=0}return(0,Zd.default)(n,[{key:"startRequest",value:function(){this.startTime=pe.getCurrentTimeMs()}},{key:"getMsUntilTimeout",value:function(){var e=pe.getCurrentTimeMs()-this.startTime;return this.requestTimeoutInMs-e}},{key:"endRequest",value:function(e){this.ended||(this.invokeCallback(null,e,!0),this.ended=!0)}},{key:"addResponseData",value:function(e){this.invokeCallback(e,null,!1)}},{key:"invokeCallback",value:function(e,t,o){var a=this;new Promise(function(){return a.callback(e,t,o)}).catch(function(s){})}}])}(),JC=function(){function n(r,e,t){(0,Xd.default)(this,n),this.requestCounter=0,this.activeRequests=[],this.pendingRequests=[],this.requestTimeoutInMs=r,this.workerFactory=e,this.maxActiveRequests=t}return(0,Zd.default)(n,[{key:"testConnection",value:function(e,t){var o=this,a=!1,s=new E({cv:new Je().toString(),operationName:"WebSocketTest",resourceId:en(e),success:!0}).start();return new Promise(function(u){var l=pe.createHealthCheckRequest(t);e?o.addRequest(e,l,s.cv,"HealthCheckRequest",function(c,f,d){f&&(s.success=!1,s.resultSignature="Error",s.resultDescription=f.message||f),c&&c.status==="OK"&&(a=!0),d&&(s.success&&!a&&(s.success=!1,s.resultSignature="NoResponseData"),v.info(556617949,y.CoreDefault,s.stop()),u(s.success))}):(s.success=!1,s.resultSignature="EmptyUrl",v.info(557641870,y.CoreDefault,s.stop()),u(s.success))})}},{key:"addRequest",value:function(e,t,o,a,s){var u=(this.requestCounter++).toString(),l=new TM(u,o,a,t,s,this.requestTimeoutInMs);this.getWorker(e),this.pendingRequests.push(l),this.egressPendingRequests()}},{key:"egressPendingRequests",value:function(){for(;this.pendingRequests.length>0&&this.activeRequests.length<this.maxActiveRequests;){var e=this.pendingRequests.shift();if(this.activeRequests.push(e),this.activeRequests.length===1){var t=e.getMsUntilTimeout();setTimeout(this.onTimeout.bind(this),t)}e.startRequest(),this.worker&&this.worker.egress({obj:this.createRequestMessage(e.data,e.requestId,e.correlationId)})}}},{key:"createRequestMessage",value:function(e,t,o){return JSON.stringify({correlationId:o,requestId:t,body:e})}},{key:"onTimeout",value:function(){for(;this.activeRequests.length>0;){var e=this.activeRequests[0],t=e.getMsUntilTimeout();if(t<=0){var o=new Error("Request timed out");e.endRequest(o),this.activeRequests.shift(),this.egressPendingRequests()}else{setTimeout(this.onTimeout.bind(this),t);return}}}},{key:"onMessage",value:function(e){try{for(var t=JSON.parse(e),o=0;o<this.activeRequests.length;o++){var a=this.activeRequests[o];if(a.requestId===t.requestId){t.end?(this.activeRequests.splice(o,1),a.endRequest(t.error),this.egressPendingRequests()):t.body&&a.addResponseData(t.body);break}}}catch(s){v.error(557641871,y.CoreDefault,s)}}},{key:"onClose",value:function(e){var t=new Error(`Connection closed: ${e}`);for(var o of this.activeRequests)o.endRequest(t);this.activeRequests=[];for(var a of this.pendingRequests)a.endRequest(t);this.pendingRequests=[],this.worker=void 0}},{key:"getWorker",value:function(e){return this.worker||(this.worker=this.workerFactory(),this.worker.init(e,this.onMessage.bind(this),function(){},this.onClose.bind(this))),this.worker}}])}();var IM=3e4,_M=50,vu,tp=function(){vu=new hu};tp();var KC=new JC(IM,function(){return new ii},_M),ep=function(r,e,t,o,a,s,u,l,c,f){var d={payload:e.payload,payloadSchema:t,requestedSchema:o,clientMetadata:s,tokens:vu.getAuthTokenEntries(u,c.docId)},p="";o&&o.schema&&(p=o.schema.name);var g=!1;KC.addRequest(r,d,a,p,function(k,S,C){if(!g)if(g=!0,S!=null)if(S.exceptionType===Te.Authentication)try{var x=JSON.parse(S.data);l>0?(v.info(572838108,y.CoreDefault,"Auth token required for remote lambda WebSocket request"),vu.updateAuthToken(u,{Tickets:[x],DocId:c.docId}).then(function(){ep(r,e,t,o,a,s,u,l-1,c,f)}).catch(function(T){f({exceptionType:Te.Authentication,message:T.message})})):f({exceptionType:Te.Authentication,message:"Remote lambda request retry with authentication token failed"})}catch(T){f({exceptionType:Te.Authentication,message:T.message})}else f(new Error(`Error in remote lambda WebSocket request to ${r}: ${S}`));else e.moreResults=!1,f(null,k)})},YC=function(r,e,t,o,a,s,u,l,c){Array.isArray(l.authTickets)?vu.updateAuthToken(u,{Tickets:l.authTickets,DocId:l.docId}).then(function(){ep(r,e,t,o,a.id,s,u,1,l,c)}).catch(function(f){c({exceptionType:Te.Authentication,message:f.message})}):ep(r,e,t,o,a.id,s,u,1,l,c)},XC=function(r,e){return KC.testConnection(r,e)};h();var ZC=w(P()),ex=w(R()),tx=function(){function n(){(0,ZC.default)(this,n),this.cache=new Map,this.bucketSizes=new Map}return(0,ex.default)(n,[{key:"setBucketSize",value:function(e,t){this.bucketSizes.set(e,t)}},{key:"setResult",value:function(e,t,o){if(t.primary){var a=this.cache.get(e);a||(a=new Map,this.cache.set(e,a));var s=a.get(t.primary);if(s||(s=t.secondary?new Map:[],a.set(t.primary,s)),t.secondary){var u=s;u.set(t.secondary,o)}else{var l=s;l.length==this.getBucketSize(e)&&l.shift(),l.push(o)}}}},{key:"getResults",value:function(e,t){var o=this.cache.get(e);if(o){var a=o.get(t.primary);if(a){if(!t.secondary)return a;var s=Array.from(a.values());if(s.length>0)return s}}return[]}},{key:"clear",value:function(e,t){t?this.cache.forEach(function(o,a){if(!e||e===a)if(t.secondary){var s=o.get(t.primary);s&&s.delete(t.secondary)}else o.delete(t.primary)}):e?this.cache.delete(e):this.cache.clear()}},{key:"getBucketSize",value:function(e){return this.bucketSizes.get(e)||10}}])}();h();var ce;(function(n){n[n.Unknown=0]="Unknown",n[n.Local=1]="Local",n[n.Custom=2]="Custom",n[n.Remote=3]="Remote",n[n.BatchedRemote=4]="BatchedRemote"})(ce||(ce={}));h();var nx=w(P()),rx=w(R());var ox=function(){function n(){(0,nx.default)(this,n),this.throttleInfoMap=new Map}return(0,rx.default)(n,[{key:"execute",value:function(e,t,o){var a=this;if(!t.throttleSettings.shouldBeThrottled||!(t.throttleSettings.throttlingInterval>0))o();else{var s=this.getWorkflowThrottleInfo(t.name);if(s.currentTileId==null)s.currentTileId=e,s.timeOfPreviousStartedEvent=pe.getCurrentTimeMs(),o();else if(s.currentTileId===e){var u=pe.getCurrentTimeMs(),l=this.delayTime(s,u,t.throttleSettings.throttlingInterval);l>0?(s.latestCallback=o,s.lastTimeout==null&&(s.lastTimeout=setTimeout(function(){var c=a.getWorkflowThrottleInfo(t.name);c.lastTimeout=void 0,c.timeOfPreviousStartedEvent=pe.getCurrentTimeMs(),c.latestCallback()},l))):(s.timeOfPreviousStartedEvent=u,o())}else s.lastTimeout!=null&&(clearTimeout(s.lastTimeout),s.latestCallback(),s.lastTimeout=void 0),s.currentTileId=e,s.timeOfPreviousStartedEvent=pe.getCurrentTimeMs(),o()}}},{key:"delayTime",value:function(e,t,o){var a=t-e.timeOfPreviousStartedEvent;return Math.max(o-a,0)}},{key:"getWorkflowThrottleInfo",value:function(e){var t=this.throttleInfoMap.get(e);return t||(t={currentTileId:void 0,timeOfPreviousStartedEvent:-1,latestCallback:function(){},lastTimeout:void 0},this.throttleInfoMap.set(e,t)),t}}])}();var $n;(function(n){n[n.Restricted=0]="Restricted",n[n.Unrestricted=1]="Unrestricted",n[n.Suppressed=2]="Suppressed"})($n||($n={}));var np=function(){function n(){(0,rp.default)(this,n),this.canaryTextTileEventSubmittedByDocSessionId=new Set,this.stateByDocSessionId=new Map,this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map}return(0,op.default)(n,[{key:"getOutputSchema",value:function(){return this.lambdas[this.lambdas.length-1].outputSchema}},{key:"scheduleExecution",value:function(e,t){var o=this.docSessionIdExtractor?this.docSessionIdExtractor(e):void 0,a=this.getStateForDocSessionId(o);if(a===$n.Restricted){var s=this.getExecutionQueueForDocSessionId(o);s.push(t),s.length===1&&t()}else a===$n.Unrestricted?t():$n.Suppressed}},{key:"onStart",value:function(e){this.incrementExecutionCountForDocSessionId(e)}},{key:"onFinish",value:function(e,t){if(this.decrementExecutionCountForDocSessionId(e),t===Te.Authentication)this.stateByDocSessionId.set(e,$n.Suppressed),this.executionQueueByDocSessionId.delete(e);else if(this.stateByDocSessionId.get(e)===$n.Restricted){var o=this.getExecutionQueueForDocSessionId(e);if(o.shift(),t===void 0){this.stateByDocSessionId.set(e,$n.Unrestricted),this.executionQueueByDocSessionId.delete(e);for(var a of o)a()}else if(o.length>0){var s=o[0];s()}}}},{key:"onRefresh",value:function(e){this.stateByDocSessionId=new Map,this.triggerOnRefresh&&(e?(this.executionQueueByDocSessionId.delete(e),this.executionCountByDocSessionId.delete(e)):(this.executionQueueByDocSessionId=new Map,this.executionCountByDocSessionId=new Map)),this.canaryTextTileEventSubmittedByDocSessionId.delete(e)}},{key:"getStateForDocSessionId",value:function(e){var t=this.stateByDocSessionId.get(e);return t===void 0&&(t=n.executionQueuesEnabled?$n.Restricted:$n.Unrestricted,this.stateByDocSessionId.set(e,t)),t}},{key:"getExecutionQueueForDocSessionId",value:function(e){var t=this.executionQueueByDocSessionId.get(e);return t===void 0&&(t=[],this.executionQueueByDocSessionId.set(e,t)),t}},{key:"incrementExecutionCountForDocSessionId",value:function(e){var t=this.executionCountByDocSessionId.get(e)||0;this.executionCountByDocSessionId.set(e,t+1)}},{key:"decrementExecutionCountForDocSessionId",value:function(e){var t=this.executionCountByDocSessionId.get(e)||0;t<=1?this.executionCountByDocSessionId.delete(e):this.executionCountByDocSessionId.set(e,t-1)}}])}();np.executionQueuesEnabled=!0;var Wr=function(r){return{category:En.Schema,schema:{name:r}}},Ua="Tiling.TextTileEvent",ip="ClpSlideTile",bM=function(r,e){return r===Ua&&e&&e.type==Vn.TextTileEventType.Delete||r===ip&&e&&e.eventType==Ii.SlideTileEventType.Delete},ax=function(r,e){return r===Ua&&e&&e.type==Vn.TextTileEventType.Refresh},sx=function(r,e){return r===ip&&e&&e.eventType==Ii.SlideTileEventType.Refresh},ix=function(r,e){return ax(r,e)||sx(r,e)},MM=function(r,e){var t,o;return ax(r,e)?(o=(t=e.tile)===null||t===void 0?void 0:t.metadata)===null||o===void 0?void 0:o.seqnoCLPRefresh:(sx(r,e),-1)},yu=function(r,e){var t,o;if(r===Ua)return(o=(t=e.tile)===null||t===void 0?void 0:t.metadata)===null||o===void 0?void 0:o.docSessionId;if(r===ip)return e.docId},EM=function(r){return{type:r.type,tile:{metadata:{docSessionId:r.tile.metadata.docSessionId,docId:r.tile.metadata.docId,seqnoCLPRefresh:r.tile.metadata.seqnoCLPRefresh,tileId:"A56B3127DBDFD0D6"},elements:[{text:"B91153AE828B4E48"}]}}},NM=function(){function n(){(0,rp.default)(this,n),this.inputSchemasToWorkflows=new Map,this.inputSchemasToReduceWorkflows=new Map,this.reduceWorkflowsGroupingKeyExtractors=new Map,this.defaultWorkflowOptions={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},triggerOnRefresh:!1},this.resultCache=new tx,this.reduceTimerCache=new GC,this.lookupTableCache=new Map,this.throttling=new ox,this.lastTileRefreshSeq=-1,this.lastTileRefreshSeqByDocSessionId=new Map,this.tileRefreshByDocSessionIdEnabled=!0}return(0,op.default)(n,[{key:"init",value:function(e,t,o){var a=this,s=new E({operationName:"InitRuntimeALv1",resourceId:en(e)});s.start(),this.clientMetadata=t,this.clientMetadata&&(this.clientMetadata.runtimeVersion=du()),this.hostCallbacks=o;var u=[];return u.push(this.isFeatureEnabled("DisableWebSocket").then(function(l){var c=!l;if(!c)return!1;var f=["Outlook Mac","Outlook Win32","PowerPoint Mac","PowerPoint Web","PowerPoint Win32","Word Mac","Word Win32"];return f.indexOf(`${t.appName} ${t.appPlatform}`)>=0?XC(pe.convertServiceUrlToWebSocket(e),a.clientMetadata):!0}).then(function(l){e&&(a.serviceUrl=l?pe.convertServiceUrlToWebSocket(e):e,a.executeRemoteLambda=l?YC:zC,a.clearRemoteLambdaTokenCache=l?tp:Yd,a.serviceProtocol=a.serviceUrl.split(":")[0].toLowerCase())})),u.push(this.isFeatureEnabled("WorkflowQueuesDisabled").then(function(l){np.executionQueuesEnabled=!l})),u.push(this.isFeatureEnabled("TileRefreshByDocSessionIdDisabled").then(function(l){a.tileRefreshByDocSessionIdEnabled=!l})),Promise.all(u).then(function(){a.logOperation(s,!0)}).catch(function(l){a.logOperation(s,!1,"Error",l?l.message:"(no error)")})}},{key:"getServiceProtocol",value:function(){return this.serviceProtocol}},{key:"registerSchemas",value:function(e,t){return Promise.resolve()}},{key:"registerSimpleLocalWorkflow",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.defaultWorkflowOptions;return t.source=t.source||ce.Custom,this.registerHardcodedWorkflow(e,[t],this.inputSchemasToWorkflows,o)}},{key:"registerSimpleRemoteWorkflow",value:function(e,t,o,a){var s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions,u=[];return t&&(t.source=ce.Custom,u.push(t)),o.source=o.func?ce.Custom:ce.Remote,u.push(o),a&&(a.source=ce.Custom,u.push(a)),this.registerHardcodedWorkflow(e,u,this.inputSchemasToWorkflows,s)}},{key:"registerMultipleLambdasWorkflow",value:function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.defaultWorkflowOptions;return this.registerHardcodedWorkflow(e,t,this.inputSchemasToWorkflows,o)}},{key:"registerReduceWorkflow",value:function(e,t,o){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions;return this.reduceWorkflowsGroupingKeyExtractors.set(t.inputSchema,o),this.resultCache.setBucketSize(t.inputSchema,a),t.source=t.source||ce.Custom,this.registerHardcodedWorkflow(e,[t],this.inputSchemasToReduceWorkflows,s)}},{key:"registerMultipleLambdasReduceWorkflow",value:function(e,t,o){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:10,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:this.defaultWorkflowOptions;return this.reduceWorkflowsGroupingKeyExtractors.set(t[0].inputSchema,o),this.resultCache.setBucketSize(t[0].inputSchema,a),this.registerHardcodedWorkflow(e,t,this.inputSchemasToReduceWorkflows,s)}},{key:"submit",value:function(e,t,o){this.submitToWorkflows(e,t,o,this.inputSchemasToWorkflows)}},{key:"getGroupingKey",value:function(e,t,o){var a=this.reduceWorkflowsGroupingKeyExtractors.get(o);if(a==null)throw new Error("Reduce workflow does not have a grouping extractor");return a(t,e)}},{key:"submitToWorkflows",value:function(e,t,o){var a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:this.inputSchemasToWorkflows;if(this.hostCallbacks){var s;o?s=Je.fromString(o):s=new Je,this.handleTileRefresh(e,t,s);var u=a.get(e)||[];for(var l of u)ix(e,t)&&!l.triggerOnRefresh||(l.useCanaryTextTile&&e===Ua&&!l.canaryTextTileEventSubmittedByDocSessionId.has(yu(e,t))&&(this.submitToWorkflow(Ua,EM(t),s,l,a),l.canaryTextTileEventSubmittedByDocSessionId.add(yu(e,t))),this.submitToWorkflow(e,t,s,l,a))}}},{key:"submitToWorkflow",value:function(e,t,o,a,s){var u=this,l={messageType:vn.Input,correlationVector:o.newChild(),payload:t,payloadSchema:Wr(a.lambdas[0].inputSchema),clientMetadata:this.clientMetadata},c=new E({cv:l.correlationVector.toString(),operationName:"ExecuteWorkflow",resourceId:a.name});c.setClientMetadata(this.clientMetadata),c.start(),a.scheduleExecution(t,function(){try{if(!l.payload||!l.payload.tile||!l.payload.tile.metadata||!l.payload.tile.metadata.tileId)u.executeWorkflow(c,l,t,a,e,s);else{var f=l.payload.tile.metadata.tileId;u.throttling.execute(f,a,function(){return u.executeWorkflow(c,l,t,a,e,s)})}}catch(d){c.success=!1,c.resultSignature="ExecuteException",c.resultDescription=d?d.message:"(no error)",v.error(559290447,y.CoreDefault,c.stop())}})}},{key:"handleTileRefresh",value:function(e,t,o){var a=this;if(ix(e,t)){var s=this.tileRefreshByDocSessionIdEnabled?yu(e,t):void 0,u=MM(e,t);if(this.tileRefreshByDocSessionIdEnabled){var l=this.lastTileRefreshSeqByDocSessionId.get(s);if(l>=0&&u<=l)return}else if(u<=this.lastTileRefreshSeq)return;var c=new E({cv:o.toString(),operationName:"TileRefresh",resultDescription:"",success:!0});if(c.start(),this.tileRefreshByDocSessionIdEnabled&&!s){c.success=!1,c.resultDescription="NoDocSessionId",v.info(559290448,y.CoreDefault,c.stop());return}this.inputSchemasToReduceWorkflows.forEach(function(p,g){p.some(function(k){return k.triggerOnRefresh})&&(a.tileRefreshByDocSessionIdEnabled?(a.resultCache.clear(g,{primary:s}),a.resultCache.clear(a.getForcedDocLevelSchema(g),{primary:s}),a.reduceTimerCache.clear(g,s)):(a.resultCache.clear(g),a.resultCache.clear(a.getForcedDocLevelSchema(g)),a.reduceTimerCache.clear(g)),p.some(function(k){return!k.triggerOnRefresh})&&(c.resultDescription+="X_"),c.resultDescription+=g+" ")}),this.clearRemoteLambdaTokenCache();var f=[];this.inputSchemasToWorkflows.forEach(function(p){return f.push.apply(f,(0,Ga.default)(p))}),this.inputSchemasToReduceWorkflows.forEach(function(p){return f.push.apply(f,(0,Ga.default)(p))});for(var d of f)this.tileRefreshByDocSessionIdEnabled?d.onRefresh(s):d.onRefresh();this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.set(s,u):this.lastTileRefreshSeq=u,v.info(559290449,y.CoreDefault,c.stop())}}},{key:"executeWorkflow",value:function(e,t,o,a,s,u){var l=this,c=a.docIdExtractor?a.docIdExtractor(t.payload):void 0,f=a.docSessionIdExtractor(o),d=this.tileRefreshByDocSessionIdEnabled?this.lastTileRefreshSeqByDocSessionId.get(f):this.lastTileRefreshSeq;a.onStart(f);var p=function(k){var S=l.tileRefreshByDocSessionIdEnabled?l.lastTileRefreshSeqByDocSessionId.get(f):l.lastTileRefreshSeq;if(a.triggerOnRefresh&&S!==d){e.success=!0,e.resultSignature="TileRefreshIgnore",v.info(559290450,y.CoreDefault,e.stop());return}var C=k.messageType==vn.Exception&&k.payload.exceptionType==Te.NoOutput,x=C&&a.canProduceNullResult,T=x?a.lambdas[a.lambdas.length-1].outputSchema:k.payloadSchema.schema.name,I=x?null:k.payload;k.messageType===vn.Input||x?(a.shouldSendResultsToHost&&(u===l.inputSchemasToReduceWorkflows?l.hostCallbacks.onResult("Reduce.Input",o,T,I):l.hostCallbacks.onResult(s,o,T,I)),e.success=!0,e.resultSignature=C?"NoOutput":"ValidOutput"):C?(e.success=!0,e.resultSignature="NoOutput"):(e.success=!1,e.resultSignature="Exception",e.resultDescription=Hr(k)),u!==l.inputSchemasToReduceWorkflows&&l.updateResultCacheForReduceWorkflows(s,o,T,I,k.correlationVector.toString()),k.moreResults||(e.stop(),v.info(559290451,y.CoreDefault,e),a.onFinish(f,k.payload&&k.payload.exceptionType?Kg(k):void 0))};a.preExecutionPromise.then(function(){for(var g={lookupTable:l.lookupTableCache.get(a.name),docId:c,docSessionId:f},k=p,S=a.lambdas.length-1;S>=0;S--)k=l.createLambdaExecutionStep(a.name,a.lambdas[S],g,k,p);k(t)})}},{key:"getForcedDocLevelSchema",value:function(e){return`~${e}`}},{key:"updateResultCacheForReduceWorkflows",value:function(e,t,o,a,s){var u=this,l=this.inputSchemasToReduceWorkflows.get(o);if(l){var c;e==="docSessionId"?(c=this.getGroupingKey(e,t,o),this.resultCache.setResult(this.getForcedDocLevelSchema(o),c,a),c.secondary="*"):(c=this.getGroupingKey(e,t,o),bM(e,t)&&c.primary!=null&&c.secondary!=null?this.resultCache.clear(void 0,c):this.resultCache.setResult(o,c,a));var f=l.some(function(k){return k.deferReduceUntilIdle}),d=[];this.inputSchemasToWorkflows.forEach(function(k){return d.push.apply(d,(0,Ga.default)(k.filter(function(S){return S.getOutputSchema()===o})))});var p=function(){return f&&d.some(function(S){return S.executionCountByDocSessionId.get(c.primary)>0})},g=l.map(function(k){return k.deferReduceUntilIdleMaxDelayMs||0}).reduce(function(k,S){return Math.max(k,S)});this.reduceTimerCache.setReduceTimer(o,c.primary,function(){var k=u.resultCache.getResults(o,c);if(k.push.apply(k,(0,Ga.default)(u.resultCache.getResults(u.getForcedDocLevelSchema(o),{primary:c.primary}))),Array.isArray(k)){var S={id:c.primary,values:k,isReduceInput:!0};u.submitToWorkflows(o,S,s,u.inputSchemasToReduceWorkflows)}else v.error(559290452,y.CoreDefault,`Cached results have unexpected type "${typeof k}"`)},500,p,g)}}},{key:"isFeatureEnabled",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"None";return this.hostCallbacks&&this.hostCallbacks.isFeatureEnabled?this.hostCallbacks.isFeatureEnabled("Microsoft.Office.AugLoop."+e,o).catch(function(){return Promise.resolve(t)}):Promise.resolve(t)}},{key:"areLicenseFeaturesEnabled",value:function(e){return this.hostCallbacks&&this.hostCallbacks.areLicenseFeaturesEnabled?this.hostCallbacks.areLicenseFeaturesEnabled(e).catch(function(){return Promise.resolve(!1)}):Promise.resolve(!1)}},{key:"isWorkflowEnabled",value:function(e,t,o,a,s){var u=this,l=t.some(function(f){return f.source===ce.Remote||f.source===ce.BatchedRemote});if(l){if(!this.serviceUrl)return s.resultDescription="Disabled because no service URL available for remote workflow",Promise.resolve(!1);if(this.clientMetadata&&this.clientMetadata.privateMode&&t.some(function(f){return(f.source===ce.Remote||f.source===ce.BatchedRemote)&&!f.canRunInPrivateMode}))return s.resultDescription="Disabled because we are running in private mode",Promise.resolve(!1)}(!this.clientMetadata||this.clientMetadata.appPlatform!=="Mac"&&this.clientMetadata.appPlatform!=="Win32")&&(a=!0,s.resultDescription="Enabled by default due to platform name");var c;return a?c=Promise.resolve(!0):c=this.isFeatureEnabled("WorkflowEnabled."+e),c.then(function(f){return f?u.isFeatureEnabled("WorkflowDisabled."+e).then(function(d){return d?(s.resultDescription="Disabled because explicitly disabled",!1):o?u.areLicenseFeaturesEnabled(o).then(function(p){return p||(s.resultDescription="Disabled because license check failed"),p}):!0}):(s.resultDescription="Disabled because not explicitly enabled",!1)})}},{key:"registerHardcodedWorkflow",value:function(e,t){var o=this,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.inputSchemasToWorkflows,s=arguments.length>3?arguments[3]:void 0;if(!e||e.length>40)throw new Error("Workflow name has invalid length");if(new RegExp(/^[A-Z][a-zA-Z0-9_]+$/).test(e)===!1)throw new Error("Workflow name has invalid format");a.forEach(function(l){if(l.some(function(c){return c.name===e}))throw new Error("Workflow name already registered.")});var u=new E({operationName:"WorkflowRegistration",resourceId:e,success:!0});return u.setClientMetadata(this.clientMetadata),u.start(),this.isWorkflowEnabled(e,t,s.licenseFeatures,s.enabledByDefault,u).then(function(l){if(u.resultSignature=l?"Enabled":"Disabled",u.stop(),v.info(559290453,y.CoreDefault,u),l){var c=t[0].inputSchema,f=a.get(c);f||(f=[],a.set(c,f));var d=Promise.resolve();s.lookupTableLambda&&(d=new Promise(function(g,k){var S=new Je,C={messageType:vn.Input,correlationVector:S,payloadSchema:Wr(s.lookupTableLambda.inputSchema),clientMetadata:o.clientMetadata,payload:{}},x=function(_){_.messageType===vn.Input&&_.payload&&o.lookupTableCache.set(e,_.payload),g()},T=o.createLambdaExecutionStep("",s.lookupTableLambda,{},x,x);T(C)}));var p=new np;p.name=e,p.lambdas=t,p.canProduceNullResult=s.canProduceNullResult,p.shouldSendResultsToHost=s.shouldSendResultsToHost,p.triggerOnRefresh=s.triggerOnRefresh,p.throttleSettings=s.throttleSettings||o.defaultWorkflowOptions.throttleSettings,p.docIdExtractor=s.docIdExtractor,p.docSessionIdExtractor=function(g){return g.isReduceInput?g.id:yu(c,g)},p.deferReduceUntilIdle=s.deferReduceUntilIdle,p.deferReduceUntilIdleMaxDelayMs=s.deferReduceUntilIdleMaxDelayMs,p.useCanaryTextTile=s.useCanaryTextTile,p.preExecutionPromise=d,f.push(p)}})}},{key:"logOperation",value:function(e,t,o,a){e.stop(),e.success=t,e.resultSignature=o,e.resultDescription=a,v.info(559290454,y.CoreDefault,e)}},{key:"handleLambdaError",value:function(e,t,o,a,s){e.exceptionType!=null?Zn(t,e):e instanceof Error?Zn(t,{exceptionType:a,message:e.message}):Zn(t,{exceptionType:Te.Unknown,message:e?e.toString():void 0}),this.logOperation(o,!1,"Exception",Hr(t)),s(t)}},{key:"handleLambdaOutput",value:function(e,t,o,a,s,u){e&&e.exceptionType!==Te.NoOutput?e.exceptionType!=null?this.handleLambdaError(e,t,o,e.exceptionType,u):e instanceof Error?this.handleLambdaError(e,t,o,Te.LambdaErrorCallback,u):(t.payload=e,t.payloadSchema=Wr(a),this.logOperation(o,!0),s(t)):(Zn(t,{exceptionType:Te.NoOutput}),this.logOperation(o,!0,"NoOutput"),u(t))}},{key:"executeCustomLambdaStep",value:function(e,t,o,a,s,u){var l=this;if(o.func==null)Zn(e,{exceptionType:Te.LambdaThrow,message:"No lambda function set"}),this.logOperation(t,!1,"Error",Hr(e)),u(e);else{var c=function(p){l.handleLambdaOutput(p,e,t,o.outputSchema,s,u)},f=function(p,g){l.handleLambdaOutput(p,e,t,g,u,u)};try{o.func(e.payload,o.config,a,c,f)}catch(d){this.handleLambdaError(d,e,t,Te.LambdaThrow,u)}}}},{key:"executeLocalLambdaStep",value:function(e,t,o,a,s){var u=this;this.hostCallbacks.executeLocalLambda==null?(Zn(e,{exceptionType:Te.LambdaThrow,message:"No local lambda host callback set"}),this.logOperation(t,!1,"Error",Hr(e)),s(e)):this.hostCallbacks.executeLocalLambda(o.inputSchema,e.payload,o.outputSchema).then(function(l){u.handleLambdaOutput(l,e,t,o.outputSchema,a,s)}).catch(function(l){u.handleLambdaError(l,e,t,Te.LambdaThrow,s)})}},{key:"executeRemoteLambdaStep",value:function(e,t,o,a,s,u){var l=this;if(this.serviceUrl){t.resourceId+=`.${this.serviceProtocol}`;var c=function(S,C){S?l.handleLambdaError(S,e,t,S.exceptionType||Te.LambdaErrorCallback,u):l.handleLambdaOutput(C,e,t,o.outputSchema,s,u)};if(a.authTickets=o.authTickets,o.source===ce.Remote)this.executeRemoteLambda(this.serviceUrl,e,Wr(o.inputSchema),Wr(o.outputSchema),e.correlationVector,this.clientMetadata,this.hostCallbacks,a,c);else{this.batchedRemoteLambdaManager||(this.batchedRemoteLambdaManager=new Po(function(k,S,C){var x=S.context,T=x.remoteLambda,I=x.lambdaContext;l.executeRemoteLambda(l.serviceUrl,{messageType:vn.Input,correlationVector:{id:S.cv},payload:k,payloadSchema:Wr(T.inputSchema),clientMetadata:l.clientMetadata},Wr(T.remoteInputSchema),Wr(T.remoteOutputSchema),{id:S.cv},l.clientMetadata,l.hostCallbacks,I,C)},!1,!1,function(k,S,C){var x,T=C.lambdaContext;l.updateResultCacheForReduceWorkflows("docSessionId",(x=T.docSessionId)!==null&&x!==void 0?x:T.docId,k,S)}));var f=o.batchOptions,d=this.normalizeBatchOptions(f),p=d.groupingKeyExtractor;d.groupingKeyExtractor=function(k){return`${o.name}-${p(k)}`};var g={name:o.name,remoteLambda:o,lambdaContext:a};this.batchedRemoteLambdaManager.addBatchItem(e.payload,d,g,e.correlationVector.id.length>127?e.correlationVector.id.substring(0,127)+"!":e.correlationVector.id,void 0,c)}}else Zn(e,{exceptionType:Te.LambdaThrow,message:"No URL for remote lambda"}),this.logOperation(t,!1,"Error",Hr(e)),u(e)}},{key:"createLambdaExecutionStep",value:function(e,t,o,a,s){var u=this;return function(l){var c=new E({cv:l.correlationVector.toString(),operationName:"ExecuteLambda",resourceId:t.name,dimension0:e});c.start(),t.source===ce.Custom?u.executeCustomLambdaStep(l,c,t,o,a,s):t.source===ce.Local?u.executeLocalLambdaStep(l,c,t,a,s):t.source===ce.Remote||t.source===ce.BatchedRemote?u.executeRemoteLambdaStep(l,c,t,o,a,s):(Zn(l,{exceptionType:Te.LambdaThrow,message:"Unknown/No lambda location set"}),u.logOperation(c,!1,"Error",Hr(l)),s(l))}}},{key:"normalizeBatchOptions",value:function(e){if(!e)throw new Error("Expected batchConfig");var t=Object.assign({},e);return e.estimateSize||(t.estimateSize=ws),t}}])}(),ft=new NM;h();var bx=w(P()),Mx=w(R());h();h();var gx=w(P()),hx=w(R()),mx=w(Qe()),sp=w($e()),vx=w(je()),kx=w(Pn());h();var ux=w(P()),lx=w(R()),cx=w(Qe()),ap=w($e()),fx=w(je());function DM(n,r,e){return r=(0,ap.default)(r),(0,cx.default)(n,dx()?Reflect.construct(r,e||[],(0,ap.default)(n).constructor):r.apply(n,e))}function dx(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(dx=function(){return!!n})()}var px=function(n){function r(e){var t;return(0,ux.default)(this,r),t=DM(this,r,[{messageIdPrefix:"s",responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}]),t.session=e,t.setEgress(t.egressToSession.bind(t)),t}return(0,fx.default)(r,n),(0,lx.default)(r,[{key:"egressToSession",value:function(t,o){var a=this;if(m.getTypeNameFor(t)===ln.getTypeName()){var s=t.annotationType,u=t.config;this.session.activateAnnotation(s,{config:u,callback:function(f){a.ingress(new Ct({annotationType:s,ops:[f]}),function(){})}}).then(function(){a.ingress(new Ge({messageId:t.messageId}),function(){}),o()}).catch(function(c){o(c)})}else if(m.getTypeNameFor(t)===Ve.getTypeName())this.session.close(),o();else if(m.getTypeNameFor(t)===Be.getTypeName()){var l=t;l.seq===0?this.session.submitSeedOperations(l.ops):this.session.submitOperations(l.ops),this.ingress(new Ge({messageId:t.messageId}),function(){}),o()}}}])}(Go);function PM(n,r,e){return r=(0,sp.default)(r),(0,mx.default)(n,yx()?Reflect.construct(r,e||[],(0,sp.default)(n).constructor):r.apply(n,e))}function yx(){try{var n=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(r){}return(yx=function(){return!!n})()}var up=function(n){function r(e,t,o){var a;return(0,gx.default)(this,r),a=PM(this,r),a.messageCallbacksByMessageType=new Map,a.messageIdPrefix="c",a.nextMessageId=1,a.upstreamMessageEndpoint=new Go({messageIdPrefix:a.messageIdPrefix,responseTimeoutMs:3e4,resendPendingMessagesOnReconnect:!1}),a.sessionInitializer=e,a.tokenRefreshManager=t,a.serverSessionFactory=o,a}return(0,vx.default)(r,n),(0,hx.default)(r,[{key:"init",value:function(t,o,a){var s=this;return this.serverSessionFactory().then(function(u){s.upstreamMessageEndpoint.setEgress(function(d,p){var g=function(C){p(C?new Error(C.error):void 0)},k=s.messageCallbacksByMessageType.get(m.getTypeNameFor(d));k?k(d,function(S,C){C?(C.messageId=d.messageId,s.upstreamMessageEndpoint.ingress(C,g)):g(S)}):a&&a(d,p)});var l=new qf,c=new oy(function(){return new Lv(l)}),f=new Cg({log:function(){}});s.downstreamMessageEndpoint=new px(u),s.session=new TS("FakeSessionKey"+r.nextSessionKey++,{upstreamMessageEndpoint:s.upstreamMessageEndpoint,downstreamMessageEndpoint:s.downstreamMessageEndpoint,cache:c},f),s.sessionInitializer.on("connect",function(d,p,g,k,S,C){s.emit("connect",d,g,k,S,C)}),s.sessionInitializer.initSession({isTokenRefresh:!1,onResponse:function(p,g){a&&(p||g)&&a(p||g,function(){})}})})}},{key:"sendMessage",value:function(t,o,a){m.getTypeNameFor(t)?(t.messageId||(t.messageId=`${this.messageIdPrefix}${this.nextMessageId++}`),this.upstreamMessageEndpoint.ingress(t,o||function(){})):o&&o(new X({messageId:t.messageId,error:"Dropped invalid message"}))}},{key:"sendBytes",value:function(t){throw new Error("NYI")}},{key:"onMessage",value:function(t,o){if(this.messageCallbacksByMessageType.has(t))throw new Error(`Cannot register another ${t} callback`);this.messageCallbacksByMessageType.set(t,o)}},{key:"getCorrelationVector",value:function(){return new Je}},{key:"getNetworkWorkerManager",value:function(){}},{key:"forceReconnect",value:function(t){throw new Error("NYI")}},{key:"closeSession",value:function(){this.session&&this.session.onClose(Nr.MastermindShutdown,new Ve,function(){}),this.tokenRefreshManager.clearAllTimeouts()}}])}(kx.EventEmitter);up.nextSessionKey=0;h();var wx=w(P()),Sx=w(R());var Cx=function(){function n(r,e){(0,wx.default)(this,n),this.sessionManager=r,this.egress=e,this.workflowRequestCallbackMap=new Map,this.sessionManager.onMessage(ir.getTypeName(),this.onWorkflowExecutionRequest.bind(this))}return(0,Sx.default)(n,[{key:"setWorkflowRequestCallback",value:function(e,t){if(this.workflowRequestCallbackMap.has(e.id))throw new Error(`Duplicate workflow ${e.id} registered`);this.workflowRequestCallbackMap.set(e.id,t)}},{key:"onAnnotationResult",value:function(e,t){return this.sendMessageAsync(e)}},{key:"onChatStoreMessagesSet",value:function(e,t){return this.sendMessageAsync(e)}},{key:"onChatStoreMessagesGet",value:function(e,t){return this.sendMessageAsync(e)}},{key:"onMessage",value:function(e,t){return this.sendMessageAsync(e)}},{key:"onWorkflowModelRequest",value:function(e,t){return this.sendMessageAsync(e)}},{key:"onFetchRangeFromCacheRequest",value:function(e,t){return this.sendMessageAsync(e)}},{key:"onWorkflowExecutionRequest",value:function(e,t){var o=this.workflowRequestCallbackMap.get(e.workflowId);if(!o){if(this.egress){this.egress(e,function(u){u?t(new X({messageId:e.messageId,error:u.message})):t()});return}throw new Error(`Cannot execute unknown workflow ${e.workflowId}`)}var a,s;o(e).then(function(u){s=u}).catch(function(u){a=new X({messageId:e.messageId,error:u.stack})}).then(function(){t(a,s)})}},{key:"sendMessageAsync",value:function(e){var t=this;return new Promise(function(o,a){t.sessionManager.sendMessage(e,function(s,u){s?a(s.error?new Error(s.error):s):o(u)})})}}])}();h();var xx=w(P()),Tx=w(R()),Ix=function(){function n(){(0,xx.default)(this,n)}return(0,Tx.default)(n,[{key:"create",value:function(){return{validate:function(){return!0}}}}])}();var _x=function(r){var e=new pu(void 0,function(t,o,a){if(a&&!a.enableComplexLocalWorkflows)return r&&r.networkMode===Ce.LocalWorkflowsOnly?new Dr:void 0;var s=new gr,u=new up(new $a(function(){return new Fa},t,s,function(l,c){u.sendMessage(l,c)}),s,function(){return e.createSession({docSessionId:`${t.docSessionId}-Server`,serviceUrl:o})});return u},function(t){return t.localWorkflowManager||(t.workflowRuntimeFactory=function(o){var a=function(){return{}};return new Nk(new Cx(o,t.egress),new Map,new Map,a,new Ix)}),new oi(t)});return e};var hr;(function(n){n.InitMessageAlreadyReceived="InitMessageAlreadyReceived",n.UnknownBridgeId="UnknownBridgeId",n.UnknownDocSessionId="UnknownDocSessionId",n.InitNotStarted="InitNotStarted"})(hr||(hr={}));var Ax=function(r){return new Error(`Runtime${r}`)},lp=function(r){return new Error(`Session${r}`)},Ex=function(){function n(){(0,bx.default)(this,n),this.optionsByBridgeId=new Map,this.runtimesByBridgeId=new Map,this.sessionsByBridgeIdAndDocSessionId=new Map}return(0,Mx.default)(n,[{key:"initBridge",value:function(e){if(this.optionsByBridgeId.has(e.bridgeId))throw new Error(`Bridge ${e.bridgeId} already exists`);this.optionsByBridgeId.set(e.bridgeId,e)}},{key:"closeBridge",value:function(e){if(!this.optionsByBridgeId.delete(e))throw new Error(`Bridge ${e} does not exist`);this.runtimesByBridgeId.delete(e),this.sessionsByBridgeIdAndDocSessionId.delete(e)}},{key:"ingress",value:function(e,t,o){var a=this,s;try{typeof o=="string"?s=JSON.parse(o):s=fn.deserialize(o)}catch(u){this.egressResponse(e,void 0,new X({error:"FailedBridgeMessageParse: "+(u==null?void 0:u.message)}),t);return}fa.typeGuard(s)?this.onRuntimeInitMessage(e,t,s):this.afterRuntimeInit(e,function(u){if(u){a.egressResponse(e,s.messageId,new X({error:u.message}),t);return}pt.typeGuard(s)?a.onSessionInitMessage(e,t,s):t&&a.onSessionIngress(e,t,s)})}},{key:"afterRuntimeInit",value:function(e,t){var o=this.runtimesByBridgeId.get(e);if(!o){t(Ax(hr.UnknownBridgeId));return}if(!o.runtimeInitPromise){t(Ax(hr.InitNotStarted));return}if(o.runtimeInitialized){t(void 0,o.runtime);return}var a;o.runtimeInitPromise.catch(function(s){a=s}).then(function(){t(a,o.runtime)})}},{key:"afterSessionInit",value:function(e,t,o){var a=this.sessionsByBridgeIdAndDocSessionId.get(e);if(!a){o(lp(hr.UnknownBridgeId));return}var s=a.get(t);if(!s){o(lp(hr.UnknownDocSessionId));return}if(!s.sessionInitPromise){o(lp(hr.InitNotStarted));return}if(s.sessionInitialized){o(void 0,s.session);return}var u;s.sessionInitPromise.catch(function(l){u=l}).then(function(){o(u,s.session)})}},{key:"onRuntimeInitMessage",value:function(e,t,o){var a=this,s=this.runtimesByBridgeId.get(e);if(s){this.egressResponse(e,o.messageId,new X({error:`Runtime${hr.InitMessageAlreadyReceived}`}),t);return}s={runtimeInitialized:!1},this.runtimesByBridgeId.set(e,s),s.runtime=_x(o.runtimeInitOptions),s.runtimeInitPromise=s.runtime.init("https://augloop-int.officeppe.com",{appName:"Testing",appPlatform:"Client"},{requestAuthToken:function(){return Promise.reject()},sendTelemetryEvent:function(l,c,f,d,p,g,k,S){a.egress(e,JSON.stringify(new da({tenant:l,event:c,dataJson:JSON.stringify(f),contract:d,contractDataJson:JSON.stringify(p),critical:g,dataCategories:k,diagnosticLevel:S})),t)},isFeatureEnabled:function(l,c){return o.runtimeInitOptions.featureEnabled.indexOf(l)!==-1?Promise.resolve(!0):Promise.resolve(!1)},areLicenseFeaturesEnabled:function(){return Promise.resolve(!1)}},{telemetryAggregationIntervalSec:o.telemetryAggregationIntervalSec}).then(function(){s.runtimeInitialized=!0;var u=a.optionsByBridgeId.get(e);return u&&u.onRuntimeInit&&u.onRuntimeInit(s.runtime,{bridgeId:e,bridgeMessage:o}),new Ge({})}).catch(function(u){return a.runtimesByBridgeId.delete(e),new X({error:u==null?void 0:u.message})}).then(function(u){a.egressResponse(e,o.messageId,u,t)})}},{key:"onSessionInitMessage",value:function(e,t,o){var a=this,s;if(!t||((s=o.clientMetadata)===null||s===void 0?void 0:s.docSessionId)!==t){this.egressResponse(e,o.messageId,new X({error:"InvalidDocSessionId"}),t);return}this.afterRuntimeInit(e,function(u,l){if(u){a.egressResponse(e,o.messageId,new X({error:u.message}),t);return}var c=a.sessionsByBridgeIdAndDocSessionId.get(e);c||(c=new Map,a.sessionsByBridgeIdAndDocSessionId.set(e,c));var f=c.get(t);if(f){a.egressResponse(e,o.messageId,new X({error:`Session${hr.InitMessageAlreadyReceived}`}),t);return}f={sessionInitialized:!1},c.set(t,f),f.sessionInitPromise=l.createSession({docSessionId:t,extensionConfigs:o.extensionConfigs,serviceUrl:o.serviceUrl,enableComplexLocalWorkflows:!0,egress:function(p,g){un.typeGuard(p)?a.egressResponse(e,o.messageId,new un(p),t):a.egress(e,JSON.stringify(p),t),g(void 0)}}).then(function(d){f.session=d,f.sessionInitialized=!0;var p=a.optionsByBridgeId.get(e);p&&p.onSessionInit&&p.onSessionInit(f.session,{bridgeId:e,docSessionId:t,bridgeMessage:o})}).catch(function(d){c.delete(t),a.egressResponse(e,o.messageId,new X({error:d==null?void 0:d.message}),t)})})}},{key:"onSessionIngress",value:function(e,t,o){var a=this;this.afterSessionInit(e,t,function(s,u){if(s){a.egressResponse(e,o.messageId,new X({error:s.message}),t);return}u.sendMessageToSession(o,function(l,c){(l||c)&&a.egressResponse(e,o.messageId,l||c,t)})})}},{key:"egressResponse",value:function(e,t,o,a){t!==void 0&&(o.messageId=t),this.egress(e,JSON.stringify(o),a)}},{key:"egress",value:function(e,t,o){var a=this.optionsByBridgeId.get(e);a&&a.egress(t,o)}}])}();h();var wu=w(Tn());h();var ku=function(r){return{primary:r.tile.metadata.docSessionId,secondary:r.tile.metadata.tileId}};h();var RM=3,BM=10,Nx=function(r){var e=new Map,t=!1,o=new Map;if(r&&Array.isArray(r.values)){var a=0;for(var s of r.values)if(s&&Array.isArray(s.acronyms)){a+=s.acronyms.length;var u=function(p){if(p.annotationId!==void 0&&p.annotationId.indexOf("=")>=0){var g=p.annotationId.substring(0,p.annotationId.indexOf("=")),k=e.get(g);e.set(g,k===void 0?1:k+1);var S;if(Array.isArray(s.annotations)){var C=s.annotations,x=C.filter(function(M){return M.annotationId===p.annotationId});x.length===1&&x[0]&&x[0].tileInfo&&x[0].tileInfo.tileId&&(S=x[0].tileInfo.tileId)}if(!o.has(g)){var T={paragraphId:S,acronym:g,expansions:[],sourceTransactionId:s.transactionId};o.set(g,T)}var I=o.get(g).expansions;if(I.every(function(M){return M.name!==p.name})){var _={name:p.name,description:p.description,sourceType:p.sourceType,sourceEmail:p.sourceEmail,sourceFile:p.sourceFile,sourceAdmin:p.sourceAdmin,score:p.score,instrumentationId:p.instrumentationId,sourceTransactionIds:[s.transactionId]};I.push(_)}}};for(var l of s.acronyms)u(l);(a>=BM||e.size>=RM)&&(t=!0)}}var c=[];o.forEach(function(d,p){c.push(d)});var f={acronymsThresholdHit:t,paragraphAcronyms:o.size===0?[]:c};return f};h();h();var Dx=function(r){return r?r===r.toUpperCase():!1},Px=function(r,e){if(!r)return r;for(var t=0,o=r.length-1;e.indexOf(r[t])!==-1&&t<o;)t++;for(;e.indexOf(r[o])!==-1&&o>=t;)o--;return r.substring(t,o+1)};var WM=/(\b[0-9A-Z][A-Z/\.]*([a-z/]){0,3}[A-Z0-9/\.]*[- #\s&\+]?[A-Z0-9/\.]*[- #\s&\+]?[A-Z0-9/\.]*([a-z/]){0,50}[A-Z0-9\./]*([a-z/]){0,50}[\.]?s?([\+]|([\.])|\b))/,OM=/(\b(([A-Z]([a-z/]){0,50})|([0-9])*)[\.]?s?([\+]|([\.])|\b))/,LM=20,FM=function(r){if(!r)return!1;r=Px(r,[" ","\xA0","."]);var e=WM.exec(r),t=e&&e.length>0?e[0].trim():"",o=OM.exec(r),a=o&&o.length>0?o[0].trim():"";return t===r&&t.length>1&&t.length<=LM&&a!==r},qM=function(r){if(!r)return[];var e=r.trim().split(/[\s,?!'"]/g);return e.length>1&&Dx(r)?[]:e.filter(function(t){return t&&FM(t)})},Rx=function(r,e,t){if(!r||!r.tile||!r.tile.metadata||r.type===Vn.TextTileEventType.Delete)return null;var o=r.tile.elements;if(!Array.isArray(o)||o.length===0)return null;var a=qM(o.map(function(l){return l.text}).join(" "));if(!a.length)return null;if(e&&e.lookupTable&&e.lookupTable.acronymsMap&&t){var s=e.lookupTable,u=s.acronymsMap;if(a.every(function(l){return!$M(l,u)}))return null}return{documentId:r.tile.metadata.docId,documentSessionId:r.tile.metadata.docSessionId,tiles:[r.tile]}},$M=function(r,e){return e[r]!==void 0};h();var Wx=w(Tn());h();var GM=function(r){return Array.isArray(r)?r.reverse().reduce(function(e,t){return e*2+(t?1:0)},0):0},Ha=function(r,e,t){for(var o=[],a=0;a<e;a++)o.push(r.IsFeatureEnabled(t+`${a}`,"None").then(function(s){return s}).catch(function(){return!1}));return Promise.all(o).then(function(s){return GM(s)})};h();var Bx=function(r){return r.type===Vn.TextTileEventType.Delete||r.tile.elements===void 0||r.tile.elements===null||r.tile.elements.length===0||r.tile.elements[0].text===void 0||r.tile.elements[0].text===null||r.tile.elements[0].text.length===0?null:r};var cp=function(r,e){if(e===null)throw new Error(`${r} must be defined and non null`)};h();var za=function(){return[{Provider:rs.ADAL,ResourceId:"https://nleditor.osi.office.net/NlEditor",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize"}]};var UM="Acronyms.Request",HM="Acronyms.Response",zM="Acronyms.BatchRequest",VM="Acronyms.BatchResponse",QM=function(r){try{return r.tiles[0].elements[0].text.length}catch(e){throw new Error(`invalid estimateSize input ${e}`)}},jM=function(r){return cp("request",r),r.documentId},JM=function(r){return cp("acronymsBatchResponse",r),r.responses},KM=function(r){var e={requests:r};return{input:e,demultiplex:JM}},Ox=function(){var n=(0,Wx.default)(function*(r,e){var t=yield Ha(r,7,"Microsoft.Office.Augloop.AcronymsBatchingInterval"),o=yield Ha(r,7,"Microsoft.Office.Augloop.AcronymsBatchingSizeInKB"),a=t===0?1:t,s=o===0?20:o;return{name:"AcronymsLambdaRemoteBatched",source:ce.BatchedRemote,inputSchema:UM,outputSchema:HM,remoteInputSchema:zM,remoteOutputSchema:VM,authTickets:e?za():void 0,batchOptions:{delayMs:a*1e3,maxInputSize:s*1024,estimateSize:QM,groupingKeyExtractor:jM,multiplex:KM}}});return function(e,t){return n.apply(this,arguments)}}();var Fx=898989898,fp="Tiling.TextTileEvent",Lx="Acronyms.Request",qx="Acronyms.Response",YM="Acronyms.CountReduceOutput",dp=function(){var n=(0,wu.default)(function*(r,e){var t=yield e.IsFeatureEnabled("Microsoft.Office.Augloop.ShouldAcronymsUseLookupTable","None"),o={name:"AcronymsLambdaBefore",source:ce.Custom,inputSchema:fp,outputSchema:Lx,func:function(k,S,C,x){var T=Rx(k,C,t);x(T)}},a=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.RemoteLambdaAuthTickets","Production"),s=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.AcronymsLocalLambda","None"),u=yield XM(e,a,s),l=yield e.IsFeatureEnabled("Microsoft.Office.AugLoop.AcronymsWordBatchedWorkflow","None");if(l){var c=yield Ox(e,a),f=[],d={name:"AcronymsLocalLambda",inputSchema:fp,outputSchema:fp,source:ce.Local};return s&&f.push(d),f.push(o),f.push(c),r.registerMultipleLambdasWorkflow("AcronymsWorkflow",f,u)}else{var p={name:"AcronymsLambdaRemote",source:ce.Remote,inputSchema:Lx,outputSchema:qx,authTickets:a?za():void 0};return r.registerSimpleRemoteWorkflow("AcronymsWorkflow",o,p,null,u)}});return function(e,t){return n.apply(this,arguments)}}(),XM=function(){var n=(0,wu.default)(function*(r,e,t){var o=yield ZM(r,e),a=yield Ha(r,7,"Microsoft.Office.Augloop.AcronymsThrottlingInterval");return{canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:a*1e3},licenseFeatures:[Fx],lookupTableLambda:o,triggerOnRefresh:t}});return function(e,t,o){return n.apply(this,arguments)}}(),ZM=function(){var n=(0,wu.default)(function*(r,e){var t=yield r.IsFeatureEnabled("Microsoft.Office.Augloop.AcronymsLookupTable","None");if(t)return{name:"AcronymsLambdaLookup",source:ce.Remote,inputSchema:"Acronyms.LookupRequest",outputSchema:"Acronyms.LookupResponse",authTickets:e?za():void 0}});return function(e,t){return n.apply(this,arguments)}}(),pp=function(r){var e={name:"AcronymsReduceLambda",source:ce.Custom,inputSchema:qx,outputSchema:YM,func:function(a,s,u,l){l(Nx(a))}},t={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},licenseFeatures:[Fx]};return r.registerReduceWorkflow("AcronymsReduceWorkflow",e,ku,10,t)};h();var eE="Tiling.TextTileEvent",$x="SavePrompt.Request",Gx="SavePrompt.Response",tE="SavePrompt.ReduceCountSignal",nE=300,rE=function(r){if(!r||!r.tile||!r.tile.metadata)return null;var e=r.tile.elements;return!Array.isArray(e)||e.length===0?null:{documentId:r.tile.metadata.docId,documentSessionId:r.tile.metadata.docSessionId,tiles:[r.tile]}};function oE(n){return n=n.replace(/(^\s*)|(\s*$)/gi,""),n===""?0:n.split(/\r\n|\r|\n/).length}function iE(n){return n=n.replace(/(^\s*)|(\s*$)/gi,""),n=n.replace(/[ ]{2,}/gi," "),n=n.replace(/\n /gi,`
`),n=n.replace(/\r /gi,"\r"),n=n.replace(/\r\n /gi,`\r
`),n=n.replace(/\r\n|\r|\n/gi," "),n.split(" ").filter(function(r){return r!==""}).length}var aE=function(r){if(r===null)throw new Error("savepromptRequest must be defined and non null");var e=r.tiles;if(!(!e||e.length<1)){if(e.length>1)throw new Error("There are more than 1 tiles in input. Expecting max 1 tile");var t="",o=`
`;for(var a of e[0].elements)a.text&&(t+=t?o+a.text:a.text);var s=oE(t),u=iE(t),l=t.length;return{rowCount:s,wordCount:u,charCount:l,documentId:r.documentId}}},gp=function(r){var e={name:"SavePromptLambdaBefore",source:ce.Custom,inputSchema:eE,outputSchema:$x,func:function(s,u,l,c){var f=rE(s);c(f)}},t={name:"SavePromptLambdaNew",source:ce.Custom,inputSchema:$x,outputSchema:Gx,func:function(s,u,l,c){var f=aE(s);c(f)}},o={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:7e3},licenseFeatures:[]};return r.registerSimpleRemoteWorkflow("SavePromptWorkflow",e,t,null,o)},sE=function(r){var e=!1,t=0,o=0,a=0;if(r&&Array.isArray(r.values)){for(var s of r.values)s&&(t+=s.rowCount,o+=s.wordCount,a+=s.charCount);e=a>=nE}var u={thresholdHit:e,rowCount:t,wordCount:o,charCount:a};return u},hp=function(r){var e={name:"SavePromptReduceLambda",source:ce.Custom,inputSchema:Gx,outputSchema:tE,func:function(a,s,u,l){l(sE(a))}},t={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!1},licenseFeatures:[]};return r.registerReduceWorkflow("SavePromptReduceWorkflow",e,ku,10,t)};h();var Ux=w(Tn());h();var mp={documents:new Map,officeUILanguage:"",serviceUrl:"",docSessionIdToDocIdMap:new Map,docIdToDocSessionIdMap:new Map,classificationResponse:"Classification.Response",classificationBatchedResponse:"Classification.BatchResponse",classificationReduce:"Classification.Reduce",classificationReduceResponse:"Labelling.Response",labellingEditorUIResponse:"Labelling.EditorUIResponse",autoClpLicenseFeatures:[76080228,31135922],defaultBatchIntervalSeconds:3,defaultBatchSizeKB:20,defaultThrottlingIntervalSeconds:3,maxReduceDelayUntilIdleSeconds:5};function Su(n,r){return vp.apply(this,arguments)}function vp(){return vp=(0,Ux.default)(function*(n,r){mp.officeUILanguage=n.uiLanguage,mp.serviceUrl=r}),vp.apply(this,arguments)}h();h();h();var Hx="SlideTile";var Vx="Proofing.",uE="ProofingRequest",lE="ProofingResponse",zx=`${Vx}${uE}`,cE=`${Vx}${lE}`,fE="827D1907-1E10-4F04-987A-B13FEC819C3C",dE="818BCDBE-64CE-46E8-A3D7-75A1EA8365A8",pE=function(r,e){if(e.slides.length===0)return null;var t=[];r.appMetadata&&r.appMetadata.overriddenCritiqueTypeOptions&&(t=r.appMetadata.overriddenCritiqueTypeOptions),t.push({id:dE,languageId:"en-US",value:"0"});var o={documentId:r.docId,languageUxId:r.appMetadata?r.appMetadata.languageUxId:"en-US",descriptors:{isCompliant:r.appMetadata?r.appMetadata.descriptor.isCompliant:!0,licenseType:r.appMetadata?r.appMetadata.descriptor.licenseType:2},tiles:[],requestOrderInSession:r.reqOrd,runOnProfileId:fE,overriddenCritiqueTypeOptions:t},a=e.slides[0];if(a.drawingElems)for(var s of a.drawingElems){var u=s.textTile;u.metadata={tileId:s.id,revisionId:"revision",tileType:1};for(var l=0,c=u.elements;l<c.length;l++){var f=c[l];f.languageId||(f.languageId="en-US"),f.textUnit=4}o.tiles.push(u)}return o},Qx=function(r){var e={name:"ProofingLambdaBefore",source:ce.Custom,inputSchema:Hx,outputSchema:zx,func:function(s,u,l,c){var f=s,d=JSON.parse(f.content),p=pE(f,d);c(p)}},t={name:"ProofingLambdaRemote",source:ce.Remote,inputSchema:zx,outputSchema:cE},o={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!0};return r.registerSimpleRemoteWorkflow("ProofingWorkflow",e,t,null,o)};function yp(n){return Qx(n)}h();var gE="Tiling.TextTileEvent",jx="SharingSuggestion.Request",kp="SharingSuggestion.Response",Jx={},Kx=function(r,e){var t={name:"SharingSuggestionLambdaBefore",source:ce.Custom,inputSchema:gE,outputSchema:jx,func:function(c,f,d,p){var g={Provider:Rp.ADAL,ResourceId:"https://substrate.office.com",AuthorityUrl:"https://login.microsoftonline.com/common/oauth2/authorize",Target:"https://substrate.office.com",Policy:"MBI_SSL"};Jx[c.tile.metadata.docId]?p(null):e.RequestAuthToken({Tickets:[g]}).then(function(k){p({tiles:[c.tile],tokens:[{token:k.Token,ticket:g}]})}).catch(function(){p(null)})}},o={name:"SharingSuggestionLambdaRemote",source:ce.Remote,inputSchema:jx,outputSchema:kp},a={name:"SharingSuggestionLambdaAfter",source:ce.Custom,inputSchema:kp,outputSchema:kp,func:function(c,f,d,p){Jx[c.docId]=!c.retry,c.identities.length>0&&c.identities[0].suggestions.length>0?(delete c.retry,delete c.docId,p(c)):p(null)}},s=10,u={canProduceNullResult:!1,shouldSendResultsToHost:!0,enabledByDefault:!1,throttleSettings:{shouldBeThrottled:!0,throttlingInterval:1e4},licenseFeatures:[]};return r.registerSimpleRemoteWorkflow("SharingSuggestionWorkflow",t,o,a,u)};h();var ai=w(wp()),lT=w(oT());h();var tt=w(iT()),aT=w(P()),sT=w(R()),uT=function(){function n(){(0,aT.default)(this,n)}return(0,sT.default)(n,[{key:"log",value:function(e,t,o,a){(0,tt.default)(e),(0,tt.default)(t),(0,tt.default)(o),(0,tt.default)(a)}},{key:"info",value:function(e,t,o){(0,tt.default)(e),(0,tt.default)(t),(0,tt.default)(o)}},{key:"warn",value:function(e,t,o){(0,tt.default)(e),(0,tt.default)(t),(0,tt.default)(o)}},{key:"error",value:function(e,t,o){(0,tt.default)(e),(0,tt.default)(t),(0,tt.default)(o)}},{key:"debug",value:function(e,t,o){(0,tt.default)(e),(0,tt.default)(t),(0,tt.default)(o)}},{key:"logEvent",value:function(e,t,o,a,s,u){(0,tt.default)(e),(0,tt.default)(t),(0,tt.default)(o),(0,tt.default)(a),(0,tt.default)(s),(0,tt.default)(u)}}])}();var cT="Skills.Signal",WE="Skills.Intent",fT="Skills.ProviderResult",OE="Skills.RankedResult",xp,dT=function(r){var e={name:"IntentClassifierLambdaRemote",source:ce.Remote,inputSchema:cT,outputSchema:WE};return r.registerSimpleRemoteWorkflow("IntentClassifierWorkflow",null,e,null)},pT=function(r){var e={name:"ProviderResultLambdaRemote",source:ce.Remote,inputSchema:cT,outputSchema:fT};return r.registerSimpleRemoteWorkflow("ProviderResultWorkflow",null,e,null)},LE=function(r){var e={},t=[];for(var o of r.values)if(o){var a=o;try{var s={id:a.id,surfaceType:a.surfaceType,providerId:a.providerId,resultStatus:ai.ProviderResultStatus[a.resultStatus],statusCode:a.statusCode,error:a.error?{errorType:ai.ProviderErrorType[a.error.errorType],detail:a.error.detail}:null,additionalInfo:a.additionalInfo?JSON.parse(a.additionalInfo):null,entityGroups:a.entityGroups.map(function(l){return{groupTypeId:l.groupTypeId,providerId:l.providerId,data:l.data?JSON.parse(l.data):null,rank:l.rank}})},u={providerId:s.providerId,resultStatus:s.resultStatus,statusCode:s.statusCode,error:s.error,additionalInfo:s.additionalInfo,entityGroups:s.entityGroups,id:a.id,surfaceType:a.surfaceType};s.resultStatus===ai.ProviderResultStatus.Success&&s.entityGroups?t=t.concat(s.entityGroups):s.resultStatus===ai.ProviderResultStatus.NoResult&&s.entityGroups&&(u.entityGroups=void 0),e[s.providerId]=u}catch(l){e[a.providerId]=void 0}}return{transactionId:null,providerStatuses:e,rankedEntityGroups:t}},FE=function(){return{transactionId:null,interactionId:null}},qE=function(){if(!xp){var r={shouldQueryMatchQfDocumentTitle:!0},e=new uT;xp=new lT.SmartLookupRanker(e,r)}return xp},gT=function(r){var e={name:"InterProviderRanker",source:ce.Custom,inputSchema:fT,outputSchema:OE,func:function(a,s,u,l){var c=LE(a),f=qE();f.rank(FE(),c),l(c)}},t=function(a){var s={primary:a.id,secondary:null};return s};return r.registerReduceWorkflow("InterProviderRankerWorkflow",e,t)};h();var $E=function(r){if(!r)return null;var e={bar:r.baz,baz:r.bar};return e},hT=function(r){var e={name:"BazBarLambda",source:ce.Custom,inputSchema:"Microsoft.AugLoop.BazBar",outputSchema:"Microsoft.AugLoop.BazBar",func:function(u,l,c,f){var d=$E(u);f(d)}},t={name:"HealthCheckRemoteLambda",source:ce.Remote,inputSchema:"HealthCheckRequest",outputSchema:"HealthCheckResponse"},o={name:"BazBarNativeLambda",source:ce.Local,inputSchema:"BazBarNativeRequest",outputSchema:"BazBarNativeResponse"},a={name:"BazBarMissingNativeLambda",source:ce.Local,inputSchema:"BazBarMissingNativeRequest",outputSchema:"BazBarNativeResponse"};return Promise.all([r.registerSimpleLocalWorkflow("BazBarWorkflow",e),r.registerSimpleLocalWorkflow("BazBarNativeWorkflow",o),r.registerSimpleLocalWorkflow("BazBarMissingNativeWorkflow",a),r.registerSimpleRemoteWorkflow("HealthCheckWorkflow",null,t,null)]).then(function(){})};var Dt=w(vT()),DT=w(kT());h();var wT="Tiling.TextTileEvent",GE="LangDetect.Request",UE="LangDetect.Response",HE=function(r){var e={name:"LangDetectLambdaBefore",source:ce.Custom,inputSchema:wT,outputSchema:wT,func:function(a,s,u,l){var c=Bx(a);if(!c)l(null);else{var f={context:c.tile.elements.map(function(d){return d.text}).join(" ")};l(f)}}},t={name:"LangDetectLambdaRemote",source:ce.Remote,inputSchema:GE,outputSchema:UE};return r.registerSimpleRemoteWorkflow("LangDetectWorkflow",e,t,null,{canProduceNullResult:!0,shouldSendResultsToHost:!0,enabledByDefault:!0})};function ST(n){return HE(n)}h();var CT=w(Tn());function zE(n,r,e,t){return Tp.apply(this,arguments)}function Tp(){return Tp=(0,CT.default)(function*(n,r,e,t){var o;try{var a=yield r.getAll(),s=new Set;for(var u of a){var l=u.content.split(" ");for(var c of l)s.add(c)}var f=new ao({count:s.size});t.setAnnotations(n,ao.getTypeName(),[f])}catch(d){o=d}finally{t.done(o)}}),Tp.apply(this,arguments)}function xT(){return Qs.create("UniqueWordsCount").setCollectionScopeType(bt.getTypeName()).setInputTypes([nt.getTypeName()]).setOutputTypes([ao.getTypeName()]).setLambda(zE)}h();var bT=w(P()),MT=w(R());h();var Gn;(function(n){n.Table="Table",n.List="List",n.Footer="Footer",n.Header="Header",n.Paragraph="Paragraph",n.Multiselect="Multiselect"})(Gn||(Gn={}));var bu;(function(n){n.ContentType="ContentType"})(bu||(bu={}));h();var Ip=w(P()),_p=w(R());var ja=function(){function n(r){(0,Ip.default)(this,n),m.assign(n,this,r)}return(0,_p.default)(n,null,[{key:"getTypeName",value:function(){return"AugLoop_FeatureExtraction_FeatureExtractionSignal"}},{key:"getBaseTypes",value:function(){return["AugLoop_Signals_Signal"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();ja.H_={T_:ja.getTypeName(),B_:ja.getBaseTypes()};var So=function(){function n(r){(0,Ip.default)(this,n),m.assign(n,this,r)}return(0,_p.default)(n,[{key:"metadata",get:function(){return this.M_},set:function(e){this.M_=e}}],[{key:"getTypeName",value:function(){return"AugLoop_FeatureExtraction_FeatureExtractionAnnotation"}},{key:"getBaseTypes",value:function(){return["AugLoop_Core_Annotation"]}},{key:"typeGuard",value:function(e){return m.matchesTypesFor(e,[n.getTypeName()])}}])}();So.H_={T_:So.getTypeName(),B_:So.getBaseTypes()};h();var TT=w(Se()),IT=w(P()),_T=w(R());h();var Mu;(function(n){n.HeaderFooter="headerfooters"})(Mu||(Mu={}));var Ja;(function(n){n.Footer="Footer",n.Normal="Normal"})(Ja||(Ja={}));var AT=function(){function n(r){(0,IT.default)(this,n),this.context=r}return(0,_T.default)(n,[{key:"getContentType",value:function(e,t){var o,a,s=new Set;if(!e||!t||!e.selectedRanges||!Array.isArray(e.selectedRanges))return s;for(var u of e.selectedRanges)if(u){var l=t.getItemBodyByReference(u.tileReference);if(l){if(l.isInsideTable&&s.add(Gn.Table),l.listType!==Bs.NoList&&s.add(Gn.List),u.tileReference.referencedPath.indexOf(Mu.HeaderFooter)>-1&&(!((a=(o=l.formattedRanges)===null||o===void 0?void 0:o[0])===null||a===void 0)&&a.styleName&&l.formattedRanges[0].styleName===Ja.Footer?s.add(Gn.Footer):s.add(Gn.Header)),s.size===0&&s.add(Gn.Paragraph),l.formattedRanges)for(var c of l.formattedRanges)c!=null&&c.styleName&&c.styleName!==Ja.Normal&&s.add(c.styleName);u.range.length>l.content.length&&s.add(Gn.Multiselect)}}return e.selectedRanges.length>1&&s.add(Gn.Multiselect),s}},{key:"extractContentType",value:function(){var e,t,o,a=new E({operationName:"Extracting content-type",success:!0}).start();try{var s=(t=(e=this.context)===null||e===void 0?void 0:e.triggerSignals)===null||t===void 0?void 0:t[0];if(!(s!=null&&s.currentSelection)||!(!((o=this.context)===null||o===void 0)&&o.model))return"";var u=this.getContentType(s.currentSelection,this.context.model);return v.info(512242182,y.WorkflowDefault,a.stop()),(0,TT.default)(u.values()).join(",")}catch(c){a.success=!1;var l={error:c,message:c.message,stack:c.stack};a.resultDescription=JSON.stringify(l),v.error(512242181,y.WorkflowDefault,a.stop())}return""}}])}();var VE=function(){function n(){(0,bT.default)(this,n)}return(0,MT.default)(n,[{key:"execute",value:function(e,t,o,a){var s=new E({operationName:"Extracting Features",success:!0}).start();try{var u=new So({extractedFeatures:[]}),l=new AT(o),c=l.extractContentType();u.extractedFeatures.push({key:bu.ContentType,value:c}),v.info(512238366,y.WorkflowDefault,s.stop()),a.setAnnotations(e,So.getTypeName(),[u]),a.done()}catch(d){s.success=!1;var f={error:d,message:d.message,stack:d.stack};s.resultDescription=JSON.stringify(f),v.error(512238365,y.WorkflowDefault,s.stop()),a.done(d)}}},{key:"dispose",value:function(){}}])}(),ET=Qs.create("FeatureExtraction").setBypassModel().setCollectionScopeType(bt.getTypeName()).setTriggerSignals([ja.getTypeName()]).setInputTypes([nt.getTypeName()]).setOutputTypes([So.getTypeName()]).setLambdaType(VE);var PT=function(r){var e,t,o=null,a=0,s={sendConnectionParamsAcrossBridge:!1,stampBridgeMessageWithSequenceId:!1},u=new Map,l=new Map,c=new Map,f=new Map,d=function(B,L,O,D){r.OnResult({InputSchema:B,InputJson:JSON.stringify(L),OutputSchema:O,OutputJson:JSON.stringify(D)})},p=function(B){return r.RequestAuthToken(B)},g=function(B,L){return B.startsWith("Microsoft.Office")||(B="Microsoft.Office.AugLoop."+B),r.IsFeatureEnabled(B,L)},k=function(B){return r.IsChangeGateEnabled(B)},S=function(B){return r.AreLicenseFeaturesEnabled(B)},C=function(B,L,O,D){var $={InputSchema:B,InputJson:JSON.stringify(L),CorrelationVector:""};return r.ExecuteLocalLambda($,O,"").then(function(U){return U?JSON.parse(U):void 0})},x=function(){var B=new Dt.TelemetryLogger;B.setTenantTokens({Office:{AugLoop:{ariaTenantToken:"3de4087d4de34817b1c376e3d1e6e293-983c4292-5ba9-485a-ab10-9797863c788b-6770",nexusTenantToken:1780,Client:{}}}}),B.addSink((0,DT.createOTelSink)());var L=function(D,$){var U=D.charAt(0).toUpperCase()+D.slice(1);if(typeof $=="string")return{name:U,dataType:Dt.DataFieldType.String,value:$};if(typeof $=="boolean")return{name:U,dataType:Dt.DataFieldType.Boolean,value:$};if(typeof $=="number")return{name:U,dataType:Dt.DataFieldType.Double,value:$};if(typeof $=="object"&&$.isInteger)return{name:U,dataType:Dt.DataFieldType.Int64,value:$.value}};return function(O,D,$,U,K,Z){var ye={eventName:D.replace(/_/g,".")};ye.eventFlags={samplingPolicy:Dt.SamplingPolicy.Measure,dataCategories:Dt.DataCategories.ProductServiceUsage|Dt.DataCategories.ProductServicePerformance,diagnosticLevel:Dt.DiagnosticLevel.NecessaryServiceDataEvent},U==="Office.System.Activity"&&(ye.eventContract={name:U,dataFields:Dt.Contracts.Office.System.Activity.getFields({duration:K.Duration,count:K.Count,aggMode:K.AggMode,cV:K.CV,success:K.Success,result:K.Result?{code:K.Result.Code||0,type:K.Result.Type,tag:K.Result.Tag}:void 0})}),ye.dataFields=Object.keys($).filter(function(he){return $[he]!==void 0}).map(function(he){return L(he,$[he])}),B.sendTelemetryEvent(ye),t&&t.appName&&t.appName.toLowerCase()==="testing"&&r.SendDiagnosticTrace(0,Yt.Info,`EventName: ${D} Contract: ${U} ContractData: ${JSON.stringify(K)} Data: ${JSON.stringify($)}`)}},T={onResult:d,onAnnotationResult:null,requestAuthToken:p,sendTelemetryEvent:x(),isFeatureEnabled:g,isChangeGateEnabled:k,executeLocalLambda:C,areLicenseFeaturesEnabled:S};v.addLogger({level:kt.info,log:function(B){if(B.eventName==="Log"){var L,O,D;r.SendDiagnosticTrace((L=B.tagId)!=null?L:0,(O=B.traceLevel)!=null?O:Yt.Info,(D=B.message)!=null?D:"")}}});var I=function(){return o!==null||(o=Promise.all([r.IsFeatureEnabled("Microsoft.Office.AugLoop.EnableAugLoopPhase3","None"),r.IsFeatureEnabled("Microsoft.Office.AugLoop.EnablePhase3Service","None"),r.IsChangeGateEnabled("SendConnectionParamsAcrossBridge"),r.IsChangeGateEnabled("StampBridgeMessageWithSequenceId")]).then(function(B){var L,O=(0,NT.default)(B,4),D=O[0],$=O[1],U=O[2],K=O[3];s.sendConnectionParamsAcrossBridge=U,s.stampBridgeMessageWithSequenceId=K;var Z=fr((L=t.flights)!=null?L:""),ye=1e3,he="Microsoft.Office.AugLoop.BatchingIntervalMSec";return Z.hasFlight(he)&&(ye=Z.getIntValue(he)),gu.init(e,t,T,{networkMode:D&&$?Ce.LocalWorkflowsOnly:void 0,telemetryAggregationIntervalSec:30,batchOptions:{delayMs:ye,maxInputSize:1048576}}).then(function(){return ft.init(e,t,T)}).then(function(){if(t.appName==="PowerPoint")return Promise.all([yp(ft),dT(ft),Su(t,e)]).then(function(){});if(t.appName==="Word")return Promise.all([dp(ft,r),pp(ft),gp(ft),hp(ft),pT(ft),gT(ft),Su(t,e),Kx(ft,r)]).then(function(){});if(t.appName==="Outlook")return Promise.all([Su(t,e)]).then(function(){});if(t.appName==="OneNote")return ST(ft);if(t.appName==="Testing")return Promise.all([hT(ft),yp(ft),dp(ft,r),pp(ft),gp(ft),hp(ft)]).then(function(){})})})),o};r.OnSubmit.subscribe(function(W){var B="RekaPing";if(W.InputSchema===B){r.OnResult({InputSchema:B,InputJson:W.InputJson,OutputSchema:B,OutputJson:W.InputJson});return}I().then(function(){ft.submit(W.InputSchema,JSON.parse(W.InputJson),W.CorrelationVector)})}),r.OnSetServiceUrl.subscribe(function(W){e=W}),r.OnSetHostMetadata.subscribe(function(W){var B=[];for(var L of W.DisabledServiceGroups)B.push({officeServiceGroup:L.OfficeServiceGroup,controllerServiceGroup:L.ControllerServiceGroup});t={appName:W.AppName,appPlatform:W.AppPlatform,appVersion:W.AppVersion,uiLanguage:W.UILanguage,releaseAudienceGroup:W.ReleaseAudienceGroup,releaseChannel:W.ReleaseChannel,releaseFork:W.ReleaseFork,sessionId:W.SessionId,flights:W.Flights,privateMode:W.PrivateMode,disabledServiceGroups:B,userSystemTimezone:W.SystemTimezone,isClientTelemetrySampled:W.IsClientTelemetrySampled}});var _=function(B){v.error(593892183,y.CoreDefault,`Session not found for ${B} event`)},M=function(B){v.warn(0,y.CoreDefault,`Annotation token not found for ${B} event`)},b=function(B,L){v.error(0,y.CoreDefault,`Bad input for ${B}: ${L}`)},A=function(B,L){v.error(593892186,y.CoreDefault,new E({operationName:"InteropPromiseRejected",success:!1,resourceId:B,resultDescription:L}))},N=function(B){if(B){if(typeof B=="string")return B;if(typeof B.message=="string")return B.message}return"Unknown error"},F=function(B){s.stampBridgeMessageWithSequenceId&&(B.seq=a++),r.OnSDXBridgeMessageResult({bridgeMessage:JSON.stringify(new qo(B))})},q=function(B,L){if(f.has(L)&&s.sendConnectionParamsAcrossBridge){var O=f.get(L),D=O.sessionUrl,$=new qo({bridgeId:B,docSessionId:L,message:new un({origin:O.origin,sessionKey:D.split("/").pop(),sessionUrlBase:D.split("/").slice(0,-1).join("/"),anonymousToken:O.authToken})});F($)}};r.OnCreateSession.subscribe(function(W){var B=W.docSessionId,L=W.flights,O=W.serviceUrl,D=W.offlineMode;if(u.has(B)){r.OnCreateSessionResult({errMessage:"docSessionId already exists",docSessionId:B});return}var $=I().then(function(){var U=[];try{for(var K of W.extensionConfigs||[])U.push(JSON.parse(K))}catch(he){throw b("OnCreateSession",N(he)),new Error("Bad extension configs")}var Z="*",ye={docSessionId:B,onSessionConnect:function(ke,Ae,on,ht){if(v.debug(0,y.CoreDefault,"In AL Session onSessionConnect"),!f.has(B)&&s.sendConnectionParamsAcrossBridge){var an={authToken:ht,isSeedingRequired:ke,sessionUrl:Ae,origin:on};f.set(B,an),q(Z,B)}var Gt={bridgeId:Z,docSessionId:B,message:new Zi({isSeedingRequired:ke,sessionUrl:Ae,origin:on,authToken:ht})};F(Gt)},onSessionDisconnect:function(ke){v.debug(0,y.CoreDefault,"In AL Session onSessionDisconnect"),f.delete(B);var Ae={bridgeId:Z,docSessionId:B,message:new ea({error:ke})};F(Ae)},onSessionReconnect:function(){v.debug(0,y.CoreDefault,"In AL Session onSessionReconnect");var ke={bridgeId:Z,docSessionId:B,message:new ta};F(ke)},onSessionClose:function(ke){v.debug(0,y.CoreDefault,"In AL Session onSessionClose");var Ae={bridgeId:Z,docSessionId:B,message:ke};F(Ae)},onServerAuthenticationStateChangeCallback:function(ke){v.debug(0,y.CoreDefault,"In AL Session onServerAuthenticationStateChangeCallback"),c.set(B,ke);var Ae={bridgeId:Z,docSessionId:B,message:new $o({serverAuthenticationState:ke})};F(Ae)},onClaimsChallengeCallback:function(ke){v.debug(0,y.CoreDefault,"In AL Session onClaimsChallengeCallback");var Ae={bridgeId:Z,docSessionId:B,message:ke};F(Ae)},extensionConfigs:U,flights:L,serviceUrl:O};return D&&(ye.networkMode=Ce.LocalWorkflowsOnly),gu.createSession(ye)}).then(function(U){return r.OnCreateSessionResult({docSessionId:B}),U}).catch(function(U){u.delete(B);var K=N(U);throw A("OnCreateSession",K),r.OnCreateSessionResult({errMessage:K,docSessionId:B}),new Error(K)});u.set(B,$)}),r.OnActivateAnnotation.subscribe(function(W){var B=W.annotationType,L=W.token,O=W.config,D=W.docSessionId,$=W.forceReturnCachedAnnotations,U=u.get(D);if(!U){_("OnActivateAnnotation");return}var K;U.then(function(Z){var ye=O?JSON.parse(O):void 0,he=function(Ae){r.OnAnnotationResult({operation:JSON.stringify(Ae),token:L,docSessionId:D,annotationType:B})};return Z.activateAnnotation(B,{config:ye,callback:he,forceReturnCachedAnnotations:$})}).then(function(Z){Z&&Z.token&&l.set(L,Z.token)}).catch(function(Z){K=N(Z)}).then(function(){r.OnActivateAnnotationResult({errMessage:K,token:L,docSessionId:D})}).catch(function(Z){A("OnActivateAnnotation",N(Z))})}),r.OnReleaseAnnotation.subscribe(function(W){var B=W.token,L=W.docSessionId,O=l.get(B);if(!O){M("OnReleaseAnnotation");return}var D=u.get(L);if(!D){_("OnReleaseAnnotation");return}var $;D.then(function(U){return U.releaseAnnotation(O)}).catch(function(U){$=N(U)}).then(function(U){U&&l.delete(B),r.OnReleaseAnnotationResult({errMessage:$,token:B,result:U})}).catch(function(U){A("OnReleaseAnnotation",N(U))})}),r.OnSubmitOperations.subscribe(function(W){var B=W.operations,L=W.cv,O=W.docSessionId,D=u.get(O);if(!D){_("OnSubmitOperations");return}D.then(function($){$.submitOperations(B.map(function(U){return JSON.parse(U)}),L)}).catch(function($){A("OnSubmitOperations",N($))})}),r.OnSubmitSeedOperations.subscribe(function(W){var B=W.operations,L=W.cv,O=W.docSessionId,D=u.get(O);if(!D){_("OnSubmitSeedOperations");return}D.then(function($){$.submitSeedOperations(B.map(function(U){return JSON.parse(U)}),L)}).catch(function($){A("OnSubmitSeedOperations",N($))})}),r.OnSubmitSeedGroupOperations.subscribe(function(W){var B=W.operations,L=W.groupComplete,O=W.cv,D=W.docSessionId,$=u.get(D);if(!$){_("OnSubmitSeedGroupOperations");return}$.then(function(U){U.submitSeedGroupOperations(B.map(function(K){return JSON.parse(K)}),L,O)}).catch(function(U){A("OnSubmitSeedGroupOperations",N(U))})}),r.OnSubmitCustomMessage.subscribe(function(W){var B=W.message,L=W.messageId,O=W.docSessionId,D=u.get(O);if(!D){_("OnSubmitCustomMessage");return}var $,U;D.then(function(K){return K.submitCustomMessage(JSON.parse(B))}).then(function(K){U=K}).catch(function(K){$=N(K)}).then(function(){r.OnSubmitCustomMessageResult({errMessage:$,response:JSON.stringify(U),messageId:L,docSessionId:O})}).catch(function(K){A("OnSubmitCustomMessage",N(K))})}),r.OnForceReconnect.subscribe(function(W){var B=W.docSessionId,L=u.get(B);if(!L){_("OnForceReconnect");return}var O=[];try{for(var D of W.extensionConfigs||[])O.push(JSON.parse(D))}catch(U){b("OnForceReconnect",N(U));return}var $;L.then(function(U){return U.forceReconnect()}).catch(function(U){$=N(U)}).then(function(){r.OnForceReconnectResult({errMessage:$,docSessionId:B})}).catch(function(U){A("OnForceReconnect",N(U))})}),r.OnClose.subscribe(function(W){var B=W.docSessionId,L=u.get(B);if(!L){_("OnClose");return}L.then(function(O){O.close(),u.delete(B),c.delete(B)}).catch(function(O){A("OnClose",N(O))})}),r.OnAuthenticateInteractive.subscribe(function(W){var B=W.docSessionId,L=W.token,O=u.get(B);if(!O){_("OnAuthenticateInteractive");return}var D;O.then(function($){return $.authenticateInteractive()}).catch(function($){D=N($)}).then(function(){r.OnAuthenticateInteractiveResult({errMessage:D,token:L,docSessionId:B})}).catch(function($){A("OnAuthenticateInteractive",N($))})}),r.OnSetSessionCloseCallback.subscribe(function(W){var B=W.docSessionId,L=u.get(B);if(!L){_("OnSetSessionCloseCallback");return}L.then(function(O){O.setSessionCloseCallback(function(D){r.OnSessionCloseResult({docSessionId:B,sessionCloseMessage:D?JSON.stringify(D):void 0})})}).catch(function(O){A("OnSetSessionCloseCallback",N(O))})}),r.OnSetConnectCallback.subscribe(function(W){var B=W.docSessionId,L=u.get(B);if(!L){_("OnSetConnectCallback");return}L.then(function(O){O.setConnectCallback(function(D,$,U,K){r.OnConnectResult({docSessionId:B,isSeedingRequired:D,sessionUrl:$,origin:U,authToken:K})})}).catch(function(O){A("OnSetConnectCallback",N(O))})}),r.OnSetDisconnectCallback.subscribe(function(W){var B=W.docSessionId,L=u.get(B);if(!L){_("OnSetDisconnectCallback");return}L.then(function(O){O.setDisconnectCallback(function(D){r.OnDisconnectResult({error:D,docSessionId:B})})}).catch(function(O){A("OnSetDisconnectCallback",N(O))})}),r.OnSetClaimsChallengeCallback.subscribe(function(W){var B=W.docSessionId,L=W.token,O=u.get(B);if(!O){_("OnSetClaimsChallengeCallback");return}O.then(function(D){D.setClaimsChallengeCallback(function($){r.OnClaimsChallengeResult({docSessionId:B,token:L,claimsChallengeMessage:$?JSON.stringify($):void 0})})}).catch(function(D){A("OnSetClaimsChallengeCallback",N(D))})}),r.OnSetOfflineMode.subscribe(function(W){var B=W.docSessionId,L=u.get(B);if(!L){_("OnSetOfflineMode");return}L.then(function(O){O.setOfflineMode()}).catch(function(O){A("OnSetOfflineMode",N(O))})});var J,Y=new Set,fe=function(B){Y.has(B)||(Y.add(B),J.initBridge({bridgeId:B,egress:function(O,D){var $=typeof O=="string",U={bridgeId:B,docSessionId:D,bridgeMessage:$?O:void 0,binaryMessage:$?void 0:Array.from(O)};r.OnIngressAugLoopBridgeMessage(U)},onSessionInit:function(O){O.registerLocalWorkflow(xT()),O.registerLocalWorkflow(ET)}}))};r.OnInitAugLoopBridgeManager.subscribe(function(W){J||(J=new Ex)}),r.OnEgressAugLoopBridgeMessage.subscribe(function(W){if(!J)throw new Error("Called OnEgressAugLoopBridgeMessage before OnInitAugLoopBridgeManager");var B=W.bridgeId,L=W.docSessionId,O=W.bridgeMessage,D=W.binaryMessage;fe(B);var $=typeof O=="string";J.ingress(B,L,$?O:new Uint8Array(D))}),r.OnSDXBridgeMessageFromNative.subscribe(function(W){var B=JSON.parse(W.bridgeMessage),L=B.bridgeId,O=B.docSessionId,D=B.message,$=m.getTypeNameFor(D);r.SendDiagnosticTrace(0,Yt.Info,"TS Received Brige Message of type = "+$);var U=u.get(O);if(!U){_("OnSDXBridgeMessageFromNative");var K={bridgeId:L,docSessionId:O,response:new X({messageId:D.messageId,error:"Session not found"})};F(K);return}U.then(function(Z){if(ln.typeGuard(D)){var ye=D.annotationType,he=D.config;r.SendDiagnosticTrace(0,Yt.Info,"TS Activate Annotation of type = "+ye+" token = "+D.token),Z.activateAnnotation(ye,{config:he,callback:function(Ye,Fe){var Pt={bridgeId:L,docSessionId:O,message:new Ct({annotationType:ye,ops:[Ye],cv:Fe})};F(Pt)},forceReturnCachedAnnotations:D.forceReturnCachedAnnotations}).then(function(Xe){r.SendDiagnosticTrace(0,Yt.Info,"TS Annotation Activation Response Recieved with token = "+Xe.token);var Ye={bridgeId:L,docSessionId:O,response:new rr({messageId:D.messageId,token:Xe.token})};F(Ye)}).catch(function(Xe){var Ye={bridgeId:L,docSessionId:O,response:new X({messageId:D.messageId,error:N(Xe)})};F(Ye)})}else if(Be.typeGuard(D)){var ke=D.ops;for(var Ae of ke)Z.submitOperation(Ae,D.cv)}else if(Kr.typeGuard(D))r.SendDiagnosticTrace(0,Yt.Info,"TS Releasing Annotation Activation token = "+D.token),Z.releaseAnnotation(D.token).then(function(Xe){r.SendDiagnosticTrace(0,Yt.Info,"TS Sending Annotation Release Response token = "+D.token);var Ye={bridgeId:L,docSessionId:O,response:new Yr({messageId:D.messageId,lastRelease:Xe})};F(Ye)});else if(na.typeGuard(D))Z.submitCustomMessage(D.customMessage).then(function(Xe){Xe.messageId=D.messageId,r.SendDiagnosticTrace(0,Yt.Info,`Responded to ${$}`);var Ye={bridgeId:L,docSessionId:O,response:Xe};F(Ye)}).catch(function(Xe){r.SendDiagnosticTrace(0,Yt.Info,Xe.message);var Ye={bridgeId:L,docSessionId:O,response:new X({messageId:D.messageId,error:Xe.message})};F(Ye)});else if(pt.typeGuard(D)){q(L,O);var on={bridgeId:L,docSessionId:O,message:new $o({serverAuthenticationState:c.has(O)?c.get(O):Ze.Pending})};F(on)}else if(m.matchesTypesFor(D,[aa.getTypeName()])){r.SendDiagnosticTrace(0,Yt.Info,`Interactive auth requested via message ${D.messageId}`);var ht;Z.authenticateInteractive().then(function(){r.SendDiagnosticTrace(0,Yt.Info,`Interactive auth succeeded for message ${D.messageId}`),ht=new Ge({messageId:D.messageId})}).catch(function(Xe){r.SendDiagnosticTrace(0,Yt.Error,`Interactive auth failed for message ${D.messageId}`),ht=new X({messageId:D.messageId,error:N(Xe)})}).finally(function(){var Xe={bridgeId:L,docSessionId:O,response:ht};F(Xe)})}else if(m.matchesTypesFor(D,[oa.getTypeName()])){var an=function(Ye){var Fe={bridgeId:L,docSessionId:O,message:new ia({messageId:D.messageId,claimsChallengeMessage:Ye})};F(Fe)};Z.setClaimsChallengeCallback(an)}else{var Gt={bridgeId:L,docSessionId:O,response:new X({messageId:D.messageId,error:"Unknown message type to handle"})};F(Gt)}}).catch(function(Z){A("OnReceiveBridgeMessageFromNative",N(Z));var ye={bridgeId:L,docSessionId:O,response:new X({messageId:D.messageId,error:N(Z)})};F(ye)})})};(0,RT.initReka)();PT(Bp.NativeService);})();
//# sourceMappingURL=index.win32.bundle.map
